(()=>{var{defineProperty:d1,getOwnPropertyNames:C2,getOwnPropertyDescriptor:f2}=Object,k2=Object.prototype.hasOwnProperty;var B2=new WeakMap,I2=(Q)=>{var Z=B2.get(Q),Y;if(Z)return Z;if(Z=d1({},"__esModule",{value:!0}),Q&&typeof Q==="object"||typeof Q==="function")C2(Q).map((X)=>!k2.call(Z,X)&&d1(Z,X,{get:()=>Q[X],enumerable:!(Y=f2(Q,X))||Y.enumerable}));return B2.set(Q,Z),Z};var y2=(Q,Z)=>{for(var Y in Z)d1(Q,Y,{get:Z[Y],enumerable:!0,configurable:!0,set:(X)=>Z[Y]=()=>X})};var s2={};y2(s2,{default:()=>l1});class L0{constructor(){this.bodyElement=document.querySelector("body"),this.nCurretPetitions=0,this._accessErrorHandled=!1}handleAccessError(Q,Z){if(this._accessErrorHandled)return!0;let Y=window.eXeLearning?.config?.basePath||"";if(Q===401){if(this._accessErrorHandled=!0,window.eXeLearning?.app?.toasts?.default)window.eXeLearning.app.toasts.default.createToast({icon:"error",title:window._?_("Session Expired"):"Session Expired",body:window._?_("Your session has expired. Please log in again."):"Your session has expired. Please log in again.",error:!0,remove:5000});return setTimeout(()=>{window.location.href=Y+"/login"},2000),!0}if(Q===403){if(this._accessErrorHandled=!0,window.eXeLearning?.app?.toasts?.default)window.eXeLearning.app.toasts.default.createToast({icon:"error",title:window._?_("Access Denied"):"Access Denied",body:window._?_("You no longer have access to this project."):"You no longer have access to this project.",error:!0,remove:5000});return setTimeout(()=>{window.location.href=Y+"/workarea"},2000),!0}return!1}async get(Q,Z,Y=!0){try{return await this.doAjax(Q,"GET",Z,Y)}catch(X){if(X.responseJSON)return X.responseJSON;return{responseMessage:"ERROR",error:X.statusText||"Request failed"}}}async post(Q,Z,Y=!0){try{return await this.doAjax(Q,"POST",Z,Y)}catch(X){if(X.responseJSON)return X.responseJSON;return{responseMessage:"ERROR",error:X.statusText||"Request failed"}}}async fileSendPost(Q,Z,Y=!0){try{return await this.doFileSendAjax(Q,"POST",Z,Y)}catch(X){if(X.responseJSON)return X.responseJSON;return{responseMessage:"ERROR",error:X.statusText||"Request failed"}}}async postJson(Q,Z,Y=!0){try{return await this.doJsonAjax(Q,"POST",Z,Y)}catch(X){if(X.responseJSON)return X.responseJSON;return{responseMessage:"ERROR",error:X.statusText||"Request failed"}}}async put(Q,Z,Y=!0){try{return await this.doAjax(Q,"PUT",Z,Y)}catch(X){if(X.responseJSON)return X.responseJSON;return{responseMessage:"ERROR",error:X.statusText||"Request failed"}}}async delete(Q,Z,Y=!0){try{return await this.doAjax(Q,"DELETE",Z,Y)}catch(X){if(X.responseJSON)return X.responseJSON;return{responseMessage:"ERROR",error:X.statusText||"Request failed"}}}async do(Q,Z,Y,X=!0){try{return await this.doAjax(Z,Q,Y,X)}catch(J){if(J.responseJSON)return J.responseJSON;return{responseMessage:"ERROR",error:J.statusText||"Request failed"}}}async doAjax(Q,Z,Y,X=!0){if(X)this.addWaitingPetition();let J=this,W={};try{W=await $.ajax({url:Q,method:Z,data:Y,timeout:eXeLearning.config.clientCallWaitingTime,dataType:"json",success:function(z){return z},error:function(z,G,q){return J.handleAccessError(z.status,z.responseText),{error:q,status:z.status}}})}catch(z){if(z.status)this.handleAccessError(z.status,z.responseText);throw z}return setTimeout(()=>{this.removeWaitingPetition()},100),W}async doJsonAjax(Q,Z,Y,X=!0){if(X)this.addWaitingPetition();let J=this,W={};try{W=await $.ajax({url:Q,method:Z,data:JSON.stringify(Y),timeout:eXeLearning.config.clientCallWaitingTime,contentType:"application/json",dataType:"json",success:function(z){return z},error:function(z,G,q){return J.handleAccessError(z.status,z.responseText),{error:q,status:z.status}}})}catch(z){if(z.status)this.handleAccessError(z.status,z.responseText);throw z}return setTimeout(()=>{this.removeWaitingPetition()},100),W}async doFileSendAjax(Q,Z,Y,X=!0){if(X)this.addWaitingPetition();let J=this,W={};try{W=await $.ajax({url:Q,method:Z,data:Y,timeout:eXeLearning.config.clientCallWaitingTime,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(z){return z},error:function(z,G,q){return J.handleAccessError(z.status,z.responseText),{error:q,status:z.status}}})}catch(z){if(z.status)this.handleAccessError(z.status,z.responseText);throw z}return setTimeout(()=>{this.removeWaitingPetition()},100),W}async getText(Q,Z=!0){if(Z)this.addWaitingPetition();let Y={};return Y=await $.ajax({url:Q,dataType:"text",mimeType:"text/plain",async:!1,success:(X)=>{return X},error:function(X,J,W){return{error:W}}}),setTimeout(()=>{this.removeWaitingPetition()},100),Y}addWaitingPetition(){this.nCurretPetitions++,document.querySelector("body").classList.add("ajax-petition-on")}removeWaitingPetition(){if(this.nCurretPetitions--,this.nCurretPetitions<=0)document.querySelector("body").classList.remove("ajax-petition-on")}}class B0{constructor(Q,Z={}){this.app=Q,this.apiUrlBase=`${Q.eXeLearning.config.baseURL}`,this.apiUrlBasePath=`${Q.eXeLearning.config.basePath}`,this.apiUrlParameters=`${this.apiUrlBase}${this.apiUrlBasePath}/api/parameter-management/parameters/data/list`,this.func=new L0,this.endpoints={},this._projectRepo=Z.projectRepo||null,this._catalog=Z.catalog||null,this._assets=Z.assets||null,this._collaboration=Z.collaboration||null,this._exportAdapter=Z.exportAdapter||null,this._userPreferences=Z.userPreferences||null,this._linkValidation=Z.linkValidation||null,this._cloudStorage=Z.cloudStorage||null,this._platformIntegration=Z.platformIntegration||null,this._sharing=Z.sharing||null,this._content=Z.content||null}_hasAdapter(Q){return this[`_${Q}`]!==null}setAdapters(Q){if(Q.projectRepo)this._projectRepo=Q.projectRepo;if(Q.catalog)this._catalog=Q.catalog;if(Q.assets)this._assets=Q.assets;if(Q.collaboration)this._collaboration=Q.collaboration;if(Q.exportAdapter)this._exportAdapter=Q.exportAdapter;if(Q.userPreferences)this._userPreferences=Q.userPreferences;if(Q.linkValidation)this._linkValidation=Q.linkValidation;if(Q.cloudStorage)this._cloudStorage=Q.cloudStorage;if(Q.platformIntegration)this._platformIntegration=Q.platformIntegration;if(Q.sharing)this._sharing=Q.sharing;if(Q.content)this._content=Q.content}_getEndpointUrl(Q){let Z=this.endpoints[Q];if(!Z||!Z.path){let Y=this.app.capabilities;if(Y&&!Y.storage.remote)return null;return console.warn(`[apiCallManager] Endpoint not found: ${Q}`),null}return Z.path}async loadApiParameters(){this.parameters=await this.getApiParameters();for(var[Q,Z]of Object.entries(this.parameters.routes||{}))this.endpoints[Q]={},this.endpoints[Q].path=this.apiUrlBase+Z.path,this.endpoints[Q].methods=Z.methods}async getApiParameters(){return this._catalog.getApiParameters()}async getChangelogText(){return this._catalog.getChangelog()}async getUploadLimits(){return this._catalog.getUploadLimits()}async getThirdPartyCodeText(){return this._catalog.getThirdPartyCode()}async getLicensesList(){return this._catalog.getLicensesList()}async getIdevicesInstalled(){return this._catalog.getIDevices()}async getThemesInstalled(){return this._catalog.getThemes()}async getUserOdeFiles(){try{return{odeFiles:{odeFilesSync:await this._projectRepo.list()}}}catch(Q){return console.error("[API] getUserOdeFiles error:",Q),{odeFiles:{odeFilesSync:[]}}}}async _getLocalProjects(){try{if(!window.indexedDB?.databases)return console.log("[API] indexedDB.databases() not supported, returning empty list"),{odeFiles:{odeFilesSync:[]}};return{odeFiles:{odeFilesSync:(await window.indexedDB.databases()).filter((X)=>X.name?.startsWith("exelearning-project-")).map((X)=>{let J=X.name.replace("exelearning-project-","");return{uuid:J,title:`Local Project (${J.substring(0,8)}...)`,updatedAt:new Date().toISOString(),isLocal:!0}})}}}catch(Q){return console.error("[API] _getLocalProjects error:",Q),{odeFiles:{odeFilesSync:[]}}}}async getRecentUserOdeFiles(){try{return await this._projectRepo.getRecent()}catch(Q){return console.error("[API] getRecentUserOdeFiles error:",Q),[]}}async getCurrentUserOdeSessionId(){return console.warn("[apiCallManager] getCurrentUserOdeSessionId() is deprecated - use URL param or YjsProjectBridge"),{responseMessage:"OK",odeSessionId:new URLSearchParams(window.location.search).get("project")||"default"}}async getTemplates(Q){return this._catalog.getTemplates(Q)}async postJoinCurrentOdeSessionId(Q){return{responseMessage:"OK",...await this._projectRepo.joinSession(Q.odeSessionId)}}async postSelectedOdeFile(Q){return this._projectRepo.openFile(Q)}async postLocalLargeOdeFile(Q){return this._projectRepo.openLargeLocalFile(Q)}async postLocalOdeFile(Q){return this._projectRepo.openLocalFile(Q)}async postLocalXmlPropertiesFile(Q){return this._projectRepo.getLocalProperties(Q)}async postImportElpToRoot(Q){return this._projectRepo.importToRoot(Q)}async postImportElpToRootFromLocal(Q={}){return this._projectRepo.importToRootFromLocal(Q)}async postLocalOdeComponents(Q){return this._projectRepo.getLocalComponents(Q)}async postMultipleLocalOdeFiles(Q){return this._projectRepo.openMultipleLocalFiles(Q)}async postImportElpAsChildFromLocal(Q,Z={}){return this._projectRepo.importAsChild(Q,Z)}async postImportElpAsChild(Q,Z={}){return await this.postImportElpAsChildFromLocal(Q,Z)}async postDeleteOdeFile(Q){return await this._projectRepo.delete(Q),{responseMessage:"OK"}}async postDeleteOdeFilesByDate(Q){return this._projectRepo.deleteByDate(Q)}async postCheckCurrentOdeUsers(Q){return this._projectRepo.checkCurrentUsers(Q)}async postCleanAutosavesByUser(Q){return this._projectRepo.cleanAutosaves(Q)}async postCloseSession(Q){return this._projectRepo.closeSession(Q)}async postUploadTheme(Q){return this._catalog.uploadTheme(Q)}async postOdeImportTheme(Q){return this._catalog.importTheme(Q)}async deleteTheme(Q){return this._catalog.deleteTheme(Q)}async getThemeZip(Q,Z){return this._catalog.getThemeZip(Q,Z)}async postNewTheme(Q){return this._catalog.createTheme(Q)}async putEditTheme(Q,Z){return this._catalog.updateTheme(Q,Z)}async postUploadIdevice(Q){return this._catalog.uploadIdevice(Q)}async deleteIdeviceInstalled(Q){return this._catalog.deleteIdevice(Q)}async getIdeviceInstalledZip(Q,Z){return this._catalog.getIdeviceZip(Q,Z)}async postUserSetLopdAccepted(){return this._userPreferences.acceptLopd()}async getUserPreferences(){return this._userPreferences.getPreferences()}async putSaveUserPreferences(Q){return this._userPreferences.savePreferences(Q)}async getOdeLastUpdated(Q){return this._projectRepo.getLastUpdated(Q)}async getOdeConcurrentUsers(Q,Z,Y){let X=await this._projectRepo.getConcurrentUsers(Q,Z,Y);return{currentUsers:X.users?.length||0,users:X.users||[]}}async getOdeStructure(Q,Z){return this._projectRepo.getStructure(Q,Z)}async getOdeSessionBrokenLinks(Q){return this._linkValidation.getSessionBrokenLinks(Q)}async extractLinksForValidation(Q){return this._extractLinksFromYjs()}_extractLinksFromYjs(){let Y=eXeLearning?.app?.project?._yjsBridge?.structureBinding;if(!Y)return console.warn("[apiCallManager] _extractLinksFromYjs: No structureBinding available"),{responseMessage:"OK",links:[],totalLinks:0};let X=[],J=new Map,W=/href=["']([^"']+)["']/gi,z=Y.getPages()||[];for(let G of z){let q=G.id,H=G.pageName||"Page",K=Y.getBlocks(q)||[];for(let V of K){let R=V.blockName||"",O=Y.getComponents(q,V.id)||[];for(let A of O){let M=A.htmlContent||"",F=A.ideviceType||"",U=A.order||0,L;while((L=W.exec(M))!==null){let D=L[1];if(D.startsWith("#")||D.startsWith("asset://")||D.startsWith("data:")||D.startsWith("blob:")||D.startsWith("javascript:")||D.startsWith("exe-node:"))continue;let B=(J.get(D)||0)+1;J.set(D,B);let P=`link-${crypto.randomUUID().substring(0,8)}`;X.push({id:P,url:D,count:B,pageName:H,blockName:R,ideviceType:F.replace("Idevice",""),order:U})}W.lastIndex=0}}}for(let G of X)G.count=J.get(G.url)||1;return console.log("[apiCallManager] _extractLinksFromYjs: Found",X.length,"links"),{responseMessage:"OK",links:X,totalLinks:X.length}}getLinkValidationStreamUrl(){return this._linkValidation.getValidationStreamUrl()}async getOdePageBrokenLinks(Q){return this._linkValidation.getPageBrokenLinks(Q)}async getOdeBlockBrokenLinks(Q){return this._linkValidation.getBlockBrokenLinks(Q)}async getOdeIdeviceBrokenLinks(Q){return this._linkValidation.getIdeviceBrokenLinks(Q)}async getOdeProperties(Q){return this._projectRepo.getProperties(Q)}async putSaveOdeProperties(Q){return this._projectRepo.saveProperties(Q)}async getOdeSessionUsedFiles(Q){return this._getUsedFilesFromYjs()}async _getUsedFilesFromYjs(){let Z=eXeLearning?.app?.project?._yjsBridge,Y=Z?.structureBinding,X=Z?.assetManager;if(!Y)return console.warn("[apiCallManager] _getUsedFilesFromYjs: No structureBinding available"),{responseMessage:"OK",usedFiles:[]};let J=[],W=new Set,z=new Map,G=/asset:\/\/([a-f0-9-]+)/gi,q=Y.getPages()||[];console.log("[apiCallManager] _getUsedFilesFromYjs: Scanning",q.length,"pages for asset usage");for(let H of q){let K=H.id,V=H.pageName||"Page",R=Y.getBlocks(K)||[];for(let O of R){let A=O.blockName||"",M=Y.getComponents(K,O.id)||[];for(let F of M){let U=F.ideviceType||"",L=F.order||0,D="",B="";if(F._ymap){let k=F._ymap.get("htmlContent");if(k&&typeof k.toString==="function")D=k.toString();else if(typeof k==="string")D=k;if(!D){let C=F._ymap.get("htmlView");if(typeof C==="string")D=C}let y=F._ymap.get("jsonProperties");if(typeof y==="string")B=y}let P=D+" "+B,S;while((S=G.exec(P))!==null){let k=S[1];if(!z.has(k))z.set(k,{pageName:V,blockName:A,ideviceType:U.replace("Idevice",""),order:L})}G.lastIndex=0}}}if(console.log("[apiCallManager] _getUsedFilesFromYjs: Found",z.size,"assets referenced in content"),X)try{let H=X.getAllAssetsMetadata?.()||[];console.log("[apiCallManager] _getUsedFilesFromYjs: Found",H.length,"total assets in AssetManager");for(let K of H){let V=K.id||K.uuid;if(!V)continue;let R=`asset://${V}`;if(W.has(R))continue;W.add(R);let O=K.name||K.filename||V.substring(0,8)+"...",A=K.size?this._formatFileSize(K.size):"",M=z.get(V);J.push({usedFiles:O,usedFilesPath:R,usedFilesSize:A,pageNamesUsedFiles:M?.pageName||"-",blockNamesUsedFiles:M?.blockName||"-",typeComponentSyncUsedFiles:M?.ideviceType||"-",orderComponentSyncUsedFiles:M?.order||0})}}catch(H){console.debug("[apiCallManager] Could not get assets from AssetManager:",H)}for(let[H,K]of z.entries()){let V=`asset://${H}`;if(W.has(V))continue;W.add(V);let R=H.substring(0,8)+"...",O="";if(X)try{let A=await X.getAsset(H);if(A){if(R=A.name||A.filename||R,A.blob?.size)O=this._formatFileSize(A.blob.size);else if(A.size)O=this._formatFileSize(A.size)}}catch(A){console.debug("[apiCallManager] Could not get asset metadata:",H,A)}J.push({usedFiles:R,usedFilesPath:V,usedFilesSize:O,pageNamesUsedFiles:K.pageName,blockNamesUsedFiles:K.blockName,typeComponentSyncUsedFiles:K.ideviceType,orderComponentSyncUsedFiles:K.order})}return console.log("[apiCallManager] _getUsedFilesFromYjs: Returning",J.length,"assets total"),{responseMessage:"OK",usedFiles:J}}_formatFileSize(Q){if(!Q||Q===0)return"";let Z=["B","KB","MB","GB"],Y=0,X=Q;while(X>=1024&&Y<Z.length-1)X/=1024,Y++;return`${X.toFixed(1)} ${Z[Y]}`}async getOdeDownload(Q){return await this.getOdeExportDownload(Q,eXeLearning.extension)}async getOdeExportDownload(Q,Z){return this._exportAdapter.downloadExport(Q,Z)}buildStructureFromYjs(){try{let Y=this.app?.project?._yjsBridge?.getDocumentManager?.();if(!Y)return console.warn("[ApiCallManager] Yjs document manager not available"),null;let X=Y.getMetadata(),J=Y.getNavigation(),W={meta:{title:X?.get("title")||"Untitled",author:X?.get("author")||"",language:X?.get("language")||"en",description:X?.get("description")||"",license:X?.get("license")||"",theme:X?.get("theme")||"base"},pages:[],navigation:[]};for(let z=0;z<J.length;z++){let G=J.get(z);if(!G)continue;let q=G.get("id")||G.get("pageId"),H=G.get("pageName")||"Page",K=G.get("parentId")||null;W.navigation.push({id:q,navText:H,parentId:K});let V={id:q,pageName:H,parentId:K,blocks:[]},R=G.get("blocks");if(R)for(let O=0;O<R.length;O++){let A=R.get(O);if(!A)continue;let M={id:A.get("id")||A.get("blockId"),blockName:A.get("blockName")||"",iconName:A.get("iconName")||"",components:[]},F=A.get("components");if(F)for(let U=0;U<F.length;U++){let L=F.get(U);if(!L)continue;let D={id:L.get("id"),ideviceType:L.get("ideviceType"),htmlContent:L.get("htmlContent")?.toString?.()||""},B=L.get("properties");if(B&&typeof B.toJSON==="function")D.properties=B.toJSON();M.components.push(D)}V.blocks.push(M)}W.pages.push(V)}return console.log("[ApiCallManager] Built structure from Yjs:",W),W}catch(Q){return console.error("[ApiCallManager] Failed to build structure from Yjs:",Q),null}}async getOdePreviewUrl(Q){return this._exportAdapter.getPreviewUrl(Q)}async getOdeIdevicesDownload(Q,Z,Y){return this._exportAdapter.downloadIDevice(Q,Z,Y)}async getFileResourcesForceDownload(Q){return this._assets.getDownloadUrl(Q)}async postOdeSave(Q){let Z=Q?.odeSessionId||window.eXeLearning?.odeSessionId;return this._projectRepo.save(Z,Q)}async postOdeAutosave(Q){let Z=Q?.odeSessionId||window.eXeLearning?.odeSessionId;return this._projectRepo.autoSave(Z,Q)}async postOdeSaveAs(Q){let Z=Q?.odeSessionId||window.eXeLearning?.odeSessionId;return this._projectRepo.saveAs(Z,Q)}async postFirstTypePlatformIntegrationElpUpload(Q){return this._platformIntegration.uploadElp(Q)}async platformIntegrationOpenElp(Q){return this._platformIntegration.openElp(Q)}async postCheckUserOdeUpdates(Q){return{responseMessage:"OK",hasUpdates:!1,syncNavStructureFlag:!1,syncPagStructureFlag:!1,syncComponentsFlag:!1}}async postCheckUsersOdePage(Q){return console.warn("[apiCallManager] postCheckUsersOdePage() is deprecated - use Yjs awareness instead"),{responseMessage:"OK",usersOnPage:[]}}async postActivateCurrentOdeUsersUpdateFlag(Q){return{responseMessage:"OK"}}async checkCurrentOdeUsersComponentFlag(Q){return{responseMessage:"OK",isAvailable:!0}}async postObtainOdeBlockSync(Q){return this._collaboration.obtainBlockSync(Q)}async getTranslationsAll(){let Q=await this._catalog.getLocales(),Z=Array.isArray(Q)?Q.map((Y)=>Y.code||Y):["en"];return{locales:Z,packageLocales:Z,defaultLocale:"en"}}async getTranslations(Q){return this._catalog.getTranslations(Q)}async getUrlLoginGoogleDrive(){return this._cloudStorage.getGoogleDriveLoginUrl()}async getFoldersGoogleDrive(){return this._cloudStorage.getGoogleDriveFolders()}async uploadFileGoogleDrive(Q){return this._cloudStorage.uploadToGoogleDrive(Q)}async getUrlLoginDropbox(){return this._cloudStorage.getDropboxLoginUrl()}async getFoldersDropbox(){return this._cloudStorage.getDropboxFolders()}async uploadFileDropbox(Q){return this._cloudStorage.uploadToDropbox(Q)}async getComponentsByPage(Q){let Z=document.querySelector(".user-editing-overlay");if(Z)document.querySelectorAll(".editing-article, .article-disabled").forEach((z)=>{z.classList.remove("editing-article","article-disabled")}),Z.remove();let Y=eXeLearning?.app?.project;if(Y?._yjsEnabled&&Y._yjsBridge?.structureBinding)return console.log("[apiCallManager] getComponentsByPage: Loading from Yjs for page",Q),this._getComponentsByPageFromYjs(Q);let X=this.endpoints?.api_idevices_list_by_page;if(!X?.path)return console.warn("[apiCallManager] getComponentsByPage: Endpoint not available, returning empty structure"),{id:Q,odePageId:Q,pageName:"Page",odePagStructureSyncs:[]};let J=X.path;return J=J.replace("{odeNavStructureSyncId}",Q),await this.func.get(J)}_getComponentsByPageFromYjs(Q){let Y=eXeLearning?.app?.project?._yjsBridge,X=Y?.structureBinding;if(!X)return console.warn("[apiCallManager] _getComponentsByPageFromYjs: No structureBinding available"),{responseMessage:"ERROR",error:"Yjs not initialized"};let J=Q;if(Q==="root"){let q=X.getPages();if(q&&q.length>0)J=q[0].id,console.log('[apiCallManager] _getComponentsByPageFromYjs: "root" resolved to first page:',J);else return{id:"root",odePageId:"root",pageName:"Root",odePagStructureSyncs:[]}}let W=X.getPageMap(J);if(!W)return console.warn("[apiCallManager] _getComponentsByPageFromYjs: Page not found:",Q),{id:Q,odePageId:Q,pageName:"Page",odePagStructureSyncs:[]};let G=X.getBlocks(J).map((q)=>{let H=X.getComponents(J,q.id),K=q.properties;if(K&&typeof K.toJSON==="function")K=K.toJSON();else if(!K||typeof K!=="object")K={};let V={};return Object.entries(K).forEach(([R,O])=>{let A=typeof O==="boolean"?O?"true":"false":O;V[R]={value:A}}),{id:q.id,blockId:q.id,odePagId:q.blockId,blockName:q.blockName||"",iconName:q.iconName||"",order:q.order,odeNavStructureSyncId:Q,odeComponentsSyncs:H.map((R)=>{let O=R.htmlContent||"";console.debug(`[apiCallManager] _getComponentsByPageFromYjs: Component ${R.id} htmlView length: ${O.length}`);let A=Y?.assetManager;if(A&&O.includes("asset://"))O=A.resolveHTMLAssetsSync(O,{usePlaceholder:!0,addTracking:!0});return{id:R.id,odeId:R.id,odeIdeviceId:R.id,ideviceType:R.ideviceType,odeIdeviceTypeName:R.ideviceType,ideviceName:R.ideviceType?.replace("Idevice","")||"FreeText",order:R.order,htmlView:O,htmlViewName:O,jsonProperties:R.jsonProperties||"{}",odePagStructureSyncId:q.id,odeComponentsSyncProperties:[],fromYjs:!0,yjsComponentId:R.id}}),odePagStructureSyncProperties:V}});return{id:Q,odePageId:W.get("id")||Q,pageName:W.get("pageName")||"Page",order:W.get("order")||0,odePagStructureSyncs:G}}async getComponentHtmlTemplate(Q){return this._catalog.getComponentHtmlTemplate(Q)}async getSaveHtmlView(Q){return this._catalog.getSaveHtmlView(Q)}async putSaveHtmlView(Q){let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z._yjsBridge?.structureBinding){console.log("[apiCallManager] putSaveHtmlView: Saving to Yjs",Q);let X=Q.odeComponentsSyncId||Q.id;if(X&&Q.htmlView!==void 0)try{let J=Z._yjsBridge?.assetManager,W=Q.htmlView;if(J&&W&&typeof W==="string"){let z=W.includes("blob:"),G=J.convertBlobURLsToAssetRefs(W);if(G!==W)console.log("[apiCallManager] ✅ Converted blob URLs to asset URLs"),console.log("[apiCallManager] BEFORE:",W.substring(0,200)),console.log("[apiCallManager] AFTER:",G.substring(0,200));else if(z)console.warn("[apiCallManager] ⚠️ HTML had blob: URLs but conversion returned unchanged!"),console.warn("[apiCallManager] HTML preview:",W.substring(0,300));W=G}Z._yjsBridge.structureBinding.updateComponent(X,{htmlContent:W}),console.log("[apiCallManager] Saved htmlView to Yjs:",X)}catch(J){console.error("[apiCallManager] Error saving htmlView to Yjs:",J)}return{responseMessage:"OK"}}let Y=this.endpoints.api_idevices_html_view_save.path;return await this.func.put(Y,Q)}async putSaveIdevice(Q){let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z._yjsBridge?.structureBinding)return this._saveIdeviceToYjs(Q);let Y=this.endpoints.api_idevices_idevice_data_save.path;return await this.func.put(Y,Q)}_saveIdeviceToYjs(Q){let Y=eXeLearning?.app?.project?._yjsBridge,X=Y?.structureBinding;if(!X)return console.warn("[apiCallManager] _saveIdeviceToYjs: No structureBinding available"),{responseMessage:"ERROR",error:"Yjs not initialized"};let J=(V)=>{if(!V||typeof V!=="string")return V;let R=Y?.assetManager;if(R?.convertBlobURLsToAssetRefs){let O=V.includes("blob:"),A=R.convertBlobURLsToAssetRefs(V);if(A!==V)console.log("[apiCallManager] _saveIdeviceToYjs: ✅ Converted blob URLs to asset URLs"),console.log("[apiCallManager] _saveIdeviceToYjs BEFORE:",V.substring(0,200)),console.log("[apiCallManager] _saveIdeviceToYjs AFTER:",A.substring(0,200));else if(O)console.warn("[apiCallManager] _saveIdeviceToYjs: ⚠️ HTML had blob: URLs but conversion returned unchanged!"),console.warn("[apiCallManager] _saveIdeviceToYjs HTML:",V.substring(0,300));return A}return V},W=(V)=>{if(!V||typeof V!=="string")return V;if(!V.includes("blob:"))return V;try{let R=JSON.parse(V),O=!1;for(let A of Object.keys(R)){let M=R[A];if(typeof M==="string"&&M.includes("blob:")){let F=J(M);if(F!==M)R[A]=F,O=!0,console.log(`[apiCallManager] _saveIdeviceToYjs: ✅ Converted blob URLs in jsonProperties.${A}`)}}if(O)return JSON.stringify(R)}catch(R){console.warn("[apiCallManager] _saveIdeviceToYjs: Failed to parse jsonProperties:",R)}return V},z=Q.odeNavStructureSyncId||Q.odePageId,G=Q.odePagStructureSyncId||Q.odeBlockId,q=Q.odeComponentsSyncId||Q.odeIdeviceId||Q.id;console.log("[apiCallManager] _saveIdeviceToYjs:",{pageId:z,blockId:G,componentId:q,params:Q});let H=(V,R=!1)=>({responseMessage:"OK",odeComponentsSyncId:V,id:V,odeComponentsSync:{id:V,odeId:V,ideviceType:Q.odeIdeviceTypeName,odeComponentsSyncProperties:[]},newOdePagStructureSync:R,odePagStructureSync:{id:G,odePagId:G,odePagStructureSyncProperties:[]}}),K=q?X.getComponentMap(q):null;if(!K&&z&&G&&(Q.odeIdeviceTypeName||q)){let V=G;if(G==="new"||!X.getBlockMap(z,G))V=X.createBlock(z,Q.blockName||""),console.log("[apiCallManager] Created new block in Yjs:",V);let R=X.createComponent(z,V,Q.odeIdeviceTypeName||"FreeTextIdevice",{id:q,htmlContent:J(Q.htmlView)||"",iconName:Q.iconName,jsonProperties:Q.jsonProperties?W(Q.jsonProperties):void 0});return console.log("[apiCallManager] Created new iDevice in Yjs:",R),H(R||q,!0)}if(K&&q){let V={};if(Q.htmlView!==void 0)V.htmlContent=J(Q.htmlView);if(Q.jsonProperties!==void 0)V.jsonProperties=W(Q.jsonProperties);if(Q.order!==void 0)V.order=Q.order;try{X.updateComponent(q,V),console.log("[apiCallManager] Updated iDevice in Yjs:",q)}catch(R){console.error("[apiCallManager] Error updating iDevice in Yjs:",R)}return H(q,!1)}return console.warn("[apiCallManager] _saveIdeviceToYjs: Missing required IDs or component not found"),H(q,!1)}async putSavePropertiesIdevice(Q){let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z._yjsBridge?.structureBinding){console.log("[apiCallManager] putSavePropertiesIdevice: Saving to Yjs",Q);let X=Q.odeComponentsSyncId;if(X)try{let J=["visibility","teacherOnly","identifier","cssClass"],W={};for(let z of J)if(Q[z]!==void 0)W[z]=Q[z];Z._yjsBridge.structureBinding.updateComponent(X,{properties:W}),console.log("[apiCallManager] Saved properties to Yjs:",X,W)}catch(J){console.error("[apiCallManager] Error saving properties to Yjs:",J)}return{responseMessage:"OK"}}let Y=this.endpoints.api_idevices_idevice_properties_save.path;return await this.func.put(Y,Q)}async postEditIdevice(Q){return{responseMessage:"OK"}}async putReorderIdevice(Q){if(this._content)try{return await this._content.reorderIdevice(Q)}catch(Y){console.error("[API] putReorderIdevice via content adapter error:",Y)}let Z=this.endpoints.api_idevices_idevice_reorder.path;return await this.func.put(Z,Q)}async deleteIdevice(Q){let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z._yjsBridge?.structureBinding){console.log("[apiCallManager] deleteIdevice: Deleting from Yjs",Q);try{return Z._yjsBridge.structureBinding.deleteComponent(Q),console.log("[apiCallManager] Deleted iDevice from Yjs:",Q),{responseMessage:"OK"}}catch(X){return console.error("[apiCallManager] Error deleting iDevice from Yjs:",X),{responseMessage:"ERROR",error:X.message}}}let Y=this.endpoints.api_idevices_idevice_delete.path;return Y=Y.replace("{odeComponentsSyncId}",Q),await this.func.delete(Y)}async putSaveBlock(Q){let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z._yjsBridge?.structureBinding){console.log("[apiCallManager] putSaveBlock: Saving block in Yjs",Q);try{let X=Q.odePagStructureSyncId,J={};if(Q.blockName!==void 0)J.blockName=Q.blockName;if(Q.iconName!==void 0)J.iconName=Q.iconName;if(Q.order!==void 0)J.order=Q.order;if(Object.keys(J).length>0)Z._yjsBridge.structureBinding.updateBlock(X,J);return{responseMessage:"OK",odePagStructureSyncs:[],odePagStructureSync:{id:X,odePagId:X,blockName:Q.blockName,iconName:Q.iconName,order:Q.order}}}catch(X){return console.error("[apiCallManager] Error saving block in Yjs:",X),{responseMessage:"OK",odePagStructureSyncs:[]}}}let Y=this.endpoints.api_pag_structures_pag_structure_data_save.path;return await this.func.put(Y,Q)}async putSavePropertiesBlock(Q){let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z._yjsBridge?.structureBinding)try{console.log("[apiCallManager] putSavePropertiesBlock: Saving block properties in Yjs",Q);let X=Q.odePagStructureSyncId,J={};if(["visibility","teacherOnly","allowToggle","minimized","identifier","cssClass"].forEach((z)=>{if(Q[z]!==void 0)J[z]=Q[z]}),Object.keys(J).length>0)Z._yjsBridge.structureBinding.updateBlock(X,{properties:J});if(Q.blockName!==void 0)Z._yjsBridge.structureBinding.updateBlock(X,{blockName:Q.blockName});if(Q.iconName!==void 0)Z._yjsBridge.structureBinding.updateBlock(X,{iconName:Q.iconName});return{responseMessage:"OK",odePagStructureSyncs:[]}}catch(X){return console.error("[apiCallManager] Error saving block properties in Yjs:",X),{responseMessage:"OK",odePagStructureSyncs:[]}}let Y=this.endpoints.api_pag_structures_pag_structure_properties_save.path;return await this.func.put(Y,Q)}async putReorderBlock(Q){if(this._content)try{return await this._content.reorderBlock(Q)}catch(Y){console.error("[API] putReorderBlock via content adapter error:",Y)}let Z=this.endpoints.api_pag_structures_pag_structure_reorder.path;return await this.func.put(Z,Q)}async deleteBlock(Q){if(this._content)try{return await this._content.deleteBlock(Q)}catch(Y){console.error("[API] deleteBlock via content adapter error:",Y)}let Z=this.endpoints.api_pag_structures_pag_structure_delete.path;return Z=Z.replace("{odePagStructureSyncId}",Q),await this.func.delete(Z)}async putSavePage(Q){if(this._content)try{return await this._content.savePage(Q)}catch(Y){console.error("[API] putSavePage via content adapter error:",Y)}let Z=this.endpoints.api_nav_structures_nav_structure_data_save.path;return await this.func.put(Z,Q)}async putSavePropertiesPage(Q){let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z._yjsBridge?.structureBinding){console.log("[apiCallManager] putSavePropertiesPage: Saving page properties in Yjs",Q);try{let X=Q.odeNavStructureSyncId,J={};if(Q.titleNode!==void 0)J.pageName=Q.titleNode;if(Q.order!==void 0)J.order=Q.order;let W={};for(let[z,G]of Object.entries(Q))if(z!=="odeNavStructureSyncId"&&z!=="updateChildsProperties")W[z]=G;if(Object.keys(W).length>0)J.properties=W;if(Object.keys(J).length>0)Z._yjsBridge.structureBinding.updatePage(X,J);return{responseMessage:"OK",odeNavStructureSync:{id:X,odePageId:X,pageName:Q.titleNode,odeNavStructureSyncProperties:W}}}catch(X){return console.error("[apiCallManager] Error saving page properties in Yjs:",X),{responseMessage:"OK"}}}let Y=this.endpoints.api_nav_structures_nav_structure_properties_save.path;return await this.func.put(Y,Q)}async putReorderPage(Q){if(this._content)try{return await this._content.reorderPage(Q)}catch(Y){console.error("[API] putReorderPage via content adapter error:",Y)}let Z=this.endpoints.api_nav_structures_nav_structure_reorder.path;return await this.func.put(Z,Q)}async postClonePage(Q){if(this._content)try{return await this._content.clonePage(Q)}catch(Y){console.error("[API] postClonePage via content adapter error:",Y)}let Z=this.endpoints.api_nav_structures_nav_structure_duplicate.path;return await this.func.post(Z,Q)}async deletePage(Q){if(this._content)try{return await this._content.deletePage(Q)}catch(Y){console.error("[API] deletePage via content adapter error:",Y)}let Z=this.endpoints.api_nav_structures_nav_structure_delete.path;return Z=Z.replace("{odeNavStructureSyncId}",Q),await this.func.delete(Z)}async postUploadFileResource(Q){if(this._assets&&Q.file&&Q.projectId)try{return{responseMessage:"OK",...await this._assets.upload(Q.projectId,Q.file,Q.path||"")}}catch(Y){return console.error("[API] postUploadFileResource via adapter error:",Y),{responseMessage:"ERROR",error:Y.message}}let Z=this.endpoints.api_idevices_upload_file_resources.path;return await this.func.post(Z,Q)}async postUploadLargeFileResource(Q){if(this._assets&&Q.file&&Q.projectId)try{return{responseMessage:"OK",...await this._assets.upload(Q.projectId,Q.file,Q.path||"")}}catch(Y){return console.error("[API] postUploadLargeFileResource via adapter error:",Y),{responseMessage:"ERROR",error:Y.message}}let Z=this.endpoints.api_idevices_upload_large_file_resources.path;return await this.func.fileSendPost(Z,Q)}async send(Q,Z){if(!this.endpoints[Q])return console.warn("[apiCallManager] Endpoint not found:",Q),{responseMessage:"NOT_SUPPORTED"};let Y=this.endpoints[Q].path,X=this.endpoints[Q].method;return await this.func.do(X,Y,Z)}async getIdevicesBySessionId(Q){if(this._catalog)try{return await this._catalog.getIdevicesBySessionId(Q)}catch(Y){console.error("[API] getIdevicesBySessionId via catalog adapter error:",Y)}let Z=this.endpoints.api_games_session_idevices.path;return Z=Z.replace("{odeSessionId}",Q),await this.func.get(Z)}async getResourceLockTimeout(){return 900000}_buildProjectUrl(Q,Z=""){return(String(Q).includes("-")?`${this.apiUrlBase}${this.apiUrlBasePath}/api/projects/uuid/${Q}`:`${this.apiUrlBase}${this.apiUrlBasePath}/api/projects/${Q}`)+Z}async getProject(Q){if(this._sharing)try{return await this._sharing.getProject(Q)}catch(X){console.error("[API] getProject via adapter error:",X)}let Z=this._buildProjectUrl(Q,"/sharing"),Y=eXeLearning?.app?.project?._yjsBridge?.authToken||eXeLearning?.app?.auth?.getToken?.()||localStorage.getItem("authToken");try{let X=await fetch(Z,{method:"GET",headers:{"Content-Type":"application/json",...Y?{Authorization:`Bearer ${Y}`}:{}},credentials:"include"});if(!X.ok)return{responseMessage:"ERROR",detail:(await X.json().catch(()=>({}))).message||`HTTP ${X.status}`};return await X.json()}catch(X){return console.error("[API] getProject error:",X),{responseMessage:"ERROR",detail:X.message}}}async updateProjectVisibility(Q,Z){return this._sharing.updateVisibility(Q,Z)}async addProjectCollaborator(Q,Z,Y="editor"){return this._sharing.addCollaborator(Q,Z,Y)}async removeProjectCollaborator(Q,Z){return this._sharing.removeCollaborator(Q,Z)}async transferProjectOwnership(Q,Z){if(this._sharing)try{return await this._sharing.transferOwnership(Q,Z)}catch(J){console.error("[API] transferProjectOwnership via adapter error:",J)}let Y=this._buildProjectUrl(Q,"/owner"),X=eXeLearning?.app?.project?._yjsBridge?.authToken||eXeLearning?.app?.auth?.getToken?.()||localStorage.getItem("authToken");try{let J=await fetch(Y,{method:"PATCH",headers:{"Content-Type":"application/json",...X?{Authorization:`Bearer ${X}`}:{}},credentials:"include",body:JSON.stringify({newOwnerId:Z})});if(!J.ok)return{responseMessage:"ERROR",detail:(await J.json().catch(()=>({}))).message||`HTTP ${J.status}`};return await J.json()}catch(J){return console.error("[API] transferProjectOwnership error:",J),{responseMessage:"ERROR",detail:J.message}}}}class D0{constructor(Q){this.app=Q,this.lang=null,this.strings={},this.c_strings={},window._=(Z)=>{return this.getGUITranslation(Z)},window.c_=(Z)=>{if(Z=this.getContentTranslation(Z),Z=Z.replace(" (elp)"," (elpx)"),Z=Z.replace(" .elp "," .elpx "),Z=Z.replace(" elp "," elpx "),Z.endsWith(".elp"))Z+="x";return Z}}async init(){this.setLocaleLang(this.app.eXeLearning.config.locale),await this.loadTranslationsStrings()}async loadContentTranslationsStrings(Q){this.c_strings=await this.app.api.getTranslations(Q)}async setLocaleLang(Q){this.lang=Q,document.querySelector("body").setAttribute("lang",Q)}async loadTranslationsStrings(){this.strings=await this.app.api.getTranslations(this.lang),this.translateStaticUI()}translateStaticUI(){let Q={"#dropdownFile":"File","#dropdownUtilities":"Utilities","#dropdownHelp":"Help","#navbar-button-new":"New","#navbar-button-new-from-template":"New from Template...","#navbar-button-openuserodefiles":"Open","#navbar-button-dropdown-recent-projects":"Recent projects","#navbar-button-import-elp":"Import (.elpx…)","#navbar-button-save":"Save","#navbar-button-save-as":"Save as","#dropdownExportAs":"Download as...","#navbar-button-download-project":"eXeLearning content (.elpx)","#navbar-button-export-html5":"Website","#navbar-button-export-html5-sp":"Single page","#navbar-button-settings":"Settings","#navbar-button-share":"Share","#navbar-button-open-offline":"Open","#navbar-button-save-offline":"Save","#navbar-button-save-as-offline":"Save as","#dropdownExportAsOffline":"Export as...","#navbar-button-exportas-html5":"Website","#navbar-button-exportas-html5-folder":"Export to Folder (Unzipped Website)","#navbar-button-exportas-html5-sp":"Single page","#navbar-button-export-print":"Print","#dropdownUploadTo":"Upload to","#dropdownProperties":"Metadata","#navbar-button-import-xml-properties":"Import","#navbar-button-export-xml-properties":"Export","#navbar-button-idevice-manager":"iDevice manager","#navbar-button-odeusedfiles":"Resources report","#navbar-button-odebrokenlinks":"Link validation","#navbar-button-filemanager":"File manager","#navbar-button-styles":"Styles","#navbar-button-preview":"Preview","#navbar-button-preferences":"Preferences","#navbar-button-assistant":"Assistant","#navbar-button-exe-tutorial":"User manual","#navbar-button-api-docs":"API Reference (Swagger)","#navbar-button-about-exe":"About eXeLearning","#navbar-button-release-notes":"Release notes","#navbar-button-legal-notes":"Legal notes","#navbar-button-exe-web":"eXeLearning website","#navbar-button-report-bug":"Report a bug",'#head-top-save-button > span:not([class*="icon"])':"Save"};for(let[Y,X]of Object.entries(Q))document.querySelectorAll(Y).forEach((W)=>{let z=_(X),G=W.querySelector('span[class*="icon"], div[class*="icon"]');if(G)if(Array.from(W.childNodes).filter((H)=>H.nodeType===Node.TEXT_NODE).forEach((H)=>H.remove()),G.nextSibling&&G.nextSibling.nodeType===Node.TEXT_NODE)G.nextSibling.textContent=" "+z;else G.after(document.createTextNode(" "+z));else if(W.tagName==="A"||W.tagName==="BUTTON")if(W.querySelector(".shortcut, kbd")){let H=Array.from(W.childNodes).find((K)=>K.nodeType===Node.TEXT_NODE);if(H)H.textContent=z}else{let H=Array.from(W.childNodes).find((K)=>K.nodeType===Node.TEXT_NODE);if(H)H.textContent=z}else W.textContent=z});let Z={"#modalProperties .modal-title":"Preferences","#modalAbout .modal-title":"About eXeLearning","#modalReleaseNotes .modal-title":"Release notes","#modalLegalNotes .modal-title":"Legal notes"};for(let[Y,X]of Object.entries(Z)){let J=document.querySelector(Y);if(J)J.textContent=_(X)}}getGUITranslation(Q){if(typeof Q!="string")return"";if(Q=Q?Q.replace(/"/g,"\\\""):"",this.strings&&this.strings.translations&&Q in this.strings.translations){let Z=this.strings.translations[Q].replace(/\\"/g,'"').replace(/\\\//g,"/");if(Z.startsWith("~"))Z=Z.substring(1);return Z}else return Q.replace(/\\"/g,'"')}getContentTranslation(Q){if(typeof Q!="string")return"";if(Q=Q?Q.replace(/"/g,"\\\""):"",this.c_strings&&this.c_strings.translations&&Q in this.c_strings.translations){let Z=this.c_strings.translations[Q].replace(/\\"/g,'"').replace(/\\\//g,"/");if(Z.startsWith("~"))Z=Z.substring(1);return Z}else return Q.replace(/\\"/g,'"').replace(/\\\//g,"/")}getTranslation(Q,Z,Y){if(typeof Q!="string")return"";if(Q=Q?Q.replace(/"/g,"\\\""):"",Z=Z?Z:this.lang,Y){let X=`${Y}.${Q}`;if(this.strings&&this.strings.translations&&X in this.strings.translations)return this.strings.translations[X].replace(/\\"/g,'"')}if(this.strings&&this.strings.translations&&Q in this.strings.translations)return this.strings.translations[Q].replace(/\\"/g,'"');else return Q.replace(/\\"/g,'"')}}class j0{constructor(){}getDateYear(Q){return Q.getFullYear()}getDateMonth(Q){let Z=Q.getMonth()+1;if(Z<10)Z="0"+Z;return String(Z)}getDateDay(Q){let Z=Q.getDate();if(Z<10)Z="0"+Z;return String(Z)}getDateHour(Q){let Z=Q.getHours();if(Z<10)Z="0"+Z;return String(Z)}getDateMinutes(Q){let Z=Q.getMinutes();if(Z<10)Z="0"+Z;return String(Z)}getDateSeconds(Q){let Z=Q.getSeconds();if(Z<10)Z="0"+Z;return String(Z)}getDateMilliseconds(Q){let Z=Q.getMilliseconds();if(Z<10)Z="0"+Z;if(Z<100||String(Z).length<3)Z="0"+Z;return String(Z)}}class x0{constructor(Q){this.app=Q,this.dateConversion=new j0}generateId(){let Q=new Date,Z=this.dateConversion.getDateYear(Q),Y=this.dateConversion.getDateMonth(Q),X=this.dateConversion.getDateDay(Q),J=this.dateConversion.getDateHour(Q),W=this.dateConversion.getDateMinutes(Q),z=this.dateConversion.getDateSeconds(Q),G=this.dateConversion.getDateMilliseconds(Q),q=this.generateRandomString(3);return`${Z}${Y}${X}${J}${W}${z}${G}${q}`}initTooltips(Q){try{(Q instanceof Element?Q:document).querySelectorAll(".exe-app-tooltip").forEach((X)=>{if(!(window.bootstrap?.Tooltip?.getInstance?window.bootstrap.Tooltip.getInstance(X):null)&&window.bootstrap?.Tooltip?.getOrCreateInstance)window.bootstrap.Tooltip.getOrCreateInstance(X),X.addEventListener("click",()=>{try{window.bootstrap.Tooltip.getInstance(X)?.hide()}catch(W){}},{passive:!0}),X.addEventListener("mouseleave",()=>{try{window.bootstrap.Tooltip.getInstance(X)?.hide()}catch(W){}},{passive:!0})})}catch(Z){$(".exe-app-tooltip",Q).tooltip(),$(".exe-app-tooltip",Q).on("click mouseleave",function(){$(this).tooltip("hide")})}}markdownToHTML(Q){var Z=new showdown.Converter;return Z.setOption("noHeaderId",!0),Z.makeHtml(Q)}getVersionTimeStamp(){let Q=eXeLearning.version;if(eXeLearning.config.environment=="dev"||Q=="v0.0.0-alpha")return Date.now();return Q}generateRandomString(Q){var Z="",Y="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",X=Y.length;for(var J=0;J<Q;J++)Z+=Y.charAt(Math.floor(Math.random()*X));return Z}timer(Q){return new Promise((Z)=>{setTimeout(Z,Q)})}}var h2=window.AppLogger||console;class _0{constructor(Q,Z){if(this.manager=Q,this.id=Z.name,this.setConfigValues(Z),this.path=`${Q.symfonyURL}${Z.url}`,this.pathEdition=`${this.path}/edition/`,this.pathExport=`${this.path}/export/`,this.exportObject=null,this.exportJs.length>0)this.exportObject=this.getIdeviceObjectKey()}configParams=["apiVersion","author","authorUrl","category","componentType","cssClass","description","editionCss","editionJs","exportCss","exportJs","icon","license","licenseUrl","location","locationType","title","version","downloadable"];configParamsTranslatables=["title"];default={apiVersion:"3.0",author:"",authorUrl:"",category:"Others",componentType:"html",cssClass:"default",description:"",editionCss:[`${this.id}.css`],editionJs:[`${this.id}.js`],exportCss:[`${this.id}.css`],exportJs:[`${this.id}.js`],icon:{},license:"",licenseUrl:"",location:"",locationType:"",title:"Unknown",version:"1.0"};getIdeviceObjectKey(){return"$"+this.id.split("-").join("")}setConfigValues(Q){for(let[Z,Y]of Object.entries(Q)){let X=this.default[Z]?this.default[Z]:null,J=Y?Y:X;if(this.isTranslatable(Z))J=_(J,this.id);this[Z]=J}}isTranslatable(Q){return this.configParamsTranslatables.includes(Q)}isValid(){return this.id!=null}loadScriptsEdition(){let Q=[];for(let Z=0;Z<this.editionJs.length;Z++){let Y=this.editionJs[Z],X=`${this.pathEdition}${Y}`,J=this.getResourceServicePath(X),W=this.manager.app.project.idevices.loadScriptDynamically(J,!1);Q.push(W)}return Q}loadScriptsExport(){let Q=[];for(let Z=0;Z<this.exportJs.length;Z++){let Y=this.exportJs[Z],X=`${this.pathExport}${Y}`,J=this.getResourceServicePath(X),W=this.manager.app.project.idevices.loadScriptDynamically(J,!1);Q.push(W)}return Q}async loadStylesEdition(){let Q=[];for(let Z=0;Z<this.editionCss.length;Z++){let Y=this.editionCss[Z],X=`${this.pathEdition}${Y}`,J=this.getResourceServicePath(X),W=await this.manager.app.project.idevices.loadStyleByInsertingIt(J,this,"edition");Q.push(W)}return Q}async loadStylesExport(){let Q=[];for(let Z=0;Z<this.exportCss.length;Z++){let Y=this.exportCss[Z],X=`${this.pathExport}${Y}`,J=this.getResourceServicePath(X),W=await this.manager.app.project.idevices.loadStyleByInsertingIt(J,this,"export");Q.push(W)}return Q}getResourceServicePath(Q){if(Q.includes("/files/perm/idevices/"))return Q;let Z=this.manager.app.api.endpoints.api_idevices_download_file_resources;if(!Z)return Q;let Y=Z.path,X=Q.split("/files/"),J=X.length==2?X[1]:Q,W=`${Y}?resource=${J}`;return h2.log("[iDevice] getResourceServicePath:",{inputPath:Q,pathServiceResources:Y,pathSplit:X,pathParam:J,finalUrl:W}),W}}class w0{constructor(Q){this.manager=Q,this.installed={}}async load(){await this.loadIdevicesInstalled()}async loadIdevicesInstalled(){let Q=await this.manager.app.api.getIdevicesInstalled();if(Q&&Q.idevices)Q.idevices.forEach((Z)=>{let Y=new _0(this.manager,Z);this.installed[Z.name]=Y})}loadIdevice(Q){let Z=new _0(this.manager,Q);this.installed[Q.name]=Z}removeIdevice(Q){delete this.installed[Q]}getIdeviceInstalled(Q){for(let[Z,Y]of Object.entries(this.installed))if(Z==Q)return Y;return null}}class S0{constructor(Q){this.app=Q,this.list=new w0(this),this.symfonyURL=this.app.eXeLearning.config.fullURL}async loadIdevicesFromAPI(){await this.list.load()}showModalIdeviceManager(){this.app.modals.idevicemanager.show(this.list)}ideviceEngineBehaviour(){this.app.project.idevices.behaviour()}getIdeviceActive(){return this.app.project.idevices.getIdeviceActive()}getIdeviceById(Q){return this.app.project.idevices.getIdeviceById(Q)}setIdeviceActive(Q){return this.app.project.idevices.setIdeviceActive(Q)}unsetIdeviceActive(){return this.app.project.idevices.setIdeviceActive(void 0)}getIdeviceInstalled(Q){return this.list.getIdeviceInstalled(Q)}getIdeviceInstallEditionPath(Q){let Z=this.getIdeviceInstalled(Q);if(Z)return Z.pathEdition;else return""}getIdeviceInstalledExportPath(Q){let Z=this.getIdeviceInstalled(Q);if(Z)return Z.pathExport;else return""}}var D2=window.AppLogger||console;class T0{constructor(Q){this.properties=Q,this.metadataProperties={},this.categories=[],this.cataloguingCategoryKey="cataloguing",this.nodeContent=document.querySelector("#main #workarea #node-content"),this.addBehaviourBodyToHideHelpDialogs(),this.yjsBinding=null}show(){this.combineMetadataProperties();let Q=this.makeBodyElement(this.metadataProperties);this.setBodyElement(Q),this.addBehaviourExeHelp(),this.initYjsBinding(),setTimeout(()=>{this.focusTextInput(this.nodeContent.querySelector('input[type="text"'))},500)}initYjsBinding(){let Q=this.properties.project;if(Q._yjsBridge&&Q._yjsBridge.initialized){let Z=Q._yjsBridge.getDocumentManager();if(Z&&Z.initialized&&window.YjsPropertiesBinding){if(this.yjsBinding)this.yjsBinding.unbindForm();this.yjsBinding=new window.YjsPropertiesBinding(Z),this.yjsBinding.bindForm(this.propertiesFormElement),D2.log("[FormProperties] Yjs binding initialized - changes sync automatically")}}}combineMetadataProperties(){if(this.metadataProperties={},this.metadataPropertiesBase=Object.assign({},this.properties.properties,this.properties.cataloguing),eXeLearning.app.user.preferences.preferences.advancedMode.value=="true")this.metadataProperties=this.metadataPropertiesBase;else for(let[Q,Z]of Object.entries(this.metadataPropertiesBase))if(Z.alwaysVisible)this.metadataProperties[Q]=Z;return this.metadataProperties}setBodyElement(Q){if(this.propertiesFormElement=this.nodeContent.querySelector("#properties-node-content-form"),this.propertiesFormElement)this.propertiesFormElement.replaceWith(Q);else this.propertiesFormElement=Q,this.nodeContent.append(this.propertiesFormElement)}remove(){if(this.yjsBinding)this.yjsBinding.unbindForm(),this.yjsBinding=null;if(this.propertiesFormElement)this.propertiesFormElement.remove()}makeBodyElement(Q){let Z=document.createElement("form");Z.id="properties-node-content-form",Z.classList.add("loading"),Z.setAttribute("novalidate","");let Y=document.createElement("div");Y.classList.add("exe-properties-form-content"),Z.append(Y);let X=document.createElement("div");return X.classList.add("exe-table-content"),X.classList.add("pb-1"),this.addRowsFlatWithSectionTitles(Q,X),Y.append(X),setTimeout(()=>Z.classList.remove("loading"),100),Z}addRowsFlatWithSectionTitles(Q,Z){let Y=Object.entries(Q);Y=Y.sort((W,z)=>{if(W[1].multipleId&&z[1].multipleId&&W[1].multipleId===z[1].multipleId){if(W[1].multipleIndex===z[1].multipleIndex)return 0;return W[1].multipleIndex>z[1].multipleIndex?1:-1}else if(W[1].multipleId&&z[1].multipleId&&W[1].prefix===z[1].prefix)if(W[1].multipleIndex===z[1].multipleIndex){if(W[1].index===z[1].index)return 0;return W[1].index>z[1].index?1:-1}else{if(W[1].multipleIndex===z[1].multipleIndex)return 0;return W[1].multipleIndex>z[1].multipleIndex?1:-1}else return 0});let X=new Map,J=(W,z,G)=>{if(X.has(W))return X.get(W);let q=document.createElement("div");q.classList.add("properties-group","properties-body-container","form-properties"),q.setAttribute("data-group",W);let H=document.createElement("div");H.classList.add("properties-group-title");let K=`collapse-${W}`;if(H.setAttribute("data-bs-toggle","collapse"),H.setAttribute("data-bs-target",`#${K}`),H.setAttribute("role","button"),D2.log(W,z,G),W==="properties_package")H.setAttribute("aria-expanded","true");else H.classList.add("collapsed"),H.setAttribute("aria-expanded","false");H.setAttribute("aria-controls",K);let V="<span class='title-text'>"+_(z)+"</span>";if(Object.keys(G.category||{"":""})[0]==this.cataloguingCategoryKey)if(G.required)V="* "+V+" · <span class='required-text'>("+_("Required")+")</span>";else V+=" · <span class='optional-text'>("+_("Optional")+")</span>";H.innerHTML="<h2 class='title'>"+V+"</h2>";let O=document.createElement("div");if(W==="properties_package")O.classList.add("collapse","show");else O.classList.add("collapse");return O.id=K,q.append(H,O),Z.append(q),X.set(W,O),O};for(let[W,z]of Y){let G=null,q=null;if(z.groups&&Object.keys(z.groups).length)G=Object.keys(z.groups)[0],q=z.groups[G];let H;if(G)H=J(G,q,z);else{if(!X.has("__no_group__")){let R=document.createElement("div");R.classList.add("properties-group"),R.setAttribute("data-group","no-group"),X.set("__no_group__",R),Z.append(R)}H=X.get("__no_group__")}let K=this.makeRowElement(W,z);if(K)H.append(K)}}makeRowElement(Q,Z){Z.id=Q;let Y=Z.multipleId?Z.multipleId:Z.id,X=Y+"-"+eXeLearning.app.common.generateId(),J=document.createElement("div");if(J.id=X+"-container",J.classList.add("property-row"),J.setAttribute("property",Z.id),J.setAttribute("type",Z.type),J.setAttribute("category",Object.keys(Z.category||{"":""})[0]),J.setAttribute("group",Z.groups?Object.keys(Z.groups).pop():""),J.setAttribute("duplicate",Z.duplicate?Z.duplicate:!1),Z.multipleId)J.classList.add("copied-row");let W=this.makeRowElementLabel(X,Z),z=this.makeRowValueElement(X,Y,Z),G=this.makeRowElementHelp(Z),q=this.makeRowActionsElement(Z,J);if(q&&Z.multipleId)q.setAttribute("original",!1);if(Z.type=="checkbox"){let H=document.createElement("span");H.classList.add("toggle-item"),H.style.cursor="pointer";let K=document.createElement("span");K.classList.add("toggle-control");let V=document.createElement("span");if(V.classList.add("toggle-visual"),V.setAttribute("aria-hidden","true"),z.classList.add("toggle-input"),K.append(z,V),W.classList.add("toggle-label","mb-0"),W.style.cursor="pointer",H.addEventListener("click",(R)=>{if(R.target!==z)R.preventDefault(),z.checked=!z.checked,z.dispatchEvent(new Event("change",{bubbles:!0}))}),W.addEventListener("click",(R)=>{R.preventDefault(),R.stopPropagation(),z.checked=!z.checked,z.dispatchEvent(new Event("change",{bubbles:!0}))}),H.append(K,W),J.append(H),G)G.classList.add("ms-2"),J.append(G);if(q)q.classList.add("ms-2"),J.append(q)}else{let H=document.createElement("div");if(H.classList.add("header-container","d-flex","align-items-center","gap-2","mb-1"),W.classList.add("form-label","mb-0"),H.append(W),G)H.append(G);J.append(H);let K=document.createElement("div");if(K.classList.add("d-flex","align-items-center","gap-2","flex-nowrap","content-field"),K.append(z),q)q.classList.add("mt-1"),K.append(q);J.append(K)}return J}makeRowElementLabel(Q,Z){let Y=document.createElement("label"),X=_(Z.title);if(Z.required)X="* "+X;return Y.innerHTML=X,Y.setAttribute("for",Q),Y}makeRowValueElement(Q,Z,Y){let X;switch(Y.type){case"text":X=document.createElement("input"),X.value=Y.value;break;case"checkbox":X=document.createElement("input"),X.checked=Y.value=="true"?!0:!1,X.classList.add("toggle-input");break;case"date":X=document.createElement("input"),X.value=Y.value;break;case"textarea":X=document.createElement("textarea"),X.innerHTML=Y.value,X.value=Y.value;break;case"select":X=document.createElement("select");for(let[J,W]of Object.entries(Y.options||{})){let z=document.createElement("option");if(z.value=J,z.innerHTML=W,J===Y.value)z.setAttribute("selected","selected");X.append(z)}break;default:X=document.createElement("div");break}switch(X=this.addAttributesRowValueElement(Q,Z,Y,X),Y.type){case"select":X.classList.add("form-select");break;case"textarea":X.classList.add("form-control"),X.setAttribute("rows",Y.rows?Y.rows:3);break;case"checkbox":break;case"date":case"text":default:X.classList.add("form-control");break}return X}addAttributesRowValueElement(Q,Z,Y,X){X.id=Q,X.setAttribute("name",Q),X.setAttribute("property",Z),X.setAttribute("type",Y.type),X.setAttribute("category",Y.category?Object.keys(Y.category)[0]:""),X.setAttribute("group",Y.groups?Object.keys(Y.groups).pop():""),X.setAttribute("data-type",Y.type),X.classList.add("property-value");let J={titleNode:"prop-title",editableInPage:"prop-editable-in-page",visibility:"prop-visible-export",description:"prop-description",titlePage:"prop-title-page",titleHtml:"prop-title-html"},W=(G)=>(G||"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),z=J[Y.id]||`prop-${W(Y.id)}`;if(X.setAttribute("data-testid",z),X.addEventListener("focus",()=>this.hideHelpContentAll()),Y.required)X.setAttribute("required",""),X.classList.add("required");if(Y.readonly)X.setAttribute("readonly","");if(Y.onchange)X.addEventListener("change",()=>{let G;switch(Y.type){case"select":G=X.selectedOptions[0].innerHTML.trim();break;default:G=X.value.trim();break}this.propertiesFormElement.querySelector(`#${Y.onchange} input`).value=G});return X}makeRowElementHelp(Q){if(Q.help){let Z=document.createElement("div");Z.classList.add("exe-form-help","help-content-disabled");let Y=document.createElement("span");Y.classList.add("form-help-exe-icon","icon-medium","info-icon-solid-green");let X=document.createElement("span");return X.classList.add("help-content","help-hidden"),X.innerHTML=_(Q.help),Z.append(Y,X),Z}else return!1}makeRowActionsElement(Q,Z){let Y=!1;if(Q.duplicate){Y=document.createElement("div"),Y.classList.add("actions-duplicate-properties-container","d-inline-flex","align-items-center","gap-2"),Y.setAttribute("duplicate",Q.duplicate),Y.setAttribute("original","true");let X=document.createElement("div");X.classList.add("exe-icon","add-properties"),X.setAttribute("duplicate",Q.duplicate),X.innerHTML="add_circle_outline",this.addEventClickToActionAddButton(X,Q.duplicate,Q,Z),Y.append(X);let J=document.createElement("div");J.classList.add("exe-icon","delete-properties"),J.setAttribute("duplicate",Q.duplicate),J.innerHTML="remove_circle_outline",this.addEventClickToActionDeleteButton(J,Q.duplicate,Q,Z),Y.append(J)}return Y}addEventClickToActionAddButton(Q,Z,Y,X){Q.addEventListener("click",()=>{let J=[],W=X;for(let z=0;z<Z;z++)if(W){let G=this.cloneRowElement(W,Y,z);if(J.push(G),z<Z-1)W=W.nextElementSibling}J.reverse().forEach((z)=>{this.insertAfter(W,z),z.querySelectorAll(".actions-duplicate-properties-container").forEach((G)=>{let q=G.parentNode.previousSibling;if(G&&q){let H=q.classList.contains("property-row")||z.classList.contains("first-copied-row");G.setAttribute("original",!H)}})})})}addEventClickToActionDeleteButton(Q,Z,Y,X){Q.addEventListener("click",()=>{let J=X.parentNode,W=X.querySelector(".property-value").getAttribute("property"),z=Q.parentNode.getAttribute("original")=="true",G=J.querySelectorAll(`.property-value[property="${W}"]`);if((G?G.length:0)>1&&!z){let H=[],K=X;for(let V=0;V<Z;V++){if(K&&K!=X&&K.classList.contains("first-copied-row"))break;if(H.push(K),V<Z-1)K=K.nextElementSibling?K.nextElementSibling:!1}H.forEach((V)=>{if(V)V.remove()})}})}cloneRowElement(Q,Z,Y){let X=Q.cloneNode(!0),J=X.querySelector("label"),W=X.querySelector(".property-value"),z=X.getAttribute("property"),G=this.metadataProperties[z];if(X.classList.add("copied-row"),J)J.classList.add("copied");if(W)W.classList.add("copied");if(Y==0)X.classList.add("first-copied-row");else X.classList.remove("first-copied-row");X.id=`${X.id.split("-")[0]}-${eXeLearning.app.common.generateId()}-container`;let q=`${Q.id}-${eXeLearning.app.common.generateId()}`;if(J)J.id=q,J.setAttribute("for",q),J.addEventListener("click",()=>{W?.focus()});if(W){if(W.id=q,W.setAttribute("name",q),W.setAttribute("groupCopied",Z.groups?Object.keys(Z.groups).pop():""),W.tagName.toLowerCase()!=="select")W.value=""}let H=X.querySelector(".actions-duplicate-properties-container");if(H){let K=H.getAttribute("duplicate"),V=H.querySelector(".add-properties"),R=H.querySelector(".delete-properties");this.addEventClickToActionAddButton(V,K,G,X),this.addEventClickToActionDeleteButton(R,K,G,X)}return X}addBehaviourExeHelp(){this.nodeContent.querySelectorAll(".exe-form-help").forEach((Z)=>{let Y=Z.querySelector(".help-content");Z.setAttribute("title",_("Information")),this.hideHelpContent(Z),Z.querySelector(".form-help-exe-icon").addEventListener("click",()=>{let X=Y.classList.contains("help-hidden");if(this.hideHelpContentAll(),X)this.showHelpContent(Z)})})}addBehaviourBodyToHideHelpDialogs(){document.querySelector("body").addEventListener("click",(Q)=>{if(!Q.target.classList.contains("form-help-exe-icon"))this.hideHelpContentAll()})}showHelpContent(Q){Q.querySelector(".help-content").classList.remove("help-hidden"),Q.classList.add("help-content-active"),Q.classList.remove("help-content-disabled")}hideHelpContent(Q){Q.querySelector(".help-content").classList.add("help-hidden"),Q.classList.add("help-content-disabled"),Q.classList.remove("help-content-active")}hideHelpContentAll(){this.nodeContent.querySelectorAll(".exe-form-help").forEach((Z)=>this.hideHelpContent(Z))}focusTextInput(Q){if(Q){Q.focus();let Z=Q.value;Q.value="",Q.value=Z}}insertAfter(Q,Z){Q.parentNode.insertBefore(Z,Q.nextSibling)}reloadValues(){this.combineMetadataProperties();for(let[Q,Z]of Object.entries(this.metadataProperties)){let Y;if(Z.multipleId)Y=this.nodeContent.querySelectorAll(`.property-value[property="${Z.multipleId}"]`)[Z.multipleIndex-1];else Y=this.nodeContent.querySelector(`.property-value[property="${Q}"]`);if(!Y)continue;switch(Z.type){case"checkbox":Y.checked=Z.value=="true"?!0:!1;break;case"select":{let X=Y.querySelector(`option[value="${Z.value}"]`);if(X)X.setAttribute("selected","selected");break}case"text":case"date":case"textarea":default:Y.value=Z.value;break}}}}var b2=window.AppLogger||console;class P0{categoryPropertiesId="properties";categoryCataloguingId="cataloguing";constructor(Q){this.project=Q,this.formProperties=new T0(this)}async load(){this.propertiesConfig=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.odeProjectSyncPropertiesConfig)),this.properties={};for(let[Q,Z]of Object.entries(this.propertiesConfig))for(let[Y,X]of Object.entries(Z))this.properties[Y]=X;this.cataloguingConfig=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.odeProjectSyncCataloguingConfig)),this.cataloguing={};for(let[Q,Z]of Object.entries(this.cataloguingConfig))for(let[Y,X]of Object.entries(Z))this.cataloguing[Y]=X;this.loadPropertiesFromYjs()}showModalProperties(){eXeLearning.app.modals.properties.show({node:this,title:_("Project properties"),contentId:"project-properties",properties:this.properties,fullScreen:!0})}loadPropertiesFromYjs(){try{let Q=this.project._yjsBridge?.getDocumentManager();if(!Q){console.warn("[ProjectProperties] Yjs document manager not available");return}let Z=Q.getMetadata();if(!Z){console.warn("[ProjectProperties] Yjs metadata map not available");return}for(let[Y,X]of Object.entries(this.properties)){let J=this.mapPropertyToMetadataKey(Y),W=Z.get(J);if(W!==void 0)this.properties[Y].value=W}b2.log("[ProjectProperties] Loaded properties from Yjs metadata")}catch(Q){console.error("[ProjectProperties] Failed to load from Yjs:",Q)}}mapPropertyToMetadataKey(Q){if(Q.startsWith("pp_"))return Q.substring(3);return Q}updateTitlePropertiesStructureNode(){this.project.structure.setTitleToNodeRoot()}updateTitlePropertiesMenuTop(){this.project.app.interface.odeTitleElement.setTitle()}}var N=window.AppLogger||console;class $0{constructor(Q,Z){this.engine=Q,this.id=Z.id?Z.id:null;let Y=eXeLearning?.app?.project?._yjsEnabled;this.odeIdeviceId=Z.odeIdeviceId?Z.odeIdeviceId:Y?`idevice-${Date.now()}-${Math.random().toString(36).substr(2,9)}`:this.engine.generateId(),this.odeIdeviceTypeName=Z.odeIdeviceTypeName?Z.odeIdeviceTypeName:"",this.idevice=this.findInstalledIdevice(this.odeIdeviceTypeName),this.setParams(Z),this.fromYjs=Z.fromYjs||!1,this.yjsComponentId=Z.yjsComponentId||null,this.accesibility=1,this.loading=Z.loading?Z.loading:this.id?!1:!0,this.visibility=!0,this.haveEdition=!0,this.canHaveHeirs=!1,this.isSync=Z.isSync?Z.isSync:!1,this.scriptsElements=[],this.stylesElements=[],this.ideviceContent=null,this.ideviceBody=null,this.ideviceButtons=null,this.checkDeviceLoadInterval=null,this.interval=100;let X=this.engine.clientCallWaitingTime||5000;this.checkDeviceLoadNumMax=Math.round(X/this.interval),this.checkIsValid(),this.offlineInstallation=eXeLearning.config.isOfflineInstallation,this.nodeContainer=document.querySelector("#node-content-container"),this.timeIdeviceEditing=null,this.editUnlockDevice=null,this.inactivityCleanup=null,this.inactivityTimer=null,document.addEventListener("DOMContentLoaded",this.checkIdeviceIsEditing())}properties=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.odeComponentsSyncPropertiesConfig));params=["odeNavStructureSyncId","odePagStructureSyncId","odeSessionId","odeVersionId","blockId","parent","order","mode","htmlView","jsonProperties"];default={order:0,mode:"edition",htmlView:"",jsonProperties:"{}"};parseParams=["jsonProperties"];isYjsEnabled(){return eXeLearning.app?.project?._yjsEnabled===!0}loadPropertiesFromYjs(){if(!this.isYjsEnabled())return;let Z=eXeLearning.app.project._yjsBridge;if(!Z||!Z.structureBinding)return;let Y=Z.structureBinding.getComponentProperties(this.odeIdeviceId);if(Y){for(let[X,J]of Object.entries(Y))if(this.properties[X])if(typeof J==="boolean")this.properties[X].value=J?"true":"false";else this.properties[X].value=J;N.log("[IdeviceNode] Loaded properties from Yjs:",this.odeIdeviceId,Y)}}setParams(Q){for(let[Z,Y]of Object.entries(this.params)){let X=this.default[Y]!=null?this.default[Y]:null,J=Q[Y]?Q[Y]:X;this[Y]=this.parseParams.includes(Y)?JSON.parse(J):J}if(Q.htmlView!==void 0)console.debug(`[IdeviceNode] setParams: Component ${Q.odeIdeviceId||Q.id} htmlView length: ${this.htmlView?.length||0}`);if(Q.odeComponentsSyncProperties)this.setProperties(Q.odeComponentsSyncProperties)}setProperties(Q,Z){for(let[Y,X]of Object.entries(this.properties)){if(!Q||!Q[Y])continue;if(Z){if(Q[Y].heritable)X.value=Q[Y].value}else X.value=Q[Y].value}if(this.ideviceContent)this.setPropertiesClassesToElement()}makeIdeviceContentNode(Q){if(Q)this.ideviceContent=document.createElement("div");else{this.ideviceContent.classList.remove(...this.ideviceContent.classList);while(this.ideviceContent.attributes.length>0)this.ideviceContent.removeAttribute(this.ideviceContent.attributes[0].name)}if(this.ideviceContent.id=this.odeIdeviceId,this.ideviceContent.classList.add("idevice_node"),this.ideviceContent.classList.add("idevice-element-in-content"),this.ideviceContent.classList.add("draggable"),this.idevice&&this.idevice.name)this.ideviceContent.classList.add(this.idevice.name);if(this.ideviceContent.setAttribute("mode",this.mode),this.ideviceContent.setAttribute("loading",this.loading),this.ideviceContent.setAttribute("order",this.order),this.ideviceContent.setAttribute("drag","idevice"),Q)this.ideviceContent.appendChild(this.makeIdeviceBodyElement());return this.ideviceContent.prepend(this.makeIdeviceButtonsElement()),this.setPropertiesClassesToElement(),this.ideviceContent}setPropertiesClassesToElement(){if(this.properties.identifier.value!="")this.ideviceContent.setAttribute("identifier",this.properties.identifier.value);if(this.properties.visibility.value!="")this.ideviceContent.setAttribute("export-view",this.properties.visibility.value);if(this.properties.cssClass.value!="")(this.properties.cssClass.value?this.properties.cssClass.value.split(" "):[]).forEach((Z)=>{this.ideviceContent.classList.add(Z)})}makeIdeviceBodyElement(){if(this.ideviceBody=document.createElement("div"),this.ideviceBody.classList.add("idevice_body"),this.ideviceBody.classList.add("idevice-element-in-content"),this.idevice&&this.idevice.cssClass)this.ideviceBody.classList.add(`${this.idevice.cssClass}Idevice`);return this.ideviceBody.setAttribute("idevice-id",this.odeIdeviceId),this.ideviceBody.id=this.odeIdeviceId,this.addBehaviourEditionIdeviceDoubleClick(),this.ideviceBody}makeIdeviceButtonsElement(){if(!this.ideviceContent.querySelector(".idevice_actions"))this.ideviceButtons=document.createElement("div"),this.ideviceButtons.classList.add("idevice_actions"),this.ideviceButtons.classList.add("idevice-element-in-content"),this.ideviceButtons.setAttribute("drag","idevice"),this.ideviceButtons.setAttribute("idevice-id",this.odeIdeviceId),this.engine.addEventDragStartToContentIdevice(this.ideviceButtons),this.engine.addEventDragEndToContentIdevice(this.ideviceButtons);else this.ideviceButtons.querySelectorAll(".button-action-idevice").forEach((J)=>{J.remove()});let Q=this.odeIdeviceId,Z,Y="",X=$("#"+this.odeIdeviceId).height();if(!isNaN(X)){if(X<200)Y=" dropdown-menu-with-cols"}switch(this.mode){case"edition":Z=`
                <div class="exe-actions-menu">
                    <button class="btn-action-menu btn button-secondary secondary-green button-square button-combo combo-left d-flex justify-content-center align-items-center btn-save-idevice" type="button" id=saveIdevice${Q} title="${_("Save")}"><span class="small-icon save-icon-green" aria-hidden="true"></span>${_("Save")}</button>
                    <button class="btn-action-menu btn button-secondary secondary-green button-square button-combo combo-center d-flex justify-content-center align-items-center btn-delete-idevice exe-advanced" type="button" id=deleteIdevice${Q} title="${_("Delete")}"><span class="small-icon delete-icon-green" aria-hidden="true"></span><span class='visually-hidden'>${_("Delete")}</span></button>
                    <button class="btn-action-menu btn button-secondary secondary-green button-square button-combo combo-right d-flex justify-content-center align-items-center btn-undo-idevice" type="button" id=undoIdevice${Q} title="${_("Discard changes")}"><span class="small-icon undo-icon-green" aria-hidden="true"></span><span class='visually-hidden'>${_("Discard changes")}</span></button>
                </div>`,this.ideviceButtons.innerHTML=Z,this.ideviceButtons.setAttribute("draggable",!1),this.addBehaviourSaveIdeviceButton(),this.addBehaviourUndoIdeviceButton(),this.addBehaviourDeleteIdeviceButton(),this.addNoTranslateForGoogle();break;case"export":let J=" disabled",W="",z=this.isLockedByOtherUser();if(this.haveEdition&&this.valid&&!z)J="";if(z){let K=this.getLockInfo(),V=K?.lockUserName||this.lockUserName||_("Another user");W=`<span class="lock-indicator" style="color: ${K?.lockUserColor||this.lockUserColor||"#999"}; font-size: 10px; margin-left: 4px;" title="${_("Editing by")} ${V}">\uD83D\uDD12 ${V}</span>`}let G="chevron-down-icon-green";if($("div.idevice_body[idevice-id='"+this.odeIdeviceId+"']").is(":hidden"))G="chevron-up-icon-green";let H=this._getIdeviceTypeIconHtml();Z=`
                <div class="dropdown exe-actions-menu">
                    <div class="idevice-editor-avatar" data-component-id="${Q}"></div>
                    ${H}
                    <button class="btn-action-menu btn button-secondary secondary-green button-narrow button-combo combo-left d-flex justify-content-center align-items-center btn-move-up-idevice" type="button" id=moveUpIdevice${Q} title="${_("Move up")}"><span class="small-icon arrow-up-icon-green" aria-hidden="true"></span><span class='visually-hidden'>${_("Move up")}</span></button>
                    <button class="btn-action-menu btn button-secondary secondary-green button-narrow button-combo combo-right d-flex justify-content-center align-items-center btn-move-down-idevice" type="button" id=moveDownIdevice${Q} title="${_("Move down")}"><span class="small-icon arrow-down-icon-green" aria-hidden="true"></span><span class='visually-hidden'>${_("Move down")}</span></button>
                    <button class="btn-action-menu btn button-secondary secondary-green button-square button-combo combo-left d-flex justify-content-center align-items-center btn-edit-idevice ${J}" type="button" id=editIdevice${Q} title="${_("Edit")}" ${J}><span class="small-icon edit-icon-green" aria-hidden="true"></span>${_("Edit")}${W}</button>
                    <button class="btn-action-menu btn-action-menu btn button-secondary secondary-green button-square button-combo combo-center d-flex justify-content-center align-items-center btn-delete-idevice" type="button" id=deleteIdevice${Q} title="${_("Delete")}"><span class="small-icon delete-icon-green" aria-hidden="true"></span><span class='visually-hidden'>${_("Delete")}</span></button>                    
                    <button class="btn-action-menu btn-action-menu btn button-secondary secondary-green button-square button-combo combo-right d-flex justify-content-center align-items-center exe-advanced" type="button" id="dropdownMenuButtonIdevice${Q}" data-bs-toggle="dropdown" aria-expanded="false" title="${_("Actions")}"><span class="micro-icon dots-menu-horizontal-icon-green" aria-hidden="true"></span><span class='visually-hidden'>${_("Actions")}</span></button>
                    <ul class="dropdown-menu${Y} button-action-block exe-advanced" aria-labelledby="dropdownMenuButtonIdevice${Q}">
                        <li><button class="dropdown-item button-action-block" id="propertiesIdevice${Q}"><span class="small-icon settings-icon-green" aria-hidden="true"></span>${_("Properties")}</button></li>
                        <li><button class="dropdown-item button-action-block" id="cloneIdevice${Q}"><span class="small-icon duplicate-icon-green" aria-hidden="true"></span>${_("Clone")}</button></li>
                        <li><button class="dropdown-item button-action-block" id="moveIdevice${Q}"><span class="small-icon move-icon-green" aria-hidden="true"></span>${_("Move to")}</button></li>
                        <li class="exe-advanced"><button class="dropdown-item button-action-block" id="exportIdevice${Q}"><span class="small-icon download-icon-green" aria-hidden="true"></span>${_("Export")}</span></button></li>
                    </ul>
                    <button class="btn-action-menu btn button-secondary secondary-green button-narrow button-combo combo-left d-flex justify-content-center align-items-center btn-minify-idevice" type="button" id=minifyIdevice${Q} title="${_("Toggle content")}"><span id="minifyIdevice${Q}icon" class="small-icon ${G}" aria-hidden="true"></span><span class='visually-hidden'>${_("Toggle content")}</span></button>
                </div>`,this.ideviceButtons.innerHTML=Z,this.ideviceButtons.setAttribute("draggable",!0),this.addBehaviourEditionIdeviceButton(),this.addBehaviourMoveUpIdeviceButton(),this.addBehaviourMoveDownIdeviceButton(),this.addBehaviourDeleteIdeviceButton(),this.addBehaviourPropertiesIdeviceButton(),this.addBehaviouCloneIdeviceButton(),this.addBehaviourMoveToPageIdeviceButton(),this.addBehaviourExportIdeviceButton(),this.addBehaviourMinifyIdeviceButton(),this.addNoTranslateForGoogle();break}return this.addTooltips(),this.ideviceButtons}toogleIdeviceButtonsState(Q){if(!this.ideviceButtons)return;this.ideviceButtons.querySelectorAll(".button-action-idevice").forEach((Z)=>{Z.disabled=Q})}isLockedByOtherUser(){if(this.lockedByRemote)return!0;let Q=this.getLockManager();if(!Q)return!1;let Z=this.yjsComponentId||this.odeIdeviceId;return Q.isLocked(Z)}getLockInfo(){if(this.lockedByRemote)return{lockUserName:this.lockUserName||_("Another user"),lockUserColor:this.lockUserColor||"#999"};let Q=this.getLockManager();if(!Q)return null;let Z=this.yjsComponentId||this.odeIdeviceId,Y=Q.getLockInfo(Z);if(Y)return{lockUserName:Y.user?.name||_("Another user"),lockUserColor:Y.user?.color||"#999",clientId:Y.clientId,timestamp:Y.timestamp};let X=this.engine?.project?._yjsBridge;if(X){let J=X.structureBinding?.getComponentMap(Z);if(J)return{lockUserName:J.get("lockUserName")||_("Another user"),lockUserColor:J.get("lockUserColor")||"#999"}}return null}getLockManager(){return this.engine?.project?._yjsBridge?.lockManager||null}updateLockIndicator(){if(this.ideviceButtons)this.makeIdeviceButtonsElement()}createAddTextBtn(){eXeLearning.app.menus.menuStructure.engine.menuStructureBehaviour.createAddTextBtn()}inactivityInElement(Q,Z,Y){if(N.log(`Setting up inactivity tracker for ${Q}`),!Q)return console.error("Element ID is undefined"),()=>{};if(this.inactivityTimer)clearTimeout(this.inactivityTimer),this.inactivityTimer=null;let X=document.getElementById(Q);if(!X)return N.log(`Element with ID ${Q} not found`),()=>{};if(!this.inactivityTimers)this.inactivityTimers={};if(!this.inactiveStates)this.inactiveStates={};if(this.inactivityTimers[Q])clearTimeout(this.inactivityTimers[Q]);let J=()=>{if(this.inactiveStates[Q])N.log(`[Inactivity] User is active again, sending HIDE_UNLOCK for ${Q}`),this.updateResourceLockStatus({odeIdeviceId:this.odeIdeviceId,blockId:this.blockId,actionType:"HIDE_UNLOCK_BUTTON",destinationPageId:this.block?.pageId??""}),this.inactiveStates[Q]=!1;clearTimeout(this.inactivityTimers[Q]),this.inactivityTimers[Q]=setTimeout(()=>{let z=new Date,G=document.getElementById("saveIdevice"+Q);if(N.log(`[${z.toLocaleTimeString()}] Inactivity timeout for ${Q}. Sending FORCE_UNLOCK...`),this.inactiveStates[Q]=!0,G)Y();if(this.updateResourceLockStatus({odeIdeviceId:this.odeIdeviceId,blockId:this.blockId,actionType:"FORCE_UNLOCK",destinationPageId:this.block?.pageId??""}),G)Y()},Z*1000)},W=["mousedown","mousemove","mouseover","scroll","touchstart","click"];return W.forEach((z)=>{X.addEventListener(z,J)}),eXeLearning.app.project.idevices.components.blocks.forEach((z)=>{let G=z.blockContent;if(!G)return;let q=["keydown","keypress"];q.forEach((K)=>{G.addEventListener(K,J,!0)});let H=G.querySelector("iframe.tox-edit-area__iframe");if(H?.contentDocument?.body)q.forEach((K)=>{H.contentDocument.body.addEventListener(K,J,!0)})}),J(),()=>{clearTimeout(this.inactivityTimers[Q]),delete this.inactivityTimers[Q],delete this.inactiveStates[Q],N.log(`Inactivity tracker cleaned for ${Q}`),W.forEach((z)=>{X.removeEventListener(z,J)})}}updateResourceLockStatus({odeSessionId:Q=!1,odeNavStructureSyncId:Z=null,odeIdeviceId:Y,blockId:X,actionType:J,destinationPageId:W="",pageId:z=""}={}){}addBehaviourSaveIdeviceButton(){this.timeIdeviceEditing=new Date().getTime();let Q=document.getElementById(this.odeIdeviceId),Z=()=>{this.editUnlockDevice="FORCE_UNLOCK",this.updateResourceLockStatus({odeIdeviceId:this.odeIdeviceId,blockId:this.blockId,actionType:"FORCE_UNLOCK"})},Y=(J)=>{if(this.inactivityCleanup)this.inactivityCleanup();this.inactivityCleanup=this.inactivityInElement(this.odeIdeviceId,J,Z)},X=()=>{try{eXeLearning.app.api.getResourceLockTimeout().then((J)=>{N.log("Lock timeout:",J),Y(J)}).catch((J)=>{console.error("Timeout API error:",J),Y(900000)})}catch(J){console.error("Error:",J),Y(900000)}};this.ideviceButtons.querySelector("#saveIdevice"+this.odeIdeviceId).addEventListener("click",(J)=>{if(J.target.disabled)return;this.toogleIdeviceButtonsState(!0),this.save(!0),this.createAddTextBtn(),this.updateResourceLockStatus({odeIdeviceId:this.odeIdeviceId,blockId:this.blockId,actionType:"SAVE_BLOCK",pageId:this.block?.pageId??eXeLearning.app.project.structure.getSelectNodePageId()}),Y(900000)}),X()}cleanupInactivityTracker(){if(N.log("Attempting to clean up timer"),this.inactivityCleanup)N.log("Cleaning up inactivity timer"),this.inactivityCleanup(),this.inactivityCleanup=null;else N.log("No inactivityCleanup function to call");if(this.inactivityTimer)N.log("Clearing inactivity timer directly"),clearTimeout(this.inactivityTimer),this.inactivityTimer=null}checkIdeviceIsEditing(){this.updateResourceLockStatus({odeIdeviceId:this.odeIdeviceId,blockId:this.blockId,actionType:"LOADING",pageId:this.block?.pageId??eXeLearning.app.project.structure.getSelectNodePageId()})}addBehaviourPropertiesIdeviceButton(){this.ideviceButtons.querySelector("#propertiesIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,this.odeIdeviceId).then((Z)=>{let Y=Q.target.closest(".idevice_node");if(Y&&Y.getAttribute("mode")==="export"){if(eXeLearning.app.project.checkOpenIdevice())return}if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else this.loadPropertiesFromYjs(),eXeLearning.app.modals.properties.show({node:this,title:_("iDevice properties"),contentId:"idevice-properties",properties:this.properties})})})}addBehaviourEditionIdeviceButton(){this.timeIdeviceEditing=new Date().getTime(),this.ideviceButtons.querySelector("#editIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(Q.target.disabled)return;if(this.isLockedByOtherUser()){let Y=this.getLockInfo()?.lockUserName||this.lockUserName||_("Another user");eXeLearning.app.modals.alert.show({title:_("iDevice locked"),body:_("This iDevice is being edited by")+" "+Y,contentId:"warning"});return}this.toogleIdeviceButtonsState(!0),eXeLearning.app.project.changeUserFlagOnEdit(!0,this.odeNavStructureSyncId,this.blockId,this.odeIdeviceId,null,this.timeIdeviceEditing,"EDIT_IDEVICE",this.block?.pageId??eXeLearning.app.project.structure.getSelectNodePageId()).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else this.edition()})})}addBehaviourEditionIdeviceDoubleClick(){this.timeIdeviceEditing=new Date().getTime(),this.ideviceBody.addEventListener("dblclick",(Q)=>{if(this.mode=="export"){if(this.isLockedByOtherUser()){let Y=this.getLockInfo()?.lockUserName||this.lockUserName||_("Another user");eXeLearning.app.modals.alert.show({title:_("iDevice locked"),body:_("This iDevice is being edited by")+" "+Y,contentId:"warning"});return}eXeLearning.app.project.changeUserFlagOnEdit(!0,this.odeNavStructureSyncId,this.blockId,this.odeIdeviceId,null,this.timeIdeviceEditing,"EDIT_IDEVICE",this.block?.pageId??eXeLearning.app.project.structure.getSelectNodePageId()).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else this.edition(),this.clearSelection()})}})}addBehaviourDeleteIdeviceButton(){this.ideviceButtons.querySelector("#deleteIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{let Z=Q.target.closest(".idevice_node");if(Z&&Z.getAttribute("mode")==="export"){if(eXeLearning.app.project.checkOpenIdevice())return}this.createAddTextBtn(),eXeLearning.app.project.changeUserFlagOnEdit(!1,this.odeNavStructureSyncId,this.blockId,this.odeIdeviceId,!0,null).then((Y)=>{if(Y.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Y.responseMessage),contentId:"error"});else eXeLearning.app.modals.confirm.show({title:_("Delete iDevice"),body:_("Delete iDevice? This cannot be undone."),confirmButtonText:_("Yes"),confirmExec:()=>{this.remove(!0)}})})})}addBehaviourUndoIdeviceButton(){this.ideviceButtons.querySelector("#undoIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{eXeLearning.app.modals.confirm.show({title:_("Discard changes"),body:_("Discard all changes?"),confirmButtonText:_("Yes"),confirmExec:()=>{this.cleanupInactivityTracker(),this.createAddTextBtn(),eXeLearning.app.project.changeUserFlagOnEdit(!1,this.odeNavStructureSyncId,this.blockId,this.odeIdeviceId,null,this.timeIdeviceEditing,"UNDO_IDEVICE",this.block?.pageId??eXeLearning.app.project.structure.getSelectNodePageId());let Z=[];this.engine.components.idevices.forEach((Y)=>{if(Y.id!=this.id)Z.push(Y.id)}),this.loadInitScriptIdevice("export"),this.engine.resetCurrentIdevicesExportView([])}})})}addBehaviouCloneIdeviceButton(){this.ideviceButtons.querySelector("#cloneIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.apiCloneIdevice()})}async getOdeIdeviceBrokenLinksEvent(Q){return await eXeLearning.app.api.getOdeIdeviceBrokenLinks(Q)}addBehaviourMoveUpIdeviceButton(){this.ideviceButtons.querySelector("#moveUpIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,this.odeIdeviceId).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else{let Y=this.order;if(!this.ideviceContent.classList.contains("moving")){let X=this.getContentPrevIdevice();if(X)this.ideviceContent.classList.add("moving"),this.order--,this.apiUpdateOrder().then((J)=>{if(J.responseMessage=="OK")this.block.blockContent.insertBefore(this.ideviceContent,X)})}}})})}addBehaviourMoveDownIdeviceButton(){this.ideviceButtons.querySelector("#moveDownIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,this.odeIdeviceId).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else{let Y=this.order;if(!this.ideviceContent.classList.contains("moving")){let X=this.getContentNextIdevice();if(X)this.ideviceContent.classList.add("moving"),this.order++,this.apiUpdateOrder().then((J)=>{if(J.responseMessage=="OK")this.block.blockContent.insertBefore(this.ideviceContent,X.nextSibling)})}}})})}addBehaviourMoveToPageIdeviceButton(){this.ideviceButtons.querySelector("#moveIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,this.odeIdeviceId).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else{let Y=this.generateModalMoveToPageBody();eXeLearning.app.modals.confirm.show({title:_("Move iDevice to page"),body:Y.innerHTML,contentId:"modal-move-to-page",confirmButtonText:_("Move"),cancelButtonText:_("Cancel"),confirmExec:()=>{let X=eXeLearning.app.modals.confirm.modalElementBody.querySelector(".select-move-to-page"),W=X.item(X.selectedIndex).getAttribute("value"),H=document.querySelector("#main #workarea").querySelector("#menu_nav_content").querySelector(`[nav-id="${W}"]`).getAttribute("page-id"),K=this.odeNavStructureSyncId,V=eXeLearning.app.project.structure.getSelectNodePageId(),R=this.blockId;if(this.apiUpdatePage(W),parseInt(W)!==this.odeNavStructureSyncId);}})}})})}addBehaviourExportIdeviceButton(){this.ideviceButtons.querySelector("#exportIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,this.odeIdeviceId).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else this.downloadIdeviceSelected(this.blockId,this.odeIdeviceId)})})}addBehaviourMinifyIdeviceButton(){this.ideviceButtons.querySelector("#minifyIdevice"+this.odeIdeviceId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;let Z=$("div.idevice_body[idevice-id='"+this.odeIdeviceId+"']");if(Z.length!=1)return!1;let Y=this.ideviceButtons.querySelector("#minifyIdevice"+this.odeIdeviceId+"icon");if(Y.classList.contains("chevron-down-icon-green"))Y.classList.remove("chevron-down-icon-green"),Y.classList.add("chevron-up-icon-green"),Z.hide();else Y.classList.remove("chevron-up-icon-green"),Y.classList.add("chevron-down-icon-green"),Z.show();return!1})}addNoTranslateForGoogle(){$(".auto-icon",this.ideviceButtons).addClass("notranslate")}addTooltips(){$('button.btn-action-menu:not([data-bs-toggle="dropdown"]):not(.btn-edit-idevice):not(.btn-save-idevice)',this.ideviceButtons).addClass("exe-app-tooltip"),eXeLearning.app.common.initTooltips(this.ideviceButtons)}async downloadIdeviceSelected(Q,Z){try{let Y=eXeLearning.app.project._yjsBridge;if(!Y)throw Error("Yjs bridge not initialized");let X=Y.documentManager,J=eXeLearning.app.project._assetCache||null,W=Y.assetManager||null,G=await window.createExporter("COMPONENT",X,J,null,W).exportAndDownload(Q,Z);if(!G.success)eXeLearning.app.modals.alert.show({title:_("Download error"),body:G.error||_("Failed to export iDevice"),contentId:"error"})}catch(Y){console.error("[ideviceNode] Export failed:",Y),eXeLearning.app.modals.alert.show({title:_("Download error"),body:Y.message,contentId:"error"})}}generateModalMoveToPageBody(){let Q=document.createElement("div"),Z=document.createElement("p"),Y=document.createElement("select");return Z.innerHTML=_("Select the page where you want to move the iDevice. It will be placed at the end of the page."),Z.classList.add("text-info-move-to-page"),Y.classList.add("select-move-to-page"),Q.append(Z),Q.append(Y),eXeLearning.app.project.structure.getAllNodesOrderByView().forEach((J)=>{let W=document.createElement("option");if(W.value=J.id,W.innerHTML=`${"&nbsp;&nbsp;".repeat(J.deep)} ${J.pageName}`,J.id==this.block.odeNavStructureSyncId)W.setAttribute("selected","selected");Y.append(W)}),Q}async loadInitScriptIdevice(Q){switch(Q){case"edition":this.loadEditionIdevice(),await this.ideviceInitEdition();break;case"export":this.restartExeIdeviceValue(),await this.loadExportIdevice(),await this.ideviceInitExport();break}this.updateMode(Q),this.engine.updateMode(),setTimeout(()=>{this.makeIdeviceButtonsElement()},100)}async loadExportIdevice(){this.loadScriptsExport(),await this.loadStylesExport()}async loadEditionIdevice(){if(this.clearFilesElements(),typeof $exeDevice<"u")$exeDevice=void 0;this.loadScriptsEdition(),await this.loadStylesEdition()}async ideviceInitEdition(){let Q=this.checkDeviceLoadNumMax;eXeLearning.app.idevices.setIdeviceActive(this),this.checkDeviceLoadInterval=setInterval(()=>{if(typeof $exeDevice<"u")this.ideviceInitEditionLoadSuccess();else if(Q--,Q<=0)this.ideviceInitEditionLoadError()},this.interval)}ideviceInitEditionLoadSuccess(){if(clearInterval(this.checkDeviceLoadInterval),!this.id)this.apiSaveIdevice().then((Q)=>{this.ideviceInitEditionLoadSuccessInitScript()});else this.ideviceInitEditionLoadSuccessInitScript()}ideviceInitEditionLoadSuccessInitScript(){this.loading=!1,this.ideviceContent.setAttribute("loading",!1),this.initExeDeviceEdition(),this.loadLegacyExeFunctionalitiesEdition()}ideviceInitEditionLoadError(){clearInterval(this.checkDeviceLoadInterval),this.editionLoadedError()}exportHtmlView(){let Q;if(eXeLearning.app.themes.selected&&eXeLearning.app.themes.selected.templateIdevice)Q=eXeLearning.app.themes.selected.templateIdevice,Q=Q.replace("{idevice-content}",this.htmlView);else Q=this.htmlView;if(typeof window.escapePreCodeContent==="function")Q=window.escapePreCodeContent(Q);if(typeof window.addMediaTypes==="function")Q=window.addMediaTypes(Q);if(typeof window.simplifyMediaElements==="function")Q=window.simplifyMediaElements(Q);if(typeof window.resolveAssetUrls==="function")Q=window.resolveAssetUrls(Q);return Q}restartExeIdeviceValue(){if(this.isSync==!0)this.isSync=!1;else if(typeof $exeDevice<"u")$exeDevice=void 0}async ideviceInitExport(){if(this.isLockedByOtherUser()){let Y=!this.htmlView||this.htmlView.trim()==="",X=this.idevice?.componentType==="json";if(X&&Y)return N.log(`[IdeviceNode] Remote JSON iDevice ${this.odeIdeviceId} locked without content, showing placeholder`),this.showLockedPlaceholder();if(!X&&Y)return N.log(`[IdeviceNode] Remote HTML iDevice ${this.odeIdeviceId} locked without content, showing placeholder`),this.showLockedPlaceholder()}let Q;switch(this.idevice&&this.idevice.componentType?this.idevice.componentType:null){case"json":let Y=this.checkDeviceLoadNumMax;do{if(typeof window[this.idevice.exportObject]<"u")Q=await this.ideviceInitExportLoadSuccess();else await eXeLearning.app.common.timer(this.interval);Y--}while(!Q&&Y>0);if(!Q)this.ideviceInitExportLoadError();break;case"html":default:Q=await this.ideviceInitExportLoadSuccess();break}return Q}async ideviceInitExportLoadSuccess(){return clearInterval(this.checkDeviceLoadInterval),await this.generateContentExportView()}ideviceInitExportLoadError(){clearInterval(this.checkDeviceLoadInterval),this.exportLoadedError()}showLockedPlaceholder(){let Q=this.getLockInfo(),Z=Q?.lockUserName||_("Another user"),Y=Q?.lockUserColor||"#999",X=`
            <div class="idevice-locked-placeholder" style="
                background-color: #f8f9fa;
                border: 2px dashed ${Y};
                border-radius: 8px;
                padding: 30px 20px;
                text-align: center;
                min-height: 100px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 10px;
            ">
                <span style="font-size: 24px;">\uD83D\uDD12</span>
                <p style="margin: 0; color: #666; font-size: 14px;">
                    ${_("Being edited by")}
                    <strong style="color: ${Y};">${Z}</strong>
                </p>
                <p style="margin: 0; color: #999; font-size: 12px;">
                    ${_("Content will appear when saved")}
                </p>
            </div>
        `;if(this.ideviceBody)this.ideviceBody.innerHTML=X;return N.log(`[IdeviceNode] Showing locked placeholder for ${this.odeIdeviceId}, locked by ${Z}`),{init:"locked",lockedBy:Z}}async generateContentExportView(){let Q;switch(this.idevice&&this.idevice.componentType?this.idevice.componentType:null){case"json":Q=await this.exportProcessIdeviceJson();break;case"html":default:Q=await this.exportProcessIdeviceHtml();break}return this.typesetLatexInContent(),Q}typesetLatexInContent(){if(!this.ideviceBody)return;let Q=this.ideviceBody.textContent||"";if(/(?:\\\(|\\\[|\\begin\{|\$\$)/.test(Q)){if(typeof MathJax<"u"&&MathJax.typesetPromise)MathJax.typesetPromise([this.ideviceBody]).catch((Z)=>{N.log("[IdeviceNode] MathJax typeset error:",Z)})}}async exportProcessIdeviceHtml(){return new Promise((Z,Y)=>{this.ideviceBody.innerHTML=this.exportHtmlView(),Z({init:"true"})})}async exportProcessIdeviceJson(){let Q={};if(this.exportObject=window[this.idevice.exportObject],this.jsonProperties&&Object.keys(this.jsonProperties).length>0){let Z=this.idevice.exportTemplateContent;if(this.htmlView=this.exportObject.renderView(this.jsonProperties,this.accesibility,Z,this.odeIdeviceId),this.ideviceBody.innerHTML=this.exportHtmlView(),this.jsonProperties.ideviceId=this.odeIdeviceId,this.exportObject.renderBehaviour(this.jsonProperties,this.accesibility,this.odeIdeviceId),this.exportObject.init(this.jsonProperties,this.accesibility),this.mode=="edition")return await this.apiSaveIdeviceViewHTML();else return Q.responseMessage="OK",Q}else return Q=new Promise((Z,Y)=>{this.ideviceBody.innerHTML=this.exportHtmlView();let X={ideviceId:this.odeIdeviceId};this.exportObject.renderBehaviour(X,this.accesibility),this.exportObject.init(X,this.accesibility),Z({init:"true"})}),Q}async saveIdeviceProcess(){let Q;switch(this.idevice&&this.idevice.componentType?this.idevice.componentType:null){case"json":Q=await this.apiSaveIdeviceJson(!0);break;case"html":default:Q=await this.apiSaveIdeviceViewHTML(!0);break}return Q}async apiSaveIdevice(){let Q=["odeVersionId","odeSessionId","odeNavStructureSyncId","odePagStructureSyncId","odePageId","odeBlockId","iconName","blockName","odeIdeviceId","odeIdeviceTypeName"],Z=this.getCurrentOrder();if(Z>=0)this.order=Z,Q.push("order");N.log(Q);let Y=await this.apiSendDataService("putSaveIdevice",Q,!0);if(Y.responseMessage=="OK"){if(Y.odeComponentsSyncId)this.odeComponentsSyncId=Y.odeComponentsSyncId,this.id=Y.odeComponentsSyncId;if(Y.odeComponentsSync?.id)this.odeComponentsSyncId=this.odeComponentsSyncId||Y.odeComponentsSync.id,this.id=this.id||Y.odeComponentsSync.id;if(this.setProperties(Y.odeComponentsSync.odeComponentsSyncProperties),Y.newOdePagStructureSync)this.block.setProperties(Y.odePagStructureSync.odePagStructureSyncProperties),this.block.apiUpdateOrder(!0).then((X)=>{})}else{this.toogleIdeviceButtonsState(!1);let X=_("An error occurred while save component in database");this.showModalMessageErrorDatabase(Y,X)}return Y}async apiSaveProperties(Q){for(let[Y,X]of Object.entries(Q))this.properties[Y].value=X;let Z={odeComponentsSyncId:this.id};for(let[Y,X]of Object.entries(this.properties))Z[Y]=X.value;eXeLearning.app.api.putSavePropertiesIdevice(Z).then((Y)=>{if(Y.responseMessage&&Y.responseMessage=="OK")this.makeIdeviceContentNode(!1);else eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_("An error occurred while saving the iDevice’s properties to the database."),contentId:"error"})})}async apiSaveIdeviceViewHTML(Q){let Z=["odeComponentsSyncId","htmlView"];if(Q&&typeof $exeDevice<"u"&&$exeDevice){if(this.htmlView=$exeDevice.save(),this.htmlView==!1)this.ideviceBody.classList.add("save-error")}if(this.htmlView&&this.htmlView!="undefined")return await this.apiSendDataService("putSaveHtmlView",Z,!1);else return!1}async apiSaveIdeviceJson(Q){let Z=["odeComponentsSyncId","jsonProperties"];if(Q&&typeof $exeDevice<"u"&&$exeDevice){if(this.jsonProperties=$exeDevice.save(),this.jsonProperties==!1)this.ideviceBody.classList.add("save-error")}if(this.jsonProperties&&this.jsonProperties!="undefined")return this.htmlView=this.htmlView?this.htmlView:"",await this.apiSendDataService("putSaveIdevice",Z,!1);else return!1}async apiUpdateBlock(){if(this.isYjsEnabled())return await this.moveToBlockViaYjs();let Q={odeSessionId:eXeLearning.app.project.odeSession,odeIdeviceId:this.odeIdeviceId,odeNavStructureSyncId:this.odeNavStructureSyncId,actionType:"MOVE_ON_PAGE",odeComponentFlag:!1};eXeLearning.app.api.postActivateCurrentOdeUsersUpdateFlag(Q);let Z=["odeComponentsSyncId","odePagStructureSyncId"];if(this.block.id==eXeLearning.app.api.parameters.generateNewItemKey)Z=Z.concat(["odeVersionId","odeSessionId","odeNavStructureSyncId","odePagStructureSyncOrder","odePageId","odeBlockId","blockName","iconName"]);let Y=this.getCurrentOrder();if(Y>=0)this.order=Y,Z.push("order");let X=await this.apiSendDataService("putSaveIdevice",Z,!0);if(X.responseMessage=="OK")this.engine.setParentsAndChildrenIdevicesBlocks(!0);else{this.toogleIdeviceButtonsState(!1);let J=_("An error occurred while update component in database");this.showModalMessageErrorDatabase(X,J)}return X}async moveToBlockViaYjs(){try{let Z=eXeLearning.app?.project?._yjsBridge?.structureBinding;if(!Z)return console.warn("[IdeviceNode] Cannot move to block via Yjs: structureBinding not available"),{responseMessage:"ERROR"};let Y=[this.yjsComponentId,this.odeIdeviceId,this.id].filter(Boolean),X=[this.block?.blockId,this.blockId,this.block?.id].filter(Boolean),J=!1;for(let W of Y){for(let z of X)if(J=Z.moveComponentToBlock(W,z,this.order),J){N.log("[IdeviceNode] Move to block succeeded with compId:",W,"blockId:",z);break}if(J)break}if(J)return this.engine.setParentsAndChildrenIdevicesBlocks(!0),{responseMessage:"OK"};return{responseMessage:"ERROR"}}catch(Q){return console.error("[IdeviceNode] Error moving to block via Yjs:",Q),{responseMessage:"ERROR"}}}async apiUpdatePage(Q){if(this.odeNavStructureSyncId==Q)return!1;if(this.isYjsEnabled())return await this.moveToPageViaYjs(Q);let Z=["odeComponentsSyncId","odeNavStructureSyncId","odePagStructureSyncId","odeVersionId","odeSessionId","odePageId","odeBlockId","blockName","iconName","odeIdeviceId","odeIdeviceTypeName"],Y={odePagStructureSyncId:eXeLearning.app.api.parameters.generateNewItemKey,iconName:"",blockName:this.idevice.title};this.block=this.engine.newBlockNode(Y,!1),this.odeNavStructureSyncId=Q,this.odePagStructureSyncId=this.block.odePagStructureSyncId,this.blockId=this.block.blockId;let X=await this.apiSendDataService("putSaveIdevice",Z,!0);if(X.responseMessage=="OK")this.remove(),this.engine.setParentsAndChildrenIdevicesBlocks(!0);else{this.toogleIdeviceButtonsState(!1);let J=_("An error occurred while update component in database");this.showModalMessageErrorDatabase(X,J)}}async moveToPageViaYjs(Q){try{let Z=this.idevice?.title||"",X=eXeLearning.app?.project?._yjsBridge?.structureBinding;if(!X)return console.warn("[IdeviceNode] Cannot move to page via Yjs: structureBinding not available"),{responseMessage:"ERROR"};let J=[this.yjsComponentId,this.odeIdeviceId,this.id].filter(Boolean),W=null;for(let z of J)if(W=X.moveComponentToPage(z,Q,Z),W){N.log("[IdeviceNode] Move to page succeeded with compId:",z);break}if(W)return this.odeNavStructureSyncId=Q,this.blockId=W.blockId,this.remove(),this.engine.setParentsAndChildrenIdevicesBlocks(!0),{responseMessage:"OK"};return{responseMessage:"ERROR"}}catch(Z){return console.error("[IdeviceNode] Error moving to page via Yjs:",Z),{responseMessage:"ERROR"}}}async apiUpdateOrder(){if(this.isYjsEnabled())return await this.reorderViaYjs();let Q=["odeComponentsSyncId","order"],Z=await this.apiSendDataService("putReorderIdevice",Q,!0);if(Z.responseMessage=="OK")this.engine.updateComponentsIdevices(Z.odeComponentsSyncs,["order"]),setTimeout(()=>{this.ideviceContent.classList.remove("moving")},this.engine.movingClassDuration);else{this.toogleIdeviceButtonsState(!1);let Y=_("An error occurred while update component in database");this.showModalMessageErrorDatabase(Z,Y)}return Z}async reorderViaYjs(){try{let Z=eXeLearning.app?.project?._yjsBridge?.structureBinding;if(!Z)return console.warn("[IdeviceNode] Cannot reorder via Yjs: structureBinding not available"),{responseMessage:"ERROR"};let Y=[this.yjsComponentId,this.odeIdeviceId,this.id].filter(Boolean),X=!1;for(let J of Y)if(X=Z.reorderComponent(J,this.order),X){N.log("[IdeviceNode] Reorder succeeded with id:",J);break}if(X)return setTimeout(()=>{this.ideviceContent?.classList.remove("moving")},this.engine.movingClassDuration),{responseMessage:"OK"};return{responseMessage:"ERROR"}}catch(Q){return console.error("[IdeviceNode] Error reordering via Yjs:",Q),{responseMessage:"ERROR"}}}async apiCloneIdevice(){return await this.cloneViaYjs()}async apiDeleteIdevice(){if(this.isYjsEnabled()&&eXeLearning.app.project.deleteComponentViaYjs)return await this.deleteViaYjs();eXeLearning.app.api.deleteIdevice(this.id).then((Q)=>{if(Q.responseMessage&&Q.responseMessage=="OK"){if(Q.odeComponentsSyncs)this.engine.updateComponentsIdevices(Q.odeComponentsSyncs,["order"])}else{let Z=_("An error occurred while removing the component from the database");this.showModalMessageErrorDatabase(Q,Z)}})}async deleteViaYjs(){try{if(eXeLearning.app.project.deleteComponentViaYjs(this.id))return N.log("[IdeviceNode] Deleted component via Yjs:",this.id),{responseMessage:"OK"};else throw Error("Failed to delete component via Yjs")}catch(Q){console.error("[IdeviceNode] Yjs delete error:",Q);let Z=_("An error occurred while removing the component");return this.showModalMessageErrorDatabase({responseMessage:"ERROR"},Z),!1}}async cloneViaYjs(){try{let Q=eXeLearning.app.project,Z=this.block?.pageId??this.odeNavStructureSyncId??this.pageId??Q.structure?.getSelectNodePageId?.()??Q.structure?.nodeSelected?.id,Y=this.block?.blockId??this.blockId??this.block?.id;if(!Z||!Y)throw console.error("[IdeviceNode] cloneViaYjs missing IDs:",{pageId:Z,blockId:Y,block:this.block}),Error("Missing pageId or blockId for clone");let X=Q.cloneComponentViaYjs(Z,Y,this.id);if(X)return N.log("[IdeviceNode] Cloned component via Yjs:",this.id,"→",X.id),await this.engine.loadApiIdevicesInPage(!0),{responseMessage:"OK",clonedComponent:X};else throw Error("Failed to clone component via Yjs")}catch(Q){console.error("[IdeviceNode] Yjs clone error:",Q);let Z=_("An error occurred while cloning the component");return this.showModalMessageErrorDatabase({responseMessage:"ERROR"},Z),{responseMessage:"ERROR"}}}base64ToFile(Q,Z){let Y=Q.match(/^data:([^;]+);base64,(.+)$/);if(!Y)throw Error("Invalid base64 data URL");let X=Y[1],J=Y[2],W=atob(J),z=new Uint8Array(W.length);for(let G=0;G<W.length;G++)z[G]=W.charCodeAt(G);return new File([z],Z,{type:X})}async apiUploadFile(Q,Z){let Y={odeIdeviceId:this.odeIdeviceId,file:Q,filename:Z,createThumbnail:!0},X=await eXeLearning.app.api.postUploadFileResource(Y),J=eXeLearning.app?.project?._yjsBridge?.assetManager;if(J&&X?.savedPath)try{let W=this.base64ToFile(Q,Z),z=await J.insertImage(W),G=z.match(/^asset:\/\/([^/]+)\/(.+)$/);if(G){let q=G[1],H=G[2];X.savedPath=`asset://${q}/`,X.savedFilename=H,X.savedThumbnailName=H;let K=await J.resolveAssetURL(z);if(K)X.previewUrl=K;N.log(`[IdeviceNode] Created asset for upload: ${z}`)}}catch(W){N.warn("[IdeviceNode] Failed to create asset from upload:",W)}return X}async apiUploadLargeFile(Q){Q.append("odeIdeviceId",[this.odeIdeviceId]),Q.append("createThumbnail",[!0]);let Z=await eXeLearning.app.api.postUploadLargeFileResource(Q);if(typeof Z==="string")if(Z.includes("Allowed memory")||Z.includes("Out of memory"))Z={code:_("File is too large")};else Z={code:_("Error uploading file")};return Z}async apiGetHtmlView(){let Q=await eXeLearning.app.api.getSaveHtmlView(this.id);return this.ideviceBody.innerHTML=Q.htmlView,this.htmlView=Q.htmlView,this.htmlView}async apiGetComponentHtmlTemplate(){return(await eXeLearning.app.api.getComponentHtmlTemplate(this.id)).htmlTemplate}async apiSendDataService(Q,Z,Y){let X=this.generateDataObject(Z),J=await eXeLearning.app.api[Q].call(eXeLearning.app.api,X);if(J&&J.responseMessage=="OK"){if(J.newOdeComponentsSync)this.updateParam("id",J.odeComponentsSync.id),this.updateParam("odeNavStructureSyncId",J.odePagStructureSync.odeNavStructureSyncId),this.updateParam("pageId",J.odeComponentsSync.pageId);if(J.newOdePagStructureSync)this.block.updateParam("id",J.odePagStructureSyncId),this.block.updateParam("odeNavStructureSyncId",J.odePagStructureSync.odeNavStructureSyncId),this.block.updateParam("pageId",J.odePagStructureSync.pageId);if(!this.block?.idevices?.includes(this))this.block?.idevices?.push(this);if(Y&&J.odeComponentsSyncs)this.engine.updateComponentsIdevices(J.odeComponentsSyncs,["order"]);if(Y&&J.odePagStructureSyncs)this.engine.updateComponentsBlocks(J.odeComponentsSyncs,["order"]);return J}else return!1}generateDataObject(Q){let Z=this.getDictBaseValuesData(),Y={};return Q.forEach((X)=>{Y[X]=Z[X]}),Y}getDictBaseValuesData(){let Q=eXeLearning.app.project.odeVersion,Z=eXeLearning.app.project.odeSession,Y=eXeLearning.app.project.structure.getSelectNodeNavId(),X=eXeLearning.app.project.structure.getSelectNodePageId(),J=null;if(this.block&&this.block.getCurrentOrder){let W=this.block.getCurrentOrder();if(W>=0)J=W;else if(typeof this.block.getFallbackPageOrder==="function")J=this.block.getFallbackPageOrder()}return{odeComponentsSyncId:this.id,odeVersionId:Q,odeSessionId:Z,odeNavStructureSyncId:this.odeNavStructureSyncId?this.odeNavStructureSyncId:Y,odePageId:this.pageId?this.pageId:X,odePagStructureSyncId:this.block?this.block.id:null,odePagStructureSyncOrder:J,odeBlockId:this.block?this.block.blockId:null,blockName:this.block?this.block.blockName:null,iconName:this.block?this.block.iconName:null,odeIdeviceId:this.odeIdeviceId,odeIdeviceTypeName:this.idevice.name,jsonProperties:this.getJsonProperties(!0),htmlView:this.getViewHTML(),order:this.order}}showModalMessageErrorDatabase(Q,Z){let Y,X;if(Y=_("iDevice error"),Q&Q.message)X=Q.message;else X=Z;setTimeout(()=>{eXeLearning.app.modals.alert.show({title:Y,body:X,contentId:"error"})},300)}getCurrentOrder(){let Q,Z;if(Q=this.getContentPrevIdevice())return this.order=parseInt(Q.getAttribute("order"))+1,this.order;else if(Z=this.getContentNextIdevice())return this.order=parseInt(Z.getAttribute("order"))-1,this.order;return-1}getBodyHTML(){if(this.ideviceBody)return this.ideviceBody.getInnerHTML();else return""}getSavedData(){let Q=null;switch(this.idevice&&this.idevice.componentType?this.idevice.componentType:null){case"json":Q=this.getJsonProperties();break;case"html":default:Q=this.getViewHTML();break}return Q}getViewHTML(){if(console.debug(`[IdeviceNode] getViewHTML: Component ${this.odeIdeviceId} htmlView length: ${this.htmlView?.length||0}`),this.htmlView&&!["undefined","null","false"].includes(this.htmlView))return this.htmlView;else return""}getJsonProperties(Q){let Z={};if(this.jsonProperties)Z=this.jsonProperties;if(Q)return JSON.stringify(this.jsonProperties);else return this.jsonProperties}getPathEdition(){return this.idevice.pathEdition}getPathExport(){return this.idevice.pathExport}getContentPrevIdevice(){let Q=this.ideviceContent.previousSibling;if(Q&&Q.classList&&Q.classList.contains("idevice_node"))return Q;return!1}getContentNextIdevice(){let Q=this.ideviceContent.nextSibling;if(Q&&Q.classList&&Q.classList.contains("idevice_node"))return Q;return!1}getBlock(){return this.engine.getBlockById(this.blockId)}async save(Q){clearInterval(this.checkDeviceLoadInterval);let Z=await this.saveIdeviceProcess();if(await eXeLearning.app.project.changeUserFlagOnEdit(!1,this.odeNavStructureSyncId,this.blockId,this.odeIdeviceId),this.isYjsEnabled()){let Y=this.yjsComponentId||this.odeIdeviceId,X=this.engine?.project?._yjsBridge,J=this.getLockManager();if(J)J.releaseLock(Y);if(X?.structureBinding)X.structureBinding.updateComponent(Y,{lockedBy:null,lockUserName:null,lockUserColor:null});let W=X?.getDocumentManager();if(W?.setEditingComponent)W.setEditingComponent(null)}if(Z){if(this.resetWindowHash(),this.goWindowToIdevice(100),Q)this.engine.resetCurrentIdevicesExportView([this.id]),await this.loadInitScriptIdevice("export");else await this.loadInitScriptIdevice("export");setTimeout(()=>this.loadLegacyExeFunctionalitiesExport(),100),this.engine.unsetIdeviceActive()}else this.toogleIdeviceButtonsState(!1),setTimeout(()=>{if(!eXeLearning.app.modals.alert.modal._isShown&&!eXeLearning.app.modals.confirm.modal._isShown)eXeLearning.app.modals.alert.show({title:_("Error saving the iDevice"),body:_("Failed to save the iDevice to database"),contentId:"error"})},500);return Z}edition(){if(clearInterval(this.checkDeviceLoadInterval),this.engine.mode=="view"){if(this.goWindowToIdevice(100),this.loadInitScriptIdevice("edition"),this.engine.updateMode(),this.isYjsEnabled()){let Q=this.yjsComponentId||this.odeIdeviceId,Y=this.engine?.project?._yjsBridge?.getDocumentManager();if(Y?.setEditingComponent)Y.setEditingComponent(Q)}}else eXeLearning.app.modals.alert.show({title:_("Not allowed"),body:_("You cannot edit another iDevice until you save the current one")})}remove(Q){if(clearInterval(this.checkDeviceLoadInterval),this.mode=="edition"){if(typeof $exeDevice<"u")$exeDevice=void 0}if(this.ideviceContent.remove(),this.clearFilesElements(),this.engine.removeIdeviceOfComponentList(this.id),this.block?.removeIdeviceOfListById?.(this.id),this.engine.updateMode(),Q)this.apiDeleteIdevice();if(Q)this.removeBlockParentProcess(!0)}removeBlockParentProcess(Q){if(this.block?.idevices?.length==0){if(this.block.removeIfEmpty)this.block.remove(Q);else if(this.block.askForRemoveIfEmpty)setTimeout(()=>{eXeLearning.app.modals.confirm.show({title:_("Remove Block"),body:_("iDevice deleted. Now the box is empty. Delete the box too?"),confirmButtonText:_("Yes"),confirmExec:()=>{this.block.remove(!0),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode()}})},300)}}loadScriptsEdition(){let Q=this.idevice?this.idevice.loadScriptsEdition():[];this.scriptsElements=this.stylesElements.concat(Q)}loadScriptsExport(){let Q=this.idevice?this.idevice.loadScriptsExport():[];this.scriptsElements=this.stylesElements.concat(Q)}async loadStylesEdition(){let Q=this.idevice?await this.idevice.loadStylesEdition():[];this.stylesElements=this.stylesElements.concat(Q)}async loadStylesExport(){let Q=this.idevice?await this.idevice.loadStylesExport():[];this.stylesElements=this.stylesElements.concat(Q)}initExeDeviceEdition(){tinymce.remove(),$exeDevice.init(this.ideviceBody,this.getSavedData(),this.getPathEdition()),$exeTinyMCE.init("multiple-visible",".exe-html-editor")}clearFilesElements(){this.clearScriptsElements(),this.clearStylesElements()}clearScriptsElements(){if(this.scriptsElements.forEach((Q)=>{Q.remove()}),this.idevice&&this.idevice.exportObject){if(window[this.idevice.exportObject]);}}clearStylesElements(){this.stylesElements.forEach((Q)=>{Q.remove()})}findInstalledIdevice(Q){if(!Q)return null;let Z=eXeLearning.app.idevices,Y=Z.getIdeviceInstalled(Q);if(Y)return Y;let J={FreeTextIdevice:"text",FreeText:"text",freetext:"text",TextIdevice:"text"}[Q];if(J){if(Y=Z.getIdeviceInstalled(J),Y)return this.odeIdeviceTypeName=J,Y}let W=Q.replace(/Idevice$/i,"").toLowerCase();if(Y=Z.getIdeviceInstalled(W),Y)return this.odeIdeviceTypeName=W,Y;let z=Object.keys(Z.installed||{});for(let G of z){let q=Z.installed[G];if(q&&q.cssClass===Q)return console.log(`[IdeviceNode] Found iDevice by cssClass match: ${Q} -> ${q.name}`),this.odeIdeviceTypeName=q.name,q}return console.warn(`[IdeviceNode] Could not find installed iDevice for type: ${Q}`),null}_getIdeviceTypeIconHtml(){if(!this.idevice||!this.idevice.icon)return"";let Q=this.idevice.icon,Z=this.idevice.title||this.odeIdeviceTypeName;if(Q.type==="exe-icon")return`<div class="idevice-type-icon exe-app-tooltip" title="${Z}">${Q.name}</div>`;else if(Q.type==="img"&&Q.url)return`<div class="idevice-type-icon idevice-img-icon exe-app-tooltip" style="background-image: url('${`${this.idevice.path}/${Q.url}`}')" title="${Z}"></div>`;return""}checkIsValid(){if(this.valid=!0,!this.odeIdeviceId||!this.odeIdeviceTypeName||!this.idevice)this.valid=!1;return this.valid}editionLoadedError(){this.loading=!1,this.ideviceContent.setAttribute("loading",!1),eXeLearning.app.modals.alert.show({title:this.idevice.title,body:_("Failed to load the iDevice."),contentId:"error"})}exportLoadedError(){this.engine.updateMode(),eXeLearning.app.modals.alert.show({title:this.idevice.title,body:_("Failed to load the iDevice view."),contentId:"error"})}loadLegacyExeFunctionalitiesExport(){$exeABCmusic.init(),$exeFX.init(),$exe.mermaid.init()}loadLegacyExeFunctionalitiesEdition(){this.legacyExeFieldsetAction(),this.legacyExeIdevicesFilePicker()}legacyExeFieldsetAction(){this.ideviceBody.querySelectorAll("fieldset.exe-fieldset").forEach((Q)=>{let Z=Q.querySelector("legend a");if(Z){if(!Q.classList.contains("exe-fieldset-closed"))Q.classList.add("exe-fieldset-open");Z.addEventListener("click",(Y)=>{if(Y.preventDefault(),Q.classList.contains("exe-fieldset-closed"))Q.classList.remove("exe-fieldset-closed"),Q.classList.add("exe-fieldset-open");else Q.classList.remove("exe-fieldset-open"),Q.classList.add("exe-fieldset-closed")})}})}legacyExeIdevicesFilePicker(){let Q=window.eXeLearning?.app?.modals?.filemanager;this.ideviceBody.querySelectorAll(".exe-file-picker,.exe-image-picker").forEach((Z)=>{let Y=Z.id,X=Z.classList.contains("exe-image-picker"),J=X?"exe-pick-image":"exe-pick-any-file",W=null;if(X)W="image";else if(Y.toLowerCase().includes("audio"))W="audio";else if(Y.toLowerCase().includes("video"))W="video";let z=document.createElement("input");z.classList.add(J),z.setAttribute("type","button"),z.setAttribute("value",_("Select a file")),z.addEventListener("click",()=>{if(Q)Q.show({accept:W,onSelect:async(G)=>{Z.value=G.assetUrl,Z.dataset.blobUrl=G.blobUrl,Z.dispatchEvent(new Event("change"))}})}),Z.parentNode.insertBefore(z,Z.nextSibling)})}async processFile(Q,Z,Y){try{await this.addUploadImage(Q,Q.name,Z,Y)}catch(X){}}async readFile(Q){return new Promise((Z,Y)=>{let X=new FileReader;X.onload=(J)=>{Z(J.target.result)},X.onerror=Y,X.readAsDataURL(Q)})}async addUploadImage(Q,Z,Y,X){var J=new FormData;J.append("file",Q),J.append("filename",[Z]),J.append("odeSessionId",[eXeLearning.app.project.odeSession]),this.lockScreen();let W=new Date,z=await eXe.app.uploadLargeFile(J),G=new Date().getTime()-W;if(z&&z.savedPath&&z.savedFilename){let q=`${z.savedPath}/${z.savedFilename}`,H=this.ideviceBody.querySelector(`#${Y}`);if(H)H.value=q,H.dispatchEvent(new Event("change"))}else eXe.app.alert(_(z.code));this.unlockScreen(G)}lockScreen(){let Q=document.getElementById("load-screen-node-content");Q.style.zIndex="9999",Q.style.position="fixed",Q.style.top="0",Q.style.left="0",Q.classList.remove("hide","hidden"),Q.classList.add("loading"),Q.setAttribute("data-visible","true"),document.getElementById("node-content")?.setAttribute("data-ready","false")}unlockScreen(Q=1000){Q=Q>1000?400:0;let Z=document.getElementById("load-screen-node-content");Z.classList.remove("loading"),Z.classList.add("hidding"),setTimeout(()=>{Z.classList.add("hide","hidden"),Z.classList.remove("hidding"),Z.style.zIndex="990",Z.style.position="absolute",delete Z.style.top,delete Z.style.left,Z.setAttribute("data-visible","false"),document.getElementById("node-content")?.setAttribute("data-ready","true")},Q)}updateParam(Q,Z){switch(this[Q]=Z,Q){case"order":this.ideviceContent.setAttribute("order",this.order);break}}updateMode(Q){if(Q)this.mode=Q;switch(this.updateModeParentBlock(),this.mode){case"edition":this.ideviceContent.classList.remove("eXeLearning-content"),this.ideviceContent.classList.remove("draggable"),this.ideviceContent.removeAttribute("draggable");break;case"export":this.ideviceContent.classList.add("eXeLearning-content"),this.ideviceContent.classList.add("draggable"),this.ideviceBody.classList.remove("save-error");break}this.ideviceContent.setAttribute("mode",this.mode)}updateModeParentBlock(){if(this.block=this.getBlock(),this.block)this.block.updateMode(this.mode)}resetWindowHash(){this.nodeContainer.scrollTop=this.nodeContainer.offsetTop}goWindowToIdevice(Q){let Z;if(this.block&&this.block.idevices.length>0&&this.block.idevices[0].odeIdeviceId==this.odeIdeviceId)Z=this.block.blockId;else Z=this.odeIdeviceId;let Y=document.getElementById(Z);setTimeout(()=>{this.nodeContainer.scrollTop=Y.offsetTop},Q)}clearSelection(){if(window.getSelection)window.getSelection().removeAllRanges();else if(document.selection)document.selection.empty()}activateUpdateFlag(){let Q={odeSessionId:eXeLearning.app.project.odeSession,odeIdeviceId:this.odeIdeviceId};eXeLearning.app.api.postActivateCurrentOdeUsersUpdateFlag(Q)}activateComponentFlag(){}sendPublishedNotification(){if(!this.offlineInstallation)this.realTimeEventNotifier.notify(eXeLearning.app.project.odeSession,{name:"new-content-published"})}}var c=window.AppLogger||console;class E0{constructor(Q,Z){this.engine=Q,this.id=Z.id?Z.id:eXeLearning.app.api.parameters.generateNewItemKey;let Y=eXeLearning?.app?.project?._yjsEnabled;this.blockId=Z.blockId?Z.blockId:Y?`block-${Date.now()}-${Math.random().toString(36).substr(2,9)}`:this.engine.generateId(),this.setParams(Z),this.idevices=[],this.removeIfEmpty=!1,this.askForRemoveIfEmpty=!0,this.canHaveHeirs=!0,this.blockContent=null,this.headElement=null,this.idevicesContainerElement=null,this.iconElement=null,this.blockNameElementText=null,this.toggleElement=null,this.blockButtons=null,this.offlineInstallation=eXeLearning.config.isOfflineInstallation}emptyIcon="block";properties=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.odePagStructureSyncPropertiesConfig));params=["odeNavStructureSyncId","odeSessionId","odeVersionId","pageId","mode","blockName","iconName","order"];default={mode:"export",blockName:"",iconName:"",order:0};setParams(Q){for(let[Z,Y]of Object.entries(this.params)){let X=this.default[Y]?this.default[Y]:null;this[Y]=Q[Y]?Q[Y]:X}if(Q.odePagStructureSyncProperties)this.setProperties(Q.odePagStructureSyncProperties)}isYjsEnabled(){return eXeLearning.app?.project?._yjsEnabled===!0}loadPropertiesFromYjs(){if(!this.isYjsEnabled())return;let Z=eXeLearning.app.project._yjsBridge;if(!Z||!Z.structureBinding)return;let Y=Z.structureBinding.getBlockProperties(this.blockId);if(Y){for(let[X,J]of Object.entries(Y))if(this.properties[X])if(typeof J==="boolean")this.properties[X].value=J?"true":"false";else this.properties[X].value=J;c.log("[BlockNode] Loaded properties from Yjs:",this.blockId,Y)}}setProperties(Q,Z){for(let[Y,X]of Object.entries(this.properties)){if(!Q||!Q[Y])continue;if(Z){if(Q[Y].heritable)X.value=Q[Y].value}else X.value=Q[Y].value}if(this.blockContent)this.setPropertiesClassesToElement()}generateBlockContentNode(Q){if(Q)this.blockContent=document.createElement("article");else{this.blockContent.classList.remove(...this.blockContent.classList);while(this.blockContent.attributes.length>0)this.blockContent.removeAttribute(this.blockContent.attributes[0].name);this.toggleElement.removeAttribute("disabled")}if(this.blockContent.id=this.blockId,this.blockContent.classList.add("box"),this.blockContent.classList.add("idevice-element-in-content"),this.blockContent.classList.add("draggable"),this.id)this.blockContent.setAttribute("sym-id",this.id);if(this.blockContent.setAttribute("order",this.order),this.blockContent.setAttribute("drag","box"),this.blockContent.setAttribute("drop",'["idevice"]'),Q)this.blockContent.appendChild(this.makeBlockHeadElement()),this.addBehaviourChangeIcon();return this.setPropertiesClassesToElement(),this.updateMode(),this.blockContent}setPropertiesClassesToElement(){if(this.properties.identifier.value!="")this.blockContent.setAttribute("identifier",this.properties.identifier.value);if(this.properties.visibility.value=="true")this.blockContent.setAttribute("export-view",this.properties.visibility.value);if(this.properties.cssClass.value!="")(this.properties.cssClass.value?this.properties.cssClass.value.split(" "):[]).forEach((Z)=>{this.blockContent.classList.add(Z)});if(this.properties.allowToggle.value!="true");if(this.properties.minimized.value=="true")this.toggleOff()}makeBlockHeadElement(){let Q=this.blockId;this.headElement=document.createElement("header"),this.headElement.classList.add("box-head"),this.headElement.classList.add("draggable"),this.headElement.classList.add("idevice-element-in-content"),this.headElement.setAttribute("draggable",!0),this.headElement.setAttribute("drag","box"),this.headElement.setAttribute("block-id",this.blockId);let Z=document.createElement("button");Z.className="btn-action-menu btn btn-light btn-toggle box-toggler box-toggle-on btn-expandblock",Z.type="button",Z.id=`toggleBox${Q}`,Z.title=_("Hide");let Y=document.createElement("span");Y.className="auto-icon",Y.setAttribute("aria-hidden","true"),Y.textContent="keyboard_arrow_down";let X=document.createElement("span");return X.className="visually-hidden",X.textContent=_("Hide"),Z.appendChild(Y),Z.appendChild(X),this.headElement.appendChild(Z),this.headElement.appendChild(this.makeIconNameElement()),this.headElement.appendChild(this.makeBlockTitleElementText()),this.headElement.appendChild(this.makeBlockButtonsElement()),eXeLearning.app.common.initTooltips(this.headElement),this.engine.addEventDragStartToContentBlock(this.headElement),this.engine.addEventDragEndToContentBlock(this.headElement),this.headElement}makeIconNameElement(){this.iconElement=this.iconElement?this.iconElement:document.createElement("button"),this.iconElement.classList.add("exe-icon"),this.iconElement.classList.add("box-icon","exe-app-tooltip"),this.iconElement.setAttribute("data-bs-toggle","tooltip"),this.iconElement.setAttribute("data-bs-original-title",_("Select an icon")),this.iconElement.setAttribute("aria-label",_("Select an icon")),this.iconElement.setAttribute("type","button");let Q=!1;if(this.iconName){if(Q=eXeLearning.app.themes.getThemeIcons()[this.iconName],Q){let Z=this.makeIconValueElement(Q);this.iconElement.innerHTML=Z.outerHTML,this.iconElement.classList.remove("exe-no-icon"),this.iconElement.setAttribute("title",_("Select an icon"))}}if(!Q)this.iconElement.innerHTML=`<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect x="0.5" y="0.5" width="39" height="39" rx="5.5" stroke="#9ca3af" stroke-dasharray="5 5"/>
<path d="M20 13V27M13 20H27" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,this.iconElement.classList.add("exe-no-icon"),this.iconElement.setAttribute("title",_("No icon"));return this.iconElement}makeIconValueElement(Q){let Z=document.createElement("img");return Z.setAttribute("src",Q.value),Z.setAttribute("alt",Q.title),Z}makeBlockTitleElementText(){let Q=document.createElement("div");Q.classList.add("content-editable-title"),this.blockNameElementText=document.createElement("h1"),this.blockNameElementText.classList.add("box-title"),this.blockNameElementText.classList.add("idevice-element-in-content"),this.blockNameElementText.innerHTML=this.blockName;let Z=document.createElement("button");Z.classList.add("auto-icon","btn","btn-ternary","btn-edit-title","exe-app-tooltip"),Z.title=_("Edit title");let Y=document.createElement("span");return Y.classList.add("small-icon","edit-icon"),Z.appendChild(Y),Z.addEventListener("click",()=>{eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((X)=>{if(X.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(X.responseMessage),contentId:"error"});else{this.blockNameElementText.setAttribute("contenteditable","true"),this.blockNameElementText.focus();let J=document.createRange();J.selectNodeContents(this.blockNameElementText),J.collapse(!1);let W=window.getSelection();W.removeAllRanges(),W.addRange(J),Z.style.display="none";let z=!1,G=()=>{let K=eXeLearning.app.project?._yjsBridge?.structureBinding;if(K)K.updateBlock(this.blockId,{blockName:this.blockNameElementText.textContent.trim()})};this.blockNameElementText.addEventListener("input",G);let q=()=>{if(z)return;z=!0,this.blockNameElementText.removeAttribute("contenteditable"),this.blockNameElementText.removeEventListener("input",G),Z.style.display="",this.apiUpdateTitle(this.blockNameElementText.textContent.trim())},H=(K)=>{if(K.key==="Enter")K.preventDefault(),q()};this.blockNameElementText.addEventListener("blur",q),this.blockNameElementText.addEventListener("keydown",H)}})}),Q.appendChild(this.blockNameElementText),Q.appendChild(Z),eXeLearning.app.common.initTooltips(Q),this.addBehaviourChangeIcon(),Q}test(){c.log("click")}makeBlockButtonsElement(){let Q=this.blockId,Z=`
        <div class="exe-actions-menu dropdown">
            <button class="btn-action-menu btn button-tertiary button-narrow button-combo combo-left d-flex justify-content-center align-items-center btn-move-up" type="button" id=moveUp${Q} title="${_("Move up")}"><span class="small-icon arrow-up-icon"></span></button>
            <button class="btn-action-menu btn button-tertiary button-narrow button-combo combo-right d-flex justify-content-center align-items-center btn-move-down" type="button" id=moveDown${Q} title="${_("Move down")}"><span class="small-icon arrow-down-icon"></span></button>
            <button class="btn-action-menu btn button-tertiary button-square d-flex justify-content-center align-items-center exe-advanced" type="button" id="dropdownMenuButton${Q}" data-bs-toggle="dropdown" aria-expanded="false" title="${_("Actions")}">
                <span class="small-icon dots-menu-vertical-icon"></span>
            </button>
            <ul class="dropdown-menu button-action-block exe-advanced" aria-labelledby="dropdownMenuButton${Q}">
                <li><button class="dropdown-item button-action-block" id="dropdownBlockMore-button-properties${Q}"><span class="small-icon settings-icon-green"></span>${_("Properties")}</button></li>
                <li><button class="dropdown-item button-action-block" id="dropdownBlockMore-button-clone${Q}"><span class="small-icon duplicate-icon-green"></span>${_("Clone")}</button></li>
                <li><button class="dropdown-item button-action-block" id="dropdownBlockMore-button-move${Q}"><span class="small-icon move-icon-green"></span>${_("Move to")}</button></li>
                <li><button class="dropdown-item button-action-block" id="dropdownBlockMore-button-export${Q}"><span class="small-icon download-icon-green"></span>${_("Export")}</button></li>
                <li><button class="dropdown-item button-action-block" id="deleteBlock${Q}"><span class="small-icon delete-icon-red"></span><span>${_("Delete box")}</span></button></li>
             </ul>
        </div>`;return this.blockButtons=document.createElement("div"),this.blockButtons.classList.add("box_actions"),this.blockButtons.classList.add("idevice-element-in-content"),this.blockButtons.insertAdjacentHTML("beforeend",Z),this.addBehaviourButtonDropDown(),this.addBehaviourButtonMoveUpBlock(),this.addBehaviourButtonMoveDownBlock(),this.addBehaviourButtonDeleteBlock(),this.addBehaviourButtonPropertiesBlock(),this.addBehaviourButtonCloneBlock(),this.addBehaviourMoveToPageBlockButton(),this.addBehaviourExportBlockButton(),this.addBehaviourToggleBlockButton(),this.addTooltips(),this.addNoTranslateForGoogle(),this.blockButtons}addBehaviourChangeIcon(){this.iconElement.addEventListener("click",(Q)=>{eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else this.showModalChangeIcon()})})}addBehaviourButtonCheckBrokenLinksBlock(){this.blockButtonCheckBrokenLinks.addEventListener("click",(Q)=>{let Z=this.blockId;this.getOdeBlockBrokenLinksEvent(Z).then((Y)=>{if(!Y.responseMessage)eXeLearning.app.modals.odebrokenlinks.show(Y);else eXeLearning.app.modals.alert.show({title:_("Broken Links"),body:_("No broken links found.")})})})}addBehaviourButtonDropDown(){this.blockButtons.querySelector("#dropdownMenuButton"+this.blockId).addEventListener("click",(Q)=>{var Z=document.getElementById("dropdownMenuButton"+this.blockId),Y=document.getElementById(this.blockId);if(Z&&Y){var X=Z.classList;if(Z.classList.contains("show")){if(Y.classList.contains("hidden-idevices"))this.toggleOn()}}})}addBehaviourButtonMoveUpBlock(){this.blockButtons.querySelector("#moveUp"+this.blockId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;var Z=$("#dropdownMenuButton"+this.blockId);if(Z.attr("aria-expanded")=="true")Z.trigger("click");eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((Y)=>{if(Y.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Y.responseMessage),contentId:"error"});else if(!this.blockContent.classList.contains("moving")){let X=this.getContentPrevBlock(),J=this.order;if(X)this.blockContent.classList.add("moving"),this.order--,this.apiUpdateOrder().then((W)=>{if(W.responseMessage=="OK")this.engine.nodeContentElement.insertBefore(this.blockContent,X)})}})})}addBehaviourButtonMoveDownBlock(){this.blockButtons.querySelector("#moveDown"+this.blockId).addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;var Z=$("#dropdownMenuButton"+this.blockId);if(Z.attr("aria-expanded")=="true")Z.trigger("click");eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((Y)=>{if(Y.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Y.responseMessage),contentId:"error"});else if(!this.blockContent.classList.contains("moving")){let X=this.getContentNextBlock(),J=this.order;if(X)this.blockContent.classList.add("moving"),this.order++,this.apiUpdateOrder().then((W)=>{if(W.responseMessage=="OK")this.engine.nodeContentElement.insertBefore(this.blockContent,X.nextSibling)})}})})}addBehaviourButtonDeleteBlock(){this.blockButtons.querySelector("#deleteBlock"+this.blockId).addEventListener("click",(Q)=>{var Z=$("#dropdownMenuButton"+this.blockId);if(Z.attr("aria-expanded")=="true")Z.trigger("click");eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((Y)=>{if(Y.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Y.responseMessage),contentId:"error"});else this.remove(!0),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode()})})}addBehaviourButtonPropertiesBlock(){this.blockButtons.querySelector("#dropdownBlockMore-button-properties"+this.blockId).addEventListener("click",(Q)=>{eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else this.loadPropertiesFromYjs(),eXeLearning.app.modals.properties.show({node:this,title:_("Box properties"),contentId:"block-properties",properties:this.properties})})})}addBehaviourButtonCloneBlock(){this.blockButtons.querySelector("#dropdownBlockMore-button-clone"+this.blockId).addEventListener("click",(Q)=>{this.apiCloneBlock()})}addBehaviourMoveToPageBlockButton(){this.blockButtons.querySelector("#dropdownBlockMore-button-move"+this.blockId).addEventListener("click",(Q)=>{eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else{let Y=this.generateModalMoveToPageBody();eXeLearning.app.modals.confirm.show({title:_("Move Block to page"),body:Y.innerHTML,contentId:"modal-move-to-page",confirmButtonText:_("Move"),cancelButtonText:_("Cancel"),confirmExec:()=>{let X=eXeLearning.app.modals.confirm.modalElementBody.querySelector(".select-move-to-page"),W=X.item(X.selectedIndex).getAttribute("value"),q=document.querySelector("#main #workarea").querySelector("#menu_nav_content").querySelector(`[nav-id="${W}"]`);this.apiUpdatePage(W)}})}})})}addBehaviourExportBlockButton(){this.blockButtons.querySelector("#dropdownBlockMore-button-export"+this.blockId).addEventListener("click",(Q)=>{eXeLearning.app.project.isAvalaibleOdeComponent(this.blockId,null).then((Z)=>{if(Z.responseMessage!=="OK")eXeLearning.app.modals.alert.show({title:_("iDevice error"),body:_(Z.responseMessage),contentId:"error"});else this.downloadBlockSelected(this.blockId)})})}addBehaviourToggleBlockButton(){this.toggleElement=this.headElement.querySelector("#toggleBox"+this.blockId),this.toggleElement.addEventListener("click",(Q)=>{if(this.toggleElement.classList.contains("box-toggle-on")){var Z=$("#dropdownMenuButton"+this.blockId);if(Z.attr("aria-expanded")=="true")Z.trigger("click");this.toggleOff()}else this.toggleOn()})}addTooltips(){$('button.btn-action-menu:not([data-bs-toggle="dropdown"])',this.blockButtons).addClass("exe-app-tooltip"),eXeLearning.app.common.initTooltips(this.blockButtons)}addNoTranslateForGoogle(){$(".auto-icon",this.ideviceButtons).addClass("notranslate")}async downloadBlockSelected(Q){try{let Z=eXeLearning.app.project._yjsBridge;if(!Z)throw Error("Yjs bridge not initialized");let Y=Z.documentManager,X=eXeLearning.app.project._assetCache||null,J=Z.assetManager||null,z=await window.createExporter("COMPONENT",Y,X,null,J).exportAndDownload(Q,null);if(!z.success)eXeLearning.app.modals.alert.show({title:_("Download error"),body:z.error||_("Failed to export block"),contentId:"error"})}catch(Z){console.error("[blockNode] Export failed:",Z),eXeLearning.app.modals.alert.show({title:_("Download error"),body:Z.message,contentId:"error"})}}toggleOff(){this.blockContent.classList.add("hidden-idevices"),this.blockContent.classList.remove("dropdown-menu-on"),this.toggleElement.classList.add("box-toggle-off"),this.toggleElement.classList.remove("box-toggle-on"),this.toggleElement.setAttribute("title",_("Show")),this.toggleElement.querySelector("span").innerHTML="keyboard_arrow_up"}toggleOn(){this.blockContent.classList.remove("hidden-idevices"),this.toggleElement.classList.remove("box-toggle-off"),this.toggleElement.classList.add("box-toggle-on"),this.toggleElement.setAttribute("title",_("Hide")),this.toggleElement.querySelector("span").innerHTML="keyboard_arrow_down"}generateModalMoveToPageBody(){let Q=document.createElement("div"),Z=document.createElement("p"),Y=document.createElement("select");return Z.innerHTML=_("Select the page you want to move the block to. This will be at the end of it."),Z.classList.add("text-info-move-to-page"),Y.classList.add("select-move-to-page"),Q.append(Z),Q.append(Y),eXeLearning.app.project.structure.getAllNodesOrderByView().forEach((J)=>{let W=document.createElement("option");if(W.value=J.id,W.innerHTML=`${"&nbsp;&nbsp;".repeat(J.deep)} ${J.pageName}`,J.id==this.odeNavStructureSyncId)W.setAttribute("selected","selected");Y.append(W)}),Q}showModalChangeIcon(){eXeLearning.app.modals.confirm.show({title:_("Select icon"),body:this.makeModalChangeIconBody().outerHTML,confirmButtonText:_("Save"),cancelButtonText:_("Cancel"),confirmExec:()=>{this.saveIconAction()},behaviour:()=>{this.addBehaviourToModalChangeIconBody()}})}saveIconAction(){let Z=eXeLearning.app.modals.confirm.modalElementBody.querySelector('.option-block-icon[selected="true"]'),Y="";if(Z){let J=Z.getAttribute("icon-id");Y=J?J:Z.innerHTML}if(Y=="0"||Y==this.emptyIcon)Y="";let X=eXeLearning.app.project?._yjsBridge?.structureBinding;if(X)X.updateBlock(this.blockId,{iconName:Y});this.apiUpdateIcon(Y)}makeModalChangeIconBody(){let Q=document.createElement("div");Q.id="change-block-icon-modal-content",Q.appendChild(this.makeEmptyIcon());for(let[Z,Y]of Object.entries(eXeLearning.app.themes.getThemeIcons())){let X=document.createElement("div");X.classList.add("exe-icon"),X.classList.add("option-block-icon"),X.setAttribute("tabindex",0),X.setAttribute("icon-id",Y.id);let J=this.makeIconValueElement(Y);if(X.append(J),this.iconName==Y.value||this.iconName==J.getAttribute("icon-id")){if(X.setAttribute("selected",!0),this.iconName==Y.value)X.classList.add("selected-provisional")}Q.appendChild(X)}return Q}makeEmptyIcon(){let Q=document.createElement("div"),Z=this.emptyIcon,Y=_("Empty");return Q.classList.add("exe-icon"),Q.classList.add("option-block-icon"),Q.classList.add("empty-block-icon"),Q.setAttribute("tabindex",0),Q.setAttribute("icon-id",0),Q.title=Y,Q.innerHTML=Z,Q.setAttribute("selected",!this.iconName),Q}addBehaviourToModalChangeIconBody(){let Z=eXeLearning.app.modals.confirm.modalElementBody.querySelectorAll("#change-block-icon-modal-content .option-block-icon");Z.forEach((Y)=>{Y.addEventListener("click",(X)=>{Z.forEach((W)=>{W.setAttribute("selected","false")}),Y.setAttribute("selected",!0);let J=eXeLearning.app.project?._yjsBridge?.structureBinding;if(J){let W=Y.getAttribute("icon-id"),z=W==="0"||W===this.emptyIcon?"":W;J.updateBlock(this.blockId,{iconName:z})}}),Y.addEventListener("dblclick",(X)=>{Z.forEach((J)=>{J.setAttribute("selected","false")}),Y.setAttribute("selected",!0),this.saveIconAction(),eXeLearning.app.modals.confirm.close()}),Y.addEventListener("keyup",(X)=>{if(X.key=="Enter")Z.forEach((J)=>{J.setAttribute("selected","false")}),Y.setAttribute("selected",!0),this.saveIconAction(),eXeLearning.app.modals.confirm.close()})})}getCurrentOrder(){let Q,Z;if(Q=this.getContentPrevBlock())return this.order=parseInt(Q.getAttribute("order"))+1,this.order;else if(Z=this.getContentNextBlock())return this.order=parseInt(Z.getAttribute("order"))-1,this.order;return-1}getContentPrevBlock(){let Q=this.blockContent.previousElementSibling;if(Q&&Q.classList&&Q.classList.contains("box"))return Q;return!1}getContentNextBlock(){let Q=this.blockContent.nextSibling;if(Q&&Q.classList&&Q.classList.contains("box"))return Q;return!1}apiUpdateIcon(Q){let Z=["odePagStructureSyncId","iconName"];if(this.iconName=Q,this.id)this.apiSendDataService("putSaveBlock",Z).then((Y)=>{this.makeIconNameElement()})}apiUpdateTitle(Q){let Z=["odePagStructureSyncId","blockName"];this.blockName=Q,this.blockNameElementText.innerHTML=Q;let Y=eXeLearning.app.project?._yjsBridge?.structureBinding;if(Y)Y.updateBlock(this.blockId,{blockName:Q});if(this.id)this.apiSendDataService("putSaveBlock",Z)}async apiSaveProperties(Q,Z){for(let[X,J]of Object.entries(Q))this.properties[X].value=J;let Y={odePagStructureSyncId:this.id};if(Z)Y.updateChildsProperties="true";for(let[X,J]of Object.entries(this.properties))Y[X]=J.value;eXeLearning.app.api.putSavePropertiesBlock(Y).then((X)=>{if(X.responseMessage&&X.responseMessage=="OK"){if(this.generateBlockContentNode(!1),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode(),Z&&X.odePagStructureSync.odeComponentsSyncs)X.odePagStructureSync.odeComponentsSyncs.forEach((J)=>{let W=this.engine.getIdeviceById(J.odeIdeviceId);W.setProperties(this.properties,!0),W.makeIdeviceContentNode(!1)})}else eXeLearning.app.modals.alert.show({title:_("Block error"),body:_("An error occurred while saving block's properties in database"),contentId:"error"})})}async apiUpdatePage(Q){if(this.odeNavStructureSyncId==Q)return!1;if(this.isYjsEnabled())return await this.moveToPageViaYjs(Q);let Z=["odePagStructureSyncId","odeNavStructureSyncId"];this.odeNavStructureSyncId=Q;let Y=await this.apiSendDataService("putSaveBlock",Z);if(Y.responseMessage=="OK")this.remove();else{let X=_("An error occurred while update component in database");this.showModalMessageErrorDatabase(Y,X)}}async moveToPageViaYjs(Q){try{let Y=eXeLearning.app?.project?._yjsBridge?.structureBinding;if(!Y)return console.warn("[BlockNode] Cannot move to page via Yjs: structureBinding not available"),{responseMessage:"ERROR"};let X=Y.moveBlockToPage(this.blockId,Q);if(!X&&this.id&&this.id!==this.blockId)c.log("[BlockNode] Retrying with id:",this.id),X=Y.moveBlockToPage(this.id,Q);if(X)return this.odeNavStructureSyncId=Q,this.pageId=Q,this.remove(),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode(),{responseMessage:"OK"};return{responseMessage:"ERROR"}}catch(Z){return console.error("[BlockNode] Error moving to page via Yjs:",Z),{responseMessage:"ERROR"}}}async deleteBlockViaYjs(){try{let Z=eXeLearning.app?.project?._yjsBridge?.structureBinding;if(!Z)return console.warn("[BlockNode] Cannot delete block via Yjs: structureBinding not available"),{responseMessage:"ERROR"};let Y=[this.blockId,this.id].filter(Boolean),X=!1;for(let J of Y)if(c.log("[BlockNode] Trying to delete block with id:",J),X=Z.deleteBlock(this.pageId,J),X){c.log("[BlockNode] Block deleted via Yjs with id:",J);break}if(X)return{responseMessage:"OK"};return console.warn("[BlockNode] Block not found in Yjs for deletion"),{responseMessage:"ERROR"}}catch(Q){return console.error("[BlockNode] Error deleting block via Yjs:",Q),{responseMessage:"ERROR"}}}async cloneBlockViaYjs(){try{let Q=eXeLearning.app?.project?._yjsBridge,Z=this.pageId??this.odeNavStructureSyncId??eXeLearning.app.project.structure?.getSelectNodePageId?.()??eXeLearning.app.project.structure?.nodeSelected?.id;if(!Q||!Z)throw console.error("[BlockNode] cloneBlockViaYjs missing:",{bridge:!!Q,pageId:Z}),Error("Yjs bridge not available or missing pageId");let Y=[this.blockId,this.id].filter(Boolean),X=null;for(let J of Y)if(c.log("[BlockNode] Trying to clone block with id:",J),X=Q.cloneBlock(Z,J),X){c.log("[BlockNode] Block cloned via Yjs with id:",J);break}if(!X&&Y.length===0)throw console.error("[BlockNode] No block IDs available for cloning"),Error("No block ID available");if(X){c.log("[BlockNode] Cloned block via Yjs:",this.id,"→",X.id),await this.engine.loadApiIdevicesInPage(!0);let J=this.engine.getBlockById(X.id);if(J)J.goWindowToBlock(100),J.blockContent.classList.add("moving"),setTimeout(()=>{J.blockContent.classList.remove("moving")},2500);return{responseMessage:"OK",clonedBlock:X}}else throw Error("Failed to clone block via Yjs")}catch(Q){console.error("[BlockNode] Yjs clone error:",Q);let Z=_("An error occurred while cloning the block");return this.showModalMessageErrorDatabase({responseMessage:"ERROR"},Z),{responseMessage:"ERROR"}}}async apiUpdateOrder(Q){if(Q){let X=this.getCurrentOrder();if(X>=0)this.order=X;else if(typeof this.getFallbackPageOrder==="function")this.order=this.getFallbackPageOrder()}if(this.isYjsEnabled())return await this.reorderViaYjs();let Z=["odePagStructureSyncId","order"],Y=await this.apiSendDataService("putReorderBlock",Z);if(Y.responseMessage=="OK")setTimeout(()=>{this.blockContent.classList.remove("moving")},this.engine.movingClassDuration);else{let X=_("An error occurred while update component in database");this.showModalMessageErrorDatabase(Y,X)}return Y}async reorderViaYjs(){try{let Z=eXeLearning.app?.project?._yjsBridge?.structureBinding;if(!Z)return console.warn("[BlockNode] Cannot reorder via Yjs: structureBinding not available"),{responseMessage:"ERROR"};let Y=Z.updateBlockOrder(this.blockId,this.order);if(!Y&&this.id&&this.id!==this.blockId)c.log("[BlockNode] Retrying reorder with id:",this.id),Y=Z.updateBlockOrder(this.id,this.order);if(Y)return setTimeout(()=>{this.blockContent?.classList.remove("moving")},this.engine.movingClassDuration),{responseMessage:"OK"};return{responseMessage:"ERROR"}}catch(Q){return console.error("[BlockNode] Error reordering via Yjs:",Q),{responseMessage:"ERROR"}}}getFallbackPageOrder(){try{let Q=this.pageId||(this.engine&&this.engine.project&&this.engine.project.app&&this.engine.project.app.project&&this.engine.project.app.project.structure&&this.engine.project.app.project.structure.getSelectNodePageId?this.engine.project.app.project.structure.getSelectNodePageId():null),Y=(this.engine&&this.engine.components&&Array.isArray(this.engine.components.blocks)?this.engine.components.blocks:[]).filter((X)=>{if(!X)return!1;let J=X.pageId||null;return J&&Q?String(J)===String(Q):!1}).map((X)=>{let J=X.order!==void 0&&X.order!==null?parseInt(X.order):NaN,W=X.blockContent&&X.blockContent.getAttribute?parseInt(X.blockContent.getAttribute("order")):NaN;return!isNaN(J)?J:!isNaN(W)?W:NaN}).filter((X)=>!isNaN(X));if(Y.length)return Math.max(...Y)+1;return 1}catch(Q){}return 1}async apiCloneBlock(){return await this.cloneBlockViaYjs()}async apiDeleteBlock(){if(this.isYjsEnabled())return await this.deleteBlockViaYjs();eXeLearning.app.api.deleteBlock(this.id).then((Q)=>{if(Q.responseMessage&&Q.responseMessage=="OK"){if(Q.odePagStructureSyncs)this.engine.updateComponentsBlocks(Q.odePagStructureSyncs,["order"])}else{let Z=_("An error occurred while removing the component from the database");this.showModalMessageErrorDatabase(Q,Z)}})}async apiSendDataService(Q,Z){let Y=this.generateDataObject(Z),X=await eXeLearning.app.api[Q].call(eXeLearning.app.api,Y);if(X&&X.responseMessage=="OK"){if(X.odePagStructureSyncs)this.engine.updateComponentsBlocks(X.odePagStructureSyncs,["order"]);return X}else return!1}generateDataObject(Q){let Z=this.getDictBaseValuesData(),Y={};return Q.forEach((X)=>{Y[X]=Z[X]}),Y}getDictBaseValuesData(){let Q=eXeLearning.app.project.odeVersion,Z=eXeLearning.app.project.odeSession,Y=eXeLearning.app.project.structure.getSelectNodeNavId(),X=eXeLearning.app.project.structure.getSelectNodePageId();return{odePagStructureSyncId:this.id,odeVersionId:Q,odeSessionId:Z,odeNavStructureSyncId:this.odeNavStructureSyncId?this.odeNavStructureSyncId:Y,odePageId:this.pageId?this.pageId:X,iconName:this.iconName,blockName:this.blockName,order:this.order}}showModalMessageErrorDatabase(Q,Z){let Y,X;if(Y=_("Block error"),Q&Q.message)X=Q.message;else X=Z;setTimeout(()=>{eXeLearning.app.modals.alert.show({title:Y,body:X,contentId:"error"})},300)}remove(Q){if(this.blockContent.remove(),this.engine.removeBlockOfComponentList(this.id),this.removeIdevices(),this.engine.updateMode(),Q)this.apiDeleteBlock()}removeIdevices(){this.idevices.forEach((Q)=>{Q.remove(!1)})}removeIdeviceOfListById(Q){this.clearIdevicesOfList(),this.idevices=this.idevices.filter((Z,Y,X)=>{return Z.id!=Q})}clearIdevicesOfList(){this.idevices.forEach((Q)=>{if(!this.engine.components.idevices.includes(Q))Q.hasBeenDeleted=!0}),this.idevices=this.idevices.filter((Q,Z,Y)=>{return!Q.hasBeenDeleted})}removeClassLoading(){this.blockContent.classList.remove("loading")}updateParam(Q,Z){switch(this[Q]=Z,Q){case"order":this.blockContent.setAttribute("order",this.order);break;case"id":this.blockContent.setAttribute("sym-id",this.id)}}updateMode(Q){if(Q)this.mode=Q;switch(this.blockContent.setAttribute("mode",this.mode),this.mode){case"edition":this.headElement.setAttribute("draggable",!1),this.headElement.classList.remove("draggable");break;case"export":this.headElement.setAttribute("draggable",!0),this.headElement.classList.add("draggable");break}}resetWindowHash(){window.location.hash="node-content"}goWindowToBlock(Q){let Z=this.blockId;setTimeout(()=>{window.location.hash=Z},Q)}focusTextInput(Q){Q.focus();let Z=Q.value;Q.value="",Q.value=Z}sendPublishedNotification(){if(!this.offlineInstallation)this.realTimeEventNotifier.notify(eXeLearning.app.project.odeSession,{name:"new-content-published"})}}function N0(Q){return Q&&Q.toLowerCase().endsWith("@guest.local")}function m2(Q){let Z=0;for(let Y=0;Y<Q.length;Y++){let X=Q.charCodeAt(Y);Z=(Z<<5)-Z+X,Z=Z&Z}return Math.abs(Z).toString(16).padStart(32,"0")}function s(Q,Z=50){if(!Q)return null;let Y=m2(Q.trim().toLowerCase()),X=N0(Q),W=`https://www.gravatar.com/avatar/${Y}?d=${X?"identicon":"initials"}&s=${Z}&r=g`;if(!X){let z=s1(Q);W+=`&initials=${encodeURIComponent(z)}`}return W}function j2(Q){if(!Q)return"?";let Z=Q.trim().split(/\s+/);if(Z.length===1)return Z[0].substring(0,2).toUpperCase();return(Z[0][0]+Z[Z.length-1][0]).toUpperCase()}function s1(Q){if(!Q)return"?";let Z=Q.split("@")[0],Y=Z.split(/[._-]/).filter(Boolean);if(Y.length>=2)return(Y[0][0]+Y[1][0]).toUpperCase();return Z.substring(0,2).toUpperCase()}function v(Q){if(!Q)return"?";if(Q.includes("@"))return s1(Q);return j2(Q)}function c2(Q={}){let{email:Z="",name:Y="",gravatarUrl:X="",initials:J="",size:W=40,cssClasses:z=[],color:G=""}=Q,q=document.createElement("div");if(q.className=["avatar-container",...z].join(" "),Z)q.title=Z;if(G)q.style.borderColor=G;let H=J||v(Y||Z);if(X){let K=document.createElement("img");K.className="exe-gravatar",K.src=X,K.alt=Z||Y||"User",K.width=W,K.height=W,K.onerror=function(){this.style.display="none";let V=document.createElement("span");V.className="avatar-initials",V.textContent=H,q.appendChild(V)},q.appendChild(K)}else{let K=document.createElement("span");K.className="avatar-initials",K.textContent=H,q.appendChild(K)}return q}function n1(Q={}){let{email:Z="",name:Y="",gravatarUrl:X="",initials:J="",size:W=40}=Q,z=J||v(Y||Z),G=Z?`title="${i1(Z)}"`:"";if(X){let q=`this.style.display='none';this.parentElement.innerHTML+='<span class=\\'avatar-initials\\'>${z}</span>';`;return`<img class="exe-gravatar" src="${i1(X)}" alt="${i1(Z||Y)}" width="${W}" height="${W}" ${G} onerror="${q}">`}return`<span class="avatar-initials" ${G}>${z}</span>`}function i1(Q){if(!Q)return"";let Z=document.createElement("div");return Z.textContent=Q,Z.innerHTML}if(typeof window<"u")window.AvatarUtils={isGuestAccount:N0,generateGravatarUrl:s,getInitialsFromName:j2,getInitialsFromEmail:s1,getInitials:v,createAvatarElement:c2,createAvatarHTML:n1};var h=window.AppLogger||console;class C0{constructor(Q){this.project=Q,this.workareaElement=document.querySelector("#main #workarea"),this.nodeContainerElement=this.workareaElement.querySelector("#node-content-container"),this.nodeContentLoadScreenElement=this.nodeContainerElement.querySelector("#load-screen-node-content"),this.nodeContentElement=this.nodeContainerElement.querySelector("#node-content"),this.loadingPage=!1,this.hideNodeContanerLoadScreenTimeout=null,this.mode="view",this.draggedElement=null,this.ideviceActive=null,this.menuIdevicesDraggableElements=null,this.clickIdeviceMenuEnabled=null,this.intervalTime=100,this.movingClassDuration=200,this.clientCallWaitingTime=this.project.app.eXeLearning.config.clientCallWaitingTime,this.ideviceScriptsElements=[],this.components={blocks:[],idevices:[]}}behaviour(){this.clickIdeviceMenuEnabled=!0,this.menuIdevicesElement=this.project.app.menus.menuIdevices.menuIdevices,this.menuIdevicesElementBottom=this.project.app.menus.menuIdevices.menuIdevicesBottomContent,this.menuIdevicesDraggableElements=[...this.menuIdevicesElement.querySelectorAll(".idevice_item.draggable"),...this.menuIdevicesElementBottom.querySelectorAll(".idevice_item.draggable")],this.updateMode(),this.addEventDragEnterToContainer(this.nodeContentElement),this.addEventDragLeaveToContainer(this.nodeContentElement),this.addEventDropToContainer(this.nodeContentElement),this.addEventDragOverToContainer(this.nodeContentElement),this.addEventDragStartToMenuIdevices(),this.addEventClickIdevice(),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode(),this.initIdevicePresence()}generateId(){return this.project.app.common.generateId()}moveIdeviceMenuToContent(Q,Z){if(this.project.app.project.structure.nodeSelected.getAttribute("nav-id")=="root")return!1;this.draggedElement.classList.add("idevice-content-block"),this.draggedElement.classList.add("idevice-element-in-content");let Y=".idevice-element-in-content.draggable:not(.dragging)",X=[...Q.querySelectorAll(Y)],J=this.getDragAfterElement(Z,X);if(J)if(Q==J.parentNode)Q.insertBefore(this.draggedElement,J);else Q.insertBefore(this.draggedElement,J.parentNode);else Q.append(this.draggedElement)}moveIdeviceContentToContent(Q,Z){let Y=".idevice-element-in-content.draggable:not(.dragging)",X=[...Q.querySelectorAll(Y)],J=this.getDragAfterElement(Z,X);if(J){if(Q!==J.parentNode)J=J.parentNode;Q.insertBefore(this.draggedElement,J)}else Q.append(this.draggedElement)}moveBlockContentToContent(Q,Z){let Y=".box.idevice-element-in-content.draggable:not(.dragging)",X=[...Q.querySelectorAll(Y)],J=this.getDragAfterElement(Z,X);if(J)Q.insertBefore(this.draggedElement,J);else Q.append(this.draggedElement)}addEventDragOverToContainer(Q){Q.addEventListener("dragover",(Z)=>{if(Z.stopPropagation(),this.isDragableInside(this.draggedElement,Q)){if(Z.preventDefault(),this.draggedElement.classList.contains("idevice_item"))this.moveIdeviceMenuToContent(Q,Z.clientY);else if(this.draggedElement.classList.contains("idevice_actions"))this.moveIdeviceContentToContent(Q,Z.clientY);else if(this.draggedElement.classList.contains("box-head"))this.moveBlockContentToContent(Q,Z.clientY)}})}addEventDragEnterToContainer(Q){Q.addEventListener("dragenter",(Z)=>{if(Z.preventDefault(),this.draggedElement){if(Q.id=="node-content")this.draggedElement.classList.add("in"),this.draggedElement.classList.remove("out"),this.draggedElement.inNodeContent++,Q.classList.add("component-inside"),this.project.app.project.structure.menuStructureBehaviour.clearMenuNavDragOverClasses();else if(Q.classList.contains("box")){if(this.components.blocks.forEach((Y)=>{if(Q.id!=Y.blockId){if(Y.blockContent.classList.contains("component-inside"))Y.blockContent.classList.remove("component-inside")}}),this.draggedElement.inBlockContent++,this.draggedElement.inBlockContent>0)Q.classList.add("component-inside")}}})}addEventDragLeaveToContainer(Q){Q.addEventListener("dragleave",(Z)=>{if(Z.preventDefault(),this.draggedElement){if(Q.id=="node-content"){if(this.draggedElement.inNodeContent--,this.draggedElement.inNodeContent<=0)this.draggedElement.inNodeContent=0,this.draggedElement.classList.add("out"),this.draggedElement.classList.remove("in"),Q.classList.remove("component-inside")}else if(Q.classList.contains("box")){if(this.draggedElement.inBlockContent--,this.draggedElement.inBlockContent<=0)this.draggedElement.inBlockContent=0,Q.classList.remove("component-inside")}}})}addEventDropToContainer(Q){Q.addEventListener("drop",async(Z)=>{if(Z.stopPropagation(),this.draggedElement){if(this.draggedElement.classList.contains("idevice_item"))this.dropIdeviceMenuInContent(Q);else if(this.draggedElement.classList.contains("idevice_actions"))this.dropIdeviceContentInContent(Q);else if(this.draggedElement.classList.contains("box-head"))this.dropBlockContentInContent(Q)}})}addEventDragStartToMenuIdevices(){this.menuIdevicesDraggableElements.forEach((Q)=>{Q.addEventListener("dragstart",(Z)=>{Z.stopPropagation(),Q.classList.add("dragging"),Q.setAttribute("hexid",this.generateId()),this.addEventDragEndToMenuIdevice(Q),this.draggedElement=Q.cloneNode(),this.draggedElement.inNodeContent=0,this.draggedElement.inBlockContent=0})})}addEventDragEndToMenuIdevice(Q){Q.addEventListener("dragend",(Z)=>{Z.stopPropagation(),Q.classList.remove("dragging"),document.querySelectorAll(".idevice-content-block").forEach((Y)=>{Y.remove()}),this.resetDragElement()})}async dropIdeviceMenuInContent(Q){if(this.isDragableInside(this.draggedElement,Q)){let Z={odeIdeviceTypeName:this.draggedElement.id},Y=await this.createIdeviceInContent(Z,Q)}this.resetDragElement(!0),this.resetDragOverClasses()}addEventDragStartToContentIdevice(Q){Q.addEventListener("dragstart",(Z)=>{if(eXeLearning.app.project.checkOpenIdevice()){Z.preventDefault();return}Z.stopPropagation(),this.clearSelection();let X=this.getIdeviceById(Q.getAttribute("idevice-id")).ideviceContent;if(!X)return;this.draggedElement=Q,eXeLearning.app.project.isAvalaibleOdeComponent(null,X.id).then((J)=>{if(J.responseMessage=="OK"&&this.draggedElement){if(X.getAttribute("mode")=="export")Q.classList.add("dragging"),Q.classList.add("dragging-start"),this.draggedElement.inNodeContent=0,this.draggedElement.inBlockContent=0,setTimeout(()=>{if(this.draggedElement)X.classList.add("dragging"),Q.classList.remove("dragging-start")},10)}})})}addEventDragEndToContentIdevice(Q){Q.addEventListener("dragend",(Z)=>{if(Z.stopPropagation(),this.draggedElement){this.structureMenuList=this.project.app.menus.menuStructure.menuStructureCompose.menuNavList;let Y=this.structureMenuList.querySelector(".idevice-content-over");if(Y)this.dragEndIdeviceInStructureMenu(Y);else this.dragEndIdeviceOutOffContainer()}})}dragEndIdeviceInStructureMenu(Q){let Z=Q.parentNode.getAttribute("nav-id"),Y=Q.parentNode.getAttribute("page-id"),X=this.getIdeviceById(this.draggedElement.getAttribute("idevice-id")),J=X.odeNavStructureSyncId,W=X.blockId,z=X.order,q=this.getBlockById(W).pageId;if(Z&&X&&X.odeNavStructureSyncId!=Z)this.resetDragElement(!0),this.resetDragOverClasses(),X.apiUpdatePage(Z);else this.dragEndIdeviceOutOffContainer();this.project.app.project.structure.menuStructureBehaviour.clearMenuNavDragOverClasses()}dragEndIdeviceOutOffContainer(){let Q=this.getIdeviceById(this.draggedElement.getAttribute("idevice-id"));this.resetDragElement(!0),this.resetDragOverClasses(),Q.makeIdeviceContentNode(!1),setTimeout(()=>{Q.ideviceContent.classList.remove("dragging")},10),setTimeout(()=>{Q.ideviceContent.classList.remove("dragging")},10),Q.ideviceContent.classList.add("moving"),setTimeout(()=>{Q.ideviceContent.classList.remove("moving")},this.movingClassDuration)}async dropIdeviceContentInContent(Q){if(this.project.app.project.structure.nodeSelected.getAttribute("nav-id")=="root")return!1;if(this.isDragableInside(this.draggedElement,Q)){let Z=this.getIdeviceById(this.draggedElement.getAttribute("idevice-id"));if(Z){let{blockId:Y,order:X}=Z;if(this.addIdeviceNodeToContainer(Z,Q),!this.getIdeviceById(Z.odeIdeviceId))this.addIdeviceToComponentsList(Z,Z.blockId);setTimeout(()=>{Z.ideviceContent.classList.remove("dragging")},10),setTimeout(()=>{Z.ideviceButtons.classList.remove("dragging")},10),this.resetDragElement(!0),this.resetDragOverClasses(),Z.ideviceContent.classList.add("moving"),Z.apiUpdateBlock().then((J)=>{setTimeout(()=>{Z.ideviceContent.classList.remove("moving")},this.movingClassDuration)})}}}addEventDragStartToContentBlock(Q){Q.addEventListener("dragstart",(Z)=>{if(eXeLearning.app.project.checkOpenIdevice()){Z.preventDefault();return}Z.stopPropagation(),this.clearSelection();let Y=Q.parentNode,X=this.getBlockById(Y.id);if(!X)return;this.draggedElement=Q,eXeLearning.app.project.isAvalaibleOdeComponent(X.blockId,null).then((J)=>{if(J.responseMessage=="OK"&&this.draggedElement){if(Y.getAttribute("mode")=="export")Q.classList.add("dragging-start"),this.draggedElement.inNodeContent=0,setTimeout(()=>{if(this.draggedElement){if(Q.classList.add("dragging"),Q.classList.add("dragging-start"),this.nodeContentElement.insertBefore(Q,Y),this.nodeContentElement.insertBefore(Y,Q),Y.classList.add("dragging"),!Y.classList.contains("hidden-idevices")){if(this.draggedElement)this.draggedElement.toggle=!0;X.toggleOff()}Q.classList.remove("dragging-start")}},10)}})})}addEventDragEndToContentBlock(Q){Q.addEventListener("dragend",(Z)=>{if(Z.stopPropagation(),this.draggedElement){this.structureMenuList=this.project.app.menus.menuStructure.menuStructureCompose.menuNavList;let Y=this.structureMenuList.querySelector(".block-content-over");if(Y)this.dragEndBlockInStructureMenu(Y);else this.dragEndBlockOutOffContainer();this.project.app.project.structure.menuStructureBehaviour.clearMenuNavDragOverClasses()}})}dragEndBlockInStructureMenu(Q){let Z=Q.parentNode.getAttribute("nav-id"),Y=Q.parentNode.getAttribute("page-id"),X=this.getBlockById(this.draggedElement.getAttribute("block-id")),J=X.odeNavStructureSyncId,W=X.pageId,z=X.order;if(Z&&X&&Z!=X.odeNavStructureSyncId)this.resetDragElement(!0),this.resetDragOverClasses(),X.apiUpdatePage(Z);else this.dragEndBlockOutOffContainer()}dragEndBlockOutOffContainer(){let Q=this.getBlockById(this.draggedElement.getAttribute("block-id"));if(Q){if(Q.headElement.parentNode!=Q.blockContent)Q.blockContent.prepend(Q.headElement);if(setTimeout(()=>{Q.blockContent.classList.remove("dragging")},10),setTimeout(()=>{Q.headElement.classList.remove("dragging")},10),setTimeout(()=>{Q.headElement.classList.remove("dragging-start")},10),Q.blockContent.classList.add("moving"),this.draggedElement.toggle)Q.toggleOn();this.resetDragElement(),this.resetDragOverClasses(),Q.apiUpdateOrder(!0).then((Z)=>{setTimeout(()=>{Q.blockContent.classList.remove("moving")},this.movingClassDuration)})}}async dropBlockContentInContent(Q){if(this.isDragableInside(this.draggedElement,Q)){let Z=this.getBlockById(this.draggedElement.getAttribute("block-id")),Y=Z.order,X=Z.pageId;if(Z){if(Z.headElement.parentNode!=Z.blockContent)this.nodeContentElement.insertBefore(Z.blockContent,Z.headElement),Z.blockContent.prepend(Z.headElement);if(setTimeout(()=>{Z.blockContent.classList.remove("dragging")},10),setTimeout(()=>{Z.headElement.classList.remove("dragging")},10),Z.blockContent.classList.add("moving"),this.draggedElement.toggle)Z.toggleOn();this.resetDragElement(),this.resetDragOverClasses(),Z.apiUpdateOrder(!0).then((J)=>{setTimeout(()=>{Z.blockContent.classList.remove("moving")},this.movingClassDuration)})}}}resetDragElement(Q){if(this.draggedElement){if(this.draggedElement.classList.remove("in"),this.draggedElement.classList.remove("out"),Q)this.draggedElement.remove();this.draggedElement=null}}resetDragOverClasses(){this.nodeContentElement.classList.remove("component-inside"),this.components.blocks.forEach((Q)=>{Q.blockContent.classList.remove("component-inside")}),this.project.app.project.structure.menuStructureBehaviour.createAddTextBtn()}isDragableInside(Q,Z){if(Q&&Z&&Q!=Z){if(!(Q.classList.contains("box-head")&&Z.classList.contains("box"))){let Y=Q.getAttribute("drag"),X=[];if(Z.getAttribute("drop"))X=JSON.parse(Z.getAttribute("drop"));if(X.includes(Y))return!0}}return!1}getDragAfterElement(Q,Z){return Z.reduce((Y,X)=>{let J=X.getBoundingClientRect(),W=Q-J.top;if(W<0&&W>Y.offset)return{offset:W,element:X};else return Y},{offset:Number.NEGATIVE_INFINITY}).element}addEventClickIdevice(){this.menuIdevicesDraggableElements.forEach((Q)=>{Q.addEventListener("click",async(Z)=>{if(Z.target.classList.contains("ideviceMenu")||Z.target.classList.contains("userIdeviceExport")||Z.target.classList.contains("userIdeviceDelete"))return;if(this.clickIdeviceMenuEnabled){let X={odeIdeviceTypeName:Q.id},J=await this.createIdeviceInContent(X,this.nodeContentElement);this.clickIdeviceMenuEnabled=!1,setTimeout(()=>{this.clickIdeviceMenuEnabled=!0},this.intervalTime)}document.querySelectorAll("#menu_idevices .idevice_category").forEach((X)=>{X.classList.remove("last-open"),X.classList.remove("on"),X.classList.add("off")})})})}async cloneBlockInContent(Q,Z){if(await this.loadApiIdevicesInPage(!0)){let X=this.getBlockById(Z.blockId);X.goWindowToBlock(100),X.blockContent.classList.add("moving"),setTimeout(()=>{X.blockContent.classList.remove("moving")},this.movingClassDuration*2+5*this.components.idevices.length)}}async cloneIdeviceInContent(Q,Z){let X=this.getBlockById(Z.blockId).blockContent;Z.mode="export",Z.loading=!0;let J=await this.createIdeviceInContent(Z,X);X.insertBefore(J.ideviceContent,Q.ideviceContent.nextSibling),J.resetWindowHash(),J.goWindowToIdevice(100),this.resetCurrentIdevicesExportView([J.id]),J.ideviceContent.classList.add("moving"),setTimeout(()=>{J.ideviceContent.classList.remove("moving")},this.movingClassDuration*2)}async createIdeviceInContent(Q,Z,Y=null){if(Z.getAttribute("node-selected")=="root")return eXeLearning.app.modals.alert.show({title:_("Problem adding iDevice"),body:_("You can't add an iDevice on the root page")}),!1;if(Z.querySelector('div.idevice_node[mode="edition"]')!==null)return eXeLearning.app.modals.alert.show({title:_("Info"),body:_("You are currently editing another iDevice. Please close it before continuing")}),!1;$("#eXeAddContentInstructions").remove();let X=await this.newIdeviceNode(Q,Y);if(X){if(this.addIdeviceNodeToContainer(X,Z),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode(),await X.loadInitScriptIdevice(X.mode),X.mode=="edition")this.updateMode()}return X}addIdeviceNodeToContainer(Q,Z){let Y;if(Q.ideviceContent)Q.ideviceContent.prepend(Q.makeIdeviceButtonsElement()),Y=Q.ideviceContent;else Y=Q.makeIdeviceContentNode(!0);if(Z.id=="node-content"){let J={iconName:"",blockName:Q.idevice.title},W=this.newBlockNode(J,!0),z=W.blockContent;z.append(Y),this.setBlockDataToIdeviceNode(Q,W),Z.insertBefore(z,this.draggedElement)}else{let X=this.getBlockById(Z.id);if(X){if(Q.mode==="edition")X.toggleOn();this.setBlockDataToIdeviceNode(Q,X),Z.insertBefore(Y,this.draggedElement)}}if(Q.mode==="edition")eXeLearning.app.project.changeUserFlagOnEdit(!0,this.project.app.project.structure.nodeSelected.getAttribute("nav-id"),Q.blockId,Q.ideviceContent.id),Q.goWindowToIdevice();this.syncNewIdeviceToYjs(Q)}syncNewIdeviceToYjs(Q){let Z=this.project._yjsBridge;if(!Z){console.debug("[IdevicesEngine] No YjsBridge available, skipping Yjs sync");return}let Y=this.project.app.project.structure.nodeSelected?.getAttribute("nav-id");if(!Y){console.warn("[IdevicesEngine] No pageId available for Yjs sync");return}let X=Z.structureBinding.getBlocks(Y);for(let H of X){let K=Z.structureBinding.getComponents(Y,H.id);if(K&&K.some((V)=>V.id===Q.odeIdeviceId)){console.debug(`[IdevicesEngine] Component ${Q.odeIdeviceId} already exists in Yjs (block: ${H.id}), skipping sync`),Q.yjsComponentId=Q.odeIdeviceId,Q.fromYjs=!0;return}}if(Q.fromYjs||Q.yjsComponentId){console.debug(`[IdevicesEngine] Skipping Yjs sync for ${Q.odeIdeviceId} (fromYjs flag set)`);return}let J=Q.blockId;if(Z.structureBinding.getPage(Y)){let H=X.find((K)=>K.id===J||K.blockId===J);if(!H){let K=this.getBlockById(J),V=K?.blockName||"",R=J,O=null;if(K?.blockContent){let A=K.blockContent.parentElement;if(A){let F=Array.from(A.querySelectorAll(":scope > .box")).indexOf(K.blockContent);if(F>=0)O=F}}if(O===null&&typeof K?.getCurrentOrder==="function"){let A=K.getCurrentOrder();if(A>=0)O=A}if(O===null||O<0)O=X.length;if(J=Z.addBlock(Y,V,R,O),J&&K)K.yjsBlockId=J}else J=H.id}let z=Q.idevice?.id||Q.odeIdeviceTypeName||"text",G=null;if(Q.ideviceContent){let H=Q.ideviceContent.parentElement;if(H){let V=Array.from(H.querySelectorAll(":scope > .idevice_node")).indexOf(Q.ideviceContent);if(V>=0)G=V}}if(G===null&&typeof Q.getCurrentOrder==="function"){let H=Q.getCurrentOrder();if(H>=0)G=H}if(G===null||G<0){let H=Z.structureBinding.getComponents(Y,J);G=H?H.length:0}let q=Z.addComponent(Y,J,z,{id:Q.odeIdeviceId,htmlContent:Q.htmlView||"",title:Q.idevice?.title||"",jsonProperties:JSON.stringify(Q.jsonProperties||{}),order:G});if(q)Q.yjsComponentId=q,h.log(`[IdevicesEngine] Synced iDevice to Yjs: ${q} (type: ${z})`)}async renderRemoteIdevice(Q,Z,Y){if(this.project.app.project.structure.nodeSelected?.getAttribute("nav-id")!==Z){console.debug("[IdevicesEngine] Remote iDevice is on different page, skipping render");return}if(document.getElementById(Q.id)){console.debug("[IdevicesEngine] Remote iDevice already exists in DOM, skipping");return}if(this.components.idevices.find((F)=>F.odeIdeviceId===Q.id||F.yjsComponentId===Q.id)){console.debug("[IdevicesEngine] Remote iDevice already exists in components list, skipping");return}h.log(`[IdevicesEngine] Rendering remote iDevice: ${Q.id}`,Q);let z=Q.ideviceType;if(!z){console.warn("[IdevicesEngine] Remote iDevice has no type, skipping render");return}let G={FreeTextIdevice:"text",FreeText:"text",freetext:"text",TextIdevice:"text"};if(G[z])z=G[z];let q=eXeLearning.app.idevices.getIdeviceInstalled(z);if(!q){let F=z.replace(/Idevice$/i,"").toLowerCase();if(q=eXeLearning.app.idevices.getIdeviceInstalled(F),q)z=F}if(!q){console.warn(`[IdevicesEngine] iDevice type not installed: ${Q.ideviceType}, skipping render`);return}let H=document.querySelector(`article[sym-id="${Y}"]`);if(!H){console.debug("[IdevicesEngine] Block not found, creating new block for remote iDevice");let F=document.getElementById("node-content");if(!F)return;let U=this.newBlockNode({blockName:"",iconName:"",blockId:Y},!0);U.yjsBlockId=Y,H=U.blockContent,F.appendChild(H)}let K="{}";if(Q.jsonProperties)K=typeof Q.jsonProperties==="string"?Q.jsonProperties:JSON.stringify(Q.jsonProperties);let V={odeIdeviceTypeName:z,odeIdeviceId:Q.id,htmlView:Q.htmlContent||"",jsonProperties:K,odeComponentsSyncProperties:Q.odeComponentsSyncProperties||{},order:Q.order||0,mode:"export",loading:!1},R=new $0(this,V);if(R.mode="export",R.yjsComponentId=Q.id,Q.lockedBy||Q.lockUserName)R.lockedByRemote=!0,R.lockUserName=Q.lockUserName||"Another user",R.lockUserColor=Q.lockUserColor||"#999";this.components.idevices.push(R);let O=R.makeIdeviceContentNode(!0);(H.querySelector(".box-body")||H).appendChild(O);let M=this.getBlockById(H.id);if(M)this.setBlockDataToIdeviceNode(R,M);if(await R.loadInitScriptIdevice("export"),eXeLearning?.app?.menus?.menuStructure?.menuStructureBehaviour)eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode();h.log(`[IdevicesEngine] Remote iDevice rendered: ${Q.id}`)}async updateRemoteIdeviceContent(Q){let Z=this.components.idevices.find((Y)=>Y.odeIdeviceId===Q.id||Y.yjsComponentId===Q.id);if(!Z){console.debug("[IdevicesEngine] Component not found for update:",Q.id);return}if(h.log(`[IdevicesEngine] Updating remote iDevice content: ${Q.id}`),Z.htmlView=Q.htmlContent||"",Z.lockedByRemote=!1,Z.lockUserName=null,Z.lockUserColor=null,Z.ideviceContent)Z.ideviceContent.setAttribute("loading","false");if(Z.ideviceBody){if(Z.idevice?.componentType!=="json"||Q.htmlContent){let Y=Z.ideviceBody.querySelector(".idevice-locked-placeholder");if(Y)Y.remove();if(Z.mode==="export")Z.ideviceBody.innerHTML=Q.htmlContent||"",await Z.loadInitScriptIdevice("export")}}Z.updateLockIndicator(),h.log(`[IdevicesEngine] Remote iDevice content updated: ${Q.id}`)}newBlockNode(Q,Z){let Y=new E0(this,Q),X=Y.generateBlockContentNode(!0);if(this.addEventDragEnterToContainer(X),this.addEventDragLeaveToContainer(X),this.addEventDropToContainer(X),this.addEventDragOverToContainer(X),Z)this.components.blocks.push(Y);return Y}async newIdeviceNode(Q,Z=null){let Y=!1,X=new $0(this,Q);if(Y=await this.appendNewIdeviceProcess(X,Z),Y)return X;else return setTimeout(()=>{if(!this.project.app.modals.alert.modal._isShown){let J=_("iDevice error");J+=X.odeIdeviceTypeName?` (${X.odeIdeviceTypeName})`:"",this.project.app.modals.alert.show({title:J,body:_("An error occurred while loading the iDevice."),contentId:"error"})}},500),!1}async appendNewIdeviceProcess(Q,Z=null){let Y=await this.saveEditionIdevices(Z);if(Y)this.components.idevices.push(Q);return Y}async resetCurrentIdevicesExportView(Q){this.clearNeedlessScripts(),await this.loadIdevicesExportStyles(),this.components.idevices.forEach(async(Z)=>{if(!Q.includes(Z.id))await Z.generateContentExportView()}),this.loadIdevicesExportScripts(),this.loadLegacyExeFunctionalitiesExport(),setTimeout(()=>{this.components.idevices.forEach((Z)=>{Z.ideviceContent.setAttribute("loading",!1)})},500),this.enableInternalLinks()}async loadApiIdevicesInPage(Q,Z){if(this.loadingPage)return!1;return this.loadingPage=!0,await this.cleanNodeAndLoadPage(Q,Z)}async cleanNodeAndLoadPage(Q,Z){let Y,X=!1,J;if(Z)J=Z.getAttribute("nav-id");else if(this.project.app.project.structure.nodeSelected)J=this.project.app.project.structure.nodeSelected.getAttribute("nav-id");else J=!1;return Y=await this.cleanNodeContent(),X=await this.loadingComponentsProcess(Y,Z,Q),this.loadThemePageTemplate(J),X}loadThemePageTemplate(Q){let Z,Y;this.resetNodeTemplate();let X=eXeLearning.app.themes.selected;if(!X)return;let J=X.getPageTemplateElement(),W=X.templatePageClass;if(Q&&Q!="root"&&J){if(this.nodeContentElement.parentNode&&this.nodeContentElement.parentNode==this.nodeContainerElement)Z=J,Y=Z.querySelector(`.${W}`),Y.append(this.nodeContentElement),this.nodeContainerElement.append(Z)}}resetNodeTemplate(){let Q=eXeLearning.app.themes.selected;if(!Q)return;let Z=Q.templatePageContainerClass;if(this.nodeContentElement.parentNode&&this.nodeContentElement.parentNode!=this.nodeContainerElement){this.nodeContainerElement.append(this.nodeContentElement);let Y=this.nodeContainerElement.querySelector(`.${Z}`);if(Y)Y.remove()}}resetThemePageTemplate(){let Q=this.workareaElement.querySelector(".page-content-template");if(Q)this.workareaElement.append(this.nodeContentElement),Q.remove()}async loadingComponentsProcess(Q,Z,Y){let X=!1;if(Q){let J;if(Z)J=Z.getAttribute("nav-id");else if(this.project.app.project.structure.nodeSelected)J=this.project.app.project.structure.nodeSelected.getAttribute("nav-id");else J=!1;if(Y)this.showNodeContainerLoadScreen();X=await this.loadApiComponentsInContentByPage(J)}return this.loadingPage=!1,X}async loadApiComponentsInContentByPage(Q){if(this.removeNodeContentPageTitle(),this.removeNodeContentLangAttribute(),Q)if(Q=="root")return this.removeNodeContentHeader(),await this.getAndLoadComponentsRootNode(Q),!0;else return await this.getAndLoadComponentsPageNode(Q);else return!1}async getAndLoadComponentsRootNode(Q){if(!this.project?._yjsEnabled){let Z=await this.project.app.api.getComponentsByPage(Q)}this.project.properties.formProperties.show(),this.hideNodeContainerLoadScreen(500)}async getAndLoadComponentsPageNode(Q){this.removeNodeContentFormProperties();let Z=await this.project.app.api.getComponentsByPage(Q);if(Z&&Z.odePagStructureSyncs)return await this.loadComponentsPage(Z.odePagStructureSyncs),await this.loadIdevicesExportStyles(),this.loadIdevicesExportScripts(),this.setParentsAndChildrenIdevicesBlocks(),new Promise((X,J)=>{setTimeout(()=>{if(this.hideNodeContainerLoadScreen(500),this.removeClassLoadingBlocks(),this.loadLegacyExeFunctionalitiesExport(),this.enableInternalLinks(),this.setNodeContentHeader(),this.project?._yjsEnabled)this.setNodeContentPageTitle(Q),this.initPagePropertiesObserver(Q);else this.setNodeContentPageTitle(Z.odeNavStructureSyncProperties);X(!0)},100+10*this.components.idevices.length)});return!1}setNodeContentHeader(){let Q=this.nodeContainerElement.querySelector("#header-node-content");if(Q.innerHTML="",Q){let Z=eXeLearning.app.themes.selected;if(Z&&Z.logoImg){let Y=document.createElement("div");Y.classList.add("logo-img-container"),Y.style.backgroundImage=`url("${Z.getLogoImgUrl()}?v=${Date.now()}")`,Q.append(Y)}if(Z&&Z.headerImg){let Y=document.createElement("div");Y.classList.add("header-img-container"),Y.style.backgroundImage=`url("${Z.getHeaderImgUrl()}?v=${Date.now()}")`,Q.append(Y)}if(Z&&(Z.headerImg||Z.logoImg))Q.classList.remove("hidden");else Q.classList.add("hidden")}}setNodeContentPageTitle(Q){let Z=this.nodeContainerElement.querySelector("#page-title-node-content");if(!Z)return;let Y=this.getPageTitleProperties(Q),X=Y.hidePageTitle===!0||Y.hidePageTitle==="true";if(h.log("[IdevicesEngine] setNodeContentPageTitle - props:",Y),h.log("[IdevicesEngine] setNodeContentPageTitle - hidePageTitle:",X,"(raw:",Y.hidePageTitle,")"),X){h.log("[IdevicesEngine] Hiding page title"),Z.innerText="",Z.classList.add("hidden");return}let W=Y.editableInPage===!0||Y.editableInPage==="true"?Y.titlePage||"":Y.titleNode||"";if(Z.innerText=W,Z.classList.toggle("hidden",!W),W&&/(?:\\\(|\\\[|\\begin\{)/.test(W)){if(typeof MathJax<"u"&&MathJax.typesetPromise)MathJax.typesetPromise([Z]).catch((z)=>{h.log("[IdevicesEngine] MathJax typeset error:",z)});if(typeof $exe<"u"&&$exe.math&&$exe.math.refresh)$exe.math.refresh(Z)}}getPageTitleProperties(Q){if(typeof Q==="string"){let Z=this.project;if(Z?._yjsBridge?.structureBinding){let X=Z._yjsBridge.structureBinding.getPageProperties(Q);if(X)return{hidePageTitle:X.hidePageTitle,editableInPage:X.editableInPage,titlePage:X.titlePage||"",titleNode:X.titleNode||""}}let Y=typeof Z?.structure?.getNodeById==="function"?Z.structure.getNodeById(Q):null;if(Y?.properties)return{hidePageTitle:Y.properties.hidePageTitle?.value,editableInPage:Y.properties.editableInPage?.value,titlePage:Y.properties.titlePage?.value||"",titleNode:Y.properties.titleNode?.value||""};return{}}if(Q&&typeof Q==="object")return{hidePageTitle:Q.hidePageTitle?.value,editableInPage:Q.editableInPage?.value,titlePage:Q.titlePage?.value||"",titleNode:Q.titleNode?.value||""};return{}}initPagePropertiesObserver(Q){if(this.cleanupPagePropertiesObserver(),!this.project?._yjsBridge?.structureBinding)return;let Z=this.project._yjsBridge.structureBinding,Y=Z.getPageMap(Q);if(!Y)return;this._observedPageId=Q,this._observedPageMap=Y;let X=["hidePageTitle","editableInPage","titlePage","titleNode"];this._pagePropertiesObserver=(J,W)=>{if(W.origin==="user")return;let z=!1;for(let G of J)if(G.path.length>0&&G.path[0]==="properties")G.changes.keys.forEach((q,H)=>{if(X.includes(H))z=!0});if(z){let G=Z.getPageProperties(this._observedPageId);h.log("[IdevicesEngine] Remote page properties changed:",G),h.log("[IdevicesEngine] hidePageTitle:",G?.hidePageTitle,typeof G?.hidePageTitle),this.setNodeContentPageTitle(this._observedPageId)}},Y.observeDeep(this._pagePropertiesObserver),h.log("[IdevicesEngine] Page properties observer initialized for:",Q)}cleanupPagePropertiesObserver(){if(this._pagePropertiesObserver&&this._observedPageMap)try{this._observedPageMap.unobserveDeep(this._pagePropertiesObserver)}catch(Q){}this._pagePropertiesObserver=null,this._observedPageId=null,this._observedPageMap=null}removeNodeContentHeader(){let Q=this.nodeContainerElement.querySelector("#header-node-content");Q.innerHTML="",Q.classList.add("sr-av")}removeNodeContentPageTitle(){let Q=this.nodeContainerElement.querySelector("#page-title-node-content");Q.innerHTML="",Q.classList.add("hidden")}removeNodeContentLangAttribute(){this.nodeContentElement.removeAttribute("lang")}removeNodeContentFormProperties(){let Q=this.nodeContentElement.querySelector("#properties-node-content-form");if(Q)Q.remove()}async loadComponentsPage(Q){for(let Z of Q){let X=this.newBlockNode(Z,!0).blockContent;X.classList.add("loading"),this.nodeContentElement.append(X);for(let J of Z.odeComponentsSyncs){J.mode="export";let W=await this.createIdeviceInContent(J,X)}}}async cleanNodeContent(Q){let Z=!0;if(!Q)Z=await this.saveEditionIdevices();if(Z)this.clearNeedlessScripts(),this.nodeContentElement.querySelectorAll(".box.idevice-element-in-content").forEach((Y)=>{Y.remove()}),this.components.blocks=[],this.components.idevices=[],this.updateMode();return Z}showNodeContainerLoadScreen(){if(this.nodeContentLoadScreenElement.classList.add("loading"),this.nodeContentLoadScreenElement.classList.remove("hidden"),this.nodeContentLoadScreenElement.classList.remove("hiding"),this.nodeContentLoadScreenElement.setAttribute("data-visible","true"),this.nodeContentElement?.setAttribute("data-ready","false"),this.hideNodeContanerLoadScreenTimeout)clearTimeout(this.hideNodeContanerLoadScreenTimeout)}hideNodeContainerLoadScreen(Q){this.nodeContentLoadScreenElement.classList.add("hiding"),this.nodeContentLoadScreenElement.classList.remove("loading"),this.hideNodeContanerLoadScreenTimeout=setTimeout(()=>{this.nodeContentLoadScreenElement.classList.add("hidden"),this.nodeContentLoadScreenElement.classList.remove("hiding"),this.nodeContentLoadScreenElement.setAttribute("data-visible","false"),this.nodeContentElement?.setAttribute("data-ready","true")},Q)}removeClassLoadingBlocks(){this.components.blocks.forEach((Q)=>{Q.removeClassLoading()})}async saveEditionIdevices(Q=null){var Z=!0;if(!Q)this.components.idevices.forEach((Y)=>{if(Y.mode=="edition")if(Y.loading)Y.remove();else Z=Y.save()});return Z}updateMode(){if(this.isIdeviceInEdition())this.mode="edition";else this.mode="view";this.nodeContentElement.setAttribute("mode",this.mode)}isIdeviceInEdition(){let Q=!1;return this.components.idevices.forEach((Z)=>{if(Z.mode=="edition")Q=Z}),Q}getIdeviceActive(){return this.ideviceActive}getIdeviceById(Q){var Z=null;return this.components.idevices.forEach((Y)=>{if(Y.odeIdeviceId==Q)Z=Y}),Z}getBlockById(Q){var Z=null;return this.components.blocks.forEach((Y)=>{if(Y.blockId==Q)Z=Y}),Z}addIdeviceToComponentsList(Q,Z){this.components.idevices.push(Q);let Y;if(Y=this.getBlockById(Z))Y.idevices.push(Q)}removeIdeviceOfComponentList(Q){this.components.idevices=this.components.idevices.filter((Z,Y,X)=>{return Z.id!=Q})}removeBlockOfComponentList(Q){this.project.app.project.structure.menuStructureBehaviour.createAddTextBtn(),this.components.blocks=this.components.blocks.filter((Z,Y,X)=>{return Z.id!=Q})}setParentsAndChildrenIdevicesBlocks(Q){if(this.components.blocks.forEach((Z)=>{Z.idevices=[]}),this.components.idevices.forEach((Z)=>{let Y=this.getBlockById(Z.blockId);if(Y)Y.idevices.push(Z)}),Q)this.components.blocks.forEach((Z)=>{if(Z.idevices.length==0){if(Z.removeIfEmpty)Z.remove(!0);else if(Z.askForRemoveIfEmpty)setTimeout(()=>{eXeLearning.app.modals.confirm.show({title:_("Delete box"),body:_("The box is empty. Do you want to delete it?"),confirmButtonText:_("Yes"),confirmExec:()=>{Z.remove(!0)}})},300)}})}updateComponentsBlocks(Q,Z){for(let[Y,X]of Object.entries(Q)){let J=this.getBlockById(X.blockId);if(J)Z.forEach((W)=>{J.updateParam(W,X[W])})}}updateComponentsIdevices(Q,Z){for(let[Y,X]of Object.entries(Q)){let J=this.getIdeviceById(X.odeIdeviceId);if(J)Z.forEach((W)=>{J.updateParam(W,X[W])})}}setBlockDataToIdeviceNode(Q,Z){Q.block=Z,Q.blockId=Z.blockId,Q.odePagStructureSyncId=Z.id,Q.odeNavStructureSyncId=Z.odeNavStructureSyncId}setIdeviceActive(Q){this.ideviceActive=Q}unsetIdeviceActive(){return this.setIdeviceActive(null)}loadIdevicesExportScripts(){var Q={};this.components.idevices.forEach((Z)=>{if(Z.idevice)Q[Z.idevice.id]=Z.idevice});for(let[Z,Y]of Object.entries(Q))Y.loadScriptsExport()}async loadIdevicesExportStyles(){var Q={};this.components.idevices.forEach((Z)=>{if(Z.idevice)Q[Z.idevice.id]=Z.idevice});for(let[Z,Y]of Object.entries(Q))await Y.loadStylesExport()}loadLegacyExeFunctionalitiesExport(){$exeFX.init(),$exeGames.init(),$exeHighlighter.init(),$exeABCmusic.init(),$exe.init()}enableInternalLinks(){let Q=document.querySelectorAll("a[href^='exe-node']");if(Q.length>0){let Z=eXeLearning.app.project.structure.data,Y=document.querySelectorAll(".nav-element-text");Q.forEach((X)=>{let J=null,W="nopage",z=X.href.replace("exe-node:","");if(Z.forEach((G)=>{if(G.pageId===z)W=G.pageName}),Y.forEach((G)=>{if(G.className=="nav-element-text"&&G.innerText==W)J=G}),J)X.onclick=function(G){G.preventDefault(),J.click()}})}}loadScriptDynamically(Q,Z){let Y=document.createElement("script");if(Y.id=this.generateId(),Y.setAttribute("type","text/javascript"),Z)Y.src=`${Q}?t=${Date.now()}`;else Y.src=Q;return h.log("[iDevice] Loading script:",Y.src),Y.onerror=(X)=>{console.error("[iDevice] Failed to load script:",Y.src,X)},Y.onload=()=>{h.log("[iDevice] Script loaded successfully:",Y.src)},document.querySelector("head").append(Y),this.onloadedScriptCallback(Q,Y,!1),Y}loadStyleDynamically(Q,Z){let Y=document.createElement("link");if(Y.id=this.generateId(),Y.setAttribute("rel","stylesheet"),Z)Y.href=`${Q}?t=${Date.now()}`;else Y.href=Q;return document.querySelector("head").append(Y),this.onloadedScriptCallback(Q,Y,!1),Y}async loadStyleByInsertingIt(Q,Z,Y){let X=document.createElement("style");X.id=`idevice-style-${this.generateId()}`,X.setAttribute("idevice",Z.id),X.setAttribute("status",Y);let J=Y=="edition"?Z.pathEdition:Z.pathExport,W=await eXeLearning.app.api.func.getText(Q);return W=W.replace(/url\(\s*(['"]?)(?!data:|http:|https:|blob:|\/)([^'")]+)\1\s*\)/g,(z,G,q)=>`url(${G}${J}${q}${G})`),X.innerHTML=W,document.querySelector("head").append(X),X}loadScript(Q,Z){let Y=Q.split(".").pop(),X;switch(Y){case"css":X=document.createElement("link"),X.id=this.generateId(),X.setAttribute("rel","stylesheet"),X.href=`${Q}?t=${Date.now()}`,this.ideviceScriptsElements.push(X);break;case"js":X=document.createElement("script"),X.id=this.generateId(),X.setAttribute("type","text/javascript"),X.src=`${Q}?t=${Date.now()}`,this.ideviceScriptsElements.push(X);break;default:return}document.querySelector("head").append(X),this.onloadedScriptCallback(Q,X,Z)}clearIdevicesScripts(){this.ideviceScriptsElements.forEach((Q)=>{Q.remove()}),this.ideviceScriptsElements=[]}clearNeedlessScripts(){document.querySelectorAll("head > script:not(.exe)").forEach((Q)=>{Q.remove()})}onloadedScriptCallback(Q,Z,Y){let X=()=>{if(Y)if(typeof Y==="function")Y();else Function(Y)()};if(Z.readyState)Z.onreadystatechange=function(){if(Z.readyState=="loaded"||Z.readyState=="complete")Z.onreadystatechange=null,X()};else Z.onload=function(){X()}}initIdevicePresence(){let Q=()=>{if(this.project?._yjsEnabled&&this.project?._yjsBridge?.getDocumentManager()){let Z=this.project._yjsBridge.getDocumentManager();this._presenceUnsubscribe=Z.onUsersChange(({users:Y})=>{this._updateIdevicePresence(Y)})}else setTimeout(Q,500)};Q()}_updateIdevicePresence(Q){let Z={};Q.forEach((X)=>{if(X.editingComponentId&&!X.isLocal){if(!Z[X.editingComponentId])Z[X.editingComponentId]=[];Z[X.editingComponentId].push(X)}}),document.querySelectorAll(".idevice-editor-avatar").forEach((X)=>{let J=X.getAttribute("data-component-id"),W=Z[J]||[];this._renderIdeviceEditorAvatar(X,W);let z=this.components.idevices.find((G)=>G.odeIdeviceId===J||G.yjsComponentId===J);if(z){let G=z.lockedByRemote,q=W.length>0;if(G!==q){if(q)z.lockedByRemote=!0,z.lockUserName=W[0].name||"Another user",z.lockUserColor=W[0].color||"#999";else z.lockedByRemote=!1,z.lockUserName=null,z.lockUserColor=null;z.updateLockIndicator()}}})}_renderIdeviceEditorAvatar(Q,Z){if(Q.innerHTML="",Z.length===0){Q.style.display="none";return}Q.style.display="flex";let Y=Z[0],X=document.createElement("div");if(X.classList.add("idevice-user-avatar"),X.title=Y.email||`${_("Editing by")} ${Y.name||"User"}`,Y.color)X.style.borderColor=Y.color,X.style.backgroundColor=Y.color+"20";let J=Y.initials||v(Y.name||Y.email),W=Y.gravatarUrl||s(Y.email,24);if(W){let z=document.createElement("img");z.src=W,z.alt=Y.name||"",z.onerror=function(){this.style.display="none",X.textContent=J},X.appendChild(z)}else X.textContent=J;if(Q.appendChild(X),Z.length>1){let z=document.createElement("div");z.classList.add("idevice-user-avatar","idevice-user-more"),z.textContent=`+${Z.length-1}`,Q.appendChild(z)}}clearSelection(){if(window.getSelection)window.getSelection().removeAllRanges();else if(document.selection)document.selection.empty()}}var p=window.AppLogger||console;class l{constructor(Q,Z){this.structure=Q,this.id=Z.id,this.children=[],this.moving=!1,this.setParams(Z),this.canHaveHeirs=!0}properties=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.odeNavStructureSyncPropertiesConfig));params=["odePagStructureSyncs","odeSessionId","odeVersionId","pageId","pageName","parent","order","open"];default={order:0};setParams(Q){if(!Q)return;for(let[Z,Y]of Object.entries(this.params)){let X=this.default[Y]?this.default[Y]:null;this[Y]=Q[Y]?Q[Y]:X}if(Q.odeNavStructureSyncProperties)this.setProperties(Q.odeNavStructureSyncProperties);this.properties.titleNode.value=this.pageName}setProperties(Q,Z){for(let[Y,X]of Object.entries(this.properties)){if(!Q[Y]){console.warn(`Missing property '${Y}' in odeNavStructureSyncProperties`);continue}if(Z){if(Q[Y].heritable)X.value=Q[Y].value}else X.value=Q[Y].value}}isYjsEnabled(){return eXeLearning.app?.project?._yjsEnabled===!0}async create(){if(this.isYjsEnabled()&&eXeLearning.app.project.addPageViaYjs)return await this.createViaYjs();let Q=this.getDictBaseValuesData();Q.pageName=this.pageName,Q.odeNavStructureSyncIdParent=this.parent;let Z=await eXeLearning.app.api.putSavePage(Q);if(Z.responseMessage&&Z.responseMessage=="OK"){if(this.id=Z.odeNavStructureSyncId,this.setParams(Z.odeNavStructureSync),this.structure.data.push(this),Z.odeNavStructureSyncs)this.structure.updateNodesStructure(Z.odeNavStructureSyncs,["order"])}else return eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while saving the node in database"),contentId:"error"}),!1;return Z}async createViaYjs(){try{let Q=eXeLearning.app.project,Z=this.parent==="root"?null:this.parent,Y=Q.addPageViaYjs(this.pageName,Z);if(Y)return this.id=Y.id,this.pageId=Y.id,this.order=Y.order||0,this.structure.data.push(this),p.log("[StructureNode] Created page via Yjs:",Y.id),{responseMessage:"OK",odeNavStructureSyncId:Y.id,odeNavStructureSync:{id:Y.id,pageId:Y.id,pageName:Y.title,parent:Y.parentId,order:Y.order}};else throw Error("Failed to create page via Yjs")}catch(Q){return console.error("[StructureNode] Yjs create error:",Q),eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while creating the page"),contentId:"error"}),!1}}async clone(){if(this.isYjsEnabled()&&eXeLearning.app.project.clonePageViaYjs)return await this.cloneViaYjs();let Q=["odeNavStructureSyncId"],Z=this.generateDataObject(Q),Y=await eXeLearning.app.api.postClonePage(Z);if(Y.responseMessage!=="OK")return eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while cloning the node in database"),contentId:"error"}),!1;return Y}async cloneViaYjs(){try{let Z=eXeLearning.app.project.clonePageViaYjs(this.id);if(Z)return p.log("[StructureNode] Cloned page via Yjs:",Z.id),{responseMessage:"OK",odeNavStructureSync:{id:Z.id,pageId:Z.pageId,pageName:Z.pageName,parent:Z.parentId,order:Z.order}};else throw Error("Failed to clone page via Yjs")}catch(Q){return console.error("[StructureNode] Yjs clone error:",Q),eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while cloning the page"),contentId:"error"}),!1}}async rename(Q){if(this.isYjsEnabled()&&eXeLearning.app.project.renamePageViaYjs)return await this.renameViaYjs(Q);this.pageName=Q;let Z=["odeNavStructureSyncId"],Y=this.generateDataObject(Z);Y.pageName=this.pageName;let X=await eXeLearning.app.api.putSavePage(Y);if(X.responseMessage&&X.responseMessage=="OK")this.properties.titleNode.value=X.odeNavStructureSync.odeNavStructureSyncProperties.titleNode.value;else return eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while updating the node in database"),contentId:"error"}),!1;return X}async renameViaYjs(Q){try{let Z=eXeLearning.app.project;if(this.pageName=Q,this.properties.titleNode.value=Q,Z.renamePageViaYjs(this.id,Q))return p.log("[StructureNode] Renamed page via Yjs:",this.id),{responseMessage:"OK",odeNavStructureSync:{id:this.id,pageName:Q,odeNavStructureSyncProperties:{titleNode:{value:Q}}}};else throw Error("Failed to rename page via Yjs")}catch(Z){return console.error("[StructureNode] Yjs rename error:",Z),eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while renaming the page"),contentId:"error"}),!1}}async remove(){if(this.isYjsEnabled()&&eXeLearning.app.project.deletePageViaYjs)return await this.removeViaYjs();this.structure.data=this.structure.data.filter((Z,Y,X)=>{return Z.id!=this.id});let Q=await eXeLearning.app.api.deletePage(this.id);if(Q.responseMessage!=="OK")return eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while remove the node in database"),contentId:"error"}),!1;return Q}async removeViaYjs(){try{let Q=eXeLearning.app.project,Z=this.id;if(Q.deletePageViaYjs(Z)){let X=this._collectLocalDescendantIds(Z),J=new Set([Z,...X]);return this.structure.data=this.structure.data.filter((W)=>{return!J.has(W.id)}),p.log("[StructureNode] Removed page via Yjs:",Z),{responseMessage:"OK"}}else throw Error(`Page ${Z} not found in Yjs document`)}catch(Q){return console.error("[StructureNode] Yjs remove error:",Q),eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while removing the page"),contentId:"error"}),!1}}_collectLocalDescendantIds(Q){let Z=[];for(let Y of this.structure.data)if(Y.parent===Q)Z.push(Y.id),Z.push(...this._collectLocalDescendantIds(Y.id));return Z}async apiUpdateParent(Q,Z){if(this.isYjsEnabled()&&eXeLearning.app.project.movePageViaYjs)return await this.updateParentViaYjs(Q,Z);if(this.structure.movingNode=!0,this.updateParam("moving",!0),this.parent=Q,Z)this.order=Z;let Y=["odeNavStructureSyncId"],X=this.generateDataObject(Y);if(X.odeNavStructureSyncIdParent=this.parent,Z)X.order=this.order;eXeLearning.app.api.putSavePage(X).then((J)=>{if(J.responseMessage&&J.responseMessage=="OK");else eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while saving the node in database"),contentId:"error"})})}async updateParentViaYjs(Q,Z){let Y=this.parent,X=this.order;try{if(this.structure.movingNode=!0,this.updateParam("moving",!0),this.parent=Q,Z!==void 0&&Z!==null)this.order=Z;if(!eXeLearning.app.project.movePageViaYjs(this.id,Q,Z))return console.warn("[StructureNode] Yjs updateParent failed, rolling back:",this.id),this.parent=Y,this.order=X,this.structure.movingNode=!1,this.updateParam("moving",!1),this.structure.reloadStructureMenu(),!1;return this.structure.movingNode=!1,this.updateParam("moving",!1),p.log("[StructureNode] Updated parent via Yjs:",this.id,"->",Q),!0}catch(J){return console.error("[StructureNode] Yjs updateParent error:",J),this.parent=Y,this.order=X,this.structure.movingNode=!1,this.updateParam("moving",!1),!1}}async apiUpdateOrder(Q){if(this.isYjsEnabled()&&eXeLearning.app.project.movePageViaYjs)return await this.updateOrderViaYjs(Q);this.structure.movingNode=!0,this.updateParam("moving",!0),this.updateOrderByParam(Q);let Z=["odeNavStructureSyncId"],Y=this.generateDataObject(Z);Y.order=this.order,eXeLearning.app.api.putReorderPage(Y).then((X)=>{if(X.responseMessage&&X.responseMessage=="OK");else eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while saving the node in database"),contentId:"error"})}).catch((X)=>{console.error("Failed to reorder page:",X),eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while reordering the page. Please try again."),contentId:"error"})})}async updateOrderViaYjs(Q){let Z=this.order;try{if(this.structure.movingNode=!0,this.updateParam("moving",!0),this.updateOrderByParam(Q),!eXeLearning.app.project.movePageViaYjs(this.id,this.parent,this.order))return console.warn("[StructureNode] Yjs updateOrder failed, rolling back:",this.id),this.order=Z,this.structure.movingNode=!1,this.updateParam("moving",!1),this.structure.reloadStructureMenu(),!1;return this.structure.movingNode=!1,this.updateParam("moving",!1),p.log("[StructureNode] Updated order via Yjs:",this.id,"->",this.order),!0}catch(Y){return console.error("[StructureNode] Yjs updateOrder error:",Y),this.order=Z,this.structure.movingNode=!1,this.updateParam("moving",!1),!1}}async apiSaveProperties(Q,Z){for(let[X,J]of Object.entries(Q))if(this.properties[X])this.properties[X].value=J;if(this.isYjsEnabled())return await this.savePropertiesViaYjs(Q);let Y={odeNavStructureSyncId:this.id};if(Z)Y.updateChildsProperties="true";for(let[X,J]of Object.entries(this.properties))Y[X]=J.value;eXeLearning.app.api.putSavePropertiesPage(Y).then((X)=>{if(X.responseMessage&&X.responseMessage=="OK")this.structure.renameNodeAndReload(this.id,Y.titleNode),this.structure.project.idevices.loadApiIdevicesInPage(!0);else eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while saving node's properties in database"),contentId:"error"})})}async savePropertiesViaYjs(Q){try{let Y=eXeLearning.app.project._yjsBridge;if(!Y||!Y.structureBinding)return console.warn("[StructureNode] Yjs structure binding not available"),!1;if(Y.structureBinding.updatePageProperties(this.id,Q)){if(p.log("[StructureNode] Saved properties via Yjs:",this.id),Q.titleNode)this.pageName=Q.titleNode,this.structure.renameNodeAndReload(this.id,Q.titleNode);return this.structure.project.idevices.loadApiIdevicesInPage(!0),{responseMessage:"OK"}}else throw Error("Failed to save properties via Yjs")}catch(Z){return console.error("[StructureNode] Yjs saveProperties error:",Z),eXeLearning.app.modals.alert.show({title:_("Structure node error"),body:_("An error occurred while saving page properties"),contentId:"error"}),!1}}loadPropertiesFromYjs(){if(!this.isYjsEnabled())return;let Z=eXeLearning.app.project._yjsBridge;if(!Z||!Z.structureBinding)return;let Y=Z.structureBinding.getPageProperties(this.id);if(Y){for(let[X,J]of Object.entries(Y))if(this.properties[X])if(typeof J==="boolean")this.properties[X].value=J?"true":"false";else this.properties[X].value=J;p.log("[StructureNode] Loaded properties from Yjs:",this.id)}}generateDataObject(Q){let Z=this.getDictBaseValuesData(),Y={};return Q.forEach((X)=>{Y[X]=Z[X]}),Y}getDictBaseValuesData(){return{odeNavStructureSyncId:this.id?this.id:null,odePageId:this.pageId,odeVersionId:eXeLearning.app.project.odeVersion,odeSessionId:eXeLearning.app.project.odeSession}}updateOrderByParam(Q){switch(Q){case"+":this.order++;break;case"-":this.order--;break;default:this.order=Q;break}}updateParam(Q,Z){switch(this[Q]=Z,Q){case"moving":let Y=this.getElement();if(Y)Y.setAttribute("moving",Z);break}}getElement(){return this.structure.menuStructureCompose.menuNav.querySelector(`.nav-element[nav-id="${this.id}"]`)}getPos(){for(let Q=0;Q<this.structure.data.length;Q++)if(this.structure.data[Q].id==this.id)return Q;return!1}showModalProperties(){this.loadPropertiesFromYjs(),eXeLearning.app.modals.properties.show({node:this,title:_("Page properties"),contentId:"page-properties",properties:this.properties})}}var E=window.AppLogger||console;class f0{constructor(Q){this.project=Q,this.data=null,this.dataJson=null,this.dataGroupByParent=null,this.nodeSelected=null,this.nodeContainer=document.querySelector("#main > #workarea > #node-content"),this.movingNode=!1,this._structureLoaded=!1}rootNodeData={id:"root",pageId:"root",pageName:"",icon:"edit_note",parent:null,order:1};isYjsEnabled(){return this.project?._yjsEnabled===!0}async loadData(){this.dataJson=await this.getOdeStructure(),this.processStructureData(this.dataJson)}async getOdeStructure(){if(this.isYjsEnabled()&&this.project._yjsBridge){let Q=this.project._yjsBridge,Z=Q.documentManager?.getNavigation();if(this.project._forceStructureImport===!0){if(E.log("[StructureEngine] Force import flag set - clearing Yjs and fetching from API..."),this.project._forceStructureImport=!1,Q.clearNavigation)Q.clearNavigation();let J=await this.fetchStructureFromApi();if(J&&J.length>0)Q.importStructure(J),E.log("[StructureEngine] Force imported",J.length,"pages into Yjs");return this.getStructureFromYjs()}if(Z&&Z.length>0)return E.log("[StructureEngine] Loading structure from Yjs (has data)"),this.getStructureFromYjs();E.log("[StructureEngine] Yjs empty, fetching from API and importing...");let X=await this.fetchStructureFromApi();if(X&&X.length>0)Q.importStructure(X),E.log("[StructureEngine] Imported",X.length,"pages into Yjs");return this.getStructureFromYjs()}return await this.fetchStructureFromApi()}async fetchStructureFromApi(){let Q=this.project.odeVersion,Z=this.project.odeSession,Y=await this.project.app.api.getOdeStructure(Q,Z);return Y.structure?Y.structure:[]}getStructureFromYjs(){let Q=this.project._yjsBridge;if(!Q||!Q.structureBinding)return console.warn("[StructureEngine] Yjs bridge not available"),[];let Z=Q.structureBinding,X=Z.getPages().map((J)=>{let z=Z.getBlocks(J.id).map((H)=>{let V=Z.getComponents(J.id,H.id).map((R)=>({odeComponentSyncId:R.id,odeIdeviceTypeName:R.ideviceType||R.type,htmlView:R.htmlContent||"",jsonProperties:R.jsonProperties||"{}",order:R.order,...R.properties}));return{blockId:H.id,blockName:H.blockName||H.name,order:H.order,odeComponentsSyncs:V}}),G=J.order;if(typeof G!=="number"||isNaN(G)||!isFinite(G))G=0;let q=null;if(J.properties&&typeof J.properties==="object"){q={};for(let[H,K]of Object.entries(J.properties))q[H]={value:K}}return{id:J.id,pageId:J.pageId||J.id,pageName:J.pageName,parent:J.parentId||"root",order:G,odePagStructureSyncs:z,odeNavStructureSyncProperties:q}});return E.log("[StructureEngine] Loaded",X.length,"pages from Yjs"),this._structureLoaded=!0,X}setDataFromYjs(Q){let Z=this.menuStructureBehaviour?.nodeSelected,Y=Z&&typeof Z.getAttribute==="function"?Z.getAttribute("nav-id"):null;if(this.dataJson=Q,this.processStructureData(this.dataJson),this.menuStructureCompose)this.reloadStructureMenu(Y)}async updateDataFromApi(){return this.dataJson=await this.getOdeStructure(),this.dataJson.forEach((Q)=>{let Z=this.getNode(Q.id);if(Z)Z.updateParam("order",Q.order),Z.updateParam("parent",Q.parent),Z.updateParam("moving",!1)}),this.movingNode=!1,this.data}subscribeToYjsChanges(){if(!this.isYjsEnabled()||!this.project._yjsBridge)return;if(this.project._yjsBridge.onStructureChange(async(Q,Z)=>{if(Z?.local!==!1){E.log("[StructureEngine] Skipping local change (local:",Z?.local,")");return}E.log("[StructureEngine] Yjs structure changed (remote), reloading...");let X=this.menuStructureBehaviour?.nodeSelected?.getAttribute("nav-id"),W=(X?this.getNode(X):null)?.parent||null,z=this.getStructureFromYjs();if(this.processStructureData(z),this.menuStructureCompose){this.menuStructureCompose.compose(),this.menuStructureBehaviour.behaviour(!1);let G=null;if(X&&this.getNode(X))await this.selectNode(X),G=X;else if(W&&this.getNode(W))await this.selectNode(W),G=W;else if(X)await this.selectFirst();if(G){let q=this.menuStructureBehaviour?.menuNav?.querySelector(`.nav-element[nav-id="${G}"]`);if(q)E.log("[StructureEngine] Forcing page content reload for remote changes"),await eXeLearning.app.project.idevices.loadApiIdevicesInPage(!1,q)}}}),!this.data||this.data.length===0){let Q=this.getStructureFromYjs();if(Q&&Q.length>0){if(E.log(`[StructureEngine] Loading initial ${Q.length} pages from Yjs`),this.processStructureData(Q),this.menuStructureCompose)this.menuStructureCompose.compose(),this.menuStructureBehaviour.behaviour(!1),this.menuStructureBehaviour.selectFirst()}}else E.log(`[StructureEngine] Structure already loaded (${this.data.length} pages), skipping reload`);E.log("[StructureEngine] Subscribed to Yjs changes")}async resetStructureData(Q){if(E.log("[StructureEngine] resetStructureData called with idSelect:",Q),this.isYjsEnabled()){let Y=this.getStructureFromYjs();this.processStructureData(Y),this.openNode(Q),E.log("[StructureEngine] About to call reloadStructureMenu with:",Q),await this.reloadStructureMenu(Q),E.log("[StructureEngine] reloadStructureMenu completed");return}let Z=await this.updateDataFromApi();this.data=this.orderStructureData(Z),this.openNode(Q),await this.reloadStructureMenu(Q)}async resetDataAndStructureData(Q){if(this.isYjsEnabled()){let Y=this.getStructureFromYjs();this.processStructureData(Y),this.openNode(Q),await this.reloadStructureMenu(Q);return}this.loadData();let Z=await this.updateDataFromApi();this.data=this.orderStructureData(Z),this.openNode(Q),await this.reloadStructureMenu(Q)}async reloadStructureMenu(Q){if(E.log("[StructureEngine] reloadStructureMenu called with:",Q),this.menuStructureCompose.compose(),this.menuStructureBehaviour.behaviour(!1),Q)E.log("[StructureEngine] Calling selectNode with:",Q),await this.selectNode(Q),E.log("[StructureEngine] selectNode completed");else await this.selectFirst()}processStructureData(Q){let Z=[],Y=eXeLearning.app.project.properties.properties.pp_title.value,X=new l(this,this.rootNodeData);X.pageName=Y?Y:_("Untitled document"),X.icon=this.rootNodeData.icon,Z.push(X),Q.forEach((J)=>{let W=new l(this,J);Z.push(W)}),Z=this.orderStructureData(Z),Z=this.addOpenParamToStructureData(Z),this.data=Z}addParentRootToData(Q){return Q.forEach((Z)=>{if(Z.id!="root"&&Z.parent==null)Z.parent="root"}),Q}setTitleToNodeRoot(){let Q=eXeLearning.app.project.properties.properties.pp_title.value,Z=this.data[0];Z.pageName=Q?Q:_("Untitled document");let Y=this.menuNav?.querySelector('.nav-element[nav-id="root"] .node-text');if(Y)Y.textContent=Z.pageName}orderStructureData(Q){Q=this.addParentRootToData(Q),this.dataGroupByParent=this.groupDataByParent(Q),this.setIndexToStructureData();let Z=[],Y=[null];while(Y.length>0){let X=Y.pop(),J=this.dataGroupByParent[X];if(!J||!Array.isArray(J.children))continue;J.children.forEach((W)=>{if(!W||!W.id)return;Z.push(W),Y.push(W.id)})}return Z}groupDataByParent(Q){if(!Array.isArray(Q))return console.warn("[StructureEngine] groupDataByParent: Invalid data (not an array)"),{null:{children:[]},root:{children:[]}};let Z={null:{children:[]},root:{children:[]}},Y=[null,"root"],X=new Set;while(Y.length>0){let J=Y.pop();Q.forEach((W)=>{if(!W||!W.id)return;if(X.has(W.id))return;if((W.parent==="root"?"root":W.parent||null)==J){X.add(W.id);let G=Z[W.id]?.children||[];if(Z[W.id]=W,Z[W.id].children=G,!Z[J])Z[J]={children:[]};Z[J].children.push(W),Z[J].children.sort(this.compareNodesSort),Y.push(W.id)}})}return Z}setIndexToStructureData(){let Q="root",Z=[0];this.setIndexToChildrenNodesRecursive(this.dataGroupByParent[Q].children,Z)}setIndexToChildrenNodesRecursive(Q,Z){Q.forEach((Y)=>{if(Z[Z.length-1]++,Y.index=Z.join("."),Y.deep=Z.length-1,Y.children.length>0)Z.push(0),this.setIndexToChildrenNodesRecursive(Y.children,Z)}),Z.pop()}addOpenParamToStructureData(Q){return Q.forEach((Z)=>{if(Z.children.length>0){if(Z.open==null)Z.open=!0}else Z.open=null}),Q}compareNodesSort(Q,Z){let Y=typeof Q?.order==="number"&&isFinite(Q.order)?Q.order:0,X=typeof Z?.order==="number"&&isFinite(Z.order)?Z.order:0;if(Y<X)return-1;if(Y>X)return 1;return 0}getYjsBinding(){return this.project._yjsBridge?.structureBinding||null}moveNodePrev(Q){if(this.getYjsBinding()?.movePagePrev(Q))this.resetStructureData(Q)}moveNodeNext(Q){if(this.getYjsBinding()?.movePageNext(Q))this.resetStructureData(Q)}moveNodeUp(Q){if(this.getYjsBinding()?.movePageLeft(Q))this.resetStructureData(Q)}moveNodeDown(Q){if(this.getYjsBinding()?.movePageRight(Q))this.resetStructureData(Q)}moveNodeToNode(Q,Z){if(this.getYjsBinding()?.movePageToTarget(Q,Z))this.resetStructureData(Q)}getPosNode(Q){for(let Z=0;Z<this.data.length;Z++)if(this.data[Z].id==Q)return Z;return!1}createNodeAndReload(Q,Z){E.log("[StructureEngine] createNodeAndReload called, parentId:",Q,"title:",Z),this.createNode(Q,Z).then((Y)=>{if(E.log("[StructureEngine] createNode response:",Y),Y&&Y.responseMessage=="OK")E.log("[StructureEngine] Calling resetStructureData with ID:",Y.odeNavStructureSyncId),this.resetStructureData(Y.odeNavStructureSyncId)}).catch((Y)=>{console.error("[StructureEngine] Error creating node:",Y)})}async createNode(Q,Z){let X={pageId:this.generateNodeId(),pageName:Z,parent:Q,order:-1};return await new l(this,X).create()}async cloneNodeAndReload(Q){let Z=await this.cloneNode(Q);await this.resetStructureData(Z.id)}async cloneNode(Q){let Z=await this.getNode(Q).clone(),Y=new l(this,Z.odeNavStructureSync);return this.data.push(Y),Y}async cloneNodeNav(Q){let Z=new l(this,Q);return this.data.push(Z),Z}updateNodesStructure(Q,Z){for(let[Y,X]of Object.entries(Q)){let J=this.getNode(X.id);if(J)Z.forEach((W)=>{J.updateParam(W,X[W])})}}renameNodeAndReload(Q,Z){this.renameNode(Q,Z),this.resetStructureData(Q)}renameNode(Q,Z){this.getNode(Q).rename(Z)}removeNodeCompleteAndReload(Q){if(!Q)return;let Z=this.getNode(Q);if(Z&&typeof Z.remove==="function")this.removeNode(Q);this.resetStructureData(!1)}removeNode(Q){let Z=this.getNode(Q);if(!Z||typeof Z.remove!=="function")return!1;return Z.remove(),!0}removeNodes(Q){Q.forEach((Z)=>{let Y=this.getNode(Z);if(Y&&typeof Y.remove==="function")Y.remove()})}removeChildren(Q){this.data=this.data.filter((Z,Y,X)=>{return Z.parent!=Q})}removeDecendents(Q){let Y=this.getDecendents(Q).map((X)=>{return X.id});this.removeNodes(Y)}cleanOrphans(){var Q=!0;while(Q){Q=!1;for(let Z=0;Z<this.data.length;Z++)if(this.data[Z].parent!=null&&!this.hasChildren(this.data[Z].parent))Q=!0,this.removeNode(this.data[Z].id)}}hasChildren(Q){for(let Z=0;Z<this.data.length;Z++)if(this.data[Z].id==Q)return!0;return!1}openNode(Q){if(Q){var Z=this.getAncestors(Q);this.data.forEach((Y)=>{if(Y.children.length>0&&Z.includes(Y.id))Y.open=!0})}}getNode(Q){for(let Z=0;Z<this.data.length;Z++)if(this.data[Z].id==Q)return this.data[Z]}getChildren(Q,Z){let Y=this.getNode(Q),X=Z?{}:[];return this.data.forEach((J)=>{if(J.parent==Q)if(Z)X[J.id]=J;else X.push(J)}),X}getDecendents(Q){var Z=[Q],Y=[];while(Z.length>0){let X=Z.pop();this.getChildren(X).forEach((W)=>{Y.push(W),Z.push(W.id)})}return Y}getAncestors(Q){var Z=[],Y=this.getNode(Q);if(Y){Z.push(Y.parent);while(Z[Z.length-1]){let X=Z[Z.length-1],J=this.getNode(X);if(!J)break;Z.push(J.parent)}}return Z}getAllNodesOrderByView(){return this.nodesOrderByView=[],this.menuStructureCompose.menuNavList.querySelectorAll(".nav-element").forEach((Z)=>{let Y=this.getNode(Z.getAttribute("nav-id"));if(Y&&Y.id!=="root")this.nodesOrderByView.push(Y)}),this.nodesOrderByView}getPosInNodesOrderByView(Q){if(!Array.isArray(this.nodesOrderByView))return!1;for(let Z=0;Z<this.nodesOrderByView.length;Z++){let Y=this.nodesOrderByView[Z];if(Y&&Y.id===Q)return Z}return!1}getNodeElement(Q){return this.menuStructureCompose.menuNav.querySelector(`.nav-element[nav-id="${Q}"]`)}async selectNode(Q){E.log("[StructureEngine] selectNode called with id:",Q);let Z=this.getNodeElement(Q);if(E.log("[StructureEngine] getNodeElement returned:",Z?"FOUND":"NOT FOUND",Z),Z)E.log("[StructureEngine] Calling menuStructureBehaviour.selectNode..."),await this.menuStructureBehaviour.selectNode(Z),E.log("[StructureEngine] menuStructureBehaviour.selectNode completed");else console.warn(`[StructureEngine] Node ${Q} not found in DOM, selecting first`),await this.selectFirst()}async selectFirst(){await this.menuStructureBehaviour.selectFirst()}getSelectNodeNavId(){let Q=this.getSelectedNode();return Q?Q.id:null}getSelectNodePageId(){let Q=this.getSelectedNode();return Q?Q.pageId:null}getSelectedNode(){if(this.menuStructureBehaviour.nodeSelected)return this.getNode(this.menuStructureBehaviour.nodeSelected.getAttribute("nav-id"));else return!1}generateNodeId(){return this.project.app.common.generateId()}}var w=window.AppLogger||console;class k0{constructor(Q){this.app=Q,this.properties=new P0(this),this.idevices=new C0(this),this.structure=new f0(this),this.offlineInstallation=eXeLearning.config.isOfflineInstallation,this.clientIntervalUpdate=eXeLearning.config.clientIntervalUpdate,this.syncIntervalTime=250,this.activeLocks=new Map,this._yjsEnabled=!1,this._yjsBridge=null,this._yjsBindings=new Map}async load(){if(w.log("public/app/workarea/project/projectManager.js: load"),await this.loadCurrentProject(),await this.loadProjectProperties(),this.app.locale.loadContentTranslationsStrings(this.properties.properties.pp_lang.value),await this.loadInterface(),await this.initializeYjs(),this.app.interface?.shareButton)this.app.interface.shareButton.loadVisibilityFromProject();if(await this.loadStructureData(),this._yjsEnabled&&this.structure)this.structure.subscribeToYjsChanges();if(await this.loadMenus(),await this.loadModalsContent(),this.ideviceEngineBehaviour(),this.compatibilityLegacy(),await this.initialiceProject(),this.showScreen(),!this.app?.capabilities?.storage?.remote&&window.__pendingImportFile){w.log("[ProjectManager] Found pending import file, importing...");let Z=window.__pendingImportFile;window.__pendingImportFile=null,this.importElp(Z).catch((Y)=>{console.error("[ProjectManager] Failed to import pending file:",Y)})}if(this.setInstallationTypeAttribute(),!this._yjsEnabled)this.generateIntervalAutosave();if(this.cleanPreviousAutosaves(),!this.offlineInstallation)await this.subscribeToSessionAndNotify()}async initializeYjs(){if(!window.YjsLoader&&!window.YjsModules){w.log("[ProjectManager] Yjs not available, using legacy mode");return}try{if(window.YjsLoader&&!window.YjsModules?.YjsProjectBridge)w.log("[ProjectManager] Loading Yjs modules..."),await window.YjsLoader.load();if(window.YjsProjectManagerMixin&&!this.enableYjsMode)window.YjsProjectManagerMixin.applyMixin(this);let Q=this.app?.auth?.getToken?.()||eXeLearning?.config?.token||localStorage.getItem("authToken"),Z=this.offlineInstallation===!0;if(Z)w.log("[ProjectManager] Yjs local-only mode (offline installation)");else w.log("[ProjectManager] Yjs collaborative mode (WebSocket + IndexedDB)");let Y=this.yjsProjectId||window.eXeLearning?.projectId;if(!Y){console.error("[ProjectManager] No project ID available - this should not happen"),console.error("[ProjectManager] Make sure to access workarea via /workarea?project=<id>");return}this.yjsProjectId=Y;let J=new URLSearchParams(window.location.search).get("new")==="1";if(this.enableYjsMode){if(w.log("[ProjectManager] Enabling Yjs mode for project:",Y,J?"(new)":"(existing)"),await this.enableYjsMode(Y,Q,{treeContainerId:"structure-menu-nav",enableWebSocket:!Z,enableIndexedDB:!0,offline:Z,isNewProject:J}),w.log("[ProjectManager] Yjs collaborative editing enabled"),J){let z=new URLSearchParams(window.location.search).get("jwt_token"),G=window.location.pathname+"?project="+Y;if(z)G+="&jwt_token="+encodeURIComponent(z);window.history.replaceState({},"",G)}await this.checkAndImportElp()}}catch(Q){console.warn("[ProjectManager] Failed to initialize Yjs:",Q)}}async reinitializeWithProject(Q,Z={}){if(w.log("[ProjectManager] Reinitializing with new project:",Q),this._yjsBridge){w.log("[ProjectManager] Disconnecting existing Yjs bridge...");try{await this._yjsBridge.disconnect()}catch(W){console.warn("[ProjectManager] Error disconnecting Yjs:",W)}this._yjsBridge=null}this._yjsBindings.clear(),this.yjsProjectId=Q,window.eXeLearning.projectId=Q,this.odeId=Q;let Y=window.YjsModules?.YjsProjectBridge;if(!Y)throw Error("YjsProjectBridge not available");let X=this.app?.auth?.getToken?.()||eXeLearning?.config?.token||localStorage.getItem("authToken"),J=this.offlineInstallation===!0;this._yjsBridge=new Y(this.app),await this._yjsBridge.initialize(Q,X,{enableWebSocket:!J,enableIndexedDB:!0,offline:J,isNewProject:Z.isNewProject,skipSyncWait:Z.skipSyncWait??!1}),this._yjsEnabled=!0,w.log("[ProjectManager] Yjs reinitialized for project:",Q),w.log("[ProjectManager] About to call resetProject..."),this.resetProject(),w.log("[ProjectManager] resetProject completed, reinitializeWithProject returning")}async importElpDirectly(Q,Z={}){if(w.log("[ProjectManager] Importing ELP directly from memory:",Q.name),!this._yjsBridge)throw Error("Yjs bridge not initialized");let Y=await this.importFromElpxViaYjs(Q,Z);w.log("[ProjectManager] Direct import complete:",Y);try{await this._yjsBridge.documentManager.saveToServer(),w.log("[ProjectManager] Document saved to server after direct import")}catch(X){console.warn("[ProjectManager] Failed to save to server:",X)}return Y}async refreshAfterDirectImport(){if(w.log("[ProjectManager] Refreshing UI after direct import..."),eXeLearning.app.modals.openuserodefiles.close(),this.structure){if(this.structure.isYjsEnabled&&this.structure.isYjsEnabled()){let Q=this.structure.getStructureFromYjs();w.log("[ProjectManager] Structure data from Yjs:",Q?.length,"pages"),this.structure.processStructureData(Q)}await this.structure.reloadStructureMenu()}if(this.app?.interface?.odeTitleElement)this.app.interface.odeTitleElement.setTitle();if(this.properties)this.properties.loadPropertiesFromYjs();await this.initialiceProject(),this.showScreen(),w.log("[ProjectManager] UI refreshed after direct import")}async checkAndImportElp(){let Z=new URLSearchParams(window.location.search).get("import");if(!Z){w.log("[ProjectManager] No import parameter found");return}w.log("[ProjectManager] Import parameter detected:",Z);try{if(this.app?.modals?.loader)this.app.modals.loader.show({message:_("Importing project...")});let Y=window.eXeLearning?.config?.basePath||"",X=Z.startsWith("/")&&Y&&!Z.startsWith(Y)?`${Y}${Z}`:Z,J=await fetch(X);if(!J.ok)throw Error(`Failed to fetch ELP file: ${J.statusText}`);let W=await J.blob(),z=Z.split("/").pop()||"imported.elp",G=new File([W],z,{type:"application/octet-stream"});w.log("[ProjectManager] ELP file fetched, size:",G.size);let q=await this.importFromElpxViaYjs(G);w.log("[ProjectManager] ELP import complete:",q);try{await this._yjsBridge.documentManager.saveToServer(),w.log("[ProjectManager] Document saved to server after import")}catch(K){console.warn("[ProjectManager] Failed to save to server after import:",K)}let H=new URL(window.location);H.searchParams.delete("import"),window.history.replaceState({},"",H);try{await fetch(`${Y}/api/project/cleanup-import?path=${encodeURIComponent(Z)}`,{method:"DELETE"})}catch(K){console.warn("[ProjectManager] Failed to cleanup temp file:",K)}if(this.app?.modals?.loader)this.app.modals.loader.hide();if(q.pages>0)w.log(`[ProjectManager] Successfully imported ${q.pages} pages, ${q.blocks} blocks, ${q.components} components`)}catch(Y){if(console.error("[ProjectManager] Failed to import ELP:",Y),this.app?.modals?.loader)this.app.modals.loader.hide();if(this.app?.modals?.alert)this.app.modals.alert.show({title:_("Import Error"),body:_("Failed to import the project: ")+Y.message,contentId:"error"})}}generateProjectId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(Q){let Z=Math.random()*16|0;return(Q==="x"?Z:Z&3|8).toString(16)})}updateUrlWithProjectId(Q){let Z=new URL(window.location);Z.searchParams.set("project",Q),window.history.replaceState({},"",Z)}getNumericProjectId(){if(!this.odeSession)return null;let Q=0;for(let Z=0;Z<this.odeSession.length;Z++){let Y=this.odeSession.charCodeAt(Z);Q=(Q<<5)-Q+Y,Q=Q&Q}return Math.abs(Q)}resetProject(){if(w.log("[ProjectManager] Resetting project - clearing all previous state"),this._forceStructureImport=!0,this._yjsBridge?.clearNavigation)w.log("[ProjectManager] Clearing Yjs navigation..."),this._yjsBridge.clearNavigation();if(w.log("[ProjectManager] Resetting projectState..."),window.eXeLearning?.app?.projectState)window.eXeLearning.app.projectState.reset();w.log("[ProjectManager] ProjectState reset done");let Q=document.querySelector("#structure-menu-nav");if(Q)w.log("[ProjectManager] Clearing navigation tree DOM..."),Q.innerHTML="";if(this.app.menus?.menuStructure?.menuStructureCompose?.structureEngine)try{this.app.menus.menuStructure.menuStructureCompose.structureEngine.resetDataAndStructureData("reset")}catch(X){console.warn("[ProjectManager] Error resetting structure menu:",X)}if(this.app.menus?.menuStructure?.menuStructureBehaviour)this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected=!1;let Z=document.querySelector("#exe-content-area");if(Z)w.log("[ProjectManager] Clearing content area..."),Z.innerHTML="";let Y=document.querySelector("#exe-idevice-panels");if(Y)w.log("[ProjectManager] Clearing iDevice panels..."),Y.innerHTML="";if(this.properties?.formProperties)this.properties.formProperties.remove();w.log("[ProjectManager] ✓ Project reset complete - ready for new content")}async openLoad(){if(w.log("public/app/workarea/project/projectManager.js:openLoad"),this.resetProject(),eXeLearning.app.modals.openuserodefiles.close(),await this.loadUser(),this.app.interface.loadingScreen.show(),await this.loadProjectProperties(),await this.loadStructureData(),this.app.interface.odeTitleElement.setTitle(),this.properties.formProperties.remove(),this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected=!1,await this.structure.reloadStructureMenu(),await this.loadModalsContent(),await this.initialiceProject(),this.showScreen(),this.setInstallationTypeAttribute(),this.generateIntervalAutosave(!0),!this.offlineInstallation)await this.subscribeToSessionAndNotify()}async updateUserPage(Q,Z=!1){let Y=document.querySelector(".template-page"),X;if(Y!==null)X=document.querySelector(".template-page").scrollTop;else X=document.querySelector("#node-content-container").scrollTop;if(await this.loadStructureData(),await this.loadModalsContent(),Z)this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected=!1;if(await this.structure.reloadStructureMenu(Q),await this.initialiceProject(),Y!==null)document.querySelector(".template-page").scrollTo(0,X);else document.querySelector("#node-content-container").scrollTo(0,X)}cleanupCurrentIdeviceTimer(){if(this.idevices?.cleanupCurrentIdeviceTimer)return this.idevices.cleanupCurrentIdeviceTimer()}getTimeIdeviceEditing(){if(this.idevices?.getTimeIdeviceEditing)return this.idevices.getTimeIdeviceEditing()}getEditUnlockDevice(){if(this.idevices?.getEditUnlockDevice)return this.idevices.getEditUnlockDevice()}lockPageContent(Q,Z,Y){let X=document.querySelector(`[node-selected="${Z}"]`);if(!X)return!1;if(getComputedStyle(X).position==="static")X.style.position="relative";let J=document.createElement("div"),W=document.createElement("div"),z=document.createElement("div"),G=document.createElement("div"),q=document.createElement("div");J.className="user-editing-overlay",W.className="user-editing-message",z.className="user-editing-description",G.className="user-editing-email",q.className="user-editing-time",z.textContent=_("This page is being edited by:"),G.textContent=Q;let H=new Date(Number(Y)),K=String(H.getHours()).padStart(2,"0"),V=String(H.getMinutes()).padStart(2,"0"),R=String(H.getSeconds()).padStart(2,"0");return q.textContent=`${_("at")} ${K}:${V}:${R}`,W.appendChild(z),W.appendChild(G),W.appendChild(q),J.appendChild(W),X.prepend(J),X.classList.add("editing-article","article-disabled"),this.lockIdevices(),!0}collaborativePageLock(Q,Z,Y,X=null){this.clearUserLocks(Q);let J=X;if(!J){let K=this.activeLocks.get(Z);if(K&&K.user===Q)J=K.lockTime}let W=document.querySelector(`[page-id="${Z}"]`);if(!W)return;let z=W.querySelectorAll(":scope > button, :scope > .nav-element-text");if(Y==="page")z.forEach((K)=>{K.disabled=!0,K.style.cursor="not-allowed",K.style.opacity="0.5",K.setAttribute("title",_("This page is being edited by:")+` ${Q}`);let V=K.querySelector(".node-menu-button");V.style.cursor="not-allowed",V.style.pointerEvents="none"});let G=eXeLearning.app.interface.concurrentUsers.getConcurrentUsersElementsList(),q=W.querySelector(".drag-over-border"),H=Array.from(G).find((K)=>K.dataset.username.toLowerCase()===Q.toLowerCase());if(H.classList.add("user-inpage"),H.querySelector(".username").remove(),q&&H){let K=H.cloneNode(!0);K.querySelector(".exe-gravatar").setAttribute("height","30px"),K.querySelector(".exe-gravatar").setAttribute("width","30px"),q.appendChild(K),this.activeLocks.set(Z,{user:Q,gravatar:K,originalGravatar:H,lockTime:X})}if(Y==="page")this.lockPageContent(Q,Z,X)}clearUserLocks(Q){this.unlockIdevices();for(let[Z,Y]of this.activeLocks.entries())if(Y.user===Q)this.clearPageLock(Z)}lockIdevices(){let Q=document.querySelector("#idevices-bottom");Q.classList.add("disabled"),Q.querySelectorAll(".idevice_item").forEach((Y)=>{Y.setAttribute("tabindex","-1"),Y.addEventListener("keydown",(X)=>X.preventDefault())}),document.querySelector("#list_menu_idevices").classList.add("disabled"),Q.querySelectorAll(".idevice_category").forEach((Y)=>{Y.setAttribute("tabindex","-1"),Y.addEventListener("keydown",(X)=>X.preventDefault())})}unlockIdevices(){let Q=document.querySelector("#idevices-bottom");Q.classList.remove("disabled"),Q.querySelectorAll(".idevice_item").forEach((Y)=>{Y.removeAttribute("tabindex"),Y.removeEventListener("keydown",(X)=>X.preventDefault())}),document.querySelector("#list_menu_idevices").classList.remove("disabled"),Q.querySelectorAll(".idevice_category").forEach((Y)=>{Y.removeAttribute("tabindex"),Y.removeEventListener("keydown",(X)=>X.preventDefault())})}clearPageLock(Q){this.unlockIdevices();let Z=this.activeLocks.get(Q);if(!Z)return;let{user:Y,gravatar:X}=Z,J=document.querySelector(`[page-id="${Q}"]`);if(J){J.removeAttribute("title"),J.querySelectorAll(":scope > button, :scope > .nav-element-text").forEach((G)=>{G.disabled=!1,G.style.cursor="inherit",G.style.opacity="1",G.setAttribute("title",G.querySelector(".node-text-span").textContent);let q=G.querySelector(".node-menu-button");q.style.cursor="inherit",q.style.pointerEvents="auto"});let z=J.querySelector(".drag-over-border");if(z&&X&&z.contains(X))z.removeChild(X)}this.activeLocks.delete(Q)}handleBlockEditingOverlay(Q,Z){let Y={};Q.split(",").forEach((B)=>{let[P,S]=B.split(":");Y[P]=S});let X=Y.user,J=(X&&X!==Z)??!1,W=Y.pageId??"",z=Y.actionType??"",G=Y.collaborativeMode??"",q=["FORCE_UNLOCK","HIDE_UNLOCK_BUTTON"],H=Y.odeComponentFlag==="true",K=q.some((B)=>z?.includes(B)),V=z?.includes("EDIT")||K||H;if(!W)return;let R=Y.blockId,O;if(G==="page")O=document.getElementById(R)?.parentElement;else O=document.getElementById(R);let A=O?.querySelector(".user-editing-overlay")??null;if(V&&J){let P=this.idevices?.ideviceActive?.timeIdeviceEditing??this.getTimeIdeviceEditing();this.collaborativePageLock(X,W,G,P)}else if(z==="UNDO_IDEVICE"){if(this.clearPageLock(W),A)O.classList.remove("editing-article","article-disabled"),A.remove()}if(z==="collaborative-page-lock"&&G==="page"){if(X&&X!==Z)this.collaborativePageLock(X,W,G);return}if(z==="SAVE_BLOCK")this.clearPageLock(W);if(!R||R==="none"||!O||X===Z)return;let{elementId:M,odeIdeviceId:F}=Y,U=Y.timeIdeviceEditing??0,L=document.getElementById("saveIdevice"+F)??null,D=document.querySelectorAll('[class*="article-disabled"]');if(A)O.classList.remove("editing-article","article-disabled"),A.remove();if(!D.length&&z==="DELETE"&&J&&W)this.updateUserPage(W,!0);if(z==="SAVE_STOP"&&W){this.updateUserPage(W,!0);return}if(!document.querySelectorAll('[id^="saveIdevice"]').length>0&&D.length===1&&z==="SAVE_BLOCK"&&J&&W){w.log(`
                odeElementSave: ${L}
                disabledElements.length; ${D.length}
                isOdeComponentFlag: ${H}
                isNotSameEmail: ${J}
                odeIdeviceId: ${F}
                actionType: ${z}
                pageId: ${W}
            `),this.updateUserPage(W,!0);return}if(z==="UNLOCK_RESOURCE"&&J)this.cleanupCurrentIdeviceTimer(),L.click();if(z==="LOADING"&&J&&L){let P=this.idevices?.ideviceActive?.timeIdeviceEditing??this.getTimeIdeviceEditing(),k=this.idevices?.ideviceActive?.editUnlockDevice??"EDIT";setTimeout(()=>{this.app.api.postEditIdevice({odeSessionId:this.odeSession,odeNavStructureSyncId:this.app.project.structure.nodeSelected.getAttribute("nav-id"),blockId:R,odeIdeviceId:F,actionType:k,odeComponentFlag:!0,timeIdeviceEditing:P})},1000)}if(V&&J){if(K){let B=document.createElement("button");B.id=`unlock-btn-${M}`,B.className="user-editing-unlock-btn",B.textContent=_("Force Unlock"),B.style.display="block",messageBox.appendChild(B),B.onclick=()=>this.unlockResource(R,F)}}if(z?.includes("HIDE_UNLOCK_BUTTON")){let B=`unlock-btn-${M}`,P=document.getElementById(B);if(P)P.remove()}}unlockResource(Q,Z){this.app.api.postEditIdevice({odeSessionId:this.odeSession,odeNavStructureSyncId:this.app.project.structure.nodeSelected.getAttribute("nav-id"),blockId:Q,odeIdeviceId:Z,actionType:"UNLOCK_RESOURCE",odeComponentFlag:!1,timeIdeviceEditing:null}).then((Y)=>{if(Y.responseMessage==="OK")this.showUnlockSuccess()}).catch((Y)=>{if(Y.status===423&&Y.data.forceUnlockAvailable)this.showForceUnlockOption()})}async subscribeToSessionAndNotify(){}async saveMenuHeadButton(Q){let Z=document.querySelector("#head-top-save-button");if(!Z)return;Z.disabled=Q}async reloadStructure(){let Q=this.structure.getSelectNodeNavId(),Z=await this.structure.resetDataAndStructureData(Q);return await this.checkUserUpdateFlag(Z)}async loadCurrentProject(){w.log("public/app/workarea/project/projectManager.js:loadCurrentProject");let Q=window.eXeLearning?.projectId;if(!Q)throw Error("[ProjectManager] No project ID in URL. Backend should always provide a project ID.");w.log(`[ProjectManager] Using project ID from URL: ${Q}`),this.yjsProjectId=Q,this.odeSession=`yjs-${Q}`,this.odeId=Q,this.odeVersion="1"}async loadPlatformProject(Q){let Z=eXeLearning.user.odePlatformId,X=new URLSearchParams(window.location.search).get("jwt_token"),J={odePlatformId:Z,odeSessionId:Q,platformUrlGet:eXeLearning.config.platformUrlGet,jwt_token:X},W;if(W=await this.app.api.platformIntegrationOpenElp(J),W.responseMessage=="OK"){let z={odeFileName:W.elpFileName,odeFilePath:W.elpFilePath,forceCloseOdeUserPreviousSession:W.forceCloseOdeUserPreviousSession};if(W=await this.app.api.postLocalOdeFile(z),W.responseMessage=="OK")this.app.project.odeSession=W.odeSessionId,this.app.project.odeVersion=W.odeVersionId,this.app.project.odeId=W.odeId,this.odeSession=W.odeSessionId,window.location.replace("workarea?jwt_token="+X)}}async newSession(Q){let Z={odeSessionId:Q};this.createSession(Z)}async createSession(Q){await this.app.api.postCloseSession(Q).then((Z)=>{if(Z.responseMessage=="OK")this.app.project.loadCurrentProject(),this.app.project.openLoad()})}async loadProjectProperties(){await this.properties.load()}async loadInterface(){await this.app.interface.load()}async loadUser(){await this.app.user.loadUserPreferences()}async loadStructureData(){this.idevices.components={blocks:[],idevices:[]},await this.structure.loadData()}async loadMenus(){await this.app.menus.load()}async loadModalsContent(){await this.app.modals.releasenotes.load(),await this.app.modals.legalnotes.load()}async ideviceEngineBehaviour(){this.idevices.behaviour()}async compatibilityLegacy(){window.eXe={},window.eXe.app={},window.eXe.app.isInExe=()=>{return!0},window.eXe.app.getProjectProperties=()=>{return this.properties.loadPropertiesFromYjs(),this.properties.properties},window.eXe.app.getIdeviceActive=()=>this.idevices.getIdeviceActive(),window.eXe.app.getIdeviceById=(Q)=>this.idevices.getIdeviceById(Q),window.eXe.app.getIdeviceInstalled=(Q)=>this.app.idevices.getIdeviceInstalled(Q),window.eXe.app.getIdeviceInstalledEditionPath=(Q)=>this.app.idevices.getIdeviceInstalledEditionPath(Q),window.eXe.app.getIdeviceInstalledExportPath=(Q)=>this.app.idevices.getIdeviceInstalledExportPath(Q),window.eXe.app.alert=(Q,Z)=>this.app.modals.alert.show({body:Q,title:Z?Z:_("Alert")}),window.eXe.app.confirm=(Q,Z,Y)=>this.app.modals.confirm.show({title:Q,body:Z,confirmExec:Y}),window.eXe.app.loadScript=(Q,Z)=>this.idevices.loadScript(Q,Z),window.eXe.app.uploadFile=(Q,Z)=>this.idevices.ideviceActive.apiUploadFile(Q,Z),window.eXe.app.uploadLargeFile=(Q)=>this.idevices.ideviceActive.apiUploadLargeFile(Q)}async initialiceProject(){if(!this._yjsEnabled||!this.app.themes.selected){let Q=eXeLearning.config.defaultTheme;if(this.app.user.preferences.preferences.theme)Q=this.app.user.preferences.preferences.theme.value;await this.app.themes.selectTheme(Q,!1)}await this.lastNodeSelected()}async lastNodeSelected(){await this.app.selectFirstNodeStructure()}async showScreen(){setTimeout(()=>{this.app.interface.loadingScreen.hide()},250)}setInstallationTypeAttribute(){let Q=this.app.runtimeConfig,Z;if(Q?.isStaticMode())Z="static";else if(Q?.isElectronMode())Z="electron";else if(this.offlineInstallation===!0)Z="electron";else Z="online";if(document.querySelector("body").setAttribute("installation-type",Z),Z==="electron"||Z==="static"){if(document.querySelector("#head-top-download-button").innerHTML="save",document.querySelector("#head-top-download-button").setAttribute("title",_("Save")),Z==="electron")try{window.__currentProjectId=this.odeId||"default"}catch(Y){}}}async save(){let Q={title:_("Save"),body:_("Saving the project..."),icon:"downloading"},Z=this.app.toasts.createToast(Q);try{if(this._yjsEnabled&&this._yjsBridge){let Y=this._yjsBridge.getDocumentManager();if(Y){let X=await Y.save();if(X.success)this.app.interface.connectionTime.loadLasUpdatedInInterface(),Z.toastBody.innerHTML=_("Project saved."),w.log("[ProjectManager] Yjs document saved:",X.message);else Z.toastBody.innerHTML=_("An error occurred while saving the project."),Z.toastBody.classList.add("error"),console.error("[ProjectManager] Yjs save failed:",X.message)}else Z.toastBody.innerHTML=_("An error occurred while saving the project."),Z.toastBody.classList.add("error"),console.error("[ProjectManager] Yjs document manager not available")}else{let Y={odeSessionId:this.odeSession,odeVersion:this.odeVersion,odeId:this.odeId},X=await this.app.api.postOdeSave(Y);if(X&&X.responseMessage=="OK")this.app.interface.connectionTime.loadLasUpdatedInInterface(),Z.toastBody.innerHTML=_("Project saved.");else this.showModalSaveError(X),Z.toastBody.innerHTML=_("An error occurred while saving the project."),Z.toastBody.classList.add("error")}}catch(Y){console.error("[ProjectManager] Save error:",Y),Z.toastBody.innerHTML=_("An error occurred while saving the project."),Z.toastBody.classList.add("error")}setTimeout(()=>{Z.remove()},1500)}showModalSaveOk(Q){this.app.modals.alert.show({title:_("Saved"),body:_("The project has been saved.")})}showModalSaveError(Q){let Z=_("Error while saving: ${response.responseMessage}");Z=Z.replace("${response.responseMessage}",Q.responseMessage),this.app.modals.alert.show({title:_("Error"),body:_(Z),contentId:"error"})}async generateIntervalAutosave(Q){if(this.app.api.parameters.autosaveOdeFilesFunction){if(Q)clearInterval(this.intervalSaveOde);let Z={odeSessionId:this.odeSession,odeVersion:this.odeVersion,odeId:this.odeId};this.intervalSaveOde=setInterval(()=>{this.app.api.postOdeAutosave(Z)},this.app.api.parameters.autosaveIntervalTime*1000)}}async generateIntervalSessionExpiration(Q){if(this.app.api.parameters.autosaveOdeFilesFunction){if(Q)clearInterval(this.intervalSaveOde);let Z={odeSessionId:this.odeSession,odeVersion:this.odeVersion,odeId:this.odeId};this.intervalSaveOde=setInterval(()=>{this.app.api.renewSession()},1e4)}}async generateIntervalCheckOdeUpdates(){if(this.offlineInstallation!==!0)setInterval(()=>{let Q=this.odeId,Z=this.odeVersion,Y=this.odeSession,X=!0,J=document.querySelectorAll(".idevice-element-in-content"),W=document.querySelectorAll(".dragging"),z=this.structure.getSelectNodeNavId();if(X=this.checkUsersInSession(Q,Z,Y,X),X=this.checkModeEdition(J,X),X=this.checkDraggingElement(W,X),X)this.checkUserUpdateFlag(z)},this.clientIntervalUpdate)}async replaceOdeComponent(Q,Z=!1){let Y,X,J,q=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content").querySelector(".idevice_node[mode='edition']"),H=document.getElementById(Q.odeIdeviceId);if(H)J=H.nextElementSibling,H.remove();let K=this.idevices.getBlockById(Q.blockId);if(K)X=K.blockContent,Q.isSync=!0,Q.mode="export",Y=await this.idevices.createIdeviceInContent(Q,X,q);else{let R=document.querySelector(".nav-element .selected").getAttribute("nav-id"),M=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content");Q.isSync=!0,Q.mode="export";let F=await this.idevices.createIdeviceInContent(Q,M,q);F.odeNavStructureSyncId=R}if(H||Z)if(Z)X.insertBefore(Y.ideviceContent,X.children[Y.order]);else X.insertBefore(Y.ideviceContent,J);var V=setInterval(()=>{let R=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");if(document.querySelector('[node-selected="'+R+'"]').getAttribute("mode")=="view")this.idevices.resetCurrentIdevicesExportView([]),clearInterval(V)},this.syncIntervalTime)}async checkUsersInSession(Q,Z,Y,X){return this.app.api.getOdeConcurrentUsers(Q,Z,Y).then((J)=>{let W=J.currentUsers;if(!W||W.length<=1)X=!1}),X}async checkModeEdition(Q,Z){return Q.forEach((Y)=>{if(Y.getAttribute("mode")=="edition")Z=!1}),Z}async checkDraggingElement(Q,Z){if(Q.length>0)Z=!1;return Z}async updateEditedElement(Q){if(Q.odeComponentSyncId){this.replaceOdeComponent(Q.odeComponentSync);let Z=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");if(document.querySelector('[node-selected="'+Z+'"]').getAttribute("mode")=="view")this.idevices.resetCurrentIdevicesExportView([])}else if(Q.odeBlockId){this.replaceOdeBlock(Q.odeBlockSync);let Z=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");if(document.querySelector('[node-selected="'+Z+'"]').getAttribute("mode")=="view")this.idevices.resetCurrentIdevicesExportView([])}else if(this.replaceOdePage(Q.odePageSync),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id")==Q.odePageSync.pageId)eXeLearning.app.project.idevices.setNodeContentPageTitle(Q.odePageSync.odeNavStructureSyncProperties)}async updateDeletedElement(Q){if(Q.odeComponentSyncId)this.deleteOdeComponent(Q.odeComponentSyncId);else if(Q.odeBlockId)this.deleteOdeBlock(Q.odeBlockId);else this.deleteOdePage(Q.odePageId)}async updateAddedElement(Q){if(Q.odeComponentSyncId)this.addOdeComponent(Q.odeComponentSync);else if(Q.odeBlockSync)this.addOdeBlock(Q.odeBlockSync);else this.addOdePage(Q.odePageSync),this.reloadStructure()}async updateOrderNavMap(Q){let Z=this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("nav-id");if(this.app.menus.menuStructure.menuStructureCompose.structureEngine.resetDataAndStructureData(Z),eXeLearning.app.user.preferences.preferences.theme.value!==Q.styleThemeValueId)this.app.modals.confirm.show({title:_("Style changed"),body:_("Your style has changed. Reload the page to apply changes?"),confirmButtonText:_("Yes"),confirmExec:()=>{eXeLearning.app.themes.selectTheme(Q.styleThemeValueId,!0)}})}async updateMovedElement(Q){if(Q.odeComponentSyncId)this.moveOdeComponent(Q.odeComponentSync);else this.moveOdeBlock(Q.odeBlockSync);var Z=setInterval(()=>{let Y=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");if(document.querySelector('[node-selected="'+Y+'"]').getAttribute("mode")=="view")this.idevices.resetCurrentIdevicesExportView([]),clearInterval(Z)},this.syncIntervalTime)}async updateMovedElementOnSamePage(Q){if(Q.odeComponentSyncId)this.moveOdeComponentOnSamePage(Q.odeComponentSync);else this.moveOdeBlockOnSamePage(Q.odeBlockSync);var Z=setInterval(()=>{let Y=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");if(document.querySelector('[node-selected="'+Y+'"]').getAttribute("mode")=="view")this.idevices.resetCurrentIdevicesExportView([]),clearInterval(Z)},this.syncIntervalTime)}async checkUserUpdateFlag(Q){if(!Q)return!1;this.app.api.postCheckUserOdeUpdates(Q).then((Z)=>{if(Z.responseMessage=="OK")for(let Y of Z.syncChanges)setTimeout(()=>{if(Y.actionType=="EDIT")setTimeout(()=>{this.updateEditedElement(Y)},this.syncIntervalTime);else if(Y.actionType=="DELETE")this.updateDeletedElement(Y);else if(Y.actionType=="ADD")this.updateAddedElement(Y);else if(Y.actionType=="RELOAD_NAV_MAP")this.updateOrderNavMap(Y);else if(Y.actionType=="MOVE_TO_PAGE")this.updateMovedElement(Y);else if(Y.actionType=="MOVE_ON_PAGE")this.updateMovedElementOnSamePage(Y);else this.updateUserPage(Q)},this.syncIntervalTime)})}async replaceOdeBlock(Q){let Z,J=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content"),W=J.querySelector(".idevice_node[mode='edition']"),z=document.getElementById(Q.blockId);if(z)Z=z.nextElementSibling,z.remove();Q.mode="export";let G=await this.idevices.newBlockNode(Q,!0);J.insertBefore(G.blockContent,J.children[G.order]),Q.odeComponentsSyncs.forEach(async(q)=>{q.mode="export",await this.idevices.createIdeviceInContent(q,G.blockContent,W)})}async moveOdeBlockOnSamePage(Q){let Z=document.getElementById(Q.blockId);if(Z)Z.remove();let J=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content"),W=J.querySelector(".idevice_node[mode='edition']"),z=await this.idevices.newBlockNode(Q,!0),G=J.children.length-1;J.insertBefore(z.blockContent,J.children[G]);var q=setInterval(()=>{if(J.getAttribute("mode")=="view")Q.odeComponentsSyncs.forEach(async(H)=>{if(H.htmlView!==null)H.mode="export",await this.idevices.createIdeviceInContent(H,z.blockContent,W)}),clearInterval(q)},this.syncIntervalTime)}async moveOdeComponentOnSamePage(Q){let Z,Y,X,z=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content"),G=z.querySelector(".idevice_node[mode='edition']"),q=document.getElementById(Q.odeIdeviceId);if(q)X=q.nextElementSibling,q.remove();let H=this.idevices.getBlockById(Q.blockId);if(H)Y=H.blockContent,Q.mode="export",Z=await this.idevices.createIdeviceInContent(Q,Y,G);else{Q.mode="export";let K={odeBlockId:Q.blockId},V=await this.app.api.postObtainOdeBlockSync(K);Q.mode="export";let R=await this.idevices.newBlockNode(V,!0);Y=R.blockContent,Z=await this.idevices.createIdeviceInContent(Q,Y,G),z.insertBefore(Y,z.children[R.order])}if(H)Y.insertBefore(Z.ideviceContent,Y.children[Z.order])}async replaceOdePage(Q){let Z=this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("nav-id");if(!Q){let X=Q.odeNavStructureSyncProperties;if(this.structure.data=this.structure.data.filter((J,W,z)=>{return J.id!=Q.id}),await this.app.menus.menuStructure.menuStructureCompose.structureEngine.cloneNodeNav(Q),Q.id==Z)this.idevices.setNodeContentPageTitle(X)}this.app.project.properties.loadPropertiesFromYjs(),this.app.project.properties.formProperties.reloadValues(),this.app.menus.menuStructure.menuStructureCompose.structureEngine.resetDataAndStructureData(Z);let Y=document.querySelector("#exe-title > .exe-title.content");if(Y.innerHTML=this.app.project.properties.properties.pp_title.value,Y.dataset.originalTitle=this.app.project.properties.properties.pp_title.value,typeof $exe<"u"&&$exe.math&&$exe.math.refresh)$exe.math.refresh(Y)}async deleteOdeComponent(Q){document.getElementById(Q)?.remove?.()}async deleteOdeBlock(Q){document.getElementById(Q)?.remove?.()}async deleteOdePage(Q){let Z=this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("nav-id"),Y=this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");if(this.structure.data=this.structure.data.filter((X,J,W)=>{return X.pageId!=Q}),Q==Y)await this.app.menus.menuStructure.menuStructureCompose.structureEngine.resetStructureData(!1);else await this.app.menus.menuStructure.menuStructureCompose.structureEngine.resetStructureData(Z)}async addOdeComponent(Q){let J=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content").querySelector(".idevice_node[mode='edition']"),z=this.idevices.getBlockById(Q.blockId).blockContent;Q.mode="export";let G=await this.idevices.createIdeviceInContent(Q,z,J);z.insertBefore(G.ideviceContent,z.children[G.order])}async addOdeBlock(Q,Z=!1){let Y=document.querySelector(".nav-element .selected").getAttribute("nav-id"),W=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content"),z=W.querySelector(".idevice_node[mode='edition']");Q.mode="export";let G=await this.idevices.newBlockNode(Q,!0);if(Z)W.insertBefore(G.blockContent,W.children[G.order]);else W.insertBefore(G.blockContent,W.children[G.order]);Q.odeComponentsSyncs.forEach(async(H)=>{H.mode="export";let K=await this.idevices.createIdeviceInContent(H,G.blockContent,z)});var q=setInterval(()=>{let H=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");if(document.querySelector('[node-selected="'+H+'"]').getAttribute("mode")=="view")this.idevices.resetCurrentIdevicesExportView([]),clearInterval(q)},this.syncIntervalTime)}async addOdePage(Q){await this.app.menus.menuStructure.menuStructureCompose.structureEngine.cloneNodeNav(Q);let Z=this.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("nav-id"),Y=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.menuNavList.getElementsByClassName("nav-element").length;if(Z=="root"&&Y<=1)await this.app.menus.menuStructure.menuStructureCompose.structureEngine.resetStructureData(Q.id);await this.app.menus.menuStructure.menuStructureCompose.structureEngine.resetStructureData(Z)}async moveOdeBlock(Q,Z=!1){let Y=document.querySelectorAll(".idevice-element-in-content"),X=!1;if(Y.length<=0)X=!0;for(let J of Y){let W=J.getAttribute("block-id");if(Q.blockId==W){this.deleteOdeBlock(Q.blockId),X=!1;return}else if(Q.id!==W)X=!0}if(X)this.addOdeBlock(Q,Z)}async moveOdeComponent(Q,Z=!1){let Y=document.querySelectorAll(".idevice_node .idevice-element-in-content"),X=!1;if(Y.length<=0)X=!0;for(let J of Y){let W=J.getAttribute("idevice-id");if(Q.odeIdeviceId==W){if(Z)this.deleteOdeBlock(Q.previousBlockId);else this.deleteOdeComponent(Q.odeIdeviceId);X=!1;return}else if(Q.odeIdeviceId!==W)X=!0}if(X)this.replaceOdeComponent(Q,Z)}async cleanPreviousAutosaves(){let Q={odeSessionId:this.odeSession};await this.app.api.postCleanAutosavesByUser(Q)}async changeUserFlagOnEdit(Q,Z,Y,X,J=!1,W=null,z,G=null){let q={odeSessionId:this.odeSession,odeIdeviceId:X,blockId:Y,odeNavStructureSyncId:Z,odeComponentFlag:Q,timeIdeviceEditing:W,actionType:z,pageId:G};if(this.offlineInstallation!==!0&&Q==!1){let H=this.odeId,K=this.odeVersion,V=this.odeSession,R=!0;if(R=await this.checkUsersInSession(H,K,V,R),R&&J==!1)setTimeout(()=>{let O=document.getElementById(q.odeIdeviceId);if(O&&O.getAttribute("mode")!=="edition")return this.app.api.postEditIdevice(q)},this.clientIntervalUpdate);else return await this.app.api.postEditIdevice(q)}else return await this.app.api.postEditIdevice(q)}async isAvalaibleOdeComponent(Q,Z){let Y={odeSessionId:this.odeSession,odeIdeviceId:Z,blockId:Q};return await this.app.api.checkCurrentOdeUsersComponentFlag(Y)}checkOpenIdevice(){let Q=document.getElementById("node-content");if(!Q)return!1;if(Q.querySelector('div.idevice_node[mode="edition"]')!==null)return eXeLearning.app.modals.alert.show({title:_("Info"),body:_("You are editing an iDevice. Please close it before continuing")}),!0}checkPageCollaborativeEditing(){let Q=document.getElementById("node-content").getAttribute("node-selected");if(this.activeLocks.get(Q)===!1)return!1;return eXeLearning.app.modals.alert.show({title:_("Info"),body:_("Someone else is editing this page. Please wait until they finish before adding new iDevices.")}),!0}sortBlocksById(Q=!0){let X=document.querySelector("#main #workarea").querySelector("#node-content-container").querySelector("#node-content");Array.from(X.children).filter((W)=>W.tagName.toLowerCase()==="article").sort((W,z)=>{return Q?W.id.localeCompare(z.id):z.id.localeCompare(W.id)}).forEach((W)=>{let z=W.querySelector(".exe-text-activity p"),G=W.querySelector(".exe-udlContent-content > div"),q=z?z.innerText:G?.innerText||"[No content]",H=q.length>50?q.slice(0,50)+"…":q;w.log("id: "+W.id+" content: "+H),X.appendChild(W)})}}class r{constructor(Q,Z,Y){if(this.manager=Q,Y)this.toastElement=Y;if(this.id=Z,this.defaultIcon="info",this.defaultTitle="",this.defaultBody="",!Y)this.toastElement=document.getElementById(this.id);this.toastIcon=this.toastElement.querySelector(".toast-header > .toast-icon"),this.toastTitle=this.toastElement.querySelector(".toast-header > .toast-title"),this.toastBody=this.toastElement.querySelector(".toast-body"),this.progressContainer=this.toastElement.querySelector(".toast-progress-container"),this.progressBar=this.toastElement.querySelector(".toast-progress-bar"),this.toast=new bootstrap.Toast(this.toastElement,{}),this.hidingTime=2000}showProgress(){if(this.progressContainer)this.progressContainer.style.display="block",this.setProgress(0)}hideProgress(){if(this.progressContainer)this.progressContainer.style.display="none"}setProgress(Q){if(this.progressBar){let Z=Math.min(100,Math.max(0,Q));this.progressBar.style.width=`${Z}%`}}updateBodyWithProgress(Q,Z){let Y=Math.round(Z);this.toastBody.innerHTML=`${Q} (${Y}%)`,this.setProgress(Z)}show(Q){let Z=Q.icon?Q.icon:this.defaultIcon,Y=Q.title?Q.title:this.defaultTitle,X=Q.body?Q.body:this.defaultBody;if(this.toastIcon.innerHTML=Z,this.toastTitle.innerHTML=Y,this.toastBody.innerHTML=X,Q.error)this.toastBody.classList.add("error");if(this.toastElement.classList.remove("hiding"),this.toast.show(),Q.remove)setTimeout(()=>{this.remove()},Q.remove)}hide(){this.toastElement.classList.add("hiding"),this.toastBody.classList.remove("error"),setTimeout(()=>{if(this.toastElement.classList.contains("hiding"))this.toast.hide()},this.hidingTime)}remove(){this.toastElement.classList.add("hiding"),setTimeout(()=>{if(this.toastElement.classList.contains("hiding"))this.toast.hide(),this.toastElement.remove()},this.hidingTime)}}class I0 extends r{constructor(Q){let Z="toastDefault";super(Q,Z)}}class y0{constructor(Q){this.app=Q,this.default=null}init(){this.default=new I0(this)}createToast(Q){let Z=`tmp-toast-${eXeLearning.app.common.generateId()}`,Y=this.default.toastElement.cloneNode(!0);Y.id=Z,document.querySelector("body > .toasts-container").append(Y);let X=new r(this,Z);return X.show(Q),X}}class x{constructor(Q,Z,Y,X){this.manager=Q,this.id=Z,this.titleDefault=Y,this.clearAfterClose=X,this.confirmExec=void 0,this.cancelExec=void 0,this.closeExec=void 0,this.modalElement=document.getElementById(this.id),this.modalElementHeader=this.modalElement.querySelector(".modal-header"),this.modalElementTitle=this.modalElement.querySelector(".modal-title"),this.modalElementBody=this.modalElement.querySelector(".modal-body"),this.modalElementButtonsConfirm=this.modalElement.querySelectorAll(".confirm"),this.modalElementButtonsClose=this.modalElement.querySelectorAll(".close"),this.modalElementButtonsCancel=this.modalElement.querySelectorAll(".cancel"),this.exeTabs=this.modalElement.querySelectorAll(".exe-form-tabs li a"),this.exeContents=this.modalElement.querySelectorAll(".exe-form-content"),this.exeHelp=this.modalElement.querySelectorAll(".exe-form-help"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary"),this.preventCloseModal=!1,this.tabSelectedLink=null,this.modal=new bootstrap.Modal(this.modalElement,{}),this.timeMax=500,this.timeMin=50,this.modalElement.setAttribute("data-open","false"),this.modalElement.addEventListener("shown.bs.modal",()=>{this.modalElement.setAttribute("data-open","true")}),this.modalElement.addEventListener("hidden.bs.modal",()=>{this.modalElement.setAttribute("data-open","false")})}behaviour(){this.interactModal(),this.addBehaviourCloseModal(),this.addBehaviourCancelModal(),this.addBehaviourButtonConfirm(),this.addBehaviourExeTabs(),this.addBehaviourExeHelp(),this.addBehaviourBodyToHideHelpDialogs()}addBehaviourCloseModal(){this.modalElementButtonsClose.forEach((Q)=>{Q.addEventListener("click",(Z)=>{this.close()})})}addBehaviourCancelModal(){this.modalElementButtonsCancel.forEach((Q)=>{Q.addEventListener("click",(Z)=>{this.cancel()})})}addBehaviourButtonConfirm(){this.modalElementButtonsConfirm.forEach((Q)=>{Q.addEventListener("click",(Z)=>{this.confirm()})})}addBehaviourExeTabs(){this.exeTabs=this.modalElement.querySelectorAll(".exe-form-tabs li a"),this.exeContents=this.modalElement.querySelectorAll(".exe-form-content"),this.exeTabs.forEach((Q)=>{Q.addEventListener("click",(Z)=>{if(Z.preventDefault(),this.hideHelpContentAll(),this.exeTabs.forEach((Y)=>{Y.classList.remove("exe-form-active-tab")}),Q.classList.add("exe-form-active-tab"),this.exeContents.length>0)this.exeContents.forEach((Y)=>{Y.classList.remove("exe-form-active-content")}),this.modalElementBody.querySelector(`${Q.hash}.exe-form-content`).classList.add("exe-form-active-content"),this.tabSelectedLink=Q.hash;else if(this.exeContentsRows=this.modalElement.querySelectorAll(".exe-form-content-rows .row-form-content"),this.exeContentsRows.length>0)this.exeContentsRows.forEach((Y)=>{if("#"+Y.getAttribute("category")==Q.hash)Y.classList.remove("hidden");else Y.classList.add("hidden")})})})}addBehaviourExeHelp(){this.exeHelp=this.modalElement.querySelectorAll(".exe-form-help"),this.exeHelp.forEach((Q)=>{let Z=Q.querySelector(".help-content");Q.setAttribute("title",_("Information")),this.hideHelpContent(Q),Q.querySelector("icon").addEventListener("click",(Y)=>{let X=Z.classList.contains("help-hidden");if(this.hideHelpContentAll(),X)this.showHelpContent(Q)})})}addBehaviourBodyToHideHelpDialogs(){this.modalElement.addEventListener("click",(Q)=>{if(!Q.target.classList.contains("form-help-exe-icon"))this.hideHelpContentAll()})}initCloseCheckInterval(){this.intervalCloseCheck=setInterval(()=>{if(!this.modal._isShown)this.close()},100)}showHelpContent(Q){Q.querySelector(".help-content").classList.remove("help-hidden"),Q.classList.add("help-content-active"),Q.classList.remove("help-content-disabled")}hideHelpContent(Q){Q.querySelector(".help-content").classList.add("help-hidden"),Q.classList.add("help-content-disabled"),Q.classList.remove("help-content-active")}hideHelpContentAll(){this.exeHelp=this.modalElement.querySelectorAll(".exe-form-help"),this.exeHelp.forEach((Q)=>{this.hideHelpContent(Q)})}interactModal(){interact(`#${this.id}.modal .modal-header`).draggable({listeners:{move:this.dragMoveModalListener.bind(this)},inertia:!1,modifiers:[interact.modifiers.restrictRect({restriction:document.querySelector("#main"),endOnly:!0})]})}dragMoveModalListener(Q){let Z=Q.target.parentNode;if(!Z.classList.contains("static")){let Y=(parseFloat(Z.getAttribute("data-x"))||0)+Q.dx,X=(parseFloat(Z.getAttribute("data-y"))||0)+Q.dy;Z.style.transform="translate("+Y+"px, "+X+"px)",Z.setAttribute("data-x",Y),Z.setAttribute("data-y",X)}}show(Q){let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{Q=Q?Q:{};let Y=Q.title?Q.title:this.titleDefault,X=Q.contentId?Q.contentId:null,J=Q.body?Q.body:"";if(this.setTitle(Y),this.setContentId(X),this.setBody(J),this.modal.show(),this.cancelButton)setTimeout(()=>{this.cancelButton.focus()},this.timeMax)},Z)}close(Q){if(this.preventCloseModal)return this.preventCloseModal=!1,!1;if(this.intervalCloseCheck)clearInterval(this.intervalCloseCheck);if(!Q&&this.closeExec)this.closeExec.call();if(document.activeElement&&this.modalElement.contains(document.activeElement))document.activeElement.blur();if(this.modal.hide(),this.clearAfterClose)setTimeout(()=>{this.modalElementTitle.innerHTML="",this.modalElementBody.innerHTML="",this.modalElementHeader.removeAttribute("modal-content-id"),this.modalElementBody.removeAttribute("modal-content-id")},100)}async confirm(){if(this.modalElementButtonsConfirm.forEach((Q)=>{Q.classList.add("disabled")}),this.confirmExec)await this.confirmExec.call();this.close(!0),setTimeout(()=>{this.modalElementButtonsConfirm.forEach((Q)=>{Q.classList.remove("disabled")})},this.timeMax)}async cancel(){if(this.modalElementButtonsCancel.forEach((Q)=>{Q.classList.add("disabled")}),this.cancelExec)await this.cancelExec.call();this.close(!0),setTimeout(()=>{this.modalElementButtonsCancel.forEach((Q)=>{Q.classList.remove("disabled")})},this.timeMax)}setContentId(Q){if(Q)this.modalElementHeader.setAttribute("modal-content-id",Q),this.modalElementBody.setAttribute("modal-content-id",Q);else this.modalElementHeader.removeAttribute("modal-content-id"),this.modalElementBody.removeAttribute("modal-content-id")}setTitle(Q){this.modalElementTitle.innerHTML=Q}setBody(Q){this.modalElementBody.innerHTML=Q}setConfirmExec(Q){this.confirmExec=Q}setCancelExec(Q){this.cancelExec=Q}setCloseExec(Q){this.closeExec=Q}sorTable(Q,Z,Y){var X,J=0;let W=Q.rows,z=W[0].getAttribute("sort-type")?W[0].getAttribute("sort-type"):"asc";var G=!0;while(G){G=!1;for(var q=1;q<W.length-1;q++){let K=W[q].getElementsByTagName("td")[Z],V=W[q+1].getElementsByTagName("td")[Z];if(!K||!V)return!1;switch(Y){case"string":X=this.sorTableString(z,K,V);break;case"date":X=this.sorTableDate(z,K,V);break;case"float":X=this.sorTableFloat(z,K,V);break;case"checkbox":X=this.sorTableCheckbox(z,K,V);break;default:return!1}if(X)break}if(X)W[q].parentNode.insertBefore(W[q+1],W[q]),G=!0,J++}let H=z=="asc"?"desc":"asc";W[0].setAttribute("sort-type",H)}sorTableString(Q,Z,Y){if(Q=="asc")return Z.innerHTML.toLowerCase()>Y.innerHTML.toLowerCase();else if(Q=="desc")return Z.innerHTML.toLowerCase()<Y.innerHTML.toLowerCase();return!1}sorTableDate(Q,Z,Y){if(Q=="asc")return Z.id>Y.id;else if(Q=="desc")return Z.id<Y.id;return!1}sorTableFloat(Q,Z,Y){if(Q=="asc")return parseFloat(Z.getAttribute("size"))>parseFloat(Y.getAttribute("size"));else if(Q=="desc")return parseFloat(Z.getAttribute("size"))<parseFloat(Y.getAttribute("size"));return!1}sorTableCheckbox(Q,Z,Y){let X=Z.querySelector("input"),J=Y.querySelector("input");if(Q=="asc")return X.checked>J.checked;else if(Q=="desc")return X.checked<J.checked;return!1}tableToCSV(Q,Z={}){let Y=Z.skipColumns||[],X=[],J=Q.querySelector("thead");if(J){let z=[],G=J.querySelectorAll("tr th");if(G.length===0)G=J.querySelectorAll("th");if(G.forEach((q,H)=>{if(!Y.includes(H))z.push(this._escapeCSVValue(q.textContent.trim()))}),z.length>0)X.push(z.join(","))}let W=Q.querySelector("tbody");if(W)W.querySelectorAll("tr").forEach((G)=>{let q=[],H=G.querySelectorAll("td");if(H.length===1&&H[0].colSpan>1)return;if(H.forEach((K,V)=>{if(!Y.includes(V)){let R=K.textContent.trim();q.push(this._escapeCSVValue(R))}}),q.length>0)X.push(q.join(","))});return X.join(`\r
`)}_escapeCSVValue(Q){if(Q===null||Q===void 0)return"";let Z=String(Q);if(Z.includes(",")||Z.includes('"')||Z.includes(`
`)||Z.includes("\r"))return`"${Z.replace(/"/g,'""')}"`;return Z}downloadCSVFile(Q,Z){let Y=new Blob(["\uFEFF",Q],{type:"text/csv;charset=utf-8"}),X=URL.createObjectURL(Y),J=document.createElement("a");J.href=X,J.download=Z,document.body.appendChild(J),J.click(),document.body.removeChild(J),URL.revokeObjectURL(X)}makeFilterTable(Q,Z,Y){let X=document.createElement("input");return X.classList.add("table-filter"),X.classList.add("form-control"),X.setAttribute("type","text"),X.setAttribute("placeholder",Y),X.addEventListener("keyup",()=>{let J=X.value.toUpperCase(),W=Q.getElementsByTagName("tr");Q.querySelectorAll("tr").forEach((z)=>{let G=z.querySelector(Z);if(G)if((G.textContent||G.innerText).toUpperCase().indexOf(J)>-1)z.style.display="";else z.style.display="none"})}),X}}class h0 extends x{constructor(Q){let Z="modalAlert",Y=_("Alert");super(Q,Z,Y,!0)}}class b0 extends x{constructor(Q){let Z="modalConfirm",Y;super(Q,Z,Y,!0);this.confirmButtonDefaultText=_("Yes"),this.cancelButtonDefaultText=_("No"),this.confirmButton=this.modalElement.querySelector("button.btn.button-primary"),this.cancelButton=this.modalElement.querySelector("button.cancel.btn.button-tertiary")}show(Q){this.titleDefault=_("Confirm");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{Q=Q?Q:{};let Y=Q.title?Q.title:this.titleDefault,X=Q.contentId?Q.contentId:null,J=Q.body?Q.body:"",W=Q.confirmButtonText?Q.confirmButtonText:this.confirmButtonDefaultText,z=Q.cancelButtonText?Q.cancelButtonText:this.cancelButtonDefaultText,G=Q.confirmExec?Q.confirmExec:null,q=Q.cancelExec?Q.cancelExec:null,H=Q.closeExec?Q.closeExec:null,K=Q.behaviour?Q.behaviour:null,V=Q.focusFirstInputText?Q.focusFirstInputText:null,R=Q.focusCancelButton?Q.focusCancelButton:null;if(this.setTitle(Y),this.setContentId(X),this.setBody(J),this.setConfirmButtonText(W),this.setCancelButtonText(z),this.setConfirmExec(G),this.setCancelExec(q),this.setCloseExec(H),this.modal.show(),setTimeout(()=>{this.addBehaviourTextInputs()},this.timeMax),K)K.call();if(V)setTimeout(()=>{this.focusTextInput(this.modalElementBody.querySelector('input[type="text"'))},this.timeMax);else if(R)setTimeout(()=>{this.cancelButton.focus()},this.timeMax);else setTimeout(()=>{this.confirmButton.focus()},this.timeMax)},Z)}setConfirmButtonText(Q){this.confirmButton.innerHTML=Q}setCancelButtonText(Q){this.cancelButton.innerHTML=Q}addBehaviourTextInputs(){if(this.confirmExec)this.modalElementBody.querySelectorAll('input[type="text"]').forEach((Q)=>{Q.addEventListener("keyup",(Z)=>{if(Z.preventDefault(),Z.key=="Enter")this.confirm()})})}focusTextInput(Q){if(Q){Q.focus();let Z=Q.value;Q.value="",Q.value=Z}}}class v0 extends x{constructor(Q){let Z="modalInfo",Y=_("Info");super(Q,Z,Y,!0)}}class g0 extends x{constructor(Q){let Z="modalUploadToDrive",Y;super(Q,Z,Y,!1);this.confirmButtonDefaultText=_("Upload"),this.cancelButtonDefaultText=_("Cancel"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary")}show(Q){this.titleDefault=_("Upload to Google Drive");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{this.setTitle(this.titleDefault),this.setBody(this.makeBodyHtml(Q)),this.setConfirmExec(()=>{this.uploadFile()}),this.modal.show()},Z)}makeBodyHtml(Q){let Z=document.createElement("div");return Z.append(this.makeElementBodyInfo()),Z.append(this.makeElementSelectDir(Q)),Z.innerHTML}makeElementBodyInfo(){let Q=document.createElement("p");return Q.innerHTML=_("Select the Google Drive directory where the project will be uploaded:"),Q}makeElementSelectDir(Q){let Z=document.createElement("select");Z.id="drive-folders";let Y=document.createElement("option");return Y.value=null,Y.text=_("Root"),Y.setAttribute("selected","selected"),Z.appendChild(Y),Q.files.sort((X,J)=>X.name>J.name?1:J.name>X.name?-1:0),Q.files.forEach((X)=>{Y=document.createElement("option"),Y.value=X.id,Y.text=X.name,Z.appendChild(Y)}),Z}async uploadFile(){let Q=eXeLearning.app.project.odeSession,Z=eXeLearning.app.project.odeId,Y=eXeLearning.app.project.odeVersion,W={folder:this.modalElementBody.querySelector("select#drive-folders option:checked").value,odeSessionId:Q,odeId:Z,odeVersion:Y},z=await eXeLearning.app.api.uploadFileGoogleDrive(W);this.close(),setTimeout(()=>{this.showUploadAlert(z)},300)}showUploadAlert(Q){eXeLearning.app.modals.alert.show({title:Q.status,body:Q.statusMsg})}}class u0 extends x{constructor(Q){let Z="modalUploadToDropbox",Y;super(Q,Z,Y,!1);this.confirmButtonDefaultText=_("Upload"),this.cancelButtonDefaultText=_("Cancel"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary")}show(Q){this.titleDefault=_("Upload to Dropbox");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{this.setTitle(this.titleDefault),this.setBody(this.makeBodyHtml(Q)),this.setConfirmExec(()=>{this.uploadFile()}),this.modal.show()},Z)}makeBodyHtml(Q){let Z=document.createElement("div");return Z.append(this.makeElementBodyInfo()),Z.append(this.makeElementSelectDir(Q)),Z.innerHTML}makeElementBodyInfo(){let Q=document.createElement("p");return Q.innerHTML=_("Select the Dropbox directory where the project will be uploaded:"),Q}makeElementSelectDir(Q){let Z=document.createElement("select");Z.id="dropbox-folders";let Y=document.createElement("option");return Y.value=null,Y.text=_("Root"),Y.setAttribute("selected","selected"),Z.appendChild(Y),Q.files.sort((X,J)=>X.name>J.name?1:J.name>X.name?-1:0),Q.files.forEach((X)=>{if(X!=null)Y=document.createElement("option"),Y.value=X.id,Y.text=X.name,Z.appendChild(Y)}),Z}async uploadFile(){let Q=eXeLearning.app.project.odeSession,Z=eXeLearning.app.project.odeId,Y=eXeLearning.app.project.odeVersion,W={folder:this.modalElementBody.querySelector("select#dropbox-folders option:checked").value,odeSessionId:Q,odeId:Z,odeVersion:Y},z=await eXeLearning.app.api.uploadFileDropbox(W);this.close(),setTimeout(()=>{this.showUploadAlert(z)},300)}showUploadAlert(Q){eXeLearning.app.modals.alert.show({title:Q.status,body:Q.statusMsg})}}var T=window.AppLogger||console;class m0 extends x{constructor(Q){let Y=_("File manager");super(Q,"modalFileManager",Y,!1);this.assets=[],this.filteredAssets=[],this.selectedAsset=null,this.selectedAssets=[],this.multiSelect=!1,this.onSelectCallback=null,this.acceptFilter=null,this.typeFilter="",this.assetManager=null,this.assetUsageCounts=new Map,this.currentPath="",this.folders=[],this.createdFolders=new Set,this.isSearchMode=!1,this.viewMode="grid",this.sortBy="date-desc",this.currentPage=1,this.itemsPerPage=50,this.grid=null,this.listTable=null,this.listTbody=null,this.sidebar=null,this.sidebarEmpty=null,this.sidebarContent=null,this.uploadBtn=null,this.uploadInput=null,this.searchInput=null,this.deleteBtn=null,this.insertBtn=null,this.viewBtns=null,this.sortSelect=null,this.downloadBtn=null,this.moreBtn=null,this.extractBtn=null,this.copyUrlBtn=null,this.fullSizeBtn=null}initElements(){this.grid=this.modalElement.querySelector(".media-library-grid"),this.listContainer=this.modalElement.querySelector(".media-library-list-container"),this.listTable=this.modalElement.querySelector(".media-library-list"),this.listTbody=this.listTable?.querySelector("tbody"),this.emptyState=this.modalElement.querySelector(".media-library-empty"),this.sidebar=this.modalElement.querySelector(".media-library-sidebar"),this.sidebarEmpty=this.modalElement.querySelector(".media-library-sidebar-empty"),this.sidebarContent=this.modalElement.querySelector(".media-library-sidebar-content"),this.uploadBtn=this.modalElement.querySelector(".media-library-upload-btn"),this.uploadInput=this.modalElement.querySelector(".media-library-upload-input"),this.searchInput=this.modalElement.querySelector(".media-library-header-search .media-library-search");let Q=this.modalElement.querySelector(".media-library-footer");this.deleteBtn=Q?.querySelector(".media-library-delete-btn"),this.insertBtn=Q?.querySelector(".media-library-insert-btn"),this.renameBtn=Q?.querySelector(".media-library-rename-btn"),this.duplicateBtn=Q?.querySelector(".media-library-duplicate-btn"),this.moveBtn=Q?.querySelector(".media-library-move-btn"),this.downloadBtn=Q?.querySelector(".media-library-download-btn"),this.moreBtn=Q?.querySelector(".media-library-more-btn"),this.extractBtn=Q?.querySelector(".media-library-extract-btn"),this.copyUrlBtn=Q?.querySelector(".media-library-copyurl-btn"),this.fullSizeBtn=Q?.querySelector(".media-library-fullsize-btn"),this._wsHandler=null,this._onAssetRenamed=null,this._onFolderRenamed=null,this.viewBtns=this.modalElement.querySelectorAll(".media-library-view-btn"),this.sortSelect=this.modalElement.querySelector(".media-library-sort"),this.filterSelect=this.modalElement.querySelector(".media-library-filter"),this.showRefCountCheckbox=this.modalElement.querySelector(".media-library-show-refcount"),this.showRefCount=!1,this.previewImg=this.modalElement.querySelector(".media-library-preview-img"),this.previewVideo=this.modalElement.querySelector(".media-library-preview-video"),this.previewAudio=this.modalElement.querySelector(".media-library-preview-audio"),this.previewFile=this.modalElement.querySelector(".media-library-preview-file"),this.previewPdf=this.modalElement.querySelector(".media-library-preview-pdf"),this.breadcrumbs=this.modalElement.querySelector(".media-library-breadcrumbs"),this.searchIndicator=this.modalElement.querySelector(".media-library-search-indicator"),this.newFolderBtn=this.modalElement.querySelector(".media-library-newfolder-btn"),this.folderPicker=this.modalElement.querySelector(".media-library-folder-picker"),this.folderPickerList=this.modalElement.querySelector(".folder-picker-list"),this.folderPickerConfirm=this.modalElement.querySelector(".folder-picker-confirm"),this.folderPickerCancel=this.modalElement.querySelector(".folder-picker-cancel"),this.folderPickerClose=this.modalElement.querySelector(".folder-picker-close"),this.folderPickerOverlay=this.modalElement.querySelector(".folder-picker-overlay"),this.filenameSpan=this.modalElement.querySelector(".media-library-filename"),this.copyUrlBtn=this.modalElement.querySelector(".media-library-copy-url-btn"),this.fileCountSpan=this.modalElement.querySelector(".media-library-count-value"),this.typeSpan=this.modalElement.querySelector(".media-library-type"),this.sizeSpan=this.modalElement.querySelector(".media-library-size"),this.dimensionsRow=this.modalElement.querySelector(".media-library-dimensions-row"),this.dimensionsSpan=this.modalElement.querySelector(".media-library-dimensions"),this.dateSpan=this.modalElement.querySelector(".media-library-date"),this.usageRow=this.modalElement.querySelector(".media-library-usage-row"),this.usageSpan=this.modalElement.querySelector(".media-library-usage"),this.urlInput=this.modalElement.querySelector(".media-library-url"),this.locationRow=this.modalElement.querySelector(".media-library-location-row"),this.locationValue=this.modalElement.querySelector(".media-library-location-value"),this.openFolderBtn=this.modalElement.querySelector(".media-library-open-folder-btn"),this.locationColumnHeader=this.listTable?.querySelector("th.col-location")}initBehaviour(){if(this.uploadBtn&&this.uploadInput)this.uploadBtn.addEventListener("click",()=>{this.uploadInput.click()}),this.uploadInput.addEventListener("change",async(Q)=>{let Z=Q.target.files;if(Z&&Z.length>0)await this.uploadFiles(Z);this.uploadInput.value=""});if(this.initDragAndDrop(),this.searchInput)this.searchInput.addEventListener("input",(Q)=>{this.filterAssets(Q.target.value)});if(this.deleteBtn)this.deleteBtn.addEventListener("click",()=>{this.deleteSelectedAsset()});if(this.insertBtn)this.insertBtn.addEventListener("click",()=>{this.insertSelectedAsset()});if(this.downloadBtn)this.downloadBtn.addEventListener("click",()=>{this.downloadSelectedAsset()});if(this.extractBtn)this.extractBtn.addEventListener("click",(Q)=>{Q.preventDefault(),this.extractZipAsset()});if(this.copyUrlBtn)this.copyUrlBtn.addEventListener("click",(Q)=>{Q.preventDefault(),this.copyAssetUrl()});if(this.fullSizeBtn)this.fullSizeBtn.addEventListener("click",(Q)=>{Q.preventDefault(),this.viewFullSize()});if(this.copyUrlBtn)this.copyUrlBtn.addEventListener("click",()=>{this.copyAssetUrl()});if(this.viewBtns)this.viewBtns.forEach((Q)=>{Q.addEventListener("click",()=>{let Z=Q.dataset.view;if(Z)this.setViewMode(Z)})});if(this.sortSelect)this.sortSelect.addEventListener("change",(Q)=>{this.sortBy=Q.target.value,this.currentPage=1,this.applyFiltersAndRender()});if(this.filterSelect)this.filterSelect.addEventListener("change",(Q)=>{this.typeFilter=Q.target.value,this.currentPage=1,this.applyFiltersAndRender()});if(this.showRefCountCheckbox)this.showRefCountCheckbox.addEventListener("change",(Q)=>{this.showRefCount=Q.target.checked,this.applyFiltersAndRender()});if(this.listTable)this.listTable.querySelectorAll("th[data-sort]").forEach((Z)=>{Z.addEventListener("click",()=>{let Y=Z.dataset.sort;this.handleHeaderSort(Y)})});if(this.newFolderBtn)this.newFolderBtn.addEventListener("click",()=>{this.createNewFolder()});if(this.breadcrumbs)this.breadcrumbs.addEventListener("click",(Q)=>{let Z=Q.target.closest(".breadcrumb-item");if(Z){let Y=Z.dataset.path||"";this.navigateToFolder(Y)}});if(this.searchIndicator)this.searchIndicator.querySelector(".breadcrumb-home")?.addEventListener("click",()=>{this.clearSearchAndNavigate("")}),this.searchIndicator.querySelector(".clear-search-btn")?.addEventListener("click",()=>{if(this.searchInput)this.searchInput.value="";this.isSearchMode=!1,this.applyFiltersAndRender()});if(this.openFolderBtn)this.openFolderBtn.addEventListener("click",()=>{if(this.selectedAsset)this.clearSearchAndNavigate(this.selectedAsset.folderPath||"")});if(this.renameBtn)this.renameBtn.addEventListener("click",()=>{this.renameSelectedAsset()});if(this.duplicateBtn)this.duplicateBtn.addEventListener("click",()=>{this.duplicateSelectedAsset()});if(this.moveBtn)this.moveBtn.addEventListener("click",()=>{this.showMoveDialog()});if(this.folderPickerCancel)this.folderPickerCancel.addEventListener("click",()=>{this.hideFolderPicker()});if(this.folderPickerClose)this.folderPickerClose.addEventListener("click",()=>{this.hideFolderPicker()});if(this.folderPickerOverlay)this.folderPickerOverlay.addEventListener("click",()=>{this.hideFolderPicker()});if(this.folderPickerConfirm)this.folderPickerConfirm.addEventListener("click",()=>{this.confirmMove()})}handleHeaderSort(Q){let Z=this.sortBy.split("-")[0],Y=this.sortBy.split("-")[1];if(Z===Q)this.sortBy=`${Q}-${Y==="asc"?"desc":"asc"}`;else this.sortBy=`${Q}-asc`;if(this.sortSelect)this.sortSelect.value=this.sortBy;this.currentPage=1,this.applyFiltersAndRender()}setViewMode(Q){if(this.viewMode=Q,this.viewBtns)this.viewBtns.forEach((Z)=>{Z.classList.toggle("active",Z.dataset.view===Q)});if(Q==="grid"){if(this.grid)this.grid.style.display="grid";if(this.listContainer)this.listContainer.style.display="none"}else{if(this.grid)this.grid.style.display="none";if(this.listContainer)this.listContainer.style.display="flex"}this.renderCurrentView()}async show(Q={}){this.titleDefault=_("File manager");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(async()=>{if(this.setTitle(this.titleDefault),this.onSelectCallback=Q.onSelect||null,this.multiSelect=Q.multiSelect||!1,this.selectedAssets=[],this.acceptFilter=Q.accept||null,this.selectedAsset=null,this.selectedFolder=null,this.selectedFolderPath=null,this.currentPath="",!this.grid)this.initElements(),this.initBehaviour();if(this.showRefCount=!1,this.showRefCountCheckbox)this.showRefCountCheckbox.checked=!1;if(this.assetUsageCounts.clear(),this.updateButtonStates(),this.showSidebarEmpty(),this.assetManager=window.eXeLearning?.app?.project?._yjsBridge?.assetManager,T.log(`[MediaLibrary] Opening with assetManager.projectId: ${this.assetManager?.projectId}`),!this.assetManager){if(console.error("[MediaLibrary] AssetManager not available"),this.grid)this.grid.innerHTML=`<div class="media-library-error">${_("Media library not available")}</div>`;this.modal.show();return}this.modal.show(),await this.loadAssets(),this._subscribeToYjsChanges()},Z)}_subscribeToYjsChanges(){let Q=this.assetManager?.getAssetsYMap?.();if(!Q){T.log("[MediaLibrary] Yjs assets map not available for real-time sync");return}this._onYjsAssetsChange=(Z)=>this._handleYjsAssetsChange(Z),Q.observe(this._onYjsAssetsChange),this._assetsMap=Q,T.log("[MediaLibrary] Subscribed to Yjs asset changes")}_unsubscribeFromYjsChanges(){if(!this._assetsMap||!this._onYjsAssetsChange)return;this._assetsMap.unobserve(this._onYjsAssetsChange),this._assetsMap=null,this._onYjsAssetsChange=null,T.log("[MediaLibrary] Unsubscribed from Yjs asset changes")}_handleYjsAssetsChange(Q){if(Q.transaction.local)return;T.log("[MediaLibrary] Remote Yjs asset change detected"),this.loadAssets()}async loadAssets(){if(!this.assetManager)return;this.grid.innerHTML=`<div class="media-library-loading">${_("Loading assets...")}</div>`;try{this.assets=await this.assetManager.getProjectAssets(),T.log(`[MediaLibrary] Loaded ${this.assets.length} assets`),this.currentPage=1,this.updateFilterOptions(),this.loadFolderContents(this.currentPath)}catch(Q){console.error("[MediaLibrary] Failed to load assets:",Q),this.grid.innerHTML=`<div class="media-library-error">${_("Failed to load assets")}</div>`}}loadFolderContents(Q=""){this.currentPath=Q;let Z=this.assets.filter((W)=>(W.folderPath||"")===Q),Y=this.deriveSubfolders(this.assets,Q),X=this.getCreatedSubfolders(Q),J=new Set([...Y,...X]);this.folders=Array.from(J).sort((W,z)=>W.toLowerCase().localeCompare(z.toLowerCase())),this.filteredAssets=Z,this.renderBreadcrumbs(),this.applyFiltersAndRender()}getCreatedSubfolders(Q){let Z=[],Y=Q?Q+"/":"";for(let X of this.createdFolders)if(Q){if(!X.startsWith(Y))continue;let W=X.slice(Y.length).split("/")[0];if(W)Z.push(W)}else{let J=X.split("/")[0];if(J)Z.push(J)}return[...new Set(Z)]}deriveSubfolders(Q,Z=""){let Y=new Set,X=Z?Z+"/":"";for(let J of Q){let W=J.folderPath||"";if(!W.startsWith(X))continue;let z=W.slice(X.length);if(!z)continue;let G=z.split("/")[0];if(G)Y.add(G)}return Array.from(Y).sort((J,W)=>J.toLowerCase().localeCompare(W.toLowerCase()))}navigateToFolder(Q){T.log(`[MediaLibrary] Navigating to folder: "${Q}"`),this.selectedAsset=null,this.selectedAssets=[],this.selectedFolder=null,this.selectedFolderPath=null,this.showSidebarEmpty(),this.updateButtonStates(),this.currentPage=1,this.loadFolderContents(Q)}enterFolder(Q){let Z=this.currentPath?`${this.currentPath}/${Q}`:Q;this.navigateToFolder(Z)}navigateUp(){if(!this.currentPath)return;let Q=this.currentPath.split("/");Q.pop(),this.navigateToFolder(Q.join("/"))}renderBreadcrumbs(){if(!this.breadcrumbs)return;let Q=this.currentPath?this.currentPath.split("/"):[],Z=`<span class="breadcrumb-item" data-path="" title="${_("Root")}">
            <span class="exe-icon">home</span>
        </span>`,Y="";for(let X=0;X<Q.length;X++)Y+=(X>0?"/":"")+Q[X],Z+=`<span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item" data-path="${Y}">${this.escapeHtml(Q[X])}</span>`;this.breadcrumbs.innerHTML=Z}async createNewFolder(){let Q=prompt(_("Enter folder name:"));if(!Q)return;if(!this.isValidFolderName(Q)){alert(_('Invalid folder name. Avoid special characters like / \\ : * ? " < > |'));return}if(this.folders.includes(Q)){alert(_("A folder with this name already exists."));return}let Z=this.currentPath?`${this.currentPath}/${Q}`:Q;T.log(`[MediaLibrary] Creating folder: ${Z}`),this.createdFolders.add(Z),this.folders.push(Q),this.folders.sort((Y,X)=>Y.toLowerCase().localeCompare(X.toLowerCase())),this.renderCurrentView()}isValidFolderName(Q){if(!Q||Q.trim()!==Q)return!1;if(Q==="."||Q==="..")return!1;return!/[/\\:*?"<>|]/.test(Q)}escapeHtml(Q){let Z=document.createElement("div");return Z.textContent=Q,Z.innerHTML}applyFiltersAndRender(){let Q=this.searchInput?.value?.toLowerCase().trim()||"";this.isSearchMode=Q.length>0;let Z=this.isSearchMode?this.assets:this.assets.filter((Y)=>(Y.folderPath||"")===this.currentPath);if(this.filteredAssets=Z.filter((Y)=>{if(this.acceptFilter){let J=Y.mime||"";if(this.acceptFilter==="image"&&!J.startsWith("image/"))return!1;if(this.acceptFilter==="audio"&&!J.startsWith("audio/"))return!1;if(this.acceptFilter==="video"&&!J.startsWith("video/"))return!1}if(this.typeFilter){if(this.getAssetTypeCategory(Y.mime)!==this.typeFilter)return!1}if(!Q)return!0;return(Y.filename||"").toLowerCase().includes(Q)}),this.fileCountSpan)this.fileCountSpan.textContent=this.filteredAssets.length;if(this.isSearchMode)this.showSearchIndicator(Q);else this.showBreadcrumbs();this.sortAssets(),this.renderCurrentView()}showSearchIndicator(Q){if(this.breadcrumbs)this.breadcrumbs.classList.add("d-none");if(this.searchIndicator){this.searchIndicator.classList.remove("d-none");let Z=this.searchIndicator.querySelector(".search-term");if(Z)Z.textContent=Q}if(this.locationColumnHeader)this.locationColumnHeader.classList.remove("d-none")}showBreadcrumbs(){if(this.breadcrumbs)this.breadcrumbs.classList.remove("d-none");if(this.searchIndicator)this.searchIndicator.classList.add("d-none");if(this.locationColumnHeader)this.locationColumnHeader.classList.add("d-none")}clearSearchAndNavigate(Q){if(this.searchInput)this.searchInput.value="";this.isSearchMode=!1,this.navigateToFolder(Q)}sortAssets(){let[Q,Z]=this.sortBy.split("-"),Y=Z==="asc"?1:-1;this.filteredAssets.sort((X,J)=>{let W,z;switch(Q){case"name":return W=(X.filename||"").toLowerCase(),z=(J.filename||"").toLowerCase(),W.localeCompare(z)*Y;case"date":return W=X.createdAt||0,z=J.createdAt||0,(W-z)*Y;case"size":return W=X.size||0,z=J.size||0,(W-z)*Y;case"type":return W=(X.mime||"").toLowerCase(),z=(J.mime||"").toLowerCase(),W.localeCompare(z)*Y;default:return 0}})}renderCurrentView(){if(this.viewMode==="grid")this.renderGrid(this.filteredAssets);else this.renderList(this.filteredAssets);if(this.updateButtonStates(),this.multiSelect&&this.selectedAssets.length>0){let Q=new Set(this.selectedAssets.map((Z)=>Z.id));if(this.viewMode==="grid"&&this.grid)this.grid.querySelectorAll(".media-library-item").forEach((Z)=>{if(Q.has(Z.dataset.assetId))Z.classList.add("selected")});else if(this.listTbody)this.listTbody.querySelectorAll("tr").forEach((Z)=>{if(Q.has(Z.dataset.assetId))Z.classList.add("selected")})}else if(!this.multiSelect)this.selectedAsset=null,this.selectedAssets=[],this.showSidebarEmpty()}updateButtonStates(){let Q=this.selectedAsset!==null,Z=this.selectedFolder!==null,Y=Q||Z,X=Q&&(this.selectedAsset.mime==="application/zip"||this.selectedAsset.mime==="application/x-zip-compressed"||this.selectedAsset.filename?.toLowerCase().endsWith(".zip"));if(this.deleteBtn)this.deleteBtn.disabled=!Y;if(this.renameBtn)this.renameBtn.disabled=!Y;if(this.moveBtn)this.moveBtn.disabled=!Y;if(this.downloadBtn)this.downloadBtn.disabled=!Q;if(this.duplicateBtn)this.duplicateBtn.disabled=!Q;if(this.insertBtn)this.insertBtn.disabled=!Q;if(this.moreBtn)this.moreBtn.disabled=!Q;if(this.extractBtn)this.extractBtn.classList.toggle("d-none",!X)}renderGrid(Q=null){if(!this.grid)return;let Z=Q||this.filteredAssets,Y=!this.isSearchMode&&this.folders.length>0,X=Z.length>0;if(!Y&&!X){this.showEmptyState();return}if(this.hideEmptyState(),this.grid.innerHTML="",!this.isSearchMode)for(let J of this.folders){let W=this.createFolderGridItem(J);this.grid.appendChild(W)}for(let J of Z){let W=this.createGridItem(J);this.grid.appendChild(W)}}createFolderGridItem(Q){let Z=document.createElement("div");return Z.className="media-library-item media-library-folder",Z.dataset.folderName=Q,Z.innerHTML=`
            <div class="media-thumbnail folder-thumbnail">
                <span class="exe-icon folder-icon">folder</span>
                <span class="media-label">${this.escapeHtml(Q)}</span>
            </div>`,Z.addEventListener("dblclick",()=>{this.enterFolder(Q)}),Z.addEventListener("click",()=>{this.selectedAsset=null,this.selectedAssets=[],this.grid.querySelectorAll(".media-library-item").forEach((Y)=>{Y.classList.remove("selected")}),Z.classList.add("selected"),this.showFolderSidebarContent(Q)}),Z}showFolderSidebarContent(Q){if(this.sidebarEmpty)this.sidebarEmpty.style.display="none";if(this.sidebarContent)this.sidebarContent.style.display="flex";if(this.previewImg)this.previewImg.style.display="none";if(this.previewVideo)this.previewVideo.style.display="none";if(this.previewAudio)this.previewAudio.style.display="none";if(this.previewPdf)this.previewPdf.style.display="none";if(this.previewFile){this.previewFile.style.display="flex";let X=this.previewFile.querySelector(".file-icon");if(X)X.textContent="folder"}let Z=this.currentPath?`${this.currentPath}/${Q}`:Q,Y=this.assets.filter((X)=>{let J=X.folderPath||"";return J===Z||J.startsWith(Z+"/")}).length;if(this.filenameSpan)this.filenameSpan.textContent=Q;if(this.typeSpan)this.typeSpan.textContent=_("Folder");if(this.sizeSpan)this.sizeSpan.textContent=`${Y} ${_("items")}`;if(this.dimensionsRow)this.dimensionsRow.style.display="none";if(this.dateSpan)this.dateSpan.textContent="-";if(this.urlInput)this.urlInput.value=Z;this.selectedFolder=Q,this.selectedFolderPath=Z,this.updateButtonStates()}renderList(Q=null){if(!this.listTbody)return;let Z=Q||this.filteredAssets,Y=!this.isSearchMode&&this.folders.length>0,X=Z.length>0;if(!Y&&!X){this.showEmptyState();return}if(this.hideEmptyState(),this.listTbody.innerHTML="",!this.isSearchMode)for(let J of this.folders){let W=this.createFolderListRow(J);this.listTbody.appendChild(W)}for(let J of Z){let W=this.createListRow(J);this.listTbody.appendChild(W)}}createFolderListRow(Q){let Z=document.createElement("tr");Z.className="media-library-folder-row",Z.dataset.folderName=Q;let Y=document.createElement("td");Y.className="col-thumb",Y.innerHTML='<div class="list-thumb-icon"><span class="exe-icon folder-icon">folder</span></div>',Z.appendChild(Y);let X=document.createElement("td");X.className="col-name",X.textContent=Q,Z.appendChild(X);let J=document.createElement("td");J.className="col-location d-none",Z.appendChild(J);let W=document.createElement("td");W.className="col-type",W.textContent=_("Folder"),Z.appendChild(W);let z=this.currentPath?`${this.currentPath}/${Q}`:Q,G=this.assets.filter((K)=>{let V=K.folderPath||"";return V===z||V.startsWith(z+"/")}).length,q=document.createElement("td");q.className="col-size",q.textContent=`${G} ${_("items")}`,Z.appendChild(q);let H=document.createElement("td");return H.className="col-date",H.textContent="-",Z.appendChild(H),Z.addEventListener("dblclick",()=>{this.enterFolder(Q)}),Z.addEventListener("click",()=>{if(this.selectedAsset=null,this.selectedAssets=[],this.listTbody)this.listTbody.querySelectorAll("tr").forEach((K)=>{K.classList.remove("selected")});Z.classList.add("selected"),this.showFolderSidebarContent(Q)}),Z}createListRow(Q){let Z=document.createElement("tr");Z.dataset.assetId=Q.id,Z.dataset.filename=Q.filename||"";let Y=this.assetManager.getBlobURLSynced?.(Q.id)??this.assetManager.blobURLCache.get(Q.id);if(!Y&&Q.blob)Y=URL.createObjectURL(Q.blob),this.assetManager.blobURLCache.set(Q.id,Y),this.assetManager.reverseBlobCache.set(Y,Q.id);else if(Y&&!this.assetManager.reverseBlobCache.has(Y))this.assetManager.reverseBlobCache.set(Y,Q.id);let X=document.createElement("td");if(X.className="col-thumb",Q.mime&&Q.mime.startsWith("image/"))X.innerHTML=`<img src="${Y}" alt="" loading="lazy">`;else{let K=this.getFileIcon(Q.mime,Q.filename);X.innerHTML=`<div class="list-thumb-icon"><span class="exe-icon">${K}</span></div>`}Z.appendChild(X);let J=document.createElement("td");if(J.className="col-name",this.showRefCount){let K=this.getAssetUsageCount(Q.id),V=K>0?"bg-primary":"bg-danger";J.innerHTML=`<span class="filename">${Q.filename||"Unknown"}</span> <span class="badge rounded-pill ${V} badge-sm">${K}</span>`}else J.textContent=Q.filename||"Unknown";Z.appendChild(J);let W=document.createElement("td");if(W.className=this.isSearchMode?"col-location":"col-location d-none",this.isSearchMode){let K=Q.folderPath?`/${Q.folderPath}`:"/";W.innerHTML=`
                <span class="location-link"
                      data-path="${this.escapeHtml(Q.folderPath||"")}"
                      title="${this.escapeHtml(K)}">
                    ${this.escapeHtml(K)}
                </span>`;let V=W.querySelector(".location-link");if(V)V.addEventListener("click",(R)=>{R.stopPropagation(),this.clearSearchAndNavigate(Q.folderPath||"")})}Z.appendChild(W);let z=document.createElement("td");z.className="col-type",z.textContent=this.getFileTypeLabel(Q.mime),Z.appendChild(z);let G=document.createElement("td");G.className="col-size",G.textContent=this.assetManager.formatFileSize(Q.size||0),Z.appendChild(G);let q=document.createElement("td");q.className="col-date";let H=Q.createdAt?new Date(Q.createdAt):null;return q.textContent=H?H.toLocaleDateString():"Unknown",Z.appendChild(q),Z.addEventListener("click",()=>{this.selectAssetInList(Q,Z)}),Z.addEventListener("dblclick",()=>{this.insertSelectedAsset()}),Z}getFileTypeLabel(Q){if(!Q)return"Unknown";if(Q.startsWith("image/"))return"Image";if(Q.startsWith("video/"))return"Video";if(Q.startsWith("audio/"))return"Audio";if(Q.includes("pdf"))return"PDF";return"File"}getFileIcon(Q,Z){if(Q){if(Q.startsWith("image/"))return"image";if(Q.startsWith("video/"))return"videocam";if(Q.startsWith("audio/"))return"audiotrack";if(Q==="application/pdf")return"picture_as_pdf";if(Q==="application/zip"||Q==="application/x-zip-compressed")return"folder_zip";if(Q==="model/stl"||Q==="application/sla")return"view_in_ar"}if(Z)switch(Z.split(".").pop()?.toLowerCase()){case"pdf":return"picture_as_pdf";case"zip":case"rar":case"7z":case"tar":case"gz":return"folder_zip";case"elp":case"elpx":return"school";case"stl":case"obj":case"fbx":case"gltf":case"glb":return"view_in_ar";case"doc":case"docx":case"odt":return"description";case"xls":case"xlsx":case"ods":case"csv":return"table_chart";case"ppt":case"pptx":case"odp":return"slideshow";case"txt":case"md":return"article";case"html":case"htm":case"xml":case"json":return"code";case"js":case"css":case"py":case"java":case"php":return"terminal";default:return"insert_drive_file"}return"insert_drive_file"}getAssetTypeCategory(Q){if(!Q)return"other";if(Q.startsWith("image/"))return"image";if(Q.startsWith("video/"))return"video";if(Q.startsWith("audio/"))return"audio";if(Q==="application/pdf")return"pdf";return"other"}updateFilterOptions(){if(!this.filterSelect)return;let Q=new Set;for(let X of this.assets){let J=this.getAssetTypeCategory(X.mime);Q.add(J)}this.filterSelect.innerHTML=`<option value="">${_("All")}</option>`;let Z={image:_("Images"),video:_("Videos"),audio:_("Audio"),pdf:_("PDF"),other:_("Other")},Y=["image","video","audio","pdf","other"];for(let X of Y)if(Q.has(X)){let J=document.createElement("option");J.value=X,J.textContent=Z[X]||X,this.filterSelect.appendChild(J)}if(this.typeFilter&&!Q.has(this.typeFilter))this.typeFilter="",this.filterSelect.value=""}async selectAssetInList(Q,Z){if(this.multiSelect){let Y=this.selectedAssets.findIndex((X)=>X.id===Q.id);if(Y>=0)this.selectedAssets.splice(Y,1),Z.classList.remove("selected");else this.selectedAssets.push(Q),Z.classList.add("selected");if(this.selectedAssets.length>0){let X=this.selectedAssets[this.selectedAssets.length-1];this.selectedAsset=X,await this.showSidebarContent(X)}else this.selectedAsset=null,this.showSidebarEmpty()}else{if(this.listTbody)this.listTbody.querySelectorAll("tr").forEach((Y)=>{Y.classList.remove("selected")});Z.classList.add("selected"),this.selectedAsset=Q,this.selectedAssets=[Q],await this.showSidebarContent(Q)}}createGridItem(Q){let Z=document.createElement("div");Z.className="media-library-item",Z.dataset.assetId=Q.id,Z.dataset.filename=Q.filename||"";let Y=this.assetManager.getBlobURLSynced?.(Q.id)??this.assetManager.blobURLCache.get(Q.id),X=!1;if(!Y&&Q.blob)Y=URL.createObjectURL(Q.blob),this.assetManager.blobURLCache.set(Q.id,Y),this.assetManager.reverseBlobCache.set(Y,Q.id);else if(!Y)Y=this.assetManager.generateLoadingPlaceholder(Q.id),X=!0,this.triggerAssetFetch(Q.id);else if(Y&&!this.assetManager.reverseBlobCache.has(Y))this.assetManager.reverseBlobCache.set(Y,Q.id);let J="";if(this.showRefCount){let q=this.getAssetUsageCount(Q.id);J=`<span class="position-absolute top-0 end-0 badge rounded-pill ${q>0?"bg-primary":"bg-danger"} m-2 shadow-sm">${q}</span>`}let W="";if(this.isSearchMode){let q=Q.folderPath?`/${Q.folderPath}`:"/";W=`
                <span class="item-path-badge text-truncate"
                      data-path="${this.escapeHtml(Q.folderPath||"")}"
                      title="${this.escapeHtml(q)}">
                    <span class="exe-icon">folder</span>
                    in ${this.escapeHtml(q)}
                </span>`}let z=X?` data-asset-id="${Q.id}" data-asset-loading="true"`:"";if(Q.mime&&Q.mime.startsWith("image/"))if(this.isSearchMode)Z.innerHTML=`
                    <img src="${Y}" alt="${this.escapeHtml(Q.filename||"Image")}" loading="lazy"${z}>
                    ${J}
                    <div class="item-info">
                        <span class="item-name text-truncate">${this.escapeHtml(Q.filename||"Image")}</span>
                        ${W}
                    </div>`;else Z.innerHTML=`<img src="${Y}" alt="${this.escapeHtml(Q.filename||"Image")}" loading="lazy"${z}>${J}`;else{let q=this.getFileIcon(Q.mime,Q.filename);if(this.isSearchMode)Z.innerHTML=`
                    <div class="media-thumbnail file-thumbnail">
                        <span class="exe-icon">${q}</span>
                    </div>
                    ${J}
                    <div class="item-info">
                        <span class="item-name text-truncate">${this.escapeHtml(Q.filename||"File")}</span>
                        ${W}
                    </div>`;else Z.innerHTML=`
                    <div class="media-thumbnail file-thumbnail">
                        <span class="exe-icon">${q}</span>
                        <span class="media-label">${this.escapeHtml(Q.filename||"File")}</span>
                    </div>${J}`}let G=Z.querySelector(".item-path-badge");if(G)G.addEventListener("click",(q)=>{q.stopPropagation(),this.clearSearchAndNavigate(Q.folderPath||"")});return Z.addEventListener("click",()=>{this.selectAsset(Q,Z)}),Z.addEventListener("dblclick",()=>{this.insertSelectedAsset()}),Z}triggerAssetFetch(Q){let Y=window.eXeLearning?.app?.project?._yjsBridge?.assetWebSocketHandler;if(Y&&!this.assetManager.pendingFetches?.has(Q))this.assetManager.pendingFetches?.add(Q),T.log(`[MediaLibrary] Fetching asset ${Q.substring(0,8)}... via WebSocket`),Y.requestAsset(Q).then((X)=>{if(X)this.assetManager.updateDomImagesForAsset(Q).catch((J)=>{console.warn(`[MediaLibrary] Failed to update DOM for ${Q.substring(0,8)}:`,J)}),T.log(`[MediaLibrary] Asset ${Q.substring(0,8)}... received via P2P`)}).catch((X)=>{console.error(`[MediaLibrary] Failed to fetch asset ${Q.substring(0,8)}:`,X)}).finally(()=>{this.assetManager.pendingFetches?.delete(Q)})}async selectAsset(Q,Z){if(this.multiSelect){let Y=this.selectedAssets.findIndex((X)=>X.id===Q.id);if(Y>=0)this.selectedAssets.splice(Y,1),Z.classList.remove("selected");else this.selectedAssets.push(Q),Z.classList.add("selected");if(this.selectedAssets.length>0){let X=this.selectedAssets[this.selectedAssets.length-1];this.selectedAsset=X,await this.showSidebarContent(X)}else this.selectedAsset=null,this.showSidebarEmpty()}else this.grid.querySelectorAll(".media-library-item").forEach((Y)=>{Y.classList.remove("selected")}),Z.classList.add("selected"),this.selectedAsset=Q,this.selectedAssets=[Q],await this.showSidebarContent(Q)}showEmptyState(){if(this.emptyState)this.emptyState.classList.add("visible");if(this.grid)this.grid.style.display="none";if(this.listContainer)this.listContainer.style.display="none"}hideEmptyState(){if(this.emptyState)this.emptyState.classList.remove("visible");if(this.viewMode==="grid"){if(this.grid)this.grid.style.display="grid";if(this.listContainer)this.listContainer.style.display="none"}else{if(this.grid)this.grid.style.display="none";if(this.listContainer)this.listContainer.style.display="flex"}}showSidebarEmpty(){if(this.sidebarEmpty)this.sidebarEmpty.style.display="block";if(this.sidebarContent)this.sidebarContent.style.display="none";this.updateButtonStates()}async showSidebarContent(Q){if(this.selectedFolder=null,this.selectedFolderPath=null,this.sidebarEmpty)this.sidebarEmpty.style.display="none";if(this.sidebarContent)this.sidebarContent.style.display="flex";let Z=this.assetManager.getBlobURLSynced?.(Q.id)??this.assetManager.blobURLCache.get(Q.id),Y=!1;if(!Z&&Q.blob)Z=URL.createObjectURL(Q.blob),this.assetManager.blobURLCache.set(Q.id,Z),this.assetManager.reverseBlobCache.set(Z,Q.id);else if(!Z)Z=this.assetManager.generateLoadingPlaceholder(Q.id),Y=!0,this.triggerAssetFetch(Q.id);else if(Z&&!this.assetManager.reverseBlobCache.has(Z))this.assetManager.reverseBlobCache.set(Z,Q.id);if(this.previewImg)this.previewImg.style.display="none";if(this.previewVideo)this.previewVideo.style.display="none";if(this.previewAudio)this.previewAudio.style.display="none";if(this.previewPdf)this.previewPdf.style.display="none";if(this.previewFile)this.previewFile.style.display="none";if(Q.mime&&Q.mime.startsWith("image/")){if(this.previewImg)if(this.previewImg.src=Z,this.previewImg.style.display="block",Y)this.previewImg.setAttribute("data-asset-id",Q.id),this.previewImg.setAttribute("data-asset-loading","true");else this.previewImg.removeAttribute("data-asset-id"),this.previewImg.removeAttribute("data-asset-loading")}else if(Q.mime&&Q.mime.startsWith("video/")){if(this.previewVideo)if(this.previewVideo.src=Z,this.previewVideo.style.display="block",Y)this.previewVideo.setAttribute("data-asset-id",Q.id),this.previewVideo.setAttribute("data-asset-loading","true");else this.previewVideo.removeAttribute("data-asset-id"),this.previewVideo.removeAttribute("data-asset-loading")}else if(Q.mime&&Q.mime.startsWith("audio/")){if(this.previewAudio)if(this.previewAudio.src=Z,this.previewAudio.style.display="block",Y)this.previewAudio.setAttribute("data-asset-id",Q.id),this.previewAudio.setAttribute("data-asset-loading","true");else this.previewAudio.removeAttribute("data-asset-id"),this.previewAudio.removeAttribute("data-asset-loading")}else if(Q.mime==="application/pdf"){if(this.previewPdf)if(this.previewPdf.src=Z,this.previewPdf.style.display="block",Y)this.previewPdf.setAttribute("data-asset-id",Q.id),this.previewPdf.setAttribute("data-asset-loading","true");else this.previewPdf.removeAttribute("data-asset-id"),this.previewPdf.removeAttribute("data-asset-loading")}else if(this.previewFile)this.previewFile.style.display="flex";if(this.filenameSpan)this.filenameSpan.textContent=Q.filename||"Unknown";if(this.typeSpan)this.typeSpan.textContent=Q.mime||"Unknown";if(this.sizeSpan)this.sizeSpan.textContent=this.assetManager.formatFileSize(Q.size||0);if(this.dateSpan){let X=Q.createdAt?new Date(Q.createdAt):null;this.dateSpan.textContent=X?X.toLocaleDateString():"Unknown"}if(this.usageSpan){let X=this.getAssetUsageCount(Q.id);this.usageSpan.textContent=`${X} iDevices`}if(this.urlInput)this.urlInput.value=this.assetManager.getAssetUrl(Q.id,Q.filename);if(this.dimensionsRow&&this.dimensionsSpan)if(Q.mime&&Q.mime.startsWith("image/")){this.dimensionsRow.style.display="flex";try{let X=await this.assetManager.getImageDimensions(Q.id);if(X)this.dimensionsSpan.textContent=`${X.width} x ${X.height} px`;else this.dimensionsSpan.textContent=_("Unknown")}catch(X){this.dimensionsSpan.textContent=_("Unknown")}}else this.dimensionsRow.style.display="none";if(this.locationRow&&this.locationValue){let X=Q.folderPath?`/${Q.folderPath}`:"/";this.locationRow.style.display="flex",this.locationValue.textContent=X,this.locationValue.title=X}this.updateButtonStates()}async uploadFiles(Q){if(!this.assetManager)return;T.log(`[MediaLibrary] uploadFiles: assetManager.projectId = ${this.assetManager.projectId}, folder = "${this.currentPath}"`);let Z=0;for(let Y of Q)try{T.log(`[MediaLibrary] Uploading: ${Y.name} to projectId: ${this.assetManager.projectId}, folder: "${this.currentPath}"`),await this.assetManager.insertImage(Y,{folderPath:this.currentPath}),Z++}catch(X){console.error(`[MediaLibrary] Failed to upload ${Y.name}:`,X)}if(Z>0)T.log(`[MediaLibrary] Uploaded ${Z} files to folder "${this.currentPath}"`),await this.loadAssets()}filterAssets(Q){this.currentPage=1,this.applyFiltersAndRender()}async deleteSelectedAsset(){if(!this.assetManager)return;if(this.selectedFolder&&this.selectedFolderPath){let X=this.selectedFolder,J=this.selectedFolderPath,W=this.assets.filter((G)=>{let q=G.folderPath||"";return q===J||q.startsWith(J+"/")}).length,z=W>0?_('Are you sure you want to delete the folder "%1" and all %2 files inside?').replace("%1",X).replace("%2",W):_('Are you sure you want to delete the empty folder "%1"?').replace("%1",X);if(!confirm(z))return;try{if(W>0)await this.assetManager.deleteFolderContents(J);this.createdFolders.delete(J);for(let G of this.createdFolders)if(G.startsWith(J+"/"))this.createdFolders.delete(G);T.log(`[MediaLibrary] Deleted folder: ${J} (${W} items)`),this.selectedFolder=null,this.selectedFolderPath=null,this.showSidebarEmpty(),await this.loadAssets()}catch(G){console.error("[MediaLibrary] Failed to delete folder:",G),alert(_("Failed to delete folder"))}return}if(!this.selectedAsset)return;let Q=this.selectedAsset.filename||"Unknown",Z=this.getAssetUsageCount(this.selectedAsset.id),Y=_('Delete "%1"?').replace("%1",Q);if(Z>0)Y+=`
`+_("This asset is referenced in %1 iDevices.").replace("%1",Z);if(!confirm(Y))return;try{await this.assetManager.deleteAsset(this.selectedAsset.id),T.log(`[MediaLibrary] Deleted asset: ${this.selectedAsset.id}`),await this.loadAssets()}catch(X){console.error("[MediaLibrary] Failed to delete asset:",X),alert(_("Failed to delete file"))}}async renameSelectedAsset(){if(!this.assetManager)return;if(this.selectedFolder&&this.selectedFolderPath){let Y=this.selectedFolder,X=prompt(_("Enter new folder name:"),Y);if(!X||X===Y)return;if(!this.isValidFolderName(X)){alert(_('Invalid folder name. Avoid special characters like / \\ : * ? " < > |'));return}if(this.folders.includes(X)){alert(_("A folder with this name already exists."));return}try{let J=this.selectedFolderPath,W=this.currentPath,z=W?`${W}/${X}`:X;if(await this.assetManager.renameFolder(J,z),T.log(`[MediaLibrary] Renamed folder: ${J} to ${z}`),this.createdFolders.has(J))this.createdFolders.delete(J),this.createdFolders.add(z);for(let G of[...this.createdFolders])if(G.startsWith(J+"/"))this.createdFolders.delete(G),this.createdFolders.add(z+G.slice(J.length));if(this.selectedFolder=X,this.selectedFolderPath=z,this.filenameSpan)this.filenameSpan.textContent=X;if(this.urlInput)this.urlInput.value=z;await this.loadAssets()}catch(J){console.error("[MediaLibrary] Failed to rename folder:",J),alert(_("Failed to rename folder"))}return}if(!this.selectedAsset)return;let Q=this.selectedAsset.filename||"",Z=prompt(_("Enter new filename:"),Q);if(!Z||Z===Q)return;if(!this.isValidFolderName(Z)){alert(_('Invalid filename. Avoid special characters like / \\ : * ? " < > |'));return}try{if(await this.assetManager.renameAsset(this.selectedAsset.id,Z),T.log(`[MediaLibrary] Renamed asset: ${this.selectedAsset.id} to ${Z}`),this.selectedAsset.filename=Z,this.filenameSpan)this.filenameSpan.textContent=Z;if(this.urlInput)this.urlInput.value=this.assetManager.getAssetUrl(this.selectedAsset.id,Z);await this.loadAssets()}catch(Y){console.error("[MediaLibrary] Failed to rename asset:",Y),alert(_("Failed to rename file"))}}countAssetReferences(Q){if(!Q)return 0;try{let Z=window.eXeLearning?.app?.project?._yjsBridge;if(!Z?.documentManager?.ydoc)return 0;let Y=Z.documentManager.ydoc.getArray("navigation");if(!Y)return 0;let X=0,J=new RegExp(`asset://${Q}`,"gi");for(let W=0;W<Y.length;W++){let z=Y.get(W);if(!z)continue;let G=z.get("blocks");if(!G)continue;for(let q=0;q<G.length;q++){let H=G.get(q);if(!H)continue;let K=H.get("components");if(!K)continue;for(let V=0;V<K.length;V++){let R=K.get(V);if(!R)continue;let O=!1,A=R.get("htmlView")||R.get("htmlContent");if(A){let M=A.toString?A.toString():String(A);if(J.test(M))O=!0;J.lastIndex=0}if(!O){let M=R.get("jsonProperties")||R.get("ideviceProperties");if(M){let F=JSON.stringify(M.toJSON?M.toJSON():M);if(J.test(F))O=!0;J.lastIndex=0}}if(!O){let M=R.get("properties");if(M){let F=JSON.stringify(M.toJSON?M.toJSON():M);if(J.test(F))O=!0;J.lastIndex=0}}if(O)X++}}}return X}catch(Z){return T.warn("[MediaLibrary] Error counting asset references:",Z),0}}calculateAllAssetUsages(){this.assetUsageCounts.clear();for(let Q of this.assets)if(Q.id){let Z=this.countAssetReferences(Q.id);this.assetUsageCounts.set(Q.id,Z)}}getAssetUsageCount(Q){if(this.assetUsageCounts.has(Q))return this.assetUsageCounts.get(Q);let Z=this.countAssetReferences(Q);return this.assetUsageCounts.set(Q,Z),Z}generateUniqueCopyName(Q,Z){let Y=Q.lastIndexOf(".")>0?Q.substring(Q.lastIndexOf(".")):"",X=Y?Q.substring(0,Q.lastIndexOf(".")):Q,J=_("copy"),W=new Set(Z.map((q)=>q.toLowerCase())),z=`${X} (${J})${Y}`;if(!W.has(z.toLowerCase()))return z;let G=1;while(G<1000){if(z=`${X} (${J}) (${G})${Y}`,!W.has(z.toLowerCase()))return z;G++}return`${X} (${J}) (${Date.now()})${Y}`}async duplicateSelectedAsset(){if(!this.selectedAsset||!this.assetManager)return;try{let Q=this.selectedAsset,Z=Q.blob;if(!Z)Z=(await this.assetManager.getAsset(Q.id))?.blob;if(!Z){alert(_("Could not read file"));return}let Y=Q.folderPath||"",J=this.assets.filter((V)=>(V.folderPath||"")===Y).map((V)=>V.filename||""),W=Q.filename||"file",z=this.generateUniqueCopyName(W,J),G=prompt(_("Enter name for the duplicate:"),z);if(G===null)return;let q=G.trim();if(!q){alert(_("Please enter a valid filename"));return}if(new Set(J.map((V)=>V.toLowerCase())).has(q.toLowerCase())){alert(_("A file with this name already exists in this folder"));return}let K=new File([Z],q,{type:Q.mime||"application/octet-stream"});await this.assetManager.insertImage(K,{folderPath:Y,forceNewId:!0}),T.log(`[MediaLibrary] Duplicated asset: ${Q.id} as ${q}`),await this.loadAssets()}catch(Q){console.error("[MediaLibrary] Failed to duplicate asset:",Q),alert(_("Failed to duplicate file"))}}showMoveDialog(){if(!this.folderPicker)return;if(!this.selectedAsset&&!this.selectedFolderPath)return;this.buildFolderPickerList(),this.folderPicker.style.display="flex",this.selectedMoveTarget=null}hideFolderPicker(){if(this.folderPicker)this.folderPicker.style.display="none";this.selectedMoveTarget=null}buildFolderPickerList(){if(!this.folderPickerList)return;let Q=!!this.selectedFolderPath,Z=this.selectedFolderPath||null,Y=new Set([""]);for(let z of this.assets){let G=z.folderPath||"";if(G){Y.add(G);let q=G.split("/");for(let H=1;H<q.length;H++)Y.add(q.slice(0,H).join("/"))}}if(this.createdFolders){for(let z of this.createdFolders)if(z){Y.add(z);let G=z.split("/");for(let q=1;q<G.length;q++)Y.add(G.slice(0,q).join("/"))}}let X=Array.from(Y).sort((z,G)=>{if(z==="")return-1;if(G==="")return 1;return z.localeCompare(G)});if(Q)X=X.filter((z)=>{if(z===Z)return!1;if(z.startsWith(Z+"/"))return!1;return!0});let J;if(Q){let z=Z.split("/");z.pop(),J=z.join("/")}else J=this.selectedAsset?.folderPath||"";let W="";for(let z of X){let G=z===""?_("Root"):z.split("/").pop(),q=z===""?0:z.split("/").length,H=z===J;W+=`<div class="folder-picker-item${H?" current":""}"
                          data-path="${this.escapeHtml(z)}"
                          style="padding-left: ${12+q*16}px">
                <span class="exe-icon">folder</span>
                <span class="folder-picker-name">${this.escapeHtml(G)}</span>
                ${H?`<span class="folder-picker-current">(${_("current")})</span>`:""}
            </div>`}this.folderPickerList.innerHTML=W,this.folderPickerList.querySelectorAll(".folder-picker-item").forEach((z)=>{z.addEventListener("click",()=>{this.folderPickerList.querySelectorAll(".folder-picker-item").forEach((G)=>{G.classList.remove("selected")}),z.classList.add("selected"),this.selectedMoveTarget=z.dataset.path})})}async confirmMove(){if(this.selectedMoveTarget===null||this.selectedMoveTarget===void 0){alert(_("Please select a destination folder"));return}if(!this.assetManager){this.hideFolderPicker();return}let Q=this.selectedMoveTarget;if(this.selectedFolderPath){let Y=this.selectedFolderPath,X=this.selectedFolder,J=Y.split("/");if(J.pop(),J.join("/")===Q){alert(_("Folder is already in this location"));return}let z=Q?`${Q}/${X}`:X;if(this.deriveSubfolders(this.assets,Q).includes(X)){alert(_("A folder with this name already exists in the destination."));return}try{await this.assetManager.moveFolder(Y,Q),T.log(`[MediaLibrary] Moved folder ${Y} to ${z}`),this.selectedFolder=null,this.selectedFolderPath=null,this.hideFolderPicker(),this.showSidebarEmpty(),await this.loadAssets()}catch(q){console.error("[MediaLibrary] Failed to move folder:",q),alert(_("Failed to move folder"))}return}if(!this.selectedAsset){this.hideFolderPicker();return}let Z=this.selectedAsset.folderPath||"";if(Z===Q){alert(_("File is already in this folder"));return}try{await this.assetManager.updateAssetFolderPath(this.selectedAsset.id,Q),T.log(`[MediaLibrary] Moved asset ${this.selectedAsset.id} from "${Z}" to "${Q}"`),this.hideFolderPicker(),await this.loadAssets()}catch(Y){console.error("[MediaLibrary] Failed to move asset:",Y),alert(_("Failed to move file"))}}async insertSelectedAsset(){let Q=this.multiSelect?this.selectedAssets:this.selectedAsset?[this.selectedAsset]:[];if(Q.length===0)return;if(this.onSelectCallback){let X=[];for(let J of Q){let W=this.assetManager.getAssetUrl(J.id,J.filename),z=this.assetManager.getBlobURLSynced?.(J.id)??this.assetManager.blobURLCache.get(J.id);if(!z&&J.blob)z=URL.createObjectURL(J.blob),this.assetManager.blobURLCache.set(J.id,z),this.assetManager.reverseBlobCache.set(z,J.id);else if(z&&!this.assetManager.reverseBlobCache.has(z))this.assetManager.reverseBlobCache.set(z,J.id);if(J.mime==="text/html"||J.filename&&/\.html?$/i.test(J.filename))try{let G=await this.assetManager.resolveHtmlWithAssets(J.id);if(G)z=G}catch(G){console.warn("[MediaLibrary] Failed to resolve HTML with assets:",G)}X.push({assetUrl:W,blobUrl:z,asset:J})}if(this.multiSelect)this.onSelectCallback(X);else this.onSelectCallback(X[0]);this.close();return}let Z=this.assetManager.getAssetUrl(this.selectedAsset.id,this.selectedAsset.filename),Y=window.tinymce?.activeEditor;if(Y){let X=this.assetManager.getBlobURLSynced?.(this.selectedAsset.id)??this.assetManager.blobURLCache.get(this.selectedAsset.id);if(!X&&this.selectedAsset.blob)X=URL.createObjectURL(this.selectedAsset.blob),this.assetManager.blobURLCache.set(this.selectedAsset.id,X),this.assetManager.reverseBlobCache.set(X,this.selectedAsset.id);else if(X&&!this.assetManager.reverseBlobCache.has(X))this.assetManager.reverseBlobCache.set(X,this.selectedAsset.id);if(this.selectedAsset.mime&&this.selectedAsset.mime.startsWith("image/"))Y.insertContent(`<img src="${X}" alt="${this.selectedAsset.filename||""}" data-asset-url="${Z}">`);else if(this.selectedAsset.mime&&this.selectedAsset.mime.startsWith("video/"))Y.insertContent(`<video src="${X}" controls data-asset-url="${Z}"></video>`);else if(this.selectedAsset.mime&&this.selectedAsset.mime.startsWith("audio/"))Y.insertContent(`<audio src="${X}" controls data-asset-url="${Z}"></audio>`);else if(this.selectedAsset.mime==="application/pdf")Y.insertContent(`<iframe src="${Z}" data-mce-pdf="true" style="width:100%; height:600px; border:1px solid #ccc;"></iframe>`);else if(this.selectedAsset.mime==="text/html"||this.selectedAsset.filename&&/\.html?$/i.test(this.selectedAsset.filename))Y.insertContent(`<iframe src="${Z}" data-mce-html="true" style="width:100%; height:600px; border:1px solid #ccc;"></iframe>`);else Y.insertContent(`<a href="${X}" data-asset-url="${Z}">${this.selectedAsset.filename||"File"}</a>`);T.log(`[MediaLibrary] Inserted asset into editor: ${this.selectedAsset.id}`),this.close()}else if(console.warn("[MediaLibrary] No active editor to insert into"),navigator.clipboard)navigator.clipboard.writeText(Z),alert(_("Asset URL copied to clipboard"))}downloadSelectedAsset(){if(!this.selectedAsset)return;let Q=this.selectedAsset,Z=this.assetManager?.getBlobURLSynced?.(Q.id)??this.assetManager?.blobURLCache.get(Q.id);if(!Z&&Q.blob)Z=URL.createObjectURL(Q.blob);if(!Z){console.error("[MediaLibrary] No blob URL available for download");return}let Y=document.createElement("a");Y.href=Z,Y.download=Q.filename||"download",document.body.appendChild(Y),Y.click(),document.body.removeChild(Y),T.log(`[MediaLibrary] Downloaded asset: ${Q.id}`)}copyAssetUrl(){if(!this.selectedAsset)return;let Q=this.selectedAsset,Z=this.assetManager.getAssetUrl(Q.id,Q.filename);if(navigator.clipboard)navigator.clipboard.writeText(Z).then(()=>{T.log(`[MediaLibrary] Copied URL to clipboard: ${Z}`)}).catch((Y)=>{console.error("[MediaLibrary] Failed to copy URL:",Y)})}viewFullSize(){if(!this.selectedAsset)return;let Q=this.selectedAsset,Z=this.assetManager?.getBlobURLSynced?.(Q.id)??this.assetManager?.blobURLCache.get(Q.id);if(!Z&&Q.blob)Z=URL.createObjectURL(Q.blob);if(!Z){console.error("[MediaLibrary] No blob URL available for full size view");return}window.open(Z,"_blank"),T.log(`[MediaLibrary] Opened asset in new tab: ${Q.id}`)}async extractZipAsset(){if(!this.selectedAsset||!this.assetManager)return;let Q=this.selectedAsset;if(!(Q.mime==="application/zip"||Q.mime==="application/x-zip-compressed"||Q.filename?.toLowerCase().endsWith(".zip"))){console.warn("[MediaLibrary] Selected file is not a ZIP");return}let X=(Q.filename||"archive").replace(/\.zip$/i,""),J=prompt(_("Extract to folder:")+`

`+_("The internal folder structure of the ZIP will be preserved."),X);if(J===null)return;if(J&&!this.isValidFolderName(J)){alert(_('Invalid folder name. Avoid special characters like / \\ : * ? " < > |'));return}let W=J?this.currentPath?`${this.currentPath}/${J}`:J:this.currentPath;try{let z=Q.blob;if(!z)z=(await this.assetManager.getAsset(Q.id))?.blob;if(!z){alert(_("Could not read ZIP file"));return}if(!window.fflate){alert(_("ZIP extraction is not available"));return}if(this.moreBtn)this.moreBtn.disabled=!0;let G=await z.arrayBuffer(),q=new Uint8Array(G),H=window.fflate.unzipSync(q),K=Object.keys(H),V=0,R=0;for(let O of K){let A=H[O];if(!A||A.length===0)continue;let M=O.split("/"),F=M.pop();if(!F||F.startsWith(".")||F.startsWith("__")){R++;continue}if(M.some((L)=>L.startsWith("__")||L.startsWith("."))){R++;continue}let U=W;if(M.length>0){let L=M.join("/");U=W?`${W}/${L}`:L}try{let L=this.getMimeTypeFromFilename(F),D=new Blob([A],{type:L}),B=new File([D],F,{type:L});await this.assetManager.insertImage(B,{folderPath:U}),V++,T.log(`[MediaLibrary] Extracted: ${U}/${F}`)}catch(L){console.error(`[MediaLibrary] Failed to extract ${O}:`,L),R++}}if(this.moreBtn)this.moreBtn.disabled=!1;if(V>0)T.log(`[MediaLibrary] Extracted ${V} files from ZIP to "${W}"`),await this.loadAssets();if(R>0)alert(_("Extracted %1 files. %2 files were skipped.").replace("%1",V).replace("%2",R));else if(V>0)alert(_("Extracted %1 files successfully.").replace("%1",V));else alert(_("No files were extracted from the ZIP."))}catch(z){if(console.error("[MediaLibrary] Failed to extract ZIP:",z),alert(_("Failed to extract ZIP file")),this.moreBtn)this.moreBtn.disabled=!1}}getMimeTypeFromFilename(Q){let Z=Q.split(".").pop()?.toLowerCase();return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",ico:"image/x-icon",bmp:"image/bmp",mp4:"video/mp4",webm:"video/webm",ogv:"video/ogg",mov:"video/quicktime",avi:"video/x-msvideo",mp3:"audio/mpeg",wav:"audio/wav",oga:"audio/ogg",ogg:"audio/ogg",flac:"audio/flac",m4a:"audio/mp4",pdf:"application/pdf",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",zip:"application/zip",json:"application/json",xml:"application/xml",html:"text/html",css:"text/css",js:"application/javascript",txt:"text/plain",md:"text/markdown",csv:"text/csv",stl:"model/stl"}[Z]||"application/octet-stream"}initDragAndDrop(){let Q=this.modalElement.querySelector(".media-library-main");if(!Q)return;let Z=0;["dragenter","dragover","dragleave","drop"].forEach((Y)=>{Q.addEventListener(Y,(X)=>{X.preventDefault(),X.stopPropagation()})}),Q.addEventListener("dragenter",(Y)=>{if(Z++,Z===1){if(Q.classList.add("drag-over"),!this.emptyState?.classList.contains("visible"))this.showDropzoneOverlay(Q)}}),Q.addEventListener("dragleave",(Y)=>{if(Z--,Z===0)Q.classList.remove("drag-over"),this.hideDropzoneOverlay(Q)}),Q.addEventListener("drop",async(Y)=>{Z=0,Q.classList.remove("drag-over"),this.hideDropzoneOverlay(Q);let X=Y.dataTransfer?.files;if(X&&X.length>0)await this.uploadFiles(X)})}showDropzoneOverlay(Q){this.hideDropzoneOverlay(Q);let Z=document.createElement("div");Z.className="media-library-dropzone-overlay",Z.innerHTML=`<p>${_("Drop files here to upload")}</p>`,Q.appendChild(Z)}hideDropzoneOverlay(Q){let Z=Q.querySelector(".media-library-dropzone-overlay");if(Z)Z.remove()}close(Q){if(this._unsubscribeFromYjsChanges(),this.previewVideo)this.previewVideo.pause(),this.previewVideo.src="";if(this.previewAudio)this.previewAudio.pause(),this.previewAudio.src="";if(this.selectedAsset=null,this.selectedAssets=[],this.selectedFolder=null,this.selectedFolderPath=null,this.multiSelect=!1,this.onSelectCallback=null,this.acceptFilter=null,this.typeFilter="",this.currentPath="",this.folders=[],this.createdFolders.clear(),this.searchInput)this.searchInput.value="";if(this.filterSelect)this.filterSelect.value="";this.currentPage=1,super.close(Q)}}function x2(Q){let Z=[],Y=Q,X=0,J=!1,W=!1,z=0;for(let G=0;G<Y.length;G++){let q=Y[G];if(W){W=!1;continue}if(q==="\\"&&J){W=!0;continue}if(q==='"'&&!W){J=!J;continue}if(J)continue;if(q==="{"){if(X===0)z=G;X++}else if(q==="}"){if(X--,X===0){let H=Y.substring(z,G+1);try{let K=JSON.parse(H);if(typeof K.data==="string")try{K.data=JSON.parse(K.data)}catch{}Z.push(K)}catch(K){console.warn("[SSEClient] Failed to parse JSON:",H,K)}z=G+1}}}return Y=Y.substring(z),{parsed:Z,remaining:Y}}async function*p2(Q,Z,Y={}){let{signal:X}=Y,J=await fetch(Q,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Z),signal:X});if(!J.ok)throw Error(`HTTP ${J.status}: ${J.statusText}`);let W=J.body.getReader(),z=new TextDecoder,G="";try{while(!0){let{done:q,value:H}=await W.read();if(q){if(G.trim()){let{parsed:R}=x2(G);for(let O of R)yield O}break}G+=z.decode(H,{stream:!0});let{parsed:K,remaining:V}=x2(G);G=V;for(let R of K)yield R}}finally{W.releaseLock()}}class c0{static createStream(Q,Z,Y={}){let{onEvent:X,onComplete:J,onError:W}=Y,z=new AbortController;return(async()=>{try{for await(let q of p2(Q,Z,{signal:z.signal}))if(X)X(q);if(J)J()}catch(q){if(q.name==="AbortError"){if(J)J({cancelled:!0})}else if(W)W(q);else console.error("[SSEClient] Stream error:",q)}})(),{cancel:()=>z.abort()}}}class p0{constructor(){this.links=new Map,this.streamHandle=null,this.isValidating=!1,this.isCancelled=!1,this.onLinksExtracted=null,this.onLinkUpdate=null,this.onProgress=null,this.onComplete=null,this.onError=null}async startValidation(Q){if(this.isValidating){console.warn("[LinkValidationManager] Validation already in progress");return}this.isValidating=!0,this.isCancelled=!1,this.links.clear();try{let Z=await this._extractLinks(Q);if(!Z||!Z.links)throw Error("Failed to extract links");for(let Y of Z.links)this.links.set(Y.id,{...Y,status:"pending",error:null});if(this.onLinksExtracted)this.onLinksExtracted(this.getAllLinks(),this.getStats());if(Z.links.length===0){if(this.isValidating=!1,this.onComplete)this.onComplete(this.getStats(),this.isCancelled);return}await this._validateLinksStream(Z.links)}catch(Z){if(this.isValidating=!1,this.onError)this.onError(Z);else console.error("[LinkValidationManager] Error:",Z)}}async _extractLinks(Q){let Z=eXeLearning?.app?.project?.odeSession;return await eXeLearning.app.api.extractLinksForValidation({odeSessionId:Z,idevices:Q})}async _validateLinksStream(Q){return new Promise((Z,Y)=>{let X=eXeLearning.app.api.getLinkValidationStreamUrl();if(!X){console.log("[LinkValidationManager] No validation stream URL available - skipping server validation"),this.isValidating=!1;for(let J of this.links.values()){if(J.status="valid",J.error=null,this.onLinkUpdate)this.onLinkUpdate(J.id,J.status,J.error,J);if(this.onProgress)this.onProgress(this.getStats())}if(this.onComplete)this.onComplete(this.getStats(),!1);Z();return}this.streamHandle=c0.createStream(X,{links:Q},{onEvent:(J)=>this._handleStreamEvent(J),onComplete:(J)=>{if(this.isValidating=!1,this.streamHandle=null,J?.cancelled)this.isCancelled=!0;if(this.onComplete)this.onComplete(this.getStats(),this.isCancelled);Z()},onError:(J)=>{this.isValidating=!1,this.streamHandle=null,Y(J)}})})}_handleStreamEvent(Q){if(Q.event==="link-validated"){let{id:Z,status:Y,error:X}=Q.data,J=this.links.get(Z);if(J){if(J.status=Y,J.error=X,this.onLinkUpdate)this.onLinkUpdate(Z,Y,X,J);if(this.onProgress)this.onProgress(this.getStats())}}else if(Q.event==="done");}cancel(){if(this.streamHandle)this.streamHandle.cancel(),this.streamHandle=null;this.isCancelled=!0}getStats(){let Q=0,Z=0,Y=0;for(let W of this.links.values())switch(W.status){case"valid":Q++;break;case"broken":Z++;break;case"pending":case"validating":Y++;break}let X=this.links.size,J=Q+Z;return{total:X,validated:J,valid:Q,broken:Z,pending:Y}}getAllLinks(){return Array.from(this.links.values())}getBrokenLinks(){return this.getAllLinks().filter((Q)=>Q.status==="broken")}getValidLinks(){return this.getAllLinks().filter((Q)=>Q.status==="valid")}getLinkById(Q){return this.links.get(Q)}isInProgress(){return this.isValidating}wasCancelled(){return this.isCancelled}reset(){this.cancel(),this.links.clear(),this.isValidating=!1,this.isCancelled=!1}toExportFormat(Q=!0){return(Q?this.getBrokenLinks():this.getAllLinks()).map((Y)=>({brokenLinks:Y.url,brokenLinksError:Y.error||"",nTimesBrokenLinks:Y.count,pageNamesBrokenLinks:Y.pageName,blockNamesBrokenLinks:Y.blockName,typeComponentSyncBrokenLinks:Y.ideviceType,orderComponentSyncBrokenLinks:Y.order}))}}class l0 extends x{constructor(Q){super(Q,"modalOdeBrokenLinks",void 0,!1);this.confirmButtonDefaultText=_("Download CSV"),this.cancelButtonDefaultText=_("Cancel"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary"),this.linkManager=null,this.progressContainer=null,this.tableBody=null,this.rowElements=new Map}makeTheadElements(){let Q=document.createElement("thead"),Z=document.createElement("tr"),Y=[_("Status"),_("Link"),_("Error"),_("Times"),_("Page name"),_("Block name"),_("iDevice"),_("Position")];for(let X of Y){let J=document.createElement("th");J.textContent=X,Z.appendChild(J)}return Q.appendChild(Z),Q}createLinkRow(Q){let Z=document.createElement("tr");Z.dataset.linkId=Q.id;let Y=document.createElement("td");Y.className="link-status text-center",Y.innerHTML=this.getStatusHtml(Q.status,Q.error),Z.appendChild(Y);let X=document.createElement("td");X.className="link-url",X.textContent=Q.url,X.title=Q.url,X.style.maxWidth="300px",X.style.overflow="hidden",X.style.textOverflow="ellipsis",X.style.whiteSpace="nowrap",Z.appendChild(X);let J=document.createElement("td");J.className="link-error",J.textContent=Q.error||"",Z.appendChild(J);let W=document.createElement("td");W.textContent=Q.count||"",Z.appendChild(W);let z=document.createElement("td");z.textContent=Q.pageName||"",Z.appendChild(z);let G=document.createElement("td");G.textContent=Q.blockName||"",Z.appendChild(G);let q=document.createElement("td");q.textContent=Q.ideviceType||"",Z.appendChild(q);let H=document.createElement("td");return H.textContent=Q.order||"",Z.appendChild(H),Z}getStatusHtml(Q,Z){switch(Q){case"pending":case"validating":return`<span class="spinner-border spinner-border-sm text-secondary" role="status" aria-label="${_("Validating")}"></span>`;case"valid":return`<span class="text-success" title="${_("Valid")}">&#10003;</span>`;case"broken":return`<span class="text-danger" title="${Z||_("Error")}">&#10007;</span>`;default:return""}}createProgressHtml(){return`
            <div class="validation-progress mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="progress-text text-muted">${_("Validating links...")}</small>
                    <small class="progress-stats text-muted">0 / 0</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        `}updateProgress(Q){if(!this.progressContainer)return;let Z=this.progressContainer.querySelector(".progress-bar"),Y=this.progressContainer.querySelector(".progress-stats"),X=this.progressContainer.querySelector(".progress-text"),J=Q.total>0?Math.round(Q.validated/Q.total*100):0;if(Z)Z.style.width=`${J}%`;if(Y)Y.textContent=`${Q.validated} / ${Q.total}`;if(X&&Q.validated===Q.total){let W=Q.broken>0?`${Q.broken} ${_("broken")}`:_("No broken links");X.textContent=`${_("Complete")}: ${W}`,X.classList.remove("text-muted"),X.classList.add(Q.broken>0?"text-danger":"text-success")}}updateLinkRow(Q,Z,Y){let X=this.rowElements.get(Q);if(!X)return;let J=X.querySelector(".link-status");if(J)J.innerHTML=this.getStatusHtml(Z,Y);let W=X.querySelector(".link-error");if(W)W.textContent=Y||"";if(Z==="broken")X.classList.add("table-danger")}buildBody(Q){let Z=document.createElement("div");this.progressContainer=document.createElement("div"),this.progressContainer.innerHTML=this.createProgressHtml(),Z.appendChild(this.progressContainer);let Y=document.createElement("table");if(Y.className="table table-striped table-sm",Y.appendChild(this.makeTheadElements()),this.tableBody=document.createElement("tbody"),this.rowElements.clear(),Q.length===0){let J=document.createElement("tr"),W=document.createElement("td");W.colSpan=8,W.className="text-center text-muted",W.textContent=_("No links found in content"),J.appendChild(W),this.tableBody.appendChild(J)}else for(let J of Q){let W=this.createLinkRow(J);this.rowElements.set(J.id,W),this.tableBody.appendChild(W)}Y.appendChild(this.tableBody);let X=document.createElement("div");return X.style.maxHeight="400px",X.style.overflowY="auto",X.appendChild(Y),Z.appendChild(X),Z}show(Q){this.titleDefault=_("Link Validation");let Z=this.manager.closeModals()?500:50;setTimeout(()=>{if(this.setTitle(this.titleDefault),this.confirmButton)this.confirmButton.disabled=!0,this.confirmButton.textContent=_("Download CSV");this.linkManager=new p0,this.linkManager.onLinksExtracted=(Y,X)=>{let J=this.buildBody(Y);this.setBody(J.innerHTML);let W=this.modalElement.querySelectorAll("tbody tr[data-link-id]");this.rowElements.clear(),W.forEach((z)=>{this.rowElements.set(z.dataset.linkId,z)}),this.progressContainer=this.modalElement.querySelector(".validation-progress"),this.updateProgress(X)},this.linkManager.onLinkUpdate=(Y,X,J)=>{this.updateLinkRow(Y,X,J)},this.linkManager.onProgress=(Y)=>{this.updateProgress(Y)},this.linkManager.onComplete=(Y,X)=>{if(this.confirmButton)this.confirmButton.disabled=!1;if(this.updateProgress(Y),this.progressContainer&&!X)setTimeout(()=>{let J=this.progressContainer.querySelector(".progress");if(J)J.style.display="none"},1000)},this.linkManager.onError=(Y)=>{console.error("[ModalOdeBrokenLinks] Validation error:",Y),eXeLearning.app.alerts.showToast({type:"error",message:_("Error validating links")})},this.setConfirmExec(()=>{this.downloadCsv()}),this.setCancelExec(()=>{if(this.linkManager&&this.linkManager.isInProgress())this.linkManager.cancel()}),this.modal.show(),this.linkManager.startValidation(Q||[])},Z)}downloadCsv(){this.preventCloseModal=!0;let Q=this.modalElement.querySelector("table");if(!Q){console.warn("[ModalOdeBrokenLinks] No table found for CSV export");return}let Z=Q.querySelectorAll("tbody tr.table-danger");if(Z.length===0){eXeLearning.app.alerts.showToast({type:"info",message:_("No broken links to export")});return}let Y=document.createElement("table"),X=Q.querySelector("thead");if(X)Y.appendChild(X.cloneNode(!0));let J=document.createElement("tbody");Z.forEach((z)=>{J.appendChild(z.cloneNode(!0))}),Y.appendChild(J);let W=this.tableToCSV(Y,{skipColumns:[0]});this.downloadCSVFile(W,"BrokenLinks.csv")}onHide(){if(this.linkManager)this.linkManager.cancel(),this.linkManager=null;this.rowElements.clear(),this.progressContainer=null,this.tableBody=null}}class d0 extends x{constructor(Q){let Z="modalOdeUsedFiles",Y;super(Q,Z,Y,!1);this.confirmButtonDefaultText=_("End"),this.cancelButtonDefaultText=_("Cancel"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary")}makeTheadElements(){let Q=document.createElement("thead"),Z=[_("File"),_("Path"),_("Size"),_("Page name"),_("Block name"),_("iDevice"),_("Position")];for(let Y=0;Y<Z.length;Y++){let X=document.createElement("th");X.textContent=_(Z[Y]),Q.appendChild(X)}return Q}createPathLink(Q){if(!Q){let X=document.createElement("span");return X.textContent="",X}let Z=Q.match(/asset:\/\/([a-f0-9-]+)/i);if(Z){let X=Z[1],J=document.createElement("a");return J.href="#",J.textContent=Q,J.title=_("Click to open resource in new window"),J.style.cursor="pointer",J.onclick=async(W)=>{W.preventDefault(),await this.openAssetInNewWindow(X)},J}if(Q.startsWith("/")||Q.startsWith("http")){let X=document.createElement("a");return X.href=Q,X.textContent=Q,X.target="_blank",X.rel="noopener noreferrer",X.title=_("Click to open resource in new window"),X}let Y=document.createElement("span");return Y.textContent=Q,Y}async openAssetInNewWindow(Q){try{let Z=eXeLearning.app.project?._yjsBridge?.assetManager;if(!Z){console.error("[ModalOdeUsedFiles] AssetManager not available"),alert(_("Cannot open resource: Asset manager not available"));return}let Y=await Z.getAsset(Q);if(!Y||!Y.blob){console.error(`[ModalOdeUsedFiles] Asset not found: ${Q}`),alert(_("Cannot open resource: Asset not found"));return}let X=await Z.createBlobURL(Y.blob);window.open(X,"_blank")}catch(Z){console.error("[ModalOdeUsedFiles] Error opening asset:",Z),alert(_("Error opening resource"))}}makeTbodyElements(Q){let Z,Y=document.createElement("tbody"),X=Q.usedFiles;for(Z=0;Z<X.length;Z++){let J=[X[Z].usedFiles,X[Z].usedFilesPath,X[Z].usedFilesSize,X[Z].pageNamesUsedFiles,X[Z].blockNamesUsedFiles,X[Z].typeComponentSyncUsedFiles,X[Z].orderComponentSyncUsedFiles],W=document.createElement("tr");for(let z=0;z<J.length;z++){let G=document.createElement("td");if(z===1)G.appendChild(this.createPathLink(J[z]));else G.textContent=J[z];W.appendChild(G)}Y.appendChild(W)}return Y}makeOdeListElements(Q){let Z=document.createElement("table"),Y=this.makeTheadElements(),X=this.makeTbodyElements(Q);return Z.appendChild(Y),Z.appendChild(X),Z.classList.add("table"),Z.classList.add("table-striped"),Z}setBodyElement(Q){this.modalElementBody.innerHTML="",this.modalElementBody.appendChild(Q)}show(Q){this.titleDefault=_("Resource Report");let Z=this.manager.closeModals()?500:50;setTimeout(()=>{Q=Q?Q:{};let Y=Q.title?Q.title:this.titleDefault;this.setTitle(Y),this.setBodyElement(this.makeOdeListElements(Q)),this.setConfirmExec(()=>{this.downloadCsv()}),this.modal.show()},Z)}downloadCsv(){this.preventCloseModal=!0;let Q=this.modalElement.querySelector("table");if(!Q){console.warn("[ModalOdeUsedFiles] No table found for CSV export");return}if(Q.querySelectorAll("tbody tr").length===0){eXeLearning.app.alerts.showToast({type:"info",message:_("No resources to export")});return}let Y=this.tableToCSV(Q);this.downloadCSVFile(Y,"ResourceReport.csv")}}class i0 extends x{constructor(Q){let Z="modalStyleManager",Y;super(Q,Z,Y,!1);this.modalElementBodyContent=this.modalElementBody.querySelector(".modal-body-content"),this.modalFooter=this.modalElement.querySelector(".modal-footer"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary"),this.modalElementAlert=this.modalElementBody.querySelector(".alert.alert-danger"),this.modalElementAlertText=this.modalElementBody.querySelector(".text"),this.modalElementAlertCloseButton=this.modalElementAlert.querySelector(".close-alert"),this.addBehaviourButtonCloseAlert(),this.readers=[]}show(Q){if(this.titleDefault=_("Styles"),this.paramInstallThemes=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.canInstallThemes)),this.paramsInfo=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.themeInfoFieldsConfig)),this.paramsEdit=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.themeEditionFieldsConfig)),Q)this.themes=Q;this.themeSelectedPrevId=this.themes.manager.selected.id,this.themeSelectedId=this.themes.manager.selected.id,this.themesBase=this.getBaseThemes(this.themes.installed),this.themesUser=this.getUserThemes(this.themes.installed),this.themeEdition=!1;let Z=this.makeBodyElement(),Y=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{if(this.setTitle(this.titleDefault),this.setBodyElement(Z),this.showButtonsConfirmCancel(),this.setConfirmExec(async()=>{await this.confirmExecEvent()}),this.setCloseExec(()=>{this.themes.manager.selectTheme(this.themeSelectedPrevId,!1)}),this.addBehaviourExeTabs(),Q)this.modalElementAlert.classList.remove("show");this.modal.show(),this.initCloseCheckInterval()},Y)}async confirmExecEvent(){if(this.themeEdition){this.preventCloseModal=!0;let Q=this.getFormEditThemeValues();if(this.themeEdition.id){if(await this.editTheme(this.themeEdition.dirName,Q),this.themeEdition.id==this.themes.manager.selected.id)await this.themes.manager.selectTheme(this.themeSelectedId,!0,!0)}else await this.newTheme(Q);this.backExecEvent()}else{let Z=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("page-id");await this.themes.manager.selectTheme(this.themeSelectedId,!0)}}getFormEditThemeValues(){var Q={data:{}};return this.modalElementBodyContent.querySelectorAll(".theme-edit-value-field").forEach((Y)=>{let X=Y.getAttribute("field"),J=Y.value?Y.value:Y.getAttribute("value");Q.data[X]=J}),Q}setConfirmButtonText(Q){this.confirmButton.innerHTML=Q}hideConfirmButtonText(){this.confirmButton.style.display="none"}showConfirmButtonText(){this.confirmButton.style.display="flex"}setCancelButtonText(Q){this.cancelButton.innerHTML=Q}hideCancelButtonText(){this.cancelButton.style.display="none"}showCancelButtonText(){this.cancelButton.style.display="flex"}generateButtonBack(){return this.buttonBack=document.createElement("button"),this.buttonBack.classList.add("back"),this.buttonBack.classList.add("btn"),this.buttonBack.classList.add("btn-secondary"),this.buttonBack.setAttribute("type","button"),this.buttonBack.innerHTML=_("Back"),this.buttonBack.addEventListener("click",(Q)=>{this.backExecEvent()}),this.modalFooter.append(this.buttonBack),this.buttonBack}removeButtonBack(){if(this.buttonBack)this.buttonBack.remove()}backExecEvent(){this.themeEdition=!1,this.setBodyElement(this.makeBodyElement(this.themes)),this.addBehaviourExeTabs(),this.clickSelectedTab(),this.showButtonsConfirmCancel()}showButtonsConfirmCancel(){this.removeButtonBack(),this.showConfirmButtonText(),this.showCancelButtonText()}clickSelectedTab(){if(this.tabSelectedLink)this.modalElementBody.querySelector(`a[href="${this.tabSelectedLink}"]`).click()}showAlert(Q){this.modalElementAlert.innerHTML=Q,this.modalElementAlert.classList.add("show")}setBodyElement(Q){this.modalElementBodyContent.innerHTML="",this.modalElementBodyContent.append(Q)}getBaseThemes(Q){let Z={};for(let[Y,X]of Object.entries(Q))if(X.type==eXeLearning.config.themeTypeBase)Z[Y]=X;return Z}getUserThemes(Q){let Z={};for(let[Y,X]of Object.entries(Q))if(X.type==eXeLearning.config.themeTypeUser)Z[Y]=X;return Z}makeBodyElement(){let Q=document.createElement("div");Q.classList.add("body-themes-container"),Q.append(this.makeElementToButtons(this.paramInstallThemes));let Z=document.createElement("div");Z.classList.add("themes-list-container"),Q.append(Z);let Y={title:_("Default styles"),id:"base-themes-tab",active:!0};if(Object.keys(this.themesUser).length>0){let X={title:_("My styles"),id:"user-themes-tab"},J=[Y,X];Z.append(this.makeThemesFormTabs(J)),Z.append(this.makeElementTableThemes(this.themesBase,Y)),Z.append(this.makeElementTableThemes(this.themesUser,X))}else Z.append(this.makeElementTableThemes(this.themesBase,Y)),Z.classList.add("no-tabs");return Q}makeElementToButtons(Q){let Z=document.createElement("div");Z.classList.add("themes-button-container"),Z.append(this.makeElementButtonNewTheme());var Y=this.makeElementButtonImportTheme(Q);if(Y!=!1)Z.append(this.makeElementInputFileImportTheme()),Z.append(this.makeElementButtonImportTheme(Q));return Z}makeElementButtonNewTheme(){let Q=document.createElement("button");return Q.classList.add("themes-button-new"),Q.classList.add("btn"),Q.classList.add("btn-secondary"),Q.innerHTML=_("New style"),Q.addEventListener("click",(Z)=>{this.themeEdition=this.themes.newTheme({title:_("My new style")}),this.modalElementBodyContent.innerHTML="",this.modalElementBodyContent.append(this.makeElementEditTheme(this.themeEdition)),this.addBehaviourExeTabs(),this.modalElementBodyContent.querySelector(".exe-form-tabs li a").click(),this.focusTextInput(this.modalElementBodyContent.querySelector("input")),this.generateButtonBack(),this.hideCancelButtonText()}),Q}makeElementInputFileImportTheme(){let Q=document.createElement("input");return Q.setAttribute("type","file"),Q.setAttribute("accept",".zip"),Q.classList.add("hidden"),Q.classList.add("theme-file-import"),Q.addEventListener("change",(Z)=>{Array.from(Q.files).forEach((Y)=>{this.addNewReader(Y)}),Q.value=null}),Q}makeElementButtonImportTheme(Q){if(eXeLearning.config.isOfflineInstallation==!1&&eXeLearning.config.userStyles==!1)return!1;let Z=document.createElement("button");if(Z.classList.add("themes-button-import"),Z.classList.add("btn"),Z.classList.add("btn-secondary"),!Q)Z.disabled=!0;return Z.innerHTML=_("Import style"),Z.addEventListener("click",(Y)=>{this.modalElementBody.querySelector("input.theme-file-import").click()}),Z}makeThemesFormTabs(Q){let Z=document.createElement("ul");return Z.classList.add("exe-form-tabs"),Q.forEach((Y)=>{let X=document.createElement("li"),J=document.createElement("a");if(J.setAttribute("href",`#${Y.id}`),J.classList.add("exe-tab"),Y.active)J.classList.add("exe-form-active-tab");J.innerText=Y.title,X.append(J),Z.append(X)}),Z}makeElementTableThemes(Q,Z){let Y=document.createElement("div");if(Y.classList.add("themes-table-rows-container"),Y.classList.add("exe-form-content"),Z.active)Y.classList.add("exe-form-active-content");if(Z.id)Y.id=Z.id;let X=document.createElement("table");Y.append(X),X.classList.add("table"),X.classList.add("themes-table"),X.classList.add("table-striped");let J=document.createElement("thead"),W=document.createElement("tr");J.append(W),X.append(J),[{title:_("Title")},{title:_("Actions"),colspan:3}].forEach((q)=>{let H=document.createElement("th");if(H.setAttribute("scope","col"),q.colspan)H.setAttribute("colspan",q.colspan);H.innerText=q.title,W.append(H)});let G=document.createElement("tbody");X.append(G);for(let[q,H]of Object.entries(Q)){let K=this.makeRowTableThemesElement(H);G.append(K)}return Y}makeRowTableThemesElement(Q){let Z=document.createElement("tr");if(Z.setAttribute("theme-id",Q.id),Z.classList.add("theme-row"),eXeLearning.app.themes.selected){if(Q.id==eXeLearning.app.themes.selected.id)Z.classList.add("selected")}if(Z.append(this.makeTitleThemeTd(Q)),Q.type=="user")Z.append(this.makeActionEditThemeTd(Q));if(Q.type=="user")Z.append(this.makeActionRemoveThemeTd(Q));return Z.append(this.makeActionExportThemeTd(Q)),Z.append(this.makeActionInfoThemeTd(Q)),Z}makeTitleThemeTd(Q){let Z=document.createElement("td");return Z.classList.add("theme-title"),Z.innerHTML=Q.title,Z.addEventListener("click",(Y)=>{this.selectTheme(Q.id,!1)}),Z}makeActionEditThemeTd(Q){let Z=document.createElement("td");return Z.classList.add("exe-icon"),Z.classList.add("theme-action"),Z.classList.add("theme-action-edit"),Z.title=_("Edit"),Z.innerHTML="edit",Z.addEventListener("click",(Y)=>{this.themeEdition=Q,this.modalElementBodyContent.innerHTML="",this.modalElementBodyContent.append(this.makeElementEditTheme(Q)),this.addBehaviourExeTabs(),this.modalElementBodyContent.querySelector(".exe-form-tabs li a").click(),this.focusTextInput(this.modalElementBodyContent.querySelector("input")),this.generateButtonBack(),this.hideCancelButtonText()}),Z}makeActionRemoveThemeTd(Q){let Z=document.createElement("td");return Z.classList.add("exe-icon"),Z.classList.add("theme-action"),Z.classList.add("theme-action-remove"),Z.title=_("Delete"),Z.innerHTML="delete_forever",Z.addEventListener("click",(Y)=>{eXeLearning.app.modals.confirm.show({title:_("Delete style"),body:_(`Are you sure you want to delete the style: ${Q.id}?`),confirmButtonText:_("Delete"),cancelButtonText:_("Cancel"),confirmExec:()=>{this.removeTheme(Q.id)}})}),Z}makeActionExportThemeTd(Q){let Z=document.createElement("td");if(Z.classList.add("exe-icon"),Z.classList.add("theme-action"),Z.classList.add("theme-action-export"),Z.title=_("Download"),Z.innerHTML="download",Q.downloadable)Z.setAttribute("downloadable",!0);else Z.setAttribute("downloadable",!1);return Z.addEventListener("click",(Y)=>{this.downloadThemeZip(Q)}),Z}makeActionInfoThemeTd(Q){let Z=document.createElement("td");return Z.classList.add("exe-icon"),Z.classList.add("theme-action"),Z.classList.add("theme-action-info"),Z.title=_("Info"),Z.innerHTML="info",Z.addEventListener("click",(Y)=>{this.modalElementBodyContent.innerHTML="",this.modalElementBodyContent.append(this.makeElementInfoTheme(Q)),this.generateButtonBack(),this.hideConfirmButtonText(),this.hideCancelButtonText()}),Z}makeElementInfoTheme(Q){let Z=document.createElement("div");Z.classList.add("info-theme-container");let Y=document.createElement("p");return Y.classList.add("theme-properties-title"),Y.innerHTML=_("Style properties"),Z.append(Y),Z.append(this.makeElementInfoThemeTable(Q)),Z}makeElementInfoThemeTable(Q){let Z=document.createElement("table");Z.classList.add("info-theme-table");for(let[Y,X]of Object.entries(this.paramsInfo))if(Q[Y])Z.append(this.makeElementInfoThemeTableRow(Y,Q[Y],X));return Z}makeElementInfoThemeTableRow(Q,Z,Y){let X=document.createElement("tr");return X.classList.add("row-table-info-theme"),X.append(this.makeElementInfoThemeTableRowKey(Q,Y)),X.append(this.makeElementInfoThemeTableRowValue(Z,Y)),X}makeElementInfoThemeTableRowKey(Q,Z){let Y=document.createElement("td");return Y.classList.add("theme-info-key"),Y.innerHTML=`${Z.title}`,Y}makeElementInfoThemeTableRowValue(Q,Z){let Y=document.createElement("td");switch(Y.classList.add("theme-info-value"),Z.tag){case"text":let X=document.createElement("input");X.classList.add("theme-info-value-text"),X.setAttribute("type","text"),X.setAttribute("disabled","disabled"),X.setAttribute("value",Q),Y.append(X);break;case"textarea":let J=document.createElement("textarea");J.classList.add("theme-info-value-text"),J.setAttribute("disabled","disabled"),J.innerHTML=Q,Y.append(J);break}return Y}makeElementEditTheme(Q){let Z=document.createElement("div");Z.classList.add("edit-theme-container");let Y=document.createElement("p");return Y.classList.add("theme-edit-title"),Y.innerHTML=_("Style")+": "+Q.title,Z.append(Y),Z.append(this.makeElementEditThemeTable(Q)),Z}makeElementEditThemeTable(Q){let Z=document.createElement("div");Z.classList.add("edit-theme-table");let Y={};for(let[z,G]of Object.entries(this.paramsEdit)){let q=G.category.replaceAll(/[^a-zA-Z ]/g,"").replaceAll(" ","").toLowerCase();Y[q]=G.category,G.tabId=q}let X=[];for(let[z,G]of Object.entries(Y))X.push({id:z,title:G});if(X.length>0)X[0].active=!0;let J=this.makeThemesFormTabs(X);Z.append(J);let W=document.createElement("div");W.classList.add("edit-theme-table-rows-container"),W.classList.add("exe-form-content-rows"),Z.append(W);for(let[z,G]of Object.entries(this.paramsEdit)){let q=Q[z]?Q[z]:"";W.append(this.makeElementEditThemeTableRow(z,q,G))}return W.querySelectorAll("input").forEach((z)=>{z.addEventListener("keyup",(G)=>{if(G.preventDefault(),G.key=="Enter")this.confirm()})}),Z}makeElementEditThemeTableRow(Q,Z,Y){let X=document.createElement("div");return X.classList.add("row-table-edit-theme"),X.classList.add("row-form-content"),X.setAttribute("category",Y.tabId),X.append(this.makeElementEditThemeTableRowKey(Q,Y)),X.append(this.makeElementEditThemeTableRowValue(Q,Z,Y)),X}makeElementEditThemeTableRowKey(Q,Z){let Y=document.createElement("label");return Y.classList.add("theme-edit-key"),Y.setAttribute("for",`${this.themeEdition.id}-${Q}-field`),Y.innerHTML=`${Z.title}:`,Y}makeElementEditThemeTableRowValue(Q,Z,Y){let X;switch(Y.tag){case"textarea":X=this.makeElementEditThemeTextarea(Z);break;case"text":X=this.makeElementEditThemeText(Z);break;case"color":X=this.makeElementEditThemeColor(Z);break;case"img":X=this.makeElementEditThemeImg(Z);break}if(X){if(Y.tag=="img"){let J=X.querySelector("input");J.id=`${this.themeEdition.id}-${Q}-field`}else X.id=`${this.themeEdition.id}-${Q}-field`;X.classList.add("theme-edit-value-field"),X.setAttribute("field",Y.config)}return X}makeElementEditThemeTextarea(Q){let Z=document.createElement("textarea");return Z.classList.add("theme-edit-value-text"),Z.innerHTML=Q,Z}makeElementEditThemeText(Q){let Z=document.createElement("input");return Z.classList.add("theme-edit-value-text"),Z.setAttribute("type","text"),Z.setAttribute("value",Q),Z}makeElementEditThemeColor(Q){let Z=document.createElement("input");return Z.setAttribute("type","color"),Z.setAttribute("value",Q),Z}makeElementEditThemeImg(Q){let Z=document.createElement("div");if(Z.classList.add("img-container"),Z.setAttribute("value",Q),!Q)Z.classList.add("no-img");let Y=document.createElement("img");if(Y.classList.add("preview-img"),Q)Y.setAttribute("src",`${eXeLearning.config.basePath}${Q}?v=${Date.now()}`);let X=document.createElement("input");X.setAttribute("type","file"),X.setAttribute("accept","image/*");let J=document.createElement("input");J.setAttribute("type","button"),J.setAttribute("value",_("Select image"));let W=document.createElement("div");return W.classList.add("exe-icon"),W.classList.add("remove-img"),W.innerHTML="close",J.addEventListener("click",(z)=>{X.click()}),X.addEventListener("change",(z)=>{let G=z.target.files.length>0?z.target.files[0]:!1;if(G)this.readFile(G).then((q)=>{if(q)Z.classList.remove("no-img"),Z.setAttribute("value",q),Y.setAttribute("src",q)})}),W.addEventListener("click",(z)=>{X.value="",Z.classList.add("no-img"),Z.setAttribute("value",""),Y.setAttribute("src","")}),Z.append(J),Z.append(Y),Z.append(W),Z}showElementAlert(Q,Z){let Y=Q,X=Z&&Z.error?Z.error:"",J=X?`<p>${Y}:</p><p>&nbsp;${X}</p>`:`<p>${Y}</p>`;this.modalElementAlertText.innerHTML=J,this.modalElementAlert.classList.add("show")}addBehaviourButtonCloseAlert(){this.modalElementAlertCloseButton.addEventListener("click",(Q)=>{this.modalElementAlertText.innerHTML="",this.modalElementAlert.classList.remove("show")})}async selectTheme(Q,Z){await this.themes.manager.selectTheme(Q,Z),this.themeSelectedId=Q,this.addClassSelectThemeRow(Q)}addClassSelectThemeRow(Q){this.modalElementBody.querySelectorAll(".themes-table .theme-row").forEach((Z)=>{if(Z.getAttribute("theme-id")==Q)Z.classList.add("selected");else Z.classList.remove("selected")})}addNewReader(Q){let Z=new FileReader;this.readers.push(Z),Z.onload=(Y)=>{this.uploadTheme(Q.name,Y.target.result)},Z.readAsDataURL(Q)}focusTextInput(Q){if(Q){Q.focus();let Z=Q.value;Q.value="",Q.value=Z}}readFile(Q){return new Promise((Z,Y)=>{let X=new FileReader;X.onload=(J)=>{Z(J.target.result)},X.onerror=Y,X.readAsDataURL(Q)})}uploadTheme(Q,Z){let Y={};Y.filename=Q,Y.file=Z,eXeLearning.app.api.postUploadTheme(Y).then((X)=>{if(X&&X.responseMessage=="OK"){this.themes.loadTheme(X.theme),this.themes.orderThemesInstalled(),this.themesBase=this.getBaseThemes(this.themes.installed),this.themesUser=this.getUserThemes(this.themes.installed);let J=this.makeBodyElement();this.setBodyElement(J),this.addBehaviourExeTabs()}else this.showElementAlert(_("Failed to install the new style"),X)})}async newTheme(Q){let Z=await eXeLearning.app.api.postNewTheme(Q);if(Z&&Z.responseMessage=="OK"&&Z.themes)return new Promise((X,J)=>{setTimeout(()=>{this.themes.loadThemes(Z.themes.themes),this.themesBase=this.getBaseThemes(this.themes.installed),this.themesUser=this.getUserThemes(this.themes.installed);let W=this.makeBodyElement();this.setBodyElement(W),this.addBehaviourExeTabs(),X(!0)},1000)});else this.showElementAlert(_("Failed to create the style"),Z)}async editTheme(Q,Z){let Y=await eXeLearning.app.api.putEditTheme(Q,Z);if(Y&&Y.responseMessage=="OK"&&Y.themes)return new Promise((J,W)=>{setTimeout(()=>{this.themes.loadThemes(Y.themes.themes),this.themesBase=this.getBaseThemes(this.themes.installed),this.themesUser=this.getUserThemes(this.themes.installed);let z=this.makeBodyElement();this.setBodyElement(z),this.addBehaviourExeTabs(),J(!0)},1000)});else this.showElementAlert(_("Failed to edit the style "),Y)}async removeTheme(Q){let Z={};Z.id=Q;let Y=await eXeLearning.app.api.deleteTheme(Z);if(Y&&Y.responseMessage=="OK"&&Y.deleted&&Y.deleted.name)this.themes.removeTheme(Y.deleted.name),setTimeout(()=>{if(!this.modal._isShown)this.show(!1)},this.timeMax);else setTimeout(()=>{if(!this.modal._isShown)this.show(!1);this.showElementAlert(_("Failed to remove style"),Y)},this.timeMax)}downloadThemeZip(Q){eXeLearning.app.api.getThemeZip(eXeLearning.app.project.odeSession,Q.dirName).then((Z)=>{if(Z&&Z.zipFileName&&Z.zipBase64){let Y=document.createElement("a");Y.setAttribute("type","hidden"),Y.href="data:text/plain;base64,"+Z.zipBase64,Y.download=Z.zipFileName,Y.click(),Y.remove()}})}}class s0 extends x{constructor(Q){let Z="modalIdeviceManager",Y;super(Q,Z,Y,!1);this.modalElementBodyContent=this.modalElementBody.querySelector(".modal-body-content"),this.modalFooter=this.modalElement.querySelector(".modal-footer"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary"),this.modalElementAlert=this.modalElementBody.querySelector(".alert.alert-danger"),this.modalElementAlertText=this.modalElementBody.querySelector(".text"),this.modalElementAlertCloseButton=this.modalElementAlert.querySelector(".close-alert"),this.addBehaviourButtonCloseAlert(),this.readers=[]}hideConfirmButtonText(){this.confirmButton.style.display="none"}showConfirmButtonText(){this.confirmButton.style.display="flex"}hideCancelButtonText(){this.cancelButton.style.display="none"}showCancelButtonText(){this.cancelButton.style.display="flex"}generateButtonBack(){return this.buttonBack=document.createElement("button"),this.buttonBack.classList.add("back"),this.buttonBack.classList.add("btn"),this.buttonBack.classList.add("btn-secondary"),this.buttonBack.setAttribute("type","button"),this.buttonBack.innerHTML=_("Back"),this.buttonBack.addEventListener("click",(Q)=>{this.backExecEvent()}),this.modalFooter.append(this.buttonBack),this.buttonBack}removeButtonBack(){if(this.buttonBack)this.buttonBack.remove()}backExecEvent(){this.setBodyElement(this.makeBodyElement(this.idevices)),this.addBehaviourExeTabs(),this.clickSelectedTab(),this.showButtonsConfirmCancel()}showButtonsConfirmCancel(){this.removeButtonBack(),this.showConfirmButtonText(),this.showCancelButtonText()}clickSelectedTab(){if(this.tabSelectedLink)this.modalElementBody.querySelector(`a[href="${this.tabSelectedLink}"]`).click()}show(Q){if(this.titleDefault=_("iDevice manager"),this.paramsInfo=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.ideviceInfoFieldsConfig)),Q)this.idevices=Q;this.idevicesBase=this.getBaseIdevices(this.idevices.installed),this.idevicesUser=this.getUserIdevices(this.idevices.installed);let Z=this.makeBodyElement(),Y=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{if(this.setTitle(this.titleDefault),this.setBodyElement(Z),this.showButtonsConfirmCancel(),this.addBehaviourExeTabs(),this.setConfirmExec(()=>{}),Q)this.modalElementAlert.classList.remove("show");this.modal.show()},Y)}setBodyElement(Q){this.modalElementBodyContent.innerHTML="",this.modalElementBodyContent.append(Q)}saveIdevicesVisibility(){let Q={};this.modalElementBody.querySelectorAll(".idevice-row .idevice-visible input").forEach((Y)=>{let X=Y.getAttribute("idevice"),J=eXeLearning.config.ideviceVisibilityPreferencePre+X;Q[J]=Y.checked,this.updateIdeviceVisibility(X,Y.checked)}),eXeLearning.app.api.putSaveUserPreferences(Q).then((Y)=>{eXeLearning.app.user.preferences.setPreferences(Y),eXeLearning.app.menus.menuIdevices.compose(),eXeLearning.app.menus.menuIdevices.behaviour(),eXeLearning.app.project.idevices.behaviour()})}getBaseIdevices(Q){let Z={};for(let[Y,X]of Object.entries(Q))if(X.type===eXeLearning.config.ideviceTypeBase)Z[Y]=X;return Z}getUserIdevices(Q){let Z={};for(let[Y,X]of Object.entries(Q))if(X.type==eXeLearning.config.ideviceTypeUser)Z[Y]=X;return Z}updateIdeviceVisibility(Q,Z){if(this.idevicesBase[Q])this.idevicesBase[Q].visible=Z;if(this.idevicesUser[Q])this.idevicesUser[Q].visible=Z;eXeLearning.app.idevices.list.installed[Q].visible=Z}makeBodyElement(){let Q=document.createElement("div");Q.classList.add("body-idevices-container");let Z=this.makeFilterTableIdevices(Q,".idevice-title",_("Search iDevices"));Q.append(Z);let Y=document.createElement("span");Y.classList.add("small-icon","search-icon"),Q.append(Y),Q.append(this.makeElementToButtons());let X=document.createElement("div");X.classList.add("idevices-list-container"),Q.append(X);let J=this.makeRowTableTheadElements();if(J)Q.prepend(J);let W={title:_("Default iDevices"),id:"base-idevices-tab",active:!0};return X.append(this.makeElementTableIdevices(this.idevices.installed,W)),X.classList.add("no-tabs"),Q}makeFilterTableIdevices(Q,Z,Y){let X=document.createElement("input");X.classList.add("table-filter"),X.classList.add("form-control"),X.setAttribute("type","text"),X.setAttribute("placeholder",Y),X.setAttribute("name","idevice-searcher"),X.id="idevice-searcher",X.addEventListener("keyup",()=>{let z=X.value.toUpperCase();Q.querySelectorAll(".toggle-item").forEach((G)=>{let q=G.querySelector(Z);if(q)if((q.textContent||q.innerText).toUpperCase().indexOf(z)>-1)G.style.display="";else G.style.display="none"})});let J=document.createElement("label");J.setAttribute("for","idevice-searcher"),J.classList.add("visually-hidden"),J.textContent=Y||_("Filter items");let W=document.createElement("div");return W.classList.add("table-filter-group"),W.append(J,X),W}makeElementToButtons(){let Q=document.createElement("div");Q.classList.add("idevices-button-container"),Q.append(this.makeElementInputFileImportIdevice());let Z=this.makeElementButtonImportIdevice();if(Z!=!1)Q.append(Z);return Q}makeElementInputFileImportIdevice(){let Q=document.createElement("input");Q.setAttribute("type","file"),Q.setAttribute("accept",".zip"),Q.id="modal-idevice-file-import",Q.setAttribute("name","modal-idevice-file-import"),Q.classList.add("hidden"),Q.classList.add("idevice-file-import"),Q.addEventListener("change",(X)=>{Array.from(Q.files).forEach((J)=>{this.addNewReader(J)}),Q.value=null});let Z=document.createElement("label");Z.setAttribute("for","modal-idevice-file-import"),Z.classList.add("visually-hidden"),Z.textContent=_("Upload iDevice file");let Y=document.createElement("div");return Y.append(Z,Q),Y}makeElementButtonImportIdevice(){if(eXeLearning.config.isOfflineInstallation==!1&&eXeLearning.config.userIdevices==!1)return!1;let Q=document.createElement("button");Q.classList.add("idevices-button-import","btn","button-secondary","d-flex","align-items-center","justify-content-start"),Q.innerHTML=_("Import iDevice");let Z=document.createElement("span");return Z.classList.add("small-icon","import-icon"),Q.prepend(Z),Q.addEventListener("click",(Y)=>{this.modalElementBody.querySelector("input.idevice-file-import").click()}),Q}makeElementTableIdevices(Q,Z){let Y=document.createElement("div");if(Y.classList.add("idevices-toggle-container","exe-form-content"),Z?.active)Y.classList.add("exe-form-active-content");if(Z?.id)Y.id=Z.id;let X=document.createElement("div");return X.className="toggle-grid",Y.append(X),this.getUserListIdevices().then((J)=>{for(let[,W]of Object.entries(Q))if(W.id!="example"){let z=this.makeRowTableIdevicesElement(W,J);X.append(z)}}),Y}async getUserListIdevices(){let Y=(await this.openDB()).transaction("idevicesSettings","readonly").objectStore("idevicesSettings"),X=eXeLearning.app.user.name;return new Promise((J)=>{let W=Y.get(X);W.onsuccess=()=>{J(W.result?W.result.value:null)},W.onerror=()=>{J(null)}})}openDB(){return new Promise((Q,Z)=>{let Y=indexedDB.open("exelearning",1);Y.onupgradeneeded=function(X){let J=X.target.result;if(!J.objectStoreNames.contains("idevicesSettings"))J.createObjectStore("idevicesSettings",{keyPath:"id"})},Y.onsuccess=function(X){Q(X.target.result)},Y.onerror=function(X){Z(X.target.error)}})}async saveIdevices(Q){let Y=(await this.openDB()).transaction("idevicesSettings","readwrite"),X=Y.objectStore("idevicesSettings"),J=eXeLearning.app.user.name;X.put({id:J,value:Q}),await Y.complete}makeRowTableTheadElements(Q,Z){return this.alertFiveIdevices=document.createElement("div"),this.alertFiveIdevices.className="alert alert-info align-items-start fade",this.alertFiveIdevices.setAttribute("role","alert"),this.alertFiveIdevices}makeRowTableIdevicesElement(Q,Z){let Y=document.createElement("div");Y.classList.add("toggle-item"),Y.setAttribute("idevice-id",Q.id);let X=document.createElement("label");if(X.classList.add("toggle-label","idevice-title"),X.setAttribute("for",`tgl-${Q.id}`),X.textContent=Q.title||Q.id,Q.type===eXeLearning.config.ideviceTypeUser)X.textContent=X.textContent+" *";let J=document.createElement("div");J.className="toggle-control";let W=document.createElement("input");W.type="checkbox",W.id=`tgl-${Q.id}`,W.className="toggle-input",W.checked=Z.includes(Q.name),W.setAttribute("aria-label",`${_("Activate")} ${Q.title||Q.id}`);let z=document.createElement("span");z.className="toggle-visual",z.addEventListener("click",()=>{W.checked=!W.checked,W.dispatchEvent(new Event("change",{bubbles:!0}))});let G=()=>{if(this.alertFiveIdevices)this.alertFiveIdevices.textContent=_("You can only select 5 iDevices as favourites. Please remove an iDevice so you can add another one."),this.alertFiveIdevices.classList.add("show")},q=()=>{if(this.alertFiveIdevices)this.alertFiveIdevices.classList.remove("show")},H=()=>{return(Y.parentElement||document).querySelectorAll(".toggle-input:checked").length};return W.addEventListener("change",()=>{if(W.checked)if(H()>5){W.checked=!1,G();return}else q();else q();Q.visible=W.checked,this.getUserListIdevices().then((K)=>{if(!Array.isArray(K))K=[];let V=K.indexOf(Q.name);if(W.checked){if(V===-1)K.push(Q.name)}else if(V!==-1)K.splice(V,1);this.saveIdevices(K).then(()=>{eXeLearning.app.menus.menuIdevices.menuIdevicesBottomContent.innerHTML="",eXeLearning.app.menus.menuIdevices.menuIdevicesBottom.init()})}).catch((K)=>{console.error("Error updating idevices:",K)})}),J.append(W,z),Y.append(J,X),Y}showElementAlert(Q,Z){let Y=Q,X=Z&&Z.error?Z.error:"",J=X?`<p>${Y}:</p><p>&nbsp;${X}</p>`:`<p>${Y}</p>`;this.modalElementAlertText.innerHTML=J,this.modalElementAlert.classList.add("show")}addBehaviourButtonCloseAlert(){this.modalElementAlertCloseButton.addEventListener("click",(Q)=>{this.modalElementAlertText.innerHTML="",this.modalElementAlert.classList.remove("show")})}selectIdevice(Q){eXeLearning.app.idevices.selectIdevice(Q,!0),this.addClassSelectIdeviceRow(Q)}addClassSelectIdeviceRow(Q){this.modalElementBody.querySelectorAll(".idevices-table .idevice-row").forEach((Z)=>{if(Z.getAttribute("idevice-id")==Q)Z.classList.add("selected");else Z.classList.remove("selected")})}addNewReader(Q){let Z=new FileReader;this.readers.push(Z),Z.onload=(Y)=>{this.uploadIdevice(Q.name,Y.target.result)},Z.readAsDataURL(Q)}uploadIdevice(Q,Z){let Y={};Y.filename=Q,Y.file=Z,eXeLearning.app.api.postUploadIdevice(Y).then((X)=>{if(X&&X.responseMessage=="OK"){this.idevices.loadIdevice(X.idevice),this.idevicesBase=this.getBaseIdevices(this.idevices.installed),this.idevicesUser=this.getUserIdevices(this.idevices.installed);let J=this.makeBodyElement();if(this.setBodyElement(J),Object.keys(this.idevicesUser).length==0)J.classList.add("only-base-idevices");let W=this.modalElementBody.querySelector(`tr[idevice-id="${X.idevice.name}"] input`);if(W)W.click();this.addBehaviourExeTabs(),this.saveIdevicesVisibility()}else this.showElementAlert(_("Failed to install the new iDevice"),X)})}removeIdevice(Q){let Z={};Z.id=Q,eXeLearning.app.api.deleteIdeviceInstalled(Z).then((Y)=>{if(Y&&Y.responseMessage=="OK"&&Y.deleted&&Y.deleted.name)this.idevices.removeIdevice(Y.deleted.name),setTimeout(()=>{if(!this.modal._isShown)this.show(!1)},this.timeMax);else setTimeout(()=>{if(!this.modal._isShown)this.show(!1);this.showElementAlert(_("Could not remove the iDevice"),Y)},this.timeMax)})}}class n0 extends x{constructor(Q){let Z="modalLopd",Y;super(Q,Z,Y,!1);this.confirmButtonDefaultText=_("Accept"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.permanent=!0}show(){this.titleDefault="eXeLearning",this.setTitle(this.titleDefault),this.setConfirmExec(()=>{this.setLopdAccepted()}),this.modal._config.keyboard=!1,this.modal._config.backdrop="static",this.modal.show()}setLopdAccepted(){this.manager.app.api.postUserSetLopdAccepted().then((Q)=>{if(Q.responseMessage=="OK")this.loadProjectLopdAccepted(),this.close()})}async loadProjectLopdAccepted(){await eXeLearning.app.loadProject(),document.querySelector("#node-content-container").style.display="",eXeLearning.app.check()}confirm(){if(this.confirmExec)this.confirmExec.call()}}class o0 extends x{constructor(Q){let Z="modalAssistant",Y;super(Q,Z,Y,!1);this.addBehaviourExeTabs(),this.addBehaviourShowTabsButton()}show(Q){this.titleDefault=_("Assistant");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{Q=Q?Q:{},this.setTitle(this.titleDefault),this.modal.show()},Z)}setBodyContent(Q){this.modalElementBody.querySelector(".body-content").innerHTML=Q}generateBodyElement(){let Q=20,Z="workarea.help.assistant.tab.{i}.title.html",Y="workarea.help.assistant.tab.{i}.content.html",X=document.createElement("div"),J=document.createElement("ul");J.classList.add("exe-form-tabs"),X.append(J);for(let W=1;W<Q;W++){let z=Z.replace("{i}",W),G=Y.replace("{i}",W);if(!this.hasTranslation(z)||!this.hasTranslation(G))break;J.append(this.generateExeFormTab(z,W)),X.append(this.generateExeFormContent(G,W))}return X}generateExeFormTab(Q,Z){let Y=_(Q),X=document.createElement("li"),J=document.createElement("a");if(J.setAttribute("href",`#${this.id}-tab-${Z}`),J.classList.add("exe-tab"),Z==1)J.classList.add("exe-form-active-tab");return J.innerHTML=`${Z}. ${Y}`,X.append(J),X}generateExeFormContent(Q,Z){let Y=_(Q),X=document.createElement("div");if(X.id=`${this.id}-tab-${Z}`,X.classList.add("exe-form-content"),Z==1)X.classList.add("exe-form-active-content");return X.innerHTML=Y,X}hasTranslation(Q){return _(Q)&&_(Q)!=Q}addBehaviourShowTabsButton(){this.modalElementBody.querySelector("icon.show-tabs").addEventListener("click",(Q)=>{Q.preventDefault();let Z=this.modalElementBody.querySelector(".body-content");if(Z)if(Z.classList.contains("show-tabs"))Z.classList.remove("show-tabs");else Z.classList.add("show-tabs")})}}class r0 extends x{constructor(Q){let Z="modalReleaseNotes",Y;super(Q,Z,Y,!1)}show(){this.titleDefault=_("Release notes");let Q=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{this.setTitle(this.titleDefault),this.modal.show()},Q)}async load(){let Q=await eXeLearning.app.api.getChangelogText(),Z=this.modalElementBody.querySelector(".body-release .changelog-content");Z.innerHTML=eXeLearning.app.common.markdownToHTML(Q),$("h2",Z).each(function(){var Y=$(this),X=Y.html();if(X=X.split(" - "),X.length==2)X=X[0]+" <span>"+X[1]+"</span>",Y.html(X);Y.attr("class","lead mb-4")}),$("h3",Z).attr("class","lead mb-3")}}class a0 extends x{constructor(Q){let Z="modalLegalNotes",Y;super(Q,Z,Y,!1);this.addBehaviourExeTabs()}show(Q){this.titleDefault=_("Legal notes");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{Q=Q?Q:{},this.setTitle(this.titleDefault),this.modal.show()},Z)}setBodyContent(Q){this.modalElementBody.querySelector(".body-content").innerHTML=Q}generateBodyElement(){let Q=20,Z="workarea.help.legalnotes.tab.{i}.title.html",Y="workarea.help.legalnotes.tab.{i}.content.html",X=document.createElement("div"),J=document.createElement("ul");J.classList.add("exe-form-tabs"),X.append(J);for(let W=1;W<Q;W++){let z=Z.replace("{i}",W),G=Y.replace("{i}",W);if(!this.hasTranslation(z)||!this.hasTranslation(G))break;J.append(this.generateExeFormTab(z,W)),X.append(this.generateExeFormContent(G,W))}return X}generateExeFormTab(Q,Z){let Y=_(Q),X=document.createElement("li"),J=document.createElement("a");if(J.setAttribute("href",`#${this.id}-tab-${Z}`),J.classList.add("exe-tab"),Z==1)J.classList.add("exe-form-active-tab");return J.innerHTML=Y,X.append(J),X}generateExeFormContent(Q,Z){let Y=_(Q),X=document.createElement("div");if(X.id=`${this.id}-tab-${Z}`,X.classList.add("exe-form-content"),Z==1)X.classList.add("exe-form-active-content");return X.innerHTML=Y,X}async load(){let Q=await eXeLearning.app.api.getThirdPartyCodeText(),Z=this.modalElementBody.querySelector("#modalLegalNotes .third-party-content");Z.innerHTML=eXeLearning.app.common.markdownToHTML(Q),Q=await eXeLearning.app.api.getLicensesList(),Z=this.modalElementBody.querySelector("#modalLegalNotes .licenses-list"),Z.innerHTML=eXeLearning.app.common.markdownToHTML(Q),$("#modalLegalNotes .md-converted-content h2").attr("class","lead mb-4"),$("#modalLegalNotes .md-converted-content a").attr("title",_("New window")).on("click",function(){return window.open(this.href),!1})}hasTranslation(Q){return _(Q)&&_(Q)!=Q}}class t0 extends x{constructor(Q){super(Q,"modalAbout",void 0,!1);this._easterEggState={clickCount:0,lastClickAt:0,keyIndex:0,lastKeyAt:0,triggered:!1},this._easterEggPhrase=["a","u","l","a"],this._easterEggInitialized=!1}behaviour(){super.behaviour(),this.initEasterEgg()}initEasterEgg(){if(this._easterEggInitialized)return;if(this._easterEggInitialized=!0,this.logoEl=this.modalElement.querySelector(".exe-logo"),this.modalElement.addEventListener("shown.bs.modal",()=>{this.resetEasterEggState()}),this.modalElement.addEventListener("hidden.bs.modal",()=>{this.resetEasterEggState()}),this.logoEl)this.logoEl.addEventListener("click",()=>this.onLogoClick());window.addEventListener("keydown",(Q)=>this.onKeyDown(Q))}resetEasterEggState(){this._easterEggState.clickCount=0,this._easterEggState.lastClickAt=0,this._easterEggState.keyIndex=0,this._easterEggState.lastKeyAt=0,this._easterEggState.triggered=!1}isAboutOpen(){return this.modalElement?.getAttribute("data-open")==="true"}onLogoClick(){if(!this.isAboutOpen()||this._easterEggState.triggered)return;let Q=Date.now(),Z=900,Y=7;if(Q-this._easterEggState.lastClickAt>Z)this._easterEggState.clickCount=0;if(this._easterEggState.lastClickAt=Q,this._easterEggState.clickCount++,this._easterEggState.clickCount>=Y)this.triggerEasterEgg()}onKeyDown(Q){if(!this.isAboutOpen()||this._easterEggState.triggered)return;if(Q.ctrlKey||Q.metaKey||Q.altKey)return;let Z=typeof Q.key==="string"&&Q.key.length===1?Q.key.toLowerCase():null;if(!Z)return;let Y=Date.now(),X=1200;if(Y-this._easterEggState.lastKeyAt>X)this._easterEggState.keyIndex=0;this._easterEggState.lastKeyAt=Y;let J=this._easterEggPhrase[this._easterEggState.keyIndex];if(Z===J){if(this._easterEggState.keyIndex++,this._easterEggState.keyIndex>=this._easterEggPhrase.length)this.triggerEasterEgg();return}this._easterEggState.keyIndex=Z===this._easterEggPhrase[0]?1:0}triggerEasterEgg(){if(this._easterEggState.triggered)return;this._easterEggState.triggered=!0;let Q=()=>{this.modalElement.removeEventListener("hidden.bs.modal",Q),this.manager?.easteregg?.show()};this.modalElement.addEventListener("hidden.bs.modal",Q),this.close(!0)}show(Q){this.titleDefault=_("About eXeLearning");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{Q=Q?Q:{},this.setTitle(this.titleDefault),this.modal.show()},Z)}}var a=(Q,Z,Y)=>Math.max(Z,Math.min(Y,Q)),w2=(Q)=>{while(Q<=-Math.PI)Q+=Math.PI*2;while(Q>Math.PI)Q-=Math.PI*2;return Q},S2=(Q,Z,Y,X)=>Math.hypot(Q-Y,Z-X),l2=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,2,2,0,0,0,2,2,0,0,0,2,2,0,1],[1,0,2,2,0,0,0,2,2,0,0,0,2,2,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,2,2,0,0,2,2,0,0,0,0,1],[1,0,0,0,0,2,2,0,0,2,2,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,2,2,0,0,2,2,0,0,0,0,1],[1,0,0,0,0,2,2,0,0,2,2,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,2,2,0,0,0,2,2,0,0,0,2,2,0,1],[1,0,2,2,0,0,0,2,2,0,0,0,2,2,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,3,3,3,3,0,0,3,3,3,3,3,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],e0={1:[110,128,160],2:[150,105,70],3:[70,150,110]};class _1{constructor({canvas:Q,statsEl:Z,timerEl:Y,overlayEl:X,overlayTitleEl:J,overlayTextEl:W,startButton:z,closeButton:G,onClose:q}){this.canvas=Q,this.ctx=Q.getContext("2d",{alpha:!1}),this.statsEl=Z,this.timerEl=Y,this.overlayEl=X,this.overlayTitleEl=J,this.overlayTextEl=W,this.startButton=z,this.closeButton=G,this.onClose=q,this.map=l2.map((H)=>H.slice()),this.spawn={x:8.5,y:13.5,a:-Math.PI/2},this.player={x:this.spawn.x,y:this.spawn.y,a:this.spawn.a},this.exit={x:8,y:14.2,radius:0.55},this.pickups=[{x:4.5,y:2.5,collected:!1},{x:11.5,y:5.5,collected:!1},{x:10.5,y:10.5,collected:!1},{x:6.5,y:7.5,collected:!1}],this.keysDown=new Set,this.showMap=!1,this.fov=65*Math.PI/180,this.totalTime=90,this._raf=null,this._lastFrameAt=0,this._running=!1,this._paused=!0,this._action=null,this._zBuffer=[],this._onResize=this.resize.bind(this),this._onKeyDown=this.onKeyDown.bind(this),this._onKeyUp=this.onKeyUp.bind(this),this._onStartClick=()=>this._action?.(),this._onCloseClick=()=>this.onClose?.(),this._onCanvasPointerDown=()=>{if(this.overlayEl&&!this.overlayEl.classList.contains("hidden"))this._action?.()}}start(){if(this._running)return;this._running=!0,this.attach(),this.reset(),this.showStartOverlay(),this.resize(),this._lastFrameAt=performance.now(),this._raf=requestAnimationFrame(this.tick.bind(this))}stop(){if(this._running=!1,this._paused=!0,this._raf)cancelAnimationFrame(this._raf);this._raf=null,this.detach()}attach(){window.addEventListener("resize",this._onResize),window.addEventListener("keydown",this._onKeyDown,{passive:!1,capture:!0}),window.addEventListener("keyup",this._onKeyUp,{passive:!1,capture:!0}),this.startButton?.addEventListener("click",this._onStartClick),this.closeButton?.addEventListener("click",this._onCloseClick),this.canvas?.addEventListener("pointerdown",this._onCanvasPointerDown)}detach(){window.removeEventListener("resize",this._onResize),window.removeEventListener("keydown",this._onKeyDown,{capture:!0}),window.removeEventListener("keyup",this._onKeyUp,{capture:!0}),this.startButton?.removeEventListener("click",this._onStartClick),this.closeButton?.removeEventListener("click",this._onCloseClick),this.canvas?.removeEventListener("pointerdown",this._onCanvasPointerDown),this.keysDown.clear()}reset(){this.player.x=this.spawn.x,this.player.y=this.spawn.y,this.player.a=this.spawn.a,this.placePlayerInFreeSpace(),this.pickups.forEach((Q)=>{Q.collected=!1}),this.remainingTime=this.totalTime,this._paused=!0,this._won=!1,this._lost=!1,this.updateHud()}showOverlay({title:Q,text:Z,primaryLabel:Y,primaryAction:X}){if(!this.overlayEl)return;if(this.overlayTitleEl)this.overlayTitleEl.textContent=Q;if(this.overlayTextEl)this.overlayTextEl.innerHTML=Z;if(this.startButton)this.startButton.textContent=Y;this._action=X,this.overlayEl.classList.remove("hidden")}hideOverlay(){this.overlayEl?.classList.add("hidden")}showStartOverlay(){this.showOverlay({title:"Has encontrado el huevo de pascua",text:"Recolecta los <strong>iDevices</strong> perdidos en el aula y vuelve a la puerta para “exportar” tu escape.",primaryLabel:"Empezar",primaryAction:()=>{this._paused=!1,this.hideOverlay(),this.canvas?.focus?.()}})}showWinOverlay(){this.showOverlay({title:"¡Exportación completada!",text:"Has reunido todos los iDevices. Tu aula queda lista para aprender.",primaryLabel:"Jugar otra vez",primaryAction:()=>{this.reset(),this._paused=!1,this.hideOverlay()}})}showLoseOverlay(){this.showOverlay({title:"Se acabó el tiempo",text:"La campana sonó antes de terminar. ¿Reintentas la clase?",primaryLabel:"Reintentar",primaryAction:()=>{this.reset(),this._paused=!1,this.hideOverlay()}})}onKeyDown(Q){let Z=Q.key,Y=typeof Z==="string"?Z.toLowerCase():"",X=new Set(["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright","m","r","escape"]);if(X.has(Y)||X.has(Z))Q.preventDefault(),Q.stopPropagation();if(Y==="escape"){this.onClose?.();return}if(Y==="m"&&!Q.repeat){this.showMap=!this.showMap;return}if(Y==="r"&&!Q.repeat){this.reset(),this._paused=!1,this.hideOverlay();return}if(this._paused&&!this._won&&!this._lost&&Y==="enter"){this._action?.();return}this.keysDown.add(Y)}onKeyUp(Q){let Z=Q.key,Y=typeof Z==="string"?Z.toLowerCase():"",X=new Set(["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright","m","r","escape"]);if(X.has(Y)||X.has(Z))Q.preventDefault(),Q.stopPropagation();this.keysDown.delete(Y)}resize(){if(!this.canvas)return;let Q=this.canvas.getBoundingClientRect(),Z=a(window.devicePixelRatio||1,1,2),Y=Math.max(320,Math.floor(Q.width*Z)),X=Math.max(200,Math.floor(Q.height*Z));if(this.canvas.width!==Y)this.canvas.width=Y;if(this.canvas.height!==X)this.canvas.height=X;this._zBuffer=Array(Y).fill(1/0)}tick(Q){if(!this._running)return;let Z=a((Q-this._lastFrameAt)/1000,0,0.05);if(this._lastFrameAt=Q,!this._paused)this.update(Z);this.render(),this._raf=requestAnimationFrame(this.tick.bind(this))}update(Q){if(this._won||this._lost)return;if(this.remainingTime=Math.max(0,this.remainingTime-Q),this.remainingTime<=0){this._lost=!0,this._paused=!0,this.showLoseOverlay();return}let Z=2.2;if(this.keysDown.has("arrowleft"))this.player.a-=Z*Q;if(this.keysDown.has("arrowright"))this.player.a+=Z*Q;this.player.a=w2(this.player.a);let Y=3,X=0,J=0,W=Math.cos(this.player.a),z=Math.sin(this.player.a),G=Math.cos(this.player.a-Math.PI/2),q=Math.sin(this.player.a-Math.PI/2);if(this.keysDown.has("w")||this.keysDown.has("arrowup"))X+=W*Y*Q,J+=z*Y*Q;if(this.keysDown.has("s")||this.keysDown.has("arrowdown"))X-=W*Y*Q,J-=z*Y*Q;if(this.keysDown.has("a"))X+=G*Y*Q,J+=q*Y*Q;if(this.keysDown.has("d"))X-=G*Y*Q,J-=q*Y*Q;let H=this.player.x+X,K=this.player.y+J,V=0.18;if(!this.isSolid(H+Math.sign(X)*V,this.player.y))this.player.x=H;if(!this.isSolid(this.player.x,K+Math.sign(J)*V))this.player.y=K;this.checkPickups(),this.checkExit(),this.updateHud()}isSolid(Q,Z){let Y=Math.floor(Q),X=Math.floor(Z);if(X<0||X>=this.map.length)return!0;if(Y<0||Y>=this.map[0].length)return!0;return this.map[X][Y]!==0}placePlayerInFreeSpace(){if(!this.isSolid(this.player.x,this.player.y))return;let Q=Math.floor(this.player.x),Z=Math.floor(this.player.y),Y=Math.max(this.map.length,this.map[0].length);for(let X=1;X<=Y;X++)for(let J=-X;J<=X;J++)for(let W=-X;W<=X;W++){if(Math.abs(W)!==X&&Math.abs(J)!==X)continue;let z=Q+W,G=Z+J;if(G<0||G>=this.map.length)continue;if(z<0||z>=this.map[0].length)continue;if(this.map[G][z]===0){this.player.x=z+0.5,this.player.y=G+0.5;return}}}checkPickups(){this.pickups.forEach((Z)=>{if(Z.collected)return;if(S2(this.player.x,this.player.y,Z.x,Z.y)<=0.55)Z.collected=!0})}checkExit(){let Q=this.pickups.length;if(this.pickups.filter((Y)=>Y.collected).length<Q)return;if(S2(this.player.x,this.player.y,this.exit.x,this.exit.y)<=this.exit.radius)this._won=!0,this._paused=!0,this.showWinOverlay()}updateHud(){let Q=this.pickups.length,Z=this.pickups.filter((Y)=>Y.collected).length;if(this.statsEl)this.statsEl.textContent=`iDevices: ${Z}/${Q}`;if(this.timerEl)this.timerEl.textContent=`⏱ ${Math.ceil(this.remainingTime)}s`}render(){if(!this.ctx)return;let{width:Q,height:Z}=this.canvas,Y=this.ctx;Y.fillStyle="#0b1020",Y.fillRect(0,0,Q,Z/2),Y.fillStyle="#1b1522",Y.fillRect(0,Z/2,Q,Z/2);let X=Math.max(1,Math.floor(Q/520));for(let J=0;J<Q;J+=X){let W=this.player.a-this.fov/2+J/Q*this.fov,z=this.castRay(W),G=Math.max(0.0001,z.dist);for(let U=0;U<X&&J+U<Q;U++)this._zBuffer[J+U]=G;let q=Math.min(Z,Z/G),H=Math.floor(Z/2-q/2),K=Math.floor(Z/2+q/2),V=e0[z.cell]||e0[1],R=a(1/(1+G*G*0.12),0.18,1),O=z.side===1?0.82:1,A=Math.floor(V[0]*R*O),M=Math.floor(V[1]*R*O),F=Math.floor(V[2]*R*O);Y.fillStyle=`rgb(${A}, ${M}, ${F})`,Y.fillRect(J,H,X,K-H),Y.fillStyle=`rgba(255,255,255,${a(0.15*R,0,0.12)})`,Y.fillRect(J,H,Math.max(1,Math.floor(X/2)),K-H)}if(this.renderSprites(),this.renderCrosshair(),this.showMap)this.renderMiniMap()}castRay(Q){let Z=Math.cos(Q),Y=Math.sin(Q),X=Math.floor(this.player.x),J=Math.floor(this.player.y),W=Z===0?1/0:Math.abs(1/Z),z=Y===0?1/0:Math.abs(1/Y),G,q,H,K;if(Z<0)G=-1,H=(this.player.x-X)*W;else G=1,H=(X+1-this.player.x)*W;if(Y<0)q=-1,K=(this.player.y-J)*z;else q=1,K=(J+1-this.player.y)*z;let V=!1,R=0,O=1,A=0;while(!V&&A<2048){if(A++,H<K)H+=W,X+=G,R=0;else K+=z,J+=q,R=1;if(J<0||J>=this.map.length||X<0||X>=this.map[0].length){V=!0,O=1;break}if(O=this.map[J][X],O!==0)V=!0}return{dist:R===0?H-W:K-z,side:R,cell:O}}renderSprites(){let Q=this.ctx,{width:Z,height:Y}=this.canvas,X=[],J=this.pickups.length,W=this.pickups.filter((z)=>z.collected).length;this.pickups.forEach((z)=>{if(z.collected)return;X.push({x:z.x,y:z.y,kind:"pickup"})}),X.push({x:this.exit.x,y:this.exit.y,kind:W===J?"exit-open":"exit-locked"}),X.map((z)=>{let G=z.x-this.player.x,q=z.y-this.player.y,H=Math.hypot(G,q),K=w2(Math.atan2(q,G)-this.player.a);return{...z,dist:H,angle:K}}).filter((z)=>Math.abs(z.angle)<this.fov/2+0.35).sort((z,G)=>G.dist-z.dist).forEach((z)=>{let G=Math.max(0.0001,z.dist),q=a(Y/G,12,Y*0.9),H=q*0.6,K=(0.5+z.angle/this.fov)*Z,V=Math.floor(K-H/2),R=Math.floor(K+H/2),O=Math.floor(Y/2-q/2),A=z.kind==="pickup"?[245,214,64]:z.kind==="exit-open"?[90,220,170]:[235,90,90];for(let M=V;M<=R;M++){if(M<0||M>=Z)continue;if(G>=this._zBuffer[M])continue;let F=a(1-G*0.08,0.22,0.95);Q.fillStyle=`rgba(${A[0]}, ${A[1]}, ${A[2]}, ${F})`,Q.fillRect(M,O,1,q)}if(z.kind==="pickup")Q.fillStyle="rgba(10, 10, 18, 0.45)",Q.fillRect(Math.floor(K-H*0.25),Math.floor(Y/2-q*0.2),Math.floor(H*0.5),Math.floor(q*0.4))})}renderCrosshair(){let Q=this.ctx,{width:Z,height:Y}=this.canvas,X=Math.floor(Z/2),J=Math.floor(Y/2);Q.strokeStyle="rgba(255,255,255,0.35)",Q.lineWidth=2,Q.beginPath(),Q.moveTo(X-10,J),Q.lineTo(X+10,J),Q.moveTo(X,J-10),Q.lineTo(X,J+10),Q.stroke()}renderMiniMap(){let Q=this.ctx,Z=10,Y=12,X=this.map[0].length*10,J=this.map.length*10;Q.fillStyle="rgba(0,0,0,0.35)",Q.fillRect(6,6,X+12,J+12);for(let G=0;G<this.map.length;G++)for(let q=0;q<this.map[0].length;q++){let H=this.map[G][q];if(H===0)continue;let K=e0[H]||e0[1];Q.fillStyle=`rgba(${K[0]}, ${K[1]}, ${K[2]}, 0.75)`,Q.fillRect(12+q*10,12+G*10,10,10)}this.pickups.forEach((G)=>{if(G.collected)return;Q.fillStyle="rgba(245, 214, 64, 0.95)",Q.beginPath(),Q.arc(12+G.x*10,12+G.y*10,3,0,Math.PI*2),Q.fill()}),Q.fillStyle="rgba(255,255,255,0.9)",Q.beginPath(),Q.arc(12+this.player.x*10,12+this.player.y*10,3.5,0,Math.PI*2),Q.fill(),Q.strokeStyle="rgba(255,255,255,0.7)",Q.beginPath(),Q.moveTo(12+this.player.x*10,12+this.player.y*10),Q.lineTo(12+(this.player.x+Math.cos(this.player.a)*0.7)*10,12+(this.player.y+Math.sin(this.player.a)*0.7)*10),Q.stroke();let W=this.pickups.length,z=this.pickups.filter((G)=>G.collected).length;Q.fillStyle=z===W?"rgba(90, 220, 170, 0.95)":"rgba(235, 90, 90, 0.95)",Q.beginPath(),Q.arc(12+this.exit.x*10,12+this.exit.y*10,4,0,Math.PI*2),Q.fill()}}class $1 extends x{constructor(Q){super(Q,"modalEasterEgg","Aula Secreta",!1);this._initialized=!1,this.game=null}behaviour(){super.behaviour(),this.initEasterEgg()}initEasterEgg(){if(this._initialized)return;if(this._initialized=!0,this.canvas=this.modalElement.querySelector('[data-easteregg="canvas"]'),this.statsEl=this.modalElement.querySelector('[data-easteregg="stats"]'),this.timerEl=this.modalElement.querySelector('[data-easteregg="timer"]'),this.overlayEl=this.modalElement.querySelector('[data-easteregg="overlay"]'),this.overlayTitleEl=this.modalElement.querySelector('[data-easteregg="overlay-title"]'),this.overlayTextEl=this.modalElement.querySelector('[data-easteregg="overlay-text"]'),this.startButton=this.modalElement.querySelector('[data-easteregg="start"]'),this.closeButton=this.modalElement.querySelector('[data-easteregg="close"]'),this.canvas)this.canvas.setAttribute("tabindex","0");this.modalElement.addEventListener("shown.bs.modal",()=>{this.startGame()}),this.modalElement.addEventListener("hidden.bs.modal",()=>{this.stopGame()})}show(){this.titleDefault="Aula Secreta";let Q=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{this.setTitle(this.titleDefault),this.modal.show()},Q)}startGame(){if(!this.game)this.game=new _1({canvas:this.canvas,statsEl:this.statsEl,timerEl:this.timerEl,overlayEl:this.overlayEl,overlayTitleEl:this.overlayTitleEl,overlayTextEl:this.overlayTextEl,startButton:this.startButton,closeButton:this.closeButton,onClose:()=>this.close(!0)});this.game.start()}stopGame(){this.game?.stop()}}class Q1 extends x{constructor(Q){let Z="modalProperties",Y;super(Q,Z,Y,!1);this.confirmButtonDefaultText=_("Save"),this.cancelButtonDefaultText=_("Cancel"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary"),this.node=null}show(Q){this.titleDefault=_("Preferences");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{Q=Q?Q:{},this.node=Q.node?Q.node:null;let Y=Q.title?Q.title:this.titleDefault,X=Q.contentId?Q.contentId:null,J=Q.properties?Q.properties:{},W=Q.fullScreen?Q.fullScreen:null;this.setTitle(Y),this.setContentId(X),this.setBodyElement(this.makeBodyElement(J)),this.setFullScreen(W),this.setConfirmExec(()=>{this.saveAction()}),this.modal.show(),this.addBehaviourExeHelp(),this.addBehaviourTextInputs(),this.addBehaviourToggleOptions(),setTimeout(()=>{this.focusTextInput(this.modalElementBody.querySelector('input[type="text"'))},this.timeMax)},Z)}setBodyElement(Q){this.modalElementBody.innerHTML="",this.modalElementBody.append(Q);let Z=this.modalElementBody.querySelector(".exe-form-tabs a.exe-tab");if(Z)Z.click()}setFullScreen(Q){this.modalElement.setAttribute("fullscreen",Q)}makeBodyElement(Q){let Z=document.createElement("div");Z.classList.add("properties-body-container");let Y=this.makeCategoriesTabs(Q);if(Y)Z.append(Y);let X=document.createElement("div");if(X.classList.add("exe-properties-form-content"),Y)X.classList.add("has-categories");Z.append(X);let J=document.createElement("div");return J.classList.add("exe-table-content"),X.append(J),this.addGroupsToTable(Q,J),this.addRowsToTable(Q,J),Z}addGroupsToTable(Q,Z){let Y=this.makeGroupTree(Q);for(let[X,J]of Object.entries(Y)){let W=this.createGroupElement(X,J);if(J.parent){let z={};z[J.parent]={};let G=this.getGroupElement(z,Z);if(G)G.append(W);else Z.append(W)}else Z.append(W)}}makeGroupTree(Q){let Z={};for(let[Y,X]of Object.entries(Q)){if(X.hide)continue;let J=null;if(X.groups)for(let[W,z]of Object.entries(X.groups)){if(!Z[W])Z[W]={};if(Z[W].title=z,Z[W].parent=J,Z[W].category=X.category,X.required)Z[W].required=!0;J=W}}return Z}createGroupElement(Q,Z){let Y=document.createElement("div");if(Y.id=Q,Y.setAttribute("category",Z.category),Y.classList.add("properties-group"),Z.required)Y.classList.add("required");if(!Z.required)Y.classList.add("hide-content");let X=document.createElement("h6");X.classList.add("properties-group-title");let J=Z.title;if(Z.required)J+=" *";return X.innerHTML=J,Y.append(X),X.addEventListener("click",(W)=>{if(this.hideHelpContentAll(),Y.classList.contains("hide-content"))Y.classList.remove("hide-content");else Y.classList.add("hide-content")}),Y}addRowsToTable(Q,Z){for(let[X,J]of Object.entries(Q)){if(J.hide)continue;let W=this.getGroupElement(J.groups,Z),z=this.makeRowElement(X,J,W,Z);if(!z)continue;if(W){let G=W.querySelectorAll(".properties-group");if(G){var Y=!1;if(G.forEach((q)=>{if(!q.querySelector(".property-row")&&!Y)W.insertBefore(z,q),Y=!0}),!Y)W.append(z)}else W.append(z)}else if(Z.querySelector(".properties-group"))Z.prepend(z);else Z.append(z)}}makeCategoriesTabs(Q){let Z=this.getListCategories(Q);if(Z.length>=2){let Y=document.createElement("ul");return Y.classList.add("exe-form-tabs"),Z.forEach((X)=>{let J=this.makeCategoryTabElement(X);Y.append(J)}),Y}return!1}makeCategoryTabElement(Q){let Z=document.createElement("li"),Y=document.createElement("a");return Y.setAttribute("href","#"),Y.classList.add("exe-tab"),Y.classList.add("exe-advanced"),Y.innerHTML=Q,Y.addEventListener("click",(X)=>{X.preventDefault(),this.hideHelpContentAll(),this.modalElementBody.querySelectorAll("a.exe-tab").forEach((J)=>{J.classList.remove("exe-form-active-tab")}),Y.classList.add("exe-form-active-tab"),this.modalElementBody.querySelectorAll(".property-row").forEach((J)=>{if(J.getAttribute("category")==Q)J.classList.remove("hidden");else J.classList.add("hidden")}),this.modalElementBody.querySelectorAll(".properties-group").forEach((J)=>{if(J.getAttribute("category")==Q)J.classList.remove("hidden");else J.classList.add("hidden")})}),Z.append(Y),Z}getListCategories(Q){let Z=[];for(let[Y,X]of Object.entries(Q)){if(X.hide)continue;if(!Z.includes(X.category))Z.push(X.category)}return Z}getGroupElement(Q,Z){if(Q){let Y=Object.entries(Q),J=Y[Y.length-1][0];return Z.querySelector(`#${J}`)}return!1}makeRowElement(Q,Z){Z.id=Q;let Y=Z.id+"-"+eXeLearning.app.common.generateId(),X=document.createElement("div");X.id=Z.id,X.setAttribute("category",Z.category),X.classList.add("property-row");let J=this.makeRowElementLabel(Y,Z),W=this.makeRowValueElement(Y,Z.id,Z),z=this.makeRowElementHelp(Z);if(Z.type==="checkbox"){X.classList.add("is-toggle-row"),J.classList.add("toggle-label");let G=W;G.style.cursor="pointer";let q=G.querySelector(".toggle-input");G.addEventListener("click",(H)=>{if(H.target!==q)H.preventDefault(),q.checked=!q.checked,q.dispatchEvent(new Event("change",{bubbles:!0}))}),X.append(W),X.append(J),J.style.cursor="pointer",J.addEventListener("click",(H)=>{H.preventDefault(),q.checked=!q.checked,q.dispatchEvent(new Event("change",{bubbles:!0}))})}else X.append(J),X.append(W);if(z)X.append(z);return X}makeRowElementLabel(Q,Z){let Y=document.createElement("label"),X=Z.title;if(Z.type!="checkbox")X+=":";if(Z.required)X="* "+X;return Y.innerHTML=X,Y.setAttribute("for",Q),Y}makeRowValueElement(Q,Z,Y){let X;switch(Y.type){case"text":X=document.createElement("input"),X.setAttribute("type","text"),X.value=Y.value;break;case"checkbox":let J=document.createElement("span");J.classList.add("toggle-item");let W=document.createElement("span");W.classList.add("toggle-control");let z=document.createElement("input");z.setAttribute("type","checkbox"),z.id=Q,z.setAttribute("name",Q),z.setAttribute("property",Z),z.setAttribute("data-type","checkbox"),z.classList.add("property-value","toggle-input"),z.checked=Y.value=="true"?!0:!1;let G=document.createElement("span");if(G.classList.add("toggle-visual"),G.setAttribute("aria-hidden","true"),W.append(z,G),J.append(W),Y.required)z.setAttribute("required",""),z.classList.add("required");z.addEventListener("focus",()=>{this.hideHelpContentAll()}),X=J;break;case"date":X=document.createElement("input"),X.setAttribute("type","date"),X.value=Y.value;break;case"textarea":X=document.createElement("textarea"),X.innerHTML=Y.value,X.value=Y.value;break;case"select":X=document.createElement("select");for(let[q,H]of Object.entries(Y.options)){let K=document.createElement("option");if(K.value=q,K.innerHTML=H,q==Y.value)K.setAttribute("selected","selected");X.append(K)}break;default:X=document.createElement("div");break}if(Y.type!=="checkbox"){if(X.id=Q,X.setAttribute("name",Q),X.setAttribute("property",Z),X.setAttribute("data-type",Y.type),X.classList.add("property-value"),X.addEventListener("focus",(J)=>{this.hideHelpContentAll()}),Y.required)X.setAttribute("required",""),X.classList.add("required")}return X}makeRowElementHelp(Q){if(Q.help){let Z=document.createElement("div");Z.classList.add("exe-form-help"),Z.classList.add("help-content-disabled");let Y=document.createElement("icon");Y.innerHTML="contact_support",Y.classList.add("form-help-exe-icon"),Y.classList.add("auto-icon");let X=document.createElement("span");return X.classList.add("help-content"),X.classList.add("help-hidden"),X.innerHTML=Q.help,Z.append(Y),Z.append(X),Z}else return!1}saveAction(){let Q=this.getModalPropertiesData();if(this.node.constructor.name==="UserPreferences")eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface();this.saveProperties(Q,!1)}getModalPropertiesData(){let Q={};return this.modalElementBody.querySelectorAll(".property-value").forEach((Y)=>{let X;switch(Y.getAttribute("data-type")){case"checkbox":X=Y.checked?"true":"false";break;case"select":X=Y.selectedOptions[0].value.trim();break;case"text":case"date":case"textarea":X=Y.value.trim();break}Q[Y.getAttribute("property")]=X}),Q}async saveProperties(Q,Z){return await this.node.apiSaveProperties(Q,Z)}addBehaviourTextInputs(){if(this.confirmExec)this.modalElementBody.querySelectorAll('input[type="text"]').forEach((Q)=>{Q.addEventListener("keyup",(Z)=>{if(Z.preventDefault(),Z.key=="Enter")this.confirm()})})}addBehaviourToggleOptions(){$("#modalProperties #minimized input").on("change",function(){if(this.checked)$("#modalProperties #allowToggle input").prop("checked",!0)}),$("#modalProperties #allowToggle input").on("change",function(){if(!this.checked)$("#modalProperties #minimized input").prop("checked",!1)})}focusTextInput(Q){if(Q){Q.focus();let Z=Q.value;Q.value="",Q.value=Z}}insertAfter(Q,Z){Q.parentNode.insertBefore(Z,Q.nextSibling)}}class t{constructor(){this.containerSelector="#node-content-container",this.element=null,this.menuSelectors=["#menu_nav","#menuidevices-menu","#listmenuidevices"]}show(){let Q=document.querySelector(this.containerSelector);if(!Q){console.warn("[ImportProgress] Container not found:",this.containerSelector);return}let Z=document.querySelector("#import-progress-overlay");if(Z)Z.remove();this.element=null,this.element=document.createElement("div"),this.element.id="import-progress-overlay",this.element.className="import-progress-overlay";let Y=typeof _==="function"?_("Importing..."):"Importing...";this.element.innerHTML=`
            <div class="import-progress-content">
                <div class="import-progress-spinner"></div>
                <div class="import-progress-message">${Y}</div>
                <div class="import-progress-bar-container">
                    <div class="import-progress-bar" style="width: 0%"></div>
                </div>
                <div class="import-progress-percent">0%</div>
            </div>
        `,Q.style.position="relative",Q.prepend(this.element),Q.classList.add("import-blocking"),this.menuSelectors.forEach((X)=>{document.querySelector(X)?.classList.add("disabled")})}update(Q){if(!this.element||!Q)return;let Z=this.element.querySelector(".import-progress-message"),Y=this.element.querySelector(".import-progress-bar"),X=this.element.querySelector(".import-progress-percent");if(Z&&Q.message)Z.textContent=Q.message;if(Y&&typeof Q.percent==="number")Y.style.width=`${Q.percent}%`;if(X&&typeof Q.percent==="number")X.textContent=`${Math.round(Q.percent)}%`}hide(){if(document.querySelector(this.containerSelector)?.classList.remove("import-blocking"),this.menuSelectors.forEach((Z)=>{document.querySelector(Z)?.classList.remove("disabled")}),this.element){this.element.classList.add("hiding");let Z=this.element;setTimeout(()=>{Z.remove()},300),this.element=null}}}var I=window.AppLogger||console;class Z1 extends x{constructor(Q){super(Q,"modalOpenUserOdeFiles",void 0,!1);this.modalElementBodyContent=this.modalElementBody.querySelector(".modal-body-content"),this.modalFooterContent=this.modalElement.querySelector(".modal-footer"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.odeFiles=[],this.uploadLimits=null,this.allOdeFilesData=null,this.currentTab="my-projects",this.selectedProjectUuid=null,this.loadUploadLimits()}async loadUploadLimits(){try{this.uploadLimits=await eXeLearning.app.api.getUploadLimits()}catch(Q){console.error("Failed to load upload limits:",Q),this.uploadLimits={maxFileSize:104857600,maxFileSizeFormatted:"100 MB"}}}validateFileSize(Q){if(!this.uploadLimits)return console.warn("Upload limits not loaded yet, skipping validation"),!0;if(Q.size>this.uploadLimits.maxFileSize){let Z=this.formatBytes(Q.size),Y=_("File size ({fileSize}) exceeds the maximum allowed size ({maxSize}).").replace("{fileSize}",Z).replace("{maxSize}",this.uploadLimits.maxFileSizeFormatted);return eXeLearning.app.modals.alert.show({title:_("File too large"),body:Y,contentId:"error"}),!1}return!0}formatBytes(Q){let Z=["B","KB","MB","GB","TB"];Q=Math.max(Q,0);let Y=Math.floor((Q?Math.log(Q):0)/Math.log(1024)),X=Math.min(Y,Z.length-1);return`${(Q/Math.pow(1024,X)).toFixed(2)} ${Z[X]}`}show(Q={}){this.titleDefault=_("Open project"),this.odeFiles=[],this.removeDeleteButtonFooter(this.odeFiles),this.currentTab="my-projects",this.selectedProjectUuid=null,this.confirmButton.disabled=!0,this.confirmButton.classList.add("disabled");let Z=this.manager.closeModals()?this.timeMax:this.timeMin;this.modalElementBodyContent.innerHTML="",setTimeout(()=>{Q=Q||{},this.setTitle(this.titleDefault),this.allOdeFilesData=Q.odeFiles;let Y=this.makeModalActions();this.setBodyElement(Y);let X=this.makeElementListOdeFiles(this.allOdeFilesData);this.setBodyElement(X);let J=this.makeFooterElement(Q);if(eXeLearning.config.isOfflineInstallation===!1)this.setFooterElement(J);this.modal.show(),this.typesetTitles()},Z)}setBodyElement(Q){this.modalElementBodyContent.append(Q)}setFooterElement(Q){let Z=this.modalFooterContent.querySelector(".btn-primary"),Y=this.modalFooterContent.querySelector(".progress-bar-div");if(Y)Y.remove();this.modalFooterContent.insertBefore(Q,Z)}makeModalActions(){let Q=document.createElement("div");Q.classList.add("modal-actions");let Z=this.makeProjectTabs();return Q.append(Z),Q.append(this.makeFilterForList(".ode-title",_("Search saved projects..."))),Q.append(this.makeUploadInput()),Q}makeProjectTabs(){let Q=document.createElement("div");Q.classList.add("ode-project-tabs");let Z=this.countProjectsByRole(),Y=document.createElement("button");Y.type="button",Y.classList.add("ode-project-tab","active"),Y.setAttribute("data-tab","my-projects"),Y.innerHTML=`${_("My Projects")} <span class="ode-tab-count">(${Z.owned})</span>`,Y.addEventListener("click",()=>this.switchTab("my-projects"));let X=document.createElement("button");return X.type="button",X.classList.add("ode-project-tab"),X.setAttribute("data-tab","shared-with-me"),X.innerHTML=`${_("Shared with me")} <span class="ode-tab-count">(${Z.shared})</span>`,X.addEventListener("click",()=>this.switchTab("shared-with-me")),Q.append(Y,X),Q}countProjectsByRole(){let Q={owned:0,shared:0};if(!this.allOdeFilesData?.odeFilesSync)return Q;let Z={};for(let[,Y]of Object.entries(this.allOdeFilesData.odeFilesSync))if(!Z[Y.odeId])Z[Y.odeId]=Y;for(let Y of Object.values(Z))if(Y.role==="owner")Q.owned++;else Q.shared++;return Q}switchTab(Q){this.currentTab=Q,this.modalElementBodyContent.querySelectorAll(".ode-project-tab").forEach((G)=>{G.classList.toggle("active",G.getAttribute("data-tab")===Q)});let Y=this.modalElementBodyContent.querySelector(".ode-select-all-wrap");if(Y)Y.style.display=Q==="my-projects"?"flex":"none";let X=this.modalElementBodyContent.querySelector("#ode-select-all-checkbox");if(X)X.checked=!1,X.indeterminate=!1;this.odeFiles=[],this.removeDeleteButtonFooter(this.odeFiles);let J=this.modalElementBodyContent.querySelector(".ode-files-list-container");if(J)J.remove();let W=this.modalElementBodyContent.querySelector(".alert.alert-info");if(W)W.remove();let z=this.makeElementListOdeFiles(this.allOdeFilesData);this.setBodyElement(z),this.typesetTitles()}makeFooterElement(Q){return this.showFreeDiskSpace(Q.odeFiles)}makeElementListOdeFiles(Q){if(!Q||!Q.odeFilesSync||Object.keys(Q.odeFilesSync).length===0){let W=document.createElement("div");return W.className="alert alert-info mt-3",W.innerHTML=this.currentTab==="my-projects"?_("No recent projects found."):_("No projects have been shared with you yet."),W}let Z={};for(let[W,z]of Object.entries(Q.odeFilesSync)){let G=z.role==="owner";if(this.currentTab==="my-projects"&&G)Z[W]=z;else if(this.currentTab==="shared-with-me"&&!G)Z[W]=z}if(Object.keys(Z).length===0){let W=document.createElement("div");return W.className="alert alert-info mt-3",W.innerHTML=this.currentTab==="my-projects"?_("No recent projects found."):_("No projects have been shared with you yet."),W}let Y=document.createElement("div");Y.classList.add("ode-files-list-container");let X=document.createElement("div");X.classList.add("ode-files-list"),Y.append(X);let J={};for(let[,W]of Object.entries(Z)){if(!J[W.odeId])J[W.odeId]=[];J[W.odeId].push(W)}for(let W of Object.values(J)){W.sort((H,K)=>parseInt(K.versionName||"0")-parseInt(H.versionName||"0"));let z=W[0],G=W.slice(1),q=this.renderOdeGroup(z,G);X.append(q)}return Y}renderOdeGroup(Q,Z){let Y=document.createElement("section");Y.classList.add("ode-group"),Y.setAttribute("ode-id",Q.odeId);let X=this.renderOdeRow(Q,{principal:!0},Z.length!==0);Y.append(X);let J=document.createElement("div");J.classList.add("ode-versions"),J.hidden=!0;for(let z of Z)J.append(this.renderOdeRow(z,{principal:!1},!1));Y.append(J);let W=X.querySelector(".ode-toggle");if(W)W.addEventListener("click",(z)=>{z.stopPropagation();let G=J.hidden;J.hidden=!G,W.classList.toggle("unblock-others-show",G),W.classList.toggle("block-others-show",!G),W.setAttribute("aria-expanded",String(G))});return Y}renderOdeRow(Q,{principal:Z},Y){let X=document.createElement("article");if(X.classList.add("ode-row"),Z)X.classList.add("principal-version");else X.classList.add("subversion-show");X.setAttribute("version-name",Q.versionName||"0"),X.setAttribute("ode-id",Q.odeId);let J=document.createElement("div");J.classList.add("ode-check-wrap");let W=document.createElement("input");W.type="checkbox",W.id="check-"+Q.odeId,W.setAttribute("name",W.id),W.classList.add("ode-check"),W.addEventListener("change",()=>{let C=Q.odeId;if(W.checked){if(!this.odeFiles.includes(C))this.odeFiles.push(C)}else this.odeFiles=this.odeFiles.filter((e)=>e!==C);this.updateDeleteButtonState(),this.updateSelectAllCheckbox()});let z=document.createElement("label");z.setAttribute("for",W.id),z.classList.add("visually-hidden"),z.textContent=_("Upload iDevice file"),J.append(z,W);let G=document.createElement("span");G.className="exe-logo content",G.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
  <path d="M14 2.26953V6.40007C14 6.96012 14 7.24015 14.109 7.45406C14.2049 7.64222 14.3578 7.7952 14.546 7.89108C14.7599 8.00007 15.0399 8.00007 15.6 8.00007H19.7305M14 17H8M16 13H8M20 9.98823V17.2C20 18.8802 20 19.7202 19.673 20.362C19.3854 20.9265 18.9265 21.3854 18.362 21.673C17.7202 22 16.8802 22 15.2 22H8.8C7.11984 22 6.27976 22 5.63803 21.673C5.07354 21.3854 4.6146 20.9265 4.32698 20.362C4 19.7202 4 18.8802 4 17.2V6.8C4 5.11984 4 4.27976 4.32698 3.63803C4.6146 3.07354 5.07354 2.6146 5.63803 2.32698C6.27976 2 7.11984 2 8.8 2H12.0118C12.7455 2 13.1124 2 13.4577 2.08289C13.7638 2.15638 14.0564 2.27759 14.3249 2.44208C14.6276 2.6276 14.887 2.88703 15.4059 3.40589L18.5941 6.59411C19.113 7.11297 19.3724 7.3724 19.5579 7.67515C19.7224 7.94356 19.8436 8.2362 19.9171 8.54231C20 8.88757 20 9.25445 20 9.98823Z" stroke="#1D1D1D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;let q=document.createElement("div");q.classList.add("ode-info");let H=document.createElement("div");H.classList.add("ode-title","ode-file-title"),H.id=Q.odeId,H.setAttribute("data-filename",Q.fileName),H.textContent=Q.title&&Q.title!==""?Q.title:Q.fileName;let K=document.createElement("div");K.classList.add("ode-meta");let{sizeFormatted:V,updatedAt:R}=Q,O=new Date(R),A=document.documentElement.lang||"en",M={day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1},F=O.toLocaleString(A,M);F=F.replace(","," -"),F=F.replace(" -","");let U=Q.versionName||"0",L=Q.visibility==="public",D=L?_("Public"):_("Private"),P=`
            <span class="ode-badge">v${U}</span>
            <span class="ode-badge ${L?"ode-badge-public":"ode-badge-private"}">${D}</span>
            <span class="dot">•</span>
            <span>${V}</span>
            <span class="dot">•</span>
            <span>${F}</span>
        `;if(Q.role&&Q.role!=="owner"&&Q.ownerEmail)P+=`
                <span class="dot">•</span>
                <span class="ode-owner-info" title="${_("Shared by")} ${Q.ownerEmail}">
                    <span class="auto-icon">person</span>
                    ${Q.ownerEmail}
                </span>
            `;else P+=`
                <span class="dot">•</span>
                <span>${Q.isManualSave?_("Manual"):_("Autosaved")}</span>
            `;K.innerHTML=P,q.append(H,K);let S=document.createElement("div");if(S.classList.add("ode-actions"),Z&&Y){let C=document.createElement("button");C.className="ode-toggle block-others-show",C.setAttribute("aria-expanded","false"),C.setAttribute("title",_("Show other versions")),C.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14" fill="none">
  <path d="M1 1V7.8C1 8.92011 1 9.48016 1.21799 9.90798C1.40973 10.2843 1.71569 10.5903 2.09202 10.782C2.51984 11 3.0799 11 4.2 11H9M9 11C9 12.1046 9.89543 13 11 13C12.1046 13 13 12.1046 13 11C13 9.89543 12.1046 9 11 9C9.89543 9 9 9.89543 9 11ZM1 4.33333L9 4.33333M9 4.33333C9 5.4379 9.89543 6.33333 11 6.33333C12.1046 6.33333 13 5.4379 13 4.33333C13 3.22876 12.1046 2.33333 11 2.33333C9.89543 2.33333 9 3.22876 9 4.33333Z" stroke="#1D1D1D" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,S.append(C)}else if(Z===!1)X.classList.add("ode-row--indented");let k=Q.role&&Q.role!=="owner",y=document.createElement("button");if(y.className="exe-icon open-user-ode-file-action open-user-ode-file-action-copy",y.title=k?_("Clone to my projects"):_("Duplicate"),y.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
  <path d="M5.33333 5.33333V3.46667C5.33333 2.71993 5.33333 2.34656 5.47866 2.06135C5.60649 1.81047 5.81047 1.60649 6.06135 1.47866C6.34656 1.33333 6.71993 1.33333 7.46667 1.33333H12.5333C13.2801 1.33333 13.6534 1.33333 13.9387 1.47866C14.1895 1.60649 14.3935 1.81047 14.5213 2.06135C14.6667 2.34656 14.6667 2.71993 14.6667 3.46667V8.53333C14.6667 9.28007 14.6667 9.65344 14.5213 9.93865C14.3935 10.1895 14.1895 10.3935 13.9387 10.5213C13.6534 10.6667 13.2801 10.6667 12.5333 10.6667H10.6667M3.46667 14.6667H8.53333C9.28007 14.6667 9.65344 14.6667 9.93865 14.5213C10.1895 14.3935 10.3935 14.1895 10.5213 13.9387C10.6667 13.6534 10.6667 13.2801 10.6667 12.5333V7.46667C10.6667 6.71993 10.6667 6.34656 10.5213 6.06135C10.3935 5.81047 10.1895 5.60649 9.93865 5.47866C9.65344 5.33333 9.28007 5.33333 8.53333 5.33333H3.46667C2.71993 5.33333 2.34656 5.33333 2.06135 5.47866C1.81047 5.60649 1.60649 5.81047 1.47866 6.06135C1.33333 6.34656 1.33333 6.71993 1.33333 7.46667V12.5333C1.33333 13.2801 1.33333 13.6534 1.47866 13.9387C1.60649 14.1895 1.81047 14.3935 2.06135 14.5213C2.34656 14.6667 2.71993 14.6667 3.46667 14.6667Z" stroke="#1D1D1D" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,y.addEventListener("click",(C)=>{C.stopPropagation(),this.duplicateOdeFileEvent(Q.odeId)}),S.append(y),!k){let C=document.createElement("button");C.className="exe-icon open-user-ode-file-action open-user-ode-file-action-delete",C.title=_("Delete"),C.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
  <path d="M6 2H10M2 4H14M12.6667 4L12.1991 11.0129C12.129 12.065 12.0939 12.5911 11.8667 12.99C11.6666 13.3412 11.3648 13.6235 11.0011 13.7998C10.588 14 10.0607 14 9.00623 14H6.99377C5.93927 14 5.41202 14 4.99889 13.7998C4.63517 13.6235 4.33339 13.3412 4.13332 12.99C3.90607 12.5911 3.871 12.065 3.80086 11.0129L3.33333 4M6.66667 7V10.3333M9.33333 7V10.3333" stroke="#C64143" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,C.addEventListener("click",(e)=>{e.stopPropagation(),this.showInlineDeleteConfirmation(X,Q)}),S.append(C)}return X.addEventListener("click",(C)=>{if(C.target.closest(".ode-actions"))return;this.modalElement.querySelectorAll(".ode-row").forEach((e)=>e.classList.remove("selected")),X.classList.add("selected"),this.selectedProjectUuid=Q.odeId,this.confirmButton.disabled=!1,this.confirmButton.classList.remove("disabled")}),X.addEventListener("dblclick",()=>{setTimeout(()=>this.openUserOdeFilesEvent(Q.odeId),this.timeMax)}),X.append(J,G,q,S),X}makeFilterForList(Q,Z){let Y=document.createElement("div");Y.classList.add("ode-filter-wrap");let X=document.createElement("div");X.classList.add("ode-select-all-wrap"),X.style.display=this.currentTab==="my-projects"?"flex":"none";let J=document.createElement("input");J.type="checkbox",J.id="ode-select-all-checkbox",J.classList.add("ode-select-all-checkbox"),J.title=_("Select all"),J.setAttribute("aria-label",_("Select all")),J.addEventListener("change",()=>this.toggleSelectAll(J.checked)),X.append(J),Y.append(X);let W=document.createElement("input");W.type="text",W.classList.add("form-control","ode-filter-input"),W.placeholder=Z||_("Search..."),W.setAttribute("aria-label",_("Search"));let z=document.createElement("div");z.classList.add("ode-search-field");let G=document.createElement("span");G.classList.add("medium-icon","search-icon"),z.append(G,W),Y.append(z);let q=()=>{document.querySelector(".ode-files-list-container").querySelectorAll(".ode-title mark").forEach((V)=>{let R=V.parentNode;R.replaceChild(document.createTextNode(V.textContent),V),R.normalize()})},H=(K,V)=>{let R=K.textContent,O=R.toLowerCase().indexOf(V.toLowerCase());if(O===-1||!V)return;let A=document.createTextNode(R.slice(0,O)),M=document.createElement("mark");M.textContent=R.slice(O,O+V.length);let F=document.createTextNode(R.slice(O+V.length));K.textContent="",K.append(A,M,F)};return W.addEventListener("input",()=>{let K=document.querySelector(".ode-files-list-container"),V=W.value.trim().toLowerCase();q();let R=K.querySelectorAll(".ode-group");I.log(R),R.forEach((O)=>{let A=O.querySelectorAll(".ode-title");I.log(A);let M=!1;A.forEach((L)=>{let D=L.textContent.trim().toLowerCase();if(V===""||D.includes(V))M=!0}),O.style.display=M?"":"none";let F=O.querySelector(".ode-versions"),U=O.querySelector(".ode-toggle");if(F&&U){let L=!!V&&M;F.hidden=!L,U.classList.toggle("unblock-others-show",L),U.classList.toggle("block-others-show",!L),U.setAttribute("aria-expanded",String(L))}if(M&&V)A.forEach((L)=>H(L,V))})}),Y.append(W),Y}showFreeDiskSpace(Q){let Z=document.createElement("div"),Y=document.createElement("div"),X=document.createElement("p");if(Y.classList.add("progress-bar-div"),!Q||!Q.maxDiskSpaceFormatted||Q.maxDiskSpace===0)return Y;let{maxDiskSpaceFormatted:J,usedSpaceFormatted:W}=Q,z=Q.usedSpace*100/Q.maxDiskSpace;Z.classList.add("progress");let G=_("%s of %s used");G=G.replace("%s",W),G=G.replace("%s",J),X.innerHTML=G,X.append(Z),Y.appendChild(X);let q=this.makeProgressBar(J,W,z);return Z.appendChild(q),Y}makeProgressBar(Q,Z,Y){let X=document.createElement("div");if(Y>85)X.setAttribute("class","progress-bar progress-bar-striped bg-danger");else if(Y>50)X.setAttribute("class","progress-bar progress-bar-striped bg-warning");else X.setAttribute("class","progress-bar progress-bar-striped bg-success");return X.setAttribute("role","progressbar"),X.setAttribute("style","width:"+Y+"%"),X.setAttribute("aria-valuenow",Z),X.setAttribute("aria-valuemin","0"),X.setAttribute("aria-valuemax",Q),X}openSelectedOdeFile(){let Q=this.modalElementBody.querySelector(".ode-row.selected .ode-file-title"),Z=Q?Q.id:null;if(Z)setTimeout(()=>this.openUserOdeFilesEvent(Z),this.timeMax)}async openUserOdeFilesEvent(Q){if(eXeLearning?.app?.project?._yjsBridge?.documentManager?.hasUnsavedChanges?.()||!1){this.close();let J={title:_("Open project"),forceOpen:_("Open without saving"),openYjsProject:!0,projectUuid:Q};eXeLearning.app.modals.sessionlogout.show(J);return}this.close(),window.onbeforeunload=null,I.log(`[OpenProject] Opening project: ${Q}`);let X=window.eXeLearning?.config?.basePath||"";window.location.href=`${X}/workarea?project=${Q}`}getAuthToken(){return eXeLearning?.app?.project?._yjsBridge?.authToken||eXeLearning?.app?.auth?.getToken?.()||eXeLearning?.config?.token||localStorage.getItem("authToken")}async refreshList(){try{let Q=await eXeLearning.app.api.getUserOdeFiles();if(Q&&Q.odeFiles)this.allOdeFilesData=Q.odeFiles,this.updateTabCounts(),this.switchTab(this.currentTab),this.selectedProjectUuid=null,this.confirmButton.disabled=!0,this.confirmButton.classList.add("disabled"),this.odeFiles=[],this.removeDeleteButtonFooter(this.odeFiles)}catch(Q){console.error("[OpenProject] Error refreshing list:",Q)}}updateTabCounts(){let Q=this.countProjectsByRole();this.modalElementBodyContent.querySelectorAll(".ode-project-tab").forEach((Y)=>{let X=Y.getAttribute("data-tab"),J=Y.querySelector(".ode-tab-count");if(J){if(X==="my-projects")J.textContent=`(${Q.owned})`;else if(X==="shared-with-me")J.textContent=`(${Q.shared})`}})}toggleSelectAll(Q){if(this.currentTab!=="my-projects")return;let Z=this.modalElementBodyContent.querySelectorAll(".ode-files-list .ode-row.principal-version .ode-check");this.odeFiles=[],Z.forEach((Y)=>{if(Y.checked=Q,Q){let J=Y.closest(".ode-row")?.getAttribute("ode-id");if(J&&!this.odeFiles.includes(J))this.odeFiles.push(J)}}),this.updateDeleteButtonState()}updateDeleteButtonState(){if(this.odeFiles.length>0)this.makeDeleteButtonFooter([...this.odeFiles]);else this.removeDeleteButtonFooter(this.odeFiles)}updateSelectAllCheckbox(){let Q=this.modalElementBodyContent.querySelector("#ode-select-all-checkbox");if(!Q)return;let Z=this.modalElementBodyContent.querySelectorAll(".ode-files-list .ode-row.principal-version .ode-check"),Y=Array.from(Z).filter((X)=>X.checked).length;if(Y===0)Q.checked=!1,Q.indeterminate=!1;else if(Y===Z.length)Q.checked=!0,Q.indeterminate=!1;else Q.checked=!1,Q.indeterminate=!0}selectProjectByUuid(Q){let Z=this.modalElementBodyContent.querySelector(`.ode-row[ode-id="${Q}"]`);if(Z)this.modalElement.querySelectorAll(".ode-row").forEach((Y)=>Y.classList.remove("selected")),Z.classList.add("selected"),this.selectedProjectUuid=Q,this.confirmButton.disabled=!1,this.confirmButton.classList.remove("disabled"),Z.scrollIntoView({behavior:"smooth",block:"nearest"})}async deleteOdeFileEvent(Q){try{let Z=eXeLearning.app.api.apiUrlBase+eXeLearning.app.api.apiUrlBasePath,Y=this.getAuthToken(),J=await(await fetch(`${Z}/api/projects/uuid/${Q}`,{method:"DELETE",headers:{"Content-Type":"application/json",...Y?{Authorization:`Bearer ${Y}`}:{}},credentials:"include"})).json();if(J.responseMessage==="OK"||J.success)await this.refreshList()}catch(Z){console.error("[OpenProject] Delete error:",Z)}}showInlineDeleteConfirmation(Q,Z){if(Q.classList.contains("ode-row--confirming"))return;let Y=Q.innerHTML;Q.classList.add("ode-row--confirming");let X=document.createElement("div");X.classList.add("ode-delete-confirm"),X.innerHTML=`
            <span class="ode-delete-confirm-text">${_("Delete this project?")}</span>
            <div class="ode-delete-confirm-actions">
                <button type="button" class="btn btn-sm btn-danger ode-delete-confirm-yes">${_("Delete")}</button>
                <button type="button" class="btn btn-sm btn-secondary ode-delete-confirm-no">${_("Cancel")}</button>
            </div>
        `,Q.innerHTML="",Q.append(X);let J=X.querySelector(".ode-delete-confirm-yes");J.addEventListener("click",async(z)=>{z.stopPropagation(),J.disabled=!0,J.textContent=_("Deleting..."),await this.deleteOdeFileEvent(Z.odeId)}),X.querySelector(".ode-delete-confirm-no").addEventListener("click",(z)=>{z.stopPropagation(),Q.classList.remove("ode-row--confirming"),Q.innerHTML=Y,this.switchTab(this.currentTab)})}async duplicateOdeFileEvent(Q){try{let Z=eXeLearning.app.api.apiUrlBase+eXeLearning.app.api.apiUrlBasePath,Y=this.getAuthToken(),J=await(await fetch(`${Z}/api/projects/uuid/${Q}/duplicate`,{method:"POST",headers:{"Content-Type":"application/json",...Y?{Authorization:`Bearer ${Y}`}:{}},credentials:"include"})).json();if(J.responseMessage==="OK"||J.success){let W=J.data?.uuid;if(await this.refreshList(),this.currentTab!=="my-projects")this.switchTab("my-projects");if(W)this.selectProjectByUuid(W)}else console.error("[OpenProject] Duplicate error:",J.message),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.message||_("An error occurred while duplicating the project."),contentId:"error"})}catch(Z){console.error("[OpenProject] Duplicate error:",Z),eXeLearning.app.modals.alert.show({title:_("Error"),body:_("An error occurred while duplicating the project."),contentId:"error"})}}async massiveDeleteOdeFileEvent(Q){try{let Z=eXeLearning.app.api.apiUrlBase+eXeLearning.app.api.apiUrlBasePath,Y=this.getAuthToken();for(let X of Q)await fetch(`${Z}/api/projects/uuid/${X}`,{method:"DELETE",headers:{"Content-Type":"application/json",...Y?{Authorization:`Bearer ${Y}`}:{}},credentials:"include"});await this.refreshList()}catch(Z){console.error("[OpenProject] Massive delete error:",Z)}}async openUserOdeFilesWithOpenSession(Q){let Z={elpFileName:Q,forceCloseOdeUserPreviousSession:"1",odeSessionId:eXeLearning.app.project.odeSession},Y=await eXeLearning.app.api.postSelectedOdeFile(Z);if(Y.responseMessage=="OK")eXeLearning.app.project.odeSession=Y.odeSessionId,eXeLearning.app.project.odeVersion=Y.odeVersionId,eXeLearning.app.project.odeId=Y.odeId,await eXeLearning.app.project.openLoad(),this.loadOdeTheme(Y);else setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Error opening"),body:Y.responseMessage||_("An error occurred while opening the file."),contentId:"error"})},this.timeMax)}makeDeleteButtonFooter(Q){this.confirmButton.innerHTML=_("Delete"),this.confirmButton.disabled=!1,this.confirmButton.classList.remove("disabled"),this.setConfirmExec(()=>this.showMassDeleteConfirmation(Q))}showMassDeleteConfirmation(Q){let Z=Q.length,Y=Z===1?_("Are you sure you want to delete this project?"):_("Are you sure you want to delete %s projects?").replace("%s",Z);eXeLearning.app.modals.confirm.show({title:_("Delete projects"),body:`<p>${Y}</p><p class="text-danger"><strong>${_("This action cannot be undone.")}</strong></p>`,confirmExec:async()=>{await this.massiveDeleteOdeFileEvent(Q);let X=this.modalElementBodyContent.querySelector("#ode-select-all-checkbox");if(X)X.checked=!1,X.indeterminate=!1},confirmLabel:_("Delete"),confirmClass:"btn-danger"})}removeDeleteButtonFooter(Q){if(Q.length===0){if(this.confirmButton.innerHTML=_("Open"),this.setConfirmExec(()=>this.openSelectedOdeFile()),!this.selectedProjectUuid)this.confirmButton.disabled=!0,this.confirmButton.classList.add("disabled")}}makeUploadInput(){let Q=document.createElement("div");Q.id="local-ode-file-upload-div";let Z=document.createElement("input");Z.classList.add("local-ode-file-upload-input","d-none"),Z.type="file",Z.name="local-ode-file-upload",Z.id="local-ode-modal-file-upload",Z.accept="."+eXeLearning.extension+",.elpx,.elp,.zip,.epub",Z.addEventListener("change",()=>{let G=Z.files[0];if(G){if(!this.validateFileSize(G)){Z.value="";return}this.largeFilesUpload(G)}});let Y=document.createElement("label");Y.setAttribute("for",Z.id),Y.classList.add("visually-hidden"),Y.textContent=_("Upload iDevice file");let X=document.createElement("button");X.classList.add("ode-files-button-upload","btn","button-secondary","d-flex","align-items-center","justify-content-start");let J=document.createElement("span");J.classList.add("small-icon","import-icon"),X.append(J,_("Select a file from your device")),X.addEventListener("click",()=>Z.click());let W=document.createElement("input");W.classList.add("multiple-local-ode-file-upload-input","d-none"),W.type="file",W.multiple=!0,W.name="multiple-local-ode-file-upload",W.id="multiple-local-modal-ode-file-upload",W.accept=".elpx,.elp,.zip",W.addEventListener("change",()=>{if(W.files?.length){let G=[];for(let q of W.files)if(!this.validateFileSize(q))G.push(q.name);if(G.length>0){W.value="";return}this.uploadOdeFilesToServer(W.files)}});let z=document.createElement("label");return z.setAttribute("for",W.id),z.classList.add("visually-hidden"),z.textContent=_("Upload iDevice file"),Q.append(Y,Z,z,W,X),Q}async largeFilesUpload(Q,Z=!1,Y=!1,X=!1,J=!1){let W=[],z=Q.name;if(Z){if(!z.includes(".idevice")&&!z.includes(".block"))return setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Import error"),body:_("The content is not a box or an iDevice"),contentId:"error"})},this.timeMax);try{I.log(`[ComponentImport] Importing ${z} client-side...`);let A=eXeLearning.app.project._yjsBridge?.getDocumentManager(),M=eXeLearning.app.project._yjsBridge?.assetManager;if(!A)throw Error("Yjs document manager not available");let F=window.ComponentImporter;if(!F)throw Error("ComponentImporter not loaded");let U=new F(A,M),L=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected?.getAttribute("nav-id");if(!L)throw Error("No page selected");if(this.modal&&this.modal._isShown)this.close();let D=await U.importComponent(Q,L);if(D.success)I.log(`[ComponentImport] Import successful, block ID: ${D.blockId}`),await eXeLearning.app.project.idevices.loadApiIdevicesInPage(!0);else throw Error(D.error||"Import failed");return}catch(A){console.error("[ComponentImport] Client-side import failed:",A),setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Import error"),body:A.message||_("An error occurred while importing the component."),contentId:"error"})},this.timeMax);return}}if(X&&J&&Q&&Q._preUploadedOdeData&&Q._preUploadedOdeData.odeFileName&&Q._preUploadedOdeData.odeFilePath){if(this.modal&&this.modal._isShown)this.close();let A=eXeLearning.app.modals.uploadprogress;A.show({fileName:Q.name,fileSize:Q.size}),A.setProcessingPhase("extracting"),await this.openLocalElpFile(Q._preUploadedOdeData.odeFileName,Q._preUploadedOdeData.odeFilePath,Z,A,J,Q),this.ensureModalBackdropCleared(350);return}if(!X&&!Z&&!Y){if(eXeLearning?.app?.project?._yjsBridge?.documentManager?.hasUnsavedChanges?.()||!1){let F={title:_("Open project"),forceOpen:_("Open without saving"),openOdeFile:!0,localOdeFile:!0,odeFile:Q,isLargeFile:!0};if(this.modal&&this.modal._isShown)this.close();eXeLearning.app.modals.sessionlogout.show(F);return}}if(this.modal&&this.modal._isShown)this.close();let q=eXeLearning.app.modals.uploadprogress;if(q.show({fileName:z,fileSize:Q.size}),!Z&&!Y)try{q.setProcessingPhase("extracting");let A=eXeLearning?.app?.capabilities;if(A&&!A.storage.remote){q.hide(),this.cleanupOrphanedBackdrops();let S=eXeLearning.app.project._yjsBridge;if(!S)throw Error("Yjs bridge not initialized.");if(I.log("[OpenFile] Static mode - importing file:",z),await S.importFromElpx(Q),eXeLearning.app.project?.refreshAfterDirectImport)await eXeLearning.app.project.refreshAfterDirectImport();I.log("[OpenFile] Static mode import complete:",z);return}let M=z.replace(/\.(elp|elpx)$/i,"")||"Imported Project",F=window.eXeLearning?.config?.basePath||"",U=this.getAuthToken(),L=await fetch(`${F}/api/project/create-quick`,{method:"POST",headers:{"Content-Type":"application/json",...U?{Authorization:`Bearer ${U}`}:{}},credentials:"include",body:JSON.stringify({title:M})}),D=await L.text(),B;try{B=JSON.parse(D)}catch(S){throw console.error("[OpenFile] Failed to parse response:",D),Error("Invalid server response")}if(!L.ok)throw console.error("[OpenFile] Failed to create project:",L.status,B),Error(B.message||`Failed to create project: ${L.status}`);I.log("[OpenFile] Project data received:",B);let P=B.uuid;if(!P)throw console.error("[OpenFile] No UUID in response:",B),Error("Server did not return a project UUID");I.log(`[OpenFile] Created project ${P}, processing ELP directly in memory...`),window.onbeforeunload=null;try{await eXeLearning.app.project.reinitializeWithProject(P,{skipSyncWait:!0}),I.log(`[OpenFile] Yjs reinitialized for project ${P}`),q.hide(),this.cleanupOrphanedBackdrops();let S=new t;S.show();let k=await eXeLearning.app.project.importElpDirectly(Q,{onProgress:(y)=>S.update(y)});I.log("[OpenFile] Import complete:",k),S.hide();try{let y=window.eXeLearning?.config?.basePath||"";window.history.pushState({},"",`${y}/workarea?project=${P}`)}catch(y){console.warn("[OpenFile] pushState blocked (likely by browser extension):",y.message)}await eXeLearning.app.project.refreshAfterDirectImport(),I.log(`[OpenFile] Successfully opened ${z}`)}catch(S){console.error("[OpenFile] Error processing file in memory:",S);let k=document.querySelector("#import-progress-overlay");if(k)k.remove();eXeLearning.app.modals.alert.show({title:_("Import error"),body:S.message||_("An error occurred while opening the file."),contentId:"error"})}return}catch(A){console.error("[OpenFile] Error in direct client processing:",A),I.log("[OpenFile] Falling back to legacy upload flow...")}let H=15728640,K=Q.size,V=0,R=V+H,O=0;try{while(V<K){let A=new FormData,M=Q.slice(V,R);if(A.append("odeFilePart",M),A.append("odeFileName",[z]),A.append("odeSessionId",[eXeLearning.app.project.odeSession]),W=await eXeLearning.app.api.postLocalLargeOdeFile(A),W.responseMessage!=="OK")break;if(W.odeSessionId)eXeLearning.app.project.odeSession=W.odeSessionId;O+=M.size;let F=O/K*100;q.updateUploadProgress(F,O,K),V=R,R=V+H}if(W.responseMessage==="OK"){q.setProcessingPhase("extracting"),z=W.odeFileName;let A=W.odeFilePath;if(Q)Q._preUploadedOdeData={odeFileName:z,odeFilePath:A};if(Y)await this.openLocalXmlPropertiesFile(z,A),q.hide();else await this.openLocalElpFile(z,A,Z,q,J,Q)}else this.ensureModalBackdropCleared(350),q.showError(W.responseMessage||_("Error while uploading the project.")),setTimeout(()=>{q.hide(),eXeLearning.app.modals.alert.show({title:_("Import error"),body:W.responseMessage?W.responseMessage:_("Error while uploading the project."),contentId:"error"})},2000)}catch(A){console.error("Upload error:",A),q.showError(_("Unexpected error during upload")),setTimeout(()=>{q.hide(),eXeLearning.app.modals.alert.show({title:_("Error"),body:_("An unexpected error occurred while processing the file."),contentId:"error"})},2000)}}async openLocalXmlPropertiesFile(Q,Z){let Y=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("nav-id"),X={title:_("Open project"),forceOpen:_("Open without saving changes"),openOdeFile:!0,localOdeFile:!0,odeFileName:Q,odeFilePath:Z,odeNavStructureSyncId:Y},J=await eXeLearning.app.api.postLocalXmlPropertiesFile(X);if(J.responseMessage==="OK")eXeLearning.app.project.properties.loadPropertiesFromYjs(),await eXeLearning.app.project.openLoad();else setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Import error"),body:J.responseMessage?_(J.responseMessage):_("An error occurred while importing properties."),contentId:"error"})},this.timeMax)}async openLocalElpFile(Q,Z,Y,X=null,J=!1,W=null){let z=eXeLearning.app.menus.menuStructure.menuStructureBehaviour.nodeSelected.getAttribute("nav-id"),G={odeSessionId:eXeLearning.app.project.odeSession,odeVersion:eXeLearning.app.project.odeVersion,odeId:eXeLearning.app.project.odeId},q=J?"1":"0",H={title:_("Open project"),forceOpen:_("Open without saving changes"),openOdeFile:!0,localOdeFile:!0,odeFileName:Q,odeFilePath:Z,odeNavStructureSyncId:z,forceCloseOdeUserPreviousSession:q},K=()=>{if(W&&W._preUploadedOdeData)delete W._preUploadedOdeData},V;if(V=!Y?await eXeLearning.app.api.postLocalOdeFile(H):await eXeLearning.app.api.postLocalOdeComponents(H),V.responseMessage=="OK"){if(X)await X.hide(),this.cleanupOrphanedBackdrops();if(!Y){eXeLearning.app.project.odeSession=V.odeSessionId,eXeLearning.app.project.odeVersion=V.odeVersionId,eXeLearning.app.project.odeId=V.odeId;try{window.__currentProjectId=V.odeId}catch(R){}try{let R=window.__originalElpPath;if(window.electronAPI&&typeof window.electronAPI.setSavedPath==="function"&&(R||Z)){let O=V.odeId||window.__currentProjectId||"default";window.electronAPI.setSavedPath(O,R||Z)}}catch(R){}if(V.projectUuid&&V.elpImportPath){I.log(`[OpenFile] Redirecting to Yjs project: ${V.projectUuid}`),I.log(`[OpenFile] Import path: ${V.elpImportPath}`),window.onbeforeunload=null,window._skipLeaveSessionModal=!0;let R=encodeURIComponent(V.elpImportPath),O=window.eXeLearning?.config?.basePath||"";window.location.href=`${O}/workarea?project=${V.projectUuid}&import=${R}`;return}if(await eXeLearning.app.project.openLoad(),this.loadOdeTheme(V),K(),V.newerVersionWarning)setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Warning"),body:V.newerVersionWarning,contentId:"warning"})},500)}else{try{let R=await eXeLearning.app.api.postObtainOdeBlockSync({odeBlockId:V.odeBlockId});if(R&&R.blockId)await eXeLearning.app.project.addOdeBlock(R);else eXeLearning.app.project.updateUserPage(z)}catch(R){eXeLearning.app.project.updateUserPage(z)}K()}}else if(Y)setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Import error"),body:V.responseMessage?_(V.responseMessage):_("An error occurred while importing the file."),contentId:"error"})},this.timeMax);else if(X){if(await X.hide(),this.cleanupOrphanedBackdrops(),(typeof V.responseMessage==="string"?V.responseMessage.toLowerCase():"").includes("user already has an open session")){eXeLearning.app.modals.sessionlogout.show({title:_("Open project"),forceOpen:_("Open without saving"),openOdeFile:!0,localOdeFile:!0,isLargeFile:!0,odeFile:W,odeFileName:Q,odeFilePath:Z});return}setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Import error"),body:V.responseMessage?_(V.responseMessage):_("An error occurred while opening the file."),contentId:"error"})},this.timeMax)}else if(eXeLearning?.app?.project?._yjsBridge?.documentManager?.hasUnsavedChanges?.()||!1)eXeLearning.app.modals.sessionlogout.show(H);else this.openUserLocalOdeFilesWithOpenSession(Q,Z)}async openUserLocalOdeFilesWithOpenSession(Q,Z){let Y={odeFileName:Q,odeFilePath:Z,forceCloseOdeUserPreviousSession:"1"},X=await eXeLearning.app.api.postLocalOdeFile(Y);if(X.responseMessage=="OK"){eXeLearning.app.project.odeSession=X.odeSessionId,eXeLearning.app.project.odeVersion=X.odeVersionId,eXeLearning.app.project.odeId=X.odeId;try{window.__currentProjectId=X.odeId}catch(J){}try{let J=window.__originalElpPath;if(window.electronAPI&&typeof window.electronAPI.setSavedPath==="function"&&(J||Z)){let W=X.odeId||window.__currentProjectId||"default";window.electronAPI.setSavedPath(W,J||Z)}}catch(J){}if(X.projectUuid&&X.elpImportPath){I.log(`[OpenFile] Redirecting to Yjs project: ${X.projectUuid}`),I.log(`[OpenFile] Import path: ${X.elpImportPath}`),window.onbeforeunload=null;let J=encodeURIComponent(X.elpImportPath),W=window.eXeLearning?.config?.basePath||"";window.location.href=`${W}/workarea?project=${X.projectUuid}&import=${J}`;return}await eXeLearning.app.project.openLoad(),this.loadOdeTheme(X)}else setTimeout(()=>{eXeLearning.app.modals.alert.show({title:_("Error opening"),body:X.responseMessage||_("An error occurred while opening the file."),contentId:"error"})},this.timeMax)}cleanupOrphanedBackdrops(){if(document.querySelectorAll(".modal-backdrop").forEach((Q)=>Q.remove()),!document.querySelector(".modal.show"))document.body.classList.remove("modal-open")}ensureModalBackdropCleared(Q=0){let Z=()=>{if(document.querySelector(".modal.show"))return;document.querySelectorAll(".modal-backdrop").forEach((Y)=>Y.remove()),document.body.classList.remove("modal-open")};if(Q>0)setTimeout(Z,Q);else Z()}loadOdeTheme(Q){if(Q.theme&&Q.themeDir&&Q.authorized)if(Object.keys(eXeLearning.app.themes.list.installed).includes(Q.theme))eXeLearning.app.themes.selectTheme(Q.theme);else this.showModalLoadOdeTheme(Q)}showModalLoadOdeTheme(Q){let Z="";Z+="<p>"+_("You don't have the style used by this project.")+"</p>",Z+="<p>"+_("The default style will be used instead.")+"</p>",eXeLearning.app.modals.alert.show({title:_("Style not available"),body:Z,confirmExec:()=>{let Y=eXeLearning.config?.defaultTheme||"base";eXeLearning.app.themes.selectTheme(Y,!1)}})}typesetTitles(){if(typeof MathJax>"u"||!MathJax.typesetPromise)return;let Q=this.modalElementBodyContent.querySelectorAll(".ode-file-title");if(Q.length===0)return;let Z=/\\[()[\]]|\\begin\{/,Y=Array.from(Q).filter((X)=>Z.test(X.textContent));if(Y.length>0)MathJax.typesetPromise(Y).catch((X)=>{console.warn("[OpenProject] MathJax typeset error:",X)})}}class Y1 extends x{constructor(Q){super(Q,"modalTemplateSelection",void 0,!1);this.modalElementBodyContent=this.modalElementBody.querySelector(".modal-body-content"),this.confirmButton=this.modalElement.querySelector("button.btn.btn-primary"),this.templateList=this.modalElement.querySelector("#template-list"),this.selectedTemplate=null,this.templates=[],this.confirmButton.addEventListener("click",()=>{if(this.selectedTemplate)this.loadTemplate(this.selectedTemplate)})}async show(Q={}){this.titleDefault=_("New from Template"),this.selectedTemplate=null,this.confirmButton.disabled=!0;let Z=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(async()=>{this.setTitle(this.titleDefault),await this.fetchTemplates(),this.renderTemplateList(),this.modal.show()},Z)}async fetchTemplates(){try{let Q=eXeLearning.app.locale.lang||eXeLearning.config.locale,Z=await eXeLearning.app.api.getTemplates(Q);this.templates=Z?.templates||[]}catch(Q){console.error("Error fetching templates:",Q),this.templates=[]}}renderTemplateList(){if(this.templateList.innerHTML="",this.templates.length===0){let Q=document.createElement("div");Q.className="alert alert-info",Q.innerHTML=_("No templates available for your language."),this.templateList.appendChild(Q);return}this.templates.forEach((Q)=>{let Z=document.createElement("a");Z.href="#",Z.className="list-group-item list-group-item-action",Z.dataset.templatePath=Q.path,Z.dataset.templateName=Q.name;let Y=document.createElement("div");Y.className="template-name",Y.textContent=Q.name,Z.appendChild(Y),Z.addEventListener("click",(X)=>{X.preventDefault(),this.selectTemplate(Q),this.templateList.querySelectorAll(".list-group-item").forEach((J)=>{J.classList.remove("active")}),Z.classList.add("active")}),this.templateList.appendChild(Z)})}selectTemplate(Q){this.selectedTemplate=Q,this.confirmButton.disabled=!1}async loadTemplate(Q){try{this.modal.hide();try{delete window.__originalElpPath}catch(W){}let Z=await fetch(Q.path);if(!Z.ok)throw Error("Failed to fetch template file");let Y=await Z.blob(),X=_("Untitled document")+".elpx",J=new File([Y],X,{type:"application/octet-stream"});if(eXeLearning.app.modals.openuserodefiles){if(await eXeLearning.app.modals.openuserodefiles.largeFilesUpload(J),window.electronAPI&&typeof window.electronAPI.clearSavedPath==="function")try{await new Promise((z)=>setTimeout(z,100));let W=window.__currentProjectId||"default";await window.electronAPI.clearSavedPath(W)}catch(W){console.error("Failed to clear saved path:",W)}}else console.error("Open user ODE files modal not available")}catch(Z){console.error("Error loading template:",Z),eXeLearning.app.modals.alert.show({title:_("Error"),message:_("Failed to load template. Please try again.")})}}}class X1 extends x{constructor(Q){let Z="modalSessionLogout",Y;super(Q,Z,Y,!1);this.saveSessionButton=this.modalElement.querySelector("button.session-logout-save.btn.btn-primary"),this.notSaveSessionButton=this.modalElement.querySelector("button.session-logout-without-save.btn.btn-primary"),this.cancelButton=this.modalElement.querySelector("button.close.btn.btn-secondary"),this.modalFooterContent=this.modalElement.querySelector(".modal-footer")}show(Q){this.titleDefault=_("Logout"),Q=Q?Q:{};let Z=this.manager.closeModals()?this.timeMax:this.timeMin,Y=Q.title?Q.title:this.titleDefault;setTimeout(()=>{this.setTitle(Y),this.setBody(_("Do you want to save the current project?")),this.setFooterContent(Q),this.modal.show()},Z)}setFooterContent(Q){let Z=this.saveSessionButton.cloneNode(!0),Y=this.notSaveSessionButton.cloneNode(!0),X=this.cancelButton;this.modalFooterContent.innerHTML="",this.modalFooterContent.appendChild(this.setSaveSessionButton(Z,Q)),this.modalFooterContent.appendChild(this.setNotSaveSessionButton(Y,Q)),this.modalFooterContent.appendChild(X)}setSaveSessionButton(Q,Z){return Q.innerHTML=_("Yes"),this.saveSessionEventListener(Q,Z),Q}setNotSaveSessionButton(Q,Z){return Q.innerHTML=Z.forceOpen?Z.forceOpen:_("Exit without saving"),this.notSaveSessionEventListener(Q,Z),Q}closeOfflineApp(){window.onbeforeunload=null,window.close()}saveSessionEventListener(Q,Z){Q.addEventListener("click",async()=>{if(Z.offlineExit){this.close(),await this.saveAndCloseOffline();return}let Y=[];Y.odeSessionId=eXeLearning.app.project.odeSession,Y.odeVersion=eXeLearning.app.project.odeVersion,Y.odeId=eXeLearning.app.project.odeId,this.saveSession(Y,Z),this.close()})}async saveAndCloseOffline(){try{if(eXeLearning.app.project?._yjsEnabled&&eXeLearning.app.project?.exportToElpxViaYjs)await eXeLearning.app.project.exportToElpxViaYjs({saveAs:!1});this.closeOfflineApp()}catch(Q){console.error("[ModalSessionLogout] Error saving before exit:",Q),eXeLearning.app.modals.alert.show({title:_("Error saving"),body:_("An error occurred while saving the project"),contentId:"error"})}}notSaveSessionEventListener(Q,Z){Q.addEventListener("click",()=>{if(Z.offlineExit){this.close(),this.closeOfflineApp();return}if(Z.openYjsProject&&Z.projectUuid){let X=window.eXeLearning?.config?.basePath||"";window.location.href=`${X}/workarea?project=${Z.projectUuid}`,this.close();return}let Y=[];if(Y.odeSessionId=eXeLearning.app.project.odeSession,Z.openOdeFile){if(Z.localOdeFile)if(Z.isLargeFile&&Z.odeFile)eXeLearning.app.modals.openuserodefiles.largeFilesUpload(Z.odeFile,!1,!1,!0,!0);else eXeLearning.app.modals.openuserodefiles.openUserLocalOdeFilesWithOpenSession(Z.odeFileName,Z.odeFilePath);else eXeLearning.app.modals.openuserodefiles.openUserOdeFilesWithOpenSession(Z.id);this.close()}else window.onbeforeunload=null,this.closeSession(Y.odeSessionId,Z)})}async saveSession(Q,Z){let Y=eXeLearning?.app?.project?._yjsEnabled,X=eXeLearning?.app?.project?._yjsBridge?.saveManager;if(Y&&X){try{if(await X.save(),Z.openYjsProject&&Z.projectUuid){let W=window.eXeLearning?.config?.basePath||"";window.location.href=`${W}/workarea?project=${Z.projectUuid}`}else if(Z.newFile){window.onbeforeunload=null;let W=window.eXeLearning?.config?.basePath||"";window.location.href=`${W}/workarea`}else if(Z.openOdeFile)if(Z.localOdeFile)if(Z.isLargeFile&&Z.odeFile)eXeLearning.app.modals.openuserodefiles.largeFilesUpload(Z.odeFile,!1,!1,!0,!0);else eXeLearning.app.modals.openuserodefiles.openUserLocalOdeFilesWithOpenSession(Z.odeFileName,Z.odeFilePath);else eXeLearning.app.modals.openuserodefiles.openUserOdeFilesWithOpenSession(Z.id);else window.onbeforeunload=null,this.closeSession(Q.odeSessionId,Z)}catch(W){console.error("[SessionLogout] Error saving Yjs project:",W),eXeLearning.app.modals.alert.show({title:_("Error saving"),body:_("An error occurred while saving the project"),contentId:"error"})}return}let J={odeSessionId:Q.odeSessionId,odeVersion:Q.odeVersion,odeId:Q.odeId};await eXeLearning.app.api.postOdeSave(J).then((W)=>{if(W.responseMessage=="OK")if(!Z.openOdeFile&&!Z.newFile)window.onbeforeunload=null,this.closeSession(Q.odeSessionId,Z);else if(Z.openOdeFile)if(Z.localOdeFile)if(Z.isLargeFile&&Z.odeFile)eXeLearning.app.modals.openuserodefiles.largeFilesUpload(Z.odeFile,!1,!1,!0,!0);else eXeLearning.app.modals.openuserodefiles.openUserLocalOdeFilesWithOpenSession(Z.odeFileName,Z.odeFilePath);else eXeLearning.app.modals.openuserodefiles.openUserOdeFilesWithOpenSession(Z.id);else eXeLearning.app.menus.navbar.file.createSession(J);else{let z=_("An error occurred while saving the file: ${response.responseMessage}");z=z.replace("${response.responseMessage}",W.responseMessage),eXeLearning.app.modals.alert.show({title:_("Error saving"),body:_(z),contentId:"error"})}})}async closeSession(Q,Z){let Y={odeSessionId:Q};if(Z.newFile)eXeLearning.app.menus.navbar.file.createSession(Y),this.close();else await eXeLearning.app.api.postCloseSession(Y).then((X)=>{if(X.responseMessage=="OK"){if(!this.offlineInstallation)this.realTimeEventNotifier.notify(Q,{name:"user-exiting",payload:eXeLearning.user.username});setTimeout(()=>{let J=window.location.pathname.split("/"),W=J.splice(0,J.length-1).join("/");window.location.href=window.location.origin+W+"/logout"},500)}})}}class J1{constructor(Q){this.modalsContainer=Q,this.modal=null,this.progressBar=null,this.statusText=null,this.currentPhase=null}show(Q={}){let{fileName:Z="archivo",fileSize:Y=0}=Q;if(this.modal){let z=bootstrap.Modal.getInstance(this.modal);if(z)z.dispose();if(this.modal.parentNode)this.modal.parentNode.removeChild(this.modal);this.modal=null,this.progressBar=null,this.statusText=null,this.percentageText=null,this.phaseText=null}let X=`
            <div class="modal fade" id="uploadProgressModal" tabindex="-1" role="dialog"
                 aria-labelledby="uploadProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="uploadProgressModalLabel">
                                ${_("Processing file")}
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="upload-file-name text-truncate" style="max-width: 70%;" title="${Z}">
                                        <strong>${Z}</strong>
                                    </span>
                                    <span class="upload-file-size text-muted">
                                        ${this.formatFileSize(Y)}
                                    </span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="upload-status-text">${_("Preparing upload...")}</span>
                                    <span class="upload-percentage">0%</span>
                                </div>
                                <div class="progress" style="height: 24px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar"
                                         style="width: 0%;"
                                         aria-valuenow="0"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>

                            <div class="upload-phase-info mt-3 p-3 bg-light rounded">
                                <small class="text-muted upload-phase-text">
                                    ${_("This may take a few moments for large files...")}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,J=document.createElement("div");return J.innerHTML=X.trim(),this.modal=J.firstChild,this.modalsContainer.appendChild(this.modal),this.progressBar=this.modal.querySelector(".progress-bar"),this.statusText=this.modal.querySelector(".upload-status-text"),this.percentageText=this.modal.querySelector(".upload-percentage"),this.phaseText=this.modal.querySelector(".upload-phase-text"),new bootstrap.Modal(this.modal).show(),this}updateUploadProgress(Q,Z=0,Y=0){if(!this.progressBar)return;let X=Math.min(100,Math.max(0,Q));if(this.progressBar.style.width=`${X}%`,this.progressBar.setAttribute("aria-valuenow",X),this.percentageText.textContent=`${Math.round(X)}%`,Z>0&&Y>0)this.statusText.textContent=`${_("Uploading")}: ${this.formatFileSize(Z)} / ${this.formatFileSize(Y)}`;else this.statusText.textContent=_("Uploading file...");this.currentPhase="upload"}setProcessingPhase(Q){if(!this.progressBar)return;this.currentPhase="processing",this.progressBar.classList.add("progress-bar-animated"),this.progressBar.style.width="100%",this.percentageText.textContent="";let Y={extracting:{status:_("Extracting files..."),info:_("Extracting ZIP file contents. This may take several minutes for large files.")},parsing:{status:_("Processing content..."),info:_("Reading and validating file structure. Almost done!")},finalizing:{status:_("Finalizing..."),info:_("Completing the process...")},savingProject:{status:_("Saving project..."),info:_("Saving document structure to server...")},uploadingAssets:{status:_("Uploading assets..."),info:_("Uploading images and files to server...")},savingComplete:{status:_("Save complete!"),info:_("All changes have been saved successfully.")}}[Q]||{status:_("Processing..."),info:_("Please wait...")};this.statusText.textContent=Y.status,this.phaseText.textContent=Y.info}setAssetUploadProgress(Q,Z,Y=0,X=0){if(!this.progressBar)return;this.currentPhase="uploadingAssets";let J=Z>0?Math.round(Q/Z*100):0;if(this.progressBar.classList.add("progress-bar-animated","progress-bar-striped"),this.progressBar.style.width=`${J}%`,this.progressBar.setAttribute("aria-valuenow",J),this.percentageText.textContent=`${J}%`,X>0)this.statusText.textContent=`${_("Uploading asset")} ${Q}/${Z} (${this.formatFileSize(Y)}/${this.formatFileSize(X)})`;else this.statusText.textContent=`${_("Uploading asset")} ${Q}/${Z}`;this.phaseText.textContent=_("Uploading images and files to server...")}showSaveMode(Q={}){let{projectTitle:Z="project"}=Q;if(this.modal){let W=bootstrap.Modal.getInstance(this.modal);if(W)W.dispose();if(this.modal.parentNode)this.modal.parentNode.removeChild(this.modal);this.modal=null}let Y=`
            <div class="modal fade" id="uploadProgressModal" tabindex="-1" role="dialog"
                 aria-labelledby="uploadProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="uploadProgressModalLabel">
                                ${_("Saving project")}
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="upload-file-name text-truncate" style="max-width: 100%;" title="${Z}">
                                        <strong>${Z}</strong>
                                    </span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="upload-status-text">${_("Preparing...")}</span>
                                    <span class="upload-percentage"></span>
                                </div>
                                <div class="progress" style="height: 24px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar"
                                         style="width: 100%;"
                                         aria-valuenow="0"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>

                            <div class="upload-phase-info mt-3 p-3 bg-light rounded">
                                <small class="text-muted upload-phase-text">
                                    ${_("Preparing to save your project...")}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,X=document.createElement("div");return X.innerHTML=Y.trim(),this.modal=X.firstChild,this.modalsContainer.appendChild(this.modal),this.progressBar=this.modal.querySelector(".progress-bar"),this.statusText=this.modal.querySelector(".upload-status-text"),this.percentageText=this.modal.querySelector(".upload-percentage"),this.phaseText=this.modal.querySelector(".upload-phase-text"),new bootstrap.Modal(this.modal).show(),this}setComplete(Q,Z=null,Y=!1){if(!this.progressBar)return;if(this.progressBar.classList.remove("progress-bar-animated","progress-bar-striped"),Q)this.progressBar.classList.add("bg-success"),this.progressBar.style.width="100%",this.statusText.textContent=Z||_("Completed successfully"),this.percentageText.textContent="100%";else this.progressBar.classList.add("bg-danger"),this.statusText.textContent=Z||_("Error processing file");if(Q&&Y)setTimeout(()=>{this.hide()},2000)}showError(Q){this.setComplete(!1,Q)}hide(){return new Promise((Q)=>{let Z=()=>{if(this.modal&&this.modal.parentNode)this.modal.parentNode.removeChild(this.modal);this.modal=null,this.progressBar=null,this.statusText=null,this.percentageText=null,this.phaseText=null};if(this.modal){let Y=this.modal,X=bootstrap.Modal.getInstance(Y);if(X){let J=!1,W=setTimeout(()=>{if(!J){if(J=!0,console.warn("[ModalUploadProgress] Bootstrap hidden event timeout, forcing cleanup"),Y.removeEventListener("hidden.bs.modal",z),Y.classList.remove("show"),Y.style.display="none",Y.setAttribute("aria-hidden","true"),document.querySelectorAll(".modal-backdrop").forEach((G)=>G.remove()),!document.querySelector(".modal.show"))document.body.classList.remove("modal-open");Z(),Q()}},500),z=()=>{if(!J)J=!0,clearTimeout(W),Z(),Q()};Y.addEventListener("hidden.bs.modal",z,{once:!0}),X.hide()}else Z(),Q()}else Q()})}formatFileSize(Q){if(Q===0)return"0 B";let Z=1024,Y=["B","KB","MB","GB"],X=Math.floor(Math.log(Q)/Math.log(Z));return Math.round(Q/Math.pow(Z,X)*100)/100+" "+Y[X]}}var W1=window.AppLogger||console;class z1 extends x{constructor(Q){let Z="modalShare",Y=_("Share");super(Q,Z,Y,!1);this.projectData=null,this.lastFocusedElement=null,this.currentUserIsOwner=!1,this.inviteSection=this.modalElement.querySelector("#share-invite-section"),this.inviteEmail=this.modalElement.querySelector("#share-invite-email"),this.inviteButton=this.modalElement.querySelector("#share-invite-button"),this.inviteError=this.modalElement.querySelector("#share-invite-error"),this.peopleSection=this.modalElement.querySelector("#share-people-section"),this.peopleList=this.modalElement.querySelector("#share-people-list"),this.generalAccessSection=this.modalElement.querySelector("#share-general-access-section"),this.visibilitySelect=this.modalElement.querySelector("#share-visibility-select"),this.visibilityHelp=this.modalElement.querySelector("#share-visibility-help"),this.linkInput=this.modalElement.querySelector("#share-link-input"),this.copyButton=this.modalElement.querySelector("#share-copy-button"),this.ariaLive=this.modalElement.querySelector("#share-aria-live")}behaviour(){super.behaviour(),this.inviteButton?.addEventListener("click",()=>this.handleInvite()),this.inviteEmail?.addEventListener("keypress",(Q)=>{if(Q.key==="Enter")Q.preventDefault(),this.handleInvite()}),this.visibilitySelect?.addEventListener("change",(Q)=>this.handleVisibilityChange(Q.target.value)),this.copyButton?.addEventListener("click",()=>this.handleCopyLink()),this.modalElement.addEventListener("keydown",(Q)=>{if(Q.key==="Escape")this.close()})}async show(){let Q=eXeLearning.app.project?.odeId;if(!Q){console.error("Share modal: No project ID available"),eXeLearning.app.modals.alert.show({title:_("Error"),body:_("No project available to share"),contentId:"error"});return}if(this.lastFocusedElement=document.activeElement,!await this.loadProjectData(Q))return;let Y=eXeLearning.app.user?.id||eXeLearning.user?.id;this.currentUserIsOwner=this.projectData?.isOwner===!0;let X=this.manager.closeModals()?this.timeMax:this.timeMin;setTimeout(()=>{let J=eXeLearning.app.project?.properties?.properties?.pp_title?.value,W=this.projectData?.title===_("Untitled document")||!this.projectData?.title?J:this.projectData?.title,z=_('Share "{title}"').replace("{title}",W||_("Untitled document"));this.setTitle(z),this.setContentId(Q),this.modal.show(),setTimeout(()=>{if(this.renderInviteSection(),this.renderPeopleList(),this.renderVisibilitySection(),this.renderLinkSection(),this.currentUserIsOwner&&this.inviteEmail)this.inviteEmail.focus()},300)},X)}close(){if(super.close(),this.lastFocusedElement)this.lastFocusedElement.focus()}async loadProjectData(Q){try{let Z=await eXeLearning.app.api.getProject(Q);if(Z.responseMessage==="OK")return this.projectData=Z.project,!0;else return this.showError(Z.detail||_("Failed to load project data")),!1}catch(Z){return console.error("Failed to load project:",Z),this.showError(_("Failed to load project data")),!1}}renderInviteSection(){if(!this.inviteSection)return;if(this.currentUserIsOwner)this.inviteSection.style.display="";else this.inviteSection.style.display="none"}renderPeopleList(){if(!this.projectData||!this.peopleList)return;let Q=eXeLearning.app.user?.id,Z=this.projectData.collaborators||[],Y="";Z.forEach((X)=>{let J=X.user,W=X.role==="owner",z=String(J.id)===String(Q);Y+=this.renderPersonRow(J,X.role,W,z,this.currentUserIsOwner)}),this.peopleList.innerHTML=Y,this.attachPersonRowListeners()}renderPersonRow(Q,Z,Y,X,J){let W=this.getInitials(Q.email),z=Z==="owner"?_("Owner"):_("Editor");return`
            <div class="share-person-row" data-user-id="${Q.id}">
                <div class="share-person-avatar">
                    ${this.renderAvatar(Q,W)}
                </div>
                <div class="share-person-info">
                    <div class="share-person-email">
                        ${this.escapeHtml(Q.email)}
                        ${X?`<span class="text-muted ms-1">(${_("you")})</span>`:""}
                        <span class="share-person-role-badge">${z}</span>
                    </div>
                </div>
                <div class="share-person-actions">
                    ${Y?`<span class="share-person-owner-label text-muted">${_("Owner")}</span>`:J?`
                        <div class="dropdown">
                            <button class="share-person-menu-btn" type="button"
                                    data-bs-toggle="dropdown" aria-label="${_("More actions")}">
                                <div class="auto-icon">more_vert</div>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item share-action-make-owner"
                                       href="#" data-user-id="${Q.id}" data-email="${this.escapeHtml(Q.email)}">
                                        <div class="auto-icon">person</div>
                                        ${_("Make owner")}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item share-action-remove"
                                       href="#" data-user-id="${Q.id}" data-email="${this.escapeHtml(Q.email)}">
                                        <div class="auto-icon">person_remove</div>
                                        ${_("Remove access")}
                                    </a>
                                </li>
                            </ul>
                        </div>
                    `:""}
                </div>
            </div>
        `}renderAvatar(Q,Z){return n1({email:Q.email,name:Q.name,gravatarUrl:Q.gravatarUrl,initials:Z,size:40})}getInitials(Q){return v(Q)}attachPersonRowListeners(){this.peopleList?.querySelectorAll(".share-action-make-owner").forEach((Q)=>{Q.addEventListener("click",(Z)=>{Z.preventDefault();let Y=parseInt(Z.currentTarget.dataset.userId),X=Z.currentTarget.dataset.email;this.handleMakeOwner(Y,X)})}),this.peopleList?.querySelectorAll(".share-action-remove").forEach((Q)=>{Q.addEventListener("click",(Z)=>{Z.preventDefault();let Y=parseInt(Z.currentTarget.dataset.userId),X=Z.currentTarget.dataset.email;this.handleRemove(Y,X)})})}renderVisibilitySection(){if(!this.projectData||!this.visibilitySelect)return;this.updateVisibilityOptionLabels(),this.visibilitySelect.value=this.projectData.visibility||"public",this.visibilitySelect.disabled=!this.currentUserIsOwner,this.updateVisibilityHelp(this.projectData.visibility)}updateVisibilityOptionLabels(){if(!this.visibilitySelect)return;let Q=this.visibilitySelect.querySelector('option[value="private"]'),Z=this.visibilitySelect.querySelector('option[value="public"]');if(Q)Q.textContent="\uD83D\uDD12 Restricted (Private)";if(Z)Z.textContent="\uD83C\uDF10 Anyone with the link (Public)"}updateVisibilityHelp(Q){if(!this.visibilityHelp)return;if(Q==="public")this.visibilityHelp.classList.remove("d-none");else this.visibilityHelp.classList.add("d-none")}renderLinkSection(){if(!this.linkInput)return;let Q=eXeLearning.app.interface?.shareButton,Z=Q?Q.getCurrentDocumentUrl():this.buildShareUrl();this.linkInput.value=Z}buildShareUrl(){let Q=new URL(window.location.href),Z=eXeLearning.app.project?.odeId||eXeLearning.app.project?.requestedProjectId||Q.searchParams.get("project");if(Z)Q.searchParams.set("project",Z),Q.searchParams.delete("projectId"),Q.searchParams.delete("odeSessionId");return Q.toString()}async handleInvite(){if(!this.currentUserIsOwner){console.warn("Only project owner can invite collaborators");return}let Q=this.inviteEmail?.value.trim();if(!Q){this.showInviteError(_("Please enter an email address"));return}if(!this.validateEmail(Q)){this.showInviteError(_("Please enter a valid email address"));return}this.clearInviteError();try{this.inviteButton.disabled=!0,this.inviteButton.textContent=_("Inviting...");let Z=eXeLearning.app.project?.odeId,Y=await eXeLearning.app.api.addProjectCollaborator(Z,Q,"editor");if(Y.responseMessage==="OK")this.inviteEmail.value="",await this.loadProjectData(Z),this.renderPeopleList(),this.announce(_("Invited {email}").replace("{email}",Q));else if(Y.responseMessage==="ALREADY_COLLABORATOR")this.showInviteError(_("This user is already a collaborator"));else if(Y.responseMessage==="USER_NOT_FOUND")this.showInviteError(_("User not found"));else this.showInviteError(Y.detail||_("Failed to invite user"))}catch(Z){console.error("Failed to invite collaborator:",Z),this.showInviteError(_("Failed to invite user"))}finally{this.inviteButton.disabled=!1,this.inviteButton.textContent=_("Invite")}}async handleRemove(Q,Z){let Y=_("Remove {email}'s access to this project?").replace("{email}",Z);if(!confirm(Y))return;try{let X=eXeLearning.app.project?.odeId,J=await eXeLearning.app.api.removeProjectCollaborator(X,Q);if(J.responseMessage==="OK")await this.loadProjectData(X),this.renderPeopleList(),this.announce(_("Removed {email}").replace("{email}",Z));else this.showError(J.detail||_("Failed to remove collaborator"))}catch(X){console.error("Failed to remove collaborator:",X),this.showError(_("Failed to remove collaborator"))}}async handleMakeOwner(Q,Z){let Y=_("Transfer ownership to {email}? You will become an editor.").replace("{email}",Z);if(!confirm(Y))return;try{let X=eXeLearning.app.project?.odeId,J=await eXeLearning.app.api.transferProjectOwnership(X,Q);if(J.responseMessage==="OK"){if(await this.loadProjectData(X),this.currentUserIsOwner=this.projectData?.isOwner===!0,this.renderInviteSection(),this.renderPeopleList(),this.renderVisibilitySection(),this.announce(_("Ownership transferred to {email}").replace("{email}",Z)),eXeLearning.app.interface?.shareButton)eXeLearning.app.interface.shareButton.updateVisibilityPill(this.projectData.visibility)}else this.showError(J.detail||_("Failed to transfer ownership"))}catch(X){console.error("Failed to transfer ownership:",X),this.showError(_("Failed to transfer ownership"))}}async handleVisibilityChange(Q){let Z=eXeLearning.app.project?.odeId;if(!Z){console.error("[Share] Cannot update visibility: no current project",{projectData:this.projectData,odeId:Z}),this.showError(_("Project data not loaded. Please try again."));return}if(W1.log("[Share] handleVisibilityChange:",{projectId:Z,uuid:this.projectData?.uuid,currentVisibility:this.projectData?.visibility,newVisibility:Q}),!this.currentUserIsOwner){console.warn("Only project owner can change visibility"),this.visibilitySelect.value=this.projectData.visibility;return}if(Q===this.projectData.visibility)return;try{if(Q!=="private"){let X=eXeLearning.app.project?._yjsBridge;if(X?.saveToServer){W1.log("[Share] Saving project before visibility change to:",Q);try{await X.saveToServer(),W1.log("[Share] Project saved successfully")}catch(J){console.warn("[Share] Failed to save before visibility change:",J)}}}let Y=await eXeLearning.app.api.updateProjectVisibility(Z,Q);if(W1.log("[Share] updateProjectVisibility response:",Y),Y.responseMessage==="OK"){this.projectData.visibility=Q,this.updateVisibilityHelp(Q);let X=Q==="public"?_("Project is now public"):_("Project is now private");if(this.announce(X),eXeLearning.app.interface?.shareButton)eXeLearning.app.interface.shareButton.updateVisibilityPill(Q)}else this.showError(Y.detail||_("Failed to update visibility")),this.visibilitySelect.value=this.projectData.visibility}catch(Y){console.error("Failed to update visibility:",Y),this.showError(_("Failed to update visibility")),this.visibilitySelect.value=this.projectData.visibility}}async handleCopyLink(){let Q=this.linkInput?.value;if(!Q)return;try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(Q),this.showCopySuccess();else this.linkInput.select(),document.execCommand("copy"),this.showCopySuccess();this.announce(_("Link copied to clipboard"))}catch(Z){console.error("Failed to copy link:",Z),this.showError(_("Failed to copy link"))}}showCopySuccess(){if(!this.copyButton)return;let Q=this.copyButton.innerHTML;this.copyButton.classList.add("copied"),this.copyButton.innerHTML=`
            <div class="auto-icon">check</div>
            <span>${_("Copied!")}</span>
        `,setTimeout(()=>{this.copyButton.classList.remove("copied"),this.copyButton.innerHTML=Q},2000)}showInviteError(Q){if(!this.inviteError)return;this.inviteError.textContent=Q,this.inviteError.classList.remove("d-none"),this.inviteError.classList.add("d-block"),this.inviteEmail?.classList.add("is-invalid")}clearInviteError(){if(!this.inviteError)return;this.inviteError.textContent="",this.inviteError.classList.remove("d-block"),this.inviteError.classList.add("d-none"),this.inviteEmail?.classList.remove("is-invalid")}showError(Q){eXeLearning.app.modals.alert.show({title:_("Error"),body:Q,contentId:"error"})}announce(Q){if(!this.ariaLive)return;this.ariaLive.textContent=Q,setTimeout(()=>{this.ariaLive.textContent=""},3000)}validateEmail(Q){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(Q)}escapeHtml(Q){let Z=document.createElement("div");return Z.textContent=Q,Z.innerHTML}}class G1{constructor(Q){this.manager=Q,this.overlay=document.getElementById("printPreviewOverlay"),this.iframe=this.overlay?.querySelector(".print-preview-iframe"),this.loadingEl=this.overlay?.querySelector(".print-preview-loading"),this.printBtn=this.overlay?.querySelector(".print-preview-print-btn"),this.closeBtn=this.overlay?.querySelector(".print-preview-close-btn"),this.blobUrl=null}behaviour(){if(!this.overlay)return;this.printBtn?.addEventListener("click",()=>{this.print()}),this.closeBtn?.addEventListener("click",()=>{this.close()}),document.addEventListener("keydown",(Q)=>{if(Q.key==="Escape"&&this.isVisible())this.close()})}isVisible(){return this.overlay?.getAttribute("data-visible")==="true"}async show(){if(!this.overlay){console.error("[PrintPreview] Overlay element not found");return}this.showLoading(!0),this.overlay.setAttribute("data-visible","true");try{await this.generatePreview()}catch(Q){console.error("[PrintPreview] Error:",Q),this.showError(Q.message||"An error occurred")}}close(){if(this.overlay)this.overlay.setAttribute("data-visible","false");this.cleanup()}async generatePreview(){if(!eXeLearning.app.project?._yjsEnabled)throw Error(_("Print preview requires Yjs mode"));let Q=eXeLearning.app.project?._yjsBridge;if(!Q?.documentManager)throw Error(_("Document manager not available"));let Z=window.generatePrintPreview||window.SharedExporters?.generatePrintPreview;if(typeof Z!=="function")throw Error(_("Print preview not available"));let Y=await Z(Q.documentManager,Q.resourceFetcher||null,{baseUrl:window.eXeLearning?.config?.baseURL||window.location.origin,basePath:window.eXeLearning?.config?.basePath||"",version:window.eXeLearning?.config?.version||"v1.0.0"});if(!Y.success||!Y.html)throw Error(Y.error||_("Failed to generate preview"));let X=Y.html,J=Q.assetManager;if(J&&typeof J.resolveAssetUrlsAsync==="function")X=await J.resolveAssetUrlsAsync(X);this.cleanup();let W=new Blob([X],{type:"text/html"});if(this.blobUrl=URL.createObjectURL(W),this.iframe)this.iframe.src=this.blobUrl,this.iframe.onload=()=>{this.showLoading(!1)}}print(){if(this.iframe?.contentWindow)this.iframe.contentWindow.print()}showLoading(Q){if(this.loadingEl)this.loadingEl.classList.toggle("hidden",!Q);if(this.iframe)this.iframe.classList.toggle("hidden",Q)}showError(Q){if(this.loadingEl)this.loadingEl.innerHTML=`
                <div class="print-preview-error">
                    <span class="exe-icon">error</span>
                    <p>${Q}</p>
                </div>
            `;if(this.iframe)this.iframe.classList.add("hidden")}cleanup(){if(this.blobUrl)URL.revokeObjectURL(this.blobUrl),this.blobUrl=null;if(this.iframe)this.iframe.src="about:blank",this.iframe.classList.add("hidden");if(this.loadingEl)this.loadingEl.classList.remove("hidden"),this.loadingEl.innerHTML=`
                <div class="spinner-border" role="status"></div>
                <p>${_("Generating preview...")}</p>
            `}}class q1{constructor(Q){this.app=Q,this.alert=null,this.info=null,this.confirm=null,this.uploadtodrive=null,this.uploadtodropbox=null,this.filemanager=null,this.stylemanager=null,this.idevicemanager=null,this.odebrokenlinks=null,this.odeusedfiles=null,this.lopd=null,this.assistant=null,this.releasenotes=null,this.legalnotes=null,this.about=null,this.easteregg=null,this.properties=null,this.openuserodefiles=null,this.templateselection=null,this.sessionlogout=null,this.uploadprogress=null,this.share=null,this.printpreview=null}init(){this.alert=new h0(this),this.info=new v0(this),this.confirm=new b0(this),this.uploadtodrive=new g0(this),this.uploadtodropbox=new u0(this),this.filemanager=new m0(this),this.stylemanager=new i0(this),this.idevicemanager=new s0(this),this.odebrokenlinks=new l0(this),this.odeusedfiles=new d0(this),this.lopd=new n0(this),this.assistant=new o0(this),this.releasenotes=new r0(this),this.legalnotes=new a0(this),this.about=new t0(this),this.easteregg=new $1(this),this.properties=new Q1(this),this.openuserodefiles=new Z1(this),this.templateselection=new Y1(this),this.sessionlogout=new X1(this),this.uploadprogress=new J1(document.body),this.share=new z1(this),this.printpreview=new G1(this)}behaviour(){this.alert.behaviour(),this.info.behaviour(),this.confirm.behaviour(),this.uploadtodrive.behaviour(),this.uploadtodropbox.behaviour(),this.filemanager.behaviour(),this.stylemanager.behaviour(),this.idevicemanager.behaviour(),this.odebrokenlinks.behaviour(),this.odeusedfiles.behaviour(),this.lopd.behaviour(),this.assistant.behaviour(),this.releasenotes.behaviour(),this.legalnotes.behaviour(),this.about.behaviour(),this.easteregg.behaviour(),this.properties.behaviour(),this.openuserodefiles.behaviour(),this.templateselection.behaviour(),this.sessionlogout.behaviour(),this.share.behaviour(),this.printpreview.behaviour()}list(){return[this.alert,this.info,this.confirm,this.uploadtodrive,this.uploadtodropbox,this.filemanager,this.stylemanager,this.idevicemanager,this.odebrokenlinks,this.odeusedfiles,this.lopd,this.assistant,this.releasenotes,this.legalnotes,this.about,this.easteregg,this.properties,this.openuserodefiles,this.templateselection,this.sessionlogout,this.share,this.printpreview]}closeModals(){let Q=!1;return this.list().forEach((Z)=>{if(Z&&Z.modal&&Z.modal._isShown&&!Z.permanent)Z.close(!0),Q=!0}),Q}}class H1{constructor(){this.loadingScreenNode=document.querySelector("#main > #load-screen-main"),this.hideTime=1000}show(){this.loadingScreenNode.classList.remove("hide"),this.loadingScreenNode.classList.add("loading"),this.loadingScreenNode.setAttribute("data-visible","true")}hide(){this.loadingScreenNode.classList.remove("loading"),this.loadingScreenNode.classList.add("hiding"),setTimeout(()=>{this.loadingScreenNode.classList.remove("hiding"),this.loadingScreenNode.classList.add("hide"),this.loadingScreenNode.style.display="",this.loadingScreenNode.setAttribute("data-visible","false")},this.hideTime)}}var Q0=window.AppLogger||console;class K1{constructor(){this.odeTitleMenuHeadElement=document.querySelector("#exe-title > .exe-title.content"),this.titleButton=document.querySelector(".title-menu-button"),this.titleContainer=document.querySelector("#exe-title"),this.yjsBinding=null,this.metadataObserver=null,this.titleDebounceTimer=null,this.titleDebounceDelay=300,this.rawTitleText="",new MutationObserver(this.onTitleChanged.bind(this)).observe(this.titleContainer,{childList:!0,characterData:!0,subtree:!0})}init(){this.setTitle(),this.setChangeTitle(),this.checkTitleLineCount(),this.initYjsBinding(),new ResizeObserver(()=>{this.checkTitleLineCount()}).observe(this.odeTitleMenuHeadElement)}initYjsBinding(){let Q=eXeLearning.app.project;if(Q._yjsBridge){let Z=Q._yjsBridge.getDocumentManager();if(Z){let Y=Z.getMetadata(),X=Y.get("title");if(X)this.rawTitleText=X,this.odeTitleMenuHeadElement.textContent=X,this.checkTitleLineCount(),this.typesetTitle(),Q0.log("[OdeTitleMenu] Loaded initial title from Yjs:",X);this.metadataObserver=(J)=>{if(J.transaction.origin==="user")return;J.changes.keys.forEach((W,z)=>{if(z==="title"&&(W.action==="add"||W.action==="update"))this.onRemoteTitleChange(Y.get("title"))})},Y.observe(this.metadataObserver),Q0.log("[OdeTitleMenu] Yjs title binding initialized")}}}onRemoteTitleChange(Q){let Z=Q||_("Untitled document");if(!this.titleContainer.classList.contains("title-editing")){if(this.rawTitleText!==Z)this.rawTitleText=Z,this.odeTitleMenuHeadElement.textContent=Z,this.checkTitleLineCount(),this.typesetTitle(),Q0.log("[OdeTitleMenu] Remote title update:",Z)}this.updatePropertiesInput(Z)}setTitle(){let Q=_("Untitled document"),Z=eXeLearning.app.project;if(Z?._yjsBridge){let Y=Z._yjsBridge.getDocumentManager();if(Y){let J=Y.getMetadata().get("title");if(J)Q=J}}this.rawTitleText=Q,this.odeTitleMenuHeadElement.textContent=Q,this.checkTitleLineCount(),this.typesetTitle()}typesetTitle(){let Q=this.rawTitleText;if(Q&&/(?:\\\(|\\\[|\\begin\{)/.test(Q)){if(typeof MathJax<"u"&&MathJax.typesetPromise)MathJax.typesetPromise([this.odeTitleMenuHeadElement]).catch((Z)=>{Q0.log("[OdeTitleMenu] MathJax typeset error:",Z)})}}setChangeTitle(){let Q=this.odeTitleMenuHeadElement,Z=null,Y=null,X=null,J=!1;this.titleButton.addEventListener("click",(W)=>{W.stopPropagation(),Q.click()}),Q.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(J)return;if(J=!0,Z)Q.removeEventListener("blur",Z);if(Y)Q.removeEventListener("keydown",Y);if(X)Q.removeEventListener("input",X);Q.textContent=this.rawTitleText,Q.setAttribute("contenteditable","true"),this.attachPasteAsPlain(Q),this.titleContainer.classList.add("title-editing"),this.titleContainer.classList.remove("title-not-editing"),this.titleContainer.classList.remove("one-line","two-lines"),setTimeout(()=>{this.placeCursorAtEnd(Q)},0);let W=document.createRange();W.selectNodeContents(Q),W.collapse(!1);let z=window.getSelection();z.removeAllRanges(),z.addRange(W);let G=!1;X=()=>{if(this.rawTitleText=Q.textContent,this.titleDebounceTimer)clearTimeout(this.titleDebounceTimer);this.titleDebounceTimer=setTimeout(()=>{this.saveTitleToYjs(this.rawTitleText),this.titleDebounceTimer=null},this.titleDebounceDelay)},Z=()=>{if(G)return;if(G=!0,this.titleDebounceTimer)clearTimeout(this.titleDebounceTimer),this.titleDebounceTimer=null;if(Q.removeEventListener("blur",Z),Q.removeEventListener("keydown",Y),Q.removeEventListener("input",X),Q.removeAttribute("contenteditable"),Q.scrollTop=0,this.titleContainer.classList.remove("title-editing"),this.titleContainer.classList.add("title-not-editing"),this.rawTitleText=Q.textContent,this.saveTitleToYjs(this.rawTitleText),this.checkTitleLineCount(),this.typesetTitle(),J=!1,Z=null,Y=null,X=null,Q._onPastePlain)Q.removeEventListener("paste",Q._onPastePlain),Q.removeEventListener("drop",Q._onDropPlain),delete Q._onPastePlain,delete Q._onDropPlain},Y=(q)=>{if(q.key==="Enter")q.preventDefault(),Z()},Q.addEventListener("input",X),Q.addEventListener("blur",Z),Q.addEventListener("keydown",Y)}),eXeLearning.app.common.initTooltips(this.titleContainer)}saveTitleToYjs(Q){let Z=eXeLearning.app.project;if(Z._yjsBridge){let Y=Z._yjsBridge.getDocumentManager();if(Y){let X=Y.getMetadata(),J=Y.getDoc();J.transact(()=>{X.set("title",Q),X.set("modifiedAt",Date.now())},J.clientID),this.updatePropertiesInput(Q)}}}async saveTitle(Q){try{let Z=eXeLearning.app.project;if(Z._yjsBridge){let Y=Z._yjsBridge.getDocumentManager();if(Y){let X=Y.getMetadata(),J=Y.getDoc();return J.transact(()=>{X.set("title",Q),X.set("modifiedAt",Date.now())},J.clientID),Q0.log("[OdeTitleMenu] Saved title to Yjs:",Q),this.updatePropertiesInput(Q),{responseMessage:"OK"}}}return{responseMessage:"ERROR",error:"Yjs not available"}}catch(Z){throw console.error("Error in saveTitle:",Z),Z}}checkTitleLineCount(){let Q=this.odeTitleMenuHeadElement,Z=document.querySelector("#exe-title");if(!Q||!Z)return;if(!Q.firstChild){Z.classList.remove("two-lines"),Z.classList.add("one-line");return}let Y=document.createRange();Y.selectNodeContents(Q);let J=Y.getClientRects().length;if(Z.classList.remove("one-line","two-lines"),J>=2)Z.classList.add("two-lines");else Z.classList.add("one-line")}onTitleChanged(Q,Z){for(let Y of Q)if(Y.type==="childList")this.checkTitleLineCount()}placeCursorAtEnd(Q){Q.focus();let Z=window.getSelection(),Y=document.createRange();if(Q.childNodes.length>0){let X=Q.childNodes[Q.childNodes.length-1];if(X.nodeType===Node.TEXT_NODE)Y.setStart(X,X.length);else Y.selectNodeContents(Q),Y.collapse(!1)}else Y.selectNodeContents(Q),Y.collapse(!1);Z.removeAllRanges(),Z.addRange(Y),Q.scrollTop=Q.scrollHeight}async getProjectProperties(){return eXeLearning.app.project.properties.load().then(()=>{return eXeLearning.app.project.properties.properties})}attachPasteAsPlain(Q){let Z=(X)=>{X.preventDefault();let J=(X.clipboardData||window.clipboardData).getData("text/plain")||"";this.insertTextAtCursor(Q,J)},Y=(X)=>{if(X.dataTransfer&&X.dataTransfer.getData("text/html")){X.preventDefault();let W=X.dataTransfer.getData("text/plain")||"";this.insertTextAtCursor(Q,W)}};Q.removeEventListener("paste",Z),Q.removeEventListener("drop",Y),Q.addEventListener("paste",Z),Q.addEventListener("drop",Y),Q._onPastePlain=Z,Q._onDropPlain=Y}insertTextAtCursor(Q,Z){let Y=window.getSelection();if(!Y||Y.rangeCount===0){Q.appendChild(document.createTextNode(Z));return}let X=Y.getRangeAt(0);X.deleteContents();let J=document.createTextNode(Z);X.insertNode(J),X.setStartAfter(J),X.collapse(!0),Y.removeAllRanges(),Y.addRange(X)}updatePropertiesInput(Q){let Z=document.querySelector("#node-content #properties-node-content-form");if(!Z||!Z.offsetParent)return;let Y=Z.querySelector('input[data-testid="prop-pp_title"]');if(Y)Y.value=Q}}var o1=window.AppLogger||console;class V1{constructor(Q){this.maxUsersShow=5,this.concurrentUsersElement=document.querySelector("#exe-concurrent-users"),this.currentUsers=[],this.app=Q,this.unsubscribe=null}async init(){if(!this.isYjsReady()){o1.log("[ConcurrentUsers] Yjs not ready, waiting..."),setTimeout(()=>this.init(),1000);return}this.subscribeToYjsAwareness(),this.updateUsersDisplay(),o1.log("[ConcurrentUsers] Initialized with Yjs Awareness")}isYjsReady(){return!!(this.app.project?._yjsEnabled&&this.app.project?._yjsBridge?.getDocumentManager())}getDocumentManager(){return this.app.project?._yjsBridge?.getDocumentManager()}subscribeToYjsAwareness(){let Q=this.getDocumentManager();if(!Q){console.warn("[ConcurrentUsers] Document manager not available");return}if(this.app.user)Q.setUserInfo({id:this.app.user.id,name:this.app.user.name||this.app.user.username,email:this.app.user.email,gravatarUrl:this.app.user.gravatarUrl});this.unsubscribe=Q.onUsersChange(({users:Z})=>{this.currentUsers=Z,this.updateUsersDisplay()}),this.currentUsers=Q.getOnlineUsers()}updateUsersDisplay(){if(!this.concurrentUsersElement)return;this.concurrentUsersElement.querySelectorAll(".user-current-letter-icon:not(#button-more-exe-concurrent-users)").forEach((Z)=>Z.remove()),this.addConcurrentUsersToElement(),this.updateMoreButton()}addConcurrentUsersToElement(){let Q=this.currentUsers.length;this.currentUsers.slice(0,this.maxUsersShow).forEach((Y)=>{let X=this.createUserElement(Y),J=this.concurrentUsersElement.querySelector("#button-more-exe-concurrent-users");if(J)this.concurrentUsersElement.insertBefore(X,J);else this.concurrentUsersElement.appendChild(X)}),this.concurrentUsersElement.setAttribute("num",Q),this.concurrentUsersElement.setAttribute("show-more-button",Q>1)}createUserElement(Q){let Z=document.createElement("div");if(Z.classList.add("user-current-letter-icon"),Z.classList.add("exe-top-icons"),Z.setAttribute("data-username",Q.name||"User"),Z.setAttribute("data-client-id",Q.clientId),Q.email)Z.title=Q.email;if(Q.color)Z.style.borderColor=Q.color,Z.style.borderWidth="2px",Z.style.borderStyle="solid";if(Q.isLocal)Z.classList.add("is-local-user");let Y=document.createElement("span");Y.classList.add("username"),Y.innerHTML=Q.name||"User";let X=N0(Q.email),J=Q.gravatarUrl||s(Q.email,50);if(J){let W=document.createElement("img");W.className="exe-gravatar rounded-circle",W.src=J,W.alt=Q.name||"User",W.height=50,W.width=50;let z=Q.initials||v(Q.name||Q.email);W.onerror=function(){this.style.display="none";let G=document.createElement("span");G.className="avatar-initials",G.textContent=z,Z.insertBefore(G,Y)},Z.appendChild(W),Z.appendChild(Y)}else{let W=Q.initials||v(Q.name||Q.email);Z.innerText=W,Z.appendChild(Y)}if(X){let W=document.createElement("span");W.classList.add("guest-badge"),W.textContent=_("Guest"),Z.appendChild(W)}return Z}updateMoreButton(){let Q=this.concurrentUsersElement.querySelector("#button-more-exe-concurrent-users");if(!Q)return;let Z=this.currentUsers.length;if(Z>1)Q.classList.add("d-flex"),Q.style.display="block";else Q.classList.remove("d-flex"),Q.style.display="none";Q.title=`${_("Users online")} (${Z})`,Q.setAttribute("title",`${_("Users online")} (${Z})`);let Y=Q.cloneNode(!0);Q.parentNode.replaceChild(Y,Q),Y.addEventListener("click",()=>{eXeLearning.app.modals.info.show({title:`${_("Users online")} (${Z})`,body:this.makeBodyHTMLConcurrentUsersModal()})})}getConcurrentUsersElementsList(){return this.currentUsers.map((Q)=>this.createUserElement(Q))}makeBodyHTMLConcurrentUsersModal(){let Q=document.createElement("div");return Q.classList.add("exe-concurrent-users"),this.currentUsers.forEach((Z)=>{let Y=this.createUserElement(Z),X=document.createElement("div");if(X.classList.add("user-info"),Z.selectedPageId){let J=document.createElement("span");J.classList.add("user-page-info"),J.textContent="\uD83D\uDCC4 Viewing page",X.appendChild(J)}if(Z.isLocal){let J=document.createElement("span");J.classList.add("badge","bg-primary","ms-2"),J.textContent=_("You"),X.appendChild(J)}Y.appendChild(X),Q.appendChild(Y)}),Q.outerHTML}destroy(){if(this.unsubscribe)this.unsubscribe(),this.unsubscribe=null;o1.log("[ConcurrentUsers] Destroyed")}}class R1{constructor(){this.connTimeElementWrapper=document.querySelector("#exe-last-edition"),this.connTimeElement=document.querySelector("#exe-last-edition .content"),this.lastUpdatedJson=null,this.lastUpdatedDate=null,this.intervalTime=eXeLearning.config.clientIntervalGetLastEdition}async init(){await this.loadLasUpdatedInInterface()}async loadLasUpdatedInInterface(){this.loadLastUpdated().then((Q)=>{this.setLastUpdatedToElement()})}async loadLastUpdated(){let Q=eXeLearning.app.project.odeId;this.lastUpdatedJson=await eXeLearning.app.api.getOdeLastUpdated(Q),this.lastUpdatedDate=this.lastUpdatedJson.lastUpdatedDate}setLastUpdatedToElement(){if(this.lastUpdatedDate){let Q=this.getTimeDiffToNow(),Z=this.makeStringTimeDiff(Q.days,Q.hours,Q.minutes);$(this.connTimeElementWrapper).attr("data-bs-original-title",`${Z}`),this.connTimeElement.innerHTML=`<span class="auto-icon" aria-hidden="true">history</span><span class="visually-hidden">${Z}</span>`,this.connTimeElementWrapper.className="saved",$("#head-top-save-button").attr("data-bs-original-title",Z).removeClass("unsaved")}else if(eXeLearning.app.user.preferences.preferences.versionControl.value==="false"&&eXeLearning.app.project.offlineInstallation)$(this.connTimeElementWrapper).attr("data-bs-original-title",_("No previous versions")),this.connTimeElement.innerHTML='<span class="auto-icon" aria-hidden="true">work_history</span><span class="visually-hidden">'+_("No previous versions")+"</span>",this.connTimeElementWrapper.className="no-versions",$("#head-top-save-button").attr("data-bs-original-title",_("No previous versions")).removeClass("unsaved");else $(this.connTimeElementWrapper).attr("data-bs-original-title",_("Unsaved project")),this.connTimeElement.innerHTML='<span class="auto-icon" aria-hidden="true">warning</span><span class="visually-hidden">'+_("Unsaved project")+"</span>",this.connTimeElementWrapper.className="unsaved",$("#head-top-save-button").attr("data-bs-original-title",_("Unsaved project")).addClass("unsaved");$("#exe-last-edition").tooltip()}getTimeDiffToNow(){let Z=Math.floor(new Date().getTime()/1000)-this.lastUpdatedDate,Y=Math.max(0,Math.floor(Z/60/60/60)),X=Math.max(0,Math.floor(Z/60/60)),J=Math.max(0,Math.floor(Z/60));return{days:Y,hours:X,minutes:J}}makeStringTimeDiff(Q,Z,Y){let X="";if(Q==1)X=_("Saved one day ago");else if(Q>1)X=_("Saved %s days ago"),X=X.replace("%s",Q);else if(Z==1)X=_("Saved an hours ago");else if(Z>1)X=_("Saved %s hours ago"),X=X.replace("%s",Z);else if(Y)X=_("Saved %s minutes ago"),X=X.replace("%s",Y);else X=_("Saved a few seconds ago");return X}}var T2=window.AppLogger||console;class A1{constructor(){this.saveMenuHeadButton=document.querySelector("#head-top-save-button"),this.isSaving=!1}init(){this.addEventClick()}addEventClick(){this.saveMenuHeadButton.addEventListener("click",async(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.isSaving){T2.log("[SaveButton] Save already in progress");return}let Z=eXeLearning.app.project;if(Z.realTimeEventNotifier)Z.realTimeEventNotifier.notify(Z.odeSession,{name:"save-menu-head-button",payload:!0});if(eXeLearning.config.isOfflineInstallation)eXeLearning.app.menus.navbar.file.downloadProjectEvent();else await this.saveToServer()})}async saveToServer(){this.isSaving=!0,this.setButtonLoading(!0);try{let Q=eXeLearning.app.project._yjsBridge;if(!Q||!Q.saveManager){console.warn("[SaveButton] SaveManager not available, using legacy save"),await eXeLearning.app.project.save();return}let Z=await Q.saveManager.save({showProgress:!0});if(Z.success)T2.log("[SaveButton] Project saved successfully");else console.error("[SaveButton] Save failed:",Z.error)}catch(Q){console.error("[SaveButton] Save error:",Q)}finally{this.isSaving=!1,this.setButtonLoading(!1)}}setButtonLoading(Q){if(!this.saveMenuHeadButton)return;if(Q)this.saveMenuHeadButton.classList.add("saving"),this.saveMenuHeadButton.setAttribute("disabled","disabled");else this.saveMenuHeadButton.classList.remove("saving"),this.saveMenuHeadButton.removeAttribute("disabled")}}class O1{constructor(){this.shareButton=document.querySelector("#head-top-share-button"),this.visibilityIcon=this.shareButton?.querySelector(".share-visibility-icon"),this.currentVisibility="private"}init(){this.addEventClick()}addEventClick(){if(!this.shareButton)return;this.shareButton.addEventListener("click",async(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.openShareModal()})}openShareModal(){if(eXeLearning.app.modals?.share)eXeLearning.app.modals.share.show();else console.error("ShareProjectButton: Share modal not available")}updateVisibilityPill(Q){if(!this.visibilityIcon)return;if(this.currentVisibility=Q,Q==="public")this.visibilityIcon.textContent="public";else this.visibilityIcon.textContent="lock"}async loadVisibilityFromProject(){let Q=eXeLearning.app.project?.odeId;if(!Q){let Z=eXeLearning.app.params?.defaultProjectVisibility||"private";this.updateVisibilityPill(Z);return}try{let Z=await eXeLearning.app.api.getProject(Q);if(Z?.responseMessage==="OK"&&Z.project?.visibility)this.updateVisibilityPill(Z.project.visibility)}catch(Z){console.warn("[ShareButton] Could not load project visibility:",Z)}}getCurrentDocumentUrl(){let Q=new URL(window.location.href),Z=eXeLearning.app.project?.odeId||eXeLearning.app.project?.requestedProjectId||Q.searchParams.get("project");if(Z)Q.searchParams.set("project",Z),Q.searchParams.delete("projectId"),Q.searchParams.delete("odeSessionId");return Q.toString()}}class F1{constructor(){this.downloadMenuHeadButton=document.querySelector("#head-top-download-button")}init(){this.addEventClick()}addEventClick(){this.downloadMenuHeadButton.addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;eXeLearning.app.menus.navbar.file.downloadProjectEvent()})}}var j=window.AppLogger||console;class M1{constructor(){this.panel=document.getElementById("previewsidenav"),this.overlay=document.getElementById("preview-sidenav-overlay"),this.closeButton=document.getElementById("previewsidenavclose"),this.extractButton=document.getElementById("preview-extract-button"),this.pinButton=document.getElementById("preview-pin-button"),this.refreshButton=document.getElementById("preview-refresh-button"),this.iframe=document.getElementById("preview-iframe"),this.pinnedContainer=document.getElementById("preview-pinned-container"),this.pinnedIframe=document.getElementById("preview-pinned-iframe"),this.pinnedExtractButton=document.getElementById("preview-pinned-extract-button"),this.unpinButton=document.getElementById("preview-unpin-button"),this.pinnedRefreshButton=document.getElementById("preview-pinned-refresh-button"),this.isOpen=!1,this.isPinned=!1,this.isLoading=!1,this.autoRefreshEnabled=!0,this.refreshDebounceTimer=null,this.refreshDebounceDelay=500,this._unsubscribeStructure=null,this._onYdocUpdate=null}init(){this.bindEvents(),this.subscribeToChanges(),this.restorePinnedState(),j.log("[PreviewPanel] Initialized")}bindEvents(){this.closeButton?.addEventListener("click",()=>this.close()),this.overlay?.addEventListener("click",()=>this.close()),this.extractButton?.addEventListener("click",()=>this.extractToNewTab()),this.pinButton?.addEventListener("click",()=>this.pin()),this.refreshButton?.addEventListener("click",()=>this.refresh()),this.closeButton?.addEventListener("keydown",(Q)=>{if(Q.key==="Enter"||Q.key===" ")Q.preventDefault(),this.close()}),this.pinnedExtractButton?.addEventListener("click",()=>this.extractToNewTab()),this.unpinButton?.addEventListener("click",()=>this.unpin()),this.pinnedRefreshButton?.addEventListener("click",()=>this.refresh()),document.addEventListener("keydown",(Q)=>{if(Q.key==="Escape"&&this.isOpen&&!this.isPinned)this.close();if(Q.ctrlKey&&Q.shiftKey&&Q.key==="P")Q.preventDefault(),this.toggle()}),window.addEventListener("message",async(Q)=>{if(Q.data?.type==="requestPdfBlob"){let{assetId:Z,requestId:Y}=Q.data;j.log(`[PreviewPanel] Received requestPdfBlob for ${Z}`);try{let X=eXeLearning?.app?.project?._yjsBridge?.assetManager;if(!X)throw Error("AssetManager not available");let J=await X.getAsset(Z);if(!J?.blob)throw Error("Asset not found in IndexedDB");Q.source.postMessage({type:"pdfBlobResponse",requestId:Y,blob:J.blob,success:!0},"*"),j.log(`[PreviewPanel] Sent PDF blob for ${Z}`)}catch(X){j.error("[PreviewPanel] Failed to get PDF blob:",X),Q.source.postMessage({type:"pdfBlobResponse",requestId:Y,error:X.message,success:!1},"*")}return}if(Q.data?.type==="exe-download-elpx"){j.log("[PreviewPanel] Received exe-download-elpx request");try{let Z=eXeLearning?.app?.project;if(Z?.exportToElpxViaYjs)await Z.exportToElpxViaYjs({saveAs:!0});else j.error("[PreviewPanel] exportToElpxViaYjs not available"),alert(_("ELPX export not available. Please save your project first."))}catch(Z){j.error("[PreviewPanel] ELPX export failed:",Z),alert(_("Error generating ELPX file:")+" "+Z.message)}return}if(Q.data?.type==="openPdfPopup"){let{assetId:Z}=Q.data;j.log(`[PreviewPanel] Received openPdfPopup request for ${Z}`);try{let Y=eXeLearning?.app?.project?._yjsBridge?.assetManager;if(!Y)throw Error("AssetManager not available");let X=await Y.getAsset(Z);if(!X?.blob)throw Error("Asset not found in IndexedDB");let J=URL.createObjectURL(X.blob);if(!window.open(J,"_blank","width=900,height=700"))window.open(J,"_blank");j.log(`[PreviewPanel] Opened PDF popup for ${Z}`)}catch(Y){j.error("[PreviewPanel] Failed to open PDF popup:",Y)}}if(Q.data?.type==="exe-resolve-html-link-forward"){let{requestId:Z,href:Y,baseFolder:X}=Q.data;j.log(`[PreviewPanel] Received HTML link resolution request: ${Y}`);try{let J=eXeLearning?.app?.project?._yjsBridge?.assetManager;if(!J)throw Error("AssetManager not available");let W=J.findAssetByRelativePath(X,Y);if(!W)throw Error(`Asset not found: ${Y} from ${X}`);let z=await J.resolveHtmlWithAssets(W.id);if(!z)throw Error(`Failed to resolve HTML asset: ${W.id}`);Q.source.postMessage({type:"exe-html-link-resolved",requestId:Z,resolvedUrl:z},"*"),j.log(`[PreviewPanel] Resolved HTML link: ${Y} -> blob URL`)}catch(J){j.error("[PreviewPanel] Failed to resolve HTML link:",J),Q.source.postMessage({type:"exe-html-link-resolved",requestId:Z,resolvedUrl:null,error:J.message},"*")}return}})}subscribeToChanges(){let Q=eXeLearning?.app?.project;if(!Q?._yjsEnabled||!Q._yjsBridge){j.log("[PreviewPanel] Yjs not enabled, auto-refresh disabled");return}let Z=Q._yjsBridge,Y=Z.documentManager;if(this._unsubscribeStructure=Z.onStructureChange(()=>{if(this.isOpen||this.isPinned)this.scheduleRefresh()}),Y?.ydoc)this._onYdocUpdate=(X,J)=>{if(!this.isOpen&&!this.isPinned)return;if(J==="system"||J==="initial")return;this.scheduleRefresh()},Y.ydoc.on("update",this._onYdocUpdate),j.log("[PreviewPanel] Subscribed to Yjs document updates");j.log("[PreviewPanel] Subscribed to Yjs changes (structure + content)")}scheduleRefresh(){if(!this.autoRefreshEnabled)return;if(this.refreshDebounceTimer)clearTimeout(this.refreshDebounceTimer);this.refreshDebounceTimer=setTimeout(()=>{this.refresh()},this.refreshDebounceDelay)}async toggle(){if(this.isPinned)this.unpin();else if(this.isOpen)this.close();else await this.open()}async open(){if(this.isPinned)return;if(eXeLearning?.app?.project?.checkOpenIdevice())return;this.isOpen=!0,this.panel?.classList.add("active"),this.overlay?.classList.add("active"),await this.refresh(),j.log("[PreviewPanel] Panel opened")}close(){if(this.isPinned)return;this.isOpen=!1,this.panel?.classList.remove("active"),this.overlay?.classList.remove("active"),j.log("[PreviewPanel] Panel closed")}async pin(){if(this.isPinned)return;this.panel?.classList.remove("active"),this.overlay?.classList.remove("active"),this.isPinned=!0,this.isOpen=!0,document.getElementById("workarea")?.setAttribute("data-preview-pinned","true"),await this.refresh(),this.savePinnedPreference(!0),j.log("[PreviewPanel] Preview pinned to layout")}unpin(){if(!this.isPinned)return;this.isPinned=!1,document.getElementById("workarea")?.setAttribute("data-preview-pinned","false"),this.isOpen=!0,this.panel?.classList.add("active"),this.overlay?.classList.add("active"),this.refresh(),this.savePinnedPreference(!1),j.log("[PreviewPanel] Preview unpinned")}async refresh(){if(this.isLoading)return;this.isLoading=!0,this.showLoadingState();try{let Q=await this.generatePreviewHtml();if(Q)this.injectHtmlToIframe(Q)}catch(Q){j.error("[PreviewPanel] Error generating preview:",Q),this.showError(Q.message)}finally{this.isLoading=!1,this.hideLoadingState()}}async extractToNewTab(){try{j.log("[PreviewPanel] Extracting preview to new tab...");let Q=await this.generateStandalonePreviewHtml();if(!Q){j.error("[PreviewPanel] Failed to generate standalone preview HTML");return}let Z=new Blob([Q],{type:"text/html;charset=utf-8"}),Y=URL.createObjectURL(Z);if(window.open(Y,"_blank"))j.log("[PreviewPanel] Preview opened in new tab"),setTimeout(()=>{URL.revokeObjectURL(Y)},5000);else{j.warn("[PreviewPanel] Popup blocked - trying fallback");let J=document.createElement("a");J.href=Y,J.target="_blank",J.click(),setTimeout(()=>{URL.revokeObjectURL(Y)},5000)}}catch(Q){j.error("[PreviewPanel] Error extracting to new tab:",Q)}}async generateStandalonePreviewHtml(){let Q=eXeLearning?.app?.project?._yjsBridge;if(!Q?.documentManager)return j.warn("[PreviewPanel] Yjs document manager not available"),null;let Z=window.SharedExporters;if(!Z?.generatePreview)return j.error("[PreviewPanel] SharedExporters not loaded"),null;let Y=Q.documentManager,X=Q.resourceFetcher||null,W=!eXeLearning.app?.capabilities?.storage?.remote,z=W?window.location.pathname.replace(/\/?(index\.html)?$/,""):"",G=eXeLearning.app?.themes?.selected,q=G?.path||null,H=null,K=null;if(G?.isUserTheme||q?.startsWith("user-theme://")){try{let F=G?.id||q?.replace("user-theme://","");if(F&&X){let U=X.getUserTheme(F);if(!U&&X.getUserThemeAsync)U=await X.getUserThemeAsync(F);if(U){let L=U.get("style.css")||U.get(`${F}/style.css`);if(L){let B=await L.text();B=await this.processUserThemeCssUrls(B,U,F),H=B,j.log(`[PreviewPanel] Loaded user theme CSS for standalone preview (${H.length} chars)`)}let D=U.get("style.js")||U.get(`${F}/style.js`);if(D)K=await D.text(),j.log(`[PreviewPanel] Loaded user theme JS for standalone preview (${K.length} chars)`)}}}catch(F){j.warn("[PreviewPanel] Failed to load user theme CSS/JS for standalone:",F)}q=null}else if(q&&!q.startsWith("http")&&!q.startsWith("blob:")&&!q.startsWith("exe:")){let F=q.startsWith("./")?q.slice(2):q.startsWith("/")?q.slice(1):q;q=`${W?`${window.location.origin}${z}`:window.location.origin}/${F}`}let R={baseUrl:window.location.origin,basePath:W?"/":eXeLearning.app.config?.basePath||"/",version:window.eXeLearning?.config?.version||"v1.0.0",isStaticMode:W,themeUrl:q,userThemeCss:H,userThemeJs:K},O=await Z.generatePreview(Y,X,R);if(!O.success||!O.html)throw Error(O.error||"Failed to generate preview");let A=O.html;if(W){let F=`${window.location.origin}${z}`;A=A.replace(/((?:href|src)=["'])(\/(?!\/|[a-z]+:))([^"']+)(["'])/gi,(U,L,D,B,P)=>{let S=B;return S=S.replace(/^v[^/]*\//,""),`${L}${F}/${S}${P}`}),j.log("[PreviewPanel] Converted relative URLs to absolute for standalone preview, base:",F)}let M=typeof window.addMediaTypes==="function"?window.addMediaTypes(A):A;if(typeof window.simplifyMediaElements==="function")M=window.simplifyMediaElements(M);if(M=await this.resolveHtmlIframeAssetsForStandalone(M),typeof window.resolveAssetUrlsAsync==="function")try{M=await window.resolveAssetUrlsAsync(M,{convertBlobUrls:!0,convertIframeBlobUrls:!0,skipIframeSrc:!1})}catch(F){j.warn("[PreviewPanel] Failed to resolve asset URLs for standalone:",F)}return M}async generatePreviewHtml(){let Q=eXeLearning?.app?.project?._yjsBridge;if(!Q?.documentManager)return j.warn("[PreviewPanel] Yjs document manager not available"),null;let Z=window.SharedExporters;if(!Z?.generatePreview)return j.error("[PreviewPanel] SharedExporters not loaded"),null;let Y=Q.documentManager,X=Q.resourceFetcher||null,J=eXeLearning.app?.themes?.selected,z=!eXeLearning.app?.capabilities?.storage?.remote,G=J?.path||null,q=null,H=null,K=z?window.location.pathname.replace(/\/?(index\.html)?$/,""):"";if(J?.isUserTheme||G?.startsWith("user-theme://")){console.log("[PreviewPanel] Detected USER THEME, loading CSS/JS inline...");try{let F=J?.id||G?.replace("user-theme://","");if(console.log(`[PreviewPanel] Theme name: ${F}, resourceFetcher available: ${!!X}`),F&&X){let U=X.getUserTheme(F);if(console.log(`[PreviewPanel] getUserTheme sync result: ${U?U.size+" files":"null"}`),!U&&X.getUserThemeAsync)U=await X.getUserThemeAsync(F),console.log(`[PreviewPanel] getUserThemeAsync result: ${U?U.size+" files":"null"}`);if(U){let L=U.get("style.css")||U.get(`${F}/style.css`);if(console.log(`[PreviewPanel] style.css found: ${!!L}`),L){let B=await L.text();B=await this.processUserThemeCssUrls(B,U,F),q=B,console.log(`[PreviewPanel] Loaded user theme CSS for '${F}' (${q.length} chars)`)}let D=U.get("style.js")||U.get(`${F}/style.js`);if(console.log(`[PreviewPanel] style.js found: ${!!D}`),D)H=await D.text(),console.log(`[PreviewPanel] Loaded user theme JS for '${F}' (${H.length} chars)`)}}}catch(F){console.error("[PreviewPanel] Failed to load user theme CSS/JS:",F)}G=null}else if(G&&!G.startsWith("http")&&!G.startsWith("blob:")&&!G.startsWith("exe:")){let F=G.startsWith("./")?G.slice(2):G.startsWith("/")?G.slice(1):G;G=`${z?`${window.location.origin}${K}`:window.location.origin}/${F}`}let R={baseUrl:window.location.origin,basePath:z?"/":eXeLearning.app.config?.basePath||"/",version:window.eXeLearning?.config?.version||"v1.0.0",isStaticMode:z,themeUrl:G,userThemeCss:q,userThemeJs:H},O=await Z.generatePreview(Y,X,R);if(!O.success||!O.html)throw Error(O.error||"Failed to generate preview");let A=O.html;if(z){let F=`${window.location.origin}${K}`;A=A.replace(/((?:href|src)=["'])(\/(?!\/|[a-z]+:))([^"']+)(["'])/gi,(U,L,D,B,P)=>{let S=B;return S=S.replace(/^v[^/]*\//,""),`${L}${F}/${S}${P}`}),j.log("[PreviewPanel] Converted relative URLs to absolute for static mode, base:",F)}let M=typeof window.addMediaTypes==="function"?window.addMediaTypes(A):A;if(typeof window.simplifyMediaElements==="function")M=window.simplifyMediaElements(M);if(typeof window.resolveAssetUrlsAsync==="function")try{M=await window.resolveAssetUrlsAsync(M,{convertBlobUrls:!1,convertIframeBlobUrls:!1,skipIframeSrc:!0})}catch(F){j.warn("[PreviewPanel] Failed to resolve asset URLs:",F)}return M=await this.resolveHtmlIframeAssets(M),M=this.injectPdfBlobUrlConverter(M),M=this.injectHtmlLinkHandler(M),M}async resolveHtmlIframeAssets(Q){let Z=eXeLearning?.app?.project?._yjsBridge?.assetManager;if(!Z)return j.warn("[PreviewPanel] AssetManager not available for HTML iframe resolution"),Q;let Y=/<iframe([^>]*)src=["'](asset:\/\/[^"']+)["']([^>]*)>/gi,X=[...Q.matchAll(Y)];if(X.length===0)return Q;let J=Q;for(let W of X){let[z,G,q,H]=W,K=q.match(/asset:\/\/([a-f0-9-]+)/i);if(!K)continue;let V=K[1],R=Z.getAssetMetadata(V);if(!R)continue;if(!Z._isHtmlAsset(R.mime,R.filename))continue;try{let A=await Z.resolveHtmlWithAssets(V);if(A){let M=`<iframe${G}src="${A}" data-asset-src="${q}"${H}>`;J=J.replace(z,M),j.log(`[PreviewPanel] Resolved HTML iframe: ${V} -> ${A.substring(0,30)}...`)}}catch(A){j.warn(`[PreviewPanel] Failed to resolve HTML iframe ${V}:`,A)}}return J}async resolveHtmlIframeAssetsForStandalone(Q){let Z=eXeLearning?.app?.project?._yjsBridge?.assetManager;if(!Z)return j.warn("[PreviewPanel] AssetManager not available for standalone HTML iframe resolution"),Q;let Y=/<iframe([^>]*)src=["'](asset:\/\/[^"']+)["']([^>]*)>/gi,X=[...Q.matchAll(Y)];if(X.length===0)return Q;let J=Q;for(let W of X){let[z,G,q,H]=W,K=q.match(/asset:\/\/([a-f0-9-]+)/i);if(!K)continue;let V=K[1],R=Z.getAssetMetadata(V);if(!R)continue;if(!Z._isHtmlAsset(R.mime,R.filename))continue;try{let A=await Z.resolveHtmlWithAssetsAsDataUrls(V);if(A){let M=A.replace(/&/g,"&amp;").replace(/"/g,"&quot;"),F=`<iframe${G}srcdoc="${M}"${H}>`;J=J.replace(z,F),j.log(`[PreviewPanel] Resolved HTML iframe for standalone: ${V} -> srcdoc (${A.length} bytes)`)}}catch(A){j.warn(`[PreviewPanel] Failed to resolve HTML iframe for standalone ${V}:`,A)}}return J}injectPdfBlobUrlConverter(Q){let Z=eXeLearning?.app?.config?.basePath||"",Y=window.location.origin,X=`${Y}${Z}/libs/pdfjs/pdf.min.mjs`,J=`${Y}${Z}/libs/pdfjs/pdf.worker.min.mjs`,W=`
<script type="module">
(async function() {
    // Load PDF.js
    let pdfjsLib = null;
    try {
        const pdfjs = await import('${X}');
        pdfjsLib = pdfjs;
        pdfjsLib.GlobalWorkerOptions.workerSrc = '${J}';
        console.log('[PreviewPanel] PDF.js loaded successfully');
    } catch (e) {
        console.warn('[PreviewPanel] Failed to load PDF.js:', e.message);
    }

    // Map to track pending blob requests
    var pendingRequests = {};
    var requestIdCounter = 0;

    // Listen for blob responses from parent
    window.addEventListener('message', function(event) {
        if (event.data?.type !== 'pdfBlobResponse') return;

        var requestId = event.data.requestId;
        var pending = pendingRequests[requestId];
        if (!pending) return;

        delete pendingRequests[requestId];

        if (event.data.success && event.data.blob) {
            pending.resolve(event.data.blob);
        } else {
            pending.reject(new Error(event.data.error || 'Failed to get blob'));
        }
    });

    // Request blob from parent and return promise
    function requestBlobFromParent(assetId) {
        return new Promise(function(resolve, reject) {
            var requestId = 'req_' + (++requestIdCounter);
            pendingRequests[requestId] = { resolve: resolve, reject: reject };

            window.parent.postMessage({
                type: 'requestPdfBlob',
                assetId: assetId,
                requestId: requestId
            }, '*');

            setTimeout(function() {
                if (pendingRequests[requestId]) {
                    delete pendingRequests[requestId];
                    reject(new Error('Timeout requesting blob'));
                }
            }, 15000);
        });
    }

    // Zoom levels
    var ZOOM_LEVELS = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 2.0];

    // Create PDF viewer with controls
    function createPdfViewer(iframe, assetUrl) {
        var width = iframe.width || iframe.style.width || '100%';
        var height = iframe.height || iframe.style.height || '400px';
        if (typeof width === 'number' || !width.includes('%')) width = width + 'px';
        if (typeof height === 'number' || !height.includes('%')) height = height + 'px';

        var container = document.createElement('div');
        container.className = 'exe-pdf-viewer';
        container.setAttribute('data-asset-url', assetUrl);
        container.style.cssText = 'width:' + width + ';height:' + height + ';' +
            'display:flex;flex-direction:column;border:1px solid #ccc;border-radius:4px;' +
            'background:#525659;font-family:system-ui,-apple-system,sans-serif;overflow:hidden;';

        // Toolbar
        var toolbar = document.createElement('div');
        toolbar.className = 'exe-pdf-toolbar';
        toolbar.style.cssText = 'display:flex;align-items:center;justify-content:center;gap:8px;' +
            'padding:6px 12px;background:#323639;border-bottom:1px solid #1a1a1a;flex-shrink:0;';

        // Navigation buttons
        var prevBtn = document.createElement('button');
        prevBtn.innerHTML = '◀';
        prevBtn.title = 'Previous page';
        prevBtn.style.cssText = 'background:#525659;border:none;color:#fff;padding:4px 8px;' +
            'border-radius:3px;cursor:pointer;font-size:12px;';
        prevBtn.disabled = true;

        var pageInfo = document.createElement('span');
        pageInfo.className = 'exe-pdf-page-info';
        pageInfo.textContent = 'Loading...';
        pageInfo.style.cssText = 'color:#fff;font-size:12px;min-width:80px;text-align:center;';

        var nextBtn = document.createElement('button');
        nextBtn.innerHTML = '▶';
        nextBtn.title = 'Next page';
        nextBtn.style.cssText = prevBtn.style.cssText;
        nextBtn.disabled = true;

        // Separator
        var sep1 = document.createElement('span');
        sep1.style.cssText = 'width:1px;height:16px;background:#666;margin:0 4px;';

        // Zoom controls
        var zoomOutBtn = document.createElement('button');
        zoomOutBtn.innerHTML = '−';
        zoomOutBtn.title = 'Zoom out';
        zoomOutBtn.style.cssText = prevBtn.style.cssText + 'font-size:16px;font-weight:bold;';

        var zoomInfo = document.createElement('span');
        zoomInfo.className = 'exe-pdf-zoom-info';
        zoomInfo.textContent = '100%';
        zoomInfo.style.cssText = 'color:#fff;font-size:12px;min-width:45px;text-align:center;';

        var zoomInBtn = document.createElement('button');
        zoomInBtn.innerHTML = '+';
        zoomInBtn.title = 'Zoom in';
        zoomInBtn.style.cssText = zoomOutBtn.style.cssText;

        var fitBtn = document.createElement('button');
        fitBtn.innerHTML = '⛶';
        fitBtn.title = 'Fit to width';
        fitBtn.style.cssText = prevBtn.style.cssText + 'font-size:14px;';

        // Separator
        var sep2 = document.createElement('span');
        sep2.style.cssText = sep1.style.cssText;

        // Open in popup button
        var popupBtn = document.createElement('button');
        popupBtn.innerHTML = '↗';
        popupBtn.title = 'Open in new window';
        popupBtn.style.cssText = prevBtn.style.cssText + 'font-size:14px;';

        toolbar.appendChild(prevBtn);
        toolbar.appendChild(pageInfo);
        toolbar.appendChild(nextBtn);
        toolbar.appendChild(sep1);
        toolbar.appendChild(zoomOutBtn);
        toolbar.appendChild(zoomInfo);
        toolbar.appendChild(zoomInBtn);
        toolbar.appendChild(fitBtn);
        toolbar.appendChild(sep2);
        toolbar.appendChild(popupBtn);

        // Canvas container with scroll
        var canvasContainer = document.createElement('div');
        canvasContainer.className = 'exe-pdf-canvas-container';
        canvasContainer.style.cssText = 'flex:1;overflow:auto;display:flex;justify-content:center;' +
            'align-items:flex-start;padding:10px;';

        var canvas = document.createElement('canvas');
        canvas.className = 'exe-pdf-canvas';
        canvas.style.cssText = 'box-shadow:0 2px 8px rgba(0,0,0,0.3);background:#fff;';
        canvasContainer.appendChild(canvas);

        container.appendChild(toolbar);
        container.appendChild(canvasContainer);

        // Store references for later use
        container._elements = {
            canvas: canvas,
            canvasContainer: canvasContainer,
            prevBtn: prevBtn,
            nextBtn: nextBtn,
            pageInfo: pageInfo,
            zoomOutBtn: zoomOutBtn,
            zoomInBtn: zoomInBtn,
            zoomInfo: zoomInfo,
            fitBtn: fitBtn,
            popupBtn: popupBtn
        };
        container._state = {
            pdfDoc: null,
            currentPage: 1,
            totalPages: 0,
            scale: 1.0,
            zoomIndex: 3, // Index of 1.0 in ZOOM_LEVELS
            assetUrl: assetUrl,
            rendering: false
        };

        return container;
    }

    // Render a page
    async function renderPage(container) {
        var state = container._state;
        var els = container._elements;

        if (!state.pdfDoc || state.rendering) return;
        state.rendering = true;

        try {
            var page = await state.pdfDoc.getPage(state.currentPage);
            var viewport = page.getViewport({ scale: state.scale });

            els.canvas.width = viewport.width;
            els.canvas.height = viewport.height;

            var ctx = els.canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            // Update UI
            els.pageInfo.textContent = state.currentPage + ' / ' + state.totalPages;
            els.prevBtn.disabled = state.currentPage <= 1;
            els.nextBtn.disabled = state.currentPage >= state.totalPages;
            els.zoomInfo.textContent = Math.round(state.scale * 100) + '%';
            els.zoomOutBtn.disabled = state.zoomIndex <= 0;
            els.zoomInBtn.disabled = state.zoomIndex >= ZOOM_LEVELS.length - 1;
        } catch (e) {
            console.error('[PreviewPanel] Failed to render page:', e);
            els.pageInfo.textContent = 'Error';
        }

        state.rendering = false;
    }

    // Fit to container width
    async function fitToWidth(container) {
        var state = container._state;
        var els = container._elements;

        if (!state.pdfDoc) return;

        var page = await state.pdfDoc.getPage(state.currentPage);
        var containerWidth = els.canvasContainer.clientWidth - 20; // padding
        var viewport = page.getViewport({ scale: 1.0 });
        var newScale = containerWidth / viewport.width;

        // Find closest zoom level
        var closestIndex = 0;
        var minDiff = Math.abs(ZOOM_LEVELS[0] - newScale);
        for (var i = 1; i < ZOOM_LEVELS.length; i++) {
            var diff = Math.abs(ZOOM_LEVELS[i] - newScale);
            if (diff < minDiff) {
                minDiff = diff;
                closestIndex = i;
            }
        }

        state.scale = newScale;
        state.zoomIndex = closestIndex;
        await renderPage(container);
    }

    // Setup event handlers
    function setupControls(container) {
        var state = container._state;
        var els = container._elements;

        els.prevBtn.onclick = async function() {
            if (state.currentPage > 1) {
                state.currentPage--;
                await renderPage(container);
            }
        };

        els.nextBtn.onclick = async function() {
            if (state.currentPage < state.totalPages) {
                state.currentPage++;
                await renderPage(container);
            }
        };

        els.zoomOutBtn.onclick = async function() {
            if (state.zoomIndex > 0) {
                state.zoomIndex--;
                state.scale = ZOOM_LEVELS[state.zoomIndex];
                await renderPage(container);
            }
        };

        els.zoomInBtn.onclick = async function() {
            if (state.zoomIndex < ZOOM_LEVELS.length - 1) {
                state.zoomIndex++;
                state.scale = ZOOM_LEVELS[state.zoomIndex];
                await renderPage(container);
            }
        };

        els.fitBtn.onclick = function() {
            fitToWidth(container);
        };

        els.popupBtn.onclick = function() {
            var assetUrl = state.assetUrl;
            if (assetUrl.startsWith('asset://')) {
                var match = assetUrl.match(/^asset:\\/\\/([^\\/]+)/);
                if (match) {
                    window.parent.postMessage({
                        type: 'openPdfPopup',
                        assetId: match[1],
                        assetUrl: assetUrl
                    }, '*');
                }
            }
        };
    }

    // Load PDF into viewer
    async function loadPdf(container, blob) {
        var state = container._state;
        var els = container._elements;

        try {
            var arrayBuffer = await blob.arrayBuffer();
            state.pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            state.totalPages = state.pdfDoc.numPages;
            state.currentPage = 1;

            setupControls(container);
            await fitToWidth(container);

            console.log('[PreviewPanel] PDF loaded with', state.totalPages, 'pages');
        } catch (e) {
            console.error('[PreviewPanel] Failed to load PDF:', e);
            els.pageInfo.textContent = 'Error loading PDF';
        }
    }

    // Create fallback card (when PDF.js not available)
    function createPdfCard(iframe, assetUrl) {
        var card = document.createElement('div');
        card.className = 'exe-pdf-preview-card';
        card.setAttribute('data-asset-url', assetUrl);
        card.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:center;' +
            'width:' + (iframe.width || '300') + 'px;height:' + (iframe.height || '150') + 'px;' +
            'background:linear-gradient(135deg,#f5f5f5 0%,#e0e0e0 100%);' +
            'border:1px solid #ccc;border-radius:8px;cursor:pointer;' +
            'font-family:system-ui,-apple-system,sans-serif;transition:all 0.2s ease;';

        var icon = document.createElement('div');
        icon.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 15h6M9 11h6"/></svg>';
        icon.style.cssText = 'margin-bottom:8px;';

        var label = document.createElement('div');
        label.textContent = 'PDF';
        label.style.cssText = 'font-size:14px;font-weight:600;color:#dc3545;margin-bottom:4px;';

        var hint = document.createElement('div');
        hint.textContent = 'Click to open';
        hint.style.cssText = 'font-size:12px;color:#666;';

        card.appendChild(icon);
        card.appendChild(label);
        card.appendChild(hint);

        card.onmouseenter = function() {
            card.style.background = 'linear-gradient(135deg,#e8e8e8 0%,#d0d0d0 100%)';
            card.style.transform = 'scale(1.02)';
        };
        card.onmouseleave = function() {
            card.style.background = 'linear-gradient(135deg,#f5f5f5 0%,#e0e0e0 100%)';
            card.style.transform = 'scale(1)';
        };

        card.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            var url = card.getAttribute('data-asset-url');
            if (url.startsWith('asset://')) {
                var match = url.match(/^asset:\\/\\/([^\\/]+)/);
                if (match) {
                    window.parent.postMessage({
                        type: 'openPdfPopup',
                        assetId: match[1],
                        assetUrl: url
                    }, '*');
                }
            } else {
                window.open(url, '_blank', 'width=900,height=700');
            }
        };

        return card;
    }

    // Process PDF iframes and render with PDF.js when needed.
    //
    // Why we only use PDF.js for asset:// URLs:
    // - External URLs (http/https): Chrome's native PDF viewer works fine
    // - asset:// URLs: These are internal assets stored in IndexedDB. Chrome
    //   cannot render them with its native viewer because:
    //   1. The preview is loaded as a blob URL for isolation
    //   2. Chrome blocks nested PDF rendering in blob URL contexts
    //   3. We need to fetch the blob via postMessage and render with PDF.js
    // - data: URLs: Also use PDF.js since Chrome may block in blob context
    // - blob: URLs (same context): Keep as-is, should work
    async function resolvePdfIframes() {
        var iframes = Array.from(document.querySelectorAll('iframe'));

        for (var i = 0; i < iframes.length; i++) {
            var iframe = iframes[i];
            try {
                var src = iframe.getAttribute('src') || '';

                // Skip external URLs (http://, https://) - Chrome's native PDF viewer works
                // fine for these even inside blob URL context
                if (src.startsWith('http://') || src.startsWith('https://')) {
                    continue;
                }

                // Check for PDF indicators
                var isPdf = src.includes('.pdf') ||
                           iframe.getAttribute('type') === 'application/pdf' ||
                           iframe.getAttribute('data-type') === 'application/pdf' ||
                           src.startsWith('data:application/pdf');

                // For asset:// URLs, check file extension
                if (src.startsWith('asset://') && !isPdf) {
                    if (src.toLowerCase().includes('.pdf')) {
                        isPdf = true;
                    }
                }

                if (!isPdf) continue;

                // Handle asset:// URLs for PDFs
                // These are internal assets stored in IndexedDB. Chrome cannot load them
                // directly because: (1) asset:// is not a registered protocol, and (2) even
                // if we converted to blob URL, Chrome's native PDF viewer doesn't work in
                // nested blob URL contexts. Solution: use PDF.js to render to canvas.
                if (src.startsWith('asset://')) {
                    // Extract asset ID from asset:// URL
                    // Handles multiple formats:
                    // - New format: asset://uuid.ext (e.g., asset://abc123.pdf)
                    // - Legacy format: asset://uuid/filename (e.g., asset://abc123/doc.pdf)
                    var path = src.replace('asset://', '');
                    var uuidMatch = path.match(/^([a-f0-9-]{36})(?:\\.[a-z0-9]+)?$/i);
                    var legacyMatch = path.match(/^([a-f0-9-]+)\\//);
                    var assetId = uuidMatch ? uuidMatch[1] : (legacyMatch ? legacyMatch[1] : null);
                    if (!assetId) continue;

                    // If PDF.js loaded successfully, render inline with full viewer controls
                    if (pdfjsLib) {
                        var viewer = createPdfViewer(iframe, src);
                        iframe.parentNode.replaceChild(viewer, iframe);

                        try {
                            var blob = await requestBlobFromParent(assetId);
                            await loadPdf(viewer, blob);
                            console.log('[PreviewPanel] Rendered PDF with PDF.js');
                        } catch (e) {
                            console.error('[PreviewPanel] Failed to load PDF:', e);
                            viewer._elements.pageInfo.textContent = 'Error: ' + e.message;
                        }
                    } else {
                        // Fallback to card
                        var card = createPdfCard(iframe, src);
                        iframe.parentNode.replaceChild(card, iframe);
                        console.log('[PreviewPanel] PDF.js not available, using card fallback');
                    }
                    continue;
                }

                // Handle blob:// URLs for PDFs (in same context)
                if (src.startsWith('blob:')) {
                    console.log('[PreviewPanel] PDF iframe with blob URL, keeping as-is');
                    continue;
                }

                // Handle data:application/pdf URLs
                if (src.startsWith('data:application/pdf') && pdfjsLib) {
                    var base64Match = src.match(/^data:application\\/pdf;base64,(.+)$/);
                    if (base64Match) {
                        var binaryString = atob(base64Match[1]);
                        var bytes = new Uint8Array(binaryString.length);
                        for (var j = 0; j < binaryString.length; j++) {
                            bytes[j] = binaryString.charCodeAt(j);
                        }
                        var dataBlob = new Blob([bytes], { type: 'application/pdf' });

                        var viewer = createPdfViewer(iframe, src);
                        iframe.parentNode.replaceChild(viewer, iframe);
                        await loadPdf(viewer, dataBlob);
                        console.log('[PreviewPanel] Rendered data URL PDF with PDF.js');
                    }
                }
            } catch (e) {
                console.error('[PreviewPanel] Failed to resolve PDF iframe:', e);
            }
        }
    }

    // Run on DOMContentLoaded or immediately if already loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', resolvePdfIframes);
    } else {
        resolvePdfIframes();
    }
})();
</script>`;if(Q.includes("</body>"))return Q.replace("</body>",W+"</body>");return Q+W}injectHtmlLinkHandler(Q){let X=`
<script>
(function() {
    // Map to track pending resolve requests
    var pendingResolves = {};
    var resolveIdCounter = 0;

    // Warning message for HTML asset links in preview (translated from main window)
    var htmlLinkWarningMessage = '${(typeof window._==="function"?window._("HTML websites from the Resources folder cannot be navigated in preview. Please export the project to view this content correctly."):"HTML websites from the Resources folder cannot be navigated in preview. Please export the project to view this content correctly.").replace(/'/g,"\\'").replace(/\n/g,"\\n")}';

    // Intercept clicks on ALL HTML asset links in preview
    // Internal navigation won't work because blob URLs can't resolve relative paths
    // Use capture phase to intercept before navigation happens
    document.addEventListener('click', function(e) {
        var link = e.target.closest('a[href]');
        if (!link) return;

        var href = link.getAttribute('href');
        var dataAssetUrl = link.getAttribute('data-asset-url');

        // Check if it's an HTML asset link
        // In preview, asset:// URLs are resolved to blob:// URLs
        // We detect HTML links by checking the data-asset-url attribute for .html extension
        var isHtmlLink = dataAssetUrl && /\\.html?$/i.test(dataAssetUrl);

        // Block ALL HTML asset links - internal navigation won't work in preview
        if (isHtmlLink) {
            e.preventDefault();
            e.stopPropagation();
            alert(htmlLinkWarningMessage);
        }
    }, true); // Use capture phase

    // Listen for messages from embedded HTML iframes
    window.addEventListener('message', function(event) {
        // Handle link resolution requests from embedded iframes
        if (event.data?.type === 'exe-resolve-html-link') {
            var reqId = 'htmlResolve_' + (++resolveIdCounter);

            // Store the source iframe so we can update it later
            pendingResolves[reqId] = {
                source: event.source,
                href: event.data.href,
                baseFolder: event.data.baseFolder
            };

            // Forward to main window with our request ID
            window.parent.postMessage({
                type: 'exe-resolve-html-link-forward',
                requestId: reqId,
                href: event.data.href,
                assetId: event.data.assetId,
                baseFolder: event.data.baseFolder
            }, '*');
            return;
        }

        // Handle response from main window with resolved URL
        if (event.data?.type === 'exe-html-link-resolved') {
            var reqId = event.data.requestId;
            var pending = pendingResolves[reqId];
            if (!pending) return;

            delete pendingResolves[reqId];

            var resolvedUrl = event.data.resolvedUrl;
            if (!resolvedUrl) {
                console.warn('[PreviewPanel] Failed to resolve HTML link:', pending.href);
                return;
            }

            // Find the iframe that sent the original request and update its src
            // The source is the contentWindow of the embedded iframe
            var iframes = document.querySelectorAll('iframe[data-asset-src], iframe[data-mce-html]');
            for (var i = 0; i < iframes.length; i++) {
                var iframe = iframes[i];
                if (iframe.contentWindow === pending.source) {
                    iframe.src = resolvedUrl;
                    break;
                }
            }
            return;
        }
    });
})();
</script>`;if(Q.includes("</body>"))return Q.replace("</body>",X+"</body>");return Q+X}injectHtmlToIframe(Q){let Z=this.isPinned?this.pinnedIframe:this.iframe;if(!Z){j.error("[PreviewPanel] No iframe available");return}if(Z._blobUrl)URL.revokeObjectURL(Z._blobUrl),Z._blobUrl=null;let Y=new Blob([Q],{type:"text/html;charset=utf-8"}),X=URL.createObjectURL(Y);Z._blobUrl=X,Z.removeAttribute("srcdoc"),Z.src=X,j.log("[PreviewPanel] Preview content injected via blob URL")}showLoadingState(){(this.isPinned?this.pinnedContainer?.querySelector(".preview-pinned-body"):this.panel?.querySelector(".preview-panel-body"))?.classList.add("preview-loading")}hideLoadingState(){(this.isPinned?this.pinnedContainer?.querySelector(".preview-pinned-body"):this.panel?.querySelector(".preview-panel-body"))?.classList.remove("preview-loading")}showError(Q){let Z=`
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    body {
                        font-family: Inter, system-ui, sans-serif;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        height: 100vh;
                        margin: 0;
                        background: #fafafa;
                        color: #666;
                    }
                    .error {
                        text-align: center;
                        padding: 40px;
                    }
                    h2 { color: #dc3545; margin-bottom: 16px; }
                    p { margin: 0; }
                </style>
            </head>
            <body>
                <div class="error">
                    <h2>Preview Error</h2>
                    <p>${this.escapeHtml(Q)}</p>
                </div>
            </body>
            </html>
        `;this.injectHtmlToIframe(Z)}savePinnedPreference(Q){try{localStorage.setItem("exe-preview-pinned",Q?"true":"false")}catch(Z){}}loadPinnedPreference(){try{return localStorage.getItem("exe-preview-pinned")==="true"}catch(Q){return!1}}async restorePinnedState(){if(this.loadPinnedPreference())await(()=>{return new Promise((Z)=>{let Y=()=>{if(eXeLearning?.app?.project?._yjsBridge?.documentManager)Z();else setTimeout(Y,500)};Y()})})(),await this.pin()}setAutoRefresh(Q){this.autoRefreshEnabled=Q,j.log("[PreviewPanel] Auto-refresh:",Q?"enabled":"disabled")}async processUserThemeCssUrls(Q,Z,Y){let X=Array.from(Z.keys());console.log(`[PreviewPanel] Theme '${Y}' files available (${X.length}):`,X);let J=/url\(\s*(['"]?)([^'")\s]+)\1\s*\)/gi,W=new Map,z;while((z=J.exec(Q))!==null){let q=z[0],H=z[2];if(W.has(q))continue;if(H.startsWith("http://")||H.startsWith("https://"))continue;if(H.startsWith("data:")||H.startsWith("blob:"))continue;if(H.startsWith("#"))continue;let K=H.replace(/^\.\//,"").replace(/^\.\.\//,""),V=[K,`${Y}/${K}`,K.replace(/^fonts\//,"fonts/"),K.replace(/^img\//,"img/"),K.replace(/^icons\//,"icons/"),K.replace(/^images\//,"images/")],R=null,O=null;for(let A of V)if(R=Z.get(A),R){O=A;break}if(R)try{let A=await this.blobToDataUrl(R);W.set(q,`url("${A}")`),console.log(`[PreviewPanel] ✓ Converted: ${O}`)}catch(A){console.warn(`[PreviewPanel] ✗ Failed to convert ${H}:`,A)}else if(K.match(/\.(woff2?|ttf|eot|svg|png|jpg|jpeg|gif|webp)$/i))console.warn(`[PreviewPanel] ✗ NOT FOUND: "${H}" (normalized: "${K}")`)}let G=Q;for(let[q,H]of W)G=G.split(q).join(H);return console.log(`[PreviewPanel] Processed ${W.size} CSS url() references`),G}blobToDataUrl(Q){return new Promise((Z,Y)=>{let X=new FileReader;X.onloadend=()=>Z(X.result),X.onerror=Y,X.readAsDataURL(Q)})}escapeHtml(Q){let Z=document.createElement("div");return Z.textContent=Q,Z.innerHTML}destroy(){if(this._unsubscribeStructure)this._unsubscribeStructure(),this._unsubscribeStructure=null;if(this._onYdocUpdate){let Q=eXeLearning?.app?.project?._yjsBridge?.documentManager;if(Q?.ydoc)Q.ydoc.off("update",this._onYdocUpdate);this._onYdocUpdate=null}if(this.refreshDebounceTimer)clearTimeout(this.refreshDebounceTimer),this.refreshDebounceTimer=null;[this.iframe,this.pinnedIframe].forEach((Q)=>{if(Q?._blobUrl)URL.revokeObjectURL(Q._blobUrl)}),j.log("[PreviewPanel] Destroyed")}}class U1{constructor(){this.previewMenuHeadButton=document.querySelector("#head-bottom-preview"),this.previewPanel=new M1}init(){this.previewPanel.init(),this.addEventClick()}addEventClick(){this.previewMenuHeadButton.addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.previewPanel.toggle()})}getPanel(){return this.previewPanel}}class L1{constructor(){this.logoutMenuHeadButton=document.querySelector("#head-bottom-logout-button"),this.exitMenuHeadButton=document.querySelector("#head-bottom-exit-button")}init(){this.addEventClick()}addEventClick(){if(this.logoutMenuHeadButton)this.logoutMenuHeadButton.addEventListener("click",(Q)=>{this.handleLogout()});if(this.exitMenuHeadButton)this.exitMenuHeadButton.addEventListener("click",(Q)=>{this.handleOfflineExit()})}handleLogout(){let Q=eXeLearning.app.project.odeSession,Z=eXeLearning.app.project.odeVersion,Y=eXeLearning.app.project.odeId,X={odeSessionId:Q,odeVersionId:Z,odeId:Y};eXeLearning.app.api.postCheckCurrentOdeUsers(X).then((J)=>{if(J.leaveSession)eXeLearning.app.api.postCloseSession(X).then((W)=>{window.onbeforeunload=null;let z=window.location.pathname.split("/"),G=z.splice(0,z.length-1).join("/");window.location.href=window.location.origin+G+"/logout"});else if(J.askSave)eXeLearning.app.modals.sessionlogout.show();else if(J.leaveEmptySession)this.leaveEmptySession(X)})}handleOfflineExit(){let Q=eXeLearning.app?.project?._yjsBridge;if(Q?.documentManager?.hasUnsavedChanges?.()||Q?.documentManager?.isDirty||!1)this.showOfflineExitConfirmation();else this.closeOfflineApp()}showOfflineExitConfirmation(){eXeLearning.app.modals.sessionlogout.show({title:_("Exit"),offlineExit:!0})}async saveAndCloseOffline(){try{if(eXeLearning.app.project?._yjsEnabled&&eXeLearning.app.project?.exportToElpxViaYjs)await eXeLearning.app.project.exportToElpxViaYjs({saveAs:!1});this.closeOfflineApp()}catch(Q){console.error("[LogoutButton] Error saving before exit:",Q),eXeLearning.app.modals.alert.show({title:_("Error saving"),body:_("An error occurred while saving the project"),contentId:"error"})}}closeOfflineApp(){window.onbeforeunload=null,window.close()}leaveEmptySession(Q){eXeLearning.app.modals.confirm.show({title:_("Empty session"),contentId:"empty-session",body:_("Do you want to logout anyway?"),confirmButtonText:_("Logout"),cancelButtonText:_("Cancel"),focusFirstInputText:!0,confirmExec:()=>{eXeLearning.app.api.postCloseSession(Q).then((Z)=>{window.onbeforeunload=null;let Y=window.location.pathname.split("/"),X=Y.splice(0,Y.length-1).join("/");window.location.href=window.location.origin+X+"/logout"})}})}}class B1{constructor(Q){this.app=Q,this.loadingScreen=new H1,this.odeTitleElement=new K1,this.connectionTime=new R1,this.concurrentUsers=new V1(Q),this.saveButton=new A1,this.shareButton=new O1,this.downloadButton=new F1,this.previewButton=new U1,this.logoutButton=new L1}async load(){if(this.odeTitleElement.init(),this.connectionTime.init(),!eXeLearning.app.project.offlineInstallation)this.concurrentUsers.init();this.saveButton.init(),this.downloadButton.init(),this.shareButton.init(),this.previewButton.init(),this.logoutButton.init()}}class D1{constructor(){this.main=document.querySelector("body#main"),this.head=document.querySelector("#main #head"),this.workarea=document.querySelector("#main #workarea"),this.menus=document.querySelectorAll("#main #workarea .menu"),this.menuNav=document.querySelector("#main #workarea #menu_nav"),this.menuIdevices=document.querySelector("#main #workarea #menu_idevices"),this.relationSizeMenus={},this.relationSizeMenus[this.menuNav.id]=50,this.relationSizeMenus[this.menuIdevices.id]=50}behaviour(){this.closeMenusEvent(),this.initMobileMenuBehavior()}initMobileMenuBehavior(){let Q=document.querySelector("#head-bottom-user-logged");if(!Q)return;Q.addEventListener("click",(Z)=>{let Y=Z.target.closest(".dropdown-item");if(!Y)return;if(Y.classList.contains("dropdown-toggle"))return;let X=document.querySelector("#exeUserMenuToggler");if(X&&window.bootstrap){let J=bootstrap.Dropdown.getInstance(X);if(J)J.hide()}}),this.initMobileButtonHandlers(),this.initMobileLayout(),window.addEventListener("resize",()=>{this.handleResponsiveLayout()})}initMobileButtonHandlers(){Object.entries({"mobile-navbar-button-new":"navbar-button-new","mobile-navbar-button-openuserodefiles":"navbar-button-openuserodefiles","mobile-navbar-button-save":"navbar-button-save","mobile-navbar-button-import-elp":"navbar-button-import-elp","mobile-navbar-button-settings":"navbar-button-settings","mobile-navbar-button-share":"navbar-button-share","mobile-navbar-button-export-html5":"navbar-button-export-html5","mobile-navbar-button-export-scorm12":"navbar-button-export-scorm12","mobile-navbar-button-export-epub3":"navbar-button-export-epub3","mobile-navbar-button-styles":"navbar-button-styles","mobile-navbar-button-preview":"navbar-button-preview","mobile-navbar-button-filemanager":"navbar-button-filemanager","mobile-navbar-button-exe-tutorial":"navbar-button-exe-tutorial","mobile-navbar-button-about-exe":"navbar-button-about-exe","mobile-navbar-button-exe-web":"navbar-button-exe-web"}).forEach(([Z,Y])=>{let X=document.getElementById(Z),J=document.getElementById(Y);if(X&&J)X.addEventListener("click",(W)=>{W.preventDefault(),W.stopPropagation(),J.click()})})}initMobileLayout(){if(window.innerWidth<768)document.body.classList.add("left-column-hidden")}handleResponsiveLayout(){let Q=window.innerWidth<768;if(Q&&!this._wasResizedToMobile)document.body.classList.add("left-column-hidden"),this._wasResizedToMobile=!0;else if(!Q)this._wasResizedToMobile=!1}closeMenusEvent(){this.titleProjectButton=document.querySelector(".title-menu-button"),this.titleButtonDots=document.querySelector(".title-menu-button .dots-menu-vertical-icon"),["click","dragstart","drag","dragend","dragenter","dragover","dragleave","drop"].forEach((Q)=>{document.addEventListener(Q,(Z)=>{let Y=document.querySelectorAll('[data-bs-toggle="dropdown"].show');if(Y.length>0)Y.forEach((X)=>{if(!X.contains(Z.target)&&!Z.target.classList.contains("dropdown-toggle"))X.click()})},!1)})}}var f=window.AppLogger||console,d2=new Set([".elpx",".zip",".epub",".xml"]);class j1{constructor(Q){this.menu=Q,this.button=this.menu.navbar.querySelector("#dropdownFile"),this.newButton=this.menu.navbar.querySelector("#navbar-button-new"),this.newFromTemplateButton=this.menu.navbar.querySelector("#navbar-button-new-from-template"),this.saveButton=this.menu.navbar.querySelector("#navbar-button-save"),this.saveButtonAs=this.menu.navbar.querySelector("#navbar-button-save-as"),this.settingsButton=this.menu.navbar.querySelector("#navbar-button-settings"),this.shareButton=this.menu.navbar.querySelector("#navbar-button-share"),this.saveButtonAsOffline=this.menu.navbar.querySelector("#navbar-button-save-as-offline"),this.uploadPlatformButton=this.menu.navbar.querySelector("#navbar-button-uploadtoplatform"),this.openUserOdeFilesButton=this.menu.navbar.querySelector("#navbar-button-openuserodefiles"),this.openOfflineButton=this.menu.navbar.querySelector("#navbar-button-open-offline"),this.saveOfflineButton=this.menu.navbar.querySelector("#navbar-button-save-offline"),this.recentProjectsButton=this.menu.navbar.querySelector("#navbar-button-dropdown-recent-projects"),this.downloadProjectButton=this.menu.navbar.querySelector("#navbar-button-download-project"),this.downloadProjectAsButton=this.menu.navbar.querySelector("#navbar-button-download-project-as"),this.exportHTML5Button=this.menu.navbar.querySelector("#navbar-button-export-html5"),this.exportHTML5AsButton=this.menu.navbar.querySelector("#navbar-button-exportas-html5"),this.exportHTML5FolderAsButton=this.menu.navbar.querySelector("#navbar-button-exportas-html5-folder"),this.exportHTML5SPButton=this.menu.navbar.querySelector("#navbar-button-export-html5-sp"),this.exportHTML5SPAsButton=this.menu.navbar.querySelector("#navbar-button-exportas-html5-sp"),this.exportPrintButton=this.menu.navbar.querySelector("#navbar-button-export-print"),this.exportSCORM12Button=this.menu.navbar.querySelector("#navbar-button-export-scorm12"),this.exportSCORM12AsButton=this.menu.navbar.querySelector("#navbar-button-exportas-scorm12"),this.exportSCORM2004Button=this.menu.navbar.querySelector("#navbar-button-export-scorm2004"),this.exportSCORM2004AsButton=this.menu.navbar.querySelector("#navbar-button-exportas-scorm2004"),this.exportIMSButton=this.menu.navbar.querySelector("#navbar-button-export-ims"),this.exportIMSAsButton=this.menu.navbar.querySelector("#navbar-button-exportas-ims"),this.exportEPUB3Button=this.menu.navbar.querySelector("#navbar-button-export-epub3"),this.exportEPUB3AsButton=this.menu.navbar.querySelector("#navbar-button-exportas-epub3"),this.exportXmlPropertiesButton=this.menu.navbar.querySelector("#navbar-button-export-xml-properties"),this.exportXmlPropertiesAsButton=this.menu.navbar.querySelector("#navbar-button-exportas-xml-properties"),this.importXmlPropertiesButton=this.menu.navbar.querySelector("#navbar-button-import-xml-properties"),this.importElpButton=this.menu.navbar.querySelector("#navbar-button-import-elp"),this.leftPanelsTogglerButton=this.menu.navbar.querySelector("#exe-panels-toggler")}setEvents(){this.setNewProjectEvent(),this.setNewFromTemplateEvent(),this.setSaveProjectEvent(),this.setSaveAsProjectEvent(),this.setSaveAsProjectOfflineEvent(),this.setSettingsEvent(),this.setShareEvent(),this.setUploadPlatformEvent(),this.setOpenUserOdeFilesEvent(),this.setOpenOfflineEvent(),this.setRecentProjectsEvent(),this.setDownloadProjectEvent(),this.setSaveProjectOfflineEvent(),this.setDownloadProjectAsEvent(),this.setExportHTML5Event(),this.setExportHTML5AsEvent(),this.setExportHTML5FolderAsEvent(),this.setExportHTML5SPEvent(),this.setExportHTML5SPAsEvent(),this.setExportPrintEvent(),this.setExportSCORM12Event(),this.setExportSCORM12AsEvent(),this.setExportSCORM2004Event(),this.setExportSCORM2004AsEvent(),this.setExportIMSEvent(),this.setExportIMSAsEvent(),this.setExportEPUB3Event(),this.setExportEPUB3AsEvent(),this.setExportXmlPropertiesEvent(),this.setExportXmlPropertiesAsEvent(),this.setImportXmlPropertiesEvent(),this.setImportElpEvent(),this.setLeftPanelsTogglerEvents(),this.checkAndShowNewFromTemplateButton()}setNewProjectEvent(){this.newButton.addEventListener("click",()=>{this.newProjectEvent()})}setNewFromTemplateEvent(){this.newFromTemplateButton.addEventListener("click",()=>{this.newFromTemplateEvent()})}async checkAndShowNewFromTemplateButton(){let Q=eXeLearning?.app?.capabilities;if(Q&&!Q.storage.remote)return;try{let Z=eXeLearning?.config?.locale||"en",Y=eXeLearning?.config?.basePath||"",X=await fetch(`${Y}/api/templates?locale=${Z}`,{credentials:"include"});if(!X.ok){f.debug("[NavbarFile] Templates API not available");return}let J=await X.json();if(J.templates&&J.templates.length>0){let W=this.newFromTemplateButton?.parentElement;if(W)W.classList.remove("d-none"),f.debug(`[NavbarFile] Showing "New from Template" - ${J.templates.length} templates available for ${Z}`)}}catch(Z){f.debug("[NavbarFile] Could not check templates:",Z.message)}}setSaveProjectEvent(){this.saveButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(eXeLearning.config.isOfflineInstallation&&window.electronAPI){this.downloadProjectEvent();return}this.saveOdeEvent()})}setSaveAsProjectEvent(){this.saveButtonAs.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(eXeLearning.config.isOfflineInstallation&&window.electronAPI){this.saveAsElpOffline();return}this.saveAsOdeEvent()})}setSaveAsProjectOfflineEvent(){if(!this.saveButtonAsOffline)return;this.saveButtonAsOffline.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.saveAsElpOffline()})}setSettingsEvent(){if(!this.settingsButton)return;this.settingsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.openProjectSettingsEvent()})}setShareEvent(){if(!this.shareButton)return;this.shareButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.openShareModalEvent()})}setUploadPlatformEvent(){if(this.uploadPlatformButton)this.uploadPlatformButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.uploadPlatformEvent()})}setOpenUserOdeFilesEvent(){this.openUserOdeFilesButton.addEventListener("click",()=>{this.openUserOdeFilesEvent()})}setOpenOfflineEvent(){if(!this.openOfflineButton)return;this.openOfflineButton.addEventListener("click",()=>{this.openUserOdeFilesEvent()})}setRecentProjectsEvent(){this.recentProjectsButton.addEventListener("click",()=>{this.showMostRecentProjectsEvent()})}setDownloadProjectEvent(){this.downloadProjectButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return!1;return this.downloadProjectEvent(),!1})}setSaveProjectOfflineEvent(){if(!this.saveOfflineButton)return;this.saveOfflineButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return!1;return this.downloadProjectEvent(),!1})}setDownloadProjectAsEvent(){if(!this.downloadProjectAsButton)return;this.downloadProjectAsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return!1;return this.saveAsElpOffline(),!1})}setExportHTML5Event(){this.exportHTML5Button.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportHTML5Event()})}setExportHTML5AsEvent(){if(!this.exportHTML5AsButton)return;this.exportHTML5AsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportHTML5AsEvent()})}setExportHTML5FolderAsEvent(){if(!this.exportHTML5FolderAsButton)return;this.exportHTML5FolderAsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportHTML5FolderAsEvent()})}setExportHTML5SPEvent(){this.exportHTML5SPButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportHTML5SPEvent()})}setExportHTML5SPAsEvent(){if(!this.exportHTML5SPAsButton)return;this.exportHTML5SPAsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportHTML5SPAsEvent()})}setExportPrintEvent(){if(!this.exportPrintButton)return;this.exportPrintButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.openPrintPreview()})}openPrintPreview(){let Q=eXeLearning?.app?.modals?.printpreview;if(Q)Q.show();else console.warn("[NavbarFile] Print preview modal not available"),eXeLearning?.app?.modals?.alert?.show({title:_("Error"),body:_("Print preview is not available.")})}async openClientPreview(){if(!eXeLearning.app.project?._yjsEnabled)return!1;let Q=eXeLearning.app.project?._yjsBridge;if(!Q?.documentManager)return console.warn("[NavbarFile] Yjs document manager not available for preview"),!1;if(typeof window.PreviewExporter!=="function")return console.warn("[NavbarFile] PreviewExporter not loaded"),!1;let Z={title:_("Preview"),body:_("Generating preview..."),icon:"preview"},Y=eXeLearning?.app?.toasts?.createToast?eXeLearning.app.toasts.createToast(Z):null;try{let X=Q.documentManager,J=Q.assetCache||null,W=Q.assetManager||null,z=Q.resourceFetcher||null,G=new window.PreviewExporter(X,J,z,W);f.log("[NavbarFile] Starting client-side preview...");let q=await G.preview();if(q.success){if(Y)Y.toastBody.innerHTML=_("Preview opened in new window.");f.log("[NavbarFile] Client-side preview opened successfully")}else throw Error(q.error||"Preview failed")}catch(X){if(console.error("[NavbarFile] Client-side preview error:",X),Y)Y.toastBody.innerHTML=_("An error occurred while generating the preview."),Y.toastBody.classList.add("error"),setTimeout(()=>Y.remove(),1500);return eXeLearning.app.modals.alert.show({title:_("Error"),body:X.message||_("Unknown error."),contentId:"error"}),!0}if(Y)setTimeout(()=>Y.remove(),1500);return!0}setExportSCORM12Event(){this.exportSCORM12Button.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportSCORM12Event()})}setExportSCORM12AsEvent(){if(!this.exportSCORM12AsButton)return;this.exportSCORM12AsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportSCORM12AsEvent()})}setExportSCORM2004Event(){this.exportSCORM2004Button.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportSCORM2004Event()})}setExportSCORM2004AsEvent(){if(!this.exportSCORM2004AsButton)return;this.exportSCORM2004AsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportSCORM2004AsEvent()})}setExportIMSEvent(){this.exportIMSButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportIMSEvent()})}setExportIMSAsEvent(){if(!this.exportIMSAsButton)return;this.exportIMSAsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportIMSAsEvent()})}setExportEPUB3Event(){this.exportEPUB3Button.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportEPUB3Event()})}setExportEPUB3AsEvent(){if(!this.exportEPUB3AsButton)return;this.exportEPUB3AsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportEPUB3AsEvent()})}setExportXmlPropertiesEvent(){this.exportXmlPropertiesButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportXmlPropertiesEvent()})}setExportXmlPropertiesAsEvent(){if(!this.exportXmlPropertiesAsButton)return;this.exportXmlPropertiesAsButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.exportXmlPropertiesAsEvent()})}setImportXmlPropertiesEvent(){this.importXmlPropertiesButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.importXmlPropertiesEvent()})}setImportElpEvent(){if(!this.importElpButton)return;this.importElpButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;eXeLearning.app.modals.confirm.show({title:_("Import (.elpx...)"),body:_("Import .elpx, .elp, or editable .zip or .epub files. The imported content will be added after the last page of the current project."),confirmButtonText:_("Continue"),cancelButtonText:_("Cancel"),focusFirstInputText:!0,confirmExec:()=>{let Q=document.createElement("input");Q.type="file",Q.accept=".elpx,.elp,.zip,.epub",Q.classList.add("visually-hidden"),document.body.appendChild(Q),Q.addEventListener("change",async()=>{if(!Q.files||!Q.files.length){Q.remove();return}let Z=Q.files[0],Y=eXeLearning.app.modals.uploadprogress;Y.show({fileName:Z.name,fileSize:Z.size});let X=(J=0)=>{let W=()=>{if(document.querySelectorAll(".modal-backdrop").forEach((z)=>z.remove()),!document.querySelector(".modal.show"))document.body.classList.remove("modal-open")};if(J>0)setTimeout(W,J);else W()};try{if(eXeLearning.app.project?._yjsEnabled&&eXeLearning.app.project?.importFromElpxViaYjs){Y.setProcessingPhase("extracting"),f.log("[NavbarFile] Importing via Yjs (client-side):",Z.name);let J=await eXeLearning.app.project.importFromElpxViaYjs(Z,{clearExisting:!1});f.log("[NavbarFile] Yjs import complete:",J),Y.setComplete(!0,_("Completed successfully")+` (${J?.pages||0} ${_("pages")})`),setTimeout(()=>{Y.hide(),X(350)},600)}else{let W=Z.size,z=0,G=0,q;while(z<W){let V=Math.min(z+15728640,W),R=Z.slice(z,V),O=new FormData;if(O.append("odeFilePart",R),O.append("odeFileName",[Z.name]),O.append("odeSessionId",[eXeLearning.app.project.odeSession]),q=await eXeLearning.app.api.postLocalLargeOdeFile(O),q.responseMessage!=="OK")break;G+=R.size;let A=G/W*100;Y.updateUploadProgress(A,G,W),z=V}if(q.responseMessage!=="OK"){Y.showError(q.responseMessage||_("Error while uploading the file.")),setTimeout(()=>{Y.hide(),eXeLearning.app.modals.alert.show({title:_("Error"),body:q.responseMessage||_("Unexpected error importing file.")})},2000),Q.remove();return}Y.setProcessingPhase("extracting");let H={odeSessionId:eXeLearning.app.project.odeSession,odeFileName:q.odeFileName,odeFilePath:q.odeFilePath},K=await eXeLearning.app.api.postImportElpToRootFromLocal(H);if(K&&K.responseMessage==="OK"){Y.setComplete(!0,_("Completed successfully"));let V=eXeLearning?.app?.project?.structure,R=V&&typeof V.getSelectNodeNavId==="function"?V.getSelectNodeNavId():null;if(V&&typeof V.resetDataAndStructureData==="function")V.resetDataAndStructureData(R||!1);else eXeLearning.app.project.openLoad();setTimeout(()=>{Y.hide(),X(350)},600)}else{let V=K?.responseMessage||_("Unexpected error importing file.");Y.showError(V),setTimeout(()=>{Y.hide(),eXeLearning.app.modals.alert.show({title:_("Error"),body:V})},2000)}}}catch(J){console.error("Import error:",J),Y.showError(_("An unexpected error occurred while processing the file.")),setTimeout(()=>{Y.hide(),eXeLearning.app.modals.alert.show({title:_("Error"),body:_("An unexpected error occurred while processing the file.")})},2000)}finally{X(350),Q.remove()}}),Q.click()}})})}setLeftPanelsTogglerEvents(){this.initMobileLayout(),$(this.leftPanelsTogglerButton).attr("data-bs-placement","bottom").tooltip().on("click",function(){$(this).tooltip("hide"),$("body").toggleClass("left-column-hidden")}),window.addEventListener("resize",()=>{this.handleResponsiveLayout()}),this.initMobileBackdropClose()}initMobileBackdropClose(){document.addEventListener("click",(Q)=>{if(window.innerWidth>=768)return;if(document.body.classList.contains("left-column-hidden"))return;let Z=document.querySelector(".asideleft");if(!Z)return;let Y=Z.getBoundingClientRect(),X=Q.clientX,J=Q.clientY,W=X>Y.right||X<Y.left||J>Y.bottom||J<Y.top,z=document.getElementById("exe-panels-toggler"),G=z&&z.contains(Q.target);if(W&&!G)document.body.classList.add("left-column-hidden")})}initMobileLayout(){if(window.innerWidth<768)document.body.classList.add("left-column-hidden")}handleResponsiveLayout(){let Q=window.innerWidth<768;if(Q&&!this._wasResizedToMobile)document.body.classList.add("left-column-hidden"),this._wasResizedToMobile=!0;else if(!Q)this._wasResizedToMobile=!1}newProjectEvent(){let Q=eXeLearning.app.project.odeSession;this.newSession(Q)}newFromTemplateEvent(){eXeLearning.app.modals.templateselection.show()}async newSession(Q){let Z={odeSessionId:Q};if(eXeLearning?.app?.project?._yjsBridge?.documentManager?.hasUnsavedChanges?.()||!1){let J={title:_("New file"),forceOpen:_("Create new file without saving"),newFile:!0};eXeLearning.app.modals.sessionlogout.show(J)}else this.createSession(Z)}async createSession(Q){if(eXeLearning.app.project?._yjsEnabled&&eXeLearning.app.project?.reinitializeWithProject){f.log("[NavbarFile] Creating new project in Yjs mode");try{let Z=window.eXeLearning?.config?.basePath||"",Y=await fetch(`${Z}/api/project/create-quick`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({title:_("Untitled")})});if(!Y.ok)throw Error(`Failed to create project: ${Y.status}`);let J=(await Y.json()).uuid;if(!J)throw Error("Server did not return a project UUID");f.log("[NavbarFile] New project created:",J),window.onbeforeunload=null,window.location.href=`${Z}/workarea?project=${J}&new=1`;return}catch(Z){console.error("[NavbarFile] Failed to create new project in Yjs mode:",Z)}}await eXeLearning.app.api.postCloseSession(Q).then((Z)=>{if(Z.responseMessage=="OK"){window.onbeforeunload=null;let Y=window.eXeLearning?.config?.basePath||"";window.location.href=`${Y}/workarea`}})}saveOdeEvent(){eXeLearning.app.project.save()}saveAsOdeEvent(){let Q=eXeLearning.app.project.odeSession,Z=eXeLearning.app.project.odeVersion,Y=eXeLearning.app.project.odeId,X={odeSessionId:Q,odeVersionId:Z,odeId:Y};this.currentOdeUsers(X)}openProjectSettingsEvent(){document.querySelector('[nav-id="root"]')?.querySelectorAll(".nav-element-text")[0]?.click()}openShareModalEvent(){if(eXeLearning.app.modals?.share)eXeLearning.app.modals.share.show();else f.warn("Share menu: Share modal not available")}async saveAs(Q){let Z={odeSessionId:eXeLearning.app.project.odeSession,odeVersion:eXeLearning.app.project.odeVersion,odeId:eXeLearning.app.project.odeId,title:Q},Y={title:_("Save"),body:_("Saving the project..."),icon:"downloading"},X=eXeLearning.app.toasts.createToast(Y),J=await eXeLearning.app.api.postOdeSaveAs(Z);if(J&&J.responseMessage=="OK")eXeLearning.app.project.odeId=J.odeId,eXeLearning.app.project.odeVersion=J.odeVersionId,eXeLearning.app.project.odeSession=J.newSessionId,await eXeLearning.app.project.openLoad(),eXeLearning.app.project.showModalSaveOk(J),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface(),X.toastBody.innerHTML=_("Project saved.");else eXeLearning.app.project.showModalSaveError(J),X.toastBody.innerHTML=_("An error occurred while saving the project."),X.toastBody.classList.add("error");setTimeout(()=>{X.remove()},1000)}makeConfirmTitleInputModal(){let Q=this.makeBodyElementPropertiesTiltleName();eXeLearning.app.modals.confirm.show({title:_("Save project"),body:Q.innerHTML,confirmButtonText:_("Save"),cancelButtonText:_("Cancel"),focusFirstInputText:!0,confirmExec:()=>{let Y=document.querySelector(".modal-confirm .properties-title-input").value;this.saveAs(Y)}})}makeBodyElementPropertiesTiltleName(){let Q=document.createElement("div");return Q.classList.add("properties-title-div"),Q.append(this.makeDivContentPropertiesTiltleName()),Q}makeDivContentPropertiesTiltleName(){let Q=document.createElement("div"),Z=document.createElement("p"),Y=document.createElement("input");return Q.classList.add("properties-title-content-div"),Z.classList.add("properties-title-notice"),Z.innerHTML=_("Please enter the project title:"),Y.classList.add("properties-title-input"),Y.setAttribute("type","text"),Q.append(Z),Q.append(Y),Q}uploadToGoogleDriveEvent(){this.getFoldersGoogleDrive().then((Q)=>{if(!Q.error)eXeLearning.app.modals.uploadtodrive.show(Q.files);else if(eXeLearning.app.actions.authorizeAddActions)this.openWindowLoginGoogleDrive();else eXeLearning.app.modals.alert.show({title:_("Google Drive error"),body:Q.error,contentId:"error"})})}async getFoldersGoogleDrive(){let Q=await eXeLearning.app.api.getFoldersGoogleDrive();if(Q)if(Q.folders&&Q.folders.files)return{error:!1,files:Q.folders};else return{error:Q,files:[]};else return{error:_("Unknown"),files:[]}}async openWindowLoginGoogleDrive(){let Q=await eXeLearning.app.api.getUrlLoginGoogleDrive(),Z=window.open(Q.url,"drive","location=1,status=1,scrollbars=1,width=600,height=500,top=250, left=720, menubar=0, toolbar=0,resizable=0")}uploadToDropboxEvent(){this.getFoldersDropbox().then((Q)=>{if(!Q.error)eXeLearning.app.modals.uploadtodropbox.show(Q.files);else if(eXeLearning.app.actions.authorizeAddActions)this.openWindowLoginDropbox();else eXeLearning.app.modals.alert.show({title:_("Dropbox error"),body:Q.error,contentId:"error"})})}async getFoldersDropbox(){let Q=await eXeLearning.app.api.getFoldersDropbox();if(Q)if(Q.folders&&Q.folders.files)return{error:!1,files:Q.folders};else return{error:Q,files:[]};else return{error:_("Unknown"),files:[]}}async openWindowLoginDropbox(){let Q=await eXeLearning.app.api.getUrlLoginDropbox(),Z=window.open(Q.url,"dropbox","location=1,status=1,scrollbars=1,width=600,height=500,top=250, left=720, menubar=0, toolbar=0,resizable=0")}async uploadPlatformEvent(){let Z=new URLSearchParams(window.location.search).get("jwt_token"),Y=eXeLearning.app.project.yjsProjectId||eXeLearning.app.project.odeId||eXeLearning.app.project.odeSession;try{if(eXeLearning.app.project._yjsBridge?.getDocumentManager){let W=eXeLearning.app.project._yjsBridge.getDocumentManager();if(W?.saveToServer)await W.saveToServer(),console.log("[NavbarFile] Project saved to server before platform upload")}}catch(W){console.warn("[NavbarFile] Failed to save before platform upload:",W)}let X={projectUuid:Y,jwt_token:Z},J;if(J=await eXeLearning.app.api.postFirstTypePlatformIntegrationElpUpload(X),J.responseMessage=="OK")window.onbeforeunload=null,window.location.replace(J.returnUrl);else eXe.app.alert(_(J.responseMessage))}createIdevicesUploadInput(){let Q=document.createElement("input");return Q.classList.add("local-ode-file-upload-input"),Q.setAttribute("type","file"),Q.setAttribute("name","local-ode-file-upload"),Q.setAttribute("accept",".elpx,.zip"),Q.classList.add("d-none"),Q.addEventListener("change",(Z)=>{let X=Z.target.files[0],J=this.createIdevicesUploadInput();if(Q.remove(),this.menu.navbar.append(J),X)eXeLearning.app.modals.openuserodefiles.largeFilesUpload(X)}),this.menu.navbar.append(Q),Q}openUserOdeFilesEvent(){let Q=eXeLearning?.app?.capabilities;if(Q&&!Q.storage.remote){this.openFileInputStatic();return}if(eXeLearning.config.isOfflineInstallation===!0)if(window.electronAPI&&typeof window.electronAPI.openElp==="function")(async()=>{let Z=await window.electronAPI.openElp();if(!Z)return;let Y=await window.electronAPI.readFile(Z);if(!Y||!Y.ok){eXeLearning.app.modals.alert.show({title:_("Error opening"),body:Y&&Y.error?Y.error:_("Unknown error."),contentId:"error"});return}let X=Y.base64,J=atob(X),W=J.length,z=new Uint8Array(W);for(let K=0;K<W;K++)z[K]=J.charCodeAt(K);let G=new Blob([z],{type:"application/octet-stream"}),q=Z&&Z.split(/[\\/]/).pop()||"project.elpx",H=new File([G],q,{type:"application/octet-stream",lastModified:Date.now()});try{window.__originalElpPath=Z}catch(K){}eXeLearning.app.modals.openuserodefiles.largeFilesUpload(H)})();else this.createIdevicesUploadInput(),this.menu.navbar.querySelector("input.local-ode-file-upload-input").click();else this.getOdeFilesListEvent().then((Z)=>{eXeLearning.app.modals.openuserodefiles.show(Z)})}openFileInputStatic(){let Q=document.getElementById("static-open-file-input");if(!Q)Q=document.createElement("input"),Q.type="file",Q.id="static-open-file-input",Q.accept=".elpx,.elp",Q.style.display="none",document.body.appendChild(Q),Q.addEventListener("change",async(Z)=>{let Y=Z.target.files?.[0];if(Y)try{if(eXeLearning.app.project?.showLoadingScreen)eXeLearning.app.project.showLoadingScreen();let X=eXeLearning.app.project._yjsBridge;if(!X)throw Error("Yjs bridge not initialized. Please wait for the editor to load.");if(f.log("[Static] Importing file:",Y.name),await X.importFromElpx(Y),eXeLearning.app.project?.refreshAfterDirectImport)await eXeLearning.app.project.refreshAfterDirectImport();f.log("[Static] Import complete:",Y.name)}catch(X){if(console.error("[Static] Failed to import file:",X),eXeLearning.app.modals?.alert)eXeLearning.app.modals.alert.show({title:_("Error opening"),body:X.message||String(X),contentId:"error"});else alert(_("Failed to open project: ")+(X.message||X))}finally{if(eXeLearning.app.project?.hideLoadingScreen)eXeLearning.app.project.hideLoadingScreen()}Z.target.value=""});Q.click()}async getOdeFilesListEvent(){return await eXeLearning.app.api.getUserOdeFiles()}showMostRecentProjectsEvent(){let Q=this.menu.navbar.querySelector("#navbar-dropdown-menu-recent-projects");eXeLearning.app.api.getRecentUserOdeFiles().then((Z)=>{let Y=this.makeRecentProjecList(Z);Q.innerHTML="",Q.append(Y)})}makeRecentProjecList(Q){let Z=document.createElement("li");if(Q.length>0)Q.forEach((Y)=>{let X=document.createElement("a");X.classList.add("dropdown-item"),X.setAttribute("href","#"),X.addEventListener("click",()=>{let J=Y.odeId;if(eXeLearning?.app?.project?._yjsBridge?.documentManager?.hasUnsavedChanges?.()||!1){let G={title:_("Open project"),forceOpen:_("Open without saving"),openYjsProject:!0,projectUuid:J};eXeLearning.app.modals.sessionlogout.show(G)}else{let G=window.eXeLearning?.config?.basePath||"";window.location.href=`${G}/workarea?project=${J}`}}),X.innerHTML=Y.title,Z.append(X)});else{let Y=document.createElement("a");Y.classList.add("dropdown-item"),Y.innerHTML=_("No recent projects..."),Z.append(Y)}return Z}async downloadProjectEvent(){if(eXeLearning.app.project?._yjsEnabled&&eXeLearning.app.project?.exportToElpxViaYjs)return await this.downloadProjectViaYjs();let Q={title:_("Download"),body:_("File generation in progress."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q),Y=eXeLearning.app.project.odeSession,X=await eXeLearning.app.api.getOdeExportDownload(Y,eXeLearning.extension);if(X.responseMessage=="OK")this.electronSave(X.urlZipFile,eXeLearning.extension,X.exportProjectName),Z.toastBody.innerHTML=_("File generated.");else Z.toastBody.innerHTML=_("An error occurred while generating the file."),Z.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:X.responseMessage?X.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Z.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async downloadProjectViaYjs(){let Q={title:_("Save"),body:_("Generating file from collaborative document..."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q);try{await eXeLearning.app.project.exportToElpxViaYjs({saveAs:!1}),Z.toastBody.innerHTML=_("File saved."),f.log("[NavbarFile] Project saved via Yjs")}catch(Y){console.error("[NavbarFile] Yjs save error:",Y),Z.toastBody.innerHTML=_("An error occurred while saving the file."),Z.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:Y.message||_("Unknown error."),contentId:"error"})}setTimeout(()=>{Z.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportViaYjs(Q,Z,Y={}){if(!eXeLearning.app.project?._yjsEnabled)return!1;let X=eXeLearning.app.project?._yjsBridge;if(!X?.documentManager)return console.warn("[NavbarFile] Yjs document manager not available"),!1;let J=window.SharedExporters;if(!J?.createExporter)return console.error("[NavbarFile] SharedExporters not loaded - ensure exporters.bundle.js is included"),!1;let W=["HTML5","ELPX","ELP","SCORM12","SCORM2004","PAGE","HTML5SP","IMS","EPUB3","EPUB"],z=Q.toUpperCase().replace("-","");if(!W.includes(z))return f.log(`[NavbarFile] Format ${Q} not yet supported client-side, using server`),!1;let G={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},q=eXeLearning.app.toasts.createToast(G);try{let H=X.documentManager,K=X.assetManager||null,V=X.assetCache||null,R=X.resourceFetcher||null;f.log(`[NavbarFile] Starting unified ${Q} export via SharedExporters...`);let O=await J.quickExport(Q,H,V,R,{},K);if(O.success&&O.data){if(eXeLearning?.config?.isOfflineInstallation&&window.electronAPI?.saveBuffer){let A=new Uint8Array(O.data),M="";for(let B=0;B<A.length;B++)M+=String.fromCharCode(A[B]);let F=btoa(M),L=`${window.__currentProjectId||"default"}:${Z}`,D=O.filename||"export.zip";if(Y.saveAs)await window.electronAPI.saveBufferAs(F,L,D);else await window.electronAPI.saveBuffer(F,L,D);f.log(`[NavbarFile] Unified export via Electron: ${D}`)}else{let A=new Blob([O.data],{type:"application/zip"}),M=URL.createObjectURL(A),F=document.createElement("a");F.href=M,F.download=O.filename||"export.zip",document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(M),f.log(`[NavbarFile] Unified export complete: ${O.filename}`)}q.toastBody.innerHTML=_("The project has been exported.")}else throw Error(O.error||"Export failed")}catch(H){console.error(`[NavbarFile] Client-side ${Q} export error:`,H),q.toastBody.innerHTML=_("An error occurred while exporting the project."),q.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:H.message||_("Unknown error."),contentId:"error"})}return setTimeout(()=>{q.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface(),!0}async saveAsElpOffline(){if(eXeLearning.app.project?._yjsEnabled&&eXeLearning.app.project?.exportToElpxViaYjs){let Q={title:_("Save as"),body:_("Generating file from collaborative document..."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q);try{await eXeLearning.app.project.exportToElpxViaYjs({saveAs:!0}),Z.toastBody.innerHTML=_("File saved."),f.log("[NavbarFile] Project saved via Yjs (Save As)")}catch(Y){console.error("[NavbarFile] Yjs Save As error:",Y),Z.toastBody.innerHTML=_("An error occurred while saving the file."),Z.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:Y.message||_("Unknown error."),contentId:"error"})}setTimeout(()=>Z.remove(),1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface();return}try{let Q={title:_("Save as"),body:_("File generation in progress."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q),Y=eXeLearning.app.project.odeSession,X=await eXeLearning.app.api.getOdeExportDownload(Y,eXeLearning.extension);if(X&&X.responseMessage==="OK"){let J=X.urlZipFile,W=X.exportProjectName||"document.elpx",z=window.__currentProjectId||"default",G=this.normalizeSuggestedName(W,eXeLearning.extension);if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(J,z,G);else this.downloadLink(J,G);Z.toastBody.innerHTML=_("File generated.")}else Z.toastBody.innerHTML=_("An error occurred while generating the file."),Z.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:X&&X.responseMessage?X.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>Z.remove(),1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}catch(Q){eXeLearning.app.modals.alert.show({title:_("Error"),body:Q.message||"Unknown error.",contentId:"error"})}}async exportHTML5Event(){if(await this.exportViaYjs("HTML5","html5"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"html5");if(J.responseMessage=="OK"){if(eXeLearning.config.isOfflineInstallation&&window.electronAPI)this.electronSave(J.urlZipFile,"export-html5",J.exportProjectName);else this.downloadLink(J.urlZipFile,J.exportProjectName);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportHTML5AsEvent(){if(await this.exportViaYjs("HTML5","html5",{saveAs:!0}))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"html5");if(J.responseMessage=="OK"){let W=J.urlZipFile,z=this.normalizeSuggestedName(J.exportProjectName,"export-html5"),G=window.__currentProjectId||"default";if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(W,`${G}:export-html5`,z);else this.downloadLink(W,z);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportHTML5FolderAsEvent(){let Q={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q);try{if(!eXeLearning.config.isOfflineInstallation||!window.electronAPI){Z.toastBody.innerHTML=_("This option is only available offline."),Z.toastBody.classList.add("error"),setTimeout(()=>Z.remove(),1200);return}if(eXeLearning.app.project?._yjsEnabled&&window.SharedExporters?.quickExport){let J=eXeLearning.app.project._yjsBridge;if(J?.documentManager){let W=J.documentManager,z=J.assetManager||null,G=J.assetCache||null,q=J.resourceFetcher||null,H=await window.SharedExporters.quickExport("HTML5",W,G,q,{},z);if(H.success&&H.data){let K=new Uint8Array(H.data),V="";for(let A=0;A<K.length;A++)V+=String.fromCharCode(K[A]);let R=btoa(V),O=(H.filename||"export").replace(/\.zip$/i,"");if(typeof window.electronAPI.exportBufferToFolder==="function"){let A=await window.electronAPI.exportBufferToFolder(R,O);if(A&&A.ok)Z.toastBody.innerHTML=_("The project has been exported.");else if(A&&A.canceled)Z.toastBody.innerHTML=_("Export canceled.");else throw Error(A?.error||"Folder export failed")}else{let A=new Blob([H.data],{type:"application/zip"}),M=URL.createObjectURL(A),F=document.createElement("a");F.href=M,F.download=H.filename||"export.zip",document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(M),Z.toastBody.innerHTML=_("The project has been exported.")}setTimeout(()=>Z.remove(),1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface();return}}}let Y=eXeLearning.app.project.odeSession,X=await eXeLearning.app.api.getOdeExportDownload(Y,"html5");if(X&&X.responseMessage==="OK"){let J=X.urlZipFile,W=this.normalizeSuggestedName(X.exportProjectName,"export-html5").replace(/\.zip$/i,""),z=window.__currentProjectId||"default";if(typeof window.electronAPI.exportToFolder==="function"){let G=await window.electronAPI.exportToFolder(J,`${z}:export-html5-folder`,W);if(G&&G.ok)Z.toastBody.innerHTML=_("The project has been exported.");else Z.toastBody.innerHTML=_("Export canceled.")}else this.downloadLink(J,`${W}.zip`),Z.toastBody.innerHTML=_("The project has been exported.")}else Z.toastBody.innerHTML=_("An error occurred while exporting the project."),Z.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:X&&X.responseMessage?X.responseMessage:_("Unknown error."),contentId:"error"})}catch(Y){console.error("[NavbarFile] Folder export error:",Y),Z.toastBody.innerHTML=_("Unexpected error."),Z.toastBody.classList.add("error")}setTimeout(()=>Z.remove(),1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportHTML5SPEvent(){if(await this.exportViaYjs("PAGE","html5-sp"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"html5-sp");if(J.responseMessage=="OK"){if(eXeLearning.config.isOfflineInstallation&&window.electronAPI)this.electronSave(J.urlZipFile,"export-html5-sp",J.exportProjectName);else this.downloadLink(J.urlZipFile,J.exportProjectName);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportHTML5SPAsEvent(){if(await this.exportViaYjs("PAGE","html5-sp"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"html5-sp");if(J.responseMessage=="OK"){let W=J.urlZipFile,z=this.normalizeSuggestedName(J.exportProjectName,"export-html5-sp"),G=window.__currentProjectId||"default";if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(W,`${G}:export-html5-sp`,z);else this.downloadLink(W,z);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportSCORM12Event(){if(await this.exportViaYjs("SCORM12","scorm12"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"scorm12");if(J.responseMessage=="OK"){if(eXeLearning.config.isOfflineInstallation&&window.electronAPI)this.electronSave(J.urlZipFile,"export-scorm12",J.exportProjectName);else this.downloadLink(J.urlZipFile,J.exportProjectName);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportSCORM12AsEvent(){if(await this.exportViaYjs("SCORM12","scorm12"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"scorm12");if(J.responseMessage=="OK"){let W=J.urlZipFile,z=this.normalizeSuggestedName(J.exportProjectName,"export-scorm12"),G=window.__currentProjectId||"default";if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(W,`${G}:export-scorm12`,z);else this.downloadLink(W,z);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportSCORM2004Event(){if(await this.exportViaYjs("SCORM2004","scorm2004"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"scorm2004");if(J.responseMessage=="OK"){if(eXeLearning.config.isOfflineInstallation&&window.electronAPI)this.electronSave(J.urlZipFile,"export-scorm2004",J.exportProjectName);else this.downloadLink(J.urlZipFile,J.exportProjectName);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportSCORM2004AsEvent(){if(await this.exportViaYjs("SCORM2004","scorm2004"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"scorm2004");if(J.responseMessage=="OK"){let W=J.urlZipFile,z=this.normalizeSuggestedName(J.exportProjectName,"export-scorm2004"),G=window.__currentProjectId||"default";if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(W,`${G}:export-scorm2004`,z);else this.downloadLink(W,z);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportIMSEvent(){if(await this.exportViaYjs("IMS","ims"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"ims");if(J.responseMessage=="OK"){if(eXeLearning.config.isOfflineInstallation&&window.electronAPI)this.electronSave(J.urlZipFile,"export-ims",J.exportProjectName);else this.downloadLink(J.urlZipFile,J.exportProjectName);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportIMSAsEvent(){if(await this.exportViaYjs("IMS","ims"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"ims");if(J.responseMessage=="OK"){let W=J.urlZipFile,z=this.normalizeSuggestedName(J.exportProjectName,"export-ims"),G=window.__currentProjectId||"default";if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(W,`${G}:export-ims`,z);else this.downloadLink(W,z);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportEPUB3Event(){if(await this.exportViaYjs("EPUB3","epub3"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"epub3");if(J.responseMessage=="OK"){if(eXeLearning.config.isOfflineInstallation&&window.electronAPI)this.electronSave(J.urlZipFile,"export-epub3",J.exportProjectName);else this.downloadLink(J.urlZipFile,J.exportProjectName);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportEPUB3AsEvent(){if(await this.exportViaYjs("EPUB3","epub3"))return;let Z={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdeExportDownload(X,"epub3");if(J.responseMessage=="OK"){let W=J.urlZipFile,z=this.normalizeSuggestedName(J.exportProjectName,"export-epub3"),G=window.__currentProjectId||"default";if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(W,`${G}:export-epub3`,z);else this.downloadLink(W,z);Y.toastBody.innerHTML=_("The project has been exported.")}else Y.toastBody.innerHTML=_("An error occurred while exporting the project."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportXmlPropertiesEvent(){let Q={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q),Y=eXeLearning.app.project.odeSession,X=await eXeLearning.app.api.getOdeExportDownload(Y,"properties");if(X.responseMessage=="OK"){if(eXeLearning.config.isOfflineInstallation&&window.electronAPI)this.electronSave(X.urlZipFile,"export-xml-properties",X.exportProjectName);else this.downloadLink(X.urlZipFile,X.exportProjectName);Z.toastBody.innerHTML=_("The project properties have been exported.")}else Z.toastBody.innerHTML=_("An error occurred while exporting the project."),Z.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:X.responseMessage?X.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Z.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}async exportXmlPropertiesAsEvent(){let Q={title:_("Export"),body:_("Generating export files..."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q),Y=eXeLearning.app.project.odeSession,X=await eXeLearning.app.api.getOdeExportDownload(Y,"properties");if(X.responseMessage=="OK"){let J=X.urlZipFile,W=this.normalizeSuggestedName(X.exportProjectName,"export-xml-properties"),z=window.__currentProjectId||"default";if(window.electronAPI&&typeof window.electronAPI.saveAs==="function")await window.electronAPI.saveAs(J,`${z}:export-xml-properties`,W);else this.downloadLink(J,W);Z.toastBody.innerHTML=_("The project properties have been exported.")}else Z.toastBody.innerHTML=_("An error occurred while exporting the project."),Z.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:X.responseMessage?X.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Z.remove()},1000),eXeLearning.app.interface.connectionTime.loadLasUpdatedInInterface()}createPropertiesUploadInput(){let Q=document.createElement("input");return Q.classList.add("local-xml-properties-upload-input"),Q.setAttribute("type","file"),Q.setAttribute("name","local-xml-properties-upload"),Q.setAttribute("accept",".xml"),Q.classList.add("hidden"),Q.addEventListener("change",(Z)=>{let X=Z.target.files[0],J=this.createPropertiesUploadInput();if(Q.remove(),this.menu.navbar.append(J),X)eXeLearning.app.modals.openuserodefiles.largeFilesUpload(X,!1,!0)}),this.menu.navbar.append(Q),Q}async importXmlPropertiesEvent(){this.createPropertiesUploadInput(),this.menu.navbar.querySelector(".local-xml-properties-upload-input").click()}downloadLink(Q,Z){eXeLearning.app.api.getFileResourcesForceDownload(Q).then((Y)=>{let X=Y.url||Q;if(eXeLearning.config.isOfflineInstallation===!0&&window.electronAPI&&typeof window.electronAPI.save==="function"){let W=window.__currentProjectId||"default",z=typeof Z==="string"&&Z?Z:"document.elpx",G=eXeLearning.extension;try{if(/export-html5-sp/i.test(z))G="export-html5-sp";else if(/export-html5/i.test(z))G="export-html5";else if(/export-scorm2004/i.test(z))G="export-scorm2004";else if(/export-scorm12/i.test(z))G="export-scorm12";else if(/export-ims/i.test(z))G="export-ims";else if(/export-epub3/i.test(z))G="export-epub3";else if(/xml/i.test(z))G="export-xml-properties";else if(/\.zip$/i.test(z))G="export"}catch(H){}let q=this.normalizeSuggestedName(z,G);window.electronAPI.save(X,W,q);return}let J=document.createElement("a");J.href=X,J.download=Z,document.body.appendChild(J),J.click(),document.body.removeChild(J)})}electronSave(Q,Z,Y){let X=window.__currentProjectId||"default",J=Z===eXeLearning.extension?X:`${X}:${Z}`,W=this.normalizeSuggestedName(Y,Z);if(window.electronAPI&&typeof window.electronAPI.save==="function")window.electronAPI.save(Q,J,W);else this.downloadLink(Q,W)}normalizeSuggestedName(Q,Z){try{let Y=(Q||"").trim(),J=Y.replace(/\.[^.]+$/,"").toLowerCase(),W=!J||/^document(\b|[\s._-].*)?$/.test(J)||/^export(\b|[-_.].*)?$/.test(J),z=Y;if(W){try{let R=eXeLearning.app.project.properties?.properties?.pp_title?.value;if(R&&R.trim())z=R.trim()}catch(R){}if(!z||!z.trim())z="project";z=this.appendSuffixForType(z,Z)}let G=(Z||"").toLowerCase(),q="";if(G.endsWith("epub3"))q=".epub";else if(G.endsWith(eXeLearning.extension))q="."+eXeLearning.extension;else if(G.includes("xml"))q=".xml";else q=".zip";let H=/\.([^.]+)$/.exec(z),K=H?H[0]:null,V=H?`.${H[1].toLowerCase()}`:null;if(!V||!d2.has(V))z+=q;else if(V!==q)z=z.slice(0,-K.length)+q;return z}catch(Y){return Q||"export.zip"}}appendSuffixForType(Q,Z){let Y=(Z||"").toLowerCase();if(Y.endsWith("html5"))return`${Q}_web`;if(Y.endsWith("html5-sp"))return`${Q}_page`;if(Y.endsWith("scorm12"))return`${Q}_scorm`;if(Y.endsWith("scorm2004"))return`${Q}_scorm2004`;if(Y.endsWith("ims"))return`${Q}_ims`;return Q}async currentOdeUsers(Q){if((await eXeLearning.app.api.getOdeConcurrentUsers(Q.odeId,Q.odeVersionId,Q.odeSessionId)).currentUsers.length==1)this.makeConfirmTitleInputModal();else{let X={responseMessage:_("Other users are connected.")};eXeLearning.app.project.showModalSaveError(X)}}async checkIfLegacyElpFormat(Q){try{let Z=window.fflate;if(!Z)return console.warn("[NavbarFile] fflate not available for format detection"),!1;let Y=await Q.arrayBuffer(),X=new Uint8Array(Y),W=Z.unzipSync(X)["contentv3.xml"];if(!W)return!1;let z=new TextDecoder().decode(W),H=new DOMParser().parseFromString(z,"text/xml").documentElement?.tagName;if(H==="instance"||H==="dictionary")return f.log("[NavbarFile] Detected Python pickle format (legacy)"),!0;return!1}catch(Z){return console.error("[NavbarFile] Error detecting file format:",Z),!1}}async convertLegacyElpViaBackend(Q,Z){try{let Y=new FormData;Y.append("file",Q),Y.append("sessionId",eXeLearning.app.project.odeSession);let X=window.eXeLearning?.config?.basePath||"",J=await fetch(`${X}/api/project/convert-legacy`,{method:"POST",body:Y,headers:{Authorization:`Bearer ${eXeLearning.app.auth?.token||""}`}});if(!J.ok)return{success:!1,error:(await J.json().catch(()=>({}))).message||`Server error: ${J.status}`};let W=await J.json();return{success:!0,structure:W.structure,assets:W.assets||[]}}catch(Y){return console.error("[NavbarFile] Legacy conversion failed:",Y),{success:!1,error:Y.message||"Failed to convert legacy file"}}}}var r1=window.AppLogger||console;class x1{constructor(Q){this.menu=Q,this.button=this.menu.navbar.querySelector("#dropdownUtilities"),this.preferencesButton=document.querySelector("#navbar-button-preferences"),this.ideviceManagerButton=this.menu.navbar.querySelector("#navbar-button-idevice-manager"),this.brokenLinksButton=this.menu.navbar.querySelector("#navbar-button-odebrokenlinks"),this.filemanagerButton=this.menu.navbar.querySelector("#navbar-button-filemanager"),this.usedFilesButton=this.menu.navbar.querySelector("#navbar-button-odeusedfiles"),this.previewButton=this.menu.navbar.querySelector("#navbar-button-preview"),this.projectPreferencesButton=document.querySelector("#head-top-settings-button")}setEvents(){this.setTooltips(),this.setPreferencesEvent(),this.setIdeviceManagerEvent(),this.setFileManagerEvent(),this.setOdeBrokenLinksEvent(),this.setOdeUsedFilesEvent(),this.setPreviewEvent(),this.setProjectPreferencesEvent()}setTooltips(){$(".main-menu-right > button").attr("data-bs-placement","bottom").tooltip()}setPreferencesEvent(){this.preferencesButton.addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return Q.preventDefault(),!1;this.preferencesEvent(),Q.preventDefault()})}setIdeviceManagerEvent(){this.ideviceManagerButton.addEventListener("click",()=>{this.ideviceManagerEvent()})}setFileManagerEvent(){this.filemanagerButton.addEventListener("click",()=>{this.fileManagerEvent()})}setOdeBrokenLinksEvent(){this.brokenLinksButton.addEventListener("click",()=>{this.odeBrokenLinksEvent()})}setOdeUsedFilesEvent(){this.usedFilesButton.addEventListener("click",()=>{this.odeUsedFilesEvent()})}setPreviewEvent(){this.previewButton.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.previewEvent()})}setProjectPreferencesEvent(){this.projectPreferencesButton.addEventListener("click",()=>{document.querySelector('[nav-id="root"]')?.querySelectorAll(".nav-element-text")[0]?.click()})}preferencesEvent(){eXeLearning.app.user.preferences.showModalPreferences()}ideviceManagerEvent(){eXeLearning.app.idevices.showModalIdeviceManager()}fileManagerEvent(){eXeLearning.app.modals.filemanager.show()}odeBrokenLinksEvent(){let Q=this.collectAllIdevicesHtml();eXeLearning.app.modals.odebrokenlinks.show(Q)}async getOdeSessionBrokenLinksEvent(){let Q=eXeLearning.app.project.odeSession,Z=this.collectAllIdevicesHtml(),Y={csv:!1,odeSessionId:Q,idevices:Z};return await eXeLearning.app.api.getOdeSessionBrokenLinks(Y)}collectAllIdevicesHtml(){let Q=[];if(!eXeLearning.app.project._yjsBridge?.structureBinding)return console.warn("[NavbarUtilities] Yjs structure binding not available"),Q;let Y=eXeLearning.app.project._yjsBridge.structureBinding.manager?.getNavigation();if(!Y)return console.warn("[NavbarUtilities] Navigation not available"),Q;for(let X=0;X<Y.length;X++){let J=Y.get(X),W=J.get("title")||J.get("name")||"",z=J.get("blocks");if(!z)continue;for(let G=0;G<z.length;G++){let q=z.get(G),H=q.get("blockName")||q.get("title")||q.get("name")||"",K=q.get("components");if(!K)continue;for(let V=0;V<K.length;V++){let R=K.get(V),O="",A=R.get("htmlContent"),M=R.get("htmlView");if(A)O=typeof A.toString==="function"?A.toString():String(A);else if(M)O=String(M);let F=R.get("jsonProperties");if(F)O+=" "+(typeof F==="string"?F:JSON.stringify(F));if(O)Q.push({html:O,pageName:W,blockName:H,ideviceType:R.get("ideviceType")||"",order:R.get("order")??V})}}}return console.log(`[NavbarUtilities] Collected ${Q.length} idevices for link validation`),Q}odeUsedFilesEvent(){let Q={title:_("Resources report"),body:_("Checking the project resources..."),icon:"downloading"},Z=eXeLearning.app.toasts.createToast(Q);this.getOdeSessionUsedFilesEvent().then((Y)=>{if(Y.responseMessage=="OK"&&Y.usedFiles)eXeLearning.app.modals.odeusedfiles.show(Y);else eXeLearning.app.modals.alert.show({title:_("Resources report"),body:_("The project has no files.")});setTimeout(()=>{Z.remove()},800)})}async getOdeSessionUsedFilesEvent(){let Q=eXeLearning.app.project.odeSession,Z=this.collectAllIdevicesHtml(),Y=await this.collectAssetMetadata(Z),X={csv:!1,odeSessionId:Q,resourceReport:!0,idevices:Z,assetMetadata:Y};return await eXeLearning.app.api.getOdeSessionUsedFiles(X)}async collectAssetMetadata(Q){let Z={},Y=eXeLearning.app.project?._yjsBridge?.assetManager;if(!Y)return console.warn("[NavbarUtilities] AssetManager not available"),Z;let X=new Set,J=/asset:\/\/([a-f0-9-]+)/gi;for(let W of Q){if(!W.html)continue;let z;while((z=J.exec(W.html))!==null)X.add(z[1])}for(let W of X)try{let z=await Y.getAsset(W);if(z)Z[W]={filename:z.filename||null,size:z.size||0,mime:z.mime||"application/octet-stream"}}catch(z){console.warn(`[NavbarUtilities] Failed to get metadata for asset ${W}:`,z)}return r1.log(`[NavbarUtilities] Collected metadata for ${Object.keys(Z).length} assets`),Z}json2Csv(Q,Z){let Y=typeof Q==="string"?JSON.parse(Q):Q,X=[],J={};if(Z.includes("Link")||Z.includes("Error"))X=Y.brokenLinks||[],J={Link:"brokenLinks",Error:"brokenLinksError",Times:"nTimesBrokenLinks","Page name":"pageNamesBrokenLinks","Block name":"blockNamesBrokenLinks",Type:"typeComponentSyncBrokenLinks","Block position":"orderComponentSyncBrokenLinks"};else if(Z.includes("File"))X=Y.usedFiles||[],J={File:"usedFiles",Path:"usedFilesPath",Size:"usedFilesSize","Page name":"pageNamesUsedFiles","Block name":"blockNamesUsedFiles",Type:"typeComponentSyncUsedFiles","Block position":"orderComponentSyncUsedFiles"};else return Z.join(",")+`\r
`;let W="";return W+=Z.join(",")+`\r
`,X.forEach((z)=>{if(J.Error&&(z[J.Error]===null||z[J.Error]===void 0))return;let G=Z.map((q)=>{let H=z[J[q]];if(H===null||H===void 0)H="";if(typeof H==="string"&&(H.includes(",")||H.includes('"')||H.includes(`
`)))H=`"${H.replace(/"/g,'""')}"`;return H}).join(",");W+=G+`\r
`}),W}async previewEvent(){let Q=eXeLearning.app.interface?.previewButton?.getPanel();if(Q){Q.toggle();return}if(eXeLearning.app.project?._yjsEnabled){if(await this.openClientPreview())return}let Z={title:_("Preview"),body:_("Generating preview..."),icon:"preview"},Y=eXeLearning.app.toasts.createToast(Z),X=eXeLearning.app.project.odeSession,J=await eXeLearning.app.api.getOdePreviewUrl(X);if(J.responseMessage=="OK")Y.toastBody.innerHTML=_("The preview has been generated."),setTimeout(()=>{window.open(J.urlPreviewIndex)},100);else Y.toastBody.innerHTML=_("An error occurred while generating the preview."),Y.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.responseMessage?J.responseMessage:_("Unknown error."),contentId:"error"});setTimeout(()=>{Y.remove()},1000)}async openClientPreview(){let Q=eXeLearning.app.project?._yjsBridge;if(!Q?.documentManager)return console.warn("[NavbarUtilities] Yjs document manager not available for preview"),!1;let Z=window.SharedExporters;if(!Z?.openPreviewWindow)return console.error("[NavbarUtilities] SharedExporters not loaded - ensure exporters.bundle.js is included"),!1;let Y={title:_("Preview"),body:_("Generating preview..."),icon:"preview"},X=eXeLearning.app.toasts.createToast(Y);try{let J=Q.documentManager,W=Q.resourceFetcher||null,z={baseUrl:window.location.origin,basePath:window.eXeLearning?.config?.basePath||"",version:window.eXeLearning?.config?.version||"v1.0.0"};if(r1.log("[NavbarUtilities] Starting unified preview via SharedExporters..."),await Z.openPreviewWindow(J,W,z))X.toastBody.innerHTML=_("The preview has been generated."),r1.log("[NavbarUtilities] Unified preview opened successfully");else throw Error("Failed to open preview window")}catch(J){return console.error("[NavbarUtilities] Client-side preview error:",J),X.toastBody.innerHTML=_("An error occurred while generating the preview."),X.toastBody.classList.add("error"),eXeLearning.app.modals.alert.show({title:_("Error"),body:J.message||_("Unknown error."),contentId:"error"}),!0}return setTimeout(()=>{X.remove()},1000),!0}}var n=window.AppLogger||console;class w1{constructor(Q){this.menu=Q,this.button=this.menu.navbar.querySelector("#dropdownStyles"),this.menuButton=this.menu.navbar.querySelector("#navbar-button-styles"),this.readers=[],this.paramsInfo=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.themeInfoFieldsConfig)),this.paramsEdit=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.themeEditionFieldsConfig)),this.updateThemes();let Z=document.querySelector("#exestylescontent-tab");if(Z)Z.addEventListener("click",()=>{this.buildBaseListThemes()});let Y=document.querySelector("#importedstylescontent-tab");if(Y)Y.addEventListener("click",()=>{this.buildUserListThemes()})}updateThemes(){this.themes=eXeLearning.app.themes.list.installed,this.userThemes=[],this.baseThemes=[];for(let Q in this.themes){let Z=this.themes[Q];if(Z.type==="user")this.userThemes.push(Z);else if(Z.type==="base"||Z.type==="site"||Z.type==="admin")this.baseThemes.push(Z)}}updateSelectedTheme(Q){document.querySelectorAll("#exestylescontent .theme-card").forEach((Z)=>{if(Z.dataset.themeId===Q)Z.classList.add("selected");else Z.classList.remove("selected")}),document.querySelectorAll("#importedstylescontent .user-theme-item").forEach((Z)=>{if(Z.dataset.themeId===Q)Z.classList.add("selected");else Z.classList.remove("selected")}),n.log("[NavbarStyles] Updated selected theme UI:",Q)}setStyleManagerEvent(){[this.button,this.menuButton].filter(Boolean).forEach((Q)=>{Q.addEventListener("click",()=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.styleManagerEvent()})})}styleManagerEvent(){this.updateThemes(),this.buildBaseListThemes(),this.buildUserListThemes(),this.toggleSidenav(),document.getElementById("sidenav-overlay").addEventListener("click",this.toggleSidenav),document.getElementById("stylessidenavclose").addEventListener("click",this.toggleSidenav)}buildBaseListThemes(){let Q=document.querySelector("#styleslistContent #exestylescontent");Q.innerHTML="";for(let Z in this.baseThemes){let Y=this.baseThemes[Z],X=document.createElement("div");if(X.classList.add("theme-card"),X.dataset.themeId=Y.id,Y.manager.selected&&Y.manager.selected.name===Y.name)X.classList.add("selected");let J=document.createElement("div");J.classList.add("theme-card-header");let W=document.createElement("h4");W.classList.add("theme-card-title"),W.textContent=Y.title;let z=document.createElement("div");z.classList.add("btn","button-square","fixed-border","small","d-flex","justify-content-center","align-items-center"),z.innerHTML='<span class="micro-icon dots-menu-vertical-icon"></span>';let G=document.createElement("div");G.classList.add("theme-menu","exe-submenu","hidden");let q=document.createElement("ul"),H=document.createElement("li");if(Y.downloadable=="1")H.classList.add("theme-action-download");else H.classList.add("disabled");let K=document.createElement("span");if(Y.downloadable=="1")K.classList.add("small-icon","download-icon-green");else K.classList.add("small-icon","download-icon-disabled");H.appendChild(K),H.appendChild(document.createTextNode(` ${_("Download")}`)),H.addEventListener("click",(M)=>{this.downloadThemeZip(Y)});let V=document.createElement("li");V.classList.add("theme-action-info");let R=document.createElement("span");R.classList.add("small-icon","info-icon-green"),V.appendChild(R),V.appendChild(document.createTextNode(` ${_("Properties")}`)),V.addEventListener("click",(M)=>{M.preventDefault(),M.stopPropagation();let F=document.getElementById("exestylescontent");F.innerHTML="",F.append(this.makeElementInfoTheme(Y,"base"))}),q.appendChild(V),q.appendChild(H),G.appendChild(q),J.appendChild(W),J.appendChild(z),J.appendChild(G);let O=document.createElement("img");O.classList.add("theme-card-preview"),O.setAttribute("alt",_("Preview")),O.src=`${Y.path}screenshot.png`;let A=document.createElement("p");A.classList.add("theme-description"),A.innerHTML=Y.description,X.appendChild(J),X.appendChild(O),X.appendChild(A),z.addEventListener("click",(M)=>{M.stopPropagation(),document.querySelectorAll(".theme-menu").forEach((F)=>{if(F!==G)F.classList.add("hidden")}),G.classList.toggle("hidden")}),Q.appendChild(X),X.addEventListener("click",()=>{eXeLearning.app.themes.selectTheme(Y.id,!0,!1).then(()=>{document.querySelectorAll(".theme-card.selected").forEach((M)=>{if(M!==G)M.classList.remove("selected")}),X.classList.add("selected")})})}document.addEventListener("click",()=>{document.querySelectorAll(".theme-menu").forEach((Z)=>Z.classList.add("hidden"))})}buildUserListThemes(){let Q=document.querySelector("#styleslistContent #importedstylescontent");Q.innerHTML="";let Z=document.createElement("div");if(Z.classList.add("user-theme-empty-info"),Object.keys(this.userThemes).length===0){Z.innerHTML=`
        <p class="empty-title">${_("There are no imported styles yet")}...</p>
        <p class="info-description">
            ${_("You can check the guide to create a style or add it from a link.")}
        </p>`,Q.appendChild(Z),Q.appendChild(this.createEmptyBox());return}Z.innerHTML=`<p class="info-description">
            ${_("You can check the guide to create a style or add it from a link.")}
        </p>`,Q.appendChild(Z);for(let Y in this.userThemes){let X=this.userThemes[Y],J=document.createElement("div");if(J.classList.add("user-theme-item"),J.dataset.themeId=X.id,X.manager.selected&&X.manager.selected.name===X.name)J.classList.add("selected");let W=document.createElement("span");W.classList.add("medium-icon","palette-icon-green");let z=document.createElement("span");z.classList.add("user-theme-title"),z.textContent=X.title;let G=document.createElement("div");G.classList.add("btn","button-square","fixed-border","small","d-flex","justify-content-center","align-items-center"),G.innerHTML='<span class="micro-icon dots-menu-vertical-icon"></span>';let q=document.createElement("div");q.classList.add("theme-menu","exe-submenu","hidden");let H=document.createElement("ul");H.appendChild(this.makeMenuThemeEdit(X)),H.appendChild(this.makeMenuThemeDownload(X)),H.appendChild(this.makeMenuThemeInfo(X)),H.appendChild(this.makeMenuThemeDelete(X.id)),q.appendChild(H),G.addEventListener("click",(K)=>{K.stopPropagation(),document.querySelectorAll(".theme-menu").forEach((V)=>{if(V!==q)V.classList.add("hidden")}),q.classList.toggle("hidden")}),J.appendChild(W),J.appendChild(z),J.appendChild(G),J.appendChild(q),J.addEventListener("click",()=>{eXeLearning.app.themes.selectTheme(X.id,!0,!1).then(()=>{document.querySelectorAll(".user-theme-item.selected").forEach((K)=>{if(K!==q)K.classList.remove("selected")}),J.classList.add("selected")})}),Q.appendChild(J)}Q.appendChild(this.createEmptyBox()),document.addEventListener("click",()=>{document.querySelectorAll(".theme-menu").forEach((Y)=>Y.classList.add("hidden"))})}createEmptyBox(){let Q=document.createElement("div");Q.classList.add("user-theme-empty-upload");let Z=document.createElement("div");Z.classList.add("upload-box-icon");let Y=document.createElement("span");Y.classList.add("medium-icon","upload-cloud-icon"),Z.appendChild(Y);let X=document.createElement("div");X.classList.add("upload-box-text");let J=document.createElement("p"),W=document.createElement("strong");W.textContent=_("Click to upload the file"),J.appendChild(W);let z=document.createElement("p");z.classList.add("text-muted"),z.textContent=_("or drag it here"),X.appendChild(J),X.appendChild(z),Q.appendChild(Z),Q.appendChild(X);let G=this.makeElementInputFileImportTheme();return Q.appendChild(G),Q.addEventListener("click",()=>G.querySelector("#theme-file-import")?.click()),Q.addEventListener("dragover",(q)=>{q.preventDefault(),Q.classList.add("dragover")}),Q.addEventListener("dragleave",()=>{Q.classList.remove("dragover")}),Q.addEventListener("drop",(q)=>{q.preventDefault(),Q.classList.remove("dragover");let H=q.dataTransfer.files;Array.from(H).forEach((K)=>this.addNewReader(K))}),Q}makeMenuThemeEdit(Q){let Z=document.createElement("li"),Y=document.createElement("span");return Y.classList.add("small-icon","edit-icon-green"),Z.appendChild(Y),Z.appendChild(document.createTextNode(` ${_("Edit")}`)),Z.addEventListener("click",(X)=>{X.preventDefault(),X.stopPropagation();let J=document.getElementById("importedstylescontent");J.innerHTML="",J.append(this.makeElementEditTheme(Q))}),Z}makeElementEditTheme(Q){let Z=document.createElement("div");Z.classList.add("edit-theme-container");let Y=document.createElement("div");Y.classList.add("btn","button-tertiary","button-narrow","action-back","d-flex","justify-content-center","align-items-center");let X=document.createElement("div");return X.classList.add("medium-icon","arrow-left-icon"),Y.appendChild(X),Y.addEventListener("click",()=>{this.buildUserListThemes()}),Z.appendChild(Y),Z.appendChild(this.makeElementEditThemeTable(Q)),Z}makeMenuThemeDownload(Q){let Z=document.createElement("li"),Y=Q.downloadable==="1"||Q.downloadable===1;if(!Y)Z.classList.add("disabled");let X=document.createElement("span");if(Y)X.classList.add("small-icon","download-icon-green");else X.classList.add("small-icon","download-icon-disabled");return Z.appendChild(X),Z.appendChild(document.createTextNode(` ${_("Download")}`)),Z.addEventListener("click",(J)=>{if(J.preventDefault(),J.stopPropagation(),Y)this.downloadThemeZip(Q)}),Z}makeMenuThemeInfo(Q){let Z=document.createElement("li"),Y=document.createElement("span");return Y.classList.add("small-icon","info-icon-green"),Z.appendChild(Y),Z.appendChild(document.createTextNode(` ${_("Properties")}`)),Z.addEventListener("click",(X)=>{X.preventDefault(),X.stopPropagation();let J=document.getElementById("importedstylescontent");J.innerHTML="",J.append(this.makeElementInfoTheme(Q,"users"))}),Z}makeMenuThemeDelete(Q){let Z=document.createElement("li"),Y=document.createElement("span");return Y.classList.add("small-icon","delete-icon-red"),Z.appendChild(Y),Z.appendChild(document.createTextNode(` ${_("Delete")}`)),Z.addEventListener("click",(X)=>{X.preventDefault(),X.stopPropagation(),eXeLearning.app.modals.confirm.show({title:_("Delete style"),body:_(`Are you sure you want to delete the style: ${Q}?`),confirmButtonText:_("Delete"),cancelButtonText:_("Cancel"),confirmExec:()=>{this.removeTheme(Q)}})}),Z}async newTheme(Q){let Z=await eXeLearning.app.api.postNewTheme(Q);if(Z&&Z.responseMessage==="OK"&&Z.themes)return new Promise((X,J)=>{setTimeout(()=>{this.themes.loadThemes(Z.themes.themes),this.updateThemes(),this.buildUserListThemes(),X(!0)},1000)});else this.showElementAlert(_("Failed to create the style"),Z)}async editTheme(Q,Z){try{let Y=eXeLearning.app.themes.list.installed,X=Y[Q];if(!X)X=Object.values(Y).find((z)=>z.dirName===Q||z.id===Q||z.name===Q);if(X?.isUserTheme||X?.type==="user"){let z=eXeLearning.app.project?._yjsBridge?.resourceCache;if(!z){this.showElementAlert(_("Storage not available"),{});return}let G=Z.data||{},q=X.name||X.dirName||Q;if(await z.updateUserThemeConfig(q,G),X){if(Object.assign(X,G),G.title)X.displayName=G.title}this.updateThemes(),this.buildUserListThemes(),n.log(`[NavbarStyles] User theme '${Q}' config updated`);return}let W=await eXeLearning.app.api.putEditTheme(Q,Z);if(W&&W.responseMessage==="OK"&&W.themes)return eXeLearning.app.themes.list.loadThemesInstalled(),new Promise((G,q)=>{setTimeout(()=>{this.updateThemes(),this.buildUserListThemes()},1000)});else this.showElementAlert(_("Failed to edit the style "),W)}catch(Y){console.error("[NavbarStyles] editTheme error:",Y),this.showElementAlert(_("Failed to edit the style "),{error:Y.message})}}async removeTheme(Q){try{let Z=eXeLearning.app.themes.list.installed[Q];if(Z?.isUserTheme||Z?.type==="user"){let X=eXeLearning.app.project?._yjsBridge?.resourceCache;if(X)await X.deleteUserTheme(Q),n.log(`[NavbarStyles] User theme '${Q}' deleted from IndexedDB`);let J=eXeLearning.app.resourceFetcher;if(J)J.userThemeFiles?.delete(Q),J.cache?.delete(`theme:${Q}`);await eXeLearning.app.themes.list.removeTheme(Q),this.updateThemes(),this.buildUserListThemes(),n.log(`[NavbarStyles] User theme '${Q}' removed successfully`)}else{let X={};X.id=Q;let J=await eXeLearning.app.api.deleteTheme(X);if(J&&J.responseMessage==="OK"&&J.deleted&&J.deleted.name)await eXeLearning.app.themes.list.removeTheme(J.deleted.name),this.updateThemes(),this.buildUserListThemes();else this.showElementAlert(_("Failed to remove style"),J)}}catch(Z){console.error("[NavbarStyles] Remove theme error:",Z),this.showElementAlert(_("Failed to remove style"),{error:Z.message})}}makeElementInfoTheme(Q,Z){let Y=document.createElement("div");Y.classList.add("info-theme-container");let X=document.createElement("div");X.classList.add("btn","button-tertiary","button-narrow","action-back","d-flex","justifycontent-center","align-items-center");let J=document.createElement("div");J.classList.add("medium-icon","arrow-left-icon"),X.appendChild(J),X.addEventListener("click",()=>{if(Z==="base")this.buildBaseListThemes();if(Z==="users")this.buildUserListThemes()}),Y.appendChild(X);for(let[W,z]of Object.entries(this.paramsInfo))if(Q[W])Y.appendChild(this.makeElementInfoThemeItem(W,Q[W],z));return Y}showElementAlert(Q,Z){let Y=Q,X=Z&&Z.error?Z.error:"",J=X?`<p>${Y}:</p><p>&nbsp;${X}</p>`:`<p>${Y}</p>`;eXe.app.alert(J)}makeElementInputFileImportTheme(){let Q=document.createElement("input");Q.setAttribute("type","file"),Q.setAttribute("accept",".zip"),Q.id="theme-file-import",Q.classList.add("hidden","theme-file-import");let Z=document.createElement("label");Z.setAttribute("for",Q.id),Z.classList.add("visually-hidden"),Z.textContent=_("Import style in ZIP format"),Q.addEventListener("change",(X)=>{Array.from(Q.files).forEach((J)=>{this.addNewReader(J)}),Q.value=null});let Y=document.createElement("div");return Y.append(Z),Y.append(Q),Y}addNewReader(Q){let Z=new FileReader;this.readers.push(Z),Z.onload=(Y)=>{this.uploadThemeToIndexedDB(Q.name,Y.target.result)},Z.readAsArrayBuffer(Q)}async uploadThemeToIndexedDB(Q,Z){try{let Y=window.fflate;if(!Y)throw Error("fflate library not loaded");let X=new Uint8Array(Z),J=Y.unzipSync(X),W=J["config.xml"];if(!W){this.showElementAlert(_("Invalid style package"),{error:_("config.xml not found in ZIP")});return}let z=new TextDecoder().decode(W),G=(A)=>{let M=z.match(new RegExp(`<${A}>([\\s\\S]*?)<\\/${A}>`));return M?M[1].trim():""},q=G("name")||Q.replace(".zip",""),H=q.toLowerCase().replace(/[^a-z0-9_-]/g,"_");if(eXeLearning.app.themes.list.installed[H]){this.showElementAlert(_("Style already exists"),{error:_("A style with this name already exists")});return}let K={name:H,dirName:H,displayName:q,title:q,type:"user",version:G("version")||"1.0",author:G("author")||"",license:G("license")||"",description:G("description")||"",downloadable:G("downloadable")||"1",cssFiles:[],js:[],icons:{},valid:!0,isUserTheme:!0};for(let A of Object.keys(J))if(A.endsWith(".css")&&!A.includes("/"))K.cssFiles.push(A);else if(A.endsWith(".js")&&!A.includes("/"))K.js.push(A);else if(A.startsWith("icons/")&&(A.endsWith(".png")||A.endsWith(".svg"))){let M=A.replace("icons/","").replace(/\.(png|svg)$/,"");K.icons[M]=A}if(K.cssFiles.length===0)K.cssFiles.push("style.css");let V=Y.zipSync(J,{level:6}),R=eXeLearning.app.project?._yjsBridge?.resourceCache;if(!R){this.showElementAlert(_("Failed to install the new style"),{error:_("Storage not available")});return}await R.setUserTheme(H,V,K),n.log(`[NavbarStyles] Theme '${H}' saved to IndexedDB`);let O=eXeLearning.app.resourceFetcher;if(O)await O.setUserThemeFiles(H,J);eXeLearning.app.themes.list.addUserTheme(K),this.updateThemes(),this.buildUserListThemes(),n.log(`[NavbarStyles] Theme '${H}' installed successfully`)}catch(Y){console.error("[NavbarStyles] Theme upload error:",Y),this.showElementAlert(_("Failed to install the new style"),{error:Y.message})}}uploadTheme(Q,Z){if(console.warn("[NavbarStyles] uploadTheme() is deprecated, use uploadThemeToIndexedDB()"),typeof Z==="string"&&Z.includes("base64,")){let Y=Z.split("base64,")[1],X=atob(Y),J=new Uint8Array(X.length);for(let W=0;W<X.length;W++)J[W]=X.charCodeAt(W);this.uploadThemeToIndexedDB(Q,J.buffer)}else this.uploadThemeToIndexedDB(Q,Z)}async downloadThemeZip(Q){if(!(Q.downloadable==="1"||Q.downloadable===1)){this.showElementAlert(_("This style cannot be downloaded"),{});return}if(Q.type==="user"||Q.isUserTheme){try{let Y=eXeLearning.app.project?._yjsBridge?.resourceCache;if(!Y){this.showElementAlert(_("Storage not available"),{});return}let X=await Y.getUserThemeRaw(Q.name);if(!X?.compressedFiles){this.showElementAlert(_("Style files not found"),{});return}let J=new Blob([X.compressedFiles],{type:"application/zip"}),W=URL.createObjectURL(J),z=document.createElement("a");z.href=W,z.download=`${Q.name}.zip`,z.click(),URL.revokeObjectURL(W),n.log(`[NavbarStyles] User theme '${Q.name}' downloaded`)}catch(Y){console.error("[NavbarStyles] Download theme error:",Y),this.showElementAlert(_("Failed to download the style"),{error:Y.message})}return}eXeLearning.app.api.getThemeZip(eXeLearning.app.project.odeSession,Q.dirName).then((Y)=>{if(Y&&Y.zipFileName&&Y.zipBase64){let X=document.createElement("a");X.setAttribute("type","hidden"),X.href="data:text/plain;base64,"+Y.zipBase64,X.download=Y.zipFileName,X.click(),X.remove()}})}toggleSidenav(){let Q=document.getElementById("stylessidenav"),Z=document.getElementById("sidenav-overlay");if(Q.classList.contains("active"))Q.classList.remove("active"),Z.classList.remove("active");else Q.classList.add("active"),Z.classList.add("active")}makeElementInfoThemeItem(Q,Z,Y){let X=document.createElement("div");X.classList.add("mb-3");let J=document.createElement("label");switch(J.classList.add("form-label","theme-info-key"),J.setAttribute("for","theme-info-key-"+Q),J.textContent=Y.title,X.appendChild(J),Y.tag){case"text":{let W=document.createElement("input");W.id="theme-info-key-"+Q,W.type="text",W.classList.add("form-control","theme-info-value-text"),W.disabled=!0,W.value=Z,X.appendChild(W);break}case"textarea":{let W=document.createElement("textarea");W.id="theme-info-key-"+Q,W.classList.add("form-control","theme-info-value-text"),W.disabled=!0,W.value=Z,X.appendChild(W);break}}return X}makeElementEditThemeTable(Q){let Z=document.createElement("div");Z.classList.add("edit-theme-table");let Y={};for(let[,G]of Object.entries(this.paramsEdit)){let q=this.slugifyCategory(G.category);Y[q]=G.category,G.tabId=q}let X=Object.entries(Y).map(([G,q],H)=>({id:G,title:q,active:H===0})),J=this.makeThemesFormTabs(X);Z.append(J);let W=document.createElement("div");W.classList.add("tab-content"),W.classList.add("edit-theme-table-rows-container","exe-form-content-rows"),Z.append(W);let z={};for(let[G]of Object.entries(Y)){let q=document.createElement("div");if(q.classList.add("tab-pane","fade"),q.classList.add(`pane-${G}`),!Object.keys(z).length)q.classList.add("show","active");q.id=G,W.append(q),z[G]=q}for(let[G,q]of Object.entries(this.paramsEdit)){let H=Q[G]?Q[G]:"",K=this.makeElementEditThemeTableRow(G,H,q,Q.id);(z[q.tabId]||W).append(K)}return Z.append(this.buttonSave(Q)),Z}makeThemesFormTabs(Q){let Z=document.createElement("ul");Z.classList.add("nav","nav-tabs","exe-form-tabs");let Y=["info","texts","header"];return Q.forEach((X,J)=>{let W=document.createElement("li");W.classList.add("nav-item");let z=document.createElement("a");if(z.classList.add("nav-link","exe-tab"),X.active)z.classList.add("active");z.setAttribute("data-bs-toggle","tab"),z.setAttribute("href",`#${X.id}`),z.setAttribute("role","tab"),z.setAttribute("aria-controls",X.id),z.setAttribute("aria-selected",X.active?"true":"false"),z.setAttribute("title",X.title);let G=document.createElement("div");G.classList.add("small-icon");let q=Y[J];switch(q){case"info":G.classList.add("settings-icon-green"),z.classList.add(`${q}-button`);break;case"texts":G.classList.add("colors-icon-green"),z.classList.add(`${q}-button`);break;case"header":G.classList.add("image-compact-icon-green"),z.classList.add(`${q}-button`);break;default:z.textContent=X.title;break}W.append(z),z.append(G),Z.append(W)}),Z}makeElementEditThemeTableRow(Q,Z,Y,X){let J=document.createElement("div");J.classList.add("row-table-edit-theme","row-form-content","et-row"),J.setAttribute("category",Y.tabId);let W=document.createElement("div");W.classList.add("et-col-label");let z=document.createElement("div");return z.classList.add("et-col-field"),W.append(this.makeElementEditThemeTableRowKey(Q,Y,X)),z.append(this.makeElementEditThemeTableRowValue(Q,Z,Y,X)),J.append(W,z),J}makeElementEditThemeTableRowKey(Q,Z,Y){let X=document.createElement("label");return X.classList.add("form-label","theme-edit-key"),X.setAttribute("for",`${Y}-${Q}-field`),X.innerHTML=`${Z.title}`,X}makeElementEditThemeTableRowValue(Q,Z,Y,X){let J;switch(Y.tag){case"textarea":J=this.makeElementEditThemeTextarea(Z);break;case"text":J=this.makeElementEditThemeText(Z);break;case"color":J=this.makeElementEditThemeColor(Z,Y.config);break;case"img":J=this.makeElementEditThemeImg(Z);break;default:J=this.makeElementEditThemeText(Z)}if(J){if(Y.tag==="img"){let W=J.querySelector('input[type="file"]');if(W)W.id=`${X}-${Q}-field`}else J.id=`${X}-${Q}-field`;if(Y.tag!=="color")J.classList.add("theme-edit-value-field"),J.setAttribute("field",Y.config)}return J}makeElementEditThemeTextarea(Q){let Z=document.createElement("textarea");return Z.classList.add("form-control","theme-edit-value-text"),Z.value=Q??"",Z.rows=4,Z}makeElementEditThemeText(Q){let Z=document.createElement("input");return Z.type="text",Z.classList.add("form-control","theme-edit-value-text"),Z.value=Q??"",Z}makeElementEditThemeColor(Q,Z){let Y=document.createElement("div");Y.classList.add("et-color-wrapper");let X=document.createElement("input");X.type="color",X.classList.add("form-control-color"),X.value=Q??"#000000";let J=document.createElement("input");return J.type="text",J.classList.add("form-control","form-control-sm","theme-edit-value-field"),J.value=Q??"#000000",J.classList.add("theme-edit-value-field"),J.setAttribute("field",Z),X.addEventListener("input",()=>{J.value=X.value}),J.addEventListener("input",()=>{X.value=J.value}),X.setAttribute("data-role","color-input"),J.setAttribute("data-role","color-hex"),Y.append(X,J),Y}makeElementEditThemeImg(Q){let Z=document.createElement("div");if(Z.classList.add("img-container"),Z.setAttribute("value",Q||""),!Q)Z.classList.add("no-img");let Y=document.createElement("img");if(Y.classList.add("preview-img"),Q)Y.setAttribute("src",`${eXeLearning.config.basePath}${Q}?v=${Date.now()}`);let X=document.createElement("input");X.type="file",X.accept="image/*",X.classList.add("et-hidden");let J=document.createElement("button");J.type="button",J.classList.add("btn","btn-outline-primary","btn-sm"),J.setAttribute("value",_("Select image")),J.textContent=_("Select image");let W=document.createElement("button");W.type="button",W.classList.add("exe-icon","remove-img","btn","btn-outline-danger","btn-sm"),W.setAttribute("aria-label",_("Remove image")),W.innerHTML="close";let z=document.createElement("div");return z.classList.add("et-img-controls"),z.append(J,W),J.addEventListener("click",()=>X.click()),X.addEventListener("change",(G)=>{let q=G.target.files.length>0?G.target.files[0]:null;if(q)this.readFile(q).then((H)=>{if(H)Z.classList.remove("no-img"),Z.setAttribute("value",H),Y.setAttribute("src",H)})}),W.addEventListener("click",()=>{X.value="",Z.classList.add("no-img"),Z.setAttribute("value",""),Y.setAttribute("src","")}),Z.append(X),Z.append(Y),Z.append(z),Z}buttonSave(Q){let Z=document.createElement("button");Z.type="button",Z.classList.add("btn","btn-save-theme","button-tertiary","d-flex","align-items-center","justify-content-start"),Z.title=_("Save");let Y=document.createElement("span");Y.classList.add("small-icon","save-icon"),Z.append(Y);let X=document.createElement("span");return X.innerText=Z.title,Z.append(X),Z.addEventListener("click",()=>{this.confirmExecEvent(Q)}),Z}slugifyCategory(Q){return String(Q).replaceAll(/[^a-zA-Z ]/g,"").replaceAll(" ","").toLowerCase()}readFile(Q){return new Promise((Z,Y)=>{let X=new FileReader;X.onload=(J)=>{Z(J.target.result)},X.onerror=Y,X.readAsDataURL(Q)})}getFormEditThemeValues(){let Q={data:{}};return document.querySelectorAll(".theme-edit-value-field").forEach((Y)=>{let X=Y.getAttribute("field");Q.data[X]=Y.value?Y.value:Y.getAttribute("value")}),Q}async confirmExecEvent(Q){let Z=this.getFormEditThemeValues();if(Q.id){if(await this.editTheme(Q.dirName,Z),Q.id===this.themes.manager.selected.id)await this.themes.manager.selectTheme(this.themes.manager.selected.id,!0,!0),this.updateThemes(),this.buildUserListThemes()}else await this.newTheme(Z)}}class S1{constructor(Q){this.menu=Q,this.button=this.menu.navbar.querySelector("#dropdownHelp"),this.assistantButton=this.menu.navbar.querySelector("#navbar-button-assistant"),this.tutorialButton=this.menu.navbar.querySelector("#navbar-button-exe-tutorial"),this.apiDocsButton=this.menu.navbar.querySelector("#navbar-button-api-docs"),this.releaseNotesButton=this.menu.navbar.querySelector("#navbar-button-release-notes"),this.legalNotesButton=this.menu.navbar.querySelector("#navbar-button-legal-notes"),this.exeWebButton=this.menu.navbar.querySelector("#navbar-button-exe-web"),this.reportBugButton=this.menu.navbar.querySelector("#navbar-button-report-bug"),this.aboutButton=this.menu.navbar.querySelector("#navbar-button-about-exe")}setEvents(){this.setAssistantEvent(),this.setTutorialEvent(),this.setApiDocsEvent(),this.setReleaseNotesEvent(),this.setLegalNotesEvent(),this.setExeWebEvent(),this.setReportBugEvent(),this.setAboutExeEvent()}setAssistantEvent(){this.assistantButton.addEventListener("click",()=>{this.assistantEvent()})}setTutorialEvent(){this.tutorialButton.addEventListener("click",()=>{this.tutorialEvent()})}setApiDocsEvent(){this.apiDocsButton.addEventListener("click",()=>{this.apiDocsEvent()})}setReleaseNotesEvent(){this.releaseNotesButton.addEventListener("click",()=>{this.releaseNotesEvent()})}setLegalNotesEvent(){this.legalNotesButton.addEventListener("click",()=>{this.legalNotesEvent()})}setExeWebEvent(){this.exeWebButton.addEventListener("click",()=>{this.eXeWebEvent()})}setReportBugEvent(){this.reportBugButton.addEventListener("click",()=>{this.reportBugEvent()})}setAboutExeEvent(){this.aboutButton.addEventListener("click",()=>{this.aboutExeEvent()})}assistantEvent(){eXeLearning.app.modals.assistant.show()}tutorialEvent(){let Q="https://exelearning.net/ayuda/";window.open(Q,"_blank").focus()}apiDocsEvent(){let Q="/api/docs";window.open(Q,"_blank").focus()}releaseNotesEvent(){eXeLearning.app.modals.releasenotes.show()}legalNotesEvent(){eXeLearning.app.modals.legalnotes.show()}eXeWebEvent(){let Q="https://exelearning.net/";window.open(Q,"_blank").focus()}reportBugEvent(){let Q="https://github.com/exelearning/exelearning/issues";window.open(Q,"_blank").focus()}aboutExeEvent(){eXeLearning.app.modals.about.show()}}class T1{constructor(){this.navbar=document.querySelector("#main #head #eXeLearningNavbar")}load(){this.disableLinks(),this.loadJsNavbarClasses(),this.addNavbarEvents()}disableLinks(){this.navbar.querySelectorAll("a").forEach((Q)=>{Q.addEventListener("click",(Z)=>{Z.preventDefault()})})}loadJsNavbarClasses(){this.file=new j1(this),this.utilities=new x1(this),this.styles=new w1(this),this.help=new S1(this)}addNavbarEvents(){this.file.setEvents(),this.utilities.setEvents(),this.styles.setStyleManagerEvent(),this.help.setEvents()}}var P1=window.AppLogger||console;class E1{constructor(Q){this.structureEngine=Q,this.menuNav=document.querySelector("#main #menu_nav"),this.menuNavList=this.menuNav.querySelector("#nav_list"),this.structureEngine.menuStructureCompose=this,this.levelItemCounters={},this._presenceUnsubscribe=null,this._initPresenceTracking()}_initPresenceTracking(){let Q=()=>{let Z=eXeLearning?.app?.project;if(Z?._yjsEnabled&&Z?._yjsBridge?.getDocumentManager()){let Y=Z._yjsBridge.getDocumentManager();this._presenceUnsubscribe=Y.onUsersChange(({users:J})=>{this._updateNodePresence(J)});let X=Y.getOnlineUsers();if(X&&X.length>0)this._updateNodePresence(X);this._initDeletedPageHandler(Y),P1.log("[MenuStructureCompose] Presence tracking initialized")}else setTimeout(Q,1000)};setTimeout(Q,500)}_initDeletedPageHandler(Q){let Z=Q.getNavigation();if(!Z)return;let Y=new Set;this._updatePreviousPageIds(Y),Z.observeDeep(()=>{setTimeout(()=>{this._handlePossiblePageDeletion(Y),this._updatePreviousPageIds(Y)},100)})}_updatePreviousPageIds(Q){Q.clear();let Z=this.structureEngine?.data||{};for(let[Y,X]of Object.entries(Z))Q.add(X.pageId||Y)}_handlePossiblePageDeletion(Q){try{let Z=this.structureEngine?.menuStructureBehaviour;if(!Z?.nodeSelected)return;let Y=Z.nodeSelected.getAttribute("page-id")||Z.nodeSelected.getAttribute("nav-id");if(!this.menuNavList.querySelector(`.nav-element[page-id="${Y}"], .nav-element[nav-id="${Y}"]`)){P1.log("[MenuStructureCompose] Selected page was deleted, finding parent...");let W=this._findNodeInPreviousData(Y,Q)?.parent,z=null;if(W)z=this.menuNavList.querySelector(`.nav-element[nav-id="${W}"]`);if(!z)z=this.menuNavList.querySelector('.nav-element[nav-id="root"]');if(!z)z=this.menuNavList.querySelector(".nav-element");if(z)P1.log("[MenuStructureCompose] Selecting parent/fallback node"),Z.selectNode(z)}}catch(Z){console.warn("[MenuStructureCompose] Error handling page deletion:",Z)}}_findNodeInPreviousData(Q,Z){let Y=this.structureEngine?.data||{};for(let[X,J]of Object.entries(Y))if((J.pageId||X)===Q)return J;return null}_updateNodePresence(Q){let Z={};Q.forEach((X)=>{if(X.selectedPageId&&!X.isLocal){if(!Z[X.selectedPageId])Z[X.selectedPageId]=[];Z[X.selectedPageId].push(X)}}),this.menuNavList.querySelectorAll(".node-presence-avatars").forEach((X)=>{let J=X.dataset.pageId,W=Z[J]||[];this._renderNodePresence(X,W)})}_renderNodePresence(Q,Z){if(Q.innerHTML="",Z.length===0){Q.style.display="none";return}Q.style.display="flex";let Y=3;if(Z.slice(0,Y).forEach((J,W)=>{let z=document.createElement("div");if(z.classList.add("node-user-avatar"),z.title=J.email||J.name||_("User"),z.style.zIndex=Y-W,J.color)z.style.borderColor=J.color;let G=J.gravatarUrl||s(J.email,20);if(G){let q=document.createElement("img");q.src=G,q.alt=J.name||"";let H=J.initials||v(J.name||J.email);q.onerror=function(){this.style.display="none",z.textContent=H},z.appendChild(q)}else z.textContent=J.initials||v(J.name||J.email);Q.appendChild(z)}),Z.length>Y){let J=document.createElement("div");J.classList.add("node-user-avatar","node-user-more"),J.textContent=`+${Z.length-Y}`,Q.appendChild(J)}}compose(){this.data=this.structureEngine.data?this.structureEngine.data:{},this.menuNavList.innerHTML="",this.levelItemCounters={},this.levelStructure={},this.onlyChildMap={};let Q={};for(let[Z,Y]of Object.entries(this.data))if(Y.parent){if(!Q[Y.parent])Q[Y.parent]=0;Q[Y.parent]++}for(let[Z,Y]of Object.entries(this.data))if(Y.parent&&Q[Y.parent]===1)this.onlyChildMap[Y.id]=!0;for(let[Z,Y]of Object.entries(this.data))if(!Y.parent)this.buildTreeRecursive(Y,this.menuNavList,0);this.initAccesibility(),this.typesetLatexInNavigation()}typesetLatexInNavigation(){let Q=this.menuNavList?.textContent||"";if(/(?:\\\(|\\\[|\\begin\{)/.test(Q)){if(typeof MathJax<"u"&&MathJax.typesetPromise)MathJax.typesetPromise([this.menuNavList]).catch((Z)=>{P1.log("[MenuStructureCompose] MathJax typeset error:",Z)})}}navElementsById(Q){let Z={};return Q.forEach((Y)=>{Z[Y.id]=Y}),Z}makeNodeStructureContentNode(Q,Z,Y=0,X=1,J=!1){let W=document.createElement("div");if(W.classList.add("nav-element"),W.classList.add(`level${Y}`),W.classList.add(`item${X}`),J)W.classList.add("onlyitem");if(W.setAttribute("is-parent",!1),W.setAttribute("nav-id",Z.id),W.setAttribute("page-id",Z.pageId),W.setAttribute("nav-parent",Z.parent),W.setAttribute("order",Z.order),W.setAttribute("data-node-id",Z.id),W.setAttribute("data-selected","false"),Z.open)W.classList.add("toggle-on"),W.setAttribute("data-expanded","true");else W.classList.add("toggle-off"),W.setAttribute("data-expanded","false");this.setPropertiesClassesToElement(W,Z);let z=this.makeNodeIconElement(Z);W.appendChild(z);let G=this.makeNodeTextElement(Z);W.appendChild(G);let q=document.createElement("div");q.classList.add("nav-element-children-container"),W.appendChild(q),Q.appendChild(W)}makeNodeIconElement(Q){let Z=document.createElement("span");if(Z.classList.add("exe-icon"),Z.classList.add("nav-element-toggle"),Q.open)Z.innerHTML="keyboard_arrow_down";else Z.innerHTML="keyboard_arrow_right";return Z}makeNodeRootIconElement(Q){let Z=document.createElement("span");return Z.classList.add("root-icon"),Z.innerHTML=Q.icon,Z}makeNodeTextElement(Q){let Z=document.createElement("button");Z.classList.add("nav-element-text"),Z.setAttribute("title",Q.pageName);let Y=document.createElement("i");Y.setAttribute("aria-hidden","true"),Y.classList.add("medium-icon","page-icon");let X=document.createElement("span");if(X.classList.add("node-text-span"),X.innerText=String(Q.pageName),Z.append(Y),Z.append(X),Q.id==="root"){let H=this.makeNodeRootIconElement(Q);Z.append(H)}else Z.setAttribute("draggable",!0);let J=document.createElement("button");J.classList.add("btn","button-tertiary","button-narrow","d-flex","justify-content-center","align-items-center","node-add-button","page-add"),J.setAttribute("data-parentnavid",Q.id),J.setAttribute("role","button"),J.setAttribute("tabindex","0"),J.setAttribute("aria-label",Q.id==="root"?_("Add page"):_("Add subpage")),J.setAttribute("title",Q.id==="root"?_("Add page"):_("Add subpage")),J.setAttribute("data-testid","nav-node-add"),J.setAttribute("data-node-id",Q.id),J.style.cursor="pointer";let W=document.createElement("i");W.classList.add("small-icon","add-icon-green");let z=document.createElement("span");if(z.classList.add("visually-hidden"),z.textContent=Q.id==="root"?_("Add page"):_("Add subpage"),J.append(W),J.append(z),Z.append(J),Q.id!=="root"){let H=document.createElement("i");H.classList.add("small-icon","settings-icon-green");let K=document.createElement("span");K.classList.add("visually-hidden"),K.textContent=_("Page properties");let V=document.createElement("button");V.classList.add("btn","button-tertiary","button-narrow","d-flex","justify-content-center","align-items-center","node-menu-button","page-settings"),V.setAttribute("data-menunavid",Q.id),V.setAttribute("title",_("Page properties")),V.setAttribute("aria-label",_("Page properties")),V.style.cursor="pointer",V.append(H),V.append(K),Z.append(V)}let G=document.createElement("span");G.classList.add("drag-over-border"),Z.append(G);let q=document.createElement("div");return q.classList.add("node-presence-avatars"),q.dataset.pageId=Q.pageId||Q.id,q.style.display="none",Z.append(q),Z}setPropertiesClassesToElement(Q,Z){if(Z.properties.visibility.value!="")Q.setAttribute("export-view",Z.properties.visibility.value)}recalculateLevelsFromDomTree(){let Q=(Y,X)=>{Y.classList.add(`level${X}`);let J=Y.querySelector(".nav-element-children-container");if(J){let W=[...J.children].filter((z)=>z.classList.contains("nav-element"));for(let z of W)Q(z,X+1)}},Z=[...this.menuNavList.children].filter((Y)=>Y.classList.contains("nav-element"));for(let Y of Z)Q(Y,0)}buildTreeRecursive(Q,Z,Y){if(!this.levelItemCounters[Y])this.levelItemCounters[Y]=1;let X=this.levelItemCounters[Y],J=this.onlyChildMap[Q.id]===!0;this.makeNodeStructureContentNode(Z,Q,Y,X,J),this.levelItemCounters[Y]++;let W=Z.querySelector(`.nav-element[nav-id="${Q.id}"]`),z=W.querySelector(".nav-element-children-container");for(let[G,q]of Object.entries(this.data))if(q.parent===Q.id)W.setAttribute("is-parent",!0),W.setAttribute("aria-expanded",W.classList.contains("toggle-on")?"true":"false"),this.buildTreeRecursive(q,z,Y+1)}getNodeLevel(Q){let Z=0;while(Q.parent&&this.data[Q.parent])Q=this.data[Q.parent],Z++;return Z}initAccesibility(){let Q=document.getElementById("nav_list");if(!Q)return;Q.setAttribute("role","tree"),Q.setAttribute("aria-label",_("Table of contents")),Q.querySelectorAll(".nav-element-children-container").forEach((q)=>{q.setAttribute("role","group")});let Z=Array.from(Q.querySelectorAll(".nav-element"));Z.forEach((q)=>{if(q.setAttribute("role","treeitem"),q.setAttribute("tabindex","0"),q.getAttribute("is-parent")==="true")q.setAttribute("aria-expanded",q.classList.contains("toggle-on")?"true":"false");q.setAttribute("aria-selected",q.classList.contains("selected")?"true":"false"),q.querySelectorAll(".nav-element-toggle, .page-icon, .root-icon, .drag-over-border").forEach((K)=>K.setAttribute("aria-hidden","true"))});let Y=Q.querySelector(".nav-element.selected")||Z[0];if(Y)Y.setAttribute("tabindex","0");Q.addEventListener("keydown",X),Q.querySelectorAll(".page-settings").forEach((q)=>{q.setAttribute("role","button"),q.setAttribute("tabindex","0"),q.setAttribute("aria-label",_("Page options")),q.addEventListener("keydown",(H)=>{if(H.key==="Enter"||H.key===" ")H.preventDefault(),q.click()})});function X(q){let H=document.activeElement.closest('.nav-element[role="treeitem"]');if(!H)return;let K=z(),V=K.indexOf(H);switch(q.key){case"ArrowDown":if(q.preventDefault(),V<K.length-1)J(K[V+1]);break;case"ArrowUp":if(q.preventDefault(),V>0)J(K[V-1]);break;case"ArrowRight":{q.preventDefault();let O=H.getAttribute("is-parent")==="true",A=H.classList.contains("toggle-on");if(O&&!A)W(H,!0);else{let M=H.querySelector(':scope > .nav-element-children-container .nav-element[role="treeitem"]');if(M&&G(M))J(M)}break}case"ArrowLeft":{q.preventDefault();let O=H.getAttribute("is-parent")==="true",A=H.classList.contains("toggle-on");if(O&&A)W(H,!1);else{let M=H.closest(".nav-element-children-container")?.closest('.nav-element[role="treeitem"]');if(M)J(M)}break}case"Home":q.preventDefault(),J(K[0]);break;case"End":q.preventDefault(),J(K[K.length-1]);break;case"Enter":case" ":q.preventDefault(),(H.querySelector(":scope > .nav-element-text")||H).click();break}}function J(q){let H=Q.querySelector('.nav-element[role="treeitem"][tabindex="0"]');if(H&&H!==q)H.setAttribute("tabindex","0");q.setAttribute("tabindex","0"),q.focus({preventScroll:!0}),Q.querySelectorAll('.nav-element[role="treeitem"][aria-selected="true"]').forEach((K)=>{if(K!==q)K.setAttribute("aria-selected","false")}),q.setAttribute("aria-selected","true")}function W(q,H){let K=q.classList.contains("toggle-on");if(H&&K||!H&&!K)return;let V=q.querySelector(":scope > .nav-element-toggle");if(V)V.click();q.setAttribute("aria-expanded",H?"true":"false")}function z(){return Array.from(Q.querySelectorAll('.nav-element[role="treeitem"]')).filter(G)}function G(q){return!!(q.offsetParent||q.getClientRects().length)}}}var d=window.AppLogger||console;class N1{constructor(Q){this.structureEngine=Q,this.menuNav=document.querySelector("#main #menu_nav"),this.menuNavList=this.menuNav.querySelector("#main #nav_list"),this.nodeSelected=null,this.nodeDrag=null,this.enterDragMenuStructureCount=0,this.dbclickNode=!1,this.structureEngine.menuStructureBehaviour=this}behaviour(Q){if(Q)this.addEventNavNewNodeOnclick(),this.addEventNavPropertiesNodeOnclick(),this.addEventNavRemoveNodeOnclick(),this.addEventNavCloneNodeOnclick(),this.addEventNavImportIdevicesOnclick(),this.addEventNavMovPrevOnClick(),this.addEventNavMovNextOnClick(),this.addEventNavMovUpOnClick(),this.addEventNavMovDownOnClick();this.addNavTestIds(),this.addEventNavElementOnclick(),this.addEventNavElementOnDbclick(),this.addEventNavElementIconOnclick(),this.addEventNavElementOnMenuIconClic(),this.addEventNavElementOnAddIconClick(),this.addDragAndDropFunctionalityToNavElements()}addNavTestIds(){this.menuNav.querySelectorAll(".nav-element[nav-id]").forEach((Z)=>{let Y=Z.getAttribute("nav-id");Z.setAttribute("data-testid","nav-node"),Z.setAttribute("data-node-id",Y);let X=Z.querySelector(".nav-element-text");if(X)X.setAttribute("data-testid","nav-node-text"),X.setAttribute("data-node-id",Y);let J=Z.querySelector(".node-menu-button");if(J)J.setAttribute("data-testid","nav-node-menu"),J.setAttribute("data-node-id",Y);let W=Z.querySelector(".exe-icon");if(W)W.setAttribute("data-testid","nav-node-toggle"),W.setAttribute("data-node-id",Y)})}addEventNavElementOnclick(){var Q=this.menuNav.querySelectorAll(".nav-element > .nav-element-text");Q.forEach((Z)=>{Z.addEventListener("click",(Y)=>{if(Y.stopPropagation(),eXeLearning.app.project.checkOpenIdevice())return;this.selectNode(Z.parentElement).then((X)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(X&&this.dbclickNode)this.showModalPropertiesNode(),this.dbclickNode=!1})})})}addEventNavElementOnDbclick(){var Q=this.menuNav.querySelectorAll('.nav-element:not([nav-id="root"]) > .nav-element-text');Q.forEach((Z)=>{Z.addEventListener("dblclick",(Y)=>{if(eXeLearning.app.project.checkOpenIdevice())return;Y.stopPropagation(),this.dbclickNode=!0})})}addEventNavElementOnMenuIconClic(){var Q=this.menuNav.querySelectorAll('.nav-element:not([nav-id="root"]) > .nav-element-text .node-menu-button');Q.forEach((Z)=>{Z.addEventListener("click",(Y)=>{Y.stopPropagation(),this.structureEngine.getNode(Z.getAttribute("data-menunavid")).showModalProperties(),this.mutationForModalProperties()})})}addEventNavElementOnAddIconClick(){var Q=this.menuNav.querySelectorAll(".nav-element > .nav-element-text .node-add-button");Q.forEach((Z)=>{Z.addEventListener("click",(Y)=>{if(Y.stopPropagation(),eXeLearning.app.project.checkOpenIdevice())return;let X=Z.getAttribute("data-parentnavid");if(X==="root")X=null;this.showModalNewNode(X)})})}addEventNavElementIconOnclick(){var Q=this.menuNav.querySelectorAll(".nav-element > .exe-icon");Q.forEach((Z)=>{Z.addEventListener("click",(Y)=>{if(eXeLearning.app.project.checkOpenIdevice())return;Y.stopPropagation();let X=Z.parentElement,J=this.structureEngine.getNode(X.getAttribute("nav-id"));if(X.classList.contains("toggle-on")){if(X.classList.remove("toggle-on"),X.classList.add("toggle-off"),Z.innerHTML="keyboard_arrow_right",J.open=!1,X.setAttribute("data-expanded","false"),X.getAttribute("is-parent")==="true")X.setAttribute("aria-expanded","false")}else if(X.classList.remove("toggle-off"),X.classList.add("toggle-on"),Z.innerHTML="keyboard_arrow_down",J.open=!0,X.setAttribute("data-expanded","true"),X.getAttribute("is-parent")==="true")X.setAttribute("aria-expanded","true")})})}addEventNavNewNodeOnclick(){this.menuNav.querySelector(".button_nav_action.action_add").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;this.showModalNewNode(null)})}addEventNavPropertiesNodeOnclick(){this.menuNav.querySelector(".button_nav_action.action_properties").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)this.showModalPropertiesNode()})}addEventNavRemoveNodeOnclick(){this.menuNav.querySelector(".button_nav_action.action_delete").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)this.showModalRemoveNode()})}addEventNavCloneNodeOnclick(){this.menuNav.querySelector(".button_nav_action.action_clone").addEventListener("click",async(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)await this.structureEngine.cloneNodeAndReload(this.nodeSelected.getAttribute("nav-id")),this.showModalRenameNode()})}createIdevicesUploadInput(){let Q=document.createElement("input");Q.classList.add("local-ode-file-upload-input","d-none"),Q.setAttribute("type","file"),Q.setAttribute("name","local-ode-file-upload"),Q.setAttribute("accept",".elpx,.block,.idevice,.elp,.zip"),Q.id="local-ode-file-upload";let Z=document.createElement("label");return Z.setAttribute("for",Q.id),Z.classList.add("visually-hidden"),Z.textContent=_("Upload iDevice file"),Q.addEventListener("change",async(Y)=>{let J=document.querySelector(".local-ode-file-upload-input").files[0],W=this.createIdevicesUploadInput();if(Q.remove(),this.menuNav.append(W),!J)return;let z=J.name.toLowerCase();if(z.endsWith(".elpx")||z.endsWith(".elp")||z.endsWith(".zip")){let q=this.nodeSelected&&this.nodeSelected.getAttribute("nav-id"),H=!q||q==="root"?null:q;d.log("[MenuStructure] Importing via Yjs, parentId:",H);let K=new t;K.show();try{let V=window.YjsModules?.getBridge();if(!V||!V.documentManager||!V.initialized)throw Error(_("Please wait for the project to fully load before importing."));let R=await V.importFromElpx(J,{clearExisting:!1,parentId:H,onProgress:(O)=>K.update(O)});if(d.log("[MenuStructure] Import complete:",R),K.hide(),this.structureEngine&&typeof this.structureEngine.resetDataAndStructureData==="function")this.structureEngine.resetDataAndStructureData(H||!1);else eXeLearning.app.project.openLoad()}catch(V){console.error("[MenuStructure] Import error:",V),K.hide(),eXeLearning.app.modals.alert.show({title:_("Error"),body:V?.message||_("Unexpected error importing file.")})}return}eXeLearning.app.modals.openuserodefiles.largeFilesUpload(J,!0)}),this.menuNav.append(Z),this.menuNav.append(Q),Q}addEventNavImportIdevicesOnclick(){this.createIdevicesUploadInput(),this.menuNav.querySelector(".button_nav_action.action_import_idevices").addEventListener("click",async(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)this.menuNav.querySelector("input.local-ode-file-upload-input").click()})}async getOdePageBrokenLinksEvent(Q){return await eXeLearning.app.api.getOdePageBrokenLinks(Q)}addEventNavCheckOdePageBrokenLinksOnclick(){this.menuNav.querySelector(".button_nav_action.action_check_broken_links").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected){let Y=this.menuNav.querySelector("#main .toggle-on .selected").getAttribute("page-id");this.getOdePageBrokenLinksEvent(Y).then((X)=>{if(!X.responseMessage)eXeLearning.app.modals.odebrokenlinks.show(X);else eXeLearning.app.modals.alert.show({title:_("Broken links"),body:_("No broken links found.")})})}})}addEventNavMovPrevOnClick(){this.menuNav.querySelector(".button_nav_action.action_move_prev").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)this.structureEngine.moveNodePrev(this.nodeSelected.getAttribute("nav-id"))})}addEventNavMovNextOnClick(){this.menuNav.querySelector(".button_nav_action.action_move_next").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)this.structureEngine.moveNodeNext(this.nodeSelected.getAttribute("nav-id"))})}addEventNavMovUpOnClick(){this.menuNav.querySelector(".button_nav_action.action_move_up").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)this.structureEngine.moveNodeUp(this.nodeSelected.getAttribute("nav-id"))})}addEventNavMovDownOnClick(){this.menuNav.querySelector(".button_nav_action.action_move_down").addEventListener("click",(Q)=>{if(eXeLearning.app.project.checkOpenIdevice())return;if(this.nodeSelected)this.structureEngine.moveNodeDown(this.nodeSelected.getAttribute("nav-id"))})}showModalNewNode(Q){let Z=Q!==void 0?Q:this.nodeSelected?this.nodeSelected.getAttribute("nav-id"):null,J=`<p>${_("Name")}:</p><p>${`<input id="input-new-node" class="exe-input" type='text' value='' >`}</p>`,W=eXeLearning.app.modals.confirm;W.show({title:_("New page"),contentId:"new-node-modal",body:J,confirmButtonText:_("Save"),cancelButtonText:_("Cancel"),focusFirstInputText:!0,confirmExec:()=>{let z=W.modalElement.querySelector("#input-new-node").value;if(!z||!z.replaceAll(" ",""))z=_("New page");this.structureEngine.createNodeAndReload(Z,z)},behaviour:()=>{let z=W.modalElementBody.querySelector("input");this.addBehaviourToInputTextModal(z,()=>{W.confirm()})}})}showModalRenameNode(){let Q=this.structureEngine.getNode(this.nodeSelected.getAttribute("nav-id")),Z=_("New name"),Y=`<input id="input-rename-node" class="exe-input" type='text' value='${Q.pageName}' >`,X=`<p>${Z}:</p><p>${Y}</p>`,J=eXeLearning.app.modals.confirm;J.show({title:_("Rename page"),contentId:"rename-node-modal",body:X,confirmButtonText:_("Save"),cancelButtonText:_("Cancel"),confirmExec:()=>{let W=eXeLearning.app.modals.confirm.modalElement.querySelector("#input-rename-node").value;this.structureEngine.renameNodeAndReload(Q.id,W)},behaviour:()=>{let W=J.modalElementBody.querySelector("input");this.addBehaviourToInputTextModal(W,()=>{J.confirm()})}})}showModalPropertiesNode(){this.structureEngine.getNode(this.nodeSelected.getAttribute("nav-id")).showModalProperties(),this.mutationForModalProperties()}mutationForModalProperties(){new MutationObserver((Z,Y)=>{let X=document.querySelector('.property-value[property="editableInPage"]'),J=document.querySelector('.property-value[property="titlePage"]'),W=document.querySelector('.property-value[property="titleNode"]'),z=document.querySelector("#titlePage");if(X&&J&&W&&z){let G=()=>{let q=X.checked;if(J.disabled=!q,!q)J.value=W.value||"",z.style.display="none";else z.style.display="block"};G(),X.addEventListener("change",G),W.addEventListener("input",G),Y.disconnect()}}).observe(document.body,{childList:!0,subtree:!0})}showModalRemoveNode(){let Q=this.nodeSelected.getAttribute("nav-id"),Z=this.nodeSelected.getAttribute("page-id")||Q,Y=this.nodeSelected.querySelector(".node-text-span")?.textContent||_("this page"),X=this._getAffectedUsersForDeletion(Z),J=this._nodeHasDescendants(Q),W="",z=_("Delete page");if(X.length>0){let G=X.map((q)=>q.name||_("Unknown user")).join(", ");W=`<p><strong>${_("Warning")}:</strong> ${X.length===1?_("Another user is viewing this page or its children"):_("Other users are viewing this page or its children")}:</p>
                <p class="text-primary fw-bold">${G}</p>
                <p>${_("They will be automatically redirected to the parent page.")}</p>
                <p>${_("Do you want to delete")} "<strong>${Y}</strong>"${J?" "+_("and all its children"):""}?</p>`}else if(J)W=`<p>${_("Do you want to delete")} "<strong>${Y}</strong>" ${_("and all its children")}?</p>
                <p class="text-muted small">${_("You can undo this action.")}</p>`;else W=`<p>${_("Do you want to delete")} "<strong>${Y}</strong>"?</p>
                <p class="text-muted small">${_("You can undo this action.")}</p>`;eXeLearning.app.modals.confirm.show({title:z,contentId:"delete-node-modal",body:W,confirmButtonText:_("Delete"),cancelButtonText:_("Cancel"),focusCancelButton:X.length>0,confirmExec:()=>{this.structureEngine.removeNodeCompleteAndReload(Q)}})}_getAffectedUsersForDeletion(Q){try{let Z=eXeLearning?.app?.project;if(!Z?._yjsEnabled||!Z?._yjsBridge)return[];let Y=Z._yjsBridge.getDocumentManager();if(!Y)return[];let X=this.structureEngine.data||{};return Y.getOtherUsersOnPageAndDescendants(Q,X).allAffectedUsers||[]}catch(Z){return console.warn("[MenuStructureBehaviour] Failed to get affected users:",Z),[]}}_nodeHasDescendants(Q){let Z=this.structureEngine.data||{};for(let[Y,X]of Object.entries(Z))if(X.parent===Q)return!0;return!1}showModalCloneNode(){eXeLearning.app.modals.confirm.show({title:_("Clone page"),contentId:"clone-node-modal",body:_("Do you want to clone the page?"),confirmButtonText:_("Yes"),confirmExec:()=>{this.structureEngine.cloneNodeAndReload(this.nodeSelected.getAttribute("nav-id"))}})}addDragAndDropFunctionalityToNavElements(){var Q=this.menuNav.querySelectorAll('.nav-element:not([nav-id="root"]) > .nav-element-text');Q.forEach((Z)=>{this.addDragAndDropFunctionalityToNode(Z)})}addDragAndDropFunctionalityToNode(Q){this.addEventDragOver(Q),this.addEventDragStart(Q),this.addEventDragEnd(Q)}addEventDragOver(Q){Q.addEventListener("dragover",(Z)=>{if(Z.stopPropagation(),this.clearMenuNavDragOverClasses(),this.nodeDrag){if(Z.preventDefault(),this.nodeDrag!=Q.parentElement)Q.classList.add("drag-over")}else if(eXeLearning.app.project.idevices.draggedElement){let Y=eXeLearning.app.project.idevices.draggedElement;if(Y&&Y.classList.contains("idevice_actions"))Z.preventDefault(),Q.classList.add("drag-over"),Q.classList.add("idevice-content-over");else if(Y&&Y.classList.contains("box-head"))Z.preventDefault(),Q.classList.add("drag-over"),Q.classList.add("block-content-over")}})}addEventDragStart(Q){Q.addEventListener("dragstart",async(Z)=>{if(eXeLearning.app.project.checkOpenIdevice()){Z.preventDefault();return}Z.stopPropagation(),Q.classList.add("dragging");let Y=Q.parentElement;this.nodeDrag=Y,await this.selectNode(Y)})}addEventDragEnd(Q){Q.addEventListener("dragend",(Z)=>{if(Z.stopPropagation(),this.nodeDrag){let Y=this.menuNav.querySelector(".nav-element > .nav-element-text.drag-over");if(Y){let X=Y.parentElement.getAttribute("nav-id"),J=this.nodeDrag.getAttribute("nav-id");this.structureEngine.moveNodeToNode(J,X)}this.clearMenuNavDragOverClasses(),Q.classList.remove("dragging"),this.nodeDrag=null}})}addTooltips(){$("#nav_list .nav-element-text",this.menuNav).eq(0).attr("title",_("Content properties")).addClass("exe-app-tooltip"),$("button.button_nav_action",this.menuNav).addClass("exe-app-tooltip"),eXeLearning.app.common.initTooltips(this.menuNav)}deselectNodes(){this.menuNav.querySelectorAll(".nav-element").forEach((Z)=>{Z.classList.remove("selected")})}async selectFirst(){let Q=this.menuNav.querySelectorAll(".nav-element");if(Q.length>=1&&Q[0])return await this.selectNode(Q[0]);return console.warn("[MenuStructureBehaviour] No nav elements found to select"),null}async selectNode(Q){if(!Q)return console.warn("[MenuStructureBehaviour] selectNode called with null element"),Promise.resolve(null);return eXeLearning.app.project.unlockIdevices(),new Promise(async(Z,Y)=>{let X=!1,J=50;if(this.nodeSelected&&Q.getAttribute("nav-id")==this.nodeSelected.getAttribute("nav-id"))this.setNodeSelected(Q),X=Q;else{let W=await eXeLearning.app.project.idevices.loadApiIdevicesInPage(!0,Q),z=Q.getAttribute("nav-id");if(z&&eXeLearning.app.project.bridge)eXeLearning.app.project.bridge.onPageNavigation(z);d.log("[MenuStructureBehaviour] About to setNodeSelected, element nav-id:",Q?.getAttribute("nav-id")),this.deselectNodes(),this.setNodeSelected(Q),d.log("[MenuStructureBehaviour] setNodeSelected completed, nodeSelected:",this.nodeSelected?.getAttribute("nav-id")),X=Q;let G=document.getElementById("node-content-container");if(G)G.scrollTo({top:0,behavior:"instant"});if(W)J=100;if(Q?.getAttribute("page-id")==="root")this.hideIdevicesBotton();else this.showIdevicesBotton();this.checkIfEmptyNode()}setTimeout(()=>{if(this.addTooltips(),typeof $exe<"u"&&$exe.mermaid&&$exe.mermaid.initialized)$exe.mermaid.renderDiagrams();Z(X)},J)})}hideIdevicesBotton(){document.getElementById("node-content-container").classList.add("properties-page"),document.getElementById("idevices-bottom").style.display="none"}showIdevicesBotton(){document.getElementById("node-content-container").classList.remove("properties-page"),document.getElementById("idevices-bottom").style.display="inline-flex"}checkIfEmptyNode(){this.nodeContent=document.getElementById("node-content");let Q=this.nodeContent.querySelectorAll("article:not(#empty_articles), #properties-node-content-form"),Z=this.nodeContent.querySelector("#empty_articles");if(Q.length===0){if(!Z){let Y=document.createElement("article");Y.id="empty_articles",Y.classList.add("empty-node-message"),Y.classList.add("box");let X=document.createElement("div");X.classList.add("empty-block-message-box");let J=document.createElement("div");J.classList.add("empty-block-message-icon"),J.innerHTML=`<svg width="46" height="42" viewBox="0 0 46 42" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.89385 27.3114C8.85228 28.4826 7.59713 30.1241 7.44197 31.7537C7.18594 34.4428 10.5275 36.5047 10.5275 36.5047C10.5275 36.5047 15.0356 39.3023 18.2758 40.084C21.7996 40.934 27.5554 40.2998 27.5554 40.2998C36.6375 40.2998 44 32.9372 44 23.8551C44 18.308 40.426 12.553 37.339 10.4815L26.0974 2.04022C24.446 0.800213 22.102 1.13373 20.862 2.78515C20.1718 3.70441 19.9691 4.83827 20.2099 5.87685C20.4016 6.70367 20.8669 7.49457 21.5985 8.04429M7.71786 16.3253C6.06645 15.0853 3.72249 15.4188 2.48248 17.0702C1.79223 17.9895 1.58955 19.1233 1.83035 20.1619C2.02214 20.9891 2.49525 21.7558 3.22741 22.3056L14.469 30.7468M12.1623 10.309L10.0412 8.71632C8.3898 7.47632 6.04584 7.80983 4.80583 9.46125C4.11558 10.3805 3.9129 11.5144 4.15371 12.553C4.3455 13.3801 4.81861 14.1469 5.55076 14.6966L16.7924 23.1379M12.1623 10.309C12.1897 10.3308 12.2175 10.3523 12.2456 10.3734M12.1623 10.309C11.4775 9.76457 11.033 9.02509 10.8486 8.22974C10.6078 7.19115 10.8104 6.0573 11.5007 5.13803C12.7407 3.48661 15.0847 3.1531 16.7361 4.3931L21.5985 8.04429M12.1623 10.309L19.0194 15.458M21.5985 8.04429L24.7881 10.4393" stroke="#474747" stroke-width="2.33219" stroke-linecap="round"/>
</svg>`;let W=document.createElement("h2");W.classList.add("empty-block-message-title"),W.textContent=_("Drag an iDevice in and start building");let z=document.createElement("p");z.classList.add("empty-block-message-text"),z.innerHTML=_("Just drag an iDevice onto this page to start designing your content."),X.appendChild(J),X.appendChild(W),X.appendChild(z);let G=document.createElement("div");G.classList.add("empty-block-arrow-icon"),G.innerHTML=`<svg width="84" height="129" viewBox="0 0 84 129" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M0.531071 16.7299C0.0906242 18.1471 0.343717 18.6096 0.281161 18.7143C0.281161 18.7143 15.5 -2.80225 37.151 10.6978C58.8021 24.1978 54.151 51.8564 54.151 51.8564C54.151 51.8564 44.5 49.324 37.151 51.8564C13.2532 60.0916 19.625 84.949 38.776 81.5469C48.7026 79.7835 54.151 74.074 58.3749 59.5738C58.3749 59.5738 70.1473 67.5449 72.875 82.324C75.3863 95.9307 63.4011 121.266 63.4011 121.266L65.6511 122.381C65.6511 122.381 80.5651 94.863 77.0261 78.1986C74 63.949 59.401 54.3684 59.401 54.3684C63.4011 26.1978 49.009 -0.554479 25.0625 0.324034C8.02323 0.949144 1.535 13.4995 0.531071 16.7299ZM53.3749 56.6989C53.3749 56.6989 51.75 77.199 35.401 75.9686C19.0521 74.7382 33.7499 50.0739 53.3749 56.6989Z" fill="#333333"/>
<path d="M59.8282 121.433L61.1831 106.61C61.255 105.824 62.154 105.444 62.7235 105.991C63.1168 106.368 63.5256 106.798 63.8472 107.223C65.5756 109.507 65.6905 112.348 66.8159 114.885C66.8159 114.885 70.9813 112.254 75.6249 108.199C80.1036 104.288 82.9927 102.946 83.1923 102.856C83.2003 102.852 83.207 102.848 83.2143 102.843C83.6213 102.567 84.1018 103.063 83.8095 103.458C82.3025 105.496 79.7961 108.868 76.9256 112.658C75.7708 114.183 65.6777 130.254 60.9667 128.225C59.2269 127.475 59.8282 121.433 59.8282 121.433Z" fill="#333333"/>
<path d="M70.7033 111.919C70.6039 111.815 71.0924 110.561 71.0924 110.561L69.0834 115.037L72.3437 110.918C72.3437 110.918 70.8026 112.024 70.7033 111.919Z" fill="#333333"/>
<path d="M66.4858 113.823C66.6295 113.813 67.1081 112.555 67.1081 112.555L65.5966 117.223L66.0218 112.687C66.0218 112.687 66.3422 113.834 66.4858 113.823Z" fill="#333333"/>
</svg>`,Y.appendChild(X),Y.appendChild(G),this.nodeContent.appendChild(Y),this.initSimulatedOver(Y)}}else if(Z)Z.remove()}initSimulatedOver(Q){let Z={dragging:!1,html5:!1,raf:!1},Y=(z,G)=>{let q=Q.getBoundingClientRect(),H=z>=q.left&&z<=q.right&&G>=q.top&&G<=q.bottom;Q.classList.toggle("is-over",H)},X=(z,G)=>{if(Z.raf)return;Z.raf=!0,requestAnimationFrame(()=>{Z.raf=!1,Y(z,G)})};document.addEventListener("dragstart",()=>{Z.dragging=!0,Z.html5=!0},!0),document.addEventListener("dragend",()=>{Z.dragging=!1,Q.classList.remove("is-over")},!0),document.addEventListener("dragover",(z)=>{if(!Z.dragging||!Z.html5)return;z.preventDefault(),X(z.clientX,z.clientY)},{passive:!1,capture:!0});let J=['[draggable="true"]',".draggable","[drag]","[data-drag]",".idevice-element-in-content"];document.addEventListener("pointerdown",(z)=>{if(z.button!==0)return;if(z.target.closest(J.join(",")))Z.dragging=!0,Z.html5=!1},!0);let W=()=>{if(!Z.dragging||Z.html5)return;Z.dragging=!1,Q.classList.remove("is-over")};document.addEventListener("pointermove",(z)=>{if(!Z.dragging||Z.html5)return;X(z.clientX,z.clientY)},!0),document.addEventListener("pointerup",W,!0),document.addEventListener("pointercancel",W,!0)}setNodeSelected(Q){d.log("[MenuStructureBehaviour] setNodeSelected START, element:",Q?.getAttribute("nav-id")),this.nodeSelected=Q,this.nodeSelected?.classList.add("selected"),d.log("[MenuStructureBehaviour] Added selected class, classList:",this.nodeSelected?.classList.toString()),this.structureEngine.nodeSelected=this.nodeSelected,this.setNodeIdToNodeContentElement(),this.createAddTextBtn(),this.enabledActionButtons();let Z=this.menuNav.querySelectorAll(".nav-element[nav-id]"),Y=this.nodeSelected?.getAttribute("nav-id");d.log("[MenuStructureBehaviour] Found",Z.length,"nodes to update data-selected, selNavId:",Y),Z.forEach((X)=>{let J=X.getAttribute("nav-id")===Y;if(X.setAttribute("data-selected",J?"true":"false"),X.setAttribute("aria-selected",J?"true":"false"),J)X.classList.add("selected");else X.classList.remove("selected")}),d.log("[MenuStructureBehaviour] setNodeSelected END, nodeSelected data-selected:",this.nodeSelected?.getAttribute("data-selected")),this._updateAwarenessSelectedPage()}_updateAwarenessSelectedPage(){try{let Q=eXeLearning?.app?.project;if(!Q?._yjsEnabled||!Q?._yjsBridge)return;let Z=Q._yjsBridge.getDocumentManager();if(!Z)return;let Y=null;if(this.nodeSelected)Y=this.nodeSelected.getAttribute("page-id")||this.nodeSelected.getAttribute("nav-id");Z.setSelectedPage(Y)}catch(Q){console.warn("[MenuStructureBehaviour] Failed to update awareness:",Q)}}setNodeIdToNodeContentElement(){let Q=document.querySelector("#node-content");if(!Q)return;if(Q.removeAttribute("node-selected"),this.nodeSelected){let Z=this.structureEngine.getNode(this.nodeSelected.getAttribute("nav-id"));if(!Z||typeof Z.pageId>"u")return;Q.setAttribute("node-selected",Z.pageId)}}createAddTextBtn(){if($("body > .tooltip").hide(),$("#eXeAddContentBtnWrapper").remove(),$("#properties-node-content-form").is(":visible"))return;let Q=_("Add Text"),Z=$("#list_menu_idevices #text .idevice_icon").css("background-image");var Y=`
            <div class="text-center" id="eXeAddContentBtnWrapper">
                <button data-testid="add-text-quick">${Q}</button>
            </div>
        `;$("#node-content").append(Y),$("#eXeAddContentBtnWrapper button").off("click").on("click",function(X){if($("#properties-node-content-form").is(":visible"))return;$("#list_menu_idevices #text").trigger("click"),$("#eXeAddContentBtnWrapper").remove()}).css("background-image",Z)}enabledActionButtons(){if(this.disableActionButtons(),!this.nodeSelected)return;let Q=this.nodeSelected.getAttribute("nav-id"),Z=this.structureEngine.getNode(Q);if(!Z)return;if(this.menuNav.querySelector(".button_nav_action.action_add").disabled=!1,Z.id==="root")return;this.menuNav.querySelector(".button_nav_action.action_properties").disabled=!1,this.menuNav.querySelector(".button_nav_action.action_delete").disabled=!1,this.menuNav.querySelector(".button_nav_action.action_clone").disabled=!1,this.menuNav.querySelector(".button_nav_action.action_import_idevices").disabled=!1;let Y=eXeLearning.app.project?._yjsBridge?.structureBinding;if(Y)this.menuNav.querySelector(".button_nav_action.action_move_prev").disabled=!Y.canMoveUp(Q),this.menuNav.querySelector(".button_nav_action.action_move_next").disabled=!Y.canMoveDown(Q),this.menuNav.querySelector(".button_nav_action.action_move_up").disabled=!Y.canMoveLeft(Q),this.menuNav.querySelector(".button_nav_action.action_move_down").disabled=!Y.canMoveRight(Q);else this.menuNav.querySelector(".button_nav_action.action_move_prev").disabled=!1,this.menuNav.querySelector(".button_nav_action.action_move_next").disabled=!1,this.menuNav.querySelector(".button_nav_action.action_move_up").disabled=!1,this.menuNav.querySelector(".button_nav_action.action_move_down").disabled=!1}disableActionButtons(){this.menuNav.querySelectorAll("#nav_actions .button_nav_action").forEach((Q)=>{Q.disabled=!0}),this.menuNav.querySelectorAll(".buttons_action_container_right .button_nav_action").forEach((Q)=>{Q.disabled=!0})}clearMenuNavDragOverClasses(){this.menuNav.querySelectorAll(".nav-element > .nav-element-text").forEach((Q)=>{Q.classList.remove("drag-over"),Q.classList.remove("idevice-content-over"),Q.classList.remove("block-content-over")})}addBehaviourToInputTextModal(Q,Z){setTimeout(()=>{this.focusTextInput(Q)},500)}focusTextInput(Q){Q.focus();let Z=Q.value;Q.value="",Q.value=Z}}class C1{constructor(Q){this.engine=Q,this.menuStructure=document.querySelector("#main #menu_nav")}async load(){this.compose(),this.behaviour()}compose(){this.menuStructureCompose=new E1(this.engine),this.menuStructureCompose.compose()}behaviour(){this.menuStructureBehaviour=new N1(this.engine),this.menuStructureBehaviour.behaviour(!0)}}class f1{constructor(Q,Z){this.parent=Q,this.idevicesList=Z,this.idevicesInstalled=this.idevicesList.installed,this.menuIdevices=document.querySelector("#menu_idevices #list_menu_idevices"),this.readers=[]}categoryKeys={information:"Information and presentation",evaluation:"Assessment and tracking",games:"Games",interactive:"Interactive activities",science:"Science",imported:"Imported"};categoriesOrder=["information","evaluation","games","interactive","science"];getCategoryTitle(Q){return _(this.categoryKeys[Q]||Q)}compose(){this.categoriesExtra=[],this.categoriesIdevices={},this.categoryKeyToIcon={},this.menuIdevices.innerHTML="",this.englishToKey={};for(let[Y,X]of Object.entries(this.categoryKeys))this.englishToKey[X]=Y,this.categoriesIdevices[X]=[],this.categoryKeyToIcon[X]=Y;this.addIdevicesToCategory(),this.categoriesOrder.map((Y)=>this.categoryKeys[Y]).concat(this.categoriesExtra).forEach((Y)=>{if(this.categoriesIdevices[Y]){let X=this.categoryKeyToIcon[Y]||Y.toLowerCase().replace(/[^a-z0-9]/g,"-");this.createDivCategoryIdevices(Y,this.categoriesIdevices[Y],X)}})}addIdevicesToCategory(){for(let[Q,Z]of Object.entries(this.idevicesInstalled)){let Y=Z.category;if(!this.categoriesIdevices[Y])this.categoriesIdevices[Y]=[],this.categoriesExtra.push(Y);this.categoriesIdevices[Y].push(Z)}}createDivCategoryIdevices(Q,Z,Y){if(Q===this.categoryKeys.information){let W=Z.findIndex((z)=>z.id==="text");if(W>-1){let[z]=Z.splice(W,1);Z.unshift(z)}}let X=_(Q),J=this.elementDivCategory(X);J.append(this.elementLabelCategory(X,Y)),J.append(this.elementDivIdevicesParent(Z,Y)),this.menuIdevices.append(J)}elementDivIdevicesParent(Q,Z){let Y=document.createElement("div");Y.classList.add("idevices","type_"+Z);let X=document.createElement("div");X.classList.add("idevices-category-title");let J=document.createElement("p");switch(J.classList.add("idevices-category-description"),Z){case"information":X.textContent=_("Information and presentation"),J.textContent=_("Tools to display information, organize resources or enrich content with accessibility and diverse media.");break;case"evaluation":X.textContent=_("Assessment and tracking"),J.textContent=_("Quizzes and other tools to check knowledge or progress, with the option to provide feedback.");break;case"games":X.textContent=_("Games"),J.textContent=_("Resources that use game mechanics to motivate and reinforce learning without evaluation pressure.");break;case"interactive":X.textContent=_("Interactive activities"),J.textContent=_("Exercises that require direct interaction, encouraging active learning and trial-and-error.");break;case"science":X.textContent=_("Sciencie"),J.textContent=_("Resources designed to work on specific subject areas or topics.");break;case"imported":X.textContent=_("Imported"),J.textContent=_("Select or drag to place the iDevice on the page.");break;default:break}if(Y.append(X),Y.append(J),Z!=="imported")Q.forEach((W)=>{if(W.id!="example")Y.append(this.elementDivIdevice(W))});if(Z==="imported"){let W=document.createElement("div");W.classList.add("useridevices-content"),Q.forEach((z)=>{W.append(this.elementDivIdeviceImported(z))}),Y.append(W),Y.append(this.createImportDeviceBox())}return Y}createImportDeviceBox(){let Q=document.createElement("button");Q.classList.add("idevice-import-upload","btn");let Z=document.createElement("div");Z.classList.add("upload-box-icon");let Y=document.createElement("span");Y.classList.add("medium-icon","upload-cloud-icon-green"),Z.appendChild(Y);let X=document.createElement("div");X.classList.add("upload-box-text");let J=document.createElement("p"),W=document.createElement("strong");W.textContent=_("Click to upload the file"),J.appendChild(W),X.appendChild(J),Q.appendChild(Z),Q.appendChild(X);let z=this.makeElementInputFileImportIdevice();return Q.appendChild(z),Q.addEventListener("click",()=>document.getElementById("idevice-file-import").click()),Q.addEventListener("dragover",(G)=>{G.preventDefault(),Q.classList.add("dragover")}),Q.addEventListener("dragleave",()=>{Q.classList.remove("dragover")}),Q.addEventListener("drop",(G)=>{G.preventDefault(),Q.classList.remove("dragover");let q=G.dataTransfer.files;Array.from(q).forEach((H)=>this.addNewReader(H))}),Q}makeElementInputFileImportIdevice(){let Q=document.createElement("input");Q.setAttribute("type","file"),Q.setAttribute("accept",".zip"),Q.id="idevice-file-import",Q.classList.add("hidden","idevice-file-import");let Z=document.createElement("label");Z.setAttribute("for",Q.id),Z.classList.add("visually-hidden"),Z.textContent=_("Import iDevice in ZIP format"),Q.addEventListener("change",(X)=>{Array.from(Q.files).forEach((J)=>{this.addNewReader(J)}),Q.value=null});let Y=document.createElement("div");return Y.append(Z),Y.append(Q),Y}addNewReader(Q){let Z=new FileReader;this.readers.push(Z),Z.onload=(Y)=>{this.uploadIdevice(Q.name,Y.target.result)},Z.readAsDataURL(Q)}uploadIdevice(Q,Z){let Y={};Y.filename=Q,Y.file=Z,eXeLearning.app.api.postUploadIdevice(Y).then((X)=>{if(X&&X.responseMessage==="OK")X.idevice.id=X.idevice.name,this.idevicesList.loadIdevice(X.idevice),this.categoriesIdevices[_("Imported")].push(X.idevice),this.rebuildImportedIdevices();else this.showElementAlert(_("Failed to install the new iDevice"),X)})}removeIdevice(Q){let Z={};Z.id=Q,eXeLearning.app.api.deleteIdeviceInstalled(Z).then((Y)=>{if(Y&&Y.responseMessage==="OK"&&Y.deleted&&Y.deleted.name){this.idevicesList.removeIdevice(Z.id),document.getElementById(Z.id).remove();let X=this.categoriesIdevices[_("Imported")].findIndex((J)=>J.id===Z.id);if(X!==-1)this.categoriesIdevices[_("Imported")].splice(X,1);this.rebuildImportedIdevices()}else setTimeout(()=>{this.showElementAlert(_("Could not remove the iDevice"),Y)})})}downloadIdeviceZip(Q){eXeLearning.app.api.getIdeviceInstalledZip(eXeLearning.app.project.odeSession,Q.dirName).then((Z)=>{if(Z&&Z.zipFileName&&Z.zipBase64){let Y=document.createElement("a");Y.setAttribute("type","hidden"),Y.href="data:text/plain;base64,"+Z.zipBase64,Y.download=Z.zipFileName,Y.click(),Y.remove()}})}rebuildImportedIdevices(){this.importedIdevicesContent=document.querySelector(".idevices.type_imported .useridevices-content"),this.importedIdevicesContent.innerHTML="",this.categoriesIdevices[_("Imported")].forEach((Q)=>{this.importedIdevicesContent.append(this.elementDivIdeviceImported(Q))}),eXeLearning.app.project.idevices.behaviour()}showElementAlert(Q,Z){let Y=Q,X=Z&&Z.error?Z.error:"",J=X?`<p>${Y}:</p><p>&nbsp;${X}</p>`:`<p>${Y}</p>`;eXe.app.alert(J)}elementDivCategory(Q){let Z=document.createElement("div");return Z.classList.add("idevice_category"),Z.classList.add("off"),Z}elementLabelCategory(Q,Z){let Y=document.createElement("div");Y.classList.add("label");let X=document.createElement("div");switch(X.classList.add("icon-content"),Z){case"information":X.innerHTML=`<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M7.65088 15.093H12.1509" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M3.90088 5.34302V3.09302H15.9009V5.34302" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M9.90088 3.09302V15.093" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;break;case"evaluation":X.innerHTML=`<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.90088 15.093H16.6509" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M13.2759 2.718C13.5742 2.41964 13.9789 2.25201 14.4009 2.25201C14.6098 2.25201 14.8167 2.29317 15.0097 2.37312C15.2028 2.45308 15.3781 2.57027 15.5259 2.718C15.6736 2.86574 15.7908 3.04113 15.8708 3.23416C15.9507 3.42719 15.9919 3.63407 15.9919 3.843C15.9919 4.05194 15.9507 4.25882 15.8708 4.45185C15.7908 4.64488 15.6736 4.82027 15.5259 4.968L6.15088 14.343L3.15088 15.093L3.90088 12.093L13.2759 2.718Z" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;break;case"games":X.innerHTML=`<svg width="21" height="14" viewBox="0 0 21 14" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6.69389 1.73877C5.07021 1.34554 3.45263 2.27094 3.08093 3.80571C3.08093 3.80571 2.69951 5.69429 2.31367 6.9738C1.92782 8.25331 1.1049 10.3585 1.1049 10.3585C0.826125 11.5096 1.58732 12.6818 2.80509 12.9767C4.49571 13.3861 7.11904 11.3417 8.1315 9.83111C8.25653 9.64456 8.42544 9.48764 8.6426 9.43041C8.95616 9.34779 9.4841 9.24706 10.1875 9.25002C10.8722 9.25291 11.4802 9.35589 11.8556 9.43735C12.1106 9.49268 12.3168 9.66484 12.4627 9.88115C13.4445 11.337 15.8186 13.3692 17.4393 12.9767C18.657 12.6818 19.4182 11.5096 19.1395 10.3585C19.1395 10.3585 18.3165 8.25331 17.9307 6.9738C17.5449 5.69429 17.1634 3.80571 17.1634 3.80571C16.7917 2.27094 15.1742 1.34554 13.5505 1.73877C13.5505 1.73877 11.5471 2.10422 10.1875 2.12502C8.75562 2.14694 6.69389 1.73877 6.69389 1.73877Z" stroke="#0BA0A0" stroke-width="1.7"/>
<rect x="13.2891" y="6.5813" width="1.1875" height="1.1875" rx="0.59375" fill="#0BA0A0"/>
<rect x="13.2891" y="4.2063" width="1.1875" height="1.1875" rx="0.59375" fill="#0BA0A0"/>
<path d="M6.16602 4.79159C6.16602 4.46834 6.42806 4.2063 6.7513 4.2063C7.07455 4.2063 7.33659 4.46834 7.33659 4.79159V7.13273C7.33659 7.45598 7.07455 7.71802 6.7513 7.71802C6.42806 7.71802 6.16602 7.45598 6.16602 7.13273V4.79159Z" fill="#0BA0A0"/>
<path d="M7.92204 5.37689C8.24528 5.37689 8.50732 5.63893 8.50732 5.96218C8.50732 6.28542 8.24528 6.54747 7.92204 6.54747L5.58089 6.54746C5.25765 6.54746 4.99561 6.28542 4.99561 5.96218C4.99561 5.63893 5.25765 5.37689 5.58089 5.37689L7.92204 5.37689Z" fill="#0BA0A0"/>
<rect x="13.2891" y="5.3938" width="1.1875" height="1.1875" rx="0.59375" transform="rotate(90 13.2891 5.3938)" fill="#0BA0A0"/>
<rect x="15.6641" y="5.3938" width="1.1875" height="1.1875" rx="0.59375" transform="rotate(90 15.6641 5.3938)" fill="#0BA0A0"/>
</svg>`;break;case"interactive":X.innerHTML=`<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M14.3679 9.84898L15.6531 10.7985M15.1023 6.90397L16.5795 6.68212M13.5353 4.30458L14.3592 3.18942M6.87914 4.31586L7.99087 5.13726M10.3684 2.09302L10.5902 3.57019M3.22217 11.0573L11.6026 6.92036L10.1098 16.1463L7.72384 12.17L3.22217 11.0573Z" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;break;case"science":X.innerHTML=`<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<g>
<path d="M15.9539 13.6504L11.712 6.37853V2.45205H12.5421C12.7623 2.45205 12.9734 2.36459 13.1291 2.20892C13.2848 2.05324 13.3722 1.84209 13.3722 1.62193C13.3722 1.40177 13.2848 1.19062 13.1291 1.03495C12.9734 0.879268 12.7623 0.791809 12.5421 0.791809H5.90114C5.68098 0.791809 5.46983 0.879268 5.31416 1.03495C5.15848 1.19062 5.07102 1.40177 5.07102 1.62193C5.07102 1.84209 5.15848 2.05324 5.31416 2.20892C5.46983 2.36459 5.68098 2.45205 5.90114 2.45205H6.73126V6.37853L2.48934 13.6504C2.26898 14.0287 2.15224 14.4584 2.15089 14.8962C2.14954 15.334 2.26363 15.7644 2.48166 16.1441C2.69969 16.5237 3.01394 16.8392 3.39276 17.0587C3.77157 17.2782 4.20155 17.3939 4.63936 17.3942H13.7707C14.2085 17.3939 14.6385 17.2782 15.0173 17.0587C15.3961 16.8392 15.7104 16.5237 15.9284 16.1441C16.1464 15.7644 16.2605 15.334 16.2592 14.8962C16.2578 14.4584 16.1411 14.0287 15.9207 13.6504H15.9539ZM8.27529 7.00942C8.34851 6.88615 8.38855 6.74601 8.39151 6.60266V2.45205H10.0518V6.60266C10.0533 6.74884 10.0934 6.89202 10.168 7.01772L10.8819 8.26291H7.56138L8.27529 7.00942ZM14.5178 15.3106C14.4454 15.4361 14.3414 15.5404 14.2161 15.6132C14.0909 15.6861 13.9488 15.7248 13.8039 15.7257H4.67256C4.52769 15.7248 4.38558 15.6861 4.26033 15.6132C4.13509 15.5404 4.03109 15.4361 3.95866 15.3106C3.8858 15.1844 3.84744 15.0413 3.84744 14.8956C3.84744 14.7499 3.8858 14.6067 3.95866 14.4805L6.59014 9.92315H11.8614L14.5178 14.4888C14.5907 14.615 14.629 14.7582 14.629 14.9039C14.629 15.0496 14.5907 15.1927 14.5178 15.3189V15.3106ZM7.56138 11.5834C7.3972 11.5834 7.23671 11.6321 7.10019 11.7233C6.96368 11.8145 6.85728 11.9442 6.79445 12.0958C6.73162 12.2475 6.71518 12.4144 6.74721 12.5755C6.77924 12.7365 6.85831 12.8844 6.9744 13.0005C7.09049 13.1166 7.23841 13.1957 7.39944 13.2277C7.56046 13.2597 7.72737 13.2433 7.87906 13.1804C8.03074 13.1176 8.16039 13.0112 8.25161 12.8747C8.34282 12.7382 8.39151 12.5777 8.39151 12.4135C8.39151 12.1934 8.30405 11.9822 8.14837 11.8265C7.99269 11.6709 7.78155 11.5834 7.56138 11.5834ZM10.8819 12.4135C10.7177 12.4135 10.5572 12.4622 10.4207 12.5534C10.2842 12.6446 10.1778 12.7743 10.1149 12.926C10.0521 13.0777 10.0357 13.2446 10.0677 13.4056C10.0997 13.5666 10.1788 13.7145 10.2949 13.8306C10.411 13.9467 10.5589 14.0258 10.7199 14.0578C10.881 14.0898 11.0479 14.0734 11.1995 14.0106C11.3512 13.9477 11.4809 13.8413 11.5721 13.7048C11.6633 13.5683 11.712 13.4078 11.712 13.2436C11.712 13.0235 11.6245 12.8123 11.4689 12.6567C11.3132 12.501 11.102 12.4135 10.8819 12.4135Z" fill="#0BA0A0"/>
</g>
<defs>
<rect width="18" height="18" fill="white" transform="translate(0.900879 0.0930176)"/>
</defs>
</svg>
`;break;case"imported":X.innerHTML=`<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13.6509 6.09302L9.90088 2.34302L6.15088 6.09302" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M9.90088 2.34302L9.90088 11.343" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M16.6509 11.343L16.6509 14.343C16.6509 14.7408 16.4928 15.1224 16.2115 15.4037C15.9302 15.685 15.5487 15.843 15.1509 15.843L4.65088 15.843C4.25305 15.843 3.87152 15.685 3.59022 15.4037C3.30891 15.1224 3.15088 14.7408 3.15088 14.343L3.15088 11.343" stroke="#0BA0A0" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;break;default:X.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 21 21" fill="none">
  <rect width="20.4598" height="20.4598" transform="translate(0.540039)"/>
  <path d="M10.77 5.75391V10.2295M10.77 10.2295V14.7051M10.77 10.2295H6.29443M10.77 10.2295H15.2456" stroke="#0BA1A1" stroke-width="1.5" stroke-linecap="round"/>
</svg>`;break}let J=document.createElement("h3");return J.classList.add("idevice_category_name"),J.innerHTML=Q,Y.append(X),Y.append(J),Y}elementDivIdevice(Q){let Z=document.createElement("div");return Z.id=Q.id,Z.classList.add("idevice_item"),Z.classList.add("draggable"),Z.setAttribute("draggable","true"),Z.setAttribute("drag","idevice"),Z.setAttribute("icon-type",Q.icon.type),Z.setAttribute("icon-name",Q.icon.name),Z.setAttribute("data-testid",`idevice-${Q.id}`),Z.append(this.elementDivIcon(Q)),Z.append(this.elementDivTitle(Q.title)),Z}elementDivIdeviceImported(Q){let Z=document.createElement("div");Z.id=Q.id,Z.classList.add("idevice_item","draggable"),Z.setAttribute("draggable","true"),Z.setAttribute("drag","idevice"),Z.setAttribute("title",Q.title),Z.setAttribute("icon-type",Q.icon.type),Z.setAttribute("icon-name",Q.icon.name),Z.setAttribute("data-testid",`idevice-${Q.id}`),Z.append(this.elementDivIcon(Q)),Z.append(this.elementDivTitle(Q.title));let Y=document.createElement("div");Y.classList.add("dropdown");let X=document.createElement("button");X.classList.add("btn","button-tertiary","btn-action-menu","button-narrow","d-flex","justify-content-center","align-items-center","ideviceMenu","exe-app-tooltip"),X.setAttribute("type","button"),X.setAttribute("data-bs-toggle","dropdown"),X.setAttribute("aria-expanded","false"),X.innerHTML='<span class="small-icon dots-menu-vertical-icon ideviceMenu"></span>';let J=document.createElement("ul");J.classList.add("dropdown-menu","ideviceMenu","dropdown-menu-with-cols");let W=document.createElement("li"),z=document.createElement("button");z.classList.add("dropdown-item","userIdeviceExport"),z.innerHTML='<span class="small-icon download-icon-green"></span> '+_("Export"),W.appendChild(z),z.addEventListener("click",(H)=>{H.preventDefault(),this.downloadIdeviceZip(Q)});let G=document.createElement("li"),q=document.createElement("button");return q.classList.add("dropdown-item","userIdeviceDelete"),q.innerHTML='<span class="small-icon delete-icon-red"></span> '+_("Delete"),G.appendChild(q),q.addEventListener("click",(H)=>{H.preventDefault(),eXeLearning.app.modals.confirm.show({title:_("Delete iDevice"),body:_("Delete this iDevice: %s?").replace("%s",Z.id),confirmButtonText:_("Delete"),cancelButtonText:_("Cancel"),confirmExec:()=>{this.removeIdevice(Z.id)}})}),J.append(W,G),Y.append(X,J),Z.append(Y),Z}elementDivIcon(Q){let Z=document.createElement("div");if(Z.classList.add("idevice_icon"),Q.icon.type==="exe-icon")Z.innerHTML=Q.icon.name;else if(Q.icon.type==="img")Z.classList.add("idevice-img-icon"),Z.style.backgroundImage=`url(${Q.path}/${Q.icon.url})`,Z.style.backgroundRepeat="no-repeat",Z.style.backgroundPosition="center",Z.style.backgroundSize="cover";return Z}elementDivTitle(Q){let Z=document.createElement("div");return Z.classList.add("idevice_title"),Z.innerHTML=Q,Z}}class k1{constructor(Q){this.parent=Q,this.activeLabel=null}behaviour(){this.addEventClickIdeviceCategory(),this.changeAttributePosBehaviour(),this.addResizeListener()}addEventClickIdeviceCategory(){this.parent.categoriesIdevicesLabels.forEach((Q)=>{Q.addEventListener("click",(Z)=>{let Y=Q.parentNode;if(this.activeLabel=Q,this.positionSibling(Q),this.parent.menuIdevices.getAttribute("size")==="thick")this.parent.categoriesIdevices.forEach((X)=>{X.classList.remove("on"),X.classList.add("off")}),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode();if(Y.classList.contains("off")){if(this.parent.categoriesIdevices.forEach((X)=>{X.classList.remove("last-open"),X.classList.remove("on"),X.classList.add("off")}),eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode(),eXeLearning.app.project.checkOpenIdevice())return;Y.classList.remove("off"),Y.classList.add("on"),Y.classList.add("last-open")}else Y.classList.remove("on"),Y.classList.remove("last-open"),Y.classList.add("off")})}),["click","dragstart","drag","dragend","dragenter","dragover","dragleave","drop"].forEach((Q)=>{document.addEventListener(Q,(Z)=>{if(!document.getElementById("menu_idevices_content").contains(Z.target))this.parent.categoriesIdevices.forEach((X)=>{X.classList.remove("last-open"),X.classList.remove("on"),X.classList.add("off")});eXeLearning.app.menus.menuStructure.menuStructureBehaviour.checkIfEmptyNode()},!0)})}addResizeListener(){window.addEventListener("resize",()=>{if(this.activeLabel)this.positionSibling(this.activeLabel)})}positionSibling(Q){let{parentNode:Z,nextElementSibling:Y}=Q;if(!Y)return;if(window.innerWidth<768){Y.style.left="";return}let X=Z.getBoundingClientRect();Y.style.left=`${X.right+14}px`}changeAttributePosBehaviour(){new MutationObserver((Z)=>{Z.forEach((Y)=>{if(Y.type==="attributes"&&Y.attributeName=="size"){this.parent.categoriesIdevices.forEach((J)=>{J.classList.remove("on"),J.classList.add("off")});let X=this.parent.menuIdevices.querySelector(".idevice_category.last-open");if(X)X.classList.remove("off"),X.classList.add("on")}})}).observe(this.parent.menuIdevices,{attributes:!0})}}class I1{constructor(){this.defaultIdevices=["text","az-quiz-game","form","download-source-file","image-gallery"],this.menuIdevices=document.querySelector("#idevices-bottom")}init(){this.nodeContainer=document.querySelector("#node-content"),this.centerMenuIdevices();let Q=new ResizeObserver(()=>this.centerMenuIdevices());if(this.nodeContainer)Q.observe(this.nodeContainer);window.addEventListener("resize",this.centerMenuIdevices),this.getIdevices().then((Z)=>{if(Z===null)this.idevicesData=this.filtreIdevices(this.defaultIdevices),this.saveIdevices(this.defaultIdevices);else this.idevicesData=this.filtreIdevices(Z);Object.values(this.idevicesData).forEach((Y)=>{this.menuIdevices.append(this.elementDivIdevice(Y))}),this.menuIdevices.append(this.elementConfigIdevices()),this.ideviceManagerButton=document.querySelector("#setting-menuIdevices"),this.ideviceManagerButton.addEventListener("click",()=>{eXeLearning.app.idevices.showModalIdeviceManager()}),eXeLearning.app.project.idevices.behaviour()})}centerMenuIdevices(){if(!this.nodeContainer||!this.menuIdevices)return;let Q=this.nodeContainer.getBoundingClientRect(),Z=Q.left+Q.width/2;this.menuIdevices.style.position="fixed",this.menuIdevices.style.left=`${Z}px`,this.menuIdevices.style.transform="translateX(-50%)"}elementDivIdevice(Q){let Z=document.createElement("div");Z.id=Q.id,Z.classList.add("idevice_item"),Z.classList.add("draggable"),Z.setAttribute("draggable","true"),Z.setAttribute("drag","idevice"),Z.setAttribute("icon-type",Q.icon.type),Z.setAttribute("icon-name",Q.icon.name),Z.setAttribute("title",Q.title),Z.setAttribute("data-bs-title",Q.title),Z.setAttribute("data-bs-placement","top"),Z.setAttribute("data-bs-toggle","tooltip"),window.bootstrap.Tooltip.getOrCreateInstance(Z),Z.setAttribute("data-testid",`quick-idevice-${Q.id}`),Z.append(this.elementDivIcon(Q));let Y=document.createElement("span");return Y.className="visually-hidden",Y.textContent=Q.title,Z.append(Y),Z}filtreIdevices(Q){let Z=eXeLearning.app.idevices.list.installed;return Q.reduce((Y,X,J)=>{if(Z.hasOwnProperty(X)){let W={...Z[X]};W.__order=J,Y[X]=W}return Y},{})}elementDivIcon(Q){let Z=document.createElement("div");if(Z.classList.add("idevice_icon"),Q.icon.type==="exe-icon")Z.innerHTML=Q.icon.name;else if(Q.icon.type==="img")Z.classList.add("idevice-img-icon"),Z.style.backgroundImage=`url(${Q.path}/${Q.icon.url})`,Z.style.backgroundRepeat="no-repeat",Z.style.backgroundPosition="center",Z.style.backgroundSize="24px";return Z}elementConfigIdevices(){let Q=document.createElement("div");return Q.classList.add("idevice_icon","settings-icon"),Q.id="setting-menuIdevices",Q.setAttribute("title",_("iDevices")),Q.setAttribute("data-bs-title",_("iDevices")),Q.setAttribute("data-bs-placement","top"),Q.setAttribute("data-bs-toggle","tooltip"),window.bootstrap.Tooltip.getOrCreateInstance(Q),Q}openDB(){return new Promise((Q,Z)=>{let Y=indexedDB.open("exelearning",1);Y.onupgradeneeded=function(X){let J=X.target.result;if(!J.objectStoreNames.contains("idevicesSettings"))J.createObjectStore("idevicesSettings",{keyPath:"id"})},Y.onsuccess=function(X){Q(X.target.result)},Y.onerror=function(X){Z(X.target.error)}})}async saveIdevices(Q){let Y=(await this.openDB()).transaction("idevicesSettings","readwrite"),X=Y.objectStore("idevicesSettings"),J=eXeLearning.app.user.name;X.put({id:J,value:Q}),await Y.complete}async getIdevices(){let Y=(await this.openDB()).transaction("idevicesSettings","readonly").objectStore("idevicesSettings"),X=eXeLearning.app.user.name;return new Promise((J)=>{let W=Y.get(X);W.onsuccess=()=>{J(W.result?W.result.value:null)},W.onerror=()=>{J(null)}})}}class y1{constructor(Q){this.idevicesList=Q,this.menuIdevices=document.querySelector("#menu_idevices"),this.menuIdevicesBottomContent=document.querySelector("#idevices-bottom"),this.categoriesIdevices=void 0,this.categoriesIdevicesLabels=void 0,this.menuIdevicesCompose=new f1(this,Q),this.menuIdevicesBehaviour=new k1(this)}load(){this.compose(),this.behaviour()}compose(){this.menuIdevicesCompose.compose(),this.categoriesIdevices=document.querySelectorAll("#menu_idevices .idevice_category"),this.categoriesIdevicesLabels=document.querySelectorAll("#menu_idevices .idevice_category .label")}behaviour(){this.menuIdevicesBehaviour.behaviour();let Q=document.getElementById("idevices-bottom");if(!Q||Q.children.length===0)this.menuIdevicesBottom=new I1(this),this.menuIdevicesBottom.init()}}class h1{constructor(Q){this.app=Q}async load(){this.loadJsMenusClasses(),await this.menuStructure.load(),this.menuIdevices.load(),this.navbar.load(),this.menuEngine.behaviour()}loadJsMenusClasses(){this.navbar=new T1,this.menuStructure=new C1(this.app.project.structure),this.menuIdevices=new y1(this.app.idevices.list),this.menuEngine=new D1}}class Z0{constructor(Q,Z){this.manager=Q,this.id=Z.dirName,this.dirName=Z.dirName,this.setConfigValues(Z),this.path=`${Q.symfonyURL}${Z.url}/`,this.valid=Z.valid}templatePageContainerClass="page-content-template-container";templatePageClass="page-content-template";configParams=["name","author","authorUrl","description","license","licenseUrl","title","version","type","templatePage","templateIdevice","textColor","linkColor","cssFiles","downloadable","icons"];configParamsTranslatables=["title"];default={name:"",author:"",authorUrl:"",description:"",license:"",licenseUrl:"",title:"Unknown",version:"1.0",templatePage:"",templateIdevice:"",textColor:"",linkColor:"",cssFiles:[],type:eXeLearning.config.themeBaseType,icons:{}};setConfigValues(Q){this.configParams.forEach((Z)=>{let Y=Q[Z],X=this.default[Z]!==void 0?this.default[Z]:null,J=Y!==void 0&&Y!==null?Y:X;if(this.isTranslatable(Z)&&J)J=_(J,this.id);this[Z]=J})}isTranslatable(Q){return this.configParamsTranslatables.includes(Q)}isValid(){return this.id!=null}async select(Q=!1){if(document.querySelectorAll("head .theme-style").forEach((Z)=>{Z.classList.add("prev-theme-style")}),await this.loadCss(),eXeLearning.app.project.structure.nodeSelected){if(eXeLearning.app.project.structure.nodeSelected.getAttribute("nav-id")!="root"&&Q==!1)await eXeLearning.app.project.idevices.cleanNodeAndLoadPage(!0,null)}setTimeout(()=>{this.removePreviousCssLoaded()},100)}async loadCss(){if(this.isUserTheme||this.path.startsWith("user-theme://")){await this.loadUserThemeCss();return}for(let Q=0;Q<this.cssFiles.length;Q++){let Z=this.path+this.cssFiles[Q];await this.loadStyleByInsertingIt(this.getResourceServicePath(Z))}}async loadUserThemeCss(){let Q=eXeLearning.app.resourceFetcher;if(!Q){console.error("[Theme] ResourceFetcher not available for user theme");return}let Z=Q.getUserTheme(this.id);if(!Z&&Q.getUserThemeAsync)Z=await Q.getUserThemeAsync(this.id);if(!Z){console.error(`[Theme] User theme '${this.id}' files not found in ResourceFetcher`);return}for(let Y of this.cssFiles){let X=Z.get(Y);if(X){let J=await X.text();await this.injectUserThemeCss(J,Y)}else console.warn(`[Theme] CSS file '${Y}' not found in user theme '${this.id}'`)}}async injectUserThemeCss(Q,Z){let Y=document.createElement("style");Y.classList.add("exe"),Y.classList.add("theme-style"),Y.setAttribute("data-user-theme",this.id),Y.setAttribute("data-file",Z);let J=eXeLearning.app.resourceFetcher?.getUserTheme(this.id);if(J)Q=await this.rewriteCssUrls(Q,J);return Y.innerHTML=Q,document.querySelector("head").append(Y),Y}async rewriteCssUrls(Q,Z){let Y=/url\(['"]?([^'")]+)['"]?\)/g,X=[...Q.matchAll(Y)];for(let J of X){let W=J[1];if(W.startsWith("http")||W.startsWith("data:")||W.startsWith("//"))continue;let z=W.replace(/^\.\//,""),G=Z.get(z);if(G){let q=URL.createObjectURL(G);Q=Q.replace(J[0],`url('${q}')`)}}return Q}removePreviousCssLoaded(){document.querySelectorAll("head .theme-style.prev-theme-style").forEach((Q)=>{Q.remove()})}getHeaderImgUrl(){return this.manager.symfonyURL+this.headerImgUrl}getLogoImgUrl(){return this.manager.symfonyURL+this.logoImgUrl}getPageTemplateElement(){if(!this.templatePage)return!1;let Q=document.createElement("div");return Q.classList.add(this.templatePageContainerClass),Q.innerHTML=this.templatePage.replace("{page-content}",`<div class='${this.templatePageClass}'></div>`),Q}getResourceServicePath(Q){if(Q.includes("/site-files/")||Q.includes("/admin-files/")||Q.includes("/user-files/"))return Q;if(Q.includes("/files/perm/themes/"))return Q;let Z=this.manager.app.api.endpoints.api_idevices_download_file_resources;if(!Z)return Q;let Y=Z.path,X=Q.split("/files/"),J=X.length==2?X[1]:Q;return J="/"+J,`${Y}?resource=${J}`}loadStyleDynamically(Q,Z){let Y=document.createElement("link");if(Y.classList.add("exe"),Y.classList.add("theme-style"),Y.setAttribute("rel","stylesheet"),Y.setAttribute("type","text/css"),Z)Y.href=`${Q}?t=${Date.now()}`;else Y.href=Q;return document.querySelector("head").append(Y),Y}async loadStyleByInsertingIt(Q){let Z=document.createElement("style");Z.classList.add("exe"),Z.classList.add("theme-style");let Y=await eXeLearning.app.api.func.getText(Q);return Y=Y.replace(/url\(\s*(['"]?)(?!data:|http:|https:|blob:|\/)([^'")]+)\1\s*\)/g,(X,J,W)=>`url(${J}${this.path}${W}${J})`),Z.innerHTML=Y,document.querySelector("head").append(Z),Z}}class b1{constructor(Q){this.manager=Q,this.installed={}}async load(){await this.loadThemesInstalled(),await this.loadUserThemesFromIndexedDB()}async loadThemesInstalled(){this.installed={};let Q=await this.manager.app.api.getThemesInstalled();if(Q&&Q.themes)Q.themes.forEach((Z)=>{this.loadTheme(Z)});return this.orderThemesInstalled(),this.installed}async loadThemeInstalled(Q){let Z=await this.manager.app.api.getThemesInstalled();if(Z&&Z.themes)Z.themes.forEach((Y)=>{if(Q){if(Q==Y.name){let X=new Z0(this.manager,Y);this.installed[Y.name]=X}}});return this.orderThemesInstalled(),this.installed}loadThemes(Q){this.installed={},Q.forEach((Z)=>{let Y=this.newTheme(Z);this.installed[Z.name]=Y}),this.orderThemesInstalled()}loadTheme(Q){let Z=this.newTheme(Q);this.installed[Q.name]=Z}async loadUserThemesFromIndexedDB(Q=null){try{let Z=Q;if(!Z)Z=this.manager.app?.project?._yjsBridge?.resourceCache;if(!Z)return;let Y=await Z.listUserThemes();if(!Y||Y.length===0)return;Logger.log(`[ThemeList] Loading ${Y.length} user theme(s) from IndexedDB...`);for(let{name:X,config:J}of Y){if(this.installed[X])continue;this.addUserTheme(J)}this.orderThemesInstalled(),Logger.log("[ThemeList] User themes loaded from IndexedDB")}catch(Z){console.error("[ThemeList] Error loading user themes from IndexedDB:",Z)}}addUserTheme(Q){let Z=`user-theme://${Q.dirName}`,Y={...Q,url:Z,preview:"",valid:!0},X=this.newTheme(Y);return X.isUserTheme=!0,this.installed[Q.name]=X,this.orderThemesInstalled(),console.log(`[ThemeList] Added user theme '${Q.name}'`),X}newTheme(Q){return new Z0(this.manager,Q)}getThemeInstalled(Q){for(let[Z,Y]of Object.entries(this.installed))if(Z==Q)return Y;return null}orderThemesInstalled(){let Q={};var Z=Object.keys(this.installed).map((Y)=>{return Y});Z.sort(),Z.forEach((Y)=>{Q[Y]=this.installed[Y]}),this.installed=Q}async removeTheme(Q){if(this.manager.selected.id==Q)await this.manager.selectTheme(eXeLearning.config.defaultTheme,!0);delete this.installed[Q]}}var o=()=>window.AppLogger||console;class v1{constructor(Q){this.app=Q,this.list=new b1(this),this.symfonyURL=this.app.eXeLearning.config.basePath,this.selected=null,this.metadataObserver=null,this.isApplyingRemoteTheme=!1}initYjsBinding(){let Q=this.app.project;if(Q?._yjsBridge){let Z=Q._yjsBridge.getDocumentManager();if(Z){let Y=Z.getMetadata(),X=Y.get("theme");if(X&&X!==this.selected?.id)this.selectTheme(X,!1,!1,!1),o().log("[ThemesManager] Loaded initial theme from Yjs:",X);this.metadataObserver=(J)=>{if(J.transaction.origin==="user")return;J.changes.keys.forEach((W,z)=>{if(z==="theme"&&(W.action==="add"||W.action==="update")){let G=Y.get("theme");if(G&&G!==this.selected?.id)this.onRemoteThemeChange(G)}})},Y.observe(this.metadataObserver),o().log("[ThemesManager] Yjs theme binding initialized")}}}async onRemoteThemeChange(Q){o().log("[ThemesManager] Remote theme change:",Q),this.isApplyingRemoteTheme=!0;try{if(await this.selectTheme(Q,!1,!1,!0),this.app.menus?.navbar?.styles?.updateSelectedTheme)this.app.menus.navbar.styles.updateSelectedTheme(Q)}finally{this.isApplyingRemoteTheme=!1}}saveThemeToYjs(Q){let Z=this.app.project;if(Z?._yjsBridge){let Y=Z._yjsBridge.getDocumentManager();if(Y){let X=Y.getMetadata(),J=Y.getDoc();J.transact(()=>{X.set("theme",Q),X.set("modifiedAt",Date.now())},J.clientID),o().log("[ThemesManager] Saved theme to Yjs:",Q)}}}async _ensureUserThemeInYjs(Q,Z){let Y=this.app.project;if(!Y?._yjsBridge)return;let X=Y._yjsBridge.getDocumentManager();if(!X)return;let J=X.getThemeFiles();if(J.has(Q)){o().log(`[ThemesManager] User theme '${Q}' already in Yjs`);return}let W=Y._yjsBridge.resourceCache;if(!W){console.warn("[ThemesManager] ResourceCache not available for copying theme to Yjs");return}try{let z=await W.getUserThemeRaw(Q);if(!z){console.warn(`[ThemesManager] Theme '${Q}' not found in IndexedDB`);return}let G=Y._yjsBridge._uint8ArrayToBase64(z.compressedFiles);J.set(Q,G),o().log(`[ThemesManager] Copied user theme '${Q}' to Yjs for collaboration`)}catch(z){console.error(`[ThemesManager] Error copying theme '${Q}' to Yjs:`,z)}}async _removeUserThemeFromYjs(Q){let Z=this.app.project;if(!Z?._yjsBridge)return;let Y=Z._yjsBridge.getDocumentManager();if(!Y)return;let X=Y.getThemeFiles();if(X.has(Q))X.delete(Q),o().log(`[ThemesManager] Removed user theme '${Q}' from Yjs (kept in IndexedDB)`)}async selectTheme(Q,Z,Y,X=!1){let J=this.getTheme(Q);if(!J)J=this.getTheme(eXeLearning.config.defaultTheme);if(J){let W=this.selected;if(this.selected=J,!W||Y||W.id!=this.selected.id)if(X==!1)await this.selected.select();else await this.selected.select(!0);if(Z&&W&&W.id!==Q){if(W.isUserTheme||W.type==="user")await this._removeUserThemeFromYjs(W.id)}if(Z&&(J.isUserTheme||J.type==="user"))await this._ensureUserThemeInYjs(J.id,J);if(Z)this.saveThemeToYjs(Q)}}getThemeIcons(){if(this.selected?.icons)return this.selected.icons;return{}}getTheme(Q){return this.list.getThemeInstalled(Q)}async loadThemesFromAPI(){await this.list.load()}}class g1{constructor(Q){this.manager=Q}preferenceTemplate={title:"",category:"",heritable:!1,value:"",type:"text",hide:!0};async load(){this.preferences=JSON.parse(JSON.stringify(eXeLearning.app.api.parameters.userPreferencesConfig)),await this.apiLoadPreferences()}setPreferences(Q){for(let[Z,Y]of Object.entries(Q))if(Q[Z])if(this.preferences[Z])this.preferences[Z].value=Q[Z].value;else this.preferences[Z]=JSON.parse(JSON.stringify(this.preferenceTemplate)),this.preferences[Z].title=Z,this.preferences[Z].value=Q[Z].value}showModalPreferences(){this.manager.app.modals.properties.show({node:this,title:_("Preferences"),contentId:"preferences",properties:this.preferences})}async apiLoadPreferences(){let Q=await eXeLearning.app.api.getUserPreferences();this.setPreferences(Q.userPreferences),this.manager.reloadMode(Q.userPreferences.advancedMode.value),this.manager.reloadVersionControl(Q.userPreferences.versionControl.value),this.manager.reloadLang(Q.userPreferences.locale.value)}async apiSaveProperties(Q){for(let[Y,X]of Object.entries(Q))this.preferences[Y].value=X;let Z={};for(let[Y,X]of Object.entries(Q))Z[Y]=X;if(await eXeLearning.app.api.putSaveUserPreferences(Z),Q.advancedMode)this.manager.reloadMode(Q.advancedMode);if(Q.versionControl)this.manager.reloadVersionControl(Q.versionControl);if(Q.locale)await this.manager.reloadLang(Q.locale);if(Z.locale!==void 0)window.onbeforeunload=null,window.location.reload()}}class u1{constructor(Q){this.app=Q,this._userData=eXeLearning.user,this.mode=this.modeValues.default,this.versionControl=null,this.preferences=new g1(this)}versionValues={active:"active",inactive:"inactive"};modeValues={default:"default",advanced:"advanced"};get id(){return this._userData?.id}get email(){return this._userData?.username}get username(){return this._userData?.username}get name(){return this._userData?.username}get gravatarUrl(){return this._userData?.gravatarUrl}get usernameFirsLetter(){return this._userData?.usernameFirsLetter}get acceptedLopd(){return this._userData?.acceptedLopd}get isGuest(){return this._userData?.username?.toLowerCase().endsWith("@guest.local")}async loadUserPreferences(){await this.preferences.load()}reloadMode(Q){if(Q=="true")this.mode=this.modeValues.advanced;else this.mode=this.modeValues.default;this.setModeAttribute()}setModeAttribute(){document.querySelector("body").setAttribute("mode",this.mode)}reloadVersionControl(Q){if(Q=="false"&&eXeLearning.config.isOfflineInstallation===!0)Q=this.versionValues.inactive,this.versionControl=Q,this.deleteOdeFilesByDate();else Q=this.versionValues.active,this.versionControl=Q}async deleteOdeFilesByDate(){let Z={date:Date.now()};await eXeLearning.app.api.postDeleteOdeFilesByDate(Z)}async reloadLang(Q){await eXeLearning.app.locale.setLocaleLang(Q),await eXeLearning.app.locale.loadTranslationsStrings()}}class m1{constructor(Q){this.app=Q,this.pending=[],this.authorizeAddActions=!0,this.authorizeAddActionsTimer=5000,this.intervalTime=100,this.addCheckActionsInterval()}addPendingAction(Q){if(this.authorizeAddActions)this.pending.push(Q),this.authorizeAddActions=!1,setTimeout(()=>{this.authorizeAddActions=!0},this.authorizeAddActionsTimer)}addCheckActionsInterval(){this.interval=setInterval(()=>{if(this.pending.length>0){let Q=this.pending.shift(),Z=document.getElementById(Q.element);Z.setAttribute("pending-action",!0),Z.dispatchEvent(new Event(Q.event))}},this.intervalTime)}}class c1{constructor(Q){this.app=Q,this.isMac=/Mac|iP(hone|ad|od)/.test(navigator.platform),this.index=new Map,this.boundHandler=this.onKeyDown.bind(this),this._observer=null,this._refreshTimer=null}init(){this.buildIndex(),this.renderHints(),window.addEventListener("keydown",this.boundHandler,{capture:!0}),window.addEventListener("load",()=>{requestAnimationFrame(()=>document.getElementById("eXeLearningNavbar")?.focus())})}refresh(){this.buildIndex(),this.renderHints()}observe(Q="#eXeLearningNavbar"){let Z=typeof Q==="string"?document.querySelector(Q):Q;if(!Z)return;if(this._observer)this._observer.disconnect();let Y=()=>{clearTimeout(this._refreshTimer),this._refreshTimer=setTimeout(()=>this.refresh(),10)};this._observer=new MutationObserver(Y),this._observer.observe(Z,{subtree:!0,childList:!0,attributes:!0,attributeFilter:["class","data-shortcut","aria-disabled","style","hidden"]}),Z.addEventListener("shown.bs.dropdown",Y),Z.addEventListener("hidden.bs.dropdown",Y)}destroy(){if(window.removeEventListener("keydown",this.boundHandler,{capture:!0}),this._observer)this._observer.disconnect()}buildIndex(){this.index.clear();let Q=document.querySelectorAll("[data-shortcut]");for(let Z of Q){let Y=(Z.getAttribute("data-shortcut")||"").split(",");for(let X of Y){let J=this.normalizeCombo(X);if(!J)continue;if(!this.index.has(J))this.index.set(J,[]);this.index.get(J).push(Z)}}}renderHints(){let Q=document.querySelectorAll("[data-shortcut]");for(let Z of Q){if(Z.querySelector(".shortcut-hint"))continue;let Y=(Z.getAttribute("data-shortcut")||"").split(",")[0].trim();if(!Y)continue;let X=document.createElement("span");X.className="shortcut-hint ms-auto ps-4 text-muted",X.textContent=this.humanLabel(Y),Z.appendChild(X)}}get isOffline(){return(document.body.getAttribute("installation-type")||"").toLowerCase()==="offline"}getComboRemap(){let Q=this.isOffline;return{"mod+alt+n":"navbar-button-new","mod+o":Q?"navbar-button-open-offline":"navbar-button-openuserodefiles","mod+s":Q?"navbar-button-save-offline":"navbar-button-save","mod+shift+s":Q?"navbar-button-save-as-offline":"navbar-button-save-as","mod+alt+s":"navbar-button-share","mod+alt+t":"navbar-button-styles","mod+p":"navbar-button-preview"}}resolveTarget(Q){let Z=this.getComboRemap()[Q];if(Z){let Y=document.getElementById(Z);if(Y&&!Y.hasAttribute("disabled")&&Y.getAttribute("aria-disabled")!=="true")return Y}}onKeyDown(Q){let Z=this.comboFromEvent(Q);if(!Z)return;if(this.isTypingTarget(Q.target)&&!Z.startsWith("mod+"))return;let Y=this.resolveTarget(Z);if(!Y)return;Q.preventDefault(),Q.stopPropagation(),Y.click()}normalizeCombo(Q){if(!Q||typeof Q!=="string")return null;let Z=Q.split("+").map((q)=>q.trim()).filter(Boolean);if(!Z.length)return null;let Y=new Map([["cmd","meta"],["command","meta"],["⌘","meta"],["win","meta"],["meta","meta"],["ctrl","ctrl"],["control","ctrl"],["alt","alt"],["option","alt"],["⌥","alt"],["shift","shift"],["⇧","shift"],["mod","mod"]]),X=[],J=[];for(let q of Z){let H=q.toLowerCase();if(Y.has(H))X.push(Y.get(H));else J.push(q)}let W=J.length?String(J[J.length-1]).toLowerCase():null;if(!W)return null;let z=Array.from(new Set(X));if(!z.length)return null;let G=["mod","ctrl","meta","shift","alt"];return z.sort((q,H)=>G.indexOf(q)-G.indexOf(H)),z.push(W),z.join("+")}comboFromEvent(Q){let Z=[];if(this.isMac?Q.metaKey:Q.ctrlKey)Z.push("mod");if(Q.ctrlKey&&this.isMac)Z.push("ctrl");if(Q.metaKey&&!this.isMac)Z.push("meta");if(Q.shiftKey)Z.push("shift");if(Q.altKey)Z.push("alt");if(!Z.length)return null;let Y="";if(Q.code&&/^Key[A-Z]$/.test(Q.code))Y=Q.code.slice(3).toLowerCase();else if(Q.code&&/^Digit[0-9]$/.test(Q.code))Y=Q.code.slice(5);else if(Q.key&&Q.key!=="Dead")Y=Q.key.toLowerCase();if(!Y)return null;let X=["mod","ctrl","meta","shift","alt"];return Z.sort((J,W)=>X.indexOf(J)-X.indexOf(W)),Z.push(Y),Z.join("+")}humanLabel(Q){let Z=String(Q).split("+").map((X)=>X.trim()).filter(Boolean),Y=[];for(let X of Z){let J=X.toLowerCase();if(J==="mod")Y.push(this.isMac?"⌘":"Ctrl");else if(J==="meta"||J==="cmd"||J==="command"||X==="⌘")Y.push("⌘");else if(J==="ctrl"||J==="control")Y.push("Ctrl");else if(J==="shift"||X==="⇧")Y.push(this.isMac?"⇧":"Shift");else if(J==="alt"||J==="option"||X==="⌥")Y.push(this.isMac?"⌥":"Alt");else Y.push(X.toUpperCase())}return this.isMac?Y.join(""):Y.join("+")}isVisible(Q){if(!Q)return!1;if(Q.closest(".d-none,[hidden]"))return!1;let Z=getComputedStyle(Q);if(Z.display==="none"||Z.visibility==="hidden"||Z.opacity==="0")return!1;return(Q.getClientRects()?.length||0)>0}isTypingTarget(Q){return!!(Q&&Q.closest?.('input, textarea, [contenteditable="true"]'))}isInsideOpenModal(Q){if(!document.body.classList.contains("modal-open"))return!1;return!!(Q&&Q.closest?.(".modal.show"))}}class p1{constructor(Q={}){this.checkUrl=Q.checkUrl||"",this.loginUrl=Q.loginUrl||"/login";let Z=Number(Q.interval)||60000;this.interval=Math.max(1e4,Z),this.closeYjsConnections=Q.closeYjsConnections||(()=>{}),this.onSessionInvalid=Q.onSessionInvalid||(()=>{}),this.onNetworkError=Q.onNetworkError||null,this.onRedirect=Q.onRedirect||((Y)=>{window.location.assign(Y)}),this.fetchOptions=Q.fetchOptions||{},this.timerId=null,this.pendingCheck=!1,this.invalidated=!1}start(){if(this.timerId!==null||!this.checkUrl)return;this.timerId=window.setInterval(()=>this.checkSession("interval"),this.interval),this.checkSession("initial")}stop(){if(this.timerId!==null)window.clearInterval(this.timerId),this.timerId=null}triggerImmediateCheck(Q="manual"){this.checkSession(Q)}handleYjsConnectionError(Q){if(this.invalidated)return;console.debug("SessionMonitor: Yjs connection issue, checking session...",Q),this.triggerImmediateCheck("yjs-connection-error")}async checkSession(Q){if(this.invalidated||this.pendingCheck||!this.checkUrl)return;this.pendingCheck=!0;let Z={Accept:"application/json"};if(this.fetchOptions.headers)Object.assign(Z,this.fetchOptions.headers);let Y={method:"GET",credentials:"same-origin",cache:"no-store",...this.fetchOptions,headers:Z};try{let X=await fetch(this.checkUrl,Y);if(X.status===401||X.status===403){this.handleInvalidSession("unauthorized");return}if(!X.ok){console.debug("SessionMonitor: unexpected status while checking the session",X.status);return}let J=null;if((X.headers.get("Content-Type")||"").includes("application/json"))J=await X.json();else try{J=await X.json()}catch(z){J=null}if(!J||J.authenticated!==!0)this.handleInvalidSession("session-check")}catch(X){if(this.onNetworkError)try{this.onNetworkError(X,Q)}catch(J){console.debug("SessionMonitor: error while executing network error callback",J)}else console.debug("SessionMonitor: network error",X)}finally{this.pendingCheck=!1}}handleInvalidSession(Q){if(this.invalidated)return;this.invalidated=!0,this.stop();try{this.closeYjsConnections?.(Q)}catch(Z){console.debug("SessionMonitor: error while closing Yjs connections",Z)}try{this.onSessionInvalid?.(Q)}catch(Z){console.debug("SessionMonitor: error while executing the invalid session callback",Z)}try{window.onbeforeunload=null}catch(Z){}try{this.onRedirect?.(this.loginUrl,Q)}catch(Z){console.error("SessionMonitor: redirect handler failed",Z)}}}var u=()=>window.AppLogger||console;class Y0{constructor(Q="server",Z={}){this.mode=Q,this.basePath=Z.basePath||"",this.staticData=Z.staticData||null,this.initialized=!1,this.cache={parameters:null,translations:{},idevices:null,themes:null,bundleManifest:null},u().log(`[DataProvider] Created in ${Q} mode`)}async init(){if(this.initialized)return;if(this.mode==="static")await this._initStaticData();this.initialized=!0,u().log("[DataProvider] Initialized")}async _initStaticData(){if(this.staticData){u().log("[DataProvider] Using constructor-provided static data");return}if(window.__EXE_STATIC_DATA__){this.staticData=window.__EXE_STATIC_DATA__,u().log("[DataProvider] Using window.__EXE_STATIC_DATA__");return}try{let Q=`${this.basePath}/data/bundle.json`;u().log(`[DataProvider] Fetching static data from ${Q}`);let Z=await fetch(Q);if(Z.ok){this.staticData=await Z.json(),u().log("[DataProvider] Loaded static data from bundle.json");return}}catch(Q){u().warn("[DataProvider] Failed to fetch bundle.json:",Q.message)}u().warn("[DataProvider] No static data source found, using empty defaults"),this.staticData={parameters:{routes:{}},translations:{en:{translations:{}}},idevices:{idevices:[]},themes:{themes:[]},bundleManifest:null}}isStaticMode(){return this.mode==="static"}isServerMode(){return this.mode==="server"}async getApiParameters(){if(this.cache.parameters)return this.cache.parameters;if(this.mode==="static")return this.cache.parameters=this.staticData?.parameters||{routes:{}},this.cache.parameters;let Q=`${this.basePath}/api/parameter-management/parameters/data/list`;try{let Z=await fetch(Q);if(!Z.ok)throw Error(`HTTP ${Z.status}`);return this.cache.parameters=await Z.json(),this.cache.parameters}catch(Z){throw u().error("[DataProvider] Failed to fetch API parameters:",Z),Z}}async getTranslations(Q){let Z=Q||"en";if(this.cache.translations[Z])return this.cache.translations[Z];if(this.mode==="static"){let X=Z.split("-")[0],J=this.staticData?.translations?.[Z]||this.staticData?.translations?.[X]||this.staticData?.translations?.en||{translations:{}};return this.cache.translations[Z]=J,J}let Y=`${this.basePath}/api/translations/${Z}`;try{let X=await fetch(Y);if(!X.ok)throw Error(`HTTP ${X.status}`);return this.cache.translations[Z]=await X.json(),this.cache.translations[Z]}catch(X){return u().error(`[DataProvider] Failed to fetch translations for ${Z}:`,X),{translations:{}}}}async getInstalledIdevices(){if(this.cache.idevices)return this.cache.idevices;if(this.mode==="static")return this.cache.idevices=this.staticData?.idevices||{idevices:[]},this.cache.idevices;return{idevices:[]}}async getInstalledThemes(){if(this.cache.themes)return this.cache.themes;if(this.mode==="static")return this.cache.themes=this.staticData?.themes||{themes:[]},this.cache.themes;return{themes:[]}}async getBundleManifest(){if(this.cache.bundleManifest!==null)return this.cache.bundleManifest;if(this.mode==="static")return this.cache.bundleManifest=this.staticData?.bundleManifest||null,this.cache.bundleManifest;return null}async getUploadLimits(){if(this.mode==="static")return{maxFileSize:104857600,maxFileSizeFormatted:"100 MB",limitingFactor:"none",details:{isStatic:!0}};let Q=`${this.basePath}/api/config/upload-limits`;try{let Z=await fetch(Q);if(!Z.ok)throw Error(`HTTP ${Z.status}`);return await Z.json()}catch(Z){return u().warn("[DataProvider] Failed to fetch upload limits, using defaults:",Z),{maxFileSize:104857600,maxFileSizeFormatted:"100 MB",limitingFactor:"unknown"}}}async getUserPreferences(){if(this.mode==="static")return{locale:navigator.language?.split("-")[0]||"en",theme:"light"};return{}}clearCache(){this.cache={parameters:null,translations:{},idevices:null,themes:null,bundleManifest:null}}getStaticData(){return this.staticData}}Y0.detectMode=function(){let Q=window.eXeLearning?.app?.capabilities;if(Q)return Q.storage.remote?"server":"static";if(window.__EXE_STATIC_MODE__===!0)return"static";if(window.location.protocol==="file:")return"static";if(!window.eXeLearning?.config?.fullURL)return"static";return"server"};class m{constructor(Q){this.mode=Q.mode,this.baseUrl=Q.baseUrl,this.wsUrl=Q.wsUrl,this.staticDataPath=Q.staticDataPath,Object.freeze(this)}static fromEnvironment(){if(window.__EXE_STATIC_MODE__)return new m({mode:"static",baseUrl:".",wsUrl:null,staticDataPath:"./data/bundle.json"});if(window.electronAPI)return new m({mode:"electron",baseUrl:window.location.origin,wsUrl:null,staticDataPath:null});let Q=window.location.protocol==="https:"?"wss:":"ws:";return new m({mode:"server",baseUrl:window.location.origin,wsUrl:`${Q}//${window.location.host}`,staticDataPath:null})}isStaticMode(){return this.mode==="static"}isServerMode(){return this.mode==="server"}isElectronMode(){return this.mode==="electron"}}class X0{constructor(Q){let Z=Q.mode==="server",Y=Q.mode==="static",X=Q.mode==="electron";this.collaboration=Object.freeze({enabled:Z,realtime:Z,presence:Z,concurrent:Z}),this.storage=Object.freeze({remote:Z,local:!0,sync:Z,serverPersistence:Z}),this.export=Object.freeze({serverSide:Z,clientSide:!0}),this.auth=Object.freeze({required:Z,guest:Y||X,loginAvailable:Z}),this.projects=Object.freeze({remoteList:Z,localList:Y||X,recentFromServer:Z,openFromServer:Z,saveToServer:Z}),this.sharing=Object.freeze({enabled:Z,visibility:Z,links:Z}),this.fileManager=Object.freeze({enabled:!0,serverBacked:Z,localBacked:Y||X}),Object.freeze(this)}}class J0 extends Error{constructor(Q,Z="APP_ERROR"){super(Q);this.name="AppError",this.code=Z}}class b extends J0{constructor(Q,Z=null,Y=null){super(Q,"NETWORK_ERROR");this.name="NetworkError",this.statusCode=Z,this.response=Y}isClientError(){return this.statusCode>=400&&this.statusCode<500}isServerError(){return this.statusCode>=500&&this.statusCode<600}}class g extends J0{constructor(Q,Z=null){super(Q,"STORAGE_ERROR");this.name="StorageError",this.cause=Z}}class W0 extends J0{constructor(Q,Z=!1){super(Q,"AUTH_ERROR");this.name="AuthError",this.requiresLogin=Z}}class i extends J0{constructor(Q,Z){super(`${Q} "${Z}" not found`,"NOT_FOUND");this.name="NotFoundError",this.resourceType=Q,this.resourceId=Z}}class a1{constructor(Q){this.baseUrl=Q.replace(/\/$/,"")}async get(Q,Z={}){return this._request("GET",Q,null,Z)}async post(Q,Z,Y={}){return this._request("POST",Q,Z,Y)}async put(Q,Z,Y={}){return this._request("PUT",Q,Z,Y)}async patch(Q,Z,Y={}){return this._request("PATCH",Q,Z,Y)}async delete(Q,Z={}){return this._request("DELETE",Q,null,Z)}async upload(Q,Z,Y=null){let X=this._buildUrl(Q);if(Y)return new Promise((J,W)=>{let z=new XMLHttpRequest;z.open("POST",X),z.withCredentials=!0,z.upload.addEventListener("progress",(G)=>{if(G.lengthComputable)Y(G.loaded/G.total)}),z.addEventListener("load",()=>{if(z.status>=200&&z.status<300)try{J(JSON.parse(z.responseText))}catch{J(z.responseText)}else W(new b(`Upload failed: ${z.statusText}`,z.status))}),z.addEventListener("error",()=>{W(new b("Upload failed: Network error"))}),z.send(Z)});return this._request("POST",Q,Z,{isFormData:!0})}async downloadBlob(Q){let Z=this._buildUrl(Q),Y=await fetch(Z,{method:"GET",credentials:"include"});if(!Y.ok)throw new b(`Download failed: ${Y.statusText}`,Y.status);return Y.blob()}async _request(Q,Z,Y,X={}){let J=this._buildUrl(Z),W={},z=null;if(Y)if(X.isFormData||Y instanceof FormData)z=Y;else W["Content-Type"]="application/json",z=JSON.stringify(Y);let G={method:Q,headers:W,credentials:"include",body:z,...X};delete G.isFormData;try{let q=await fetch(J,G);if(q.status===401)throw new W0("Session expired",!0);if(q.status===403)throw new W0("Access denied");if(!q.ok){let K=null;try{K=await q.json()}catch{}throw new b(K?.message||`Request failed: ${q.statusText}`,q.status,K)}if(q.status===204)return null;if(q.headers.get("content-type")?.includes("application/json"))return q.json();return q.text()}catch(q){if(q instanceof b||q instanceof W0)throw q;throw new b(`Network error: ${q.message}`)}}_buildUrl(Q){if(Q.startsWith("http://")||Q.startsWith("https://"))return Q;let Z=Q.startsWith("/")?Q:`/${Q}`;return`${this.baseUrl}${Z}`}}class z0{async list(){throw Error("ProjectRepositoryPort.list() not implemented")}async get(Q){throw Error("ProjectRepositoryPort.get() not implemented")}async create(Q){throw Error("ProjectRepositoryPort.create() not implemented")}async update(Q,Z){throw Error("ProjectRepositoryPort.update() not implemented")}async delete(Q){throw Error("ProjectRepositoryPort.delete() not implemented")}async getRecent(Q=10){throw Error("ProjectRepositoryPort.getRecent() not implemented")}async exists(Q){throw Error("ProjectRepositoryPort.exists() not implemented")}async save(Q,Z){throw Error("ProjectRepositoryPort.save() not implemented")}async autoSave(Q,Z){throw Error("ProjectRepositoryPort.autoSave() not implemented")}async saveAs(Q,Z){throw Error("ProjectRepositoryPort.saveAs() not implemented")}async duplicate(Q){throw Error("ProjectRepositoryPort.duplicate() not implemented")}async getLastUpdated(Q){throw Error("ProjectRepositoryPort.getLastUpdated() not implemented")}async getConcurrentUsers(Q,Z,Y){throw Error("ProjectRepositoryPort.getConcurrentUsers() not implemented")}async closeSession(Q){throw Error("ProjectRepositoryPort.closeSession() not implemented")}async joinSession(Q){throw Error("ProjectRepositoryPort.joinSession() not implemented")}async checkCurrentUsers(Q){throw Error("ProjectRepositoryPort.checkCurrentUsers() not implemented")}async openFile(Q){throw Error("ProjectRepositoryPort.openFile() not implemented")}async openLocalFile(Q){throw Error("ProjectRepositoryPort.openLocalFile() not implemented")}async openLargeLocalFile(Q){throw Error("ProjectRepositoryPort.openLargeLocalFile() not implemented")}async getLocalProperties(Q){throw Error("ProjectRepositoryPort.getLocalProperties() not implemented")}async getLocalComponents(Q){throw Error("ProjectRepositoryPort.getLocalComponents() not implemented")}async importToRoot(Q){throw Error("ProjectRepositoryPort.importToRoot() not implemented")}async importToRootFromLocal(Q){throw Error("ProjectRepositoryPort.importToRootFromLocal() not implemented")}async importAsChild(Q,Z){throw Error("ProjectRepositoryPort.importAsChild() not implemented")}async openMultipleLocalFiles(Q){throw Error("ProjectRepositoryPort.openMultipleLocalFiles() not implemented")}async deleteByDate(Q){throw Error("ProjectRepositoryPort.deleteByDate() not implemented")}async cleanAutosaves(Q){throw Error("ProjectRepositoryPort.cleanAutosaves() not implemented")}async getStructure(Q,Z){throw Error("ProjectRepositoryPort.getStructure() not implemented")}async getProperties(Q){throw Error("ProjectRepositoryPort.getProperties() not implemented")}async saveProperties(Q){throw Error("ProjectRepositoryPort.saveProperties() not implemented")}async getUsedFiles(Q){throw Error("ProjectRepositoryPort.getUsedFiles() not implemented")}}class t1 extends z0{constructor(Q,Z=""){super();this.http=Q,this.basePath=Z}_getAuthToken(){return window.eXeLearning?.app?.project?._yjsBridge?.authToken||window.eXeLearning?.app?.auth?.getToken?.()||window.eXeLearning?.config?.token||localStorage.getItem("authToken")}async _authFetch(Q,Z={}){let Y=this._getAuthToken(),X={"Content-Type":"application/json",...Y?{Authorization:`Bearer ${Y}`}:{},...Z.headers},J=await fetch(Q,{...Z,headers:X,credentials:"include"});if(!J.ok){if(J.status===404)throw new i("project",Q);throw new b(`Request failed: ${J.statusText}`,J.status)}if(J.status===204)return null;return J.json()}async list(){let Q=`${this.http.baseUrl}${this.basePath}/api/projects/user/list`;try{return(await this._authFetch(Q,{method:"GET"}))?.odeFiles?.odeFilesSync||[]}catch(Z){return console.error("[ServerProjectRepository] list error:",Z),[]}}async get(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/projects/${Q}`;try{return await this._authFetch(Z,{method:"GET"})}catch(Y){if(Y instanceof i)return null;throw Y}}async create(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/project/create-quick`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async update(Q,Z){let Y=`${this.http.baseUrl}${this.basePath}/api/projects/${Q}`;return this._authFetch(Y,{method:"PUT",body:JSON.stringify(Z)})}async delete(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/remove-file`;return this._authFetch(Z,{method:"POST",body:JSON.stringify({odeFileId:Q})})}async getRecent(Q=3){let Z=`${this.http.baseUrl}${this.basePath}/api/projects/user/recent`;try{return await this._authFetch(Z,{method:"GET"})}catch(Y){return console.error("[ServerProjectRepository] getRecent error:",Y),[]}}async exists(Q){try{return await this.get(Q)!==null}catch{return!1}}async joinSession(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/current-users/check-ode-session-id`;return this._authFetch(Z,{method:"POST",body:JSON.stringify({odeSessionId:Q})})}async checkCurrentUsers(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/check-before-leave-ode-session`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async save(Q,Z){let Y=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/${Q}/save/manual`;return this._authFetch(Y,{method:"POST",body:JSON.stringify(Z)})}async autoSave(Q,Z){let Y=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/${Q}/save/auto`;this._authFetch(Y,{method:"POST",body:JSON.stringify(Z)}).catch((X)=>{console.warn("[ServerProjectRepository] autoSave error:",X)})}async saveAs(Q,Z){let Y=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/${Q}/save-as`;return this._authFetch(Y,{method:"POST",body:JSON.stringify(Z)})}async duplicate(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/duplicate`;return this._authFetch(Z,{method:"POST",body:JSON.stringify({odeFileId:Q})})}async getLastUpdated(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/odes/last-updated`;try{return await this._authFetch(Z,{method:"GET"})}catch(Y){return console.error("[ServerProjectRepository] getLastUpdated error:",Y),{lastUpdated:null}}}async getConcurrentUsers(Q,Z,Y){let X=`${this.http.baseUrl}${this.basePath}/api/odes/current-users?odeSessionId=${encodeURIComponent(Y)}`;try{return{users:(await this._authFetch(X)).currentUsers||[]}}catch(J){return console.error("[ServerProjectRepository] getConcurrentUsers error:",J),{users:[]}}}async closeSession(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/close-session`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async openFile(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/elp/open`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async openLocalFile(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/local/elp/open`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async openLargeLocalFile(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/local/large-elp/open`,Y=this._getAuthToken(),X=await fetch(Z,{method:"POST",headers:{...Y?{Authorization:`Bearer ${Y}`}:{}},credentials:"include",body:Q});if(!X.ok)throw new b(`Request failed: ${X.statusText}`,X.status);return X.json()}async getLocalProperties(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/local/xml/properties/open`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async getLocalComponents(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/local/idevices/open`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async importToRoot(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/local/elp/import/root`,Y=this._getAuthToken(),X=await fetch(Z,{method:"POST",headers:{...Y?{Authorization:`Bearer ${Y}`}:{}},credentials:"include",body:Q});if(!X.ok)throw new b(`Request failed: ${X.statusText}`,X.status);return X.json()}async importToRootFromLocal(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/import/local/root`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async importAsChild(Q,Z){let Y=`${this.http.baseUrl}${this.basePath}/api/nav-structure-management/nav-structures/${Q}/import-elp`;return this._authFetch(Y,{method:"POST",body:JSON.stringify(Z)})}async openMultipleLocalFiles(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/ode/multiple/local/elp/open`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async deleteByDate(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/remove-date-files`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}async cleanAutosaves(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/odes/clean-init-autosave`;try{return await this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}catch(Y){return console.warn("[ServerProjectRepository] cleanAutosaves error:",Y),{success:!0,message:"Cleanup skipped"}}}async getStructure(Q,Z){let Y=`${this.http.baseUrl}${this.basePath}/api/nav-structure-management/nav-structures/${Q}/${Z}`;return this._authFetch(Y,{method:"GET"})}async getProperties(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/properties/${Q}`;return this._authFetch(Z,{method:"GET"})}async saveProperties(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/properties/save`;return this._authFetch(Z,{method:"PUT",body:JSON.stringify(Q)})}async getUsedFiles(Q){let Z=`${this.http.baseUrl}${this.basePath}/api/ode-management/odes/session/used-files`;return this._authFetch(Z,{method:"POST",body:JSON.stringify(Q)})}}class G0{async getIDevices(){throw Error("CatalogPort.getIDevices() not implemented")}async getThemes(){throw Error("CatalogPort.getThemes() not implemented")}async getLocales(){throw Error("CatalogPort.getLocales() not implemented")}async getTranslations(Q){throw Error("CatalogPort.getTranslations() not implemented")}async getIDevice(Q){throw Error("CatalogPort.getIDevice() not implemented")}async getTheme(Q){throw Error("CatalogPort.getTheme() not implemented")}async getLicenses(){throw Error("CatalogPort.getLicenses() not implemented")}async getExportFormats(){throw Error("CatalogPort.getExportFormats() not implemented")}async getTemplates(Q){throw Error("CatalogPort.getTemplates() not implemented")}async getComponentHtmlTemplate(Q){throw Error("CatalogPort.getComponentHtmlTemplate() not implemented")}async createTheme(Q){throw Error("CatalogPort.createTheme() not implemented")}async updateTheme(Q,Z){throw Error("CatalogPort.updateTheme() not implemented")}async getApiParameters(){throw Error("CatalogPort.getApiParameters() not implemented")}async getChangelog(){throw Error("CatalogPort.getChangelog() not implemented")}async getUploadLimits(){throw Error("CatalogPort.getUploadLimits() not implemented")}async getThirdPartyCode(){throw Error("CatalogPort.getThirdPartyCode() not implemented")}async getLicensesList(){throw Error("CatalogPort.getLicensesList() not implemented")}async getSaveHtmlView(Q){throw Error("CatalogPort.getSaveHtmlView() not implemented")}async getIdevicesBySessionId(Q){throw Error("CatalogPort.getIdevicesBySessionId() not implemented")}}class e1 extends G0{constructor(Q,Z={}){super();this.http=Q,this.endpoints=Z}_getEndpoint(Q){return this.endpoints[Q]?.path||null}async getIDevices(){let Q=this._getEndpoint("api_idevices_installed");if(!Q)return console.warn("[ServerCatalogAdapter] api_idevices_installed endpoint not found"),[];return this.http.get(Q)}async getThemes(){let Q=this._getEndpoint("api_themes_installed");if(!Q)return console.warn("[ServerCatalogAdapter] api_themes_installed endpoint not found"),[];return this.http.get(Q)}async getLocales(){let Q=this._getEndpoint("api_locales");if(!Q)return this.http.get("/api/locales");return this.http.get(Q)}async getTranslations(Q){let Z=this._getEndpoint("api_translations");if(!Z)return this.http.get(`/api/translations/${Q}`);let Y=Z.replace("{locale}",Q);return this.http.get(Y)}async getIDevice(Q){return(await this.getIDevices()).find((Y)=>Y.id===Q||Y.name===Q)||null}async getTheme(Q){return(await this.getThemes()).find((Y)=>Y.id===Q||Y.name===Q)||null}async getLicenses(){let Q=this._getEndpoint("api_licenses");if(!Q)return this.http.get("/api/licenses");return this.http.get(Q)}async getExportFormats(){let Q=this._getEndpoint("api_export_formats");if(!Q)return this.http.get("/api/export/formats");return this.http.get(Q)}async getApiParameters(){let Q=window.eXeLearning?.config?.basePath||"",Z="/api/parameter-management/parameters/data/list";return this.http.get(`${Q}/api/parameter-management/parameters/data/list`)}async getUploadLimits(){let Q=window.eXeLearning?.config?.basePath||"";return this.http.get(`${Q}/api/config/upload-limits`)}async getTemplates(Q){let Z=window.eXeLearning?.config?.basePath||"";return this.http.get(`${Z}/api/templates?locale=${Q}`)}async getChangelog(){let Q=window.eXeLearning?.config?.changelogURL;if(!Q)return"";let Z=window.eXeLearning?.app?.common?.getVersionTimeStamp?.()||Date.now();try{let Y=await fetch(`${Q}?version=${Z}`);return Y.ok?Y.text():""}catch{return""}}async getThirdPartyCode(){let Q=window.eXeLearning?.config?.basePath||"",Z=window.eXeLearning?.config?.baseURL||"",Y=window.eXeLearning?.version||"v1.0.0",X=`${Z}${Q}/${Y}/libs/README.md`;try{let J=await fetch(X);return J.ok?J.text():""}catch{return""}}async getLicensesList(){let Q=window.eXeLearning?.config?.basePath||"",Z=window.eXeLearning?.config?.baseURL||"",Y=window.eXeLearning?.version||"v1.0.0",X=`${Z}${Q}/${Y}/libs/LICENSES`;try{let J=await fetch(X);return J.ok?J.text():""}catch{return""}}async getComponentHtmlTemplate(Q){let Z=this._getEndpoint("api_idevices_html_template_get");if(!Z){let X=window.eXeLearning?.config?.basePath||"";return this.http.get(`${X}/api/idevices/${Q}/template`)}let Y=Z.replace("{odeComponentsSyncId}",Q);return this.http.get(Y)}async createTheme(Q){let Z=this._getEndpoint("api_themes_new");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.post(`${Y}/api/themes/new`,Q)}return this.http.post(Z,Q)}async updateTheme(Q,Z){let Y=this._getEndpoint("api_themes_edit");if(!Y){let J=window.eXeLearning?.config?.basePath||"";return this.http.put(`${J}/api/themes/${Q}`,Z)}let X=Y.replace("{themeId}",Q);return this.http.put(X,Z)}async getSaveHtmlView(Q){let Z=this._getEndpoint("api_idevices_html_view_get");if(!Z){let X=window.eXeLearning?.config?.basePath||"";return this.http.get(`${X}/api/idevices/${Q}/htmlview`)}let Y=Z.replace("{odeComponentsSyncId}",Q);return this.http.get(Y)}async getIdevicesBySessionId(Q){let Z=this._getEndpoint("api_games_session_idevices");if(!Z){let X=window.eXeLearning?.config?.basePath||"";return this.http.get(`${X}/api/games/session/${Q}/idevices`)}let Y=Z.replace("{odeSessionId}",Q);return this.http.get(Y)}}class q0{async upload(Q,Z,Y){throw Error("AssetPort.upload() not implemented")}async getUrl(Q,Z){throw Error("AssetPort.getUrl() not implemented")}async getBlob(Q,Z){throw Error("AssetPort.getBlob() not implemented")}async delete(Q,Z){throw Error("AssetPort.delete() not implemented")}async list(Q,Z){throw Error("AssetPort.list() not implemented")}async exists(Q,Z){throw Error("AssetPort.exists() not implemented")}async copy(Q,Z,Y){throw Error("AssetPort.copy() not implemented")}async move(Q,Z,Y){throw Error("AssetPort.move() not implemented")}}class _2 extends q0{constructor(Q,Z=""){super();this.http=Q,this.basePath=Z}async upload(Q,Z,Y){let X=new FormData;X.append("file",Z),X.append("path",Y);let J=`${this.basePath}/api/assets/${Q}/upload`;return this.http.upload(J,X)}async getUrl(Q,Z){return`${this.http.baseUrl}${this.basePath}/api/assets/${Q}/${encodeURIComponent(Z)}`}async getBlob(Q,Z){let Y=`${this.basePath}/api/assets/${Q}/${encodeURIComponent(Z)}`;return this.http.downloadBlob(Y)}async delete(Q,Z){let Y=`${this.basePath}/api/assets/${Q}/${encodeURIComponent(Z)}`;return this.http.delete(Y)}async list(Q,Z=""){let Y=`${this.basePath}/api/assets/${Q}/list`,X=Z?`?directory=${encodeURIComponent(Z)}`:"";return this.http.get(`${Y}${X}`)}async exists(Q,Z){try{let Y=`${this.basePath}/api/assets/${Q}/${encodeURIComponent(Z)}/exists`;return(await this.http.get(Y))?.exists??!1}catch(Y){if(Y instanceof b&&Y.statusCode===404)return!1;throw Y}}async copy(Q,Z,Y){let X=`${this.basePath}/api/assets/${Q}/copy`;return this.http.post(X,{src:Z,dest:Y})}async move(Q,Z,Y){let X=`${this.basePath}/api/assets/${Q}/move`;return this.http.post(X,{src:Z,dest:Y})}async uploadViaFileManager(Q,Z,Y=""){let X=new FormData;if(X.append("file",Z),Y)X.append("directory",Y);let J=`${this.basePath}/api/filemanager/${Q}/upload`;return this.http.upload(J,X)}async listFiles(Q,Z=""){let Y=`${this.basePath}/api/filemanager/${Q}/list`,X=Z?`?directory=${encodeURIComponent(Z)}`:"";return this.http.get(`${Y}${X}`)}async createDirectory(Q,Z){let Y=`${this.basePath}/api/filemanager/${Q}/mkdir`;return this.http.post(Y,{path:Z})}async deleteFile(Q,Z){let Y=`${this.basePath}/api/filemanager/${Q}/delete`;return this.http.post(Y,{path:Z})}async rename(Q,Z,Y){let X=`${this.basePath}/api/filemanager/${Q}/rename`;return this.http.post(X,{oldPath:Z,newPath:Y})}}class H0{isEnabled(){return!1}async connect(Q){throw Error("CollaborationPort.connect() not implemented")}async disconnect(){throw Error("CollaborationPort.disconnect() not implemented")}async getPresence(){throw Error("CollaborationPort.getPresence() not implemented")}async updatePresence(Q){throw Error("CollaborationPort.updatePresence() not implemented")}onPresenceChange(Q){throw Error("CollaborationPort.onPresenceChange() not implemented")}getWebSocketUrl(){return null}async obtainBlockSync(Q){throw Error("CollaborationPort.obtainBlockSync() not implemented")}}class $2 extends H0{constructor(Q,Z=""){super();this.wsUrl=Q,this.basePath=Z,this.currentProjectId=null,this._presenceCallbacks=new Set}isEnabled(){return!0}async connect(Q){this.currentProjectId=Q}async disconnect(){this.currentProjectId=null}async getPresence(){let Q=window.eXeLearning?.app?.project?._yjsBridge?.awareness;if(!Q)return[];let Z=[];return Q.getStates().forEach((Y,X)=>{if(Y.user)Z.push({clientId:X,userId:Y.user.id||X.toString(),username:Y.user.name||"Anonymous",color:Y.user.color||"#888888",cursor:Y.cursor})}),Z}async updatePresence(Q){let Z=window.eXeLearning?.app?.project?._yjsBridge?.awareness;if(!Z)return;Z.setLocalStateField("cursor",Q.cursor),Z.setLocalStateField("selection",Q.selection)}onPresenceChange(Q){this._presenceCallbacks.add(Q);let Z=window.eXeLearning?.app?.project?._yjsBridge?.awareness;if(Z){let Y=()=>{this.getPresence().then((X)=>{Q(X)})};return Z.on("change",Y),()=>{this._presenceCallbacks.delete(Q),Z.off("change",Y)}}return()=>{this._presenceCallbacks.delete(Q)}}getWebSocketUrl(){return this.wsUrl}getProjectWebSocketUrl(Q){if(!this.wsUrl)return null;return`${this.wsUrl}/yjs/${Q}`}async obtainBlockSync(Q){return{responseMessage:"OK",block:null}}}class K0{async exportAs(Q,Z,Y={}){throw Error("ExportPort.exportAs() not implemented")}async getSupportedFormats(){throw Error("ExportPort.getSupportedFormats() not implemented")}async isFormatSupported(Q){throw Error("ExportPort.isFormatSupported() not implemented")}async generatePreview(Q){throw Error("ExportPort.generatePreview() not implemented")}async exportAsElpx(Q,Z){throw Error("ExportPort.exportAsElpx() not implemented")}async getPreviewUrl(Q){throw Error("ExportPort.getPreviewUrl() not implemented")}async downloadIDevice(Q,Z,Y){throw Error("ExportPort.downloadIDevice() not implemented")}}class Q2 extends K0{constructor(Q,Z={},Y=""){super();this.http=Q,this.endpoints=Z,this.basePath=Y}_getEndpoint(Q){return this.endpoints[Q]?.path||null}async exportAs(Q,Z,Y={}){let X=`${this.basePath}/api/export/${Q}`;return this.http.post(X,{projectData:Z,...Y})}async getSupportedFormats(){return[{id:"html5",name:"Website (HTML5)",extension:"zip"},{id:"scorm12",name:"SCORM 1.2",extension:"zip"},{id:"scorm2004",name:"SCORM 2004",extension:"zip"},{id:"ims",name:"IMS Content Package",extension:"zip"},{id:"epub3",name:"ePub 3",extension:"epub"},{id:"xliff",name:"XLIFF",extension:"xliff"}]}async isFormatSupported(Q){return(await this.getSupportedFormats()).some((Y)=>Y.id===Q)}async generatePreview(Q){let Z=`${this.basePath}/api/preview/generate`;return this.http.post(Z,Q)}async exportAsElpx(Q,Z){let Y=`${this.basePath}/api/export/elpx`;return this.http.post(Y,{projectData:Q,assets:Z})}async downloadExport(Q,Z){let Y=`${this.basePath}/api/export/${Q}/${Z}/download`;return this.http.downloadBlob(Y)}async getExportStatus(Q){let Z=`${this.basePath}/api/export/status/${Q}`;return this.http.get(Z)}async cancelExport(Q){let Z=`${this.basePath}/api/export/cancel/${Q}`;return this.http.post(Z,{})}async getPreviewUrl(Q){let Z=this._getEndpoint("api_ode_export_preview");if(!Z)Z=`${this.basePath}/api/ode/${Q}/preview`;else Z=Z.replace("{odeSessionId}",Q);return this.http.get(Z)}async downloadIDevice(Q,Z,Y){let X=this._getEndpoint("api_idevices_download_ode_components");if(!X)X=`${this.basePath}/api/ode/${Q}/block/${Z}/idevice/${Y}/download`;else X=X.replace("{odeSessionId}",Q),X=X.replace("{odeBlockId}",Z),X=X.replace("{odeIdeviceId}",Y);let J=await this.http.getText(X);return{url:X,response:J}}}class V0{async savePage(Q){throw Error("ContentPort.savePage() not implemented")}async reorderPage(Q){throw Error("ContentPort.reorderPage() not implemented")}async clonePage(Q){throw Error("ContentPort.clonePage() not implemented")}async deletePage(Q){throw Error("ContentPort.deletePage() not implemented")}async reorderBlock(Q){throw Error("ContentPort.reorderBlock() not implemented")}async deleteBlock(Q){throw Error("ContentPort.deleteBlock() not implemented")}async reorderIdevice(Q){throw Error("ContentPort.reorderIdevice() not implemented")}async saveIdevice(Q){throw Error("ContentPort.saveIdevice() not implemented")}async cloneIdevice(Q){throw Error("ContentPort.cloneIdevice() not implemented")}async deleteIdevice(Q){throw Error("ContentPort.deleteIdevice() not implemented")}async send(Q,Z){throw Error("ContentPort.send() not implemented")}}class Z2 extends V0{constructor(Q,Z={}){super();this.http=Q,this.endpoints=Z}_getEndpoint(Q){return this.endpoints[Q]?.path||null}async savePage(Q){let Z=this._getEndpoint("api_ode_page_edit");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.put(`${Y}/api/page`,Q)}return this.http.put(Z,Q)}async reorderPage(Q){let Z=this._getEndpoint("api_ode_page_reorder");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.put(`${Y}/api/page/reorder`,Q)}return this.http.put(Z,Q)}async clonePage(Q){let Z=this._getEndpoint("api_ode_page_clone");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.post(`${Y}/api/page/clone`,Q)}return this.http.post(Z,Q)}async deletePage(Q){let Z=this._getEndpoint("api_ode_page_delete");if(!Z){let X=window.eXeLearning?.config?.basePath||"";return this.http.delete(`${X}/api/page/${Q}`)}let Y=Z.replace("{odeNavStructureSyncId}",Q);return this.http.delete(Y)}async reorderBlock(Q){let Z=this._getEndpoint("api_ode_block_reorder");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.put(`${Y}/api/block/reorder`,Q)}return this.http.put(Z,Q)}async deleteBlock(Q){let Z=this._getEndpoint("api_ode_block_delete");if(!Z){let X=window.eXeLearning?.config?.basePath||"";return this.http.delete(`${X}/api/block/${Q}`)}let Y=Z.replace("{odeBlockSyncId}",Q);return this.http.delete(Y)}async reorderIdevice(Q){let Z=this._getEndpoint("api_idevices_idevice_reorder");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.put(`${Y}/api/idevice/reorder`,Q)}return this.http.put(Z,Q)}async saveIdevice(Q){let Z=this._getEndpoint("api_idevices_idevice_data_save");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.put(`${Y}/api/idevice/save`,Q)}return this.http.put(Z,Q)}async cloneIdevice(Q){let Z=this._getEndpoint("api_idevices_idevice_clone");if(!Z){let Y=window.eXeLearning?.config?.basePath||"";return this.http.post(`${Y}/api/idevice/clone`,Q)}return this.http.post(Z,Q)}async deleteIdevice(Q){let Z=this._getEndpoint("api_idevices_idevice_delete");if(!Z){let X=window.eXeLearning?.config?.basePath||"";return this.http.delete(`${X}/api/idevice/${Q}`)}let Y=Z.replace("{odeComponentsSyncId}",Q);return this.http.delete(Y)}async send(Q,Z){let Y=this.endpoints[Q];if(!Y)throw Error(`Endpoint not found: ${Q}`);let X=(Y.method||Y.methods?.[0]||"GET").toLowerCase(),J=Y.path;switch(X){case"get":return this.http.get(J);case"post":return this.http.post(J,Z);case"put":return this.http.put(J,Z);case"delete":return this.http.delete(J);default:return this.http.post(J,Z)}}}class R0{async getPreferences(){throw Error("UserPreferencePort.getPreferences() not implemented")}async savePreferences(Q){throw Error("UserPreferencePort.savePreferences() not implemented")}async acceptLopd(){throw Error("UserPreferencePort.acceptLopd() not implemented")}async isLopdAccepted(){throw Error("UserPreferencePort.isLopdAccepted() not implemented")}async getPreference(Q,Z=null){throw Error("UserPreferencePort.getPreference() not implemented")}async setPreference(Q,Z){throw Error("UserPreferencePort.setPreference() not implemented")}}var Y2={locale:{title:"Language",value:"en",type:"select"},advancedMode:{title:"Advanced Mode",value:"false",type:"checkbox"},versionControl:{title:"Version Control",value:"false",type:"checkbox"},theme:{title:"Theme",value:"base",type:"select"},defaultLicense:{title:"Default License",value:"creative commons: attribution - share alike 4.0",type:"select"}};class X2 extends R0{constructor(Q,Z={},Y=""){super();this.http=Q,this.endpoints=Z,this.basePath=Y}_getEndpoint(Q){return this.endpoints[Q]?.path||null}_getAuthToken(){return window.eXeLearning?.app?.project?._yjsBridge?.authToken||window.eXeLearning?.app?.auth?.getToken?.()||window.eXeLearning?.config?.token||localStorage.getItem("authToken")}async _authFetch(Q,Z={}){let Y=this._getAuthToken(),X={"Content-Type":"application/json",...Y?{Authorization:`Bearer ${Y}`}:{},...Z.headers},J=await fetch(Q,{...Z,headers:X,credentials:"include"});if(!J.ok)throw Error(`Request failed: ${J.statusText}`);if(J.status===204)return{success:!0};return J.json()}async getPreferences(){let Q=this._getEndpoint("api_user_preferences_get");if(!Q)Q=`${this.basePath}/api/user/preferences`;try{let Y=(await this._authFetch(Q,{method:"GET"}))?.userPreferences||{},X={...Y2};for(let[J,W]of Object.entries(Y))if(W&&typeof W==="object")X[J]={...Y2[J],...W};return{userPreferences:X}}catch(Z){return console.warn("[ServerUserPreferenceAdapter] getPreferences error:",Z),{userPreferences:{...Y2}}}}async savePreferences(Q){let Z=this._getEndpoint("api_user_preferences_save");if(!Z)Z=`${this.basePath}/api/user/preferences`;return this._authFetch(Z,{method:"PUT",body:JSON.stringify(Q)})}async acceptLopd(){let Q=this._getEndpoint("api_user_set_lopd_accepted");if(!Q)Q=`${this.basePath}/api/user/lopd/accept`;return this._authFetch(Q,{method:"POST"})}async isLopdAccepted(){try{return(await this.getPreferences())?.userPreferences?.lopdAccepted?.value===!0}catch{return!1}}async getPreference(Q,Z=null){try{let X=(await this.getPreferences())?.userPreferences?.[Q];return X?.value!==void 0?X.value:Z}catch{return Z}}async setPreference(Q,Z){return this.savePreferences({[Q]:Z})}}class A0{async getSessionBrokenLinks(Q){throw Error("LinkValidationPort.getSessionBrokenLinks() not implemented")}async extractLinks(Q){throw Error("LinkValidationPort.extractLinks() not implemented")}getValidationStreamUrl(){throw Error("LinkValidationPort.getValidationStreamUrl() not implemented")}async getPageBrokenLinks(Q){throw Error("LinkValidationPort.getPageBrokenLinks() not implemented")}async getBlockBrokenLinks(Q){throw Error("LinkValidationPort.getBlockBrokenLinks() not implemented")}async getIdeviceBrokenLinks(Q){throw Error("LinkValidationPort.getIdeviceBrokenLinks() not implemented")}isSupported(){return!0}}class J2 extends A0{constructor(Q,Z={},Y=""){super();this.http=Q,this.endpoints=Z,this.basePath=Y}_getEndpoint(Q){return this.endpoints[Q]?.path||null}async getSessionBrokenLinks(Q){let Z=this._getEndpoint("api_odes_session_get_broken_links");if(!Z){let Y=window.eXeLearning?.config?.baseURL||"";return this.http.post(`${Y}${this.basePath}/api/ode-management/odes/session/brokenlinks`,Q)}return this.http.post(Z,Q)}async extractLinks(Q){let Y=`${window.eXeLearning?.config?.baseURL||""}${this.basePath}/api/ode-management/odes/session/brokenlinks/extract`;return this.http.post(Y,Q)}getValidationStreamUrl(){return`${window.eXeLearning?.config?.baseURL||""}${this.basePath}/api/ode-management/odes/session/brokenlinks/validate-stream`}async getPageBrokenLinks(Q){let Z=this._getEndpoint("api_odes_pag_get_broken_links");if(!Z){let X=window.eXeLearning?.config?.baseURL||"";return this.http.get(`${X}${this.basePath}/api/ode-management/odes/page/${Q}/brokenlinks`)}let Y=Z.replace("{odePageId}",Q);return this.http.get(Y)}async getBlockBrokenLinks(Q){let Z=this._getEndpoint("api_odes_block_get_broken_links");if(!Z){let X=window.eXeLearning?.config?.baseURL||"";return this.http.get(`${X}${this.basePath}/api/ode-management/odes/block/${Q}/brokenlinks`)}let Y=Z.replace("{odeBlockId}",Q);return this.http.get(Y)}async getIdeviceBrokenLinks(Q){let Z=this._getEndpoint("api_odes_idevice_get_broken_links");if(!Z){let X=window.eXeLearning?.config?.baseURL||"";return this.http.get(`${X}${this.basePath}/api/ode-management/odes/idevice/${Q}/brokenlinks`)}let Y=Z.replace("{odeIdeviceId}",Q);return this.http.get(Y)}isSupported(){return!0}}class O0{async getGoogleDriveLoginUrl(){throw Error("CloudStoragePort.getGoogleDriveLoginUrl() not implemented")}async getGoogleDriveFolders(){throw Error("CloudStoragePort.getGoogleDriveFolders() not implemented")}async uploadToGoogleDrive(Q){throw Error("CloudStoragePort.uploadToGoogleDrive() not implemented")}async getDropboxLoginUrl(){throw Error("CloudStoragePort.getDropboxLoginUrl() not implemented")}async getDropboxFolders(){throw Error("CloudStoragePort.getDropboxFolders() not implemented")}async uploadToDropbox(Q){throw Error("CloudStoragePort.uploadToDropbox() not implemented")}isSupported(){return!0}}class W2 extends O0{constructor(Q,Z={}){super();this.http=Q,this.endpoints=Z}_getEndpoint(Q){return this.endpoints[Q]?.path||null}async getGoogleDriveLoginUrl(){let Q=this._getEndpoint("api_google_oauth_login_url_get");if(!Q)return{responseMessage:"ENDPOINT_NOT_CONFIGURED",url:null};return this.http.get(Q)}async getGoogleDriveFolders(){let Q=this._getEndpoint("api_google_drive_folders_list");if(!Q)return{responseMessage:"ENDPOINT_NOT_CONFIGURED",folders:[]};return this.http.get(Q)}async uploadToGoogleDrive(Q){let Z=this._getEndpoint("api_google_drive_file_upload");if(!Z)return{responseMessage:"ENDPOINT_NOT_CONFIGURED"};return this.http.post(Z,Q)}async getDropboxLoginUrl(){let Q=this._getEndpoint("api_dropbox_oauth_login_url_get");if(!Q)return{responseMessage:"ENDPOINT_NOT_CONFIGURED",url:null};return this.http.get(Q)}async getDropboxFolders(){let Q=this._getEndpoint("api_dropbox_folders_list");if(!Q)return{responseMessage:"ENDPOINT_NOT_CONFIGURED",folders:[]};return this.http.get(Q)}async uploadToDropbox(Q){let Z=this._getEndpoint("api_dropbox_file_upload");if(!Z)return{responseMessage:"ENDPOINT_NOT_CONFIGURED"};return this.http.post(Z,Q)}isSupported(){return!0}}class F0{async uploadElp(Q){throw Error("PlatformIntegrationPort.uploadElp() not implemented")}async openElp(Q){throw Error("PlatformIntegrationPort.openElp() not implemented")}isSupported(){return!0}}class z2 extends F0{constructor(Q,Z={}){super();this.http=Q,this.endpoints=Z}_getEndpoint(Q){return this.endpoints[Q]?.path||null}async uploadElp(Q){let Z=this._getEndpoint("set_platform_new_ode");if(!Z)return{responseMessage:"ENDPOINT_NOT_CONFIGURED"};return this.http.post(Z,Q)}async openElp(Q){let Z=this._getEndpoint("open_platform_elp");if(!Z)return{responseMessage:"ENDPOINT_NOT_CONFIGURED"};return this.http.post(Z,Q)}isSupported(){return!0}}class M0{async getProject(Q){throw Error("SharingPort.getProject() not implemented")}async updateVisibility(Q,Z){throw Error("SharingPort.updateVisibility() not implemented")}async addCollaborator(Q,Z,Y="editor"){throw Error("SharingPort.addCollaborator() not implemented")}async removeCollaborator(Q,Z){throw Error("SharingPort.removeCollaborator() not implemented")}async transferOwnership(Q,Z){throw Error("SharingPort.transferOwnership() not implemented")}isSupported(){return!0}}class G2 extends M0{constructor(Q,Z={},Y=""){super();this.http=Q,this.endpoints=Z,this.basePath=Y}_getEndpoint(Q){return this.endpoints[Q]?.path||null}_buildUrl(Q){return`${window.eXeLearning?.config?.baseURL||""}${this.basePath}${Q}`}_isUuid(Q){return typeof Q==="string"&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(Q)}_getProjectPath(Q){if(this._isUuid(Q))return`/api/projects/uuid/${Q}`;return`/api/projects/${Q}`}async getProject(Q){let Z=this._getEndpoint("api_project_get");if(Z){let Y=Z.replace("{id}",Q);return this.http.get(Y)}return this.http.get(this._buildUrl(`${this._getProjectPath(Q)}/sharing`))}async updateVisibility(Q,Z){let Y=this._getEndpoint("api_project_visibility_update");if(Y){let X=Y.replace("{id}",Q);return this.http.put(X,{visibility:Z})}return this.http.patch(this._buildUrl(`${this._getProjectPath(Q)}/visibility`),{visibility:Z})}async addCollaborator(Q,Z,Y="editor"){let X=this._getEndpoint("api_project_collaborator_add");if(X){let J=X.replace("{id}",Q);return this.http.post(J,{email:Z,role:Y})}return this.http.post(this._buildUrl(`${this._getProjectPath(Q)}/collaborators`),{email:Z,role:Y})}async removeCollaborator(Q,Z){let Y=this._getEndpoint("api_project_collaborator_remove");if(Y){let X=Y.replace("{id}",Q).replace("{userId}",Z);return this.http.delete(X)}return this.http.delete(this._buildUrl(`${this._getProjectPath(Q)}/collaborators/${Z}`))}async transferOwnership(Q,Z){let Y=this._getEndpoint("api_project_transfer_ownership");if(Y){let X=Y.replace("{id}",Q);return this.http.post(X,{newOwnerId:Z})}return this.http.patch(this._buildUrl(`${this._getProjectPath(Q)}/owner`),{newOwnerId:Z})}isSupported(){return!0}}class q2 extends z0{constructor(Q={}){super();this.dbPrefix=Q.dbPrefix||"exelearning-project-"}async list(){try{if(!window.indexedDB?.databases)return console.log("[StaticProjectRepository] indexedDB.databases() not supported"),[];let Z=(await window.indexedDB.databases()).filter((X)=>X.name?.startsWith(this.dbPrefix));return(await Promise.all(Z.map(async(X)=>{let J=X.name.replace(this.dbPrefix,""),W=await this._getProjectMetadata(J);return{uuid:J,id:J,title:W?.title||`Local Project (${J.substring(0,8)}...)`,updatedAt:W?.updatedAt||new Date().toISOString(),isLocal:!0}}))).sort((X,J)=>new Date(J.updatedAt)-new Date(X.updatedAt))}catch(Q){return console.error("[StaticProjectRepository] list error:",Q),[]}}async get(Q){try{let Z=await this._getProjectMetadata(Q);if(!Z)return null;return{uuid:Q,id:Q,...Z,isLocal:!0}}catch(Z){return console.error("[StaticProjectRepository] get error:",Z),null}}async create(Q){let Z=Q.uuid||crypto.randomUUID(),Y=new Date().toISOString(),X={uuid:Z,title:Q.title||"Untitled Project",createdAt:Y,updatedAt:Y};return await this._saveProjectMetadata(Z,X),{uuid:Z,id:Z,...X,isLocal:!0}}async update(Q,Z){let Y=await this.get(Q);if(!Y)throw new i("project",Q);let X={...Y,...Z,updatedAt:new Date().toISOString()};return await this._saveProjectMetadata(Q,X),{uuid:Q,id:Q,...X,isLocal:!0}}async delete(Q){try{let Z=`${this.dbPrefix}${Q}`;await new Promise((Y,X)=>{let J=window.indexedDB.deleteDatabase(Z);J.onsuccess=()=>Y(),J.onerror=()=>X(new g(`Failed to delete database: ${Z}`)),J.onblocked=()=>{console.warn(`[StaticProjectRepository] Database deletion blocked: ${Z}`),Y()}})}catch(Z){throw console.error("[StaticProjectRepository] delete error:",Z),new g(`Failed to delete project: ${Z.message}`)}}async getRecent(Q=3){return(await this.list()).slice(0,Q)}async exists(Q){return await this.get(Q)!==null}async _getProjectMetadata(Q){try{let Z=`${this.dbPrefix}${Q}`,Y=await this._openDatabase(Z);if(!Y)return null;let X=await this._getFromStore(Y,"metadata","project");return Y.close(),X}catch(Z){return console.error("[StaticProjectRepository] _getProjectMetadata error:",Z),null}}async _saveProjectMetadata(Q,Z){let Y=`${this.dbPrefix}${Q}`;return new Promise((X,J)=>{let W=window.indexedDB.open(Y,1);W.onerror=()=>{J(new g(`Failed to open database: ${Y}`))},W.onupgradeneeded=(z)=>{let G=z.target.result;if(!G.objectStoreNames.contains("metadata"))G.createObjectStore("metadata",{keyPath:"key"})},W.onsuccess=(z)=>{let G=z.target.result;try{let q=G.transaction(["metadata"],"readwrite");q.objectStore("metadata").put({key:"project",...Z}),q.oncomplete=()=>{G.close(),X()},q.onerror=()=>{G.close(),J(new g("Transaction failed"))}}catch(q){G.close(),J(q)}}})}async _openDatabase(Q){return new Promise((Z)=>{let Y=window.indexedDB.open(Q);Y.onerror=()=>{Z(null)},Y.onsuccess=(X)=>{Z(X.target.result)}})}async _getFromStore(Q,Z,Y){return new Promise((X)=>{try{if(!Q.objectStoreNames.contains(Z)){X(null);return}let z=Q.transaction([Z],"readonly").objectStore(Z).get(Y);z.onsuccess=()=>{X(z.result||null)},z.onerror=()=>{X(null)}}catch{X(null)}})}async save(Q,Z){return console.log("[StaticProjectRepository] save handled by Yjs/IndexedDB"),{responseMessage:"OK",staticMode:!0}}async autoSave(Q,Z){console.log("[StaticProjectRepository] autosave handled by Yjs persistence")}async saveAs(Q,Z){return console.log("[StaticProjectRepository] saveAs handled client-side"),{responseMessage:"OK",staticMode:!0}}async duplicate(Q){return console.warn("[StaticProjectRepository] duplicate not supported in static mode"),{responseMessage:"NOT_SUPPORTED_IN_STATIC_MODE"}}async getLastUpdated(Q){try{return{lastUpdated:(await this._getProjectMetadata(Q))?.updatedAt||null,staticMode:!0}}catch(Z){return console.error("[StaticProjectRepository] getLastUpdated error:",Z),{lastUpdated:null}}}async getConcurrentUsers(Q,Z,Y){return{users:[],staticMode:!0}}async closeSession(Q){return console.log("[StaticProjectRepository] closeSession - no-op in static mode"),{responseMessage:"OK",staticMode:!0}}async joinSession(Q){return{available:!0,staticMode:!0}}async checkCurrentUsers(Q){return{responseMessage:"OK",currentUsers:0,staticMode:!0}}async openFile(Q){return{responseMessage:"OK",odeSessionId:window.eXeLearning?.projectId}}async openLocalFile(Q){return{responseMessage:"OK",odeSessionId:window.eXeLearning?.projectId}}async openLargeLocalFile(Q){return{responseMessage:"OK",odeSessionId:window.eXeLearning?.projectId}}async getLocalProperties(Q){return{responseMessage:"OK",properties:{}}}async getLocalComponents(Q){return{responseMessage:"OK",components:[]}}async importToRoot(Q){return{responseMessage:"OK"}}async importToRootFromLocal(Q){return{responseMessage:"OK"}}async importAsChild(Q,Z){return{responseMessage:"OK"}}async openMultipleLocalFiles(Q){return{responseMessage:"OK"}}async deleteByDate(Q){return{responseMessage:"OK"}}async cleanAutosaves(Q){return{responseMessage:"OK"}}async getStructure(Q,Z){return{structure:null}}async getProperties(Q){return{responseMessage:"OK",properties:window.eXeLearning?.app?.apiCallManager?.parameters?.odeProjectSyncPropertiesConfig||{}}}async saveProperties(Q){return{responseMessage:"OK"}}async getUsedFiles(Q){return{responseMessage:"OK",usedFiles:[]}}}class H2 extends G0{constructor(Q={},Z=null){super();this.bundle=Q,this.dataProvider=Z,this._cache=new Map}async _getData(Q,Z=null){if(this._cache.has(Q))return this._cache.get(Q);if(this.bundle[Q])return this._cache.set(Q,this.bundle[Q]),this.bundle[Q];if(this.dataProvider){let Y=`get${Q.charAt(0).toUpperCase()+Q.slice(1)}`;if(typeof this.dataProvider[Y]==="function"){let X=await this.dataProvider[Y]();return this._cache.set(Q,X),X}}return Z}async getIDevices(){let Q=await this._getData("idevices");if(Q)return Q;if(this.dataProvider?.getInstalledIdevices)return this.dataProvider.getInstalledIdevices();return[]}async getThemes(){let Q=await this._getData("themes");if(Q)return Q;if(this.dataProvider?.getInstalledThemes)return this.dataProvider.getInstalledThemes();return[]}async getLocales(){let Q=await this._getData("locales");if(Q)return Q;return[{code:"en",name:"English"},{code:"es",name:"Español"},{code:"ca",name:"Català"},{code:"eu",name:"Euskara"},{code:"gl",name:"Galego"},{code:"pt",name:"Português"}]}async getTranslations(Q){if(this.bundle.translations?.[Q])return this.bundle.translations[Q];try{let Z=await fetch(`./translations/${Q}.json`);if(Z.ok){let Y=await Z.json();if(!this.bundle.translations)this.bundle.translations={};return this.bundle.translations[Q]=Y,Y}}catch{}return{}}async getIDevice(Q){return(await this.getIDevices()).find((Y)=>Y.id===Q||Y.name===Q)||null}async getTheme(Q){return(await this.getThemes()).find((Y)=>Y.id===Q||Y.name===Q)||null}async getLicenses(){let Q=await this._getData("licenses");if(Q)return Q;return[{id:"cc-by",name:"CC BY 4.0"},{id:"cc-by-sa",name:"CC BY-SA 4.0"},{id:"cc-by-nc",name:"CC BY-NC 4.0"},{id:"cc-by-nc-sa",name:"CC BY-NC-SA 4.0"},{id:"cc-by-nd",name:"CC BY-ND 4.0"},{id:"cc-by-nc-nd",name:"CC BY-NC-ND 4.0"},{id:"public-domain",name:"Public Domain"}]}async getExportFormats(){return[{id:"html5",name:"Website (HTML5)",extension:"zip"},{id:"scorm12",name:"SCORM 1.2",extension:"zip"},{id:"scorm2004",name:"SCORM 2004",extension:"zip"},{id:"ims",name:"IMS Content Package",extension:"zip"},{id:"epub3",name:"ePub 3",extension:"epub"}]}async getApiParameters(){if(this.dataProvider?.getApiParameters)return this.dataProvider.getApiParameters();return this.bundle.apiParameters||{routes:{}}}async getUploadLimits(){if(this.dataProvider?.getUploadLimits)return this.dataProvider.getUploadLimits();return{maxFileSize:104857600,maxFileSizeFormatted:"100 MB",limitingFactor:"none"}}async getTemplates(){return{templates:[],locale:"en"}}async getChangelog(){try{let Q=await fetch("./CHANGELOG.md");return Q.ok?Q.text():""}catch{return""}}async getThirdPartyCode(){try{let Q=await fetch("./libs/README.md");return Q.ok?Q.text():""}catch{return""}}async getLicensesList(){try{let Q=await fetch("./libs/LICENSES");return Q.ok?Q.text():""}catch{return""}}async getComponentHtmlTemplate(Q){return{responseMessage:"OK",htmlTemplate:""}}async createTheme(){return console.warn("[StaticCatalogAdapter] Theme creation not supported in offline mode"),{responseMessage:"NOT_SUPPORTED"}}async updateTheme(){return console.warn("[StaticCatalogAdapter] Theme editing not supported in offline mode"),{responseMessage:"NOT_SUPPORTED"}}async getSaveHtmlView(Q){return{responseMessage:"OK",htmlView:""}}async getIdevicesBySessionId(Q){return console.warn("[StaticCatalogAdapter] Games API not available in offline mode"),{responseMessage:"NOT_SUPPORTED",idevices:[]}}}class K2 extends q0{constructor(Q={}){super();this.dbPrefix=Q.dbPrefix||"exelearning-assets-",this.storeName=Q.storeName||"assets"}async _openDatabase(Q){let Z=`${this.dbPrefix}${Q}`;return new Promise((Y,X)=>{let J=window.indexedDB.open(Z,1);J.onerror=()=>{X(new g(`Failed to open asset database: ${Z}`))},J.onupgradeneeded=(W)=>{let z=W.target.result;if(!z.objectStoreNames.contains(this.storeName))z.createObjectStore(this.storeName,{keyPath:"path"})},J.onsuccess=(W)=>{Y(W.target.result)}})}async upload(Q,Z,Y){let X=await this._openDatabase(Q);try{let J=await Z.arrayBuffer(),W={path:Y,name:Z.name,type:Z.type,size:Z.size,data:J,createdAt:new Date().toISOString()};return await new Promise((z,G)=>{let q=X.transaction([this.storeName],"readwrite");q.objectStore(this.storeName).put(W),q.oncomplete=()=>z(),q.onerror=()=>G(new g("Failed to store asset"))}),{path:Y,url:await this.getUrl(Q,Y)}}finally{X.close()}}async getUrl(Q,Z){let Y=await this.getBlob(Q,Z);return URL.createObjectURL(Y)}async getBlob(Q,Z){let Y=await this._openDatabase(Q);try{let X=await new Promise((J,W)=>{let q=Y.transaction([this.storeName],"readonly").objectStore(this.storeName).get(Z);q.onsuccess=()=>J(q.result),q.onerror=()=>W(new g("Failed to read asset"))});if(!X)throw new i("asset",Z);return new Blob([X.data],{type:X.type})}finally{Y.close()}}async delete(Q,Z){let Y=await this._openDatabase(Q);try{await new Promise((X,J)=>{let W=Y.transaction([this.storeName],"readwrite");W.objectStore(this.storeName).delete(Z),W.oncomplete=()=>X(),W.onerror=()=>J(new g("Failed to delete asset"))})}finally{Y.close()}}async list(Q,Z=""){let Y=await this._openDatabase(Q);try{let X=await new Promise((W,z)=>{let H=Y.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();H.onsuccess=()=>W(H.result||[]),H.onerror=()=>z(new g("Failed to list assets"))}),J=X;if(Z){let W=Z.endsWith("/")?Z:`${Z}/`;J=X.filter((z)=>z.path.startsWith(W))}return J.map((W)=>({path:W.path,name:W.name,size:W.size,type:W.type}))}finally{Y.close()}}async exists(Q,Z){let Y=await this._openDatabase(Q);try{let X=await new Promise((J)=>{let G=Y.transaction([this.storeName],"readonly").objectStore(this.storeName).get(Z);G.onsuccess=()=>J(G.result),G.onerror=()=>J(null)});return X!==null&&X!==void 0}finally{Y.close()}}async copy(Q,Z,Y){let X=await this.getBlob(Q,Z),J=new File([X],Y.split("/").pop(),{type:X.type});await this.upload(Q,J,Y)}async move(Q,Z,Y){await this.copy(Q,Z,Y),await this.delete(Q,Z)}async clearAll(Q){let Z=`${this.dbPrefix}${Q}`;return new Promise((Y,X)=>{let J=window.indexedDB.deleteDatabase(Z);J.onsuccess=()=>Y(),J.onerror=()=>X(new g(`Failed to delete asset database: ${Z}`)),J.onblocked=()=>{console.warn(`[StaticAssetAdapter] Database deletion blocked: ${Z}`),Y()}})}}class V2 extends H0{isEnabled(){return!1}async connect(Q){}async disconnect(){}async getPresence(){return[{clientId:0,userId:"local",username:"You",color:"#4285f4",cursor:null}]}async updatePresence(Q){}onPresenceChange(Q){return()=>{}}getWebSocketUrl(){return null}async obtainBlockSync(Q){return{responseMessage:"OK",block:null}}}class R2 extends K0{constructor(Q={}){super();this.getExporter=Q.getExporter||(()=>window.eXeLearning?.app?.elpxExporter)}async exportAs(Q,Z,Y={}){let X=this.getExporter();if(!X)throw Error("Exporter not available");switch(Q){case"html5":return X.exportToHtml5(Z,Y);case"scorm12":return X.exportToScorm12(Z,Y);case"scorm2004":return X.exportToScorm2004(Z,Y);case"ims":return X.exportToIms(Z,Y);case"epub3":return X.exportToEpub3(Z,Y);case"xliff":return X.exportToXliff(Z,Y);default:throw Error(`Unsupported export format: ${Q}`)}}async getSupportedFormats(){return[{id:"html5",name:"Website (HTML5)",extension:"zip"},{id:"scorm12",name:"SCORM 1.2",extension:"zip"},{id:"scorm2004",name:"SCORM 2004",extension:"zip"},{id:"ims",name:"IMS Content Package",extension:"zip"},{id:"epub3",name:"ePub 3",extension:"epub"},{id:"xliff",name:"XLIFF",extension:"xliff"}]}async isFormatSupported(Q){return(await this.getSupportedFormats()).some((Y)=>Y.id===Q)}async generatePreview(Q){let Z=this.getExporter();if(!Z)throw Error("Exporter not available");return Z.generatePreviewHtml(Q)}async exportAsElpx(Q,Z){let Y=this.getExporter();if(!Y)throw Error("Exporter not available");return Y.exportToElpx(Q,Z)}async getPreviewUrl(Q){return{responseMessage:"OK",clientSidePreview:!0}}async downloadIDevice(Q,Z,Y){return console.warn("[StaticExportAdapter] iDevice download not supported in static mode"),{url:"",response:"",responseMessage:"NOT_SUPPORTED_IN_STATIC_MODE"}}}class A2 extends V0{constructor(Q=null){super();this.dataProvider=Q}async savePage(Q){return{responseMessage:"OK"}}async reorderPage(Q){return{responseMessage:"OK"}}async clonePage(Q){return{responseMessage:"OK"}}async deletePage(Q){return{responseMessage:"OK"}}async reorderBlock(Q){return{responseMessage:"OK"}}async deleteBlock(Q){return{responseMessage:"OK"}}async reorderIdevice(Q){return{responseMessage:"OK"}}async saveIdevice(Q){return{responseMessage:"OK"}}async cloneIdevice(Q){return{responseMessage:"OK"}}async deleteIdevice(Q){return{responseMessage:"OK"}}async send(Q,Z){return console.warn(`[StaticContentAdapter] Endpoint ${Q} not available in offline mode`),{responseMessage:"OK"}}}class O2 extends R0{constructor(Q={}){super();this.defaultPreferences=Q.defaultPreferences||{},this.storageKey=Q.storageKey||"exelearning_user_preferences",this.lopdKey="exelearning_lopd_accepted"}_getDefaultPreferences(){let Q={locale:{title:"Language",value:"en",type:"select"},advancedMode:{title:"Advanced Mode",value:"false",type:"checkbox"},versionControl:{title:"Version Control",value:"false",type:"checkbox"}},Z=window.eXeLearning?.app?.apiCall?.parameters?.userPreferencesConfig||window.eXeLearning?.app?.api?.parameters?.userPreferencesConfig;if(Z){let Y=JSON.parse(JSON.stringify(Z));for(let X of Object.keys(Q))if(!Y[X]||Y[X].value===null||Y[X].value===void 0)Y[X]={...Q[X]};return Y}if(Object.keys(this.defaultPreferences).length>0){let Y=JSON.parse(JSON.stringify(this.defaultPreferences));for(let X of Object.keys(Q))if(!Y[X]||Y[X].value===null||Y[X].value===void 0)Y[X]={...Q[X]};return Y}return{...Q}}_loadStoredPreferences(){try{let Q=localStorage.getItem(this.storageKey);return Q?JSON.parse(Q):{}}catch(Q){return console.warn("[StaticUserPreferenceAdapter] Failed to load preferences:",Q),{}}}_saveStoredPreferences(Q){try{return localStorage.setItem(this.storageKey,JSON.stringify(Q)),!0}catch(Z){return console.warn("[StaticUserPreferenceAdapter] Failed to save preferences:",Z),!1}}async getPreferences(){let Q=this._getDefaultPreferences(),Z=this._loadStoredPreferences();for(let[Y,X]of Object.entries(Z))if(Q[Y])Q[Y].value=X;return{userPreferences:Q}}async savePreferences(Q){let Z=this._loadStoredPreferences();return Object.assign(Z,Q),{success:this._saveStoredPreferences(Z)}}async acceptLopd(){try{return localStorage.setItem(this.lopdKey,"true"),{success:!0}}catch(Q){return console.warn("[StaticUserPreferenceAdapter] Failed to save LOPD acceptance:",Q),{success:!1}}}async isLopdAccepted(){try{return localStorage.getItem(this.lopdKey)==="true"}catch{return!1}}async getPreference(Q,Z=null){let Y=this._loadStoredPreferences();return Y[Q]!==void 0?Y[Q]:Z}async setPreference(Q,Z){let Y=this._loadStoredPreferences();return Y[Q]=Z,{success:this._saveStoredPreferences(Y)}}}class F2 extends A0{async getSessionBrokenLinks(){return{responseMessage:"OK",brokenLinks:[]}}async extractLinks(){return{responseMessage:"OK",links:[],totalLinks:0}}getValidationStreamUrl(){return null}async getPageBrokenLinks(){return{brokenLinks:[]}}async getBlockBrokenLinks(){return{brokenLinks:[]}}async getIdeviceBrokenLinks(){return{brokenLinks:[]}}isSupported(){return!1}}class M2 extends O0{async getGoogleDriveLoginUrl(){return{responseMessage:"NOT_SUPPORTED",url:null}}async getGoogleDriveFolders(){return{responseMessage:"NOT_SUPPORTED",folders:[]}}async uploadToGoogleDrive(){return{responseMessage:"NOT_SUPPORTED"}}async getDropboxLoginUrl(){return{responseMessage:"NOT_SUPPORTED",url:null}}async getDropboxFolders(){return{responseMessage:"NOT_SUPPORTED",folders:[]}}async uploadToDropbox(){return{responseMessage:"NOT_SUPPORTED"}}isSupported(){return!1}}class U2 extends F0{async uploadElp(){return{responseMessage:"NOT_SUPPORTED"}}async openElp(){return{responseMessage:"NOT_SUPPORTED"}}isSupported(){return!1}}class L2 extends M0{async getProject(Q){return{responseMessage:"NOT_SUPPORTED"}}async updateVisibility(Q,Z){return{responseMessage:"NOT_SUPPORTED"}}async addCollaborator(Q,Z,Y){return{responseMessage:"NOT_SUPPORTED"}}async removeCollaborator(Q,Z){return{responseMessage:"NOT_SUPPORTED"}}async transferOwnership(Q,Z){return{responseMessage:"NOT_SUPPORTED"}}isSupported(){return!1}}class U0{constructor(Q,Z){this.config=Q,this.capabilities=Z}static async create(){let Q=m.fromEnvironment(),Z=new X0(Q);if(Q.isStaticMode()||Q.isElectronMode()){let X={};try{let J=await fetch(Q.staticDataPath||"./data/bundle.json");if(J.ok)X=await J.json()}catch(J){console.warn("[ProviderFactory] Failed to load bundle data:",J)}return new E2(Q,Z,X)}let Y=new P2(Q,Z);return await Y.loadEndpoints(),Y}getConfig(){return this.config}getCapabilities(){return this.capabilities}createProjectRepository(){throw Error("ProviderFactory.createProjectRepository() not implemented")}createCatalogAdapter(){throw Error("ProviderFactory.createCatalogAdapter() not implemented")}createAssetAdapter(){throw Error("ProviderFactory.createAssetAdapter() not implemented")}createCollaborationAdapter(){throw Error("ProviderFactory.createCollaborationAdapter() not implemented")}createExportAdapter(){throw Error("ProviderFactory.createExportAdapter() not implemented")}createContentAdapter(){throw Error("ProviderFactory.createContentAdapter() not implemented")}createUserPreferencesAdapter(){throw Error("ProviderFactory.createUserPreferencesAdapter() not implemented")}createLinkValidationAdapter(){throw Error("ProviderFactory.createLinkValidationAdapter() not implemented")}createCloudStorageAdapter(){throw Error("ProviderFactory.createCloudStorageAdapter() not implemented")}createPlatformIntegrationAdapter(){throw Error("ProviderFactory.createPlatformIntegrationAdapter() not implemented")}createSharingAdapter(){throw Error("ProviderFactory.createSharingAdapter() not implemented")}createAllAdapters(){return{projectRepo:this.createProjectRepository(),catalog:this.createCatalogAdapter(),assets:this.createAssetAdapter(),collaboration:this.createCollaborationAdapter(),exportAdapter:this.createExportAdapter(),content:this.createContentAdapter(),userPreferences:this.createUserPreferencesAdapter(),linkValidation:this.createLinkValidationAdapter(),cloudStorage:this.createCloudStorageAdapter(),platformIntegration:this.createPlatformIntegrationAdapter(),sharing:this.createSharingAdapter()}}}class P2 extends U0{constructor(Q,Z){super(Q,Z);this.httpClient=new a1(Q.baseUrl),this.basePath=window.eXeLearning?.config?.basePath||"",this._endpoints=null}async loadEndpoints(){if(this._endpoints)return this._endpoints;try{let Q=`${this.basePath}/api/parameter-management/parameters/data/list`,Z=await this.httpClient.get(Q);this._endpoints={};for(let[Y,X]of Object.entries(Z.routes||{}))this._endpoints[Y]={path:this.config.baseUrl+X.path,methods:X.methods}}catch(Q){console.warn("[ServerProviderFactory] Failed to load endpoints:",Q),this._endpoints={}}return this._endpoints}createProjectRepository(){return new t1(this.httpClient,this.basePath)}createCatalogAdapter(){return new e1(this.httpClient,this._endpoints||{})}createAssetAdapter(){return new _2(this.httpClient,this.basePath)}createCollaborationAdapter(){return new $2(this.config.wsUrl,this.basePath)}createExportAdapter(){return new Q2(this.httpClient,this._endpoints||{},this.basePath)}createContentAdapter(){return new Z2(this.httpClient,this._endpoints||{})}createUserPreferencesAdapter(){return new X2(this.httpClient,this._endpoints||{},this.basePath)}createLinkValidationAdapter(){return new J2(this.httpClient,this._endpoints||{},this.basePath)}createCloudStorageAdapter(){return new W2(this.httpClient,this._endpoints||{})}createPlatformIntegrationAdapter(){return new z2(this.httpClient,this._endpoints||{})}createSharingAdapter(){return new G2(this.httpClient,this._endpoints||{},this.basePath)}}class E2 extends U0{constructor(Q,Z,Y={}){super(Q,Z);this.bundleData=Y}createProjectRepository(){return new q2}createCatalogAdapter(){let Q=window.eXeLearning?.app?.dataProvider||null;return new H2(this.bundleData,Q)}createAssetAdapter(){return new K2}createCollaborationAdapter(){return new V2}createExportAdapter(){return new R2}createContentAdapter(){let Q=window.eXeLearning?.app?.dataProvider||null;return new A2(Q)}createUserPreferencesAdapter(){return new O2}createLinkValidationAdapter(){return new F2}createCloudStorageAdapter(){return new M2}createPlatformIntegrationAdapter(){return new U2}createSharingAdapter(){return new L2}}class l1{constructor(Q){if(this.eXeLearning=Q,this.parseExelearningConfig(),this.initializeDataProvider(),this.api=new B0(this),this.locale=new D0(this),this.common=new x0(this),this.toasts=new y0(this),this.idevices=new S0(this),this.themes=new v1(this),this.project=new k0(this),this.interface=new B1(this),this.modals=new q1(this),this.menus=new h1(this),this.user=new u1(this),this.actions=new m1(this),this.shortcuts=new c1(this),this.sessionMonitor=null,this.sessionExpirationHandled=!1,!this.eXeLearning.config.isOfflineInstallation)this.setupSessionMonitor()}async init(){await this.dataProvider.init(),await this.initializeAdapters(),this.initializedToasts(),this.initializedModals(),await this.loadApiParameters(),await this.loadLocale(),await this.loadIdevicesInstalled(),await this.loadThemesInstalled(),await this.loadUser(),await this.showModalLopd(),await this.showProvisionalDemoWarning(),await this.tmpStringList(),await this.addNoTranslateForGoogle(),await this.runCustomJavaScriptCode(),await this.initializedShortcuts(),this.bindElectronDownloadToasts(),this.bindElectronFileOpenHandler(),this.initExePackageProtocolHandler()}initExePackageProtocolHandler(){document.addEventListener("click",async(Q)=>{if(!Q.target.closest('a[href="exe-package:elp"]'))return;if(Q.preventDefault(),Q.stopPropagation(),!this.project?._yjsEnabled||!this.project?.exportToElpxViaYjs){this.modals.alert.show({title:_("Error"),body:_("Project not loaded or Yjs not enabled"),contentId:"error"});return}let Y={title:_("Download"),body:_("Generating ELPX file..."),icon:"downloading"},X=this.toasts.createToast(Y);try{await this.project.exportToElpxViaYjs(),X.toastBody.innerHTML=_("File generated and downloaded.")}catch(J){console.error("[exe-package:elp] Error:",J),X.toastBody.innerHTML=_("Error generating ELPX file."),X.toastBody.classList.add("error"),this.modals.alert.show({title:_("Error"),body:J.message||_("Unknown error."),contentId:"error"})}setTimeout(()=>{X.remove()},2000)})}parseExelearningConfig(){if(window.eXeLearning.user=JSON.parse(window.eXeLearning.user.replace(/&quot;/g,'"')),window.eXeLearning.config=JSON.parse(window.eXeLearning.config.replace(/&quot;/g,'"')),new URL(window.location.href).protocol==="https:")["baseURL","fullURL","changelogURL"].forEach((X)=>{if(window.eXeLearning.config[X]&&window.eXeLearning.config[X].startsWith("http://"))window.eXeLearning.config[X]=window.eXeLearning.config[X].replace("http://","https://")});window.eXeLearning.symfony={baseURL:window.eXeLearning.config.baseURL||"",basePath:window.eXeLearning.config.basePath||"",fullURL:window.eXeLearning.config.fullURL||""}}initializeDataProvider(){this.runtimeConfig=m.fromEnvironment(),this.capabilities=new X0(this.runtimeConfig);let Q=this.runtimeConfig.isStaticMode();this.eXeLearning.config.isStaticMode=Q;let Z=Q?"static":"server",Y=this.eXeLearning.config.basePath||"";if(this.dataProvider=new Y0(Z,{basePath:Y}),Q)console.log("[App] Running in STATIC/OFFLINE mode"),this.eXeLearning.config.isOfflineInstallation=!0;console.log("[App] Capabilities:",{collaboration:this.capabilities.collaboration.enabled,remoteStorage:this.capabilities.storage.remote,auth:this.capabilities.auth.required})}async initializeAdapters(){try{let Q=await U0.create(),Z=Q.createAllAdapters();this.api.setAdapters(Z),this.providerFactory=Q,this.capabilities=Q.getCapabilities(),console.log("[App] Adapters injected successfully:",{mode:Q.getConfig().mode,adaptersInjected:Object.keys(Z).length})}catch(Q){console.error("[App] Failed to initialize adapters:",Q)}}detectStaticMode(){if(this.runtimeConfig)return this.runtimeConfig.isStaticMode();if(window.__EXE_STATIC_MODE__===!0)return!0;if(window.location.protocol==="file:")return!0;if(!this.eXeLearning.config.fullURL)return!0;return!1}setupSessionMonitor(){let Q=Number(this.eXeLearning.config.sessionCheckIntervalMs||this.eXeLearning.config.sessionCheckInterval||0),Z=Q>0?Q:60000,Y=this.composeUrl("/api/session/check"),X=this.composeUrl("/login");this.sessionMonitor=new p1({checkUrl:Y,loginUrl:X,interval:Z,closeYjsConnections:(J)=>this.closeYjsConnections(J),onSessionInvalid:(J)=>this.handleSessionExpiration(J),onNetworkError:(J,W)=>{console.debug("SessionMonitor: temporary issue while checking the session",W,J)}}),window.eXeSessionMonitor=this.sessionMonitor,this.sessionMonitor.start()}getBasePath(){let Q=this.eXeLearning.config?.basePath??"";if(!Q||Q==="/")return"";return Q.replace(/\/+$/,"")}composeUrl(Q=""){let Z=Q.startsWith("/")?Q:`/${Q}`,Y=this.getBasePath();if(!Y)return Z;return`${Y}${Z}`}closeYjsConnections(Q){console.debug("Closing Yjs connections due to:",Q);let Z=this.project?._yjsBridge;if(Z?.manager)try{if(Z.manager.wsProvider)Z.manager.wsProvider.disconnect(),console.debug("Yjs WebSocket disconnected")}catch(Y){console.debug("SessionMonitor: error while closing Yjs WebSocket",Y)}if(window.yjsDocumentManager?.wsProvider)try{window.yjsDocumentManager.wsProvider.disconnect()}catch(Y){console.debug("SessionMonitor: error while closing global Yjs WebSocket",Y)}}handleSessionExpiration(Q){if(this.sessionExpirationHandled)return;this.sessionExpirationHandled=!0;try{this.project?.cleanupCurrentIdeviceTimer?.()}catch(Z){console.debug("SessionMonitor: error while cleaning up timers during logout",Z)}try{let Z=this.project?._yjsBridge;if(Z)Z.destroy?.()}catch(Z){console.debug("SessionMonitor: error while cleaning up Yjs bridge during logout",Z)}console.info("Session expired, redirecting to login.",Q)}isStaticMode(){if(this.runtimeConfig)return this.runtimeConfig.isStaticMode();return this.dataProvider?.isStaticMode()??!1}async loadApiParameters(){await this.api.loadApiParameters()}async loadIdevicesInstalled(){await this.idevices.loadIdevicesFromAPI()}async loadThemesInstalled(){await this.themes.loadThemesFromAPI()}async loadProject(){await this.project.load()}async loadUser(){await this.user.loadUserPreferences()}async loadInstallationType(){await this.project.reloadInstallationType()}async loadLocale(){await this.locale.init()}async initializedToasts(){this.toasts.init()}async initializedModals(){this.modals.init(),this.modals.behaviour()}async selectFirstNodeStructure(){await this.project.structure.selectFirst()}async ideviceEngineBehaviour(){this.project.idevices.behaviour()}async check(){if(!this.capabilities?.storage?.remote)return;if(!this.eXeLearning.config?.filesDirPermission?.checked){let Q="";if((this.eXeLearning.config?.filesDirPermission?.info||[]).forEach((Y)=>{Q+=`<p>${Y}</p>`}),Q)this.modals.alert.show({title:_("Permissions error"),body:Q,contentId:"error"})}}async showModalLopd(){if(!this.capabilities?.auth?.required){await this.loadProject(),this.check();return}if(!eXeLearning.user.acceptedLopd)await this.project.loadModalsContent(),this.interface.loadingScreen.hide(),document.querySelector("#node-content-container").style.display="none",this.modals.lopd.modal._config.keyboard=!1,this.modals.lopd.modal._config.backdrop="static",this.modals.lopd.modal._ignoreBackdropClick=!0,this.modals.lopd.show({});else await this.loadProject(),this.check()}async tmpStringList(){let Q=[_("Create image maps: Images with interactive hotspots to reveal images, videos, sounds, texts..."),_("Show questionnaire"),_("Show active areas"),_("Click here to do this activity"),_('Select the correct options and click on the "Reply" button.'),_('Mark all the options in the correct order and click on the "Reply" button.'),_('Write the correct word o phrase and click on the "Reply" button.'),_("Click on"),_("Everything is perfect! Do you want to repeat this activity?"),_("Great! You have passed the test, but you can improve it surely. Do you want to repeat this activity?"),_("Almost perfect! You can still do it better. Do you want to repeat this activity?"),_("It is not correct! You have clicked on"),_("and the correct answer is"),_("Great! You have visited the required dots."),_("You can do the test."),_("Select a subtitle file. Supported formats:"),_("Map"),_("Return"),_("Questionnarie"),_("Arrow"),_("Map marker"),_("Do you want to save the changes of this presentation?"),_("Do you want to save the changes of this quiz?"),_("Do you want to save the changes of this map?"),_("Provide a slide title."),_("Hide score bar"),_("Play the sound when scrolling the mouse over the points."),_("Show when the mouse is over the icon or active area."),_("Hide areas")]}async addNoTranslateForGoogle(){$(".exe-icon, .auto-icon, #nav_list .root-icon").each(function(){$(this).addClass("notranslate")})}async runCustomJavaScriptCode(){try{$eXeLearningCustom.init()}catch(Q){}}async initializedShortcuts(){this.shortcuts.init()}bindElectronDownloadToasts(){if(!window.electronAPI||typeof window.electronAPI.onDownloadDone!=="function")return;try{window.electronAPI.onDownloadDone(({ok:Q,path:Z,error:Y})=>{let X=(J)=>(J||"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;");if(Q){let J={title:_("Saved"),body:`Saved to: <code>${X(Z)}</code>`,icon:"task_alt",remove:3500};this.toasts.createToast(J)}else{let J={title:_("Error"),body:X(Y||_("Unknown error.")),icon:"error",error:!0,remove:5000};this.toasts.createToast(J)}})}catch(Q){}}bindElectronFileOpenHandler(){if(!window.electronAPI||typeof window.electronAPI.onOpenFile!=="function")return;window.electronAPI.onOpenFile(async(Q)=>{console.log("[App] Received file to open:",Q),await this.openFileFromPath(Q)})}async openFileFromPath(Q){try{let Z=await window.electronAPI.readFile(Q);if(!Z||!Z.ok){console.error("[App] Error reading file:",Z?.error);return}let Y=atob(Z.base64),X=new Uint8Array(Y.length);for(let G=0;G<Y.length;G++)X[G]=Y.charCodeAt(G);let J=new Blob([X],{type:"application/octet-stream"}),W=Q.split(/[\\/]/).pop()||"project.elpx",z=new File([J],W,{type:"application/octet-stream",lastModified:Z.mtimeMs||Date.now()});if(window.electronAPI&&window.electronAPI.setSavedPath){let G=this.project?.odeSession||"default";await window.electronAPI.setSavedPath(G,Q)}this.modals.openuserodefiles.largeFilesUpload(z)}catch(Z){console.error("[App] Error opening file:",Z)}}async showProvisionalDemoWarning(){if(eXeLearning.version.indexOf("-alpha")===-1&&eXeLearning.version.indexOf("-beta")===-1&&eXeLearning.version.indexOf("-rc")===-1)return;let Q=_("eXeLearning %s is a development version. It is not for production use.");if($("body").attr("installation-type")=="offline"){Q=_("This is just a demo version. Not for real projects.");var Z=eXeLearning.expires;if(Z.length==8){if(Z=parseInt(Z),!isNaN(Z)&&Z!=-1){var Y=new Date;if(Y=Y.toISOString().slice(0,10).replace(/-/g,""),Y.length==8)if(Y>=Z){Q=_("eXeLearning %s has expired! Please download the latest version."),Q=Q.replace("eXeLearning %s","<strong>eXeLearning "+eXeLearning.version+"</strong>"),$("body").html('<div id="load-screen-main" class="expired"><p class="alert alert-warning">'+Q+"</p></div>");return}else{Q=_("This is just a demo version. Not for real projects. Days before it expires: %s");var X=Z.toString();X=X.substring(0,4)+"-"+X.substring(4,6)+"-"+X.substring(6,8);var J=Y.toString();J=J.substring(0,4)+"-"+J.substring(4,6)+"-"+J.substring(6,8);var W=new Date(X).getTime(),z=new Date(J).getTime(),G=W-z;G=G/86400000,Q=Q.replace("%s","<strong>"+G+"</strong>")}}}}Q=Q.replace("eXeLearning %s","<strong>eXeLearning %s</strong>"),Q=Q.replace("%s",eXeLearning.version);let q=_("Accept"),H=`
      <div class="alert alert-warning alert-dismissible fade show m-4"
           role="alert"
           id="eXeBetaWarning">
        ${Q}
        <button type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="${q}"
                id="eXeBetaWarningCloseBtn">
        </button>
      </div>
    `;if(!document.getElementById("eXeBetaWarning")){let K=$("#node-content");if(K.length!==1)return;K.before(H)}}async showProvisionalToDoWarning(){if(eXeLearning.version.indexOf("-")===-1)return;if(document.getElementById("eXeToDoWarning"))return;$("#eXeLearningNavbar nav div > ul").append('<li class="nav-item"><a class="nav-link text-danger" href="#" id="eXeToDoWarning" hreflang="es"><span class="auto-icon" aria-hidden="true">warning</span>'+_("Warning")+"</a></li>"),$("#eXeToDoWarning").on("click",function(){let Q=`
                    <p class="alert alert-info mb-4">Por favor, antes de avisar de un fallo, asegúrate de que no está en esta lista.</p>
                    <p><strong>Problemas que ya conocemos:</strong></p>
                    <ul>
                        <li>Solo hay dos estilos, y son casi iguales.</li>
                        <li>No hay editor de estilos.</li>
                        <li>Falta Archivo - Imprimir.</li>
                        <li>No se puede exportar o importar una página.</li>
                        <li>Si estás editando un iDevice no puedes cambiar su título.</li>
                        <li>No hay opción para exportar en formato SCORM 2004.</li>
                    </ul>
                    <p><strong>Si encuentras algo más:</strong> Ayuda → Informar de un fallo</p>
                    <p>Muchas gracias.</p>
            `;return eXe.app.alert(Q,"Importante"),$(this).removeClass("text-danger").addClass("text-muted"),!1})}}var N2=!1;function i2(){if(N2)return;N2=!0,window.onbeforeunload=function(Q){return}}["pointerdown","touchstart","keydown","input"].forEach((Q)=>{window.addEventListener(Q,i2,{once:!0,passive:!0,capture:!0})});window.onload=function(){var Q=window.eXeLearning;if(Q.app=new l1(Q),m.fromEnvironment().isStaticMode()&&!Q.projectId){console.log("[App] Static mode: waiting for project selection..."),window.__startExeApp=function(){console.log("[App] Starting app with project:",Q.projectId),Q.app.init()};return}Q.app.init()};})();
