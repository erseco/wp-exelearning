<!DOCTYPE html>
<!--
YouTube Preview Wrapper

PURPOSE:
This HTML file serves as an HTTP wrapper for YouTube embeds in preview mode.

PROBLEM:
YouTube's IFrame Player API requires a valid HTTP/HTTPS origin to function.
When content is loaded via blob: URLs (as in eXeLearning's preview panel),
YouTube rejects the embed with "Error 153: Video player configuration error"
because blob: URLs have a null origin that YouTube doesn't recognize.

SOLUTION:
Instead of loading YouTube directly inside the blob: context, we load this
wrapper file via a regular HTTP URL. Since this file is served from the
eXeLearning server (e.g., http://localhost:8080/app/common/youtube-preview.html),
it has a valid HTTP origin that YouTube accepts.

FLOW:
1. Preview panel loads content as blob:http://localhost:8080/...
2. YouTube iframes are detected and transformed to point to this wrapper
3. This wrapper loads from http://localhost:8080/... (valid origin)
4. YouTube IFrame API works correctly inside this wrapper
5. Communication with parent happens via postMessage API

PARAMETERS (via query string):
- v: YouTube video ID (required)
- w, h: Width and height
- autoplay, start, end, mute, loop, controls: YouTube player options

See also:
- WebsitePreviewExporter.ts: getYouTubePreviewTransformScript()
- interactive-video.js: loadYoutubeWrapper()
-->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YouTube Preview</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        #player {
            width: 100%;
            height: 100%;
        }
        #error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
        }
        #error h2 { margin-bottom: 10px; color: #ff6b6b; }
        #error a { color: #4dabf7; }
    </style>
</head>
<body>
    <div id="player"></div>
    <div id="error">
        <h2>Video Error</h2>
        <p id="error-message"></p>
        <p style="margin-top: 15px;">
            <a id="youtube-link" href="#" target="_blank" rel="noopener">Watch on YouTube</a>
        </p>
    </div>

    <script>
    (function() {
        'use strict';

        // Parse URL parameters
        var params = new URLSearchParams(window.location.search);
        var videoId = params.get('v');
        var width = params.get('w') || '100%';
        var height = params.get('h') || '100%';

        // Additional YouTube player parameters (from TinyMCE embeds)
        var autoplay = params.get('autoplay') === '1' ? 1 : 0;
        var startTime = parseInt(params.get('start'), 10) || 0;
        var endTime = parseInt(params.get('end'), 10) || 0;
        var mute = params.get('mute') === '1' ? 1 : 0;
        var loop = params.get('loop') === '1' ? 1 : 0;
        var controls = params.get('controls') !== '0' ? 1 : 0;
        var showinfo = params.get('showinfo') === '1' ? 1 : 0;
        var cc_load_policy = params.get('cc_load_policy') === '1' ? 1 : 0;

        // Validate video ID
        if (!videoId || !/^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
            showError('Invalid or missing video ID');
            return;
        }

        // Set YouTube link with start time if specified
        var youtubeLink = 'https://www.youtube.com/watch?v=' + videoId;
        if (startTime > 0) youtubeLink += '&t=' + startTime;
        document.getElementById('youtube-link').href = youtubeLink;

        // Load YouTube IFrame API
        var tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        tag.onerror = function() {
            showError('Failed to load YouTube API');
        };
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player = null;
        var timeInterval = null;
        var isReady = false;

        // YouTube API callback
        window.onYouTubeIframeAPIReady = function() {
            try {
                // Build playerVars with all supported parameters
                var playerVars = {
                    origin: window.location.origin,
                    enablejsapi: 1,
                    rel: 0,
                    modestbranding: 1,
                    playsinline: 1,
                    autoplay: autoplay,
                    controls: controls,
                    mute: mute,
                    cc_load_policy: cc_load_policy
                };

                // Add optional parameters
                if (startTime > 0) playerVars.start = startTime;
                if (endTime > 0) playerVars.end = endTime;
                if (loop) {
                    playerVars.loop = 1;
                    playerVars.playlist = videoId; // Required for loop to work
                }

                player = new YT.Player('player', {
                    width: width,
                    height: height,
                    videoId: videoId,
                    host: 'https://www.youtube-nocookie.com',
                    playerVars: playerVars,
                    events: {
                        onReady: onPlayerReady,
                        onStateChange: onPlayerStateChange,
                        onError: onPlayerError
                    }
                });
            } catch (e) {
                showError('Failed to create YouTube player: ' + e.message);
            }
        };

        function onPlayerReady(event) {
            isReady = true;

            // Notify parent that player is ready
            sendToParent({ type: 'youtube-ready' });

            // Start time polling (every 250ms for smooth tracking)
            timeInterval = setInterval(function() {
                if (player && typeof player.getCurrentTime === 'function') {
                    try {
                        var currentTime = player.getCurrentTime();
                        var duration = player.getDuration();
                        var state = player.getPlayerState();
                        sendToParent({
                            type: 'youtube-time',
                            time: currentTime,
                            duration: duration,
                            state: state
                        });
                    } catch (e) {
                        // Player might be destroyed
                    }
                }
            }, 250);
        }

        function onPlayerStateChange(event) {
            sendToParent({
                type: 'youtube-state',
                state: event.data,
                stateName: getStateName(event.data)
            });
        }

        function onPlayerError(event) {
            var errorMessages = {
                2: 'Invalid video ID',
                5: 'HTML5 player error',
                100: 'Video not found or removed',
                101: 'Video owner does not allow embedding',
                150: 'Video owner does not allow embedding'
            };

            var message = errorMessages[event.data] || 'Unknown error (code: ' + event.data + ')';

            sendToParent({
                type: 'youtube-error',
                error: event.data,
                message: message
            });

            showError(message);
        }

        function getStateName(state) {
            var names = {
                '-1': 'unstarted',
                '0': 'ended',
                '1': 'playing',
                '2': 'paused',
                '3': 'buffering',
                '5': 'cued'
            };
            return names[String(state)] || 'unknown';
        }

        function showError(message) {
            document.getElementById('player').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function sendToParent(data) {
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(data, '*');
                }
            } catch (e) {
                // Cross-origin restrictions
            }
        }

        // Listen for commands from parent
        window.addEventListener('message', function(event) {
            if (!player || !isReady) return;

            var data = event.data;
            if (!data || typeof data.type !== 'string') return;

            try {
                switch (data.type) {
                    case 'youtube-play':
                        player.playVideo();
                        break;

                    case 'youtube-pause':
                        player.pauseVideo();
                        break;

                    case 'youtube-stop':
                        player.stopVideo();
                        break;

                    case 'youtube-seek':
                        if (typeof data.time === 'number') {
                            player.seekTo(data.time, true);
                        }
                        break;

                    case 'youtube-mute':
                        player.mute();
                        break;

                    case 'youtube-unmute':
                        player.unMute();
                        break;

                    case 'youtube-set-volume':
                        if (typeof data.volume === 'number') {
                            player.setVolume(data.volume);
                        }
                        break;

                    case 'youtube-get-time':
                        sendToParent({
                            type: 'youtube-time',
                            time: player.getCurrentTime(),
                            duration: player.getDuration(),
                            state: player.getPlayerState()
                        });
                        break;

                    case 'youtube-get-state':
                        sendToParent({
                            type: 'youtube-state',
                            state: player.getPlayerState(),
                            stateName: getStateName(player.getPlayerState())
                        });
                        break;
                }
            } catch (e) {
                console.error('[YouTubePreview] Command error:', e);
            }
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', function() {
            if (timeInterval) {
                clearInterval(timeInterval);
            }
        });

    })();
    </script>
</body>
</html>
