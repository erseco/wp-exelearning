/**
 * plugin.min.js
 *
 * Released under Attribution-ShareAlike 4.0 International License.
 * Author: Luis Ramón López López for http://exelearning.net/
 *
 * License: http://creativecommons.org/licenses/by-sa/4.0/
 */

/**
 * Insert mermaid code
 */
tinymce.PluginManager.add('exemermaid', function (editor, url) {

    let $ = tinymce.dom.DomQuery;

    function setHTMLAttribs() {
        // Add id to textarea
        let divHtmlSource = $('div.tox-form__group').eq(1);
        let textareaHtmlSource = divHtmlSource.children().eq(0);
        tinymce.DOM.setAttrib(textareaHtmlSource, { 'id': 'htmlSource' });
    }

    PasteMermaidDialog = {
        actualHtmlSource: '',
        setDefaultData: function() {
            PasteMermaidDialog.actualHtmlSource = '';
        },
        getInitialData:function () {
            return {
                htmlSource: PasteMermaidDialog.actualHtmlSource
            };
        },
        activateButton: function (node) {
            return node.nodeName === "PRE" && node.className.indexOf("mermaid") !== -1;

        },
        getValues: function () {
            var sel = tinyMCE.activeEditor.selection;
            var v = sel.getContent({ format: 'text' });
            var node = sel.getNode();

            this.initialValue = v;
            this.isUpdating = false;

            if (node.nodeName === "PRE") {
                var c = node.innerHTML;
                c = c.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                v = c;
                this.isUpdating = true;
            }
            PasteMermaidDialog.actualHtmlSource = v;
        },
        // Create or update the content
        insert: function (content) {
            var editor = tinyMCE.activeEditor;

            // Code (the content)
            var t = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var c = "<pre class=\"mermaid\">" + t + "</pre>";
            if (content === "") c = "";

            // Insert the content
            if (this.isUpdating === false) {
                // New content
                editor.insertContent(c);
            } else {
                // Update the selected content
                var ed = editor;
                var node = ed.selection.getNode();
                ed.dom.setHTML(node, t);
            }
            // Close the editor
            editor.windowManager.close();
        },
        openHTMLDialog: function () {
            PasteMermaidDialog.getValues();
            // Open the window
            win = editor.windowManager.open({
                title: _('Paste Mermaid code (diagram)'),
                body:
                {
                    type: 'panel',
                    items: [
                        {
                            type: 'label',
                            label: _('Use CTRL+V on your keyboard to paste into the window.'),
                            items: []
                        },
                        {
                            type: 'textarea',
                            name: 'htmlSource'
                        },
                        {
                            type: 'label',
                            label: _('Need help? Visit %s').replace('%s', '<a href="https://mermaid.js.org/" target="_blank" rel="noopener">mermaid.js.org</a>'),
                            items: []
                        },
                    ]
                },
                buttons: [
                    {
                        type: 'cancel',
                        name: 'cancel',
                        text: 'Cancel'
                    },
                    {
                        type: 'submit',
                        name: 'save',
                        text: 'Save',
                        primary: true
                    }
                ],
                initialData: PasteMermaidDialog.getInitialData(),
                onSubmit: function (api) {
                    PasteMermaidDialog.actualHtmlSource = api.getData().htmlSource;
                    PasteMermaidDialog.insert(PasteMermaidDialog.actualHtmlSource);
                    return false;
                },
                onClose: function () {
                    PasteCodeDialog.setDefaultData();
                }
            });

            setHTMLAttribs();

            let divDialog = $('div.tox-dialog').eq(0);
            tinymce.DOM.setStyle(divDialog, 'height', 400);
        }

    } // PasteCodeDialog

    editor.ui.registry.addIcon('exemermaid', `<?xml version="1.0" encoding="UTF-8"?>
<svg width="24px" height="24px" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" version="1.1" viewBox="0 0 491 491" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
    
    <path d="m407.48 111.18c-71.893-3.077-137.91 41.158-162.4 108.82-24.493-67.662-90.507-111.9-162.4-108.82-2.395 57.049 24.897 111.45 72.06 143.64 24.168 16.599 38.61 44.131 38.53 73.45v50.86h103.63v-50.86c-0.084-29.317 14.355-56.85 38.52-73.45 47.176-32.176 74.472-86.587 72.06-143.64z" fill-rule="nonzero"/>
</svg>`);

    editor.ui.registry.addToggleButton('exemermaid', {
        icon: 'exemermaid',
        tooltip: _('Paste Mermaid fragment (diagram)'),
        onAction: PasteMermaidDialog.openHTMLDialog,
        onSetup: function (buttonApi) {
            var editorEventCallback = function (eventApi) {
                buttonApi.setActive(PasteMermaidDialog.activateButton(eventApi.element));
            };
            editor.on('NodeChange', editorEventCallback);
            return function (buttonApi) {
                editor.off('NodeChange', editorEventCallback);
            }
        }
    });

    editor.ui.registry.addMenuItem('exemermaid', {
        icon: 'exemermaid',
        text: _('Paste Mermaid code (diagram)'),
        onAction: PasteMermaidDialog.openHTMLDialog,
        context: 'insert'
    });

    editor.on('init', function (e) {
        editor.dom.loadCSS(url + "/css/content.css");
    });

    editor.on('deactivate', function (e) {
        $exe.mermaid.init();
    });
});
